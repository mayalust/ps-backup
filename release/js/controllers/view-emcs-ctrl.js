define(["controllers/controllers","bootstrap-dialog"],function(e,i){"use strict";e.initController("ViewEmcsCtrl",["$scope","$filter","$location","$routeParams","$timeout","viewFlexService","kpiDataService","resourceUIService","growl","userLoginUIService","userDomainService","$route","SwSocket","Info","unitService",function(r,i,e,a,t,o,l,s,c,n,d,u,p,f,v){r.deviceView=null,r.selectedDevicetitem,r.kpis=[],r.timePeriod="10",r.domainListDic={},r.kpiSearch="",r.domainsAry=[],r.defaultDomain=[],r.tableDataLoading=!1,r.chartData=null,r.tableData={},r.uuid=Math.uuid(),r.erroruuid=Math.uuid(),r.domainStates=!1,r.gateData=[],r.selectedRadioId=null,r.queryDitem={},r.kpiDef={},r.deviceswitchflg=0,r.kpiswitchflg=0;var m=[];r.times=null;f.get("../localdb/info.json",function(e){m=e.emcsAlertColor,r.times=e.emcsSetTime});var g={statisticType:"",category:"time",nodeIds:[],kpiCodes:[],isRealTimeData:!0,timePeriod:"",startTime:"",endTime:"",timeRange:"",queryInstances:null};function y(e){"a"==e?(r.deviceView=[],r.kpis=[],r.selectedKpi=null,r.selectedDevicetitem=null,r.deviceView=null,0==jQuery("#devicecollapse").find(".fa.fa-plus").length&&jQuery.AdminLTE.boxWidget.collapse(jQuery("#devicecollapse")),r.kpis=null,0==jQuery("#kpicollapse").find(".fa.fa-plus").length&&jQuery.AdminLTE.boxWidget.collapse(jQuery("#kpicollapse")),0==jQuery("#viewcollapse").find(".fa.fa-plus").length&&jQuery.AdminLTE.boxWidget.collapse(jQuery("#viewcollapse"))):"b"==e&&(r.kpis=[],r.selectedKpi=null),C(),r.timePeriod="10",r.tableData={name:"",unit:"",data:[]}}r.getRealTimeHistoryData=function(){D()};var D=function(){if(r.selectedDevicetitem){var e=r.selectedDevicetitem.id;g.nodeIds=[e],g.kpiCodes=r.kpiData.idArray,g.category="time",g.timePeriod=s.getMSvalue(0,r.selectedKpi)*r.timePeriod;var i=["kpi",g];r.tableDataLoading=!0,l.getValueList(i,function(e){var i,t,a;0==e.code&&(r.tableDataLoading=!1,C(),r.tableData={name:"",unit:"",data:[]},r.chartData={xData:[],series:{name:"",type:"line",data:[]}},0!=e.data.length&&(i=e.data,t={xData:[],series:{name:"",type:"line",data:[]}},a={name:"",unit:"",data:[]},i.forEach(function(i){t.xData.push(k(i.arisingTime)),t.series.data.push(i.value),r.kpis.forEach(function(e){e.id==i.kpiCode&&(t.series.name=e.label,a.name=e.label,a.unit=e.unit,e.rangeObj&&e.rangeObj)}),a.data.push({name:k(i.arisingTime),value:i.value})}),r.$broadcast("OptionStatusChange",{option:h(t)}),r.chartData=t,a.data.reverse(),r.tableData=a))})}};r.selectedRadio=function(e){0<jQuery("#viewcollapse").find(".fa.fa-plus").length&&jQuery.AdminLTE.boxWidget.collapse(jQuery("#viewcollapse")),setTimeout(function(){$(".content-wrapper").scrollTop(1e6)},500),r.selectedKpi=e,r.selectedRadioId=parseInt(e.id),r.kpiData.idArray=[r.selectedRadioId],D()};var h=function(o){return{title:{text:"",subtext:"",x:"center",y:"top"},tooltip:{trigger:"axis",formatter:function(e){var i=(e=e[0]).name,t=e.value||0==e.value?e.value:"",a=o.series.name?o.series.name:"";return i?i+"<br>"+a+" : "+t:"没有数据"}},xAxis:[{type:"category",boundaryGap:!1,data:o.xData}],yAxis:[{type:"value",axisLabel:{formatter:"{value}"}}],series:o.series}},k=function(e){return e=i("date")(e,"yyyy-MM-dd HH:mm:ss")};function b(e,i){if(null==e||null==e||""==e)return i;if(-1<e.indexOf("{")&&-1<e.indexOf(":"))try{i=(e=JSON.parse(e))[i]}catch(e){}return i}function w(e){r.kpis=r.kpiDef[r.selectedDevicetitem.modelId];var i=r.selectedDevicetitem.id,o=r.uuid,n=function(e){for(var i in r.kpis)r.kpis[i].id==e.data.kpiCode&&r.$apply(function(){r.kpis[i].value=b(r.kpis[i].range,e.data.value),r.kpis[i].time=k(e.data.arisingTime),0!=r.kpiData.idArray.length&&""==r.chartData.series.name&&r.selectedRadioId==e.data.kpiCode&&(r.chartData.series.name=r.kpis[i].label,r.tableData.name=r.kpis[i].label,r.tableData.unit=r.kpis[i].unit)});if(0!=r.kpiData.idArray.length&&r.kpiData.idArray[0]==e.data.kpiCode){r.chartData.xData.push(k(e.data.arisingTime)),r.chartData.series.data.push(e.data.value),r.$broadcast("OptionStatusChange",{option:h({xData:r.chartData.xData,series:r.chartData.series})});var t={name:k(e.data.arisingTime),value:e.data.value};r.$apply(function(){r.tableData.data.unshift(t)})}},t=[];r.kpis.forEach(function(e){e.value="",e.valueStr="",t.push(e.id)}),g.nodeIds=[i],g.kpiCodes=t,g.category="ci",g.timePeriod="0",g.includeInstance=!0;var d=["kpi",g];l.getValueList(d,function(e){if(0==e.code){var i=e.data;if(i.forEach(function(e){for(var i in r.kpis)e.kpiCode==r.kpis[i].id&&(r.kpis[i].rangeObj?r.kpis[i].value=r.kpis[i].rangeObj[e.value]:r.kpis[i].value=e.value,r.kpis[i].time=k(e.arisingTime))}),"WebSocket"in window){var t={ciid:d[1].nodeIds.toString(),kpi:d[1].kpiCodes.toString()},a="register";p.register(o,a,n),p.send(o,a,"kpi",t)}else c.warning("您的浏览器不支持WebSocket.",{})}}),r.$on("$destroy",function(){p.unregister(o)})}function j(e){if(!e.data.instance){for(var i in r.deviceView){if(e.data.nodeId==r.deviceView[i].id){null!=m[e.data.value]&&(r.deviceView[i].color=m[e.data.value-1].color),r.deviceView[i].alertCode=e.data.value;break}if(e.data.value<=0&&e.data.nodeId==r.deviceView[i].id){delete r.deviceView[i].color,delete r.deviceView[i].alertCode;break}}r.$apply()}}r.getDeviceError=function(e){var a=[],o=r.erroruuid;r.deviceView.forEach(function(e){a.push(e.id),e.alertCode=10}),g.timePeriod=0,g.category="ci",g.nodeIds=a,g.kpiCodes=[999999];var i=["kpi",g];l.getValueList(i,function(e){if(0==e.code)if(e.data.forEach(function(e){for(var i in r.deviceView)if(r.deviceView[i].id==e.nodeId){0<e.value?r.deviceView[i].color=m[e.value-1].color:r.deviceView[i].color="#00b9b2",r.deviceView[i].alertCode=e.value;break}}),"WebSocket"in window){var i={ciid:a.toString(),kpi:"999999"},t="register";p.register(o,t,j),p.send(o,t,"kpi",i)}else c.warning("您的浏览器还不支持WebSocket",{})}),r.$on("$destroy",function(){p.unregister(o)})},r.gotoDeviceView=function(e){location.href="#/configAlert/"+e.id+"/node"};var I=function(){w(r.selectedDevicetitem),C(),r.tableData=null};r.goSearch=function(){y("a");var e=jQuery.extend({},r.queryDitem,!0);e.domains=e.domainPath,e.domainPath="",s.getDevicesByCondition(e,function(e){0<jQuery("#devicecollapse").find(".fa.fa-plus").length&&jQuery.AdminLTE.boxWidget.collapse(jQuery("#devicecollapse")),e.data&&(10<e.data.length&&(r.deviceswitchflg=0),e.data.forEach(function(e){e.icon=s.rootModelDic[e.modelId].icon}),r.deviceView=e.data,p.unregister(r.erroruuid),r.getDeviceError(r.deviceView))})},r.goClear=function(){r.queryDitem={customerId:"",projectId:"",domainPath:"",modelId:"",sn:"",label:"",gatewayId:""},y("a")},r.getKPIs=function(e){10<r.deviceView.length&&0==jQuery("#devicecollapse").find(".fa.fa-plus").length&&jQuery.AdminLTE.boxWidget.collapse(jQuery("#devicecollapse")),0<jQuery("#kpicollapse").find(".fa.fa-plus").length&&jQuery.AdminLTE.boxWidget.collapse(jQuery("#kpicollapse")),r.selectedRadioId=null,r.kpiData.idArray=[],y("b"),"WebSocket"in window&&p.unregister(r.uuid),r.selectedDevicetitem=JSON.parse(JSON.stringify(e));var i=e.modelId;x(i,function(){w(r.selectedDevicetitem)})};var x=function(e,n){r.kpiDef[r.selectedDevicetitem.modelId]?n&&n():s.getDataItemsByModelId(e,function(e){if(0==e.code){y("b");var i=/\{|\[.*\}|\]/;for(var t in e.data)if(e.data[t].unit=r.myOptionDic[e.data[t].unit],e.data[t].range){var a=i.test(e.data[t].range),o=[];if(a)try{o=a?JSON.parse(e.data[t].range):[]}catch(e){}(e.data[t].rangeAry=o)instanceof Array?2==(e.data[t].rangeAry=o).length&&(e.data[t].min=o[0],e.data[t].max=o[1]):o instanceof Object&&(e.data[t].rangeObj=o)}r.kpiDef[r.selectedDevicetitem.modelId]=e.data,n&&n()}})};function A(e){r.domainListTree=e.domainListTree,r.domainListDic=e.domainListDic,r.selectedParentitem=null}var Q=function(){if(s.getRootModel(function(e){0==e.code&&(s.rootModel=e.data,r.routePathNodes={},s.getModels(function(e){if(0==e.code){s.rootModelDic={};var i=e.data;for(var t in i){var a=i[t];a.text=a.label,r.routePathNodes[a.parentModelId]||(r.routePathNodes[a.parentModelId]=[]),r.routePathNodes[a.parentModelId].push(a),r.routePathNodes[a.id]||(r.routePathNodes[a.id]=[]);var o=jQuery.extend(!0,{},a);s.rootModelDic[o.id]=o}var n=function e(i){for(var t in r.routePathNodes)if(t==i.id){for(var a in i.nodes=r.routePathNodes[t],i.nodes)e(i.nodes[a]);0==i.nodes.length&&(i.nodes=null)}};for(var d in n(s.rootModel),r.routePathNodes)if(d!=s.rootModel.id&&!s.rootModelDic[d])for(var t in r.routePathNodes[d])n(r.routePathNodes[d][t]),s.rootModel.nodes||(s.rootModel.nodes=[]),s.rootModel.nodes.push(r.routePathNodes[d][t]);s.rootModelDic[s.rootModel.id]=s.rootModel,r.rootModel=s.rootModel.nodes,r.rootModelDic=s.rootModelDic}}))}),s.getAllGateways(function(e){0==e.code&&(r.gateData=e.data)}),r.menuitems.isloaded)r.baseConfig.extendDomain?s.getExtendDomainsByFilter({},A):d.queryDomainTree(n.user.userID,A);else var t=r.$watch("menuitems",function(e,i){r.menuitems.isloaded&&(r.baseConfig.extendDomain?s.getExtendDomainsByFilter({},A):d.queryDomainTree(n.user.userID,A),t())},!0);var e;a.hasOwnProperty("id")?a.id&&(r.searchMode=!0,e=a.id,s.getResourceById(e,function(e){if(0==e.code){r.selectedDevicetitem=e.data,r.deviceView=[e.data];var i=e.data.modelId;i&&(r.getDeviceError(r.deviceView),x(i,I))}})):(jQuery.AdminLTE.boxWidget.collapse(jQuery("#devicecollapse")),jQuery.AdminLTE.boxWidget.collapse(jQuery("#kpicollapse")),jQuery.AdminLTE.boxWidget.collapse(jQuery("#viewcollapse"))),r.$on("switchChange",function(e,i){r.$apply(function(){"deviceswitch"==i.id?(0<jQuery("#devicecollapse").find(".fa.fa-plus").length&&jQuery.AdminLTE.boxWidget.collapse(jQuery("#devicecollapse")),r.deviceswitchflg=i.itemDirValues):"kpiswitch"==i.id&&(0<jQuery("#kpicollapse").find(".fa.fa-plus").length&&jQuery.AdminLTE.boxWidget.collapse(jQuery("#kpicollapse")),r.kpiswitchflg=i.itemDirValues)})})},T=function(){r.kpiData={idArray:[],unitArray:[],labelArray:[],granularityArray:[],granularityUnitArray:[]};var e=[],i=[{data:[],name:"",type:"line"}];t(function(){r.$broadcast(Event.ECHARTINFOSINIT,{option:h({xData:e,series:i})})})},C=function(){var e=h({xData:[],series:[{data:[],name:"",type:"line"}]});r.$broadcast("OptionStatusChange",{option:e})},S=function(){v.units?(r.myOptions=v.units,r.myOptionDic=v.unitDics):v.getAllUnits(function(e){if(0==e.code){for(var i in v.units=e.data,r.myOptions=e.data,v.unitDics={},r.myOptions)v.unitDics[r.myOptions[i].unitCode]=r.myOptions[i].unitName,"NA"!=r.myOptions[i].unitCode&&"Number"!=r.myOptions[i].unitCode||(v.unitDics[r.myOptions[i].unitCode]="");r.myOptionDic=v.unitDics}})};n.user.isAuthenticated?(Q(),S(),T()):r.$on("loginStatusChanged",function(e,i){n.user.isAuthenticated&&(Q(),S(),T())})}])});
//# sourceMappingURL=../../map/js/controllers/view-emcs-ctrl.js.map
