define(["controllers/controllers","bootstrap-dialog"],function(e,k){"use strict";e.initController("ViewAlertCtrl",["$scope","$routeParams","ngDialog","userLoginUIService","alertService","SwSocket","Info","viewFlexService","alertManageFlexService","growl","ticketCategoryService","ticketService","processService","$filter","$timeout","$location",function(p,d,a,e,r,n,t,i,u,f,o,l,s,c,v,g){console.info("进入设备故障");var m,I,y,T,h=[],A=[],w=Math.uuid();p.priority=[{value:"0",label:"低"},{value:"100",label:"中"},{value:"200",label:"高"}];t.get("../localdb/info.json",function(e){T=e.alertStyle});var b=function(t){if(0<A.length){var a=0;A.forEach(function(e){e.alertId==t.data.alertId&&(a=1,e.message=t.data.message,e.title=t.data.title,e.severity=t.data.severity,e.state=t.data.state,e.arisingTime=t.data.arisingTime)}),a<=0&&A.push(t.data)}else A.push(t.data);p.$broadcast(Event.ALERTINFOSINIT+"_view",{option:[A]})};p.processTypeData=[];o.getTicketCategorys(function(e){0==e.code&&(p.processTypeData=e.data)}),p.getOrderProcedure=function(){p.processType=[];var e=p.processTypeData;for(var t in e)e[t].category==p.orderData.category&&p.processType.push(e[t])},p.showOrder=function(){D(),a.open({template:"addOrder",className:"ngdialog-theme-plain",scope:p})},p.getOrderData=function(){l.getAllTickets(function(e){0==e.code&&(p.workOrderData=e.data)})},p.getOrderData();var C=function(e){for(var t in e){var a=e[t];if(1==a.visible||"true"==a.visible)(r=new Object).data=a.dataField,r.title=a.headerText,h.push(r),"state"==r.data?h.length-1:"severity"==r.data&&h.length-1}var r;(r=new Object).data="option",r.title="操作",h.push(r);var i={data:"selected",title:'<input id="allselect-btn" type="checkbox">',width:"8px"};h.unshift(i)},O=function(e){return e&&(e=newDateJson(e).Format(GetDateCategoryStrByLabel())),e},S=function(e){h=[],A=[];var t,a=m.view;for(var r in a&&(t=jQuery.xml2json(a.profile)),null!=t&&t.hasOwnProperty("style")?C(t.style.column):C(T),e){var i=e[r];i.arisingTime=i.arisingTime,i.claimTime=O(i.claimTime),i.firstArisingTime=O(i.firstArisingTime),i.updateTime=O(i.updateTime),i.receiveTime=O(i.receiveTime),A.push(i)}if("/configAlert"==g.path()){p.selLength=10,p.$broadcast(Event.ALERTINFOSINIT+"_view",{option:[A]});var o={viewId:a.viewId};n.unregister(w),w=Math.uuid();var l="register";n.register(w,l,b),n.send(w,l,"alertView",o)}else p.$broadcast(Event.ALERTINFOSINIT,{option:[]})},D=function(){p.orderData={title:"",priorityCode:"0",category:"",ticketCategoryId:"",values:null,deviceId:"",faultId:"",message:""}};p.confirmActiveAlert=[],p.closeActiveAlert=[],p.selectedHandler=function(){p.confirmActiveAlert=[],p.closeActiveAlert=[],p.pageAlertList.forEach(function(e){e.selected&&0==e.state?(p.confirmActiveAlert.push(e),p.closeActiveAlert.push(e)):!e.selected||5!=e.state&&10!=e.state||p.closeActiveAlert.push(e)}),p.$apply()},p.ngDialogOrder=function(e){p.alertInfo={actionType:"forward",alertIds:[e.alertId],severity:0,target:"EOMS://auttest/auttest"},p.orderData={title:e.title,priorityCode:"",category:"",ticketCategoryId:"",values:null,deviceId:e.nodeId,appName:e.appName,faultId:"",message:e.message},p.alertDefinition(e.alertCode,e.nodeTypeList[e.nodeTypeList.length-1],function(e){0<p.faultList.length&&(p.orderData.faultId=p.faultList[0].faultId)}),p.priority=[{value:"0",label:"低"},{value:"100",label:"中"},{value:"200",label:"高"}];var t=e.severity;1==t||2==t?t=p.priority[0].value:3==t?t=p.priority[1].value:5!=t&&4!=t||(t=p.priority[2].value),p.orderData.priorityCode=t,a.open({template:"../partials/dialogue/add_order.html",scope:p,className:"ngdialog-theme-plain"})},p.doAction=function(e,r,i){if("claim"==e){var t={actionType:"claim",alertIds:r};u.sendClaimAction(t,function(e){0==e.code&&(f.success("确认告警成功",{}),i&&i(!0))})}else if("claim2"==e){t={actionType:"claim",alertIds:r};u.sendClaimAction(t,function(e){0==e.code&&i&&i(!0)})}else if("close"==e){t={actionType:"recover",alertIds:r,recoverAll:!0,resolved:!0,clearOut:!0};k.show({title:"提示",closable:!1,message:"确认关闭告警吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(a){u.sendRecoverAction(t,function(e){if(0==e.code){f.success("关闭告警成功",{});for(var t=A.length-1;-1<t;t--){if(A[t].alertId==r.alertId){A.splice(t,1);break}}i(e),a.close()}})}},{label:"取消",action:function(e){e.close()}}]})}else if("close2"==e){t={actionType:"recover",alertIds:r,recoverAll:!0,resolved:!0,clearOut:!0};u.sendRecoverAction(t,function(e){if(0==e.code){for(var t=A.length-1;-1<t;t--){if(A[t].alertId==r.alertId){A.splice(t,1);break}}i(!0)}else i(!1)})}else if("order"==e)p.alertInfo={actionType:"forward",alertIds:r,severity:0,target:"EOMS://auttest/auttest"},p.showOrder();else if("submit-btn"==e){var a=(s=p.orderData,c=null,s.title&&""!=s.title?null!=s.priorityCode&&String(s.priorityCode)&&""!=String(s.priorityCode)?s.category&&""!=s.category?s.message&&""!=s.message||(c="工单内容不能为空"):c="工单类型不能为空":c="紧急度不能为空":c="工单名称不能为空",c);if(null!=a)return void f.warning(a,{});if(p.commitloading)return void f.warning("请等待，正在发布工单");var o=p.orderData.ticketCategoryId.split(":"),l={title:p.orderData.title,category:p.orderData.category,ticketCategoryId:o[1],priorityCode:p.orderData.priorityCode,faultId:p.orderData.faultId,deviceId:p.orderData.deviceId,message:p.orderData.message};t=p.alertInfo;u.sendForwardAction(t,l,function(e){if(0==e.code)if(p.commitloading=!1,p.closeDialog(),f.success("已转工单",{}),d&&d.nodeId){var t={viewId:null,nodeId:d.nodeId};p.selectAlertList.search?(p.selectAlertList.searchStatus=!0,p.$broadcast(Event.ALERTINFOSINIT,{option:[]})):p.$broadcast("alertViewClick",{option:t})}else i&&i(!0);else p.commitloading=!1})}else if("cancel-btn"==e){if(d&&d.nodeId){var n={viewId:null,nodeId:d.nodeId};p.$broadcast("alertViewClick",{option:n})}else p.commitItem?p.alertViewClick(p.commitItem):p.$broadcast("alertViewClick",{option:"",states:y});f.success("取消告警转工单",{})}var s,c},p.reloadViewId=function(){r.queryByView(m.viewId,null,function(e){if(0==e.code){A=[];var t=e.data;for(var a in t){var r=t[a];r.arisingTime=r.arisingTime,r.claimTime=O(r.claimTime),r.firstArisingTime=O(r.firstArisingTime),r.updateTime=O(r.updateTime),r.receiveTime=O(r.receiveTime),A.push(r)}p.selLength=10,p.$broadcast(Event.ALERTINFOSINIT+"_view",{option:[A]})}})},p.pipeline=function(e){var d=$.extend({pages:1,url:"",data:null,method:"POST"},e),u=-1,f=null,v=null,g=null;return function(r,i,e){var t=!1,a=r.start,o=r.start,l=r.length,n=a+l;if(r.order.pop(),e.clearCache?(t=!0,e.clearCache=!1):u<0||a<u||f<n?t=!0:JSON.stringify(r.order)===JSON.stringify(v.order)&&JSON.stringify(r.columns)===JSON.stringify(v.columns)&&JSON.stringify(r.search)===JSON.stringify(v.search)||(t=!0),v=$.extend(!0,{},r),t){if(a<u&&(a-=l*(d.pages-1))<0&&(a=0),f=(u=a)+l*d.pages,r.start=a,r.length=l*d.pages,$.isFunction(d.data)){var s=d.data(r);s&&$.extend(r,s)}else $.isPlainObject(d.data)&&$.extend(r,d.data);var c={start:r.start,length:r.length,statCount:1==r.draw};p.getDevicesByPage(I,c,function(e,t){e.forEach(function(e){e.selected=!1});var a={};a.data=e,a.draw=r.draw,a.recordsTotal=null!=t?-1==t?g.recordsTotal:t:e.length,a.recordsFiltered=a.recordsTotal,g=$.extend(!0,{},a),u!=o&&a.data.splice(0,o-u),-1<=l&&a.data.splice(l,a.data.length),i(a)})}}},p.ajaxListUpdate=[],p.getDevicesByPage=function(e,t,a){r.getAlertByPage(e,t,function(e){0==e.code&&(p.pageAlertList=e.data.data,a(e.data.data,e.data.total))})},p.closeDialog=function(){a.close()},p.configAlert=function(e){"addOrder"==e?p.$broadcast("addOrder"):"selectedOrder"==e?p.$broadcast("selectedOrder"):"selectedClose"==e&&p.$broadcast("selectedClose")};var L=function(){if(p.category=p.myDicts.ticketCategory,D(),y){var e={states:y};r.queryFromCache(e,function(e){0==e.code&&S(e.data)})}else if(d.nodeId){if(!I)return;I&&(p.selectAlertList.searchStatus=!0,p.$broadcast(Event.ALERTINFOSINIT,{option:[]}))}else if(null!=m&&m.nodeId){if(!I)return;var t={};for(var a in I)t[a]=I[a];t&&S()}else p.selectAlertList.search&&I?(p.selectAlertList.searchStatus=!0,p.$broadcast(Event.ALERTINFOSINIT,{option:[]})):m&&m.viewId&&r.queryByView(m.viewId,null,function(e){0==e.code&&S(e.data)})};if(p.$on("searchAlertView",function(e,t){I=t.option,L()}),p.$on("alertViewClick",function(e,t){m=t.option,y=t.states,h=[],A=[],-1,p.selectAlertList.searchStatus=!1,L()}),p.$on("$destroy",function(){n.unregister(w)}),d.nodeId){D();var N={viewId:null,nodeId:d.nodeId};p.$broadcast("alertViewClick",{option:N})}}])});
//# sourceMappingURL=../../map/js/controllers/view-alert-ctrl.js.map
