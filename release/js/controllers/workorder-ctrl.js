define(["controllers/controllers","bootstrap-dialog"],function(t,m){"use strict";t.initController("WorkOrderCtrl",["$scope","ngDialog","resourceUIService","workflowService","ticketCategoryService","alertService","SwSocket","Info","userLoginUIService","growl","$routeParams","processService","ticketTaskService","ticketService",function(n,a,e,r,d,t,o,i,s,c,l,u,f,g){console.info("切换到工单管理"),n.editVisible=!1,n.addOrderShow=!1,n.processType=[],n.activeTab="执行中",n.activeListTab="tab1";var D=l.type,b=l.id;n.seleStatus=100,n.initAddList=function(){n.orderAddData={title:"",priorityCode:"0",ticketNo:"",category:"",ticketCategoryId:0,values:null,deviceId:"",faultId:"",message:""}},n.orderCount={doing:0,unpush:0,done:0,all:0};i.get("../localdb/info.json",function(t){n.priorityData=t.priorityData,n.statusData=t.statusData});n.formAryList=[],n.definitions={},n.selectItem="",n.process=function(){if(""!=n.orderAddData.ticketCategoryId&&null!=n.orderAddData.ticketCategoryId&&null!=n.orderAddData.ticketCategoryId){var t=n.orderAddData.ticketCategoryId.split(":");r.getWorkflowById(t[0],function(t){if(0==t.code){n.selectItem=t.data;var a=t.data.startAttributeDefinitions;for(var e in n.formAryList=[],a){var r={};r.label=a[e].label,r.name=a[e].name,r.dataType=a[e].dataType,n.definitions[a[e].label]="",n.formAryList.push(r)}}})}else n.formAryList=[]},n.initData={devicesAll:"",faultList:""},n.devicesAll="";n.findFault=function(){n.devicesDic[n.orderAddData.deviceId]&&e.findFaultKnowledgeByModelId(n.devicesDic[n.orderAddData.deviceId].modelId,function(t){0==t.code&&(n.initData.faultList=t.data)})};function v(){if("gateway"==D)f.getTicketsByStatusAndDeviceId(100,b,function(t){0==t.code&&(n.orderCount.doing=t.data.length)});else{var t={status:100};f.findTickets(t,function(t){0==t.code&&(n.orderCount.doing=t.data.length)})}}function p(){if("gateway"==D)f.getTicketsByStatusAndDeviceId(100,b,function(t){0==t.code&&(n.orderCount.doing=t.data.length)});else{var t={status:10};f.findTickets(t,function(t){0==t.code&&(n.orderCount.unpush=t.data.length)})}}function k(){if("gateway"==D)f.getTicketsByStatusAndDeviceId(100,b,function(t){0==t.code&&(n.orderCount.doing=t.data.length)});else{var t={status:200};f.findTickets(t,function(t){0==t.code&&(n.orderCount.done=t.data.length)})}}function O(){"gateway"==D?f.getTicketsByDeviceId(b,function(t){0==t.code&&(n.orderCount.all=t.data.length)}):f.getAllTickets(function(t){0==t.code&&(n.orderCount.all=t.data.length)})}function y(r){if("gateway"==D)f.getTicketsByStatusAndDeviceId(r,b,function(t){if(0==t.code){var a="",e=t.data.length;100==r?(n.orderCount.doing=e,a="doing",n.workOrderData.tab=!0):10==r?(n.orderCount.unpush=e,a="undo",n.workOrderData.tab=!1):200==r&&(n.orderCount.done=e,a="did",n.workOrderData.tab=!1),n.workOrderData.data=t.data,n.orderGirtData.data=t.data,n.workOrderData.state=a,10==r?n.$broadcast(Event.WORKORDERINIT+"_order",n.orderGirtData):n.$broadcast(Event.WORKORDERINIT,n.workOrderData)}});else{var t={status:r};f.findTickets(t,function(t){if(0==t.code){var a="",e=t.data.length;100==r?(n.orderCount.doing=e,a="doing",n.workOrderData.tab=!0):10==r?(n.orderCount.unpush=e,a="undo",n.workOrderData.tab=!1):200==r&&(n.orderCount.done=e,a="did",n.workOrderData.tab=!1),n.workOrderData.data=t.data,n.orderGirtData.data=t.data,n.workOrderData.state=a,10==r?n.$broadcast(Event.WORKORDERINIT+"_order",n.orderGirtData):n.$broadcast(Event.WORKORDERINIT,n.workOrderData)}})}}n.goSearch=function(){var t,a={};a.title=n.loaderValue,a.status=n.seleStatus,t=a,f.findTickets(t,function(t){if(0==t.code){var a=n.seleStatus,e="",r=t.data.length;100==a?(n.orderCount.doing=r,e="doing",n.workOrderData.tab=!0):10==a?(n.orderCount.unpush=r,e="undo",n.workOrderData.tab=!1):200==a&&(n.orderCount.done=r,e="did",n.workOrderData.tab=!1),n.workOrderData.data=t.data,n.orderGirtData.data=t.data,n.workOrderData.state=e,10==a?n.$broadcast(Event.WORKORDERINIT+"_order",n.orderGirtData):n.$broadcast(Event.WORKORDERINIT,n.workOrderData)}})},n.wordCancel=function(){n.$broadcast(Event.WORKORDERINIT+"_order",n.orderGirtData)},n.getOrderProcedure=function(){var t=n.processTypeData,a=[];for(var e in t)t[e].category==n.orderAddData.category&&a.push(t[e]);n.processType=a},n.addWorkOrder=function(t){t?n.orderAddData=t:n.initAddList(),n.workOrderType=n.myDicts.ticketCategory,a.open({template:"../partials/dialogue/add_workorder.html",scope:n,className:"ngdialog-theme-plain"})};n.saveOrder=function(){if(n.commitloading)c.warning("请等待，正在保存工单",{});else{n.commitloading=!0,n.orderAddData.values=n.definitions,n.orderAddData.deviceId=n.orderAddData.deviceId;var t=n.orderAddData;f.saveTicket(t,function(t){n.commitloading=!1,0==t.code&&(c.success("保存工单成功",{}),n.closeDialog(),n.initAddList(),O(),v(),p(),n.addOrderShow=!1,-1<n.activeTab.indexOf("未发布")?h(n.activeTab):$("#myTab li:eq(3) a").tab("show"))})}},n.cancelOrder=function(){n.addOrderShow=!1,c.info("取消发布工单",{}),n.initAddList()},n.uploadOrder=function(){if(n.commitloading)c.warning("请等待，正在发布工单");else{n.commitloading=!0,n.orderAddData.values=n.definitions,n.orderAddData.deviceId=n.orderAddData.deviceId;var t=n.orderAddData;f.commitTicket(t,function(t){if(n.commitloading=!1,0==t.code){if(c.success("发布工单成功",{}),n.closeDialog(),n.addOrderShow=!1,n.formAryList=[],10==n.orderAddData.status){var a=n.orderGirtData.data;for(var e in a)if(a[e].ticketCategoryId==t.data.ticketCategoryId){n.orderGirtData.data.splice(e,1);break}n.$broadcast(Event.WORKORDERINIT+"_order",n.orderGirtData)}n.initAddList(),O(),v(),k(),p(),-1<n.activeTab.indexOf("执行中")?h(n.activeTab):$("#myTab li:eq(0) a").tab("show")}else n.commitloading=!1,n.orderAddData.ticketCategoryId=""})}};var T=function(t){return t&&(t=newDateJson(t).Format(GetDateCategoryStrByLabel())),t};n.workOrderData={columnDefs:[{targets:1,data:"ticketNo",render:function(t,a,e){return t}},{targets:2,data:"ticketCategoryId",render:function(t,a,e){var r="";for(var d in n.processTypeData)n.processTypeData[d].id==t&&(r=n.processTypeData[d].name);return r}},{targets:3,data:"status",render:function(t,a,e){var r="",d="";return 10==t?(r="未发布",d="label-primary"):100==t?(r="处理中",d="label-warning"):200==t?(r="已完成",d="label-info"):150==t&&(r="已撤销",d="label-info"),"<span class='label "+d+"'>"+r+"</span>"}},{targets:5,data:"",render:function(t,a,e){return T(t)}},{targets:6,data:"",render:function(t,a,e){return T(t)}},{targets:8,data:"option",render:function(t,a,e){var r="<div class='btn-group btn-group-sm'>";return n.menuitems.A01_S09&&(r+="<button id='history'    class='btn btn-primary' ><i class='fa fa-edit hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'> 执行历史</span></button>"),(null==n.activeTab||-1<n.activeTab.indexOf("执行中")&&n.menuitems.A06_S09)&&(r+="<button id='revoke'   class='btn btn-default' ><i class='fa fa-trash hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'> 撤销</span></button>"),r+="</div>"}}]},n.orderGirtData={columns:[{data:"title",title:"工单名称"},{data:"ticketCategoryId",title:"工单流程"},{data:"status",title:"工单状态"},$.ProudSmart.datatable.optionCol2],columnDefs:[{targets:0,data:"title",render:function(t,a,e){return"<span style='cursor: pointer;'>"+t+"</span>"}},{targets:1,data:"ticketCategoryId",render:function(t,a,e){var r="";for(var d in n.processTypeData)n.processTypeData[d].id==t&&(r=n.processTypeData[d].name);return"<span style='cursor: pointer;'>"+r+"</span>"}},{targets:2,data:"status",render:function(t,a,e){return"<span style='cursor: pointer;' class='label "+(10==t?"label-primary":100==t?"label-warning":"label-info")+"'>"+(10==t?"未发布":100==t?"处理中":"已完成")+"</span>"}},{targets:3,data:"option",render:function(t,a,e){var r="<div class='btn-group btn-group-sm'>";return n.menuitems.A07_S09&&(r+="<button id='release-btn'   class='btn btn-default' ><i class='fa fa-trash hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'> 发布</span></button>"),n.menuitems.A08_S09&&(r+="<button id='del-btn'   class='btn btn-default' ><i class='fa fa-trash hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'> 删除</span></button>"),r+="</div>"}}]},n.cancelTicket=function(a){m.show({title:"提示",closable:!1,message:"确认要撤销该工单？",buttons:[{label:"确定",cssClass:"btn-success",action:function(t){t.close(),f.cancelTicket(a,function(t){if(0==t.code)if(c.success("撤销工单成功!",{}),"gateway"==D)f.getTicketsByStatusAndDeviceId(100,b,function(t){0==t.code&&(n.workOrderData.data=t.data,n.orderCount.doing=t.data.length,n.$broadcast(Event.WORKORDERINIT,n.workOrderData))});else{f.findTickets({status:100},function(t){n.workOrderData.data=t.data,n.orderCount.doing=t.data.length,n.$broadcast(Event.WORKORDERINIT,n.workOrderData)})}})}},{label:"取消",action:function(t){t.close()}}]})},n.delTicket=function(a){m.show({title:"提示",closable:!1,message:"是否要删除该工单",buttons:[{label:"确定",cssClass:"btn-success",action:function(t){g.deleteTicket(a,function(t){if(0==t.code)if(c.success("删除工单成功!",{}),"gateway"==D)f.getTicketsByStatusAndDeviceId(10,b,function(t){0==t.code&&(n.workOrderData.data=t.data,n.orderCount.doing=t.data.length,n.$broadcast(Event.WORKORDERINIT,n.workOrderData))});else{f.findTickets({status:10},function(t){n.orderGirtData.data=t.data,n.orderCount.unpush=t.data.length,n.$broadcast(Event.WORKORDERINIT+"_order",n.orderGirtData)})}}),t.close()}},{label:"取消",action:function(t){t.close()}}]})},n.tabStatus="false";var h=function(t){null==t||-1<t.indexOf("执行中")?(y(100),n.workOrderData.tab=!0,n.seleStatus=100):-1<t.indexOf("未发布")?(y(10),n.seleStatus=10):-1<t.indexOf("已完成")?(y(200),n.seleStatus=200,n.workOrderData.tab=!1):-1<t.indexOf("全部工单")&&("gateway"==D?f.getTicketsByDeviceId(b,function(t){0==t.code&&(n.orderCount.all=t.data.length)}):f.getAllTickets(function(t){0==t.code&&(n.workOrderData.data=t.data,n.orderCount.all=t.data.length,n.workOrderData.state="all",n.$broadcast(Event.WORKORDERINIT,n.workOrderData))}),n.seleStatus=0,n.workOrderData.tab=!1)};n.cancelOrderNo=function(){if("gateway"==D)f.getTicketsByStatusAndDeviceId(10,b,function(t){0==t.code&&(n.workOrderData.data=t.data,n.orderCount.doing=t.data.length,n.$broadcast(Event.WORKORDERINIT,n.workOrderData))});else{f.findTickets({status:10},function(t){n.orderGirtData.data=t.data,n.orderCount.unpush=t.data.length,n.$broadcast(Event.WORKORDERINIT+"_order",n.orderGirtData)})}};!function(){if($('a[data-toggle="tab"]').on("shown.bs.tab",function(t){if(0<$(t.target).closest("li.disabled").length)return $(t.target).closest("li.disabled").removeClass("active"),void $(t.target).closest("ul").children("[name="+n.activeListTab+"]").addClass("active");var a=$(t.target).closest("li").attr("name");a&&(n.activeListTab=a,n.$apply(),n.initAddList(),n.activeTab=$(t.target).text(),$(t.relatedTarget).text(),n.addOrderShow=!1,h(n.activeTab))}),n.initAddList(),p(),k(),O(),v(),d.getTicketCategorys(function(t){if(0==t.code){n.processTypeData=t.data;var a=[],e=[],r=[],d=[];for(var o in t.data)"10"==t.data[o].category?a.push(t.data[o]):"20"==t.data[o].category?e.push(t.data[o]):"30"==t.data[o].category?r.push(t.data[o]):"40"==t.data[o].category&&d.push(t.data[o]);n.processType1=a,n.processType2=e,n.processType3=r,n.processType4=d,y(100)}}),n.devicesDic={},e.getDevicesByCondition({},function(t){if(0==t.code){var a=[];a.push({text:"请选择",label:"请选择",id:"-1"}),t.data.forEach(function(t){t.label&&(t.text=t.label,n.devicesDic[t.id]=t,a.push(t))}),n.devicesAll=a}}),l&&l.state){var t="",a=null;switch(l.state){case"doing":t="执行中",a=0;break;case"did":t="已完成",a=1;break;case"all":t="全部工单",a=2;break;case"undo":t="未发布",a=3}$("#myTab li:eq("+a+") a").tab("show"),h(t)}else y(100)}()}])});
//# sourceMappingURL=../../map/js/controllers/workorder-ctrl.js.map
