function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}define(["controllers/controllers"],function(controllers){"use strict";controllers.controller("freeBoardCtrl",["$scope","$rootScope","$route","serviceProxy","$routeParams","$timeout","thridPartyApiService","userDomainService","kqiManagerUIService","userLoginUIService","dictionaryService","configUIService","kpiDataService","resourceUIService","SwSocket","Info","viewFlexService","growl","$q","$window","$location","solutionUIService","serviceCenterService","chartOptionService","toolbarListService","popup","angular-style","ticketTaskService","alertService","freeboardBaseService","projectUIService","customMethodService","ngDialog","commonMethodService","keySet",function(scope,rootScope,route,serviceProxy,routeParams,timeout,thridPartyApiService,userDomainService,kqiManagerUIService,userLoginUIService,dictionaryService,configUIService,kpiDataService,resourceUIService,SwSocket,Info,viewFlexService,growl,q,window,location,solutionUIService,serviceCenterService,chartOptionService,toolbarListService,popup,angularStyle,ticketTaskService,alertService,freeboardBaseService,projectUIService,customMethodService,ngDialog,commonMethodService,keySet){var currentView,loadedView,rootCi,status,allViews,allGraphViews,saveToManagement,titleComposory,CHARTDATA={},groupModels,globalModel,dashboardTemplate,target=$("#free-board-area"),JSONparse=function(e){var t;try{t=JSON.parse(e)}catch(e){t={}}finally{return t}},getTitle=function(e){switch(e){case"service":return"服务视图管理";case"editor":return"分析视图编辑器";default:return"仪表板编辑器"}},modelId,projectId,resourceId;scope.cachedBackwardJSON=[],scope.cachedForwardJSON=[],scope.instance=freeboardBaseService(target),scope.toolbarListMap=toolbarListService,scope.tempResClick=function(e){var t=JSON.stringify({modelId:e.modelId,resourceId:e.id});window.open("index.html#/template/device/dashboard/"+t,"_self")},scope.JSONParse=function(e){return"object"==_typeof(e)?e:"string"==typeof e?JSON.parse(e):{}},scope.backTemp=function(){var e=JSON.stringify({modelId:scope.tempResource.modelId});window.open("index.html#/template/model/dashboard/"+e,"_self")},scope.$on("$routeChangeSuccess",function(){var t;(rootScope.viewmode=route.current.$$route.originalPath.split("/")[1],scope.viewtype=route.current.$$route.originalPath.split("/")[2],rootScope.editorTitle=getTitle(rootScope.viewmode),"editor"==rootScope.viewmode)&&(CHARTDATA.defer=function(e){t=e},Info.get("../localdb/editor.json",function(e){CHARTDATA=e,$$.isFunction(t)&&t()}))}),scope.$on("viewChanged",function(e){scope.cachedBackwardJSON||(scope.cachedBackwardJSON=[]),scope.cachedBackwardJSON.push(scope.editData.$clone()),5<scope.cachedBackwardJSON.length&&scope.cachedBackwardJSON.shift()}),rootScope.backward=function(){if(0<scope.cachedBackwardJSON.length){scope.cachedForwardJSON.push(scope.editData.$clone()),5<scope.cachedForwardJSON.length&&scope.cachedForwardJSON.shift();var e=scope.cachedBackwardJSON[scope.cachedBackwardJSON.length-1];scope.editData=e,scope.cachedBackwardJSON.pop(),renderDataFn(!1)}},rootScope.forward=function(){if(0<scope.cachedForwardJSON.length){scope.cachedBackwardJSON.push(scope.editData.$clone()),5<scope.cachedBackwardJSON.length&&scope.cachedBackwardJSON.shift();var e=scope.cachedForwardJSON[scope.cachedForwardJSON.length-1];scope.editData=e,scope.cachedForwardJSON.pop(),renderDataFn(!1)}};var kqiModelId=routeParams.kqiModelId,solutionId=routeParams.solutionId,serviceViewId=routeParams.serviceViewId,flag=routeParams.flag,viewId=routeParams.viewId;scope.templateType=routeParams.type;var tempParams=routeParams.params;tempParams&&(tempParams=decodeURIComponent(tempParams),tempParams=JSON.parse(tempParams),modelId=tempParams.modelId,projectId=tempParams.projectId,resourceId=tempParams.resourceId),modelId&&resourceUIService.getResourceByModelId(modelId,function(e){0==e.code&&(scope.resources=e.data)}),resourceId&&resourceUIService.getResourceById(resourceId,function(e){0==e.code&&(scope.tempResource=e.data)});var path="../localdb/freeboard.json",exit=function(){window.open("","_self").close()};rootScope.dirty=null==viewId&&null==modelId&&null==projectId&&null==resourceId,loadedView={layout:{id:$randomString(32),type:"column",children:[],col:12},setting:{showNavi:!1,style:{padding:"5px"}}};var reconstruct=function reconstruct(target,callback){target.traveseByChild(function(element){if(element.onChange&&(element.onChange=eval(element.onChange)),"map"==element.type&&(element.source="BMAP"),"mapchart"==element.type&&(element.source="MAP"),element.source){var source=element.source;"object"==_typeof(source)&&(source=element.source="LISTTABLE");var sourceMode=freeBoardValue[source].$clone(),loop=function(o,e){if(-1!=["data","parameters","advance"].indexOf(o)){var t=function(e,t){null==element.$attr(o+"/"+e)&&element.$attr(o+"/"+e,t)};for(var a in e)t(a,e[a])}else null==element.$attr(o)&&element.$attr(o,e)};for(var i in sourceMode)loop(i,sourceMode[i]);if("TOPO"==element.source){var viewId=element.viewId;viewFlexService.getViewById(viewId,function(e){if(0==e.code&&e.data){var t=JSON.parse(e.data.content);element.JSON=t}})}}element.id=$randomString(32)}),replaceCiKpi.call(target,function(){timeout(function(){"function"==typeof callback?callback():renderDataFn()})})};function toolbar(e){this.$clone(e)}function subtoolbar(e){this.$clone(e)}function initData(){this.traverse(function(attr,element){element.hasOwnProperty("__onChange__")&&(element.onChange=eval(element.__onChange__),element.oldValue=element.value)})}function renderDataFn(e){if(null==scope.tabIndex)scope.instance.setMode(e),scope.instance.setButtonDisable(),scope.instance.renderLayout(scope.editData,null,scope);else{var t={layout:scope.editData.groups[scope.tabIndex].layout,setting:scope.editData.setting};scope.instance.setMode(e),scope.instance.setButtonDisable(),scope.instance.renderLayout(t,null,scope)}}function anchorChange(){var t=this.value,o=this.oldValue;curLayout().layout.traveseByChild(function(e){e.$attr("attributes/linkData/value")==o&&e.$attr("attributes/linkData/value",t)})}function setting(e){this.$clone(e)}function folder(){}function item(){}function renderToolbar(data){var rs;function traverse(target,data){for(var i in data){var constructor;if("object"==_typeof(data[i])&&null!=data[i])constructor=data[i].hasOwnProperty("$CLASS")?eval(data[i].$CLASS):data[i].constructor,target[i]=new constructor,target[i].parent=target,Object.defineProperty(target[i],"parent",{enumerable:!1}),traverse(target[i],data[i]);else"$CLASS"!=i&&(target[i]=data[i])}}return rs="object"==_typeof(data)&&null!=data?new data.constructor:data,traverse(rs,data),rs}function linkOnchange(){this.parent.color.value="#3c8dbc"}function remapData(e){return e.$remapByChild(function(e){var t=e.source;if(t){if(!window.freeBoardValue[t])throw new Error(t+"组件不存在");e.label=window.freeBoardValue[t].label}var o=commonMethodService(e,scope);return o.setRootTarget(scope.editData),o})}function isObjectLike(e){return new RegExp("^\\{.*\\}$","g").test(e)}function getDashboard(){var e,t,o,a=(e=currentView)&&isObjectLike(e.content)?JSON.parse(e.content):null;if(a)if("dashboard"==currentView.viewType||"designView"==currentView.viewType||"serviceView"==currentView.viewType)if(o=a.setting,null==a.groups)t=remapData(a.data||a.layout),scope.editData={layout:t,setting:o};else{for(var i in scope.editData=a.$clone(),scope.editData.groups)scope.editData.groups[i].layout=remapData(scope.editData.groups[i].layout);scope.tabIndex=0}else a.rows?o=3==a.rows.length?(t=remapData(machineDashboard.data.$clone()),machineDashboard.setting.$clone()):(t=remapData(standardDashboard.data.$clone()),standardDashboard.setting.$clone()):(t=remapData(standardDashboard.data.$clone()),o=standardDashboard.setting.$clone(),scope.editData={layout:t,setting:o});else t=remapData(standardDashboard.data.$clone()),o=standardDashboard.setting.$clone(),scope.editData={layout:t,setting:o};if(loadedView=scope.editData.$clone(),null==scope.tabIndex)reconstruct(scope.editData.layout);else{var r=[];for(var i in scope.editData.groups){r.push(function(e,t){var o=q.defer();return reconstruct(t.layout,function(){o.resolve("success")}),o.promise}(0,scope.editData.groups[i]))}q.all(r).then(function(){renderDataFn()})}}function getDashboardSolution(e){if(e.code){if(null!=e.data){var t,o=JSON.parse(e.data);t="V_2"==o.version?(currentView=e.data,o):201==serviceViewId?machineDashboard.$clone():standardDashboard.$clone()}else t=201==serviceViewId?machineDashboard.$clone():standardDashboard.$clone();scope.editData={layout:t.data,setting:t.setting},loadedView={layout:t.data,setting:t.setting}.$clone();var a=curLayout().layout;reconstruct(a)}}function modelSelector(e){"object"==_typeof(e)&&null!=e&&this.$clone(e)}function onTabClick(e,t,a,i){scope.dialog={title:{label:"标签信息"},input:[{label:"修改标签名称",value:a.tabName,composory:!0,data:"tabName",type:"input",maxlength:32,events:{change:function(e){}}},{label:"设为启始标签",value:a.default,composory:!1,data:"default",type:"checkbox",maxlength:32,onChange:function(e){0==e.value&&(e.value=!0)}}],fnlist:[{label:"确定",icon:"btn btn-primary",fn:function(){rootScope.dirty=!0,scope.$broadcast("viewChanged");var e=scope.dialog.input[1].value;if(1==e){for(var t in i.children)i.children[t].default=!1;var o=i.children.indexOf(a);i.tabInx=o}a.tabName=scope.dialog.input[0].value,a.default=e,timeout(function(){renderDataFn()}),ngDialog.close()}},{label:"取消",icon:"btn btn-default",fn:function(){ngDialog.close()}}]},ngDialog.open({template:"../partials/dialogue/common_dia.html",className:"ngdialog-theme-plain",scope:scope})}function panelCancel(){scope.unitFilter="",scope.unitFilterDisabled=!1,scope.dataPanel=void 0,scope.editPanel=void 0,scope.resources=void 0,scope.kpis=void 0}function dataPanelShow(e){scope.dataPanel=e.$clone(),scope.dataPanel.data.model=scope.allModels.find(function(e){return e.id==scope.dataPanel.data.model.id}),scope.dataPanel.data.model.change().then(function(){for(var t in scope.resources){var e=!1;scope.dataPanel.data.resource&&(e=scope.dataPanel.data.resource.some(function(e){return scope.resources[t].id==e.id})),scope.resources[t].checked=e}for(var t in scope.kpis){var o;scope.dataPanel.data.kpi&&(o=scope.dataPanel.data.kpi.find(function(e){return scope.kpis[t].id==e.id})),o&&(scope.unitFilter=o.unit,scope.unitFilterDisabled=!0),scope.kpis[t].checked=null!=o}})}function refineDataStructure(){this.traveseByChild(function(e){if(delete e.id,e.$$hashKey&&delete e.$$hashKey,e.JSON&&delete e.JSON,"injector"==e.type&&(e.children=[]),e.hasOwnProperty("tabInx")&&delete e.tabInx,e.hasOwnProperty("template")&&delete e.template,e.hasOwnProperty("$index")&&delete e.$index,e.hasOwnProperty("id")&&delete e.id,e.data&&(e.data.model&&"object"==_typeof(e.data.model)&&(e.data.model={id:e.data.model.id}),e.data.legend&&("function"==typeof e.data.legend.manual&&(e.data.legend.manual="("+e.data.legend.manual.toString()+")"),"function"==typeof e.data.legend.bind&&(e.data.legend.bind="("+e.data.bind.manual.toString()+")")),e.data.xAxis&&("function"==typeof e.data.xAxis.manual&&(e.data.xAxis.manual="("+e.data.xAxis.manual.toString()+")"),"function"==typeof e.data.xAxis.bind&&(e.data.xAxis.bind="("+e.data.xAxis.bind.toString()+")")),e.data.series&&("function"==typeof e.data.series.manual&&(e.data.series.manual="("+e.data.series.manual.toString()+")"),"function"==typeof e.data.series.bind&&(e.data.series.bind="("+e.data.series.bind.toString()+")")),e.data.resource&&(e.data.resource=e.data.resource.map(function(e){return $$.noEmptyObject(e)&&$$.noEmptyObject(rootCi)?e.id==rootCi.id?"rootCi":e.id:e})),e.data.kpi&&(e.data.kpi=e.data.kpi.map(function(e){return $$.noEmptyObject(e)?e.id:e})),e.data.kqiModel&&"object"==_typeof(e.data.kqiModel)&&(e.data.kqiModel={id:e.data.kqiModel.id})),e.attributes)for(var t in e.attributes){var o={value:e.attributes[t].value};null!=e.attributes[t].applied&&(o.applied=e.attributes[t].applied),e.attributes[t].data&&o.$extension({data:{value:e.attributes[t].data.value}}),e.attributes[t]=o}})}function saveManagement(e,t){var o={viewTitle:"dashboard",viewName:"dashboard",viewType:"dashboard",content:JSON.stringify(e)};viewFlexService.saveManageDashboard(o,function(e){0==e.code?(growl.success("仪表板视图修改成功",{}),t&&t()):(growl.error("运营首页修改失败",{}),getViews())})}function init(n){!function(){for(var e=[],a=[],t=0;t<80;t++){var o=Math.round(100*Math.random()),i=Math.round(1e3*Math.random())/100;e.push([o,i])}function r(){var t=function(){serviceCenterService.models.getAll().then(function(e){Array.prototype.push.apply(a,e),scope.allModels=a.map(function(e){return new modelSelector(e)});var t,o=!1;"template"==scope.viewmode?o=!!(t=scope.allModels.find(function(e){return e.id==modelId})):currentView&&currentView.hasOwnProperty("template")&&(o=!!(t=scope.allModels.find(function(e){return e.id==currentView.$attr("template/resourceId")}))),scope.globalModel.model=t,scope.globalModel.enable=o,currentView||("freeboard"==scope.viewmode?(scope.firstCreate=!0,scope.template=[{id:-1,title:"空白视图"}].concat(window.template)):"editor"==scope.viewmode?(scope.firstCreate=!0,scope.specialist=[{id:-1,label:"空白视图"}].concat(window.specialistView)):scope.setting=new setting({theme:JSONparse(scope.editData.setting).theme||"default",data:scope.editData.setting})),function(){for(var e in freeBoardValue.TEXT.$extension({data:{modelType:300,resfilltype:"parameter",modelDisable:"freeboard"==rootScope.viewmode}}),freeBoardValue.DATALIST.$extension({data:{modelType:300,resfilltype:"parameter",modelDisable:"freeboard"==rootScope.viewmode}}),freeBoardValue.LINECHART.$extension({data:{modelType:300,resfilltype:"parameter",modelDisable:"freeboard"==rootScope.viewmode}}),freeBoardValue.RADARCHART.$extension({data:{modelType:300,resfilltype:"parameter",modelDisable:"freeboard"==rootScope.viewmode}}),freeBoardValue.BARCHART.$extension({attributes:{modelGroup:{applied:!1,default:"不采用设备组",label:"设备组",value:groupModels[0]?groupModels[0].value:"",type:"select",option:groupModels}},data:{modelType:300,resfilltype:"parameter",modelDisable:"freeboard"==rootScope.viewmode}}),freeBoardValue.GAUGECHART.$extension({data:{modelType:300,resfilltype:"parameter",modelDisable:"freeboard"==rootScope.viewmode}}),freeBoardValue.PIECHART.$extension({data:{modelType:300,resfilltype:"parameter",modelDisable:"freeboard"==rootScope.viewmode}}),freeBoardValue.SCATTERCHART.$extension({data:{modelType:300,resfilltype:"parameter",modelDisable:"freeboard"==rootScope.viewmode}}),freeBoardValue.BARCHART.$extension({data:{modelType:300,resfilltype:"parameter",modelDisable:"freeboard"==rootScope.viewmode}}),scope.tools={grid:freeBoardValue.ROW,datalist_wrap:{label:"控制板2",type:"box",class:"box box-info",source:"BOX",parameters:{title:"数据列表"},style:{"font-size":"12px","font-weight":"bold","text-align":"left",margin:"5px"},children:[{type:"box-body",children:[{type:"column",col:12,children:[freeBoardValue.DATALIST.$clone()]}],class:"box-body"},{type:"box-footer",children:[{type:"column",col:12,children:[]}],class:"box-footer"}]},totalItemTemp:{label:"控制器1",type:"row",children:[{type:"column",col:3,children:[freeBoardValue.TOTALITEM.$clone().$extension({attributes:{title:{data:{value:"value"}},subtitle:{data:{value:"kpi"}},unit:{value:"个",data:{value:"none"}},icon:{value:{perfix:"fa",css:"fa-connectdevelop",id:"0"}},color:{value:"#25bce7"}},data:{modelType:300,resfilltype:"parameter",kpi:[3001]}})]},{type:"column",col:3,children:[freeBoardValue.TOTALITEM.$clone().$extension({attributes:{title:{data:{value:"value"}},subtitle:{data:{value:"kpi"}},unit:{value:"个",data:{value:"none"}},icon:{value:{perfix:"fa",css:"fa-edit",id:"2"}},color:{value:"#00b9b2"}},data:{modelType:300,resfilltype:"parameter",kpi:[3002]}})]},{type:"column",col:3,children:[freeBoardValue.TOTALITEM.$clone().$extension({attributes:{title:{data:{value:"value"}},subtitle:{data:{value:"kpi"}},unit:{label:"单位",data:{value:"none"}},icon:{label:"图标",value:{perfix:"fa",css:"fa-warning",id:"1"}},color:{value:"#e7675d"}},data:{modelType:300,resfilltype:"parameter",kpi:[3003]}})]},{type:"column",col:3,children:[freeBoardValue.TOTALITEM.$clone().$extension({attributes:{title:{data:{value:"value"}},subtitle:{data:{value:"kpi"}},icon:{value:{perfix:"fa",css:"fa-user",id:"4"}},unit:{value:"条",data:{value:"none"}},color:{value:"#ebae0b"}},data:{modelType:300,resfilltype:"parameter",kpi:[3004]}})]}]},totalItem:freeBoardValue.TOTALITEM.$clone().$extension({data:{modelType:300,resfilltype:"parameter"}}),downtab:freeBoardValue.DOWNTAB.$clone().$extension({data:{modelType:300,resfilltype:"parameter"}}),mapchartTemp:{label:"控制板2",type:"box",class:"box box-info",source:"BOX",parameters:{title:"标题文字"},style:{"font-size":"12px","font-weight":"bold","text-align":"left",margin:"5px"},children:[{type:"box-body",children:[{type:"column",col:8,children:[freeBoardValue.BMAP.$clone().$extension({style:{height:"452px"}})]},{type:"column",col:4,children:[{label:"控制板1",type:"block",source:"BLOCK",style:{margin:"0 5px 0 0",border:"1px solid rgba(147,196,129,1)","background-color":"rgba(0,185,178,1)"},children:[{type:"column",col:12,children:[freeBoardValue.SPARKLINE.$clone().$extension({style:{height:"150px"},data:{modelType:300,resfilltype:"parameter",kpi:[3005]}}),freeBoardValue.SPARKLINE.$clone().$extension({style:{height:"150px"},data:{modelType:300,resfilltype:"parameter",kpi:[3012]}}),freeBoardValue.SPARKLINE.$clone().$extension({style:{height:"150px"},data:{modelType:300,resfilltype:"parameter",kpi:[100005]}})]}]}]}],class:"box-body"},{type:"box-footer",children:[{type:"row",children:[]}],class:"box-footer"}]},mapchartLinkTemp:{label:"控制板2",type:"box",class:"box box-info",source:"BOX",parameters:{title:"标题文字"},style:{"font-size":"12px","font-weight":"bold","text-align":"left",margin:"5px"},attributes:{text:{label:"标题文字",value:"设备分布",type:"standardInput"},color:{label:"颜色",value:"#333",type:"colorPicker"},fontSize:{label:"字体大小",value:18,type:"slider"},position:{label:"对齐",value:"left",type:"select",option:[{label:"左对齐",value:"left"},{label:"中间对齐",value:"center"}]},weight:{label:"粗细",value:"bold",type:"select",option:[{label:"正常",value:"normal"},{label:"粗体",value:"bold"}]}},children:[{type:"box-body",children:[{type:"column",col:7,children:[{type:"mapchart",data:{bindTo:"mapChartBindLink"},children:[]}]},{type:"column",col:5,children:[{type:"list",attributes:{fun:{value:"ticketService.getTicketsByStatus"}},data:{bindTo:"mapChartBindLink"}}]}],class:"box-body"},{type:"box-footer",children:[{type:"row",children:[]}],class:"box-footer"}]},piechartTemp:{label:"控制板2",type:"box",class:"box box-info",source:"BOX",parameters:{title:"标题文字"},style:{"font-size":"12px","font-weight":"bold","text-align":"left",margin:"5px"},children:[{type:"box-body",children:[{type:"column",col:12,children:[freeBoardValue.PIECHART.$clone().$extension({attributes:{title:{value:""},subtitle:{value:""},dataType:{value:"alert"},value:{data:{value:"value"}},legend:{data:{value:"value"}}}})]}],class:"box-body"},{type:"box-footer",children:[{type:"column",col:12,children:[{type:"alertcount",children:[]}]}],class:"box-footer"}]},warningMapTemp:{label:"控制板2",type:"box",class:"box box-info",source:"BOX",parameters:{title:"最近一周告警情况"},style:{"font-size":"12px","font-weight":"bold","text-align":"left",margin:"5px"},children:[{type:"box-body",children:[{type:"column",col:8,children:[{label:"线图",type:"echart",source:"LINECHART",help:"../app-free-style/index.html#/help/index%7Cechart/%5B%220%22,%7B%7D%5D",data:{applied:!1,resource:[],modelDisable:!0,modelType:300,resfilltype:"parameter",timespan:{value:24,unit:"hour"},frequency:{value:30,unit:"minute"},aggregate_rule:0,aggregate_instance:[],aggregate_period:15,aggregate_type:[1],autoFillBlank:!0,format:"年月日",grid:[{}],legend:{manual:["第一组","第二组","第三组"],bind:"(function (source){\n  var formatter=function(elem){\n    return elem.kpi\n   }\n  return source.time.getSeries(formatter);\n})"},xAxisType:"category",xAxis:{manual:[["第一个数据","第二个数据","第三个数据","第四个数据","第五个数据","第六个数据"]],bind:"(function (source){\n  var formatter=function(elem){\n    return elem.kpi\n   }\n  return source.time.getxAxis(formatter);\n})"},yAxisType:"value",yAxis:{manual:[["第一个数据","第二个数据","第三个数据","第四个数据","第五个数据","第六个数据"]],bind:"(function (source){\n  var formatter=function(elem){\n    return elem.kpi\n   }\n  return source.time.getxAxis(formatter);\n})"},series:{manual:[{name:"第一组",data:[120,85,64,130,152,87]},{name:"第二组",data:[88,120,180,78,232,140]},{name:"第三组",data:[50,80,140,60,70,90]}],bind:"(function (source){\n   var formatter=function(elem){\n    return elem.kpi\n   }\n  return source.time.getSeries(formatter);\n})"},kpi:[3006,3007,3008,3009]},advance:{variable:"",getfunction:"kpiDataService.getValueList",category:"time",custom_category:"",condition:["kpi","{object:kpiQueryModel}"],expression:{}},parameters:{title:"主标题",subtitle:"附标题"},style:{margin:"auto",width:"100%",height:"300px"},echart:{general:{},title:{padding:30,text:"草莓大棚温度变化",textStyle:{fontWeight:"bold",fontSize:16}},toolbox:{},tooltip:{trigger:"axis"},legend:{data:["数据1","数据2","数据3"]},grid:[{}],xAxis:[{type:"category",boundaryGap:!1,axisLine:{lineStyle:{color:"#b0b0b0",width:1}},splitLine:{lineStyle:{color:"rgb(239, 239, 239)",width:1}}}],yAxis:[{show:!0,max:"auto",min:"auto",type:"value",boundaryGap:!1,axisLine:{lineStyle:{color:"#b0b0b0",width:1}},splitLine:{lineStyle:{color:"rgb(239, 239, 239)",width:1}},axisLabel:{show:!0,textStyle:{}},axisTick:{show:!0,lineStyle:{}}}],series:[{name:"数据1",type:"line",markPoint:{data:[{name:"最大值",type:"max"},{name:"最小值",type:"min"}]}},{name:"数据2",type:"line",markPoint:{data:[{name:"最大值",type:"max"},{name:"最小值",type:"min"}]}},{name:"数据3",type:"line",markPoint:{data:[{name:"最大值",type:"max"},{name:"最小值",type:"min"}]}}],visualMap:[]},template:[{label:"基础线图",type:"image",url:"images/line/line1.png",style:{margin:"auto",width:"100%",height:"300px"},echart:{general:{},title:{padding:30,text:"草莓大棚温度变化",textStyle:{fontWeight:"bold",fontSize:16}},toolbox:{},legend:{data:["数据1","数据2","数据3"]},grid:[{}],tooltip:{trigger:"axis"},xAxis:[{type:"category",boundaryGap:!1,axisLine:{lineStyle:{color:"#b0b0b0",width:1}},splitLine:{lineStyle:{color:"rgb(239, 239, 239)",width:1}}}],yAxis:[{show:!0,max:"auto",min:"auto",type:"value",boundaryGap:!1,axisLine:{lineStyle:{color:"#b0b0b0",width:1}},splitLine:{lineStyle:{color:"rgb(239, 239, 239)",width:1}},axisLabel:{show:!0,textStyle:{}},axisTick:{show:!0,lineStyle:{}}}],series:[{name:"数据1",type:"line",markPoint:{data:[{name:"最大值",type:"max"},{name:"最小值",type:"min"}]}},{name:"数据2",type:"line",markPoint:{data:[{name:"最大值",type:"max"},{name:"最小值",type:"min"}]}},{name:"数据3",type:"line",markPoint:{data:[{name:"最大值",type:"max"},{name:"最小值",type:"min"}]}}]}},{label:"堆积线图",type:"image",url:"images/line/line2.png",style:{margin:"auto",width:"100%",height:"300px"},echart:{general:{},title:{},legend:{data:["数据1","数据2","数据3"]},grid:[{}],xAxis:[{boundaryGap:!1,type:"category"}],yAxis:[{type:"value"}],series:[{stack:"总量",name:"数据1",type:"line"},{stack:"总量",name:"数据2",type:"line"}],toolbox:{},tooltip:{}}},{label:"对数轴",type:"image",url:"images/line/line3.png",style:{margin:"auto",width:"100%",height:"300px"},echart:{general:{},title:{},legend:{data:["数据1","数据2","数据3"]},grid:[{}],xAxis:[{boundaryGap:!1,type:"category"}],yAxis:[{type:"log"}],series:[{name:"数据1",type:"line"},{name:"数据2",type:"line"},{name:"数据3",type:"line"}],toolbox:{},tooltip:{}}},{label:"面积线图",type:"image",url:"images/line/line4.png",style:{margin:"auto",width:"100%",height:"300px"},echart:{general:{},title:{padding:30,text:"草莓大棚温度变化",textStyle:{fontWeight:"bold",fontSize:16}},toolbox:{},tooltip:{trigger:"axis"},legend:{data:["数据1","数据2","数据3"]},xAxis:[{type:"category",boundaryGap:!1,axisLine:{lineStyle:{color:"#b0b0b0",width:1}},splitLine:{lineStyle:{color:"rgb(239, 239, 239)",width:1}}}],yAxis:[{show:!0,max:"auto",min:"auto",type:"value",boundaryGap:!1,axisLine:{lineStyle:{color:"#b0b0b0",width:1}},splitLine:{lineStyle:{color:"rgb(239, 239, 239)",width:1}},axisLabel:{show:!0,textStyle:{}},axisTick:{show:!0,lineStyle:{}}}],series:[{name:"数据1",type:"line",areaStyle:{normal:{show:!0}}},{name:"数据2",type:"line",areaStyle:{normal:{show:!0}}},{name:"数据3",type:"line",areaStyle:{normal:{show:!0}}}]}},{label:"面堆积线图",type:"image",url:"images/line/line5.png",style:{margin:"auto",width:"100%",height:"300px"},echart:{general:{},title:{padding:30,text:"草莓大棚温度变化",textStyle:{fontWeight:"bold",fontSize:16}},toolbox:{},tooltip:{trigger:"axis"},legend:{data:["数据1","数据2","数据3"]},grid:[{}],xAxis:[{type:"category",boundaryGap:!1,axisLine:{lineStyle:{color:"#b0b0b0",width:1}},splitLine:{lineStyle:{color:"rgb(239, 239, 239)",width:1}}}],yAxis:[{show:!0,max:"auto",min:"auto",type:"value",boundaryGap:!1,axisLine:{lineStyle:{color:"#b0b0b0",width:1}},splitLine:{lineStyle:{color:"rgb(239, 239, 239)",width:1}},axisLabel:{show:!0,textStyle:{}},axisTick:{show:!0,lineStyle:{}}}],series:[{stack:"总量",name:"数据1",type:"line",areaStyle:{normal:{show:!0}}},{stack:"总量",name:"数据2",type:"line",areaStyle:{normal:{show:!0}}},{stack:"总量",name:"数据3",type:"line",areaStyle:{normal:{show:!0}}}]}},{label:"双坐标轴图",type:"image",url:"images/line/line6.png",style:{margin:"auto",width:"100%",height:"600px"},echart:{general:{},title:{padding:30,text:"草莓大棚温度变化",textStyle:{fontWeight:"bold",fontSize:16}},legend:{data:["数据1","数据2","数据3"]},grid:[{left:50,right:50,height:"35%"},{left:50,right:50,top:"55%",height:"35%"}],toolbox:{},tooltip:{trigger:"axis"},xAxis:[{type:"category",boundaryGap:!1},{gridIndex:1,type:"category",boundaryGap:!1,position:"top"}],yAxis:[{name:"流量(m^3/s)",type:"value"},{gridIndex:1,name:"降雨量(mm)",type:"value",inverse:!0}],series:[{name:"数据1",type:"line",symbolSize:16},{name:"数据2",type:"line",xAxisIndex:1,yAxisIndex:1,symbolSize:16},{name:"数据3",type:"line",xAxisIndex:1,yAxisIndex:1,symbolSize:16}]}}],id:"6HymH6eC2aQ5PPdBwDPaFYPxWSmibC5B",resource_time:{}}],id:"R47z77CYWWP5HHQn6pMADQdhW7kJDb3c"},{type:"column",col:4,children:[{type:"row",children:[{type:"column",col:12,children:[{label:"文字",type:"text",source:"TEXT",help:"http://localhost/app-free-style/index.html#/help/index%7Ctext/%5B%220%22,%7B%7D%5D",data:{applied:!1,multipleCi:!1,multipleKpi:!1,resource:[],modelType:300,resfilltype:"parameter",series:{manual:"处理情况",bind:"(function (source){\n  return source.getSeries();\n})"},modelDisable:!0},style:{margin:"5px auto",padding:"0","font-size":"12px","font-weight":"bold","border-width":"0px","text-align":"center"},advance:{getfunction:"kpiDataService.getValueList",category:"ci",condition:["kpi","{object:kpiQueryModel}"],expression:'expression = {\n    on : {\n        init : function(event){\n            var target = event.target;\n            target.setText("新建文字")\n        }\n    }\n}'},template:[{type:"text",style:{margin:"auto",padding:"0","font-size":"10px","font-weight":"bold",color:"#333"}},{type:"text",style:{margin:"auto",padding:"0","font-size":"16px","font-weight":"bold",color:"#666","text-align":"center"}},{type:"text",style:{width:"60px",height:"60px",margin:"auto",padding:"0","font-size":"12px","line-height":"60px","font-weight":"bold",color:"#fff","text-align":"center","border-radius":"50%","background-color":"#3c8dbc"}},{type:"text",style:{width:"140px",height:"60px",margin:"auto",padding:"0","font-size":"12px","line-height":"60px","font-weight":"bold",color:"#fff","text-align":"center","border-radius":"4px","background-color":"#3c8dbc"}},{type:"text",style:{width:"140px",height:"60px",margin:"auto",padding:"0","font-size":"12px","line-height":"60px","font-weight":"bold",color:"#444","text-align":"center","border-radius":"4px","background-color":"#eee"}},{type:"text",style:{margin:"auto",padding:"5px","font-size":"18px","font-weight":"bold",color:"#444","text-align":"center","border-radius":"0px","background-color":"#eee"}}],id:"FzNAswf4ZrJnTjWDz8QdhXTwYQWxMXAs"},{label:"百分比状态条",type:"progress",source:"PROGRESS",advance:{getfunction:"kpiDataService.getValueList",category:"ci",condition:["kpi","{object:kpiQueryModel}"],expression:""},data:{applied:!1,multipleCi:!1,multipleKpi:!1,resource:[],modelDisable:!0,modelType:300,resfilltype:"parameter",series:{manual:[{data:[{name:"指标",value:90}]}],bind:"(function (source){\n  var formatter=function(elem){\n    return elem.kpi\n   }\n  return source.ci.getSeries(formatter);\n})"},kpi:[100002]},id:"RPEr8iAt3SByJwwXFRnczbSkFHR83zYW"},{label:"百分比状态条",type:"progress",source:"PROGRESS",advance:{getfunction:"kpiDataService.getValueList",category:"ci",condition:["kpi","{object:kpiQueryModel}"],expression:""},data:{applied:!1,multipleCi:!1,multipleKpi:!1,resource:[],modelDisable:!0,modelType:300,resfilltype:"parameter",series:{manual:[{data:[{name:"指标",value:90}]}],bind:"(function (source){\n  var formatter=function(elem){\n    return elem.kpi\n   }\n  return source.ci.getSeries(formatter);\n})"},kpi:[100004]},id:"5wnnSPf7yYmDN3yBGpyZrGTYkW4nXDcT"}],id:"srEECX5j4pJEeijNPk88f27YZwp7Tt7w"}],id:"MrNYhzNNyHGQHe5KwwiziDYHGPWdTmZy",source:"ROW"}],id:"3YWchjGDckGzeF5s3Mk86n4CKj64WeJt"}],class:"box-body",id:"zP3MPNW2ai5b7bbr5mKYfSm6szFCXrcD"},{type:"box-footer",children:[{type:"column",col:3,children:[{type:"row",children:[{type:"column",col:12,children:[{label:"环比标签",type:"downTab",source:"DOWNTAB",data:{applied:!1,multipleCi:!1,multipleKpi:!1,resource:[],modelDisable:!0,modelType:300,resfilltype:"parameter",series:{manual:[{name:"指标",data:[60,70,80,90,100]}],bind:"(function (source){\n  return source.time.getSeries();\n})"}},id:"mBFpBH7p4JCSQyk6H2CtnSTPykzTenr5"}],id:"hp3WaMD2kGhcM2mhD4EbnkSKjYs7wKY5"}],id:"kbJHZJD4YP7CQSDEcDCfQA7eDmzf6DAa",source:"ROW"}],id:"Ka5YZdRA3483d4BMXzWm3CihefnNBKSA"},{type:"column",col:3,children:[{type:"row",children:[{type:"column",col:12,children:[{label:"环比标签",type:"downTab",source:"DOWNTAB",data:{applied:!1,kpi:[],modelType:300,resfilltype:"parameter",resource:[],multipleCi:!1,multipleKpi:!1,series:{manual:'[\n  {\n    "name": "指标",\n    "data": [\n      60,\n      70,\n      80,\n      120,\n      100\n    ]\n  }\n]',bind:"(function (source){\n  return source.time.getSeries();\n})"}},id:"XxiSTfPFmtpFBRhSKCjpJErXtnWRMHFn",$index:[0,0]}],id:"dcNQsbxxN5dsmxCWmTNMMYNbTFQyxBXz"}],id:"K7rQRk3AWdmyh2j53YbbZK8GyJs2rn3t",source:"ROW"}],id:"nEY7NzkpYHYC6Pni2mBHjkCbYMaGDExn"},{type:"column",col:3,children:[{type:"row",children:[{type:"column",col:12,children:[{label:"环比标签",type:"downTab",source:"DOWNTAB",data:{applied:!1,multipleCi:!1,multipleKpi:!1,resource:[],modelDisable:!0,modelType:300,resfilltype:"parameter",series:{manual:[{name:"指标",data:[60,70,80,90,100]}],bind:"(function (source){\n  return source.time.getSeries();\n})"}},id:"k8rPPWfmtGdcz5Ntffe8fXsMApxkzePE"}],id:"WGQkZKY82WZKhyXZZNPAjh2P6p8ekhir"}],id:"Ajc67sHcmPtAfMCFSkk5DnnT7FxbGn68",source:"ROW"}],id:"myKtr6ftX4x5ytbkKkw3ieXxQyfPi45C"},{type:"column",col:3,children:[{type:"row",children:[{type:"column",col:12,children:[{label:"环比标签",type:"downTab",source:"DOWNTAB",data:{applied:!1,kpi:[],modelType:300,resfilltype:"parameter",resource:[],multipleCi:!1,multipleKpi:!1,series:{manual:'[\n  {\n    "name": "指标",\n    "data": [\n      120,\n      70,\n      80,\n      90,\n      100\n    ]\n  }\n]',bind:"(function (source){\n  return source.time.getSeries();\n})"}},id:"x5wdhitTAcyTw2RfMz3yGp2WsxSfAkMB",$index:[0,0]}],id:"ycGwrJfnXDkKwX4c4AF4ERmyxxspYfeh"}],id:"dmjDRfHy2wtjPAFkcbzwZybinf5Sk6Mt",source:"ROW"}],id:"dniekBCcRpT73p54b3axmD7p68cpTw6f"}],class:"box-footer",id:"GJGepfSKasQBzGPeDWK7erbFPyedK7i2"}],url:"images/map/map1.png",id:"DXnDspipMN7c247NrrWfhEHT3aiZ44RN"},kpilist:freeBoardValue.KPILIST.$clone().$extension({data:{modelType:300,resfilltype:"parameter"}})},freeBoardValue){var t=e.toLowerCase();t&&(scope.tools[t]||(scope.tools[t]=freeBoardValue[e].$clone()))}for(var e in dashboardTemplate){var o=JSON.parse(dashboardTemplate[e].value);scope.tools["template_"+dashboardTemplate[e].id]=o}for(var e in scope.tools)replaceCiKpi.call(scope.tools[e]);"function"==typeof n&&n()}()},function(e){growl.error("获取不到模型列表。",{})})};if("editor"==rootScope.viewmode)if($$.isFunction(CHARTDATA.defer))CHARTDATA.defer(function(){var e=scope.toolBarList[5].sub[0].option;freeBoardValue.SCATTERCHART.$extension(CHARTDATA[e]),t()});else{var e=scope.toolBarList[5].sub[0].option;freeBoardValue.SCATTERCHART.$extension(CHARTDATA[e]),t()}else t();renderDataFn()}serviceCenterService.rootDomain.get().then(function(e){e&&(rootCi=e);var t=[e.modelId];resourceUIService.getModelByIds(t,function(e){e.data[0],r()},function(e){"databack is undefined !!"==e.message&&growl.error("输入的模型ID获取不到模型信息。",{}),r()})},function(e){"databack is undefined !!"==e.message&&growl.error("根设备不存在",{}),rootCi=null,r()})}()}function replaceCiKpi(e){"function"==typeof e&&e()}toolbar.prototype.click=function(){scope.toolbarDetail=this.$clone(),scope.toolbarDetail.sub=scope.toolbarDetail.sub.map(function(e){return new subtoolbar(e)})},subtoolbar.prototype.click=function(){var e,t,o=this.source,a=window.freeBoardValue[o],i=this.template,r=(e=i,a.template[e]);t=r,a.echart=t.echart,a.style=t.style,a.id=$randomString(32),scope.toolbarDetail=void 0,(o=a.source)&&(a.label=window.freeBoardValue[o].label);var n=remapData(a);scope.$broadcast("viewChanged"),curLayout().layout.children.push(n),renderDataFn(!1),rootScope.dirty=!0},saveToManagement=routeParams.saveToManagement,setting.prototype.close=function(){1==scope.firstCreate?exit():delete scope.setting},setting.prototype.save=function(){rootScope.dirty=!0;var e,t,o,a,i=JSONparse(scope.setting.data);if(i.theme=scope.setting.theme,scope.editData.setting=JSON.stringify(i,null,2),scope.firstCreate=!1,delete scope.setting,null==scope.editData.groups){var r=scope.editData.layout;replaceCiKpi.call(r,function(){timeout(function(){"EDIT"==scope.mode?renderDataFn():renderDataFn(!0)})})}else{for(var n in scope.editData.groups)e=n,t=scope.editData.groups[n],o=void 0,a=t.layout,o=e==scope.tabIndex?function(){timeout(function(){"EDIT"==scope.mode?renderDataFn():renderDataFn(!0)})}:function(){},replaceCiKpi.call(a,o)}},groupModels=[],Info.get(path,function(e){window.freeBoardValue=e.freeBoardValue;var t=0;if(window.template=e.templates.map(function(e){return e.id=t,t++,e}),initData.call(freeBoardValue),rootScope.settingDashboard=function(){null==scope.editData.setting&&(scope.editData.setting={padding:15}),scope.setting=new setting({theme:JSONparse(scope.editData.setting).theme||"default",data:scope.editData.setting})},rootScope.previewDashboard=function(){viewId?window.open("../app-free-style/index.html#/"+viewId,"_blank"):growl.warning("保存之后才可以预览！您可以进入预览模式预览！",{})},rootScope.helpFun=function(){window.open("../app-free-style/index.html#/help","_blank")},rootScope.viewmode,scope.titleComposory=!0,solutionId&&serviceViewId)scope.titleComposory=!1,solutionUIService.getManageViewContent(solutionId,function(e){e.code});else{var a=["dashboard","designView","configure"],i=["dashboardViews","designView","configure"],r=function(){"freeboard"==rootScope.viewmode||"template"==rootScope.viewmode?allGraphViews=scope.dashboardViews:"editor"!=rootScope.viewmode&&"specialist"!=rootScope.viewmode||(allGraphViews=scope.designView),allViews=allGraphViews.filter(function(e){return e.viewId!=viewId}),window.specialistView=[],kqiManagerUIService.getKqiModels(function(e){0==e.code&&(window.specialistView=e.data.filter(function(o){return allGraphViews.some(function(e){var t=!1;return e.template&&"kqiModel"==e.template.resourceType&&(t=e.template.resourceId==o.id),t})}).map(function(o){var e=allGraphViews.find(function(e){var t=!1;return e.template&&"kqiModel"==e.template.resourceType&&(t=e.template.resourceId==o.id),t});return o.url=JSON.parse(o.viewContent).thumb,o.viewId=e.viewId,o}))});var o,t=function(){scope.globalModel={open:!1,click:function(){var t=this;this.open=!this.open;var e=function(e){scope.$apply(function(){t.open=!1})};$("body").on("click.whole",e)},subclick:function(e){this.open=!this.open,this.model=e}},init(function(){solutionId&&serviceViewId?(scope.titleComposory=!1,solutionUIService.getManageViewContent(solutionId,getDashboardSolution)):"template"==scope.viewmode?(n(),currentView&&(scope.viewId=currentView.viewId)):"specialist"==scope.viewmode?(n(),currentView&&(scope.viewId=currentView.viewId)):viewId?(scope.viewId=viewId,n()):function(){scope.viewTitle="",scope.titleChange();var e=scope.configure.map(function(e){return{label:e.viewTitle,type:"topo",render:"text",viewId:e.viewId,$CLASS:"item"}}),t=scope.dashboardViews.map(function(e){return{label:e.viewTitle,type:"dashboard",render:"text",viewId:e.viewId,$CLASS:"item"}}),o=scope.designView.map(function(e){return{label:e.viewTitle,type:"designView",render:"text",viewId:e.viewId,$CLASS:"item"}});dashboardTemplate.map(function(e){var t=JSON.parse(e.value),o="template_"+e.id;return t.type=o,t.label=e.label,t.$CLASS="item",t.render="text",t});scope.toolbarListMap[2].sub[0].sub=t,scope.toolbarListMap[2].sub[1].sub=e,scope.toolbarListMap[2].sub[2].sub=o,scope.toolbarListMap=renderToolbar(scope.toolbarListMap)}()})},a=function(e){e?viewFlexService.getViewById(e.viewId,function(e){0==e.code&&(currentView=e.data,t())}):t()};configUIService.getConfigsByGroupName("Dashboard_template",function(e){e.code&&(dashboardTemplate=e.data,"template"==scope.viewmode?viewFlexService.getDefaultView(modelId,function(e){if(0==e.code){var t=e.data;o=t.find(function(e){return!!e.template&&("default"==e.template.keyValue&&("model"==scope.templateType?e.template.resourceId==modelId:"project"==scope.templateType?e.template.resourceId==projectId:"device"==scope.templateType&&e.template.resourceId==resourceId))}),a(o)}}):(o="specialist"==scope.viewmode?allGraphViews.find(function(e){var t=!1;return e.template&&"kqiModel"==e.template.resourceType&&(t=e.template.resourceId==kqiModelId),t}):allGraphViews.find(function(e){return e.viewId==viewId}),a(o)))})};!function t(o){if(o<a.length){var e=a[o];viewFlexService.getManagedViewsByTypeAndRole(e,function(e){0==e.code&&(scope[i[o]]=e.data),t(o+1)})}else r()}(0)}function n(){var e=scope.configure.map(function(e){return{label:e.viewTitle,type:"topo",render:"text",viewId:e.viewId,$CLASS:"item"}}),t=scope.dashboardViews.map(function(e){return{label:e.viewTitle,type:"dashboard",render:"text",viewId:e.viewId,$CLASS:"item"}}),o=scope.designView.map(function(e){return{label:e.viewTitle,type:"designView",render:"text",viewId:e.viewId,$CLASS:"item"}}),a=dashboardTemplate.map(function(e){var t=JSON.parse(e.value),o="template_"+e.id;return t.type=o,t.label=e.label,t.$CLASS="item",t.render="edit",t});Array.prototype.push.apply(scope.toolbarListMap[1].sub,a),scope.toolbarListMap[2].sub[0].sub=t,scope.toolbarListMap[2].sub[0].sub=t,scope.toolbarListMap[2].sub[1].sub=e,scope.toolbarListMap[2].sub[2].sub=o,scope.toolbarListMap=renderToolbar(scope.toolbarListMap),currentView?(scope.viewTitle=currentView.viewTitle,rootScope.editorSubTitle="["+scope.viewTitle+"]",scope.description=currentView.description,scope.titleChange(),getDashboard()):rootScope.editorSubTitle="[新建视图]"}}),folder.prototype.click=function(){var e=this.fold;for(var t in this.parent)this.parent[t].fold=!0;this.fold=!e},folder.prototype.fold=!0,item.prototype.click=function(){var e=this.show;if("text"!=this.render||this.message){for(var t in this.parent)this.parent[t].show=!1;this.show=!e}},item.prototype.show=!1,scope.removeConfigClick=function(e){var t=e.type.split("template_")[1],o=scope.toolbarListMap[1].sub.indexOf(e);scope.toolbarListMap[1].sub.splice(o,1),configUIService.deleteConfig(t,function(e){e.code})},Array.prototype.remove=function(e){var t=!1;for(var o in this)this[o]==e&&(t=!0),t&&(o<this.length-1?this[o]=this[parseInt(o)+1]:delete this[o]);t&&this.length--},Object.defineProperty(Array.prototype,"remove",{enumerable:!1}),modelSelector.prototype.change=function(){var t=this.id,o=q.defer(),a=q.defer(),i=q.defer();return scope.unitFilter="",scope.unitFilterDisabled=!1,serviceCenterService.kpis.getBymodelId(t).then(function(e){scope.kpis=e.map(function(e){return"string"==typeof e.unit&&""!=e.unit||(e.unit="无"),e.$clone()}),scope.kpiUnits=scope.kpis.reduce(function(e,t){return e.some(function(e){return e.value==t.unit})||e.push({label:t.unit,value:t.unit}),e},[{label:"all",value:""}]),a.resolve("success")},function(e){"data back is empty!!!"==e&&growl.warning("您通过模型ID[",t,"]并为获取任何kpi信息！")}),serviceCenterService.resources.getBymodelId(t).then(function(e){scope.resources=e.map(function(e){return e.$clone()}),i.resolve("success")},function(e){"data back is empty!!!"==e&&growl.warning("您通过模型ID[",t,"]并为获取任何设备信息！")}),q.all([a.promise,i.promise]).then(function(e){o.resolve("success")}),o.promise},scope.unitFilter="",scope.unitFilterDisabled=!1,scope.onTabClick=onTabClick,rootScope.clearDashboard=function(){rootScope.dirty=!0,scope.$broadcast("viewChanged"),delete scope.tabIndex,scope.editData={layout:{id:$randomString(32),type:"column",children:[],col:12},setting:{showNavi:!1,style:{padding:"5px"}}},timeout(function(){renderDataFn()})},rootScope.resetDashboard=function(){rootScope.dirty=!0,scope.$broadcast("viewChanged"),scope.editData=loadedView.$clone();var e=curLayout().layout;reconstruct(e),timeout(function(){"PREV"==status?renderDataFn(!0):renderDataFn()})},rootScope.panelCancel=panelCancel,scope.switchToData=function(){var e=scope.editPanel;scope.editPanel=void 0,timeout(function(){dataPanelShow(e)},400),rootScope.panelClose=function(){rootScope.dirty=!0,scope.$broadcast("viewChanged");var e=scope.dataPanel;delete scope.dataPanel,scope.selectData.$extension(e),renderDataFn(),timeout(function(){var o=[{label:"不使用链接",value:"none"}],a=[];scope.editPanel=scope.selectData.$clone();var e=scope.resources.filter(function(e){return 1==e.checked});if(scope.editPanel.data.resource=e,scope.editPanel.data.resource&&scope.editPanel.data.kpi){for(var t in scope.editPanel.attributes)scope.editPanel.attributes[t].data&&"none"==scope.editPanel.attributes[t].data.value&&(scope.editPanel.attributes[t].data.value=scope.editPanel.attributes[t].data.option[1].value);scope.editPanel.valueGroup&&(scope.editPanel.valueGroup.data.value="value")}else{for(var t in scope.editPanel.attributes)scope.editPanel.attributes[t].data&&"none"!=scope.editPanel.attributes[t].data.value&&(scope.editPanel.attributes[t].data.value="none");scope.editPanel.valueGroup&&(scope.editPanel.valueGroup.data.value="custom")}rootScope.panelClose=function(){scope.selectData.$extension(scope.editPanel),curLayout().layout.traveseByChild(function(e){if(1==e.$attr("attributes/anchor/applied")){var t=e.$attr("attributes/anchor/value");"string"==typeof t&&""!=t&&(o.push({label:e.$attr("attributes/anchor/value"),value:e.$attr("attributes/anchor/value")}),a[e.$attr("attributes/anchor/value")]=e.data)}}),curLayout().layout.traveseByChild(function(e){var t=e.$attr("attributes/linkData/value");if("none"!=t&&null!=t){if(e.data=a[t],e.$attr("data/resource")&&e.$attr("data/kpi")){for(var o in e.attributes)e.attributes[o].data&&"none"==e.attributes[o].data.value&&(e.attributes[o].data.value=e.attributes[o].data.option[1].value);e.valueGroup&&(e.valueGroup.data.value="value")}else{for(var o in e.attributes)e.attributes[o].data&&"none"!=e.attributes[o].data.value&&(e.attributes[o].data.value="none");e.valueGroup&&(e.valueGroup.data.value="custom")}e.data=a[t]}}),scope.anchors=o,renderDataFn(),scope.unitFilter="",scope.unitFilterDisabled=!1,scope.dataPanel=void 0,scope.editPanel=void 0,scope.resources=void 0,scope.kpis=void 0}},400)}},scope.switchToEdit=function(){var e=scope.dataPanel;scope.dataPanel=void 0,timeout(function(){scope.editPanel=e},400)},scope.groupAdd=function(e){var t=e[0].$clone(),o=[];for(var a in t.attributes.value.value.split(","))o.push(parseInt(100*Math.random()));for(var a in t.attributes.value.value=o.toString(),e.push(t),e)delete e[a].$$hashKey,e[a].id=a},scope.groupRemove=function(o,e){if(1<e.length)for(var t in e.$remove(function(e,t){return o.id==t.id}),e)e[t].id=t},scope.dataTypeChange=function(t,e){if("none"!=t.value&&(null==e.data.resource||null==e.data.kpi)){var o=scope.editPanel;scope.editPanel=void 0,timeout(function(){dataPanelShow(o)},400),rootScope.panelClose=function(){if(scope.dataPanel.data.resource&&scope.dataPanel.data.kpi){var e=scope.dataPanel;scope.selectData.$clone(e),scope.dataPanel=void 0,renderDataFn(),timeout(function(){rootScope.panelClose=function(){scope.editPanel.$clone(scope.selectData),scope.unitFilter="",scope.unitFilterDisabled=!1,scope.dataPanel=void 0,scope.editPanel=void 0,scope.resources=void 0,scope.kpis=void 0}},400)}else t.value="none";scope.unitFilter="",scope.unitFilterDisabled=!1,scope.dataPanel=void 0,scope.editPanel=void 0,scope.resources=void 0,scope.kpis=void 0}}},rootScope.exitDashboard=function(){if(rootScope.dirty){var e=[{label:"不保存",icon:"btn btn-default pull-left",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){exit()}},{label:"取消",icon:"btn btn-cancel",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){scope.dialogBox=void 0}},{label:"保存",icon:"btn btn-success",disabled:1!=scope.inputCheck.correct,style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){rootScope.saveDashboard(exit)}}];scope.dialogBox={title:{label:"退出编辑器"},description:{label:"尚有未保存的修改，是否保存？"},fnlist:e}}else exit()},scope.titleChange=function(){function a(){var e=allViews.filter(function(e){return currentView?e.viewTitle==scope.viewTitle&&e.viewTitle!=currentView.viewTitle:e.viewTitle==scope.viewTitle}),t=$$.switchToNumber(scope.viewTitle.length);return scope.titleComposory?0==t?{correct:!1,icon:"glyphicon-warning-sign",msg:"不可为空",style:{color:"red"}}:32<t?{correct:!1,icon:"glyphicon-remove",msg:"不可超过32字符",style:{color:"red"}}:0<e.length?{correct:!1,icon:"glyphicon-remove",msg:"错误 : 该视图名已被占用",style:{color:"red"}}:{correct:!0,icon:"glyphicon-ok",msg:"正确",style:{color:"green"}}:{correct:!0,icon:"glyphicon-ok",msg:"正确",style:{color:"green"}}}allViews?rootScope.inputCheck=a():viewFlexService.getAllMyViews(function(e){if("0"==e.code){if("freeboard"==rootScope.viewmode)for(var t in allViews=e.data.filter(function(e){return"dashboard"==e.viewType&&e.viewId!=viewId})){var o=JSON.parse(allViews[t].content);allViews[t].JSON=o}else for(var t in allViews=e.data.filter(function(e){return"designView"==e.viewType&&e.viewId!=viewId})){o=JSON.parse(allViews[t].content);allViews[t].JSON=o}rootScope.inputCheck=a()}})},rootScope.saveAsServiceView=function(t){if(rootScope.dirty=!1,!scope.titleComposory||"string"==typeof scope.viewTitle&&""!=scope.viewTitle){if(null==scope.tabIndex){var e=scope.editData.$clone();refineDataStructure.call(e.layout);var o={version:"V_2",layout:e.layout,setting:e.setting}}else{e=scope.editData.$clone();for(var a in e.groups){refineDataStructure.call(e.groups[a].layout);o={version:"V_2",groups:e.groups,setting:e.setting}}}var i={viewTitle:30<scope.viewTitle.length?scope.viewTitle.slice(0,30):scope.viewTitle,content:JSON.stringify(o)};i.$extension({viewName:"serviceView",viewType:"serviceView"}),viewFlexService.addView(i,function(e){0==e.code&&(growl.success("服务视图另存成功",{}),location.path(rootScope.viewmode+"/"+scope.viewtype+"/"+flag+"/"+e.data.viewId),scope.viewId=e.data.viewId,t&&t())})}else growl.error("视图名不能为空！",{})},rootScope.saveDashboard=function(t){if(rootScope.dirty=!1,!scope.titleComposory||"string"==typeof scope.viewTitle&&""!=scope.viewTitle){if(null==scope.tabIndex){var e=scope.editData.$clone();loadedView=scope.editData.$clone(),refineDataStructure.call(e.layout);var o={version:"V_2",layout:e.layout,setting:e.setting}}else{e=scope.editData.$clone();for(var a in e.groups){refineDataStructure.call(e.groups[a].layout);o={version:"V_2",groups:e.groups,setting:e.setting}}}if(solutionId&&serviceViewId)"freeboard"==scope.viewmode?solutionUIService.saveManageViewContent(solutionId,JSON.stringify(o),function(e){0==e.code?("freeboard"==scope.viewmode?growl.success("解决方案仪表板视图修改成功",{}):growl.success("解决方案分析视图修改成功",{}),t&&t()):"freeboard"==scope.viewmode?growl.success("解决方案仪表板视图修改失败",{}):growl.success("解决方案分析视图修改失败",{})}):solutionUIService.saveModelDashboardViewContent(solutionId,groupId,modelId,JSON.stringify(o),function(e){0==e.code?("freeboard"==scope.viewmode?growl.success("解决方案仪表板视图修改成功",{}):growl.success("解决方案分析视图修改成功",{}),t&&t()):"freeboard"==scope.viewmode?growl.success("解决方案仪表板视图修改失败",{}):growl.success("解决方案分析视图修改失败",{})});else{loadedView=o;var i={viewTitle:32<scope.viewTitle.length?scope.viewTitle.slice(0,32):scope.viewTitle,description:scope.description,content:JSON.stringify(o)};"freeboard"==scope.viewmode?(i.$extension({viewName:"dashboard",viewType:"dashboard"}),i.template=null,scope.globalModel.enable&&scope.globalModel.model&&(i.template={resourceId:scope.globalModel.model.id,resourceType:"device"})):"editor"==scope.viewmode?i.$extension({viewName:"designView",viewType:"designView"}):"service"==scope.viewmode?i.$extension({viewName:"serviceView",viewType:"serviceView"}):"template"==scope.viewmode?(i.$extension({viewName:"dashboard",viewType:"dashboard"}),scope.globalModel.enable&&scope.globalModel.model&&(i.template={resourceId:scope.globalModel.model.id,resourceType:"device",keyValue:"default"})):"specialist"==scope.viewmode&&(i.$extension({viewName:"designView",viewType:"designView"}),i.template={resourceId:kqiModelId,resourceType:"kqiModel"}),scope.viewId?(i.viewId=scope.viewId,viewFlexService.updateView(i,function(e){0==e.code&&(1==saveToManagement?(o.viewId=scope.viewId,saveManagement(o,t)):("freeboard"==scope.viewmode?growl.success("仪表板视图修改成功",{}):"editor"==scope.viewmode?growl.success("分析视图修改成功",{}):"service"==scope.viewmode?growl.success("服务视图修改成功",{}):"template"==scope.viewmode?growl.success("仪表板视图修改成功",{}):"specialist"==scope.viewmode&&growl.success("专家模版视图修改成功",{}),t&&t()))})):viewFlexService.addView(i,function(e){0==e.code&&("freeboard"==scope.viewmode?growl.success("仪表板视图创建成功",{}):"editor"==scope.viewmode?growl.success("分析视图创建成功",{}):"service"==scope.viewmode?growl.success("服务视图创建成功",{}):"template"==scope.viewmode?growl.success("仪表板视图创建成功",{}):"specialist"==scope.viewmode&&growl.success("专家模版视图创建成功",{}),"template"==rootScope.viewmode?viewFlexService.releaseViews([e.data.viewId],function(e){0==e.code&&location.path(rootScope.viewmode+"/model/"+flag+"/"+encodeURIComponent(JSON.stringify({modelId:modelId})))}):"specialist"==rootScope.viewmode?viewFlexService.releaseViews([e.data.viewId],function(e){0==e.code&&location.path(rootScope.viewmode+"/"+flag+"/"+kqiModelId)}):location.path(rootScope.viewmode+"/"+scope.viewtype+"/"+flag+"/"+e.data.viewId),scope.viewId=e.data.viewId,t&&t())})}}else growl.error("视图名不能为空！",{})},rootScope.ModelKpiSelector=function(){window.open("../app-free-style/index.html#/kpiselector","_blank")},keySet.onCommandKeyWith("s",function(){rootScope.saveDashboard()}),keySet.onCommandKeyWith("z",function(){rootScope.backward()}),keySet.onCommandKeyWith("y",function(){rootScope.forward()}),keySet.onCommandKeyWith("p",function(){rootScope.previewDashboard()}),keySet.onCommandKeyWith("h",function(){rootScope.helpFun()}),keySet.onCommandKeyWith("u",function(){scope.openTemplate()}),keySet.onCommandKeyWith("i",function(){scope.inputJSON()}),keySet.onCommandKeyWith("k",function(){scope.ModelKpiSelector()}),scope.themes=[{id:"none",label:"默认主题"},{id:"default",label:"系统主题"},{id:"Cyborg",label:"黑色主题"},{id:"Slate",label:"深蓝主题"},{id:"Solar",label:"海洋主题"},{id:"Darkly",label:"Darkly"},{id:"steel",label:"钢铁行业"}],scope.kpiChange=function(e){if(1==scope.dataPanel.data.maxKpi)for(var t in scope.kpis)scope.kpis[t].id!=e.id?scope.kpis[t].checked=!1:scope.kpis[t].checked=!scope.kpis[t].checked;else e.checked=!e.checked;var o=scope.kpis.filter(function(e){return 1==e.checked});0<o.length?(scope.unitFilter=o[0].unit,scope.unitFilterDisabled=!0,scope.dataPanel.data.kpi=o):(scope.unitFilter="",scope.unitFilterDisabled=!1,scope.dataPanel.data.kpi=void 0)},scope.resourceChange=function(e){var t=scope.resources.filter(function(e){return 1==!e.checked});0<t.length?scope.dataPanel.data.resource=t:delete scope.dataPanel.data.resource,e.checked=!e.checked},scope.mode="EDIT",scope.tabClick=function(e){if(e)"EDIT"==(scope.mode=e)?($(".free-board-left").removeClass("free-board-fold"),$(".free-board-right").removeClass("free-board-full"),timeout(function(){var e=$(".previewarea");e.removeClass("previewarea"),e.addClass("drawarea"),renderDataFn(),status="EDIT"},300)):"PREV"==e&&($(".free-board-left").addClass("free-board-fold"),$(".free-board-right").addClass("free-board-full"),timeout(function(){var e=$(".drawarea");e.addClass("previewarea"),e.removeClass("drawarea"),renderDataFn(!0),status="PREV"},300));else{var t=scope.editData.$clone();if(t.groups)for(var o in t.groups)refineDataStructure.call(t.groups[o].layout);else refineDataStructure.call(t.layout);commonMethodService().createSystemPopupByJsonName("copyCode",{title:"页面代码",width:"80%"},{message:"页面代码请点击复制，拷贝代码到剪切板",code:t})}},scope.editData={layout:{id:$randomString(32),type:"column",children:[],col:12},setting:{showNavi:!1,style:{padding:"15px"}}},scope.cols=[{inx:0,value:12}],scope.drop={},scope.colstyles=[{label:"自定义",value:[]},{label:"100%",value:[12]},{label:"50% - 50%",value:[6,6]},{label:"66% - 33%",value:[8,4]},{label:"33% - 66%",value:[4,8]},{label:"33% - 33% - 33%",value:[4,4,4]},{label:"25% - 25% - 25% - 25%",value:[3,3,3,3]}],scope.gridSelector={},scope.colChange=function(e){scope.gridSelector.setValue(e)},scope.testFn=function(){scope.colstyle=scope.colstyles[0],scope.mm=2},scope.toolbarClick=function(e){scope.currentSelect==e.id?scope.currentSelect=void 0:scope.currentSelect=e.id},scope.showInstruction=function(e){var t;for(var o in t=e.show,null==e.show&&(e.show=!1),scope.toolbarListMap)for(var a in scope.toolbarListMap[o].sub)scope.toolbarListMap[o].sub[a].show=!1;e.show=!t},scope.currentSelect=void 0,scope.colstyle=scope.colstyles[1],scope.onChange=function(e,t){scope.tools.grid.children=e.map(function(e){return{type:"column",children:[],col:e}}),t&&(scope.colstyle=scope.colstyles[0])},scope.onDelete=function(e){var o,a,i=$(e.target).attr("id");rootScope.dirty=!0,scope.$broadcast("viewChanged"),curLayout().layout.traveseByChild(function(e,t){e.id==i&&(o=e,a=t)});var t=a.find(function(e){return e==o});t&&a.remove(t),renderDataFn()},scope.onCut=function(e){var o,a,i=$(e.target).attr("id");rootScope.dirty=!0,scope.$broadcast("viewChanged"),curLayout().layout.traveseByChild(function(e,t){e.id==i&&(o=e,a=t)}),scope.clipBoard=o;var t=a.find(function(e){return e==o});t&&a.remove(t),renderDataFn()},scope.onCopy=function(e){var o,a=e.id;curLayout().layout.traveseByChild(function(e,t){e.id==a&&(o=e)}),o&&(scope.clipBoard=o.$clone().$extension({id:$randomString(32)}))},scope.onInsert=function(e){var o,a,i=e;scope.$apply(function(){rootScope.dirty=!0}),scope.$broadcast("viewChanged"),curLayout().layout.traveseByChild(function(e,t){e.id==i&&(o=e,a=t)});var t=0;for(var r in a)if(a[r].id==o.id){t=r;break}if(scope.clipBoard){var n=scope.clipBoard.$clone();n.id=$randomString(32),n.traveseByChild(function(e){e.id&&(e.id=$randomString(32))}),-1!=t&&a.insertBefore(t,n),renderDataFn()}};var body=$(["body"]);function curLayout(){return null==scope.editData.groups?scope.editData:(null==scope.tabIndex&&(scope.tabIndex=0),{layout:scope.editData.groups[scope.tabIndex].layout,setting:scope.editData.setting})}scope.importGraphToFunc=function(){commonMethodService().createSystemPopupByJsonName("importCodeTemplate",{title:"导入JSON",width:"80%",on:{submit:function(a){var e,i,t,r,o=a.code;e=JSON.parse(o),i=e.$clone(),t={label:a.title,groupName:"Dashboard_template",value:JSON.stringify(i)},r=scope.toolbarListMap.find(function(e){return"功能模块"==e.label}),configUIService.saveConfig(t,function(e){if(0==e.code){var t=e.data.id,o=new item;Object.defineProperty(o,"parent",{enumerable:!1,value:r.sub}),o.label=a.title,o.type="template _"+t,o.$CLASS="item",o.render="edit",r.sub.push(o),scope.tools["template _"+t]=i}})}}},{message:"页面代码请点击复制，拷贝代码到剪切板"})},scope.onInsertJSON=function(e){var i,r,n=e;scope.$apply(function(){rootScope.dirty=!0,scope.$broadcast("viewChanged"),commonMethodService().createSystemPopupByJsonName("importCode",{title:"导入JSON",width:"80%",on:{submit:function(e,t){t&&t(),function(e){curLayout().layout.traveseByChild(function(e,t){e.id==n&&(i=e,r=t)});var t=0;for(var o in r)if(r[o].id==i.id){t=o;break}if(e){var a=remapData(e);a.id=$randomString(32),a.traveseByChild(function(e){e.id&&(e.id=$randomString(32))}),-1!=t&&r.insertBefore(t,a),renderDataFn()}}(JSON.parse(e))}}},{message:"页面代码请点击复制，拷贝代码到剪切板"})})},scope.onPasteJSON=function(e){var o,a=e;scope.$apply(function(){rootScope.dirty=!0,scope.$broadcast("viewChanged"),commonMethodService().createSystemPopupByJsonName("importCode",{title:"导入JSON",width:"80%",on:{submit:function(e,t){t&&t(),function(e){if(curLayout().layout.traveseByChild(function(e,t){e.id==a&&(o=e)}),e){var t=remapData(e);t.id=$randomString(32),t.traveseByChild(function(e){e.id&&(e.id=$randomString(32))}),o.children.push(t),renderDataFn()}}(JSON.parse(e))}}},{message:"页面代码请点击复制，拷贝代码到剪切板"})})},scope.onPaste=function(e){var o,a=e;scope.$apply(function(){rootScope.dirty=!0,scope.$broadcast("viewChanged")}),curLayout().layout.traveseByChild(function(e,t){e.id==a&&(o=e)});var t=scope.clipBoard.$clone();t.traveseByChild(function(e){e.id&&(e.id=$randomString(32))}),t.id=$randomString(32),o.children.push(t),renderDataFn()},scope.onDataChange=function(e,t){var o,a=$(e.target).attr("id");for(var i in scope.resources)scope.resources[i].checked=!1;for(var i in scope.kpis)scope.kpis[i].checked=!1;curLayout().layout.traveseByChild(function(e,t){e.id==a&&(o=e,t)}),rootScope.panelClose=function(){rootScope.dirty=!0,scope.$broadcast("viewChanged");var e=scope.resources.filter(function(e){return 1==e.checked});if(scope.dataPanel.data.resource=e,scope.dataPanel.data.resource&&scope.dataPanel.data.kpi){for(var t in scope.dataPanel.attributes)scope.dataPanel.attributes[t].data&&"none"==scope.dataPanel.attributes[t].data.value&&(scope.dataPanel.attributes[t].data.value=scope.dataPanel.attributes[t].data.option[1].value);scope.dataPanel.valueGroup&&(scope.dataPanel.valueGroup.data.value="value")}else{for(var t in scope.dataPanel.attributes)scope.dataPanel.attributes[t].data&&"none"!=scope.dataPanel.attributes[t].data.value&&(scope.dataPanel.attributes[t].data.value="none");scope.dataPanel.valueGroup&&(scope.dataPanel.valueGroup.data.value="custom")}scope.selectData.$extension(scope.dataPanel),renderDataFn(),scope.unitFilter="",scope.unitFilterDisabled=!1,scope.dataPanel=void 0,scope.editPanel=void 0,scope.resources=void 0,scope.kpis=void 0},dataPanelShow(scope.selectData=o)},scope.selectTemp=function(e){scope.ctemp=e},scope.selectSpec=function(e){scope.cspec=e},scope.applySpecTemp=function(){if(scope.firstCreate&&(scope.setting=new setting({theme:JSONparse(scope.editData.setting).theme||"default",data:scope.editData.setting})),-1!=scope.cspec.id){rootScope.dirty=!0,scope.$broadcast("viewChanged");var e=scope.cspec.viewId;viewFlexService.getViewById(e,function(e){if("0"==e.code){var t=JSON.parse(e.data.content);scope.editData={layout:remapData(t.layout),setting:t.setting};var o=curLayout().layout;reconstruct(o)}})}scope.specialist=void 0,scope.cspec=void 0},scope.applyTemp=function(){if(scope.firstCreate&&(scope.setting=new setting({theme:JSONparse(scope.editData.setting).theme||"default",data:scope.editData.setting})),-1!=scope.ctemp.id){rootScope.dirty=!0,scope.$broadcast("viewChanged");var t=scope.ctemp.name,e="../../localdb/echartTemplate/"+scope.ctemp.json,o=function(e){if(null==e.groups)delete scope.tabIndex,scope.editData={layout:remapData(e.$clone().layout),setting:e.$clone().setting};else{for(var t in e.groups)e.groups[t].layout=remapData(e.groups[t].layout);scope.editData=e,scope.tabIndex=0}var o=curLayout().layout;reconstruct(o)};window[t]?o(window[t]):Info.get(e,function(e){window[t]=e,o(window[t])})}scope.template=void 0,scope.ctemp=void 0},scope.openTemplate=function(){scope.template=window.template},scope.openSpecialist=function(){scope.specialist=window.specialistView},scope.templateClose=function(){scope.firstCreate&&(scope.setting=new setting({theme:JSONparse(scope.editData.setting).theme||"default",data:scope.editData.setting})),scope.template=void 0,scope.ctemp=void 0},scope.specialistClose=function(){scope.firstCreate&&(scope.setting=new setting({theme:JSONparse(scope.editData.setting).theme||"default",data:scope.editData.setting})),scope.specialist=void 0,scope.cspec=void 0},scope.inputJSON=function(){commonMethodService().createSystemPopupByJsonName("importCode",{title:"导入JSON",width:"80%",on:{submit:function(e){!function(e){if(null==e.groups)delete scope.tabIndex,scope.editData={layout:remapData(e.$clone().layout),setting:e.$clone().setting};else{for(var t in e.groups)e.groups[t].layout=remapData(e.groups[t].layout);scope.editData=e,scope.tabIndex=0}var o=curLayout().layout;reconstruct(o),scope.template=void 0,scope.ctemp=void 0}(JSON.parse(e))}}},{message:"页面代码请点击复制，拷贝代码到剪切板"})},scope.jsonClose=function(){scope.JsonInput=!1,scope.JsonData=void 0},scope.anchors=[{label:"不使用链接",value:"none"}],scope.onSetting=function(e,t){var o,a=$(e.target).attr("id");curLayout().layout.traveseByChild(function(e,t){e.id==a&&(o=e,t)});var i=[];function r(e,t){var o=!1;for(var a in t)1==t[a].isDiff&&(o=!0,e[a]=t[a].data);return o}(function(){for(var e in arguments)arguments[e].content&&this.push(arguments[e])}).apply(i,[{$name:"template",label:"模板",content:o.template},{$name:"parameters",label:"基本属性",content:o.parameters},{$name:"source",label:"数据",content:o.data},{$name:"style",label:"css样式",content:o.style},{$name:"echart",label:"图表样式",defaulttype:function(e){switch(e){case"LINECHART":return"line";case"BARCHART":return"bar";case"GAUGECHART":return"gauge";case"PIECHART":return"pie";case"GAUGECHART":return"gauge";case"MAPCHARTDIST":case"SCATTERCHART":case"MAP":return"scatter";default:return"line"}}(o.source),content:o.echart},{$name:"advance",label:"高级设置",content:o.advance}]),popup.setContent(i,t.element,o.$index,o.label,o.help,o.type),popup.open(),popup.on("onPanelOpen",function(){}),keySet.onCommandKeyWith("s",function(){popup.submitPanel(function(e){e&&(o.$index=e.index,r(o,e)&&(rootScope.dirty=!0,scope.$broadcast("viewChanged"),timeout(function(){renderDataFn()})),rootScope.saveDashboard())})}),popup.on("onPanelSubmit",function(e){o.$index=e.index,r(o,e)&&(rootScope.dirty=!0,scope.$broadcast("viewChanged"),timeout(function(){renderDataFn()}),keySet.onCommandKeyWith("s",function(){rootScope.saveDashboard()}))})},scope.onDrop=function(event,ui,before){var JSONstring,targetId=$(event.target).attr("id"),dragId=ui.draggable.attr("id"),viewId=ui.draggable.attr("viewId");if(rootScope.$apply(function(){rootScope.dirty=!0,scope.$broadcast("viewChanged")}),viewId&&("add_topo"==dragId?JSONstring=scope.configure.find(function(e){return e.viewId==viewId}):"add_dashboard"==dragId?JSONstring=scope.dashboardViews.find(function(e){return e.viewId==viewId}):"add_designView"==dragId&&(JSONstring=scope.designView.find(function(e){return e.viewId==viewId}))),targetId!=dragId)if(-1==dragId.indexOf("add_")){var getElem,getParent,clone={};curLayout().layout.traveseByChild(function(e,t){e.id==dragId&&(getElem=e,getParent=t)}),clone=getElem.$clone();var find=getParent.find(function(e){return e==getElem}),find,targetParent;if(find&&getParent.remove(find),curLayout().layout.traveseByChild(function(e,t){e.id==targetId&&(find=e,targetParent=t)}),before){var inx=targetParent.indexOf(find);-1!=inx&&targetParent.insertBefore(inx,clone)}else find.children.push(clone);renderDataFn()}else{var find,pare,children,row;dragId=dragId.split("add_")[1],dragId=dragId.toLowerCase();var children=[];if("dashboard"==dragId||"designview"==dragId)row={};else if(scope.tools.$clone()[dragId])row=remapData(scope.tools.$clone()[dragId]);else{if(!scope.tools.$clone()[dragId+"chart"])throw new Error("找不到视图!");row=remapData(scope.tools.$clone()[dragId+"chart"])}kqiModelId&&(row.parameters.title="专家曲线",row.parameters.subtitle="专家曲线",row.data.kqiModel={id:kqiModelId});var run=function run(){if(replaceCiKpi.call(row),curLayout().layout.traveseByChild(function(e,t){e.id==targetId&&(find=e,pare=t)}),before){var inx=pare.indexOf(find);pare.insertBefore(inx,row)}else find.children.push(row);row.traveseByChild(function(element){element.id=$randomString(32),element.traverse(function(attr,el){el.onChange&&(el.onChange=eval(el.onChange))})}),curLayout().traverse(function(e,t){var o={};t.data&&t.data.bindTo&&(o[t.data.bindTo]?t.data=o[t.data.bindTo]:o[t.data.bindTo]=t.data)}),renderDataFn()};JSONstring?(row.viewId=parseInt(viewId),viewFlexService.getViewById(viewId,function(e){if(JSON.parse(e.data.content))if("dashboard"==dragId||"designview"==dragId){var t=JSON.parse(e.data.content);if(t.hasOwnProperty("groups"))for(var o in row={id:$randomString(),type:"tab",children:[]},t.groups)row.children.push({id:$randomString(),tabName:t.groups[o].label,tabId:o,type:"tabItem",children:t.groups[o].layout.children});else t.hasOwnProperty("data")?(t.data=t.data.$remapByChild(function(e){e.source;var t=commonMethodService(e);return t.setRootTarget(scope.editData),t}),row={id:$randomString(),type:"row",children:[t.data]}):t.hasOwnProperty("layout")&&(t.layout=t.layout.$remapByChild(function(e){e.source;var t=commonMethodService(e);return t.setRootTarget(scope.editData),t}),row={id:$randomString(),type:"row",children:[t.layout]})}else row.JSON=JSON.parse(e.data.content);else row.JSON={};run()})):run()}},scope.addEditDataGroup=function(){if(rootScope.dirty=!0,scope.$broadcast("viewChanged"),null==scope.editData.groups){var e=scope.editData.$clone();scope.editData={groups:[{id:0,label:"导航页",path:"page0",layout:e.layout}],setting:e.setting},scope.tabIndex=0}else{for(var t in scope.editData.groups.push({label:"导航页",path:"page"+scope.editData.groups.length,layout:{id:$randomString(32),type:"column",children:[],col:12}}),scope.editData.groups)scope.editData.groups[t].id=t;scope.tabIndex=scope.editData.groups.length-1}"EDIT"==scope.mode?renderDataFn():renderDataFn(!0)},scope.removeEditDataGroup=function(t){rootScope.dirty=!0,scope.$broadcast("viewChanged"),scope.editData.groups=scope.editData.groups.filter(function(e){return t.id!=e.id}),1==scope.editData.groups.length?(scope.editData={layout:scope.editData.groups[0].layout,setting:scope.editData.setting},scope.tabIndex=void 0):scope.tabIndex=0,"EDIT"==scope.mode?renderDataFn():renderDataFn(!0)},scope.renameEditDataGroup=function(t){var e=scope.editData.groups.find(function(e){return e.id==t.id}),o=[{label:"确定",icon:"btn btn-success",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){rootScope.dirty=!0,scope.$broadcast("viewChanged"),e.label=scope.dialogBox.input[0].value,e.path=scope.dialogBox.input[1].value,scope.dialogBox=void 0}},{label:"取消",icon:"btn btn-default",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){scope.dialogBox=void 0}}];scope.dialogBox={title:{label:"设置导航信息"},input:[{value:e.label,label:"导航页名称",placeholder:"修改导航名称"},{value:e.path,label:"导航路径",placeholder:"修改导航路径"}],fnlist:o}},scope.selectEditDataGroup=function(e){scope.tabIndex=e,"EDIT"==scope.mode?renderDataFn():renderDataFn(!0)}}])});
//# sourceMappingURL=../../map/js/controllers/free-board-ctrl.js.map
