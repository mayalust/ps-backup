define(["controllers/controllers","bootstrap-dialog"],function(e,L){"use strict";e.initController("ViewCtrl",["$scope","$location","$routeParams","$timeout","viewFlexService","kpiDataService","resourceUIService","growl","userLoginUIService","userDomainService","$document","userEnterpriseService",function(u,i,s,d,o,w,a,n,r,c,l,e){var m=[];u.editVisible=!1,u.alertAry=[],u.domainListDic={},u.domainListTree=null,u.selectedAlertitem={},u.selectedDesignitem=null,u.cilistByModelId=[],u.routePathNodes={},u.ifSolutionStatus=!0,u.editState=!1,u.selectedCis=[],u.alertViewList=[],u.selectedDitem={},u.selLength=10,u.selectAlertList={selList:[],search:!1,searchStatus:!1};var v=s.alertId,t=s.type;s.status&&(m=s.status.split(","));var f=function(){u.selectedDitem.label=[],null==u.selectedAlertitem&&(u.selectedAlertitem={}),u.selectedAlertitem.domain="",u.selectedAlertitem.nodeType="",u.selectedAlertitem.nodeIds="",u.selectedAlertitem.alertCodes="",u.selectedAlertitem.createTimeFrom="",u.selectedAlertitem.createTimeTo="",u.selectedAlertitem.pageSize="",u.selectedAlertitem.messageFilter="",u.selectedAlertitem.timeType="1",u.selectedAlertitem.states=["0","5","10","20"],u.selectedAlertitem.severities=["1","2","3","4"],(0<m.length||0<v)&&u.searchAlert(),u.shyj=""};u.goBack=function(){1==u.selectAlertList.search?(u.selectAlertList.search=!1,u.$broadcast(Event.ALERTINFOSINIT+"_view",{option:[]})):(u.selectAlertList.search=!0,f())},u.searchAlert=function(){var e={};e={domain:u.selectedAlertitem.domain,nodeType:u.selectedAlertitem.nodeType,alertCodes:u.selectedAlertitem.alertCodes,pageSize:u.selectedAlertitem.pageSize||1e3,messageFilter:u.selectedAlertitem.messageFilter,severities:u.selectedAlertitem.severities?u.selectedAlertitem.severities.join(","):"",states:u.selectedAlertitem.states?u.selectedAlertitem.states.join(","):""},"1"==u.selectedAlertitem.timeType?(e.firstTimeFrom=u.selectedAlertitem.createTimeFrom,e.firstTimeTo=u.selectedAlertitem.createTimeTo):"2"==u.selectedAlertitem.timeType?(e.lastTimeFrom=u.selectedAlertitem.createTimeFrom,e.lastTimeTo=u.selectedAlertitem.createTimeTo):"3"==u.selectedAlertitem.timeType&&(e.closeTimeFrom=u.selectedAlertitem.createTimeFrom,e.closeTimeTo=u.selectedAlertitem.createTimeTo),0<v&&"node"==t?(e.nodeIds=parseInt(v),a.getDevicesByCondition({},function(e){0==e.code&&(u.selectedDitem.label=e.data,v=0)})):e.nodeIds=u.selectedAlertitem.nodeIds,d(function(){0<v&&"alert"==t?(e.alertId=v,v=0):0<v&&"node"==t&&(e.nodeIds=parseInt(v),u.selectedAlertitem.nodeIds=parseInt(v)),u.$broadcast("searchAlertView",{option:e})})},u.faultList=[],u.alertDefinition=function(e,t,i){a.getAlertDefinitionByAlertCode(e,t,function(e){if(0==e.code){var t=e.data;return u.faultList=[],e.data&&"FAULT"==t.alertType&&u.faultList.push(e.data),void(i&&i())}})};var A="";u.clearSearchAlert=function(){0==s.nodeId?(f(),u.selectedDitem.label=[]):(u.selectedDitem.label=[],u.selectedAlertitem.domain="",u.selectedAlertitem.nodeType="",u.selectedAlertitem.nodeIds="",u.selectedAlertitem.alertCodes="",u.selectedAlertitem.createTimeFrom="",u.selectedAlertitem.createTimeTo="",u.selectedAlertitem.pageSize="",u.selectedAlertitem.messageFilter="",u.selectedAlertitem.timeType="1",u.selectedAlertitem.states=["0","5","10","20"],u.selectedAlertitem.severities=["1","2","3","4"])};var p=function(){var e,t;s.nodeId&&(e=s.nodeId,t=function(){u.selectedAlertitem.nodeType=u.selectedResource.modelId,u.selectedAlertitem.domain=u.selectedResource.domainPath,u.getAlertTypeByDeviceType(A),u.searchAlert()},a.getResourceById(e,function(e){0==e.code&&e.data&&(u.selectedResource=e.data,A=e.data.modelId,u.selectedAlertitem.nodeIds=e.data.id,t&&t())}))},h=function(){var i=function(e){u.domainListDic=e.domainListDic,u.domainListTree=e.domainListTree,s.nodeId&&p()};if(u.menuitems.isloaded)u.baseConfig.extendDomain?a.getExtendDomainsByFilter({},i):c.queryDomainTree(r.user.userID,i);else var l=u.$watch("menuitems",function(e,t){u.menuitems.isloaded&&(u.baseConfig.extendDomain?a.getExtendDomainsByFilter({},i):c.queryDomainTree(r.user.userID,i),l())},!0)},g=function(){o.getManagedViewsByTypeAndRole("configAlert",function(e){if(0==e.code){for(var t=e.data,i=0;i<t.length;i++){var l=t[i];if(l)var s={title:l.viewTitle.split("?")[0],url:"#/"+l.viewType+"/"+l.viewId,viewId:l.viewId,view:l,icon:"fa fa-warning"};"全部告警"==s.title?u.alertViewList.splice(0,0,s):u.alertViewList.push(s)}b()}})};u.renderChartDom=function(e){if(e){var t=l.find(".item_tr").width()*e.width/100*e.widthheightPortion;return{position:"relative",float:"left",width:e.width+"%",height:t}}};var I=["1","2","3","4"],y=["0","5","10","20"];u.alertViewClick=function(e){if(u.selectAlertList.search=!1,!(null==e||e.length<=0))if(u.editState)n.warning("当前有正在编辑的告警组",{});else{if(u.commitItem=e,u.viewId=e.viewId,"string"==typeof e.view.content){e.view.content=JSON.parse(e.view.content),e.view.content.domainPath||(e.view.content.domainPath=e.view.content.domain);var t=e.view.content.states.split(",");for(var i in y)for(var l in e["state"+y[i]]=!1,t)if(y[i]==t[l]){e["state"+y[i]]=!0,t.splice(l,1);break}for(var i in I)e["severity"+I[i]]=-1<e.view.content.severities.indexOf(I[i])}if(u.selectedAlertitem=e,u.cilistByModelId=[],u.selectedAlertitem.resources)u.cilistByModelId=u.selectedAlertitem.resources;else if(u.selectedAlertitem.view.resourceDesc){var s=JSON.parse(u.selectedAlertitem.view.resourceDesc);for(var i in s){var r=s[0].modelId;a.getResourceByModelId(r,function(e){0==e.code&&(e.data.forEach(function(e){e.text=e.label}),u.cilistByModelId=e.data,u.selectedAlertitem.resources=e.data)})}}else u.cilistByModelId=[];u.selectedAlertitem.alerts?u.selectedDitem.alerts=u.selectedAlertitem.alerts:u.selectedAlertitem.view.content&&void 0!==u.selectedAlertitem.view.content.nodeType&&u.getAlertTypeByDeviceType(u.selectedAlertitem.view.content.nodeType),0!=e.viewId&&d(function(){u.$broadcast("alertViewClick",{option:e})})}};u.addAlertView=function(){u.editState=!0;!function(){for(var e in u.alertViewList)if(""==u.alertViewList[e].view.viewId)return n.warning("当前有正在编辑的告警组，不能再添加告警组",{});var t,i,l;u.alertViewList.push((t={id:0,domainId:0,domainPath:"",domainName:"",description:"",count:0},i=Math.random(),t.icon="fa fa-warning",t.alertlv=.75<i?"bg-red":.5<i?"bg-orange":.25<i?"bg-yellow":"bg-green",t.isLoaded=0,t.type=1,t.name="",t.title="",t.label=t.name,t.view={viewId:"",viewName:"",viewTitle:"",viewType:"configAlert",protectLevel:"",content:{nodeType:"",domain:"",domainLabel:"",severities:"",states:"",pageSize:"1000",nodeIds:"",alertCodes:"",messageFilter:""},creator:"",updator:"",createTime:"",updateTime:"",description:"",domainPath:"",domainId:"",resourceDesc:"",statusType:"",originalViewId:"",modelPath:""},t.state0=!0,t.state5=!0,t.state10=!0,t.state20=!0,t.severity1=!0,t.severity2=!0,t.severity3=!0,t.severity4=!0,t)),u.selectedAlertitem=u.alertViewList[u.alertViewList.length-1],u.editVisible=!0,l=[$.ProudSmart.datatable.selectCol,{data:"title",title:"告警名称"},{data:"message",title:"告警消息"},{data:"severity",title:"告警级别"},{data:"state",title:"状态"},{data:"arisingTime",title:"最近告警时间"},$.ProudSmart.datatable.optionCol3],u.$broadcast(Event.ALERTINFOSINIT,{option:[[],l,[]]})}()},u.editAlertView=function(){u.editState=!u.editState,u.editVisible=!u.editVisible,u.editVisible},u.changeAlertCI=function(e){var t={viewId:null,nodeId:e.id};u.$broadcast("alertViewClick",{option:t})},u.delAlertView=function(){if(u.selectedAlertitem){if(u.editState)return void n.warning("当前有正在编辑的告警组",{});L.show({title:"提示",closable:!1,message:"确认要删除 “"+escape(u.selectedAlertitem.title)+"” 告警组",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){if(u.$apply(),""==u.selectedAlertitem.view.viewId){for(var t in u.selectedAlertitem=!1,u.editVisible=!1,e.close(),u.alertViewList)if(""==u.alertViewList[t].view.viewId){u.alertViewList.splice(t,1);break}}else o.deleteViews([u.selectedAlertitem.viewId],function(e){if(0==e.code){for(var t in u.alertViewList)if(u.alertViewList[t].view.viewId==u.selectedAlertitem.viewId){u.alertViewList.splice(t,1);break}return u.editVisible=!1,n.success("删除告警组成功",{}),void(0==u.alertViewList.length?u.selectedAlertitem=null:u.alertViewClick(u.alertViewList[u.alertViewList.length-1]))}}),e.close()}},{label:"取消",action:function(e){e.close()}}]})}},u.saveAlertView=function(){if(u.editState=!1,void 0!==u.selectedAlertitem.title&&void 0!==u.selectedAlertitem.view.content.pageSize)if(u.selectedAlertitem.title){var e="",t="";for(var i in I)1==u.selectedAlertitem["severity"+I[i]]&&(e+=I[i]+",");for(var i in 0!=e.length&&(e=e.substring(0,e.length-1)),y)1==u.selectedAlertitem["state"+y[i]]&&(t+=y[i]+",");0!=t.length&&(t=t.substring(0,t.length-1));var l=document.getElementById("selectedAlertType"),s=l.selectedIndex,r=(l.options[s].value,l.options[s].text,{});r.viewId=u.selectedAlertitem.view.viewId?u.selectedAlertitem.viewId:"",r.viewName=u.selectedAlertitem.title,r.viewTitle=r.viewName,r.viewType="configAlert",r.protectLevel=u.selectedAlertitem.view.protectLevel?u.selectedAlertitem.view.protectLevel:"",r.content={nodeType:u.selectedAlertitem.view.content.nodeType,domain:u.selectedAlertitem.view.content.domain,severities:u.selectedAlertitem.severities?u.selectedAlertitem.severities.join(","):"",states:u.selectedAlertitem.states?u.selectedAlertitem.states.join(","):"",pageSize:$("#alertCount").val(),alertCodes:u.selectedAlertitem.view.content.alertCodes,messageFilter:u.selectedAlertitem.view.content.messageFilter},r.creator=u.selectedAlertitem.view.creator?u.selectedAlertitem.view.creator:"",r.updator=u.selectedAlertitem.view.updator?u.selectedAlertitem.view.updator:"",r.createTime=u.selectedAlertitem.view.createTime?u.selectedAlertitem.view.createTime:"",r.updateTime=u.selectedAlertitem.view.updateTime?u.selectedAlertitem.view.updateTime:"",r.description=u.selectedAlertitem.view.description?u.selectedAlertitem.view.description:"",r.domainPath=u.selectedAlertitem.view.domainPath?u.selectedAlertitem.view.domainPath:"",r.domainId=u.selectedAlertitem.view.domainId?u.selectedAlertitem.view.domainId:"",r.resourceDesc=u.selectedAlertitem.view.resourceDesc?u.selectedAlertitem.view.resourceDesc:"",r.statusType=u.selectedAlertitem.view.statusType?u.selectedAlertitem.view.statusType:"",r.originalViewId=u.selectedAlertitem.view.originalViewId?u.selectedAlertitem.view.originalViewId:"",r.modelPath=u.selectedAlertitem.view.modelPath?u.selectedAlertitem.view.modelPath:"",r.content=JSON.stringify(r.content),""==u.selectedAlertitem.view.viewId?o.addView(r,function(e){return 0==e.code?(n.success("新建告警组成功",{}),u.editVisible=!1,u.selectedAlertitem.view=e.data,u.selectedAlertitem.viewId=e.data.viewId,u.alertViewClick(u.selectedAlertitem),!0):(n.warning("新建告警组失败",{}),!(u.editVisible=!0))}):o.updateView(r,function(e){if(0!=e.code)return n.warning("修改告警组失败",{}),void(u.editVisible=!0);for(var t in n.success("修改告警组成功",{}),u.editVisible=!1,u.selectedAlertitem.view=e.data,u.selectedAlertitem.alerts=null,u.selectedAlertitem.resources=null,u.alertViewList)if(u.alertViewList[t].view.viewId==e.data.viewId){u.alertViewList[t]=u.selectedAlertitem;break}u.alertViewClick(u.selectedAlertitem)})}else n.warning("名称不能为空",{})},u.cancelAlertView=function(){if(u.editState=!1,""==u.selectedAlertitem.view.viewId)for(var e in u.alertViewList)if(""==u.alertViewList[e].view.viewId){u.alertViewList.splice(e,1),0<u.alertViewList.length&&u.alertViewClick(u.alertViewList[e-1]);break}u.editVisible=!u.editVisible,u.editVisible},u.format=function(e){return"string"==typeof e?JSON.parse(e):void 0};var V=function(e,t){var i;if(e.content)if("<"==e.content.charAt(0)){if(null==(i=jQuery.xml2json(e.content)).hasOwnProperty("SubViews")||null==i.SubViews.hasOwnProperty("chart"))return;var l=i.SubViews.chart,s=[],r={};if(l.hasOwnProperty("length")){for(var d in l)if("LineChart"==l[d].type||"PieChart"==l[d].type||"GaugeChart"==l[d].type){if(nodeId)for(var o in l[d].dataSource.filters.filter){"ci"==(c=l[d].dataSource.filters.filter[o]).type&&(c.nodeIds=t.toString())}var a,n=w.getChartProperty(l[d],"title").value.split("::");if(1<n.length)if(r[n[0]])(a=r[n[0]]).children.push(l[d]),a.length==a.children.length&&s.push(r[n[0]]);else(a={}).length=n[1],a.type=l[d].type,a.isGroup=!0,a.children=[],a.children.push(l[d]),(r[n[0]]=a).length==a.children.length&&s.push(r[n[0]]);else s.push(l[d])}}else{if(nodeId)for(var o in l.dataSource.filters.filter){var c;"ci"==(c=l.dataSource.filters.filter[o]).type&&(c.nodeIds=t.toString())}"LineChart"!=l.type&&"PieChart"!=l.type&&"GaugeChart"!=l.type||s.push(l)}u.chartsItems=s}else{var m=e.content;if(i=JSON.parse(m),t&&0<t.length)for(var o in i.elements)i.elements[o].nodes=t;for(var o in i.elements){if(i.elements[o].layout){i.elements[o].height_absolute?i.elements[o].layout.style={height:i.elements[o].height_absolute+"px"}:i.elements[o].layout.style={height:"400px"};var v=Math.round(12*i.elements[o].layout.width*.01);i.elements[o].layout.class="col-lg-"+v}else i.elements[o].layout={row:o,col:0,width:100,widthheightPortion:.4,style:"height:500px",class:"col-lg-12"}}u.chartsItems=i.elements}};function T(e){a.findAlertDefinitions({},function(e){0==e.code&&(null==u.selectedDitem.alerts?u.selectedDitem.alerts=e.data:(u.selectedDitem.alerts=e.data,u.selectedAlertitem.alerts=e.data))})}u.chartViewClick=function(e){if(u.selectedCis=[],u.selectedDesignitem=e,u.cilistByModelId=[],w.cilistByModelId=[],u.selectedDesignitem.resources)u.cilistByModelId=u.selectedDesignitem.resources,w.cilistByModelId=u.selectedDesignitem.resources,V(u.selectedDesignitem.view,null);else{var t=JSON.parse(u.selectedDesignitem.view.resourceDesc);for(var i in t){var l=t[0].modelId;a.getResourceByModelId(l,function(e){0==e.code&&(e.data.forEach(function(e){e.text=e.label}),u.selectedDesignitem.resources=e.data,u.cilistByModelId=e.data,w.cilistByModelId=e.data,V(u.selectedDesignitem.view,null))})}}},u.changeChartsCI=function(e){V(u.selectedDesignitem.view,u.selectedCis)},u.addDesignView=function(){window.open("../app-editor/index.html#/echart")},u.editDesignView=function(){u.selectedDesignitem&&("<"==u.selectedDesignitem.view.content.charAt(0)?window.open("../iot-web/simpleView.html?viewId="+u.selectedDesignitem.viewId):window.open("../app-editor/index.html#/echart/"+u.selectedDesignitem.viewId))},u.delDesignView=function(){u.selectedDesignitem&&L.show({title:"提示",closable:!1,message:"是否要删除"+escape(u.selectedDesignitem.title)+"视图",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){o.deleteViews([u.selectedDesignitem.viewId],function(e){if(0==e.code)for(var t in n.success("删除视图成功",{}),u.designView)if(u.designView[t].viewId==u.selectedDesignitem.viewId){u.selectedDesignitem=null,u.designView.splice(t,1),u.chartsItems=null;break}}),e.close()}},{label:"取消",action:function(e){e.close()}}]})},u.getAlertTypeByDeviceType=function(){var e=u.selectedAlertitem.nodeType;null!=e&&null!=e&&""!=e?(T(e),function(e){var t={modelId:e};u.selectedAlertitem.domain&&(t.domains=u.selectedAlertitem.domain);a.getDevicesByCondition(t,function(e){0==e.code&&(u.selectedDitem.label=e.data)})}(e),D(e)):u.selectedAlertitem.alerts=[]};var D=function(e){a.getResourceByModelId(e,function(e){0==e.code&&(u.resources=e.data)})},b=function(){if("/configAlertByStatus"==i.path()){d(function(){u.$broadcast("alertViewClick",{option:"",states:"0,5"})})}else if(a.rootModel=null,a.rootModel?(u.rootModel=a.rootModel,u.rootModelDic=a.rootModelDic,h()):a.getRootModel(function(e){0==e.code&&(a.rootModel=e.data,a.getModels(function(e){if(0==e.code){a.rootModelDic={};var t=e.data;for(var i in t){var l=t[i];l.text=l.label,u.routePathNodes[l.parentModelId]||(u.routePathNodes[l.parentModelId]=[]),u.routePathNodes[l.parentModelId].push(l),u.routePathNodes[l.id]||(u.routePathNodes[l.id]=[]);var s=jQuery.extend(!0,{},l);a.rootModelDic[s.id]=s}var r=function e(t){for(var i in u.routePathNodes)if(i==t.id){for(var l in t.nodes=u.routePathNodes[i],t.nodes)e(t.nodes[l]);0==t.nodes.length&&(t.nodes=null)}};for(var d in r(a.rootModel),u.routePathNodes)if(d!=a.rootModel.id&&!a.rootModelDic[d])for(var i in u.routePathNodes[d])r(u.routePathNodes[d][i]),a.rootModel.nodes||(a.rootModel.nodes=[]),a.rootModel.nodes.push(u.routePathNodes[d][i]);a.rootModelDic[a.rootModel.id]=a.rootModel,u.rootModel=a.rootModel,u.rootModelDic=a.rootModelDic}}),h())}),0<i.path().indexOf("configAlert")){if(T(),!s.hasOwnProperty("viewId")&&!s.hasOwnProperty("nodeId"))if(0<u.alertViewList.length&&null!=u.alertViewList)for(var e in u.alertViewList){u.alertViewClick(u.alertViewList[e]);break}else d(function(){u.$broadcast(Event.ALERTINFOSINIT+"_view",{option:[]})});(0<m.length||0<v)&&(f(),u.selectAlertList.search=!0)}else{if(f(),!s.hasOwnProperty("viewId")&&!s.hasOwnProperty("nodeId")){for(var e in u.designView){u.chartViewClick(u.designView[e]);break}return}if(s.viewId)for(var e in o.viewList){var t=o.viewList[e];if(t.viewId==s.viewId){"designView"==t.viewType&&V(t,s.nodeId);break}}}};r.user.isAuthenticated&&o.viewLoadFinished?g():u.$on("viewLoadFinished",function(e,t){g()})}])});
//# sourceMappingURL=../../map/js/controllers/view-ctrl.js.map
