function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}define(["controllers/controllers","bootstrap-dialog","keyboardJS","rappid-joint","Array"],function(controllers,BootstrapDialog,keyboardJS,joint){"use strict";controllers.initController("RappidBaseCtrl",["$scope","$routeParams","$compile","$rootScope","viewFlexService","resourceUIService","kpiDataService","SwSocket","growl","$location","$timeout","configUIService","$q","ngDialog",function($scope,$routeParams,$compile,$rootScope,viewFlexService,resourceUIService,kpiDataService,SwSocket,growl,loc,timeout,configUIService,$q,ngDialog){var paper,graph,paperScroller,stencil,selection,selectionView,clipboard,commandManager,navigator,snapLines,inspector,cellsDic={},shiftHold=!1,backspaceHold=!1,displayMode=!1,uuid=Math.uuid(),deviceMap={},displayModeLink={arrowheadMarkup:"<g></g>",toolMarkup:"<g></g>",vertexMarkup:"<g></g>"},kpiDefDic={},zoomOptAry=[];-1<location.hash.search("#/display")&&(displayMode=!0);var _events_={},interval;function promise(e){var t=$q.defer();return e(t.resolve,t.reject),t.promise}function getResourceById(i){return promise(function(t,o){deviceMap[i]?t(deviceMap[i]):resourceUIService.getResourceById(i,function(e){"0"==e.code?(deviceMap[i]=e.data,t(e.data)):o(e)})})}function getValue(e){if("string"!=typeof e)return e;var t,o=e.split(":");if(1==o.length)return e;if("string"==(t=o[0]))return o[1]+"";if("number"!=t)return e;var i=o[1]-0;return i==i?i:o[1]}function success(e){var t=$q.defer();return t.resolve(e),t.promise}function getKpisByModelId(e){return resourceUIService.deviceLoader().then(function(){return success(resourceUIService.rootModelDic[e].kpis)})}function getDevicesByCondition(e,t){var o=$q.defer();return resourceUIService.getDevicesByCondition({modelId:e,domains:t},function(e){0==e.code&&o.resolve([{label:"无",id:0}].concat(e.data))}),o.promise}function getMeasurePointData(e){var t,o=[];function i(e){var t,o=[];for(t in e){if("object"!==_typeof(e[t]))return!1;o.push(e[t])}return o}function n(t){return function(e){return e-0!=e-0||e<t}}for(e=isArray(e)?e:[e];t=e.shift();)if(isArray(t))[].push.apply(e,t);else{var a=i(t);a?[].push.apply(e,a):t&&n(1e3)(t.name)&&o.push(t)}return o}function parse(e){var t;try{t=JSON.parse(e)}catch(e){return}return t}function removeType(e){var t=/(?:[^:]*:)?([^:]*)/.exec(e);return t?t[1]:e}function getKpi(t){return function(e){return e.id==t}}$scope.onEvent=function(e,t){_events_[e]=t},keyboardJS.bind("shift",function(e){shiftHold=!0},function(e){shiftHold=!1}),keyboardJS.bind("shift",null,function(e){shiftHold=!1}),keyboardJS.bind("backspace",function(e){backspaceHold=!0},function(e){backspaceHold=!1}),keyboardJS.bind("backspace",null,function(e){backspaceHold=!1}),keyboardJS.bind(["up","down","right","left","delete"],function(i){if("INPUT"!=i.target.tagName&&$scope.selectedItem.cell){var e=$scope.selectedItem.cell,t=e.attributes.position,o=e.get("embeds");38==i.keyCode?(e.prop("position/y",t.y-1),o&&o.forEach(function(e){var t=graph.getCell(e);t.prop("position/y",t.attributes.position.y-1)})):40==i.keyCode?(e.prop("position/y",t.y+1),o&&o.forEach(function(e){var t=graph.getCell(e);t.prop("position/y",t.attributes.position.y+1)})):39==i.keyCode?(e.prop("position/x",t.x+1),o&&o.forEach(function(e){var t=graph.getCell(e);t.prop("position/x",t.attributes.position.x+1)})):37==i.keyCode?(e.prop("position/x",t.x-1),o&&o.forEach(function(e){var t=graph.getCell(e);t.prop("position/x",t.attributes.position.x-1)})):46==i.keyCode&&(o&&o.forEach(function(e){graph.getCell(e).remove()}),e.remove())}else"INPUT"!=i.target.tagName&&0<selection.models.length&&selection.models.forEach(function(e){var t=e.attributes.position;if(38==i.keyCode)e.prop("position/y",t.y-1);else if(40==i.keyCode)e.prop("position/y",t.y+1);else if(39==i.keyCode)e.prop("position/x",t.x+1);else if(37==i.keyCode)e.prop("position/x",t.x-1);else if(46==i.keyCode){var o=e.get("embeds");o&&o.forEach(function(e){graph.getCell(e).remove()}),e.remove()}})}),$scope.alertIcons=[],$scope.selectedView={temp:{},inspector:!1,domainListTree:null},$scope.selectedAlertConfig={},$scope.selectedValueConfig={},$scope.selectedItem={},$scope.directiveList=[],$scope.autoSaveHandler=function(e){$scope.baseConfig&&$scope.baseConfig.autoSave&&(isNaN($scope.baseConfig.autoSave)&&($scope.baseConfig.autoSave=15),interval=setInterval(function(){e()},60*$scope.baseConfig.autoSave*1e3))},$scope.checkSameName=function(o){var t=function(e){var t=e.some(function(e){return o==e.viewTitle});$scope.errorMsg=t?"此视图名称已被占用":null,$scope.checkSm=t};$scope.getAllMyViews?t($scope.getAllMyViews):viewFlexService.getAllMyViews(function(e){0==e.code&&($scope.getAllMyViews=e.data,t(e.data))})},$scope.sendItemDir=function(t,o){var i={};if(t.value){for(var e in t.params){var n=t.params[e];i[n.name]=t.value}BootstrapDialog.show({title:"提示",closable:!1,message:"您发送的指令将会在设备上执行，状态数据返回将会有一定时间，确认要发送指令吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){resourceUIService.sendDeviceDirective(o||Number($scope.selectedItem.nodeId),t.id,i,function(e){0==e.code&&growl.success("指令发送成功，请勿重复发送，状态数据返回需要一定时间！",{})}),e.close()}},{label:"取消",action:function(e){e.close()}}]})}else growl.warning("请输入指令参数")},$scope.backHandler=function(){},$scope.nodeChangeHandler=function(){var e;if(null==$scope.selectedItem.nodeId){if($scope.selectedItem.cell.get("nodeId")){var t=$scope.selectedItem.cell.get("nodeId").toString().split(":");e=Number(t[t.length-1]),$scope.selectedItem.nodeId=e}}else e=$scope.selectedItem.nodeId;if(e){for(var o=0;o<$scope.selectedItem.nodes.length;o++){var i=$scope.selectedItem.nodes[o];if(i.id==e){if($scope.selectedItem.cell.attributes.nodeId="number:"+i.id,$scope.selectedItem.cell.attributes.modelId="number:"+i.modelId,$scope.selectedItem.cell.attributes.domainPath="number:"+$scope.selectedItem.domainPath,$scope.selectedItem.cell.attributes.sn=i.sn,$scope.selectedItem.cell.attributes.attrs.text.text=i.label,0==$scope.selectedItem.modelId){$scope.selectedItem.modelId=i.modelId;var n=resourceUIService.rootModelDic[$scope.selectedItem.modelId];n&&($scope.selectedItem.kpis=n.kpis,$scope.selectedItem.directives=n.directives)}break}}getResourceById(e).then(function(e){$scope.selectedItem.sensors=getMeasurePointData(parse(e.values.MeasurePointLocate)),$scope.selectedItem.sensor=$scope.selectedItem.cell.attributes.sensor,$scope.selectedItem.physicalConfig=e.physicalConfig.accessConfigs,void 0!==$scope.selectedItem.sensor&&null!==$scope.selectedItem.sensor&&$scope.sensorChangeHandler()})}},$scope.$watch("selectedItem.sensor",function(e,t,o){}),$scope.sensorChangeHandler=function(){$scope.selectedItem.cell.attributes.sensor=$scope.selectedItem.sensor,$scope.selectedItem.dataItem=$scope.selectedItem.cell.attributes.dataItem,$scope.selectedItem.dataItems=$scope.selectedItem.physicalConfig.filter(function(e){return e.instance==removeType($scope.selectedItem.sensor)}),$scope.selectedItem.dataItems.sort(function(e,t){var o=$scope.selectedItem.kpis.find(getKpi(e.dataItemId)),i=$scope.selectedItem.kpis.find(getKpi(t.dataItemId));return o.serial-i.serial})},$scope.dataItemChangeHandler=function(){$scope.selectedItem.cell.attributes.dataItem=$scope.selectedItem.dataItem},$scope.directivesChangeHandler=function(){$scope.selectedItem.cell.attributes.directiveIds=$scope.selectedItem.directiveIds},$scope.nodesChangeHandler=function(){$scope.selectedItem.cell.attributes.nodeIds=$scope.selectedItem.nodeIds},$scope.kpiChangeHandler=function(){$scope.selectedItem.cell.attributes.kpiId="number:"+$scope.selectedItem.kpiId},$scope.kpisChangeHandler=function(){$scope.selectedItem.cell.attributes.kpiIds=$scope.selectedItem.kpiIds},$scope.subViewChangeHandler=function(){$scope.selectedItem.cell.attributes.subViewId="number:"+$scope.selectedItem.subViewId},$scope.echartViewIdChangeHandler=function(){$scope.selectedItem.cell.attributes.echartViewId="number:"+$scope.selectedItem.echartViewId},$scope.selectTypeChangeHandler=function(){$scope.selectedItem.models=[],$scope.selectedItem.modelId=0,$scope.selectedItem.nodeId=0,$scope.selectedItem.nodeIds=[],$scope.selectedItem.directives=[],$scope.selectedItem.kpis=[],$scope.selectedItem.kpiId=0},$scope.stateIdChangeHandler=function(){$scope.selectedItem.cell.attributes.stateId="number:"+$scope.selectedItem.stateId},$scope.stateTypeChangeHandler=function(){$scope.selectedItem.cell.attributes.stateType="number:"+$scope.selectedItem.stateType},$scope.tabsInfoChangeHandler=function(){$scope.selectedItem.cell.attributes.tabsInfo=$scope.selectedItem.tabsInfo},$scope.unitChangeHandler=function(){$scope.selectedItem.cell.attributes.unitType="number:"+$scope.selectedItem.unitType},$scope.alertlevelChangeHandler=function(){$scope.selectedAlertConfig&&$scope.selectedItem.cell.prop("alertConfig",$scope.alertLevels)},$scope.alertIconChangeHandler=function(){$scope.selectedAlertConfig&&($scope.selectedItem.cell.prop("alertConfig",$scope.alertLevels),0==$scope.selectedAlertConfig.id&&($scope.selectedItem.cell.attributes.attrs.image["xlink:href"]=$scope.selectedAlertConfig.alertIcon))},$scope.alertTextChangeHandler=function(){$scope.selectedAlertConfig&&($scope.selectedItem.cell.prop("alertConfig",$scope.alertLevels),0==$scope.selectedAlertConfig.id&&($scope.selectedItem.cell.attributes.attrs.text.text=$scope.selectedAlertConfig.alertText))},$scope.valuelevelChangeHandler=function(){$scope.selectedValueConfig&&$scope.selectedItem.cell.prop("valueConfig",$scope.valueLevels)},$scope.valueIconChangeHandler=function(){$scope.selectedValueConfig&&($scope.selectedItem.cell.prop("valueConfig",$scope.valueLevels),0==$scope.selectedValueConfig.id&&($scope.selectedItem.cell.attributes.attrs.image["xlink:href"]=$scope.selectedValueConfig.valueIcon))},$scope.valueTextChangeHandler=function(){$scope.selectedValueConfig&&($scope.selectedItem.cell.prop("valueConfig",$scope.valueLevels),0==$scope.selectedValueConfig.id&&($scope.selectedItem.cell.attributes.attrs.text.text=$scope.selectedValueConfig.valueText))},$scope.valueDirChangeHandler=function(){$scope.selectedValueConfig&&$scope.selectedItem.cell.prop("valueConfig",$scope.valueLevels)},$scope.valueDirAttrChangeHandler=function(){$scope.selectedValueConfig&&$scope.selectedItem.cell.prop("valueConfig",$scope.valueLevels)},$scope.domainAndModelChangeHandler=function(t){var o=0<$scope.selectedItem.modelId?$scope.selectedItem.modelId:null,i=$scope.selectedItem.domainPath;if(o&&i){var e=resourceUIService.rootModelDic[$scope.selectedItem.modelId];e?($scope.selectedItem.kpis=e.kpis,$scope.selectedItem.directives=e.directives,$scope.selectedItem.cell.attributes.modelId="number:"+$scope.selectedItem.modelId,$scope.selectedItem.cell.attributes.domainPath="number:"+$scope.selectedItem.domainPath):($scope.selectedItem.kpis=[],$scope.selectedItem.directives=[]),$scope.selectedView.temp[o+"_"+i]?($scope.selectedItem.nodes=[{label:"无",id:0}].concat($scope.selectedView.temp[o+"_"+i]),t&&($scope.selectedItem.nodeIds=t.nodeIds,$scope.nodesChangeHandler())):resourceUIService.getDevicesByCondition({modelId:o,domains:i},function(e){0==e.code&&($scope.selectedView.temp[o+"_"+i]=e.data,$scope.selectedItem.nodes=[{label:"无",id:0}].concat(e.data),t&&($scope.selectedItem.nodeIds=t.nodeIds,$scope.nodesChangeHandler()))})}},$scope.absheightChanged=function(){$scope.selectedItem.cell.attributes.absheight=Number($scope.selectedItem.absheight),$scope.selectedItem.cell.prop("absheight",Number($scope.selectedItem.absheight))},$scope.layoutZChangeHandler=function(){$scope.selectedItem.cell.attributes.z=Number($scope.selectedItem.z),$scope.selectedItem.cell.prop("z",Number($scope.selectedItem.z))},$scope.extendDomainsChangeHandler=function(){$scope.selectedItem.extendDomainId&&($scope.selectedItem.cell.attributes.extendDomainId="number:"+$scope.selectedItem.extendDomainId,$scope.selectedItem.cell.attributes.nodeId="number:"+$scope.selectedItem.extendDomainId)};var fillColor=function(e,t,o,i,n){var a=e.get("stateId");if(a){i<1&&(i=0);var r=[o,"#25bce7","#e1cd0a","#ed9700","#e7675d"],s=[n,"#25bce7","#e1cd0a","#ed9700","#e7675d"];"number:1"!=a&&"number:3"!=a||t&&e.transition("attrs/"+t+"/fill",r[i],{delay:0,duration:500,valueFunction:joint.util.interpolate.hexColor}),"number:2"!=a&&"number:3"!=a||e.transition("attrs/text/fill",s[i],{delay:0,duration:500,valueFunction:joint.util.interpolate.hexColor})}},breathFlash=function(e,o,t,i,a){var n=e.get("stateId"),r=function(e){var n=a?1:e.opacity;e.transition("attrs/"+o+"/opacity",n,{delay:0,duration:3e3,timingFunction:joint.util.timing.inout,valueFunction:function(o,i){return function(e){var t=o+i*(n-Math.abs(n-2*n*e));return Number(t.toFixed(2))}}})};if(n){i<0&&(i=0);var s=[t,"#25bce7","#e1cd0a","#ed9700","#e7675d"];if("number:2"==n&&(o="text"),o)if(e.opacity||(e.opacity=jQuery.isNumeric(e.prop("attrs/"+o+"/opacity"))?e.prop("attrs/"+o+"/opacity"):1),e.state=i,e.prop("attrs/"+o+"/opacity",.1),e.prop("attrs/"+o+"/fill",s[i]),0<e.state){if(_.contains(e.getTransitions(),"attrs/"+o+"/opacity"))return;e.on("transition:end",function(e,t){0<e.state?r(e):(e.off("transition:end"),e.prop("attrs/"+o+"/opacity",e.opacity))}),r(e)}else e.prop("attrs/"+o+"/opacity",e.opacity)}},setLevel=function setLevel(cell,value){var range=cell.attributes.range;range&&(range=eval(range));var persent=(value-range[0])/(range[1]-range[0]);cell.prop("attrs/text/text",""),cell.transition("attrs/rect",{transform:"translate(0,0)",height:60*persent},{delay:0,duration:1e3,valueFunction:function(o,i){return function(e){var t=o.height+(i.height-o.height)*e;return{transform:"translate(0,"+(60-t)+")",height:t}}}})},bubbleFlash=function(t,o,e,i,n){var a=t.get("stateId"),r=function(){t.prop("attrs/"+o+"/r",0),t.prop("attrs/"+o+"/opacity",n?1:t.opacity),t.transition("attrs/"+o,{r:t.r,opacity:0},{delay:0,duration:1500,valueFunction:function(t,o){return function(e){return{r:t.r+(o.r-t.r)*e,opacity:t.opacity-t.opacity*e}}}})};if(a){i<0&&(i=0);var s=[e,"#25bce7","#e1cd0a","#ed9700","#e7675d"];if("number:2"==a&&(o="text"),o)if(t.opacity||(t.opacity=jQuery.isNumeric(t.prop("attrs/"+o+"/opacity"))?t.prop("attrs/"+o+"/opacity"):1,t.r=t.prop("attrs/"+o+"/r"),t.prop("attrs/"+o+"/opacity",n?1:t.opacity)),t.state=i,t.prop("attrs/"+o+"/fill",s[i]),0<t.state){if(_.contains(t.getTransitions(),"attrs/"+o))return;t.on("transition:end",function(e){0<e.state?r():(t.prop("attrs/"+o+"/opacity",t.opacity),t.prop("attrs/"+o+"/r",t.r))}),r()}else t.prop("attrs/"+o+"/opacity",t.opacity),t.prop("attrs/"+o+"/r",t.r)}},changeIconAndText=function(t,o,e){if(e||(e="alertConfig"),"alertConfig"==e)t.get("alertIcon")&&(o<1&&(o=0),t.get(e).forEach(function(e){e.id==o&&(e.alertText&&t.prop("attrs/text/text",e.alertText),e.alertIcon&&t.prop("attrs/image/xlink:href",e.alertIcon))}));else if("valueConfig"==e){t.get(e).forEach(function(e){e.stateDisplay=!1,e.valueText==o&&(e.stateDisplay=!0,e.valueText&&t.prop("attrs/text/text",e.valueText),e.valueIcon&&t.prop("attrs/image/xlink:href",e.valueIcon))})}},stateHandler=function(s){cellsDic[s.nodeId]?cellsDic[s.nodeId].forEach(function(e){if(e[s.nodeId].state!=s.value){var t=!0,o=e[s.nodeId];if(o.get("kpiId")&&"number:0"!=o.get("kpiId")?s.instance?"number:"+s.instance!=o.get("kpiId")&&(t=!1):t=!1:s.instance&&(t=!1),!t)return;var i=e[s.nodeId].get("extend");"alarm"==i?changeIconAndText(e[s.nodeId],s.value):"level"==i?fillColor(e[s.nodeId],e[s.nodeId+"_type"],e[s.nodeId+"_fill"],s.value,!1):"number:1"==e[s.nodeId].get("stateType")?breathFlash(e[s.nodeId],e[s.nodeId+"_type"],e[s.nodeId+"_fill"],s.value,!1):"number:2"==e[s.nodeId].get("stateType")?bubbleFlash(e[s.nodeId],e[s.nodeId+"_type"],e[s.nodeId+"_fill"],s.value,!1):"number:3"==e[s.nodeId].get("stateType")?breathFlash(e[s.nodeId],e[s.nodeId+"_type"],e[s.nodeId+"_fill"],s.value,!0):"number:4"==e[s.nodeId].get("stateType")?bubbleFlash(e[s.nodeId],e[s.nodeId+"_type"],e[s.nodeId+"_fill"],s.value,!0):fillColor(e[s.nodeId],e[s.nodeId+"_type"],e[s.nodeId+"_fill"],s.value,e[s.nodeId+"text_fill"])}}):graph.attributes.cells.models.forEach(function(e){if(e.get("nodeId")){var t=e.get("nodeId").split(":");if(0<t.length&&t[t.length-1]==s.nodeId){cellsDic[s.nodeId]||(cellsDic[s.nodeId]=[]);var o={},i=$scope.fillType[e.get("type")],n=!0;e.get("kpiId")&&"number:0"!=e.get("kpiId")?s.instance?"number:"+s.instance!=e.get("kpiId")&&(n=!1):n=!1:s.instance&&(n=!1);var a=e.get("extend"),r=e.get("attrs")[i];if(o[s.nodeId+"_fill"]=r?r.fill:"#fff","alarm"!=a&&"value"!=a&&"level"!=a){if(e.get("attrs").text?o[s.nodeId+"text_fill"]=e.get("attrs").text.fill:o[s.nodeId+"text_fill"]="#000",o[s.nodeId+"_type"]=i,o[s.nodeId]=e,cellsDic[s.nodeId].push(o),!n)return;"number:1"==e.get("stateType")?breathFlash(e,i,r.fill,s.value,!1):"number:2"==e.get("stateType")?bubbleFlash(e,i,r.fill,s.value,!1):"number:3"==e.get("stateType")?breathFlash(e,i,r.fill,s.value,!0):"number:4"==e.get("stateType")?bubbleFlash(e,i,r.fill,s.value,!0):fillColor(e,i,r.fill,s.value,o[s.nodeId+"text_fill"])}else if("alarm"==a){if(o[s.nodeId]=e,cellsDic[s.nodeId].push(o),!n)return;changeIconAndText(e,s.value)}else"level"==a&&fillColor(e,i,r.fill,s.value,!1)}}})},fillValue=function(e,t){var o=e.get("extend");if("alarm"!=o)if("level"==o)setLevel(e,t);else{var i="";if("number:1"==e.get("unitType")){var n=kpiDefDic[e.get("kpiId")];n&&$scope.myOptionDic&&(i=$scope.myOptionDic[n.unit])&&e.prop("attrs/text/text",t+""+i)}i||e.prop("attrs/text/text",t)}},valueHandler=function(i){var n;cellsDic[i.nodeId+"_"+i.kpiCode]?cellsDic[i.nodeId+"_"+i.kpiCode].forEach(function(e){fillValue(e,e.rangeObj?e.rangeObj[i.value]:i.value),"value"==e.get("extend")&&changeIconAndText(e,i.value,"valueConfig")}):(i.modelId&&(n=$rootScope.rootModelsDic[i.modelId].kpiDic[i.kpiCode].rangeObj),graph.attributes.cells.models.forEach(function(e){if(e.get("nodeId")){var t=e.get("nodeId").split(":");if(0<t.length&&t[t.length-1]==i.nodeId&&(cellsDic[i.nodeId+"_"+i.kpiCode]||(cellsDic[i.nodeId+"_"+i.kpiCode]=[]),e.get("kpiId"))){var o=e.get("kpiId").split(":");0<o.length&&o[o.length-1]==i.kpiCode&&(e.rangeObj=n,cellsDic[i.nodeId+"_"+i.kpiCode].push(e),fillValue(e,n?n[i.value]:i.value),"value"==e.get("extend")&&changeIconAndText(e,i.value,"valueConfig"))}}}))},getResourceBaseState=function(e){kpiDataService.getRealTimeKpiData(e,[999999],function(e){if(0==e.code)for(var t in e.data)stateHandler(e.data[t])},!0)},getResourceState=function(e,t){kpiDataService.getRealTimeKpiData(e,t,function(e){if(0==e.code)for(var t in e.data)valueHandler(e.data[t])})},uuid=Math.uuid(),getWebsocket=function(e,t){t.push(999999);var o={ciid:e.toString(),kpi:t.toString()},i="register";SwSocket.register(uuid,i,function(e){999999==e.data.kpiCode?stateHandler(e.data):valueHandler(e.data)}),SwSocket.send(uuid,i,"kpi",o)};$scope.$on("$destroy",function(){SwSocket.unregister(uuid),interval&&clearInterval(interval)});var showViewContent=function(h,e){cellsDic={},graph.attributes&&graph.attributes.cells&&graph.attributes.cells.models&&(graph.attributes.cells.models.forEach(function(e){e.off("transition:end")}),graph.clear()),"all"!=e&&viewFlexService.getViewById(e,function(e){if(0==e.code){if($.AdminLTE.controlSidebar.activate(),$scope.selectedView=e.data,$scope.selectedView.temp={},$scope.selectedView.inspector=!1,$scope.selectedView.domainListTree=[$scope.domainListDic[$scope.selectedView.domainPath]],$scope.baseConfig&&$scope.baseConfig.extendDomain&&$scope.selectedView.template&&"project"==$scope.selectedView.template.resourceType&&resourceUIService.getResourceByIds([$scope.selectedView.template.resourceId],function(e){if(e[$scope.selectedView.template.resourceId]){var t={domains:e[$scope.selectedView.template.resourceId].domains.replace($scope.selectedView.template.resourceId+"/",""),modelId:301};resourceUIService.getExtendDomainsByFilter(t,function(e){0==e.code&&($scope.selectedView.subDomainListTree=e.domainListTree,$scope.selectedView.subDomainListDic=e.domainListDic)})}}),h.data.viewTitle=$scope.selectedView.viewTitle,displayMode||($scope.autoSaveHandler(h.components.myCommander.save4Json),0<$scope.$parent.configViewBg.length&&(h.data.bgimages=h.data.bgimages.concat($scope.$parent.configViewBg)),0<$scope.$parent.configCustoms.length&&(h.components.stencil.load($scope.$parent.configCustoms,"enterprise"),h.components.layout(stencil.getGraph("enterprise")),h.components.stencil.getPaper("enterprise").fitToContent(1,1,10)),0<$scope.$parent.configCommons.length&&(h.components.stencil.load($scope.$parent.configCommons.concat(h.data.stencil.shapes.customer),"customer"),h.components.layout(stencil.getGraph("customer")),h.components.stencil.getPaper("customer").fitToContent(1,1,10),$scope.$parent.configCommons.forEach(function(e){e.label=e.attrs.text.text,$scope.alertIcons.push(e)}))),e.data.content){$scope.fillType=h.data.fillType;for(var t=JSON.parse(e.data.content),o={},i={},n=(h.data.paperscorllerW-20)/t.width,a=t.cells.length-1;-1<a;a--)"link"==t.cells[a].type?displayMode&&(jQuery.extend(t.cells[a],displayModeLink),t.cells[a].attrs[".connection-wrap"]={display:"none"}):"chart.Plot"==t.cells[a].type?displayMode&&(o[t.cells[a].id]=t.cells[a]):i[t.cells[a].id]=t.cells[a];if(0<zoomOptAry.length&&(paperScroller.zoom(-zoomOptAry.pop(),{max:4}),paper.$el.css("margin-left",0)),h.components.graph.fromJSON(t),h.components.paper.options.gridSize=Number(t.gridSize),h.components.paper.options.width=t.width,h.components.paper.options.height=t.height,h.data.bgimage=t.bgimage,h.data.bgcolor=t.bgcolor?t.bgcolor:"#ffffff",h.data.width=t.width,h.data.height=t.height,h.data.originalCellDic=i,h.components.myCommander.setDimensions(),h.components.myCommander.setGrid(),paper.$el.css("background-position","center center"),displayMode){zoomOptAry.push(n-1),paperScroller.zoom(n-1,{max:4}),paper.$el.css("margin-right",0),h.data.width=jQuery(".paper").width(),h.data.height=jQuery(".paper").height(),paperScroller.scroll(0,0),paperScroller.$el.css("padding-left","0"),paperScroller.$el.css("padding-top","0");var r=[],s={};for(a=graph.attributes.cells.models.length-1;-1<a;a--){var c=graph.attributes.cells.models[a];if("chart.Plot"==c.attributes.type){var l,d=jQuery("[model-id="+c.id+"]").find("g.background")[0].getBoundingClientRect();if(o[c.id+"_extend"]||(o[c.id].size.width=d.width,o[c.id].size.height=d.height,o[c.id].size.x=d.left,"service"==$routeParams.type?o[c.id].size.y=c.attributes.position.y*n:o[c.id].size.y=d.top-86,o[c.id].position.width=d.width,o[c.id].position.height=d.height,o[c.id].position.x=d.left,"service"==$routeParams.type?o[c.id].position.y=c.attributes.position.y*n:o[c.id].position.y=d.top-86,o[c.id+"_extend"]=!0),c.attributes.tabsInfo||c.attributes.attrs.text&&c.attributes.attrs.text.text)if(1<(l=c.attributes.tabsInfo?c.attributes.tabsInfo.split("$$"):c.attributes.attrs.text.text.split("$$")).length){c.attributes.attrs.text={text:l[l.length-1]},o[c.id].attrs.text=c.attributes.attrs.text;var p=JSON.parse(l[0]);s[p.group]||(s[p.group]={name:p.group,x:o[c.id].position.x,y:o[c.id].position.y,width:o[c.id].size.width,height:o[c.id].size.height,echartAry:[]}),s[p.group].echartAry.push(o[c.id])}else r.push(o[c.id]);else r.push(o[c.id]);c.remove()}}h.data.echartAry=r;var u=[];for(var g in s)u.push(s[g]);h.data.groupAry=u;var f=[],m=[];t.cells.forEach(function(t){if(t.nodeId&&"chart.Plot"!=t.type){var e=t.nodeId.split(":");if(0<e.length&&"?"!=e[e.length-1]){var o=Number(e[e.length-1]);if(0==o)return!0;if(f.push(o),t.kpiId){var i=t.kpiId.split(":");if(0<i.length&&"?"!=i[i.length-1]){var n=Number(i[i.length-1]);if(0==n)return!0;var a=t.modelId.split(":"),r=Number(a[a.length-1]),s=resourceUIService.rootModelDic[r];s&&s.kpis&&s.kpis.forEach(function(e){if(n==e.id)return kpiDefDic[t.kpiId]=e,m.push(n),getResourceState([o],[n]),!1})}}}}}),0<f.length&&(getResourceBaseState(f),getWebsocket(f,m))}}else h.data.bgcolor="#ffffff",h.components.graph.clear(),displayMode&&(paper.$el.css("background-image",'url(""),url("")'),paper.$el.css("margin-right",0));$scope.onEvent("graphUpdated",function(){setTimeout(function(){$scope.$apply(function(){$rootScope.dirty=!0})})})}})},PatternLinkView=joint.dia.LinkView.extend({patternMarkup:['<pattern id="pattern-<%= id %>" patternUnits="userSpaceOnUse">','<image xlink:href=""/>',"</pattern>"].join(""),render:function(){if(joint.dia.LinkView.prototype.render.apply(this,arguments),!this.model||this.model.get("pattern"))return this.listenTo(this.model,"change:pattern change:patternColor",this.update),this},remove:function(){joint.util.cancelFrame(this.frameId),joint.dia.LinkView.prototype.remove.apply(this,arguments),this.pattern&&(this.pattern.remove(),this.pattern=null)},update:function(){if(joint.dia.LinkView.prototype.update.apply(this,arguments),!this.model||this.model.get("pattern"))return this.pattern||(this.pattern=joint.V(_.template(this.patternMarkup)({id:this.id})),this.patternImage=this.pattern.findOne("image"),joint.V(this.paper.svg).defs().append(this.pattern)),this._V.connection.attr({stroke:"url(#pattern-"+this.id+")"}),this.strokeWidth=this._V.connection.attr("stroke-width")||1,joint.util.cancelFrame(this.frameId),this.frameId=joint.util.nextFrame(_.bind(this.fillWithPattern,this)),this},fillWithPattern:function(){var e=this.strokeWidth,t=joint.g.rect(joint.V(this.el).bbox(!0)).moveAndExpand({x:-e,y:-e,width:2*e,height:2*e}),o=[].concat(this.sourcePoint,this.route,this.targetPoint);o=_.map(o,function(e){return joint.g.point(e.x-t.x,e.y-t.y)});var i=document.createElement("canvas");i.width=t.width,i.height=t.height;var n=i.getContext("2d");n.lineWidth=e,n.lineJoin="round",n.lineCap="round";for(var a=0,r=o.length-1;a<r;a++){n.save();var s=this.gradientPoints(o[a],o[a+1],e),c=n.createLinearGradient.apply(n,s);this.drawPattern.call(this,n,o[a],o[a+1],e,c,o,a),n.restore()}var l=i.toDataURL("image/png");this.pattern.attr(t),this.patternImage.attr({width:t.width,height:t.height,"xlink:href":l})},gradientPoints:function(e,t,o){var i=joint.g.toRad(e.theta(t)-90),n=joint.g.line(e,t).midpoint(),a=joint.g.point.fromPolar(o/2,i,n),r=joint.g.point.fromPolar(o/2,Math.PI+i,n);return[a.x,a.y,r.x,r.y]},drawPattern:function(e,t,o,i,n){e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(o.x,o.y),e.stroke(),e.closePath(),e.beginPath(),e.strokeStyle="white",e.lineWidth=i-2,e.moveTo(t.x,t.y),e.lineTo(o.x,o.y),e.stroke(),e.closePath()}}),createConfigView=function(e){$scope.configureInfo={viewId:0,viewTitle:"新建组态视图"+(new Date).Format("yyyy-MM-dd"),viewType:"configure",template:{type:0},domainPath:"",description:""};var o=ngDialog.open({template:"../partials/dialogue/configure_dia.html",className:"ngdialog-theme-plain",scope:$scope});$scope.checkSameName($scope.configureInfo.viewTitle);$scope.$watch("configureInfo.template.type",function(e,t,o){var i=function(e){var t=e.data;$scope.typeContents=[].concat(t)};e<2?i({data:$scope.treeAry}):2==e&&($scope.getResourceByModelId?i($scope.getResourceByModelId):resourceUIService.getResourceByModelId(302,function(e){$scope.getResourceByModelId=e,i(e)}))}),$scope.saveData=function(){$scope.configureInfo.template.resourceId&&0!=$scope.configureInfo.template.resourceId?1==$scope.configureInfo.template.type?$scope.configureInfo.template.resourceType="device":$scope.configureInfo.template.resourceType="project":$scope.configureInfo.template=null,viewFlexService.addView($scope.configureInfo,function(e){if(0==e.code){var t=e.data.viewId;o&&(o.close(),$("#"+o.id).remove()),growl.success("保存成功"),location.href="index.html#/configure/"+t}})},$scope.closeDialog=function(){o&&(o.close(),$("#"+o.id).remove(),window.history.back())}};$scope.updateCellHandler=function(){inspector&&inspector.getModel().collection&&inspector.updateCell()};var inspectorStatus=function(e){$scope.selectedView.inspector=!1,$scope.$applyAsync(),$.AdminLTE.controlSidebar.openOrClose(e)};$scope.viewConfigClick=function(){$scope.selectedView.inspector=!0,$scope.$applyAsync()};var creatingLine=!1,lineCoords={source:{},target:{}},tempLine,tempLines=[];$(document.body).on("mousemove",function(e){if(creatingLine){e.preventDefault(),e.stopPropagation(),e=joint.util.normalizeEvent(e);var t=paper.snapToGrid({x:e.clientX,y:e.clientY});lineCoords.x2=t.x,lineCoords.y2=t.y;var o="M "+lineCoords.x1+" "+lineCoords.y1+" L "+lineCoords.x2+" "+lineCoords.y2;tempLine.attr("d",o)}});var addCellhandler=function(e){if("copy"==e.get("extend")){var t=JSON.parse(e.get("parentCell")),o=JSON.parse(e.get("embedObjs")),i=e.get("position"),n=t.position;if(e.remove(),t.id=joint.util.uuid(),t.embeds=[],t.z=graph.getLastCell()?(Number(graph.getLastCell().get("z"))||0)+1:1,t.z>Number.MAX_VALUE&&(t.z=Number.MAX_VALUE),t.position=i,o)for(var a=0;a<o.length;a++){var r=o[a];r.id=joint.util.uuid(),t.embeds.push(r.id),r.parent=t.id,r.position.x=r.position.x-n.x+i.x,r.position.y=r.position.y-n.y+i.y,r.z=t.z+a+1,r.z>Number.MAX_VALUE&&(r.z=Number.MAX_VALUE),graph.addCell(r)}graph.addCell(t)}else if("string"==typeof e.get("z")){var s=e.clone();s.unset("z"),s.attributes.z=graph.getLastCell()?(Number(graph.getLastCell().get("z"))||0)+1:1,s.attributes.z>Number.MAX_VALUE&&(s.attributes.z=Number.MAX_VALUE),e.remove(),graph.addCell(s)}};if($scope.initialization=[function(e,t){var o=!1;displayMode||(o=!0),$scope.graph=graph=new joint.dia.Graph,paper=new joint.dia.Paper({width:1200,height:700,gridSize:10,perpendicularLinks:!0,model:graph,markAvailable:!0,interactive:o,defaultLink:new joint.dia.Link({attrs:{".marker-source":{d:"M 10 0 L 0 5 L 10 10 z",transform:"scale(0.001)"},".marker-target":{d:"M 10 0 L 0 5 L 10 10 z"},".connection":{stroke:"black"}}}),linkConnectionPoint:joint.util.shapePerimeterConnectionPoint,linkView:PatternLinkView.extend({drawPattern:function(e,t,o,i,n){var a=i-4,r=i,s=(joint.g.point(t).move(o,-r/2),joint.g.point(o).move(t,-r/2),"blue");this.model.get("attrs")&&this.model.get("attrs")[".connection"]&&(s=this.model.get("attrs")[".connection"].stroke?this.model.get("attrs")[".connection"].stroke:s),n.addColorStop(.3,s);var c="#ffffff";this.model.get("patternColor")&&(c=this.model.get("patternColor")),n.addColorStop(.5,c),n.addColorStop(.7,s),e.beginPath(),e.lineWidth=a,e.strokeStyle=n,e.moveTo(t.x,t.y),e.lineTo(o.x,o.y),e.stroke(),e.closePath()}})}),paperScroller=new joint.ui.PaperScroller({paper:paper,autoResizePaper:displayMode,padding:0}),displayMode||(snapLines=new joint.ui.Snaplines({paper:paper})),$(".paper-container",t).append(paperScroller.el),e.components.paper=paper,e.components.scroller=paperScroller,e.components.graph=graph,e.data.paperscorllerW=$(".paper-scroller").width(),graph.on("add",function(e,t,o){addCellhandler(e)}),"service"==$routeParams.type?($(paperScroller.el).css("overflow","hidden"),$(paperScroller.el).css("width","auto"),$(paperScroller.el).css("height","auto")):($(".paper-echart-container").scroll(function(){$(".paper-scroller").scrollTop($(".paper-echart-container").scrollTop())}),$(".paper-scroller").scroll(function(){$(".paper-echart-container").scrollTop($(".paper-scroller").scrollTop())}))},function(e,t){function o(e){joint.layout.GridLayout.layout(e,{columnWidth:(stencil.options.width-10)/2,columns:2,rowHeight:90,resizeToFit:!1,dy:10,dx:0})}(stencil=new joint.ui.Stencil({graph:graph,paper:paper,width:230,dropAnimation:!0,groups:e.data.stencil.groups,search:e.data.stencil.search}).on("filter",o)).renderSearch=function(){return $('<div class="sidebar-form"><input placeholder="搜索..." type="search" class="search form-control"/></div>')},$(".stencil-container",t).append(stencil.render().el),_.each(e.data.stencil.shapes,function(e,t){stencil.load(e,t),o(stencil.getGraph(t)),stencil.getPaper(t).fitToContent(1,1,10)}),stencil.closeGroups(),e.components.layout=o,e.components.stencil=stencil},function(a,e){selection=new Backbone.Collection,selectionView=new joint.ui.SelectionView({paper:paper,graph:graph,model:selection}),paper.on("blank:pointerdown",function(e,t,o){if(inspectorStatus(!1),a.data.drawStatus){var i=function(){var e="M "+t+" "+o+" L "+t+" "+o;tempLine&&tempLines.push(tempLine),tempLine=joint.V("path",{stroke:"black","stroke-width":1,d:e}),joint.V(paper.viewport).append(tempLine),creatingLine?(lineCoords.vertices||(lineCoords.vertices=[]),lineCoords.vertices.push({x:t,y:o})):lineCoords.source={x:t,y:o},creatingLine=!0,lineCoords.x1=t,lineCoords.y1=o};if(3!=e.which)i();else if(creatingLine){i(),lineCoords.target={x:t,y:o};var n=new joint.dia.Link({source:lineCoords.source,target:lineCoords.target,vertices:lineCoords.vertices,attrs:{}});graph.addCell([n]),creatingLine=!1,lineCoords={source:{},target:{}},tempLines.forEach(function(e){e.remove()}),tempLines=[],tempLine=null,a.$apply(function(){a.data.drawStatus=!1})}}else shiftHold?selectionView.startSelecting(e,t,o):(selectionView.cancelSelection(),paperScroller.startPanning(e,t,o))}),paper.on("cell:pointerdown",function(e,t){!t.ctrlKey&&!t.metaKey||e.model instanceof joint.dia.Link||(selectionView.createSelectionBox(e),selection.add(e.model))}),selectionView.on("selection-box:pointerdown",function(e){if(e.ctrlKey||e.metaKey){var t=selection.get($(e.target).data("model"));selectionView.destroySelectionBox(paper.findViewByModel(t)),selection.reset(selection.without(t))}}),paper.el.oncontextmenu=function(e){e.preventDefault()},keyboardJS.on("delete, backspace",function(e){$.contains(e.target,paper.el)&&(commandManager.initBatchCommand(),selection.invoke("remove"),commandManager.storeBatchCommand(),selectionView.cancelSelection(),backspaceHold&&!$(e.target).is("input, textarea")&&e.preventDefault())})},function(M,T){function n(e){var t,o=$("#control-sidebar-settings-data",T),i=$("#control-sidebar-settings-text",T),n=$("#control-sidebar-settings-presentation",T),a=$("#control-sidebar-settings-geometry",T),r=e.model||e;if(displayMode){cellsDic[r.id]||(cellsDic[r.id]=jQuery.extend(!0,{},r.attributes));var s=r.get("subViewId")&&"number:0"!=r.get("subViewId")&&"?"!=r.get("subViewId"),c=r.get("nodeId")&&"number:0"!=r.get("nodeId")&&"?"!=r.get("nodeId");if(null!=s&&null!=c||(r.attributes=cellsDic[r.id],s=r.get("subViewId")&&"number:0"!=r.get("subViewId")&&"?"!=r.get("subViewId"),c=r.get("nodeId")&&"number:0"!=r.get("nodeId")&&"?"!=r.get("nodeId")),(s||c)&&(t=new joint.ui.Halo({cellView:e,type:"toolbar"}).render()).removeHandles(),c){var l,d,p=r.get("nodeId").toString().split(":");0<p.length&&"?"!=p[p.length-1]&&(l=Number(p[p.length-1]));var u=r.get("modelId").toString().split(":");0<u.length&&"?"!=u[u.length-1]&&(d=Number(u[u.length-1]));var g=resourceUIService.rootModelDic[d],f=r.get("sn");if($scope.selectedItem.nodeId=l,t.addHandle({name:"alertaction",position:"s",icon:"images/alert.svg"}),t.on("action:alertaction:pointerdown",function(e){e.stopPropagation(),window.open("../app-oc/index.html#/configAlert/"+l+"/node")}),t.addHandle({name:"chartaction",position:"s",icon:"images/chart.svg"}),t.on("action:chartaction:pointerdown",function(e){e.stopPropagation(),window.open("../app-oc/index.html#/emcsView/"+l)}),t.addHandle({name:"infoaction",position:"s",icon:"images/info.svg"}),t.on("action:infoaction:pointerdown",function(e){e.stopPropagation(),window.open("../app-oc/index.html#/facility/sn/"+f)}),t.addHandle({name:"configaction",position:"s",icon:"images/config.svg"}),t.on("action:configaction:pointerdown",function(e){e.stopPropagation(),g&&"Device"==g.category?window.open("../app-oc/index.html#/resource_type/"+d+"/0"):window.open("../app-oc/index.html#/resourcegroup/"+d+"/0")}),r.get("directiveIds")&&(t.addHandle({name:"directiveaction",position:"s",icon:"images/directive.svg"}),t.on("action:directiveaction:pointerdown",function(e){e.stopPropagation(),inspectorStatus(!0);var o=[];r.get("directiveIds").forEach(function(t){if("number"!=typeof t){var e=t.split(":");t=Number(e[e.length-1])}g.directives.forEach(function(e){t==e.id&&o.push(e)})}),$scope.directiveList=o,$scope.$apply()})),r.get("valueConfig")){var m=!1;$scope.valueLevels=r.get("valueConfig"),$scope.valueLevels&&g&&($scope.valueLevels.forEach(function(t){t.stateDisplay&&t.valueDirective&&t.valueDirectiveAttr&&(m=!0,g.directives.forEach(function(e){t.valueDirective==e.id&&(e.value=t.valueDirectiveAttr,$scope.sendItemDir(e,l))}))}),!m&&$scope.valueLevels[0].valueDirective&&$scope.valueLevels[0].valueDirectiveAttr&&g.directives.forEach(function(e){$scope.valueLevels[0].valueDirective==e.id&&(e.value=$scope.valueLevels[0].valueDirectiveAttr,$scope.sendItemDir(e,l))}))}}if(s){var h,v=r.get("subViewId").toString().split(":");0<v.length&&"?"!=v[v.length-1]&&(h=Number(v[v.length-1])),t.addHandle({name:"nextaction",position:"s",icon:"images/subview.svg"}),t.on("action:nextaction:pointerdown",function(e){e.stopPropagation(),"service"==$routeParams.type?loc.path("display/"+h+"/service"):0<h&&(SwSocket.unregister(uuid),uuid=Math.uuid(),M.data.viewRoutes.push($scope.selectedView),showViewContent(M,h))})}}else{if(M.components.commander.configDispaly&&inspectorStatus(!0),(t=new joint.ui.Halo({cellView:e}).render()).options.clone=function(e,t){var o=e.clone(),i=(Number(graph.getLastCell().get("z"))||0)+1;return o.attributes.z=i,o.prop("z",i),o.unset("parent"),o},r.get("alertConfig")?$scope.alertLevels=r.get("alertConfig"):$scope.alertLevels=[{label:"正常",id:0},{label:"警告",id:1},{label:"次要",id:2},{label:"重要",id:3},{label:"严重",id:4}],r.get("valueConfig")?$scope.valueLevels=r.get("valueConfig"):$scope.valueLevels=[{label:"第一组数据",id:0,stateDisplay:!0},{label:"第二组数据",id:1,stateDisplay:!1},{label:"第三组数据",id:2,stateDisplay:!1},{label:"第四组数据",id:3,stateDisplay:!1},{label:"第五组数据",id:4,stateDisplay:!1}],r.attributes.embeds&&0<r.attributes.embeds.length){t.addHandle({name:"embedsaction",position:"s",icon:"images/info.svg"}),t.addHandle({name:"copyaction",position:"w",icon:"images/print.png"});var I=function(o){var i=[],n=[];if($scope.selectedItem.cell.attributes.embeds){var a=$scope.selectedItem.cell.clone();a.id=joint.util.uuid(),a.attributes.id=a.id,a.attributes.parent="",a.attributes.z=graph.getLastCell()?(Number(graph.getLastCell().get("z"))||0)+1:1;var r=1;if($scope.selectedItem.cell.attributes.embeds.forEach(function(e){var t=graph.getCell(e).clone();t.id=joint.util.uuid(),t.attributes.id=t.id,t.attributes.parent=a.id,t.attributes.z=a.attributes.z+r,i.push(t.id),"embedsaction"==o?graph.addCell(t):"copyaction"==o&&n.push(t),r++}),a.attributes.embeds=i,"embedsaction"==o)graph.addCell(a);else if("copyaction"==o){paper.toPNG(function(e){!function(e){var t=a.toJSON(),o={type:"basic.Image",extend:"copy",parentCell:JSON.stringify(t),embedObjs:JSON.stringify(n),size:{width:60,height:60},attrs:{image:{width:60,height:60,"xlink:href":e},text:{text:t.attrs.text.text,"font-size":12,stroke:"#000000",display:"block","stroke-width":0,fill:"#000000","ref-dy":10,"font-family":"Microsoft YaHei"}}};$scope.$parent.configCustoms.push(o),M.components.stencil.load($scope.$parent.configCustoms,"enterprise"),M.components.layout(stencil.getGraph("enterprise")),M.components.stencil.getPaper("enterprise").fitToContent(1,1,10);var i={key:"",value:JSON.stringify(o),groupName:"ConfigurationCustom",keyDesc:"",invalid:!1,canDelete:!0,domainPath:"",id:0,label:t.attrs.text.text};configUIService.saveConfig(i,function(e){})}(e)},{padding:0})}}};t.on("action:embedsaction:pointerdown",function(e){e.stopPropagation(),I("embedsaction")}),t.on("action:copyaction:pointerdown",function(e){e.stopPropagation(),I("copyaction")})}if("basic.Text"==r.get("type")&&t.removeHandle("resize"),"link"!=r.get("type"))new joint.ui.FreeTransform({cellView:e}).render();if(!$scope.selectedItem.cell||$scope.selectedItem.cell.id!=r.id){var b,y,w,x;(b=function(e,t){var o,i=t;for(var n in e)(o=L(e[n]))&&(i[n]=o);return i}(r.attributes,{cell:r,nodes:[],kpis:[],domainPath:$scope.selectedView.domainPath,absheight:100,selectType:-1}),y=b.modelId,w=b.domainPath,x=b.nodeId,y?getDevicesByCondition(y,w).then(function(e){return b.nodes=e,getKpisByModelId(y).then(function(e){return b.kpis=e,x?getResourceById(x).then(function(e){return b.sensors=getMeasurePointData(parse(e.values.MeasurePointLocate)),b.physicalConfig=e.physicalConfig.accessConfigs,b.dataItems=b.physicalConfig.filter(function(e){return e.instance==getValue(b.sensor)}),b.domainListTree=[$scope.domainListDic[b.domainPath]],success(b)}):success(b)})}):success(b)).then(function(e){$scope.selectedItem=jQuery.extend(!0,{},e)}),!inspector||inspector.options.cell,inspector&&(inspector.getModel().collection&&inspector.updateCell(),inspector.remove());var C=M.inspectorDefs[r.get("type")],S=C&&C.inputs?C.inputs:M.commonInspectorInputs,k=C&&C.groups?C.groups:M.commonInspectorGroups;"alarm"==r.get("extend")?(delete(S=_.extend(S,M.extendAlertInputs)).valueIcon,delete S.valueLevel,delete S.valueText,delete S.valueDirective,delete S.valueDirectiveAttr):"value"==r.get("extend")?(delete(S=_.extend(S,M.extendValueInputs)).alertIcon,delete S.alertLevel,delete S.alertText):"baowualarm"==r.get("extend")?S=_.extend(M.baowuAlerts,M.basicAttr):"kpis"==r.get("extend")?S=_.extend(S,M.commonInspectorInputsKpis):("instance"==r.get("extend")?(delete(S=_.extend(S,M.commonInspectorInstance)).domainPath,delete S.subViewId,delete S.directiveIds):("level"==r.get("extend")?delete(S=_.extend({},M.levelInputs)).alertIcon:"domain"==r.get("extend")?delete(S=_.extend({},M.domainInputs)).alertIcon:"switch"==r.get("extend")?delete(S=_.extend({},M.switchInputs)).alertIcon:"openangle"==r.get("extend")?delete(S=_.extend({},M.openAngleInputs)).alertIcon:delete S.alertIcon,delete S.alertLevel,delete S.alertText),delete S.valueIcon,delete S.valueLevel,delete S.valueText,delete S.valueDirective,delete S.valueDirectiveAttr);for(var V=(inspector=new joint.ui.Inspector({inputs:S,groups:k,cell:r}).on("render",function(){this.$("[data-tooltip]").each(function(){var e=$(this);new joint.ui.Tooltip({target:e,content:e.data("tooltip"),right:".inspector",direction:"right"})})})).render().el,D=0;D<V.children.length;D++)$(V.children[D]).wrap("<div class='inspector'></div>");a.html(V.children[3]),n.html(V.children[2]),i.html(V.children[1]),o.html(V.children[0]),$compile(o)($scope),$compile(i)($scope),$compile(n)($scope),$compile(a)($scope),selectionView.cancelSelection(),selection.reset([e.model])}}function L(e){return"string"==typeof e?getValue(e):Array.isArray(e)?e.map(function(e){return getValue(e)}):e}}paper.on("cell:pointerup",function(e){e.model instanceof joint.dia.Element&&!selection.contains(e.model)&&n(e)}),paper.on("link:options",function(e,t,o,i){n(t)})},function(e,t){},function(e,t){clipboard=new joint.ui.Clipboard,keyboardJS.on("ctrl + shift + c",function(){clipboard.copyElements(selection,graph,{translate:{dx:20,dy:20},useLocalStorage:!0})}),keyboardJS.on("ctrl + shift + v",function(){selectionView.cancelSelection(),clipboard.pasteCells(graph,{link:{z:-1},useLocalStorage:!0}),clipboard.each(function(e){"link"!==e.get("type")&&(selection.add(graph.getCell(e.id)),selectionView.createSelectionBox(paper.findViewByModel(e)))})}),keyboardJS.on("ctrl + x",function(){var e=clipboard.copyElements(selection,graph,{useLocalStorage:!0});commandManager.initBatchCommand(),_.invoke(e,"remove"),commandManager.storeBatchCommand(),selectionView.cancelSelection()})},function(n,e){n.components.myCommander={},n.components.myCommander.setDimensions=function(){paper.setDimensions(paper.options.width,paper.options.height),paperScroller.options.baseWidth=paper.options.width,paperScroller.options.baseHeight=paper.options.height,paperScroller.$el.css("padding-top",0),paperScroller.$el.css("padding-left",0)},n.components.myCommander.setGrid=function(){var e=function(e,t){var o=$("<canvas/>",{width:e,height:e});o[0].width=e,o[0].height=e;var i=o[0].getContext("2d");return i.beginPath(),i.rect(1,1,1,1),i.fillStyle=t||"#AAAAAA",i.fill(),o[0].toDataURL("image/png")}(paper.options.gridSize);n.data.bgcolor?paper.$el.css("background-color",n.data.bgcolor):paper.$el.css("background-color","#fff"),n.data.bgimage?displayMode?paper.$el.css("background-image",'url(""),url("'+n.data.bgimage+'")'):paper.$el.css("background-image",'url("'+e+'"),url("'+n.data.bgimage+'")'):displayMode?paper.$el.css("background-image",'url(""),url("")'):paper.$el.css("background-image",'url("'+e+'")')},$rootScope.save4Json=n.components.myCommander.save4Json=function(t){var e=graph.toJSON();$rootScope.dirty=!1;t=t||function(){};e.gridSize=paper.options.gridSize,e.width=paper.options.width,e.height=paper.options.height,e.bgimage=n.data.bgimage,e.bgcolor=n.data.bgcolor;var o=JSON.stringify(e);try{var i={viewId:$scope.selectedView.viewId,viewTitle:n.data.viewTitle,viewName:n.data.viewTitle,viewType:"configure",content:o};0==i.viewId?viewFlexService.addView(i,function(e){0==e.code&&($rootScope.dirty=!1,t("success"),growl.success("保存成功"))}):viewFlexService.updateView(i,function(e){0==e.code&&(t("success"),$rootScope.dirty=!1,growl.success("保存成功"))})}catch(e){t("error"),alert(e)}}},function(e,t){displayMode||(joint.dia.CommandManager.prototype.push=function(e){"function"==typeof _events_.graphUpdated&&_events_.graphUpdated(),this.redoStack=[],e.batch?(this.lastCmdIndex=Math.max(this.lastCmdIndex,0),this.trigger("batch",e)):(this.undoStack.push(e),this.trigger("add",e))},commandManager=new joint.dia.CommandManager({graph:graph}),keyboardJS.on("ctrl + z",function(){commandManager.undo(),selectionView.cancelSelection()}),keyboardJS.on("ctrl + y",function(){commandManager.redo(),selectionView.cancelSelection()}),commandManager.configDispaly=!0,commandManager.configDispalySet=function(e){commandManager.configDispaly=e},commandManager.alignAction=function(n){var a;commandManager.initBatchCommand(),selectionView.model.models.forEach(function(e){"left"==n?(a||(a=e.attributes.position.x),a>e.attributes.position.x&&(a=e.attributes.position.x)):"right"==n?(a||(a=e.attributes.position.x+e.attributes.size.width),a<e.attributes.position.x+e.attributes.size.width&&(a=e.attributes.position.x+e.attributes.size.width)):"up"==n?(a||(a=e.attributes.position.y),a>e.attributes.position.y&&(a=e.attributes.position.y)):"down"==n&&(a||(a=e.attributes.position.y+e.attributes.size.height),a<e.attributes.position.y+e.attributes.size.height&&(a=e.attributes.position.y+e.attributes.size.height))}),selectionView.model.models.forEach(function(e){if(e.get("parent")){var t=graph.getCell(e.get("parent")),o=t.get("position").x-e.get("position").x,i=t.get("position").y-e.get("position").y;"left"==n?e.prop("position/x",a-o):"right"==n?e.prop("position/x",a-t.attributes.size.width-o):"up"==n?e.prop("position/y",a-i):"down"==n&&e.prop("position/y",a-t.attributes.size.height-i)}}),selectionView.model.models.forEach(function(e){e.get("parent")||("left"==n?e.prop("position/x",a):"right"==n?e.prop("position/x",a-e.attributes.size.width):"up"==n?e.prop("position/y",a):"down"==n&&e.prop("position/y",a-e.attributes.size.height))}),commandManager.storeBatchCommand()},commandManager.toFront=function(){selection.invoke("toFront")},commandManager.toBack=function(){selection.invoke("toBack")},commandManager.embed=function(){var t;selectionView.model.models.forEach(function(e){t?t.attributes.z>e.attributes.z&&(t=e):t=e}),selectionView.model.models.forEach(function(e){t.id!=e.id&&t.embed(e)})},commandManager.unembed=function(){selectionView.model.models.forEach(function(t){t.attributes.embeds&&t.attributes.embeds.forEach(function(e){t.unembed(graph.getCell(e))})})},commandManager.preview=function(){var e=[{viewId:$scope.selectedView.viewId}];window.open("../app-free-style/index.html#/topoview/index/"+encodeURIComponent(JSON.stringify(e)),"_blank")},commandManager.flip=function(){selectionView.model.models.forEach(function(e){var t=e.attributes.attrs;if(t.hasOwnProperty("image")){var o=t.image;if(o.hasOwnProperty("transform"))-1==o.transform.indexOf("scale(-1,1)")?e.attr("image/transform","scale(-1,1),translate(-"+o.width+",0)"):e.attr("image/transform","scale(1,1),translate(0,0)");else e.attr("image/transform","scale(-1,1),translate(-"+o.width+",0)")}})},commandManager.toJSON=function(){var e=_.uniqueId("json_output");window.open("",e,"menubar=no,location=no,resizable=yes,scrollbars=yes,status=no").document.write(JSON.stringify(graph.toJSON()))},commandManager.loadJSON=function(){BootstrapDialog.show({title:"导入组态内容",message:$('<textarea id="json4configer" class="form-control" placeholder="输入JSON"></textarea>'),buttons:[{label:"确认",cssClass:"btn-primary",hotkey:13,action:function(e){e.close();var t=document.getElementById("json4configer");if(t.value){var o=JSON.parse(t.value);graph.fromJSON(o)}}}]})},e.components.commander=commandManager)},function(e,t){$(".toolbar-container [data-tooltip]",t).each(function(){new joint.ui.Tooltip({target:$(this),content:$(this).data("tooltip"),top:".toolbar-container",direction:"top"})})},function(o,e){if("service"!=$routeParams.type)if($routeParams.viewId){o.data.viewRoutes=[],o.data.viewChange=function(e){for(var t in SwSocket.unregister(uuid),uuid=Math.uuid(),o.data.viewRoutes)o.data.viewRoutes[t].viewId==e.viewId&&o.data.viewRoutes.splice(t,o.data.viewRoutes.length-t);showViewContent(o,e.viewId)};var i=0,n=function(){3==i&&(0!=$routeParams.viewId?showViewContent(o,$routeParams.viewId):createConfigView(function(e){showViewContent(o,e)}))},a=$scope.$watch("rootModelDic",function(e,t){(e&&!t||t)&&(i++,n(),a())}),r=$scope.$watch("domainListTree",function(e,t){(e&&!t||t)&&(i++,n(),r())}),s=$scope.$watch("myOptionDic",function(e,t){(e&&!t||t)&&(i++,n(),s())})}else location.href="../app-oc/index.html#/index"},function(e,t){e.data.stencil&&e.data.stencil.shapes&&e.data.stencil.shapes.customer&&e.data.stencil.shapes.customer.forEach(function(e){(e.label||e.attrs.text&&e.attrs.text.text)&&(e.label||(e.label=e.attrs.text.text),$scope.alertIcons.push(e))})}],"service"==$routeParams.type){null==$scope.defer&&($scope.defer=$q.defer());var promise=$scope.defer.promise;$scope.initialization[9]=function(p,e){var n,u;$rootScope.dialogBox=void 0,p.open=!1,p.wholeClick=function(){p.open=!1},null==p.defer&&(p.defer=$q.defer());p.defer.promise;function a(t){var e={};for(var o in u)if("string"==typeof u[o].navigate&&""!=u[o].navigate){var i=u[o].navigate.split("/"),n={},a=n;for(var r in i)r<i.length-1?(a[i[r]]={},a=a[i[r]]):a[i[r]]={data:u[o]};e.$extension(n)}var s=u.find(function(e){return e.viewId==t});if(s){var c;e.traverse(function(e,t){if(t.data&&t.data.viewId&&s.viewId==t.data.viewId){c=t;var o=[];for(var i in t.parent)"data"!=i&&o.push(t.parent[i].data);p.lv1views=o}});var l,d=[];if(c){for(l=c.parent;l.parent;)d.push(l.data),l=l.parent;p.details=d}p.data.viewRoutes=[],p.data.viewChange=function(e){for(var t in SwSocket.unregister(uuid),uuid=Math.uuid(),p.data.viewRoutes)p.data.viewRoutes[t].viewId==e.viewId&&p.data.viewRoutes.splice(t,p.data.viewRoutes.length-t);showViewContent(p,e.viewId)},showViewContent(p,s.viewId)}else location.href="../app-sc/index_configure.html#/display/edit/service"}p.lv1viewsclick=function(e){p.open=!1,graph.attributes&&graph.attributes.cells&&graph.attributes.cells.models&&graph.attributes.cells.models.forEach(function(e){e.off("transition:end")}),timeout(function(){location.href="../app-sc/index_configure.html#/display/"+e.viewId+"/service"})},viewFlexService.getAllMyViews(function(e){if(0==e.code){n=e.data.find(function(e){return"confighome"==e.viewType}),e.data.filter(function(e){return"confighome"==e.viewType}).map(function(e){return e.viewId});var t=e.data.filter(function(e){return"configure"==e.viewType});u=t.map(function(e){var t;return null==(t=null!=e.content?JSON.parse(e.content):{}).level&&(t.level=1),{viewId:e.viewId,viewTitle:e.viewTitle,viewType:e.viewType,navigate:e.navigate,JSON:t}}),function(){{if(!$routeParams.viewId)return location.href="../app-sc/index_configure.html#/display/edit/service";if("all"==$routeParams.viewId)if(n){var t=JSON.parse(n.content).viewId,e=u.find(function(e){return e.viewId==t});!t||e?a(t):location.href="../app-sc/index_configure.html#/display/edit/service"}else delete $rootScope.dialogBox,location.href="../app-sc/index_configure.html#/display/edit/service";else if("edit"==$routeParams.viewId){var o;p.lv1views=u.filter(function(e){return 0<$$.switchToNumber(e.navigate)});var i=[{label:"确定",icon:"btn btn-success",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:n?(o=p.lv1views.find(function(e){return e.viewId==JSON.parse(n.content).viewId}),function(){var e=$rootScope.dialogBox.select.value.viewId,t={viewId:e},o={viewId:n.viewId,viewTitle:"confighome",viewType:"confighome",content:JSON.stringify(t)};viewFlexService.updateView(o,function(){delete $rootScope.dialogBox,location.href="../app-sc/index_configure.html#/display/all/service"})}):(o=p.lv1views[0],function(){var e=$rootScope.dialogBox.select.value.viewId,t={viewId:e},o={viewTitle:"confighome",viewType:"confighome",content:JSON.stringify(t)};viewFlexService.addView(o,function(){delete $rootScope.dialogBox,location.href="../app-sc/index_configure.html#/display/all/service"})})}];$rootScope.dialogBox={title:{label:"请选择服务中心默认视图"},description:{label:""},select:{label:"请选择展示页",value:o,options:p.lv1views},fnlist:i}}else a($routeParams.viewId)}}()}})}}}])});
//# sourceMappingURL=../../map/js/controllers/rappid-base-ctrl.js.map
