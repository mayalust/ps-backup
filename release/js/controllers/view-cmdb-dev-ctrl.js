define(["controllers/controllers","bootstrap-dialog"],function(e,w){"use strict";e.initController("ViewCmdbDevCtrl",["$scope","$q","FileUploader","$controller","$location","$routeParams","$timeout","kpiDataService","userLoginUIService","resourceUIService","alertService","customerProjectUIService","sparePartUIService","SwSocket","Info","viewFlexService","userUIService","unitService","growl","userDomainService","userEnterpriseService","faultKnowledgeUIService","$timeout","$route","configUIService",function(r,t,e,a,o,i,d,n,l,s,c,u,p,f,m,b,v,g,h,y,j,O,D,I,T){r.serviceOrigin=v.uploadFileUrl+"/api/rest/import/resourceUIService/importModel",r.fileFormat="xls、xlsx",r.fileMaxSize=10,a("AppUploadCtrl",{$scope:r,growl:h,FileUploader:e}),r.toggle=function(){$("#fileName").click()},r.uploadExcel=function(e){r.uploader.formData.push({config:"deviceModel"}),r.uploader.uploadAll(),r.loadingShow=!0},r.$on("uploadTemplate",function(e,t){0==t.response.code?(h.success("模板导入成功",{}),r.loadingShow=!1,E({})):r.loadingShow=!1}),r.uploader.onAfterAddingFile=function(e){r.uploader.queue.length>r.queueLimit&&r.uploader.removeFromQueue(0),r.uploadExcel()},r.selectObj="",r.writeXml=function(e){location.href=v.uploadFileUrl+"/api/rest/download/resourceUIService/getDeviceModel/"+encodeURI(encodeURI(e.label))+".xml/"+e.id+"/"};r.queryDitem={},r.modelAry=[],r.loaderValue="",r.modelType="",r.selectTr="0";for(var k=i.modelId,S=[],A=[],C=0;C<1;C++)A.push(t.defer());r.modelViewEdit=function(e){var t={modelId:e};window.open("../app-freeboard/index.html#/template/model/dashboard/"+JSON.stringify(t),"blank")},r.exportModel=function(){location.href=v.uploadFileUrl+"/api/rest/export/resourceUIService/exportModel/"+r.selectObj.id+".xlsx/"+r.selectObj.id+"/deviceModel/"},r.copyModel=function(e){r.selectTr&&0!=r.selectTr?(r.selectTr=0,h.info("复制模板处理中,请耐心等待...",{}),s.copyModelDefinition(e,function(e){0==e.code&&(r.modelAry.push(e.data),h.success("复制模板成功",{}),r.$broadcast("RESOURCE",{data:r.modelAry}))})):h.warning("请选择一个模板",{})};var E=function(e){s.getModelsByCondition(e,function(e){0==e.code&&(r.modelAry=e.data,k&&0<e.data.length&&(r.queryDitem.state=4,r.queryDitem.statelabel="模板名称",r.queryDitem.attributeName="label",r.loaderValue=e.data[0].label,k=""),r.$broadcast("RESOURCE",{data:r.modelAry}))})};r.goSearch=function(){var e={};0<r.queryDitem.state?e[r.queryDitem.attributeName]=r.loaderValue:k?e.id=k:e.label=r.loaderValue,E(e)},r.delMod=function(o,i){w.show({title:"提示",closable:!1,message:"确认删除设备模板吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){0<o.id&&(s.deleteModel(o.id,function(e){if(0==e.code){i(!0),h.success("删除成功");var t=r.modelAry;for(var a in t)t[a].id==o.id&&r.modelAry.splice(a,1);r.selectTr="0"}}),e.close())}},{label:"取消",action:function(e){e.close()}}]})},r.addMod=function(e){0==e?window.location.href="#/editModel/"+e:0<e?window.location.href="#/editModel/"+e:h.warning("操作异常")};var U=function(){for(var e in s.getAllModelType(function(e){0==e.code&&(r.modelType=e.data,A[0].resolve("success"))}),A)S.push(A[e].promise);t.all(S).then(function(e){r.goSearch()})};l.user.isAuthenticated?U():r.$on("loginStatusChanged",function(e,t){l.user.isAuthenticated&&U()})}]),e.initController("EditModelCtrl",["$scope","ngDialog","FileUploader","$controller","$location","$routeParams","$timeout","kpiDataService","userLoginUIService","resourceUIService","alertService","customerProjectUIService","sparePartUIService","SwSocket","Info","viewFlexService","userUIService","unitService","growl","userDomainService","userEnterpriseService","faultKnowledgeUIService","$timeout","$rootScope",function(u,i,e,t,a,o,r,d,n,p,l,s,c,f,m,b,v,g,h,y,j,O,D,I){u.tab="tab1",u.modelId=o.id,u.isLoading=!1,u.selectedDitem={id:0,label:"",modelNo:"",desc:"",series:""},u.model={},u.attrType=[],u.attrList=[],u.addAttributeType="attr",u.operateType="",u.attrTab="default",u.attrTypeSort=0,u.protocols=[],u.deleteAttrs=[],u.resolutionObj={},u.protocolStorage={},u.docError={name:"",conter:""};u.attrClick=function(e){e.name&&(u.attrTab=e.name,u.attrTypeSort=e.attrTypeSort)};u.attribute=function(e,t,a){if(u.addAttributeType=e,u.attrError.name="",u.attrError.prompt="",u.cityChang={province:"",city:"",district:""},"attr"==e&&"add"==t)u.addAttributeObj={id:0,label:"",name:"",modelId:u.modelId,attrType:u.attrTab,attrTypeSort:u.attrTypeSort,uid:0,sourceValue:"",canEdit:!0,dataType:"",delId:Math.uuid(),isEdit:3,values:{}};else if("attr"==e&&"up"==t){if("standardAddress"==a.dataType&&a.sourceValue){var o=a.sourceValue.split(",");o[0]&&null!=o[0]&&(u.cityChang.province=o[0]),o[1]&&null!=o[1]&&(u.cityChang.city=o[0]+","+o[1]),o[2]&&null!=o[2]&&(u.cityChang.district=o[0]+","+o[1]+","+o[2])}u.addAttributeObj=jQuery.extend(!0,{},a),u.addAttributeObj.isEdit=2}else"type"==e&&"up"==t?u.addAttributeObj={attrTypeName:a.name,updateTypeName:a.name,attrTypeSort:a.attrTypeSort,id:a.id,isEdit:2}:"type"==e&&"add"==t&&(u.addAttributeObj={attrTypeName:"",updateTypeName:"",attrTypeSort:u.attrType.length,isEdit:3});i.open({template:"../partials/dialogue/add_attribute.html",scope:u,className:"ngdialog-theme-plain"})};var T=function(e,t){return e.label=t.label,e.name=t.name,e.unit=t.unit,e.number=t.number?t.number:"",e.type=t.type?t.type:"kpi",e.range=t.range,e.icon=t.icon,e.compress=!!t.compress&&t.compress,e.compressTime=t.compressTime?t.compressTime:0,e.deadZone=!!t.deadZone&&t.deadZone,e.deadZoneRange=t.deadZoneRange?t.deadZoneRange:0,e.interval=!!t.interval&&t.interval,e.intervalTime=t.intervalTime?t.intervalTime:0,e};u.addDefaultData=function(e,t){u.isLoading=!1,u.select2Kpi=null,"add"==e?(u.addDataObj=T({type:"kpi"},{}),u.addDataObj.id=0,u.addDataObj.uid=0):u.addDataObj=jQuery.extend(!0,{},t),u.operateType="data",i.open({template:"../partials/dialogue/add_defaultdata.html",scope:u,className:"ngdialog-theme-plain"})},u.addData=function(e,t){u.isLoading=!1,u.select2Kpi=null,"add"==e?(u.addDataObj=T({},{}),u.addDataObj.id=0,u.addDataObj.uid=0):u.addDataObj=jQuery.extend(!0,{},t),u.operateType="data",i.open({template:"../partials/dialogue/add_data.html",scope:u,className:"ngdialog-theme-plain"})},u.saveDefaultKpis=function(e){var t=[];0==e?u.model.kpi.forEach(function(e){e.compress||e.interval||(e.compress=u.addDataObj.compress,e.compressTime=u.addDataObj.compressTime,e.deadZone=u.addDataObj.deadZone,e.deadZoneRange=u.addDataObj.deadZoneRange,e.interval=u.addDataObj.interval,e.intervalTime=u.addDataObj.intervalTime,t.push(e))}):1==e&&u.model.kpi.forEach(function(e){e.compress=u.addDataObj.compress,e.compressTime=u.addDataObj.compressTime,e.deadZone=u.addDataObj.deadZone,e.deadZoneRange=u.addDataObj.deadZoneRange,e.interval=u.addDataObj.interval,e.intervalTime=u.addDataObj.intervalTime,t.push(e)}),0<t.length?p.saveKpis(u.modelId,t,function(e){0==e.code&&(e.data&&(D(function(){u.$broadcast("KPI",u.model.kpi)}),h.success("成功应用",{})),u.closeDialog())}):(h.info("当前没有可以应用的数据项"),u.closeDialog())},u.saveKpis=function(e){if(e){var t=[],a=[];for(var o in e)for(var i in e[o])if(0<i){var r=T({id:0,uid:0},e[o][i]);r.label&&r.name&&r.unit&&r.number&&r.type?t.push(r):a.push(r)}0<t.length?(h.info("识别"+(t.length+a.length)+"条数据，成功"+t.length+"条，失败"+a.length+"条，开始导入识别成功数据！"),p.saveKpis(u.modelId,t,function(e){0==e.code&&(e.data?(e.data.successObj.forEach(function(e){u.model.kpi.push(e)}),D(function(){u.$broadcast("KPI",u.model.kpi)}),h.success("成功导入"+e.data.successObj.length+"条,失败"+e.data.failObj.length+"条",{})):h.warning("该导入数据出现问题，请刷新页面，查看是否导入成功"))})):h.warning("该导入数据无法识别")}},u.checkChang=function(){u.addDataObj.interval?u.addDataObj.intervalTime=1:u.addDataObj.intervalTime=0,0==u.addDataObj.compress&&(u.addDataObj.deadZoneRange=0,u.addDataObj.compressTime=0)},u.saveKpi=function(){u.isLoading=!0;u.model.kpi;p.saveKpi(u.modelId,u.addDataObj,function(e){if(u.isLoading=!1,0==e.code){if(u.addDataObj.id<=0||u.addDataObj.uid<=0)u.addDataObj.id=e.data.id,u.addDataObj.uid=e.data.uid,u.model.kpi.push(u.addDataObj);else for(var t in u.model.kpi)if(u.model.kpi[t].id==e.data.id){u.model.kpi[t]=e.data,u.model.kpi[t].index=u.addDataObj.index;break}u.tableSearchValue="",h.success("保存成功",{}),D(function(){u.$broadcast("KPI",u.model.kpi)}),u.closeDialog()}})},u.linkAge=function(t){u.defaultKpiLists=[],u.defaultKpiList.forEach(function(e){e.specialtyProp==t&&u.defaultKpiLists.push(e)})},u.select2Kpi={},u.selectChange=function(e){e&&(u.addDataObj.label=e.label,u.addDataObj.name=e.name,u.addDataObj.unit=e.unit,u.addDataObj.number=e.number?e.number:"",u.addDataObj.type=e.type?e.type:"kpi",u.addDataObj.range=e.range,u.addDataObj.icon=e.icon,u.addDataObj.id=e.id)},u.addProtocol=function(e,t){u.operateType="protocol","add"!=e?(u.protocolObj=jQuery.extend(!0,{},t),u.analysisChange()):u.protocolObj={id:0,modelId:u.modelId},u.expandObj={},u.initData(),i.open({template:"../partials/dialogue/add_protocol.html",scope:u,className:"ngdialog-theme-plain"})},u.saveProtocol=function(){for(var e in u.protocolObj.accessConfigs)u.protocolObj.accessConfigs[e].kpiId=u.protocolObj.accessConfigs[e].uid;p.saveModelConfig(u.protocolObj,function(e){if(0==e.code){if(u.protocolObj.id<=0)u.model.config.push(e.data);else for(var t in u.model.config)if(u.model.config[t].id==e.data.id){u.model.config[t]=e.data;break}h.success("保存成功",{}),u.closeDialog()}})},u.addCollection=function(e,t){u.directivesObj=null,u.taskObj="add"==e?{taskCode:"",description:"",taskCycle:"",cycleUnit:"",kpiDefinitionIds:[],isEdit:3,id:0}:jQuery.extend(!0,{},t),i.open({template:"../partials/dialogue/add_collection.html",scope:u,controller:"addCollectionCtrl",className:"ngdialog-theme-plain"})},u.addDirectives=function(e,t){u.taskObj=null,u.directivesObj="add"==e?{isEdit:3,name:"",description:"",commandCode:"",kpiDefinitionIds:[],commandType:"",values:{},id:0}:jQuery.extend(!0,{},t),i.open({template:"../partials/dialogue/add_directives.html",scope:u,controller:"addCollectionCtrl",className:"ngdialog-theme-plain"})},u.addDoc=function(){u.docUrl="api/rest/upload/resourceUIService/uploadModelFile",u.fileType=u.$parent.baseConfig.modelUploadConfig?u.$parent.baseConfig.modelUploadConfig.fileType:"",u.docError.name="",u.docError.conter="",u.uploadParam={modelId:"",name:"",type:"",url:"",description:"",postfix:"",size:""},i.open({template:"../partials/dialogue/add_doc.html",scope:u,controller:"addDocCtrl",className:"ngdialog-theme-plain"})};var k=function(){p.getAttrsByModelId(u.modelId,function(e){if(0==e.code){u.model.attrs=e.data,I.rootModelsDic[u.modelId]||(I.rootModelsDic[u.modelId]={}),I.rootModelsDic[u.modelId].attrs=e.data;var t=e.data,a=[],o=[];for(var i in t){var r=t[i],d={name:"",id:"",attrTypeSort:"",arr:[]},n=-1;if("default"==r.attrType&&0<o.length)n=i,o[0].arr.push(r);else for(var l in a)if(a[l].name==r.attrType){a[n=l].arr.push(r);break}-1==n&&(d.name=r.attrType,d.id=r.id,d.arr.push(r),"default"==r.attrType?(d.attrTypeSort=0,o.push(d)):(d.attrTypeSort=r.attrTypeSort,a.push(d)))}var s=o.concat(a);s.sort(doubleCompare(["attrTypeSort",""],"")),u.attrType=s}})};u.downClick=function(e){var t=v.uploadFileUrl+e;window.open(t)},u.modelType=[],u.modelTypeObj={},u.getAllModelType=function(){p.getAllModelType(function(e){if(0==e.code)for(var t in u.modelType=e.data,e.data)u.modelTypeObj[""+e.data[t].valueCode]=e.data[t]})};var S=function(e){var t,a,o=u.attrType,i=[];for(var r in o)if(0<o[r].arr.length){var d=o[r].arr;for(var n in d)0<d[n].isEdit&&(3==d[n].isEdit&&(d[n].id=0),d[n].modelId=e.id,d[n].attrType=o[r].name,d[n].isEdit="0",i.push(d[n]))}t=e,0<(a=i).length&&p.saveAttrs(a,function(e){0==e.code&&(u.modelId<=0?(u.modelId=t.id,U()):k())})};u.deleteAction=function(e,n,a){if("attr"==e)if(3==n.isEdit){var t=u.attrType;for(var o in t)if(t[o].name==u.attrTab){var i=t[o].arr;for(var r in i)if(i[r].delId==n.delId){i.splice(r,1);break}}var d=u.model.attrs;for(var l in d)if(d[l].delId==n.delId){d.splice(l,1);break}}else w.show({title:"提示",closable:!1,message:"确认删除属性吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){var t=u.attrType;for(var a in t)if(t[a].name==u.attrTab){var o=t[a].arr;for(var i in o)if(o[i].id==n.id){u.deleteAttrs.push(o[i].uid),o.splice(i,1);break}}var r=u.model.attrs;if(0<n.uid)for(var d in r)if(r[d].uid==n.uid){r.splice(d,1);break}h.success("删除成功",{}),h.info("请点击“保存模板”按钮，以便对修改的内容进行保存！",{}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("kpi"==e)w.show({title:"提示",closable:!1,message:"确认删除数据项吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){p.deleteKpi(u.modelId,n.id,function(e){if(0==e.code){for(var t in u.model.kpi)if(n.id==u.model.kpi[t].id){u.model.kpi.splice(t,1);break}a(!0),h.success("删除成功",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("dir"==e)w.show({title:"提示",closable:!1,message:"确认删除指令吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){p.deleteDirective(u.modelId,n.id,function(e){if(0==e.code){for(var t in u.model.directives)if(n.id==u.model.directives[t].id){u.model.directives.splice(t,1);break}h.success("删除成功",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("protocol"==e)w.show({title:"提示",closable:!1,message:"确认删除协议吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){p.deleteModelConfig(n.id,function(e){if(0==e.code){for(var t in u.model.config)if(n.id==u.model.config[t].id){u.model.config.splice(t,1);break}h.success("删除成功",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("task"==e)w.show({title:"提示",closable:!1,message:"确认删除数据项吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){p.deleteCollectionTaskDefinitionByModelId(u.modelId,n.id,function(e){if(0==e.code){for(var t in u.model.taskData)if(n.id==u.model.taskData[t].id){u.model.taskData.splice(t,1);break}h.success("删除成功",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("doc"==e)w.show({title:"提示",closable:!1,message:"确认删除文档吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){p.deleteModelFile(n,function(e){if(0==e.code){for(var t in u.model.docData)if(n.id==u.model.docData[t].id){u.model.docData.splice(t,1);break}h.success("删除成功",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("assortment"==e){var s=n.name,c=u.attrType;if(0<n.arr.length)w.show({title:"提示",closable:!1,message:'"'+s+'" 分类下面有子属性确认删除吗？',buttons:[{label:"确定",cssClass:"btn-success",action:function(e){for(var t in c)if(c[t].name==s){var a=c[t].arr;for(var o in a)0<a[o].id&&u.deleteAttrs.push(a[o].uid);u.attrType.splice(t,1);break}u.attrTab="default",u.attrTypeSort=0,h.success("删除成功",{}),h.info("请点击“保存模板”按钮，以便对修改的内容进行保存！",{}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else for(var o in c)if(c[o].name==s){u.attrType.splice(o,1);break}}},u.UploadFile=function(){var e=u.model.docData;for(var t in e)if(e[t].name==u.uploadParam.name)return u.docError.name="name",void(u.docError.conter="文档名称已存在");u.formObj={modelId:u.modelId,name:encodeURIComponent(u.uploadParam.name),description:encodeURIComponent(u.uploadParam.description)},u.$broadcast("UploadFile1")},u.successDoc=function(e){var t=escape(decodeURIComponent(e.name));e.name=t,e.description=escape(decodeURIComponent(e.description)),u.model.docData.push(e)};var A=function(){0<u.modelId?p.updateModel(u.selectedDitem,function(e){0==e.code&&(S(e.data),h.success("保存成功",{}),C())}):p.addModel(u.selectedDitem,function(e){0==e.code&&(h.success("保存成功",{}),S(e.data))})},C=function(){0<u.deleteAttrs.length&&p.deleteAttrs(u.deleteAttrs,function(e){0==e.code&&(u.deleteAttrs=[])})};u.saveModel=function(){if(""!=$.trim(u.selectedDitem.label)&&null!=u.selectedDitem.label){for(var e in u.attrType)if(u.attrType[e].arr.length<=0)return void w.show({title:"提示",closable:!1,message:"存在没有配置属性信息的属性分类，空的属性分类系统将不会保存，确认保存吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){A(),e.close()}},{label:"取消",action:function(e){e.close()}}]});A()}else h.warning("模板名称不能为空",{})};u.dataTypeObj={};u.resolutionProtocol=function(t,a){""!=u.resolutionObj[t]&&null!=u.resolutionObj[t]||p.getAllResolutionProtocol(t,function(e){if(0==e.code)return u.resolutionObj[t]=e.data,void(a&&a())})},u.attrError={name:"",prompt:""},u.saveType=function(){var e=u.addAttributeObj.attrTypeName,t=u.addAttributeObj.updateTypeName,a=u.addAttributeObj.isEdit,o=u.addAttributeObj.id,i=u.addAttributeObj.attrTypeSort,r=u.attrType;if(u.attrTab=e,u.attrTypeSort=i,"default"==e||"基础属性"==e)return u.attrError.name="type",void(u.attrError.prompt="系统分类不能创建");if(3==a){var d={name:"",id:"",attrTypeSort:"",arr:[]};for(var n in r)if(r[n].name==e)return u.attrError.name="type",void(u.attrError.prompt="分类名称已存在");d.name=e,d.attrTypeSort=i,d.id=""+Math.uuid(),u.attrType.push(d)}else if(2==a){for(var n in r)if(r[n].id!=o&&r[n].name==e)return u.attrError.name="type",void(u.attrError.prompt="分类名称已存在");for(var l in r)if(r[l].name==t){r[l].name=e;var s=r[l].arr;if(0<s.length){for(var c in s)0<s[c].id&&(s[c].attrType=e,s[c].attrTypeSort=i,s[c].isEdit=2);break}r[l].attrType=e,r[l].attrTypeSort=i,r[l].isEdit=2}}h.info("请点击“保存模板”按钮，以便对修改的内容进行保存！",{}),u.closeDialog()},u.saveAttrs=function(){if(""==$.trim(u.addAttributeObj.name)||null==u.addAttributeObj.name)return u.attrError.name="name",void(u.attrError.prompt="属性名称不能为空");if(""==$.trim(u.addAttributeObj.label)||null==u.addAttributeObj.label)return u.attrError.name="label",void(u.attrError.prompt="显示名称不能为空");var e=u.model.attrs;for(var t in e)if(0<u.addAttributeObj.id){if(e[t].id!=u.addAttributeObj.id&&e[t].name==u.addAttributeObj.name)return void h.warning("属性名称已存在",{});if(e[t].id!=u.addAttributeObj.id&&e[t].label==u.addAttributeObj.label)return void h.warning("显示名称已存在",{});if(e[t].id==u.addAttributeObj.id){e[t]=u.addAttributeObj;break}}else{if(e[t].delId!=u.addAttributeObj.delId&&e[t].name==u.addAttributeObj.name)return void h.warning("属性名称已存在",{});if(e[t].delId!=u.addAttributeObj.delId&&e[t].label==u.addAttributeObj.label)return void h.warning("显示名称已存在",{});if(e[t].delId==u.addAttributeObj.delId){e[t]=u.addAttributeObj;break}}if("standardAddress"==u.addAttributeObj.dataType&&(u.addAttributeObj.sourceValue="",u.cityChang.district?u.addAttributeObj.sourceValue=u.cityChang.district:u.cityChang.city?u.addAttributeObj.sourceValue=u.cityChang.city:u.addAttributeObj.sourceValue=u.cityChang.province),3==u.addAttributeObj.isEdit){var a=u.attrType;for(var o in a)if(a[o].name==u.addAttributeObj.attrType){a[o].arr.push(u.addAttributeObj),u.model.attrs.push(u.addAttributeObj);break}}else{a=u.attrType;for(var i in a)if(a[i].name==u.addAttributeObj.attrType){var r=a[i].arr;for(var t in r)if(r[t].id==u.addAttributeObj.id){r[t]=u.addAttributeObj;break}}}h.info("请点击“保存模板”按钮，以便对修改的内容进行保存！",{}),u.closeDialog()};var E=function(e,t){e.kpiId=e.id,e.kpiName=e.name,e.dataTypeId=t.dataTypeId,e.registers=t.registers,e.config=t.config,e.readExpression=t.readExpression,e.writeExpression=t.writeExpression,e.serialNumStatus=!1,e.config.startPoint=t.startPoint,e.config.length=t.length,e.config.mainAddr=t.mainAddr,e.config.subAddr=t.subAddr,e.config.bdAddr=t.bdAddr,e.config.scale=t.scale,e.config.option=!1};u.regsKpiList={},u.func=function(e){return e.name==u.attrTab},u.dataByte=function(e){var t=!1,a=u.allDataTypes,o={};for(var i in a)if(a[i].id==e.dataTypeId){o=a[i];break}if(-1!=$.inArray(o.name,["单精度浮点","双精度浮点","ubytef","bytef","ushortf","shortf","uintf","intf","ulongf","longf"])&&(t=!0),u.expandObj[e.kpiId]?u.expandObj[e.kpiId].serialNumStatus=t:(e.serialNumStatus=t,u.expandObj[e.kpiId]=e),"flexem"==u.protocolObj.accessProtocol&&u.protocolObj.analysisProtocol){var r=function(e,t){var a=u.resolutionProtocolDic[u.protocolObj.analysisProtocol].regs,o=[];for(var i in a)0<=$.inArray(a[i].extAttributes.ioWidth,e)&&o.push(a[i]);u.regsKpiList[t.kpiId]=o};switch(e.kpiRegisters=[],o.byteSize){case 1:r([0],e);break;case 2:r([2],e);break;case 4:r([2,4],e);break;case 8:r([2,4,8],e);break;default:u.regsKpiList[e.kpiId]=[]}}},u.reg=function(t,e){u.protocolObj.resolutionProtocol&&u.protocolObj.resolutionProtocol.regs.forEach(function(e){if(t.registers==e.label)return t.kpiRegisters=e.attributes,!0})},u.analysisChange=function(){if(u.protocolObj.id<=0){u.errorPoint={};var e=u.model.config;for(var t in e)if(u.protocolObj.analysisProtocol&&e[t].accessProtocol==u.protocolObj.accessProtocol&&e[t].analysisProtocol==u.protocolObj.analysisProtocol)return u.errorPoint.name="analysisProtocol",void(u.errorPoint.content="解析协议已存在")}},u.expandObj={},u.optionExpand=function(e){u.expandObj[e.kpiId]?1==u.expandObj[e.kpiId].option?u.expandObj[e.kpiId].option=!1:u.expandObj[e.kpiId].option=!0:(e.option=!0,u.expandObj[e.kpiId]=e)},u.initData=function(){var e=u.model.kpi,o=[];e.forEach(function(e){var t=jQuery.extend(!0,{},e);if(u.protocolObj.accessConfigs){var a=!1;u.protocolObj.accessConfigs.forEach(function(e){if(t.id==e.kpiId)return a=!0,e.kpiName=t.name,u.protocolObj.id<=0?(e.dataTypeId="",e.registers="",e.option=!1,e.kpiRegisters=[]):("modbus"==u.protocolObj.accessProtocol&&(e.registers=parseInt(e.registers)),e.config&&null!=e.config.scale&&null!=e.config.scale&&(e.config.scale=parseInt(e.config.scale))),o.push(e),!0}),a||(E(t,{config:{}}),o.push(t))}else E(t,{config:{}}),o.push(t)}),u.protocolObj.accessConfigs=o};var U=function(){var a;p.getAllModelType(function(e){0==e.code&&(u.model.modelType=e.data)}),a=function(){var e=u.myDicts.DataType,t=u.myDicts.specialtyProps;for(var a in e)u.dataTypeObj[e[a].valueCode]=e[a];if(t&&0<t.length){u.baseConfig.specialtyProps.split(",");var o=[],i={};for(var a in t)o.push({value:t[a].valueCode,label:t[a].label}),i[t[a].valueCode]=t[a].label;u.specialtyProps=o,u.specialtyPropsDic=i}},u.myDicts?a():u.$watch("myDicts",function(e,t){e&&a()}),u.getAllModelType(),0<u.modelId?(p.getModelByIds([u.modelId],function(e){0==e.code&&(u.selectedDitem=e.data[0])}),k(),p.getDataItemsByModelId(u.modelId,function(e){if(0==e.code){var t=[];for(var a in e.data)e.data[a].type&&t.push(e.data[a]);u.model.kpi=t}}),p.getAllCollectionPlugins(function(e){var t={};0==e.code&&(e.data.forEach(function(e){t[e.protocol]||(t[e.protocol]=e,u.protocols.push(e))}),u.protocolVersions=e.data)}),p.getAllResolutionProtocol("",function(e){0==e.code&&(u.resolutionProtocolDic={},e.data.forEach(function(e){u.resolutionProtocolDic[e.label]=e}),u.resolutionProtocols=e.data)}),p.getModelConfigByModelId(u.modelId,function(e){0==e.code&&(e.data?(e.data,u.model.config=e.data):u.model.config=[])}),p.findCollectionTaskDefinitionByModelId(u.modelId,function(e){0==e.code&&(u.model.taskData=e.data)}),p.getDirectivesByModelIdNotByRole(u.modelId,function(e){0==e.code&&(e.data.sort(doubleCompare(["values","index"],"desc")),u.model.directives=e.data)}),p.getUploadModelFileList(u.modelId,function(e){if(0==e.code){var t=[];if(0<e.data.length)for(var a in e.data){var o=escape(decodeURIComponent(e.data[a].name));e.data[a].name=o;var i=escape(decodeURIComponent(e.data[a].description));e.data[a].description=i,t.push(e.data[a])}u.model.docData=t}})):p.getdefaultAttrs(function(e){if(0==e.code){u.model.attrs=e.data;var t=[],a=e.data;for(var o in a){var i=a[o],r={name:"",id:"",arr:[]},d=-1;for(var n in t)if(t[n].name==i.attrType){d=n,i.isEdit=2,i.uid=0,t[n].arr.push(i);break}-1==d&&(r.name=i.attrType,i.isEdit=2,i.uid=0,r.arr.push(i),t.push(r))}u.attrType=t}}),$('#deploy a[data-toggle="tab"]').on("shown.bs.tab",function(e){if(0<$(e.target).closest("li.disabled").length)return $(e.target).closest("li.disabled").removeClass("active"),void $(e.target).closest("ul").children("[name="+u.tab+"]").addClass("active");var t=$(e.target).closest("li").attr("name");"tab2"==t&&0<u.model.kpi.length&&D(function(){u.$broadcast("KPI",u.model.kpi)}),t&&(u.tab=t,u.$apply())})};n.user.isAuthenticated?U():u.$on("loginStatusChanged",function(e,t){n.user.isAuthenticated&&U()})}]),e.initController("addCollectionCtrl",["$scope","ngDialog","FileUploader","$location","$routeParams","$timeout","kpiDataService","userLoginUIService","resourceUIService","alertService","customerProjectUIService","sparePartUIService","SwSocket","Info","viewFlexService","userUIService","unitService","growl","userDomainService","userEnterpriseService","faultKnowledgeUIService","solutionUIService","$route",function(i,e,t,a,o,r,d,n,l,s,c,u,p,f,m,b,v,g,h,y,j,O,D){i.selectData={optional:"",noOptional:""},i.dirError={name:"",txt:""};var I=jQuery.extend(!0,[],i.model.kpi);i.selectValueLeft=[],i.selectValueRight=[];var T=[];if(i.directivesObj&&0<i.directivesObj.id?T=i.directivesObj.kpiDefinitionIds:i.taskObj&&0<i.taskObj.id&&(T=i.taskObj.kpiDefinitionIds),0<T.length){for(var k=0;k<T.length;k++){for(var S=-1,A=0;A<I.length;A++)if(I[A].uid==T[k]){S=A;break}-1<S&&i.selectValueRight.push(I.splice(S,1)[0])}i.selectValueLeft=I}else i.selectValueLeft=I;var C=function(e){l.saveCollectionTaskDefinitionByModelId(i.modelId,[e],function(e){if("0"==e.code&&0<i.taskObj.id){for(var t in i.model.taskData)if(i.model.taskData[t].id==e.data[0].id){i.model.taskData[t]=e.data[0];break}g.success("修改成功",{})}i.closeDialog()})};i.clearError=function(){i.dirError.name="",i.dirError.txt=""},i.saveCollection=function(){var e=i.model.taskData;for(var t in e)if(e[t].taskCode==i.taskObj.taskCode&&i.taskObj.id!=e[t].id)return void g.warning("分组编码不能重复",{});if(0<i.taskObj.id){if(0<i.selectValueRight.length){var a=[];$("#valueRight option").each(function(){var e=$(this).val();a.push(e)}),i.taskObj.kpiDefinitionIds=a,C(i.taskObj)}}else l.addCollectionTaskDefinitionByModelId(i.modelId,i.taskObj,function(e){if("0"==e.code){if(g.success("保存成功",{}),i.model.taskData.push(e.data),0<i.selectValueRight.length){var t=[];$("#valueRight option").each(function(){var e=$(this).val();t.push(e)}),e.data.kpiDefinitionIds=t,C(e.data)}i.closeDialog()}})},i.saveDirectives=function(){var e=i.model.directives;for(var t in e){if(e[t].commandCode==i.directivesObj.commandCode&&i.directivesObj.id!=e[t].id)return void g.warning("指令编码不能重复",{});if(e[t].name==i.directivesObj.name&&i.directivesObj.id!=e[t].id)return void g.warning("指令名称不能重复",{})}var a=[];0<i.selectValueRight.length&&$("#valueRight option").each(function(){var e=$(this).val();a.push(e)}),i.directivesObj.kpiDefinitionIds=a,l.saveDirective(i.modelId,i.directivesObj,function(e){if("0"==e.code){if(g.success("保存成功",{}),i.directivesObj.id<=0)i.model.directives.push(e.data);else for(var t in i.model.directives)if(i.model.directives[t].id==e.data.id){i.model.directives[t]=e.data;break}i.model.directives.sort(doubleCompare(["values","index"],"desc")),i.isLoading=!0,i.closeDialog()}})},i.selectRight=function(){if(i.selectData.optional&&0<i.selectData.optional.length){var e=i.selectData.optional,t=i.selectValueLeft;for(var a in e)for(var o in t)if(e[a]==t[o].id){i.selectValueRight.push(t[o]),i.selectValueLeft.splice(o,1);break}}},i.selectLeft=function(){if(i.selectData.noOptional&&0<i.selectData.noOptional.length){var e=i.selectValueRight,t=i.selectData.noOptional;for(var a in t)for(var o in e)if(t[a]==e[o].uid){i.selectValueLeft.push(e[o]),i.selectValueRight.splice(o,1);break}}},i.leftUp=function(){var e=$("#valueRight option").index($("#valueRight option:selected:first")),t=$("#valueRight option:eq("+(e-1)+")");if(0<e){var a=$("#valueRight option:selected").remove();setTimeout(function(){t.before(a)},10)}},i.leftDown=function(){var e=$("#valueRight option").index($("#valueRight option:selected:last")),t=$("#valueRight option").length-1,a=$("#valueRight option:eq("+(e+1)+")");if(e<t){var o=$("#valueRight option:selected").remove();setTimeout(function(){a.after(o)},10)}}}]),e.initController("addDocCtrl",["$scope","FileUploader","$location","$routeParams","$timeout","kpiDataService","userLoginUIService","resourceUIService","alertService","sparePartUIService","SwSocket","Info","viewFlexService","userUIService","unitService","growl","userDomainService","userEnterpriseService","solutionUIService","$route",function(i,e,t,a,o,r,d,n,l,s,c,u,p,f,m,b,v,g,h,y){var j=i.uploader=new e({url:f.uploadFileUrl+"/"+i.docUrl,withCredentials:!0,queueLimit:1,removeAfterUpload:!1});j.filters.push({name:"fileFilter",fn:function(e,t){var a=e.name.split("."),o=(a[a.length-1],i.$parent.$parent.baseConfig.modelUploadConfig&&i.$parent.$parent.baseConfig.modelUploadConfig.fileSize?i.$parent.$parent.baseConfig.modelUploadConfig.fileSize:5);return e.size/1024>1024*o?(i.docError.name="error",i.docError.conter="您选择的文件大于"+o+"M，请重新选择",!1):(i.docError.name="",i.docError.conter="",i.uploadParam.url=e.name,!0)}}),j.onAfterAddingFile=function(e){console.info("onAfterAddingFile",e.name)},j.onWhenAddingFileFailed=function(e,t,a){j.clearQueue(),j.destroy(),i.uploadParam.url=e.name,console.info("onWhenAddingFileFailed",e.name)},j.onBeforeUploadItem=function(e){Array.prototype.push.apply(e.formData,j.formData),console.info("onBeforeUploadItem",e)},i.clearItems=function(){j.clearQueue()},j.onSuccessItem=function(e,t,a,o){0==t.code?(j.clearQueue(),j.destroy(),i.successDoc(t.data),j.formData=[],b.success("上传文件成功",{}),i.isLoading=!1,i.closeDialog()):(b.error(t.message,{}),i.isLoading=!1)},i.nameChange=function(){i.docError.name="",i.docError.conter=""},j.onErrorItem=function(e,t,a,o){b.warning("上传文件失败",{}),i.isLoading=!1,console.info("onErrorItem",e,t,a,o)},i.$on("UploadFile1",function(e,t){if(!j.queue||0==j.queue.length)return i.docError.name="error",void(i.docError.conter="请选择一个文件");i.isLoading=!0,j.formData.push(i.formObj),j.uploadAll()})}])});
//# sourceMappingURL=../../map/js/controllers/view-cmdb-dev-ctrl.js.map
