define(["controllers/controllers"],function(e){"use strict";e.initController("ViewChartsCtrl",["$scope","$timeout","kpiDataService","SwSocket","Info","resourceUIService","$q",function(m,n,k,C,e,p,i){var O;console.info("ViewChartsCtrl被触发");var I,b,x,N,P,S,w,D=e.get("../localdb/echarts-chart.json",function(e){O=e.option}),$=[],l=0,G=[],d=0,a=0,L=function(e){if(!e.data.instance&&-1<r(e.data.nodeId,e.data.kpiCode)){0==a&&(a=S.data.recordList.length);var i=(S=k.mergeKpiHandler(e.data,w,S)).data.recordList[S.data.recordList.length-1];if(S.data.recordList.length==a)P.series.forEach(function(e){e.data.pop(),e.data.push(i[e.filedName])});else{if(a++,P.xAxis){var t=P.xAxis[0];t.data.length>=d&&t.data.shift(),t.data.push(newDateJson(i.arisingTime).Format(GetDateCategoryStrByLabel(N.value)))}P.series.forEach(function(e){e.data.length>=d&&e.data.shift(),e.data.push(i[e.filedName])})}m.$broadcast("OptionStatusChange",{name:m.$parent.view?m.$parent.view.echartViewId:null,option:P})}},r=function(e,i){for(var t=0;t<P.series.length;t++)if(P.series[t].filedName==e+"?"+i)return t;return 0},u=function(o,n){p.getKpisByModelId(o.id,function(e){if(0==e.code){o.kpis=e.data;var i=/\{|\[.*\}|\]/;for(var t in o.kpis){if(o.kpis[t].range){var a=[];if(r=i.test(o.kpis[t].range))try{a=r?JSON.parse(o.kpis[t].range):[]}catch(e){}(o.kpis[t].rangeAry=a)instanceof Array?2==(o.kpis[t].rangeAry=a).length&&(o.kpis[t].min=a[0],o.kpis[t].max=a[1]):a instanceof Object&&(o.kpis[t].rangeObj=a)}if(o.kpis[t].displayParam){var r,s={};(r=i.test(o.kpis[t].displayParam))&&(s=JSON.parse(o.kpis[t].displayParam)),o.kpis[t].displayParamObj=s}p.kpisDic[o.id+"??"+o.kpis[t].id]=o.kpis[t],p.kpisDic[o.kpis[t].id]=o.kpis[t]}n&&n(o)}})},t=function(y){y||(I=Math.uuid());var h=!0,e=!1,v=b.theme?b.theme:"macarons";if(b.hasOwnProperty("option")){if(b.hasOwnProperty("timespan")){$=b.kpis;var i=!0;for(var t in b.nodes){for(var a in k.cilistByModelId)if(b.nodes[t]==k.cilistByModelId[a].id){i=!1;break}if(i&&k.cilistByModelId&&0<k.cilistByModelId.length)for(a=0;a<b.nodes.length;a++)k.cilistByModelId[a]&&b.modelId==k.cilistByModelId[a].modelId?G.push(k.cilistByModelId[a].id):G=b.nodes;else G=b.nodes;break}l=b.timespan,"line"==b.type||"bar"==b.type?x="time":"pie"!=b.type&&"gauge"!=b.type||(x="time",l=0),N={value:""},b.formatStr&&(N.value=b.formatStr)}else e=!0;h=!1}else if(b.hasOwnProperty("isGroup")&&b.isGroup)for(var a in b.children){var r=b.children[a];if($.push.apply($,k.getKpisInfo(r)[0]),0==a){x=r.dataSource.filters.category;var s=k.getNodesInfo(r);G=s[0],l=s[1]}}else{N=k.getChartProperty(b,"categoryAxisFormatStr"),x=b.dataSource.filters.category,"LineChart"==b.type&&k.getChartProperty(b,"graphLineColors").value.split(",");s=k.getKpisInfo(b);$=s[0],s[1];s=k.getNodesInfo(b);G=s[0],l=s[1]}if(e)n(function(){m.$broadcast(Event.ECHARTINFOSINIT,{theme:v,option:b.option})});else{w={category:x,isRealTimeData:!0,timePeriod:l,nodeIds:G,kpiCodes:$,kpisDic:{minTimespan:0}};S=null;var o=function(e){if(0==e.code){var i;if(S=e,h)if((P=jQuery.extend(!0,{},O)).legend.data=[],P.xAxis=[],P.series=[],b.hasOwnProperty("isGroup")&&b.isGroup)P.title.text="",P.title.subtext="","PieChart"==b.type?(P.tooltip=D.pieOption.tooltip,P.toolbox=D.pieOption.toolbox,D.pieOption.series=[]):"GaugeChart"==b.type&&(P.tooltip=D.gaugeOption.tooltip,D.gaugeOption.series=[]);else{var t=k.getChartProperty(b,"title");P.title.text=t.value,P.title.subtext="","PieChart"==b.type?(P.tooltip=D.pieOption.tooltip,P.toolbox=D.pieOption.toolbox,D.pieOption.series[0].data=[]):"GaugeChart"==b.type&&(P.tooltip=D.gaugeOption.tooltip,D.gaugeOption.series[0].data=[])}else O=b.option,(P=jQuery.extend(!0,{},O)).legend&&(P.legend.data=[]),P.xAxis=[],P.series=[];for(var a in w.nodeIds){var r=w.nodesDic[w.nodeIds[a]];for(var s in w.kpiCodes){var o=w.kpisDic[w.kpiCodes[s]];if(P.legend){if(!(r&&o&&r.hasOwnProperty("label")&&o.hasOwnProperty("label")))continue;P.legend.data.push(r.label+":"+o.label)}if("pie"==b.type||"gauge"==b.type){0==P.series.length&&(P.series.push(jQuery.extend(!0,{},O.series[0])),P.series[0].data=[]);var n={};n.name=r.label+":"+o.label,n.filedName=w.nodeIds[a]+"?"+w.kpiCodes[s],n.value,P.series[0].data.push(n)}else if("GaugeChart"==b.type){D.gaugeOption.series[0].name=filedNameAry[0];var p={};p.name=r.label+":"+o.label,p.filedName=w.nodeIds[a]+"?"+w.kpiCodes[s],p.value="",D.gaugeOption.series[0].data.push(p)}else if("line"==b.type||"bar"==b.type){for(var l in O.series)if(-1<(f=jQuery.extend(!0,{},O.series[l])).name.indexOf(o.label))break;f&&(f.data=[],f.name=r.label+":"+o.label,f.filedName=w.nodeIds[a]+"?"+w.kpiCodes[s],P.series.push(f))}}}for(var a in"LineChart"!=b.type&&"line"!=b.type&&"bar"!=b.type||((i=jQuery.extend(!0,{},O.xAxis[0])).data=[]),S.data.recordList){var d=S.data.recordList[a];if(b.hasOwnProperty("isGroup")&&b.isGroup){if("GaugeChart"==b.type)for(var s in D.gaugeOption.series){(f=D.gaugeOption.series[s]).data[0].value=d[f.data[0].filedName]}}else if("PieChart"==b.type)for(var s in D.pieOption.series[0].data){(f=D.pieOption.series[0].data[s]).value=d[f.filedName]}else if("pie"==b.type||"gauge"==b.type)for(var s in P.series[0].data){(f=P.series[0].data[s]).value=d[f.filedName]}else if("GaugeChart"==b.type)for(var s in D.gaugeOption.series[0].data){(f=D.gaugeOption.series[0].data[s]).value=d[f.filedName]}else if("LineChart"==b.type||"line"==b.type||"bar"==b.type)for(var s in P.series){if((f=P.series[s]).data.push(d[f.filedName]),0==s){var u=d[w.category];"time"==x&&(u=newDateJson(u).Format(GetDateCategoryStrByLabel(N.value))),i.data.push(u)}}}if("GaugeChart"==b.type)for(var a in D.gaugeOption.series){var f=D.gaugeOption.series[a];P.series.push(f)}else"pie"==b.type||"gauge"==b.type||("PieChart"==b.type?(f=jQuery.extend(!0,{},D.pieOption.series[0]),P.series.push(f)):"LineChart"!=b.type&&"line"!=b.type&&"bar"!=b.type||P.xAxis.push(i));if(null==P.series||null==P.series[0]||0==P.series[0].data.length)return;m.$broadcast(Event.ECHARTINFOSINIT,{name:m.$parent.view?m.$parent.view.echartViewId:null,theme:v,option:P}),console.info("在Controller中获得echarts的option");var c={ciid:G.toString(),kpi:$.toString()};if(!y){var g="register";C.register(I,g,L),C.send(I,g,"kpi",c)}}};p.getResourceByIds(G,function(e){for(var i in w.nodesDic=e,w.nodesDic)u({id:w.nodesDic[i].modelId},function(e){var i,t=-1;$.forEach(function(e){var i=p.kpisDic[e];i&&(w.kpisDic[e]=i,-1==t&&(t=p.getMSvalue(0,i),d=Math.ceil(w.timePeriod/t)))}),-1<t&&(w.kpisDic.minTimespan=t,i=["kpi",w],k.getKpiValueList(i,function(e){O?o(e):n(function(){o(e)})}))})})}};(b=m.echartItem?m.echartItem:m.$parent.item?m.$parent.item:null)&&t(),m.$on("itemChanger",function(e,i){i.id==b.id&&(b=i,t(!0))}),m.$on("$destroy",function(){C.unregister(I)})}])});
//# sourceMappingURL=../../map/js/controllers/view-chart-ctrl.js.map
