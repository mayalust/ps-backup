define(["directives/directives","echarts","jquery-ui","macarons","bmap"],function(directives,echarts){"use strict";var dragging=!1;function editBtn_directive(r,a,n){var e={restrict:"A",scope:{dashboard:"="},link:function(e,t,i){r(function(){"edit"==n.current.params.mode?($("#leftPart").addClass("open"),$("#rightPart").addClass("fold"),e.dashboard.mode="editmode"):($("#leftPart").removeClass("open"),$("#rightPart").removeClass("fold"),e.dashboard.mode="viewmode")}),$(t).on("click",function(){e.$apply(function(){$("body");e.dashboard.callback&&e.dashboard.callback(),e.dashboard.mode==a._EDITMODE_?($("#leftPart").removeClass("open"),$("#rightPart").removeClass("fold"),e.dashboard.mode=a._VIEWMODE_):($("#leftPart").addClass("open"),$("#rightPart").addClass("fold"),e.dashboard.mode=a._EDITMODE_)})})}};return e}function colorSelector_directive(t,e){var i={restrict:"A",scope:{bgcolor:"="},link:function(n,o,e){t(function(){var e=["bg-red","bg-yellow","bg-aqua","bg-blue","bg-light-blue","bg-green","bg-navy","bg-teal","bg-olive","bg-lime","bg-orange","bg-fuchsia","bg-purple","bg-maroon","bg-white","bg-black"],i=$("<div class='selWrap' id='colorSelector'></div>");for(var t in $(o).on("click.cs",r),e)!function(t){var e=$("<div class='small-box "+t+"'></div>");e.css({width:20,height:20,margin:5,float:"left",display:e}),i.append(e),e.on("click.block",function(e){e.stopPropagation(),i.css("display","none"),$("body").off("click.body"),$(o).off("click.cs"),$(o).on("click.cs",r),n.$apply(function(){n.bgcolor.attributes?n.bgcolor.attributes.color=t:n.bgcolor.attributes={color:t},$(o).removeClass().addClass("small-box").addClass(t)})})}(e[t]),n.bgcolor.attributes.color=e[0];function r(e){e.stopPropagation(),i.css("display","block"),i.css("top",$(o).offset().top),i.css("left",$(o).offset().left+30),$(o).off("click.cs"),$(o).on("click.cs",a),$("body").on("click.body",a)}function a(e){e.stopPropagation(),i.css("display","none"),$("body").off("click.body"),$(o).off("click.cs"),$(o).on("click.cs",r)}$("body").prepend(i),i.on("click.empty",function(){event.stopPropagation()})})}};return i}function iconSelector_directive(t,e){var i={restrict:"A",scope:{icon:"="},link:function(n,o,e){t(function(){var e=["ps-edit"," ps-back","ps-mushroom","ps-planting","ps-current_production","ps-estimated_output","ps-daily_output","ps-duration","ps-sandglass","ps-task","ps-current_production_p","ps-pattern","ps-number","ps-air-humidity","ps-air-temperature","ps-camera","ps-sunshine","ps-video-camera","ps-water","ps-fan","ps-electric_motor02","ps-electric_motor","ps-Co2","ps-soil_temperature","ps-soil_humidity","ps-irrigation","ps-spraying","ps-chart_brokenline","ps-userinfo","ps-user","ps-group","ps-center","ps-server","ps-app"],i=$("<div class='selWrap' id='iconSelector'></div>");for(var t in $(o).on("click.cs",r),e)!function(t){var e=$("<div class='icon'><span class='proudsmart "+t+"' style='font-size : 15px; color : #fff; top : 2px; left : 2px;'></span></div>");e.css({width:20,height:20,margin:5,float:"left",display:e}),i.append(e),e.on("click.block",function(e){e.stopPropagation(),i.css("display","block"),$("body").off("click.body"),i.css("display","none"),$(o).off("click.cs"),$(o).on("click.cs",r),n.$apply(function(){n.icon.attributes?n.icon.attributes.icon=t:n.icon.attributes={icon:t},$(o).find("i").removeClass().addClass("proudsmart "+t)})})}(e[t]),n.icon.attributes.icon=e[0];function r(e){e.stopPropagation(),i.css("top",$(o).offset().top),i.css("left",$(o).offset().left+30),i.css("display","block"),$(o).off("click.cs"),$(o).on("click.cs",a),$("body").on("click.body",a)}function a(e){e.stopPropagation(),i.css("display","none"),$("body").off("click.body"),$(o).off("click.cs"),$(o).on("click.cs",r)}$("body").prepend(i),i.on("click.empty",function(){event.stopPropagation()})})}};return i}function ciSelectmenu_directive(t,o){var e={restrict:"A",scope:{tool:"="},link:function(a,n,e){t(function(){o.$resources.get().then(function(e){for(var t in e)(function(e){var t=$("<option></option>");t.text(e.label),t.attr("value",e.id),this.append(t)}).call($(n),e[t]);var i=e[0].id;a.tool.attributes.ci=i;var r=o.$resources.getModelIdByNodeId(i);o.$kpis.getBymodelId(r).then(function(e){a.tool.onChange(e)},function(e){}),$(n).selectmenu({width:100,change:function(e,t){var i=parseInt(t.item.value);a.tool.attributes.ci=i;var r=o.$resources.getModelIdByNodeId(i);o.$kpis.getBymodelId(r).then(function(e){a.tool.onChange(e)},function(e){})}})},function(e){})})}};return e}function aciSelectmenu_directive(t,n){var e={restrict:"A",scope:{attr:"="},link:function(r,a,e){t(function(){n.$resources.getCurrent().then(function(e){for(var t in e)(function(e,t){if(0!=e){var i=$("<option></option>");i.text(t.label),i.attr("value",t.id),this.append(i)}}).call($(a),t,e[t]);var i=e[1].id;r.attr.attributes.ci=i,n.$resources.getAttrByNodeId(i).then(function(e){r.attr.onChange(e)},function(e){}),$(a).selectmenu({width:100,change:function(e,t){var i=parseInt(t.item.value);n.$resources.getAttrByNodeId(i).then(function(e){r.attr.onChange(e)},function(e){})}})},function(e){})})}};return e}function ciSelectmenuChart_directive(o,s){var c,e={};return e.restrict="A",e.scope={chart:"="},e.link=function(a,n,e){a.$watch("chart",function(e,t,i){e&&(e.add=function(){var e;for(var t in c){if(!a.chart.kpiObjects.some(function(e){return c[t].id==e.id})){e={id:c[t].id};break}}a.chart.kpiObjects.push(e);var i=a.chart.kpiObjects;o(function(){i[i.length-1].onChange(c)})})}),o(function(){s.$resources.get().then(function(e){for(var t in e)(function(e){var t=$("<option></option>");t.text(e.label),t.attr("value",e.id),this.append(t)}).call($(n),e[t]);var i=e[0].id;a.chart.attributes.nodes=[i];var r=s.$resources.getModelIdByNodeId(i);s.$kpis.getBymodelId(r).then(function(e){c=e,a.chart.kpiObjects=[{id:e[0].id}],o(function(){a.chart.kpiObjects[0].onChange(e)})},function(e){}),$(n).selectmenu({width:100,change:function(e,i){a.$apply(function(){var e=parseInt(i.item.value);a.chart.attributes.nodes=[e];var t=s.$resources.getModelIdByNodeId(e);s.$kpis.getBymodelId(t).then(function(e){c=e,a.chart.kpiObjects=[{id:e[0].id}],o(function(){a.chart.kpiObjects[0].onChange(e)})},function(e){})})}})},function(e){})})},e}function kpiSelectmenuChart_directive(e,t){var i={restrict:"A",scope:{chart:"=",target:"="}};return i.link=function(i,r,e){i.$watch("chart",function(e,t,a){e&&(e.onChange=function(e){!function(e){for(var t in $(r).children().remove(),e)(function(e){var t=$("<option></option>");t.text(e.label),t.attr("value",e.id),i.chart.id==e.id&&t.prop("selected","selected"),this.append(t)}).call($(r),e[t]);$(r).selectmenu("instance")?$(r).selectmenu("refresh"):$(r).selectmenu({width:100,change:function(e,t){i.$apply(function(){i.chart.id=parseInt(t.item.value)})}})}(e.filter(function(e){for(var t in a.filter){if(!(i=t,r=a.filter[t],e[i]==r))return!1}var i,r;return!0}))})}),i.$watch("chart.id",function(e,t,i){e&&(i.target.attributes.kpis=i.target.kpiObjects.map(function(e){return e.id}))})},i}function selectmenu_directive(e,t){var i={restrict:"A",scope:{tool:"=",filter:"="}};return i.link=function(i,r,e){i.$watch("tool",function(e,t,a){e&&(e.onChange=function(e){!function(e){for(var t in $(r).children().remove(),e)(function(e){var t=$("<option></option>");t.text(e.label),t.attr("value",e.id),this.append(t)}).call($(r),e[t]);$(r).selectmenu("instance")?$(r).selectmenu("refresh"):$(r).selectmenu({width:100,change:function(e,t){i.tool.attributes.kpi=parseInt(t.item.value)}});i.tool.attributes.kpi=e[0].id}(e.filter(function(e){for(var t in a.filter){if(!(i=t,r=a.filter[t],e[i]==r))return!1}var i,r;return!0}))})})},i}function attrSelectmenu_directive(e,t){var i={restrict:"A",scope:{attr:"=",filter:"="}};return i.link=function(i,r,e){i.$watch("attr",function(e,t,a){e&&(e.onChange=function(e){!function(e){for(var t in $(r).children().remove(),e)(function(e){var t=$("<option></option>");t.text(e.label),t.attr("value",e.id),this.append(t)}).call($(r),e[t]);$(r).selectmenu("instance")?$(r).selectmenu("refresh"):$(r).selectmenu({width:100,change:function(e,t){i.attr.attributes.attrId=parseInt(t.item.value)}});i.attr.attributes.attrId=e[0].id}(e.filter(function(e){for(var t in a.filter){if(!(i=t,r=a.filter[t],e[i]==r))return!1}var i,r;return!0}))})})},i}function bootinputfree_directive(t,e){var i={restrict:"C",scope:{model:"="}};return i.link=function(a,n,e){var o="";t(function(){var e,t,i="";for(var r in a.model.cols)r==a.model.cols.length-1?i+=a.model.cols[r].col:i+=a.model.cols[r].col+"-";e=o=i,(t=$("<input />")).on("blur",function(t){a.$apply(function(){var e=$(t.target).val().split("-");12!=e.reduce(function(e,t){return parseInt(e)+parseInt(t)})?($(t.target).val(o),alert("输入列数总和要为12！")):(o=$(t.target).val(),a.model.cols=e.map(function(e){return{col:e}}))})}),t.val(e),$(n).children().remove(),$(n).append(t)})},i}function bootinput_directive(i,e){var t={restrict:"C",scope:{model:"="}};return t.link=function(c,t,e){i(function(){!function o(){var s=$("<div class='row bootShow'></div>");for(var e in c.model.cols)!function(e,n){var t=$("<div class='cwrap col-md-"+n.col+"'><div style='margin : 0 4px 0 0;background-color : white; border : 1px solid #bfbfbf;'><div class='inner'></div></div></div>"),i=$("<input class='colNum' />");i.val(n.col),i.css("margin","0px 5px"),t.append(i);for(var r=0;r<n.col;r++){var a=$("<div class='bwrap' style='width : "+100/n.col+"%;'><div class='block'></div></div>");t.find(".inner").append(a)}t.find(".inner").append($("<div style='height : 1px; clear : both; width : 100%;'></div>")),s.append(t),i.on("change",function(a){c.$apply(function(){var e=parseInt($(a.target).val());e<2?e=2:e>12-c.model.cols.length+1&&(e=12-c.model.cols.length+1);var t=0,i=0;for(var r in c.model.cols)c.model.cols[r]!=n?(t+=c.model.cols[r].col,i+=c.model.cols[r].col):t+=e;n.col=t<=12?e:12-i,o()})})}(0,c.model.cols[e]);$(t).children().remove();$(t).append(s)}()})},t}function draggable_directive(e,c){var t={restrict:"A",scope:{dashboard:"="},link:function(e,t,s){$(t).draggable({start:function(e,t){dragging=!0},stop:function(e,t){dragging=!1},handle:$(t).find(".handler"),cursor:"move",appendTo:"body",revert:!0,helper:function(e){if("layouts"==s.drag){var t=$(e.currentTarget).attr("id"),i=JSON.parse(JSON.stringify(c.layouts.filter(function(e){return e.id==t})[0])),r=$("<div class='helper row'></div>");for(var a in i.cols){var n=i.cols[a],o=$("<div class='inner col-md-"+n.col+"'></div>");r.append(o)}}else if("designViews"==s.drag)r=$("<div class='helper row'></div>").css({height:"100px"});else if("totalItems"==s.drag)r=$("<div class='helper row'></div>").css({width:"200px",height:"100px"});else if("progress"==s.drag)r=$("<div class='helper row'></div>").css({width:"200px",height:"100px"});else if("downTab"==s.drag)r=$("<div class='helper row'></div>").css({width:"200px",height:"100px"});else if("attrTab"==s.drag)r=$("<div class='helper row'></div>").css({width:"200px",height:"100px"});else if("basicline"==s.drag)r=$("<div class='helper row'></div>").css({width:"200px",height:"100px"});else if("basicpie"==s.drag)r=$("<div class='helper row'></div>").css({width:"200px",height:"100px"});else if("header"==s.drag)r=$("<div class='helper row'></div>").css({width:"200px",height:"100px"});else if("listone"==s.drag)r=$("<div class='helper row'></div>").css({width:"200px",height:"100px"});else if("listtwo"==s.drag)r=$("<div class='helper row'></div>").css({width:"200px",height:"100px"});else if("map"==s.drag)r=$("<div class='helper row'></div>").css({width:"200px",height:"100px"});else if("sparkline"==s.drag)r=$("<div class='helper row'></div>").css({width:"200px",height:"100px"});else if("alertcommon"==s.drag)r=$("<div class='helper row'></div>").css({width:"200px",height:"100px"});return r},revertDuration:0,zIndex:9999999,connectToSortable:"#sortable"})}};return t}function droppable_directive(q,timeout,variables,kpiDataService,resourceUIService,viewFlexService,growl,basicline,basicpie,location,window,Info,ticketTaskService,solutionUIService){var templates=new $Array(variables.layouts),directive={};function bootEditor(object){var cur=this,structure,dashboard=object.dashboard;dashboard.on("switchMode",function(){timeout(function(){cur.resize()},100)}),$(window).on("resize",function(){timeout(function(){cur.resize()},100)}),cur.toJSON=function(){return structure.toJSON()},cur.resize=function(){structure.each(function(e){if("designView"==e.type||"basicline"==e.type||"basicpie"==e.type)for(var t in e.echarts)e.echarts[t].echart("option","resize")})};var dragconfig={cursorAt:{top:0,left:450},start:function(e,t){$(e.target).css("display","none"),dragging=!0},stop:function(e,t){$(e.target).css("display","block"),dragging=!1},appendTo:"body",revertDuration:0,cursor:"move",revert:!0,zIndex:9999,opacity:.5,helper:function(e){var t=$(e.currentTarget).clone(),i=t.find(".box-body"),r=$("<div class='help_wrap row'></div>");return 0<i.size()?i.children(".innerContent").children().each(function(e,t){var i=$(t).clone();i.children().remove(),0==i.filter("[class*=col-]").size()&&i.addClass("column col-md-12"),r.append(i)}):t.children(".innerContent").children().each(function(e,t){var i=$(t).clone();i.children().remove(),0==i.filter("[class*=col-]").size()&&i.addClass("column col-md-12"),r.append(i)}),r.css({"pointer-events":"none"}),r}},mouseEvent={mouseover:function(e,t){dragging&&$(e.target).addClass("drophover")},mouseout:function(e,t){dragging&&$(e.target).removeClass("drophover")}},dropconfig={tolerance:"pointer",drop:function(e,t){var i,r,a={},n=$(t.draggable),o=n.attr("id"),s=$(e.target);if(0<n.filter("[drag]").size()){var c=n.attr("drag");i=$("<div id='"+$randomString(32)+"' class='row rowWrap'></div>"),(a=JSON.parse(JSON.stringify(variables[c].filter(function(e){return e.id==o})[0]))).target=i}else structure.eachRow(function(e){var t=$(e.target).attr("id");o==t&&(structure.remove(e),a=e)}),i=a.target;if(s.hasClass("insert_before")){var d;if(d=s.parent().hasClass("box-body")?(b=s.parent().parent().parent().parent().attr("id"),s.parent().parent().parent().attr("id")):(b=s.parent().parent().attr("id"),s.parent().attr("id")),structure.eachCol(function(e){var t=$(e.target).attr("id");b==t&&(f=e)}),f.rows){var l=[];for(var p in f.rows)d==f.rows[p].target.attr("id")&&l.push(a),l.push(f.rows[p]);f.rows=l}if("dropBody"==b){var u=$("<div class='box box-info'>"),v=$('<div class="box-header with-border">                                <h3 class="box-title" id="boxTitle"></h3>                            </div>');r=$("<div class='box-body'></div>"),i.children().remove(),i.append(u),u.append(v),u.append(r)}else{0<(g=i.find(".box-body")).size()&&i.find(".box").remove(),i.children().remove(),r=i}s.parent().hasClass("box-body")?s.parent().parent().parent().before(i):s.parent().before(i)}else if(s.hasClass("insert_after")){var f,b;if(b=s.parent().hasClass("box-body")?s.parent().parent().parent().attr("id"):s.parent().attr("id"),structure.eachCol(function(e){var t=$(e.target).attr("id");b==t&&(f=e)}),f.rows?f.rows.push(a):f.rows=[a],"dropBody"==b){u=$("<div class='box'>"),v=$('<div class="box-header with-border">                                <h3 class="box-title" id="boxTitle"></h3>                            </div>');if(r=$("<div class='box-body'></div>"),i.append(u),u.append(v),u.append(r),0<(g=i.find(".box-body")).size()){var h=g.children();i.find(".box").remove(),i.append(h),i.children().remove(),i.append(u)}else r.append(i.children())}else{var g;0<(g=i.find(".box-body")).size()&&i.find(".box").remove(),i.children().remove(),r=i}s.parent().hasClass("box-body")?s.parent().parent().before(i):s.before(i)}s.removeClass("drophover"),traverse(r,a),timeout(function(){cur.resize()},100),0==$("#dropBody").children(".rowWrap").size()&&$("#dropBody").children(".insert_after").css("height","500px")}};function init(e){structure=new $tree(JSON.parse(JSON.stringify(e.data)));var t=$("<div class='insert_after'></div>");for(var i in structure.getData().target=e.root,structure.getData().rows){var r=structure.getData().rows[i],a=$("<div id='"+$randomString(32)+"' class='row rowWrap'></div>"),n=$("<div class='box'></div>"),o=$('<div class="box-header with-border">                        <h3 id="boxTitle" class="box-title"></h3>                    </div>'),s=$("<div class='box-body'></div>");(r.target=a).append(n),n.append(o),n.append(s),structure.getData().target.append(a),traverse(s,r)}structure.getData().target.append(t),t.droppable(dropconfig),t.on(mouseEvent)}function traverse(r,i){var e=$("<div class='titleWrap'><lable>表标题</lable><input id='btitle'/></div>"),t=$("<div class='toolbar'></div>"),a=$("<div class='moveBtn'><span class='proudsmart ps-move'></span></div>"),n=$("<div class='deleteBtn'><span class='proudsmart ps-delete'></span></div>"),o=$("<div class='insert_before'></div>"),s=$("<div class='row innerContent'></div>"),c=$("<div class='innerWrap'></div>");if(r.hasClass("box-body")){var d=$("<div class='showOutter'><input type='checkbox'/><label>显示外框</label></div>");if(t.append(e).append(n).append(a).append(d),0!=i.show?(i.show=!0,d.find("input").prop("checked","checked"),r.parent().parent().removeClass("hideWrap")):(i.show=!1,d.find("input").removeAttr("checked"),r.parent().parent().addClass("hideWrap")),d.find("input").on("click",function(e){$(this).prop("checked")?(i.show=!0,r.parent().parent().removeClass("hideWrap")):(i.show=!1,r.parent().parent().addClass("hideWrap"))}),i.title)e.find("#btitle").val(i.title),r.parent().find("#boxTitle").text(i.title);e.find("#btitle").on("change",function(e){var t=$(e.target);r.parent().find("#boxTitle").text(t.val()),i.title=t.val()})}else delete i.show,t.append(n).append(a);if(r.append(o).append(t).append(s),"layout"==i.type){var l=i.cols;for(var p in l){var u=$("<div id='col_"+$randomString(32)+"' class='column col-md-"+l[p].col+"'></div>"),v=$("<div class='insert_after'></div>"),f=l[p];for(var b in f.target=u,f.rows){var h=$("<div id='"+$randomString(32)+"' class='row rowWrap'></div>");u.append(h);var g=f.rows[b];traverse(g.target=h,g)}u.append(v),s.append(u),v.droppable(dropconfig),v.on(mouseEvent)}}else if("designView"==i.type){s.append(c);designView(c,i)}else if("totalItems"==i.type){s.append(c);totalItems(c,i)}else if("progress"==i.type){s.append(c);progress(c,i)}else if("downTab"==i.type){s.append(c);downTab(c,i)}else if("attrTab"==i.type){s.append(c);attrTab(c,i)}else if("header"==i.type){s.append(c);header(c,i)}else if("basicline"==i.type){s.append(c),i.content=basicline.getOption(),i.content.elements[0].nodes=i.attributes.nodes,i.content.elements[0].kpis=i.attributes.kpis;designView(c,i)}else if("basicpie"==i.type){s.append(c),i.content=basicpie.getOption(),i.content.elements[0].nodes=i.attributes.nodes,i.content.elements[0].kpis=i.attributes.kpis;designView(c,i)}else if("listone"==i.type){s.append(c);listone(c,i)}else if("listtwo"==i.type){s.append(c);listtwo(c,i)}else if("map"==i.type){s.append(c);map(c,i)}else if("sparkline"==i.type){s.append(c);sparkline(c,i)}else if("alertcommon"==i.type){s.append(c),i.content=basicpie.getOption();designView(c,i)}r.hasClass("box-body")?(r.parent().parent().draggable(dragconfig),r.parent().parent().draggable("option","handle",a),r.parent().parent().draggable("option","handle",a)):(r.draggable(dragconfig),r.draggable("option","handle",a),r.draggable("option","handle",a)),o.droppable(dropconfig),o.on(mouseEvent),r.hasClass("box-body")?r.parent().parent().on("mouseover",function(e){e.stopPropagation(),$(document).find(".boot-mouseOver").removeClass("boot-mouseOver"),$(e.currentTarget).addClass("boot-mouseOver")}):r.on("mouseover",function(e){e.stopPropagation(),$(document).find(".boot-mouseOver").removeClass("boot-mouseOver"),$(e.currentTarget).addClass("boot-mouseOver")}),n.on("click",function(e){var t;if(e.stopPropagation(),$(e.target).parent().parent().parent().hasClass("box-body")){var i=$(e.currentTarget).parent().parent().parent().parent().attr("id");structure.each(function(e){e.target.attr("id")==i&&(t=e)}),structure.remove(t),r.parent().parent().remove()}else{i=$(e.currentTarget).parent().parent().attr("id");structure.each(function(e){e.target.attr("id")==i&&(t=e)}),structure.remove(t),r.remove()}0==$("#dropBody").children(".rowWrap").size()&&$("#dropBody").children(".insert_after").css("height","500px")})}function $tree(e){var t=this,s=e;t.getData=function(){return s},t.toJSON=function(){var e={rows:[]};for(var t in s.rows){var i=s.rows[t],r={};r.type=i.type,r.show=i.show,r.title=i.title,"designView"==i.type?r.content=i.content:"totalItems"==i.type?r.attributes=i.attributes:"progress"==i.type?r.attributes=i.attributes:"downTab"==i.type?r.attributes=i.attributes:"attrTab"==i.type?r.attributes=i.attributes:"basicline"==i.type?(r.attributes=i.attributes,r.content=i.content):"basicpie"==i.type?(r.attributes=i.attributes,r.content=i.content):"header"==i.type?r.attributes=i.attributes:"listone"==i.type?r.attributes=i.attributes:"listtwo"==i.type?r.attributes=i.attributes:"map"==i.type?r.attributes=i.attributes:"sparkline"==i.type?r.attributes=i.attributes:"alertcommon"==i.type&&(r.attributes=i.attributes),e.rows.push(r),o(i,r)}function o(e,n){if(null!=e.cols)for(var t in e.cols)!function(e){var t,i,r={col:e.col};for(var a in n.cols?n.cols.push(r):n.cols=[r],e.rows)t=e.rows[a],i=void 0,(i={}).type=t.type,r.type=t.type,"designView"==t.type?i.content=t.content:"totalItems"==t.type?i.attributes=t.attributes:"progress"==t.type?i.attributes=t.attributes:"downTab"==t.type?i.attributes=t.attributes:"attrTab"==t.type?i.attributes=t.attributes:"basicline"==t.type?(i.attributes=t.attributes,i.content=t.content):"basicpie"==t.type?(i.attributes=t.attributes,i.content=t.content):"header"==t.type?i.attributes=t.attributes:"listone"==t.type?i.attributes=t.attributes:"listtwo"==t.type?i.attributes=t.attributes:"map"==t.type?i.attributes=t.attributes:"sparkline"==t.type?i.attributes=t.attributes:"alertcommon"==t.type&&(i.attributes=t.attributes),r.rows?r.rows.push(i):r.rows=[i],o(t,i)}(e.cols[t])}return e},t.each=function(a){for(var e in s.rows){var t=s.rows[e];n(t),a(t)}function n(e){for(var t in e.cols){var i=e.cols[t];for(var r in a(i),i.rows)n(i.rows[r]),a(i.rows[r])}}},t.remove=function(n){var e=[];for(var t in s.rows){var i=s.rows[t];n!=i&&(e.push(i),o(i))}function o(e){for(var t in e.cols){var i=e.cols[t],r=[];for(var a in i.rows)$(n.target).attr("id")!=$(i.rows[a].target).attr("id")&&(r.push(i.rows[a]),o(i.rows[a]));0<r.length?i.rows=r:delete i.rows}}0<(s.rows=e).length?s.rows=e:delete s.rows},t.eachRow=function(r){for(var e in s.rows)(t=s.rows[e])&&(a(t),r(t));var t;function a(e){for(var t in e.cols)!function(e){for(var t in e.rows)(i=e.rows[t])&&(a(i),r(i));var i}(e.cols[t])}},t.eachCol=function(a){for(var e in a(s),s.rows){n(s.rows[e])}function n(e){for(var t in e.cols){var i=e.cols[t];for(var r in a(i),i.rows)n(i.rows[r])}}}}function designView(o,m){var c,d;return m.echarts=[],d=$("<div class='designView'></div>"),c=m.content.elements,[],o.append(d),function(t){var e=[];for(var a in c){var n=[],l=q.defer();e.push(l.promise);var p,u,v,o,i=[],f=c[a].category,b=c[a].dataType,h=c[a].option,g=c[a].formatStr;if(c[a].layout)var r=c[a].layout.col,s=c[a].layout.row;else{r=0,s=a;c[a].layout={width:100,col:0,row:a}}i[s]||(i[s]=[]),p=i[s][r]={kpis:c[a].kpis,nodes:c[a].nodes,layout:c[a].layout,option:c[a].option},variables.$rootDomain.get().then(function(e){var t;if(o=[e.id],"alert"!=m.attributes.type){r={category:f,isRealTimeData:!0,timePeriod:"time"==f?c[a].timespan:0,nodeIds:o,kpiCodes:c[a].kpis,startTime:null,endTime:null,timeRange:"",statisticType:"psiot",condList:[]},t=["kpi",r];var i=q.defer();q.defer();n.push(i.promise),variables.$kpis.getBymodelId(e.modelId).then(function(e){u=e.reduce(function(e,t){return c[a].kpis.some(function(e){return e==t.id})&&(e[t.id]=t),e},{}),i.resolve("success")},function(e){}),(v={})[e.id]=e,q.all(n).then(function(){kpiDataService.getValueList(t,function(e){var s=new $Array(e.data),t=function(){var e=new $Array([]);for(var t in u)for(var i in v)e.push({nodeId:i,nodeDes:v[i],kpiId:t,kpiDes:u[t],valueList:[]});return e}();"time"==f?t.each(function(a){for(var e=0;e<7;e++){var t=new Date((new Date).getTime()-24*(7-e)*3600*1e3),i=t.getYear(),n=t.getMonth(),o=t.getDate(),r=s.values().find(function(r){return function(e,t,i){return this.getYear()==e&&this.getMonth()==t&&this.getDate()==i&&a.kpiId==r.kpiCode}.call(new Date(r.arisingTime.split("T")[0].replace(/-/g,"/")),i,n,o)});a.valueList.push({kpiCode:a.kpiId,value:r?r.value:void 0,timeStamp:t.getTime()})}}):t.each(function(t){var e=new Date,i=s.values().find(function(e){return t.kpiId==e.kpiCode});i?t.valueList.push({kpiCode:t.kpiId,value:i.value,timeStamp:e.getTime()}):t.valueList.push({kpiCode:t.kpiId,value:0,timeStamp:e.getTime()})});var i,r,a=b.category[f],n=new $valueListGroup(t,1,g),o=new $option(h);if("time"==f)a.series&&("linear"==a.series.model?(o.clearSeries(),r=n.getLegend(),i=n.getxAxisByTime(),n.eachValueListMerged(function(e){var t=e.nodeDes.label+"-"+e.kpiDes.label,i=e.$valueList;o.pushSeries(t,i)})):"dimensional"==a.series.model&&((a.series.value="ci")||(a.series.value="kpi")));else if("ci"==f&&a.series)if("linear"==a.series.model){var c=[];r=n.getLegend(),i=[];var d=o.firstSeries();n.eachValueListMerged(function(e){var t=e.nodeDes.label+"-"+e.kpiDes.label,i=e.valueList;c.push({name:t,value:i[0].value})}),d.data=c}else"dimensional"==a.series.model&&((a.series.value="ci")||(a.series.value="kpi"));a.xAxis&&o.setFirstxAxis(i),a.legend&&o.setLegend(r),p.option=o.getOption(),m.attributes.color&&(p.option.series[0].itemStyle={normal:{color:m.attributes.color}},p.option.series[0].lineStyle={normal:{color:m.attributes.color}},p.option.series[0].areaStyle={normal:{color:m.attributes.color}},p.option.series[0].markPoint={},p.option.series[0].markLine={}),p.option.animation=!0,l.resolve("success")})})}else{var r;t=["alert",r={category:"ci",isRealTimeData:!0,timePeriod:0,kpiCodes:["alert_code_count"]}],kpiDataService.getKpiHierarchyValueList(t,function(e){if("0"==e.code){var t=$('<ul class="nav nav-pills nav-stacked"></ul>');if(e.data.recordList instanceof Array){var i=new $option(h),r=[];for(var a in i.clearSeries(),e.data.recordList){r.push({name:e.data.recordList[a].category,value:e.data.recordList[a].alert_code_count});var n=$("<li>                                                    <a>"+e.data.recordList[a].category+' <span class="pull-right text-red ng-binding">'+e.data.recordList[a].alert_code_count+"条</span></a>                                                </li>");t.append(n)}d.after(t),i.pushSeries("常见告警类型",r),p.option=i.getOption(),p.option.animation=!0,l.resolve("success")}}})}})}q.all(e).then(function(e){t(i)})}(function(e){for(var t in e){var i=$("<div class='rowCls'></div>");for(var r in d.append(i),e[t]){var a=$("<div class='colCls'></div>"),n=e[t][r].layout.width;i.append(a),a.css("width",n+"%");o.width();a.css("height","300px"),a.echart({option:e[t][r].option}),e[t][r].target=a,m.echarts.push(a)}}}),d}function totalItems(e,t){if(t.attributes){var a,i,n=t.attributes.kpi,r=t.attributes.ci,o=$("<div class='small-box "+t.attributes.color+"'></div>"),s=$("<div class='inner' style='cursor : pointer;'></div>"),c=$("<h3><span id='text'></span><span id='unit' style='font-size: 20px'></span></h3>"),d=$("<p id='title'></p>");i=-1==t.attributes.icon.indexOf("fa")?$("<div class='icon'><i class='proudsmart "+t.attributes.icon+"' style='font-size : 70px;'></i></div>"):$("<div class='icon'><i class='"+t.attributes.icon+"' style='font-size : 70px;'></i></div>"),s.append(c),s.append(d),o.append(s),o.append(i),e.append(o),resourceUIService.getResourceById([r],function(e){"0"==e.code&&(null==e.data?variables.$rootDomain.get().then(function(e){l(e.modelId)}):l(e.data.modelId))}),variables.getValueByRootKpi(n).then(function(e){c.find("span#text").text(e)})}function l(e){variables.$kpis.getBymodelId(e).then(function(i){var r=(a=i.find(function(e){return e.id==n})).unit;d.text(a.label),o.on("click",function(){"管控设备数"==a.label?window.location.href="../app-oc/index.html#/resource":"数据采集点"==a.label?window.location.href="../app-oc/index.html#/emcsView":"待处理工单数"==a.label?window.location.href="../app-oc/index.html#/workorder":"待处理告警数"==a.label?window.location.href="../app-oc/index.html#/configAlertByStatus":"待处理紧急告警数"==a.label?window.location.href="../app-oc/index.html#/configAlert":("日开机总时长"==a.label||"当日总产量"==a.label||a.label,window.location.href="../app-oc/index.html#/emcsView")}),variables.$units.get().then(function(e){var t=e.filter(function(e){return e.unitCode==r});t[0]&&("Amount"==t[0].unitCode?"数据采集点"==i[0].label?c.find("span#unit").text("台"):c.find("span#unit").text("个"):c.find("span#unit").text(t[0].unitName))},function(e){growl.addErrorMessage(e)})})}}function header(e,i){if(i.attributes){i.attributes.text;var r=$("<h4 class='visibleWhenView'></h4>"),t=$("<div class='hideWhenView'><label>标题名称：</label><input class='form-control'/></div>");t.css({margin:"30px"}),r.css({margin:"5px"}),e.append(r).append(t),i.attributes.text&&(r.text(i.attributes.text),t.find("input").val(i.attributes.text)),t.find("input").on("change",function(e){var t=$(e.target).val();i.attributes.text=t,r.text(t)})}}function attrTab(e,t){if(t.attributes){var i=t.attributes.attrId,r=t.attributes.ci,a=$("<div class='small-box "+t.attributes.color+"'></div>"),n=$("<div class='inner' style='cursor : pointer;'></div>"),o=$("<h3><span id='text'></span><span id='unit' style='font-size: 20px'></span></h3>"),s=$("<p id='title'></p>"),c=$("<div class='icon'><i class='proudsmart "+t.attributes.icon+"'></i></div>");n.append(o),n.append(s),a.append(n),a.append(c),e.append(a),variables.$resources.getAttrByNodeId(r).then(function(e){var t=e.filter(function(e){return e.id==i});0<t.length&&(o.find("span#text").text(t[0].label),o.find("span#unit").text(t[0].value),s.text(t[0].name))},function(e){})}}function sparkline(e,t){var n;if(t.attributes&&t.kpiObjects)for(var i in t.attributes.kpis=[],t.kpiObjects)t.attributes.kpis.push(t.kpiObjects[i].id);var o=$('<div class="pad box-pane-right bg-green" style="min-height: 280px"></div>');e.append(o);var r=t.attributes.kpis;variables.$rootDomain.get().then(function(e){var t=e.modelId;variables.$kpis.getBymodelId(t).then(function(e){n=e.reduce(function(e,t){return r.some(function(e){return e==t.id})&&(e[t.id]=t),e},{}),variables.getValueListByRootKpis(r).then(function(e){for(var t in n){var i=e.filter(function(e){return e.kpiCode==n[t].id}),r=$('<div class="description-block margin-bottom ng-scope" ng-repeat="item in totalItems4" on-finish-render-filters="">                                <div class="sparkbar pad">                                </div>                                <h5 class="description-header ng-binding">'+(i.length?i[i.length-1].value:0)+'</h5>                                <span class="description-text ng-binding">'+n[t].label+"</span>                            </div>"),a=[];if(i)a=7<i.length?i.slice(-7).map(function(e){return e.value}):i.slice(1-i.length).map(function(e){return e.value});else for(t=0;t<7;t++)a.push(0);o.append(r),r.find(".sparkbar").sparkline(a,{type:"bar",barColor:"white"})}})})})}function map(e,t){var n,o=$("<div style='width : 100%; height : 340px;'></div>");e.append(o);var s={backgroundColor:"#404a59",title:{text:"",subtext:"",sublink:"",left:"center",textStyle:{color:"#fff"}},tooltip:{trigger:"item",formatter:function(e){return e.seriesName+":"+e.value[2]}},bmap:{center:[104.114129,37.550339],zoom:5,roam:!0,mapStyle:{styleJson:[]}},series:[{name:"运行设备数",type:"scatter",coordinateSystem:"bmap",data:[],symbolSize:function(e){var t;return 20<10+(t=e?.2*e[2]:0)?20:10+t},label:{normal:{formatter:"{b}",position:"right",show:!1},emphasis:{show:!0}},itemStyle:{normal:{color:"#ddb926"}}},{name:"运行设备数",type:"effectScatter",coordinateSystem:"bmap",data:[],symbolSize:function(e){var t;return 20<10+(t=e?.2*e[2]:0)?20:10+t},showEffectOn:"render",rippleEffect:{brushType:"stroke"},hoverAnimation:!0,label:{normal:{formatter:"{b}",position:"right",show:!0}},itemStyle:{normal:{color:"#f4e925",shadowBlur:10,shadowColor:"#333"}},zlevel:1}]};Info.get("../localdb/echarts-map.json",function(e){n=e,s.bmap.mapStyle.styleJson=n.styleJson_dark,resourceUIService.statDeviceByStandardAddress(function(e){var t={"北京市":0};if(0==e.code){for(var i in e.data)if(i){var r=i.split(",");-1<r[0].indexOf("市")?t[r[0]]?t[r[0]]=t[r[0]]+e.data[i]:t[r[0]]=e.data[i]:1<r.length&&(t[r[1]]=e.data[i])}else t["北京市"]=t["北京市"]+e.data[""];for(var i in t){var a={};a.name=i,a.value=n.geoCoord[i],a.value&&a.value.push(t[i]),s.series[0].data.push(a),s.series[0].data.length<5&&s.series[1].data.push(a)}o.echart({option:s})}})})}function progress(e,t){if(t.attributes){t.attributes.ci;var i=t.attributes.kpi,r=$("<div class='progress-group'></div>"),a=$("<span class='progress-text' id='value'></span>"),n=$("<span class='progress-number'></span>"),o=$("<div class='progress sm'><div class='progress-bar' style='width:80%'></div></div>");r.append(a),r.append(n),r.append(o),e.append(r),variables.$kpis.getByKpiIds([i]).then(function(e){a.text(e[0].label)}),variables.$rootDomain.get().then(function(e){var t=e.modelId;variables.$kpis.getBymodelId(t).then(function(e){e.find(function(e){return e.id==i}),variables.getValueByRootKpi(i).then(function(e){switch(n.find("span#text").text(e),!0){case 100==e:o.find(".progress-bar").addClass("progress-bar-aqua");break;case 90<e:o.find(".progress-bar").addClass("progress-bar-green");break;case 80<e:case 70<e:o.find(".progress-bar").addClass("progress-bar-yellow");break;case 60<e:o.find(".progress-bar").addClass("progress-bar-red");break;default:o.find(".progress-bar").addClass("progress-bar-danger")}n.html("<b>"+e+"</b>%"),o.find(".progress-bar").css("width",e+"%")})})})}}function downTab(e,t){if(t.attributes){t.attributes.ci;var i,r=t.attributes.kpi,a=$("<div class='description-block border-right'></div>"),n=$("<span class='description-percentage'><i class='fa'></i><span id='rate'></span></span>"),o=$("<h5 class='description-header'></h5>"),s=$("<span class='description-text'></span>");a.append(n),a.append(o),a.append(s),e.append(a),variables.$rootDomain.get().then(function(e){var t=e.modelId;variables.$kpis.getBymodelId(t).then(function(e){i=e.find(function(e){return e.id==r}),s.text(i.label)}),variables.getValueListByRootKpis([r]).then(function(e){var t,i;0<e.length&&(r=e[0].value),i=1<e.length?0<(t=e[e.length-1])?100*(r-t/t):100:0,n.find("#rate").text(Math.abs(i)+"%"),0<i?(n.find("i.fa").addClass("fa-caret-up"),n.addClass("text-red")):i<0?(n.find("i.fa").addClass("fa-caret-down"),n.addClass("text-green")):(n.find("i.fa").addClass("fa-caret-left"),n.addClass("text-red"));var r=0==r?parseInt(100*Math.random()):r;o.text(r)})})}}function listone(target,mydata){if(mydata.attributes){var fun=mydata.attributes.fun,innerContent=$("<table width='100%' class='table table-hover no-margin'>"),uldom=$('<ul class="products-list product-list-in-box"></ul>');innerContent.append(uldom),target.append(innerContent),eval(fun)(function(e){try{if("0"!=e.code)throw e.message;for(var t in e.data){var i=$('<li class="item ng-scope" ng-repeat="device in deviceitems">                                                <div class="product-info">                                                    <a href="../app-oc/index.html#/#resource/'+e.data[t].modelId+"/"+e.data[t].id+'" class="product-title ng-binding"><span class="label label-primary pull-left ng-binding">'+r(e.data[t].createTime)+"</span>"+e.data[t].label+"</a>                                                </div>                                            </li>");uldom.append(i)}uldom.append($('<a href="../app-oc/index.html#/resource" class="uppercase">查看更多</a>'))}catch(e){}function r(e){var t=/\d{4}\-\d{2}\-\d{2}/.exec(e),i=/\d{2}\:\d{2}\:\d{2}/.exec(e);return null!=t&&null!=i?t+" "+i:e}})}}function listtwo(target,mydata){if(mydata.attributes){var fun=mydata.attributes.fun,innerContent=$("<table width='100%' class='table table-hover no-margin'>"),header=$("<thead><tr><th>工单号</th><th>内容</th><th>紧急度</th></tr></thead>"),tbody=$("<tbody></tbody>");innerContent.append(header).append(tbody),target.append(innerContent);var status=100;eval(fun)(status,function(e){try{if("0"!=e.code)throw e.message;for(var t=0;t<(10<e.data.length?10:e.data.length);t++){var i;0==(r=e.data[t]).priorityCode?i=$('<tr ng-repeat="item in orderList" class="ng-scope">                                            <td><a href="../app-oc/index.html#/orderdetail/'+e.data[t].ticketNo+'/order" class="ng-binding">'+e.data[t].ticketNo+'</a></td>                                            <td class="ng-binding">'+e.data[t].message+'</td>                                            \x3c!-- <td>{{item.statuslab}}</td> --\x3e                                        <td><span class="label alerts-minor">低</span></td>                                    </tr>'):100==r.priorityCode?i=$('<tr ng-repeat="item in orderList" class="ng-scope">                                            <td><a href="../app-oc/index.html#/orderdetail/'+e.data[t].ticketNo+'/order" class="ng-binding">'+e.data[t].ticketNo+'</a></td>                                            <td class="ng-binding">'+e.data[t].message+'</td>                                            \x3c!-- <td>{{item.statuslab}}</td> --\x3e                                        <td><span class="label alerts-major">中</span></td>                                    </tr>'):200==r.priorityCode&&(i=$('<tr ng-repeat="item in orderList" class="ng-scope">                                            <td><a href="../app-oc/index.html#/orderdetail/'+e.data[t].ticketNo+'/order" class="ng-binding">'+e.data[t].ticketNo+'</a></td>                                            <td class="ng-binding">'+e.data[t].message+'</td>                                            \x3c!-- <td>{{item.statuslab}}</td> --\x3e                                        <td><span class="label alerts-critical">高</span></td>                                    </tr>')),tbody.append(i)}}catch(e){}var r;tbody.append($('<tr><td colspan="3"><a href="../app-oc/index.html#/workorder" class="btn btn-sm btn-default btn-flat">查看更多</a></td></tr>'))})}}init(object),$.fn.extend({echart:function echart(){var cur=this,target;function resize(){(target=cur.data("target"))&&target.resize()}function setOption(e){(target=cur.data("target"))&&target.setOption(e,!0)}1==arguments.length?(target=echarts.init(this[0],"macarons"),this.data("target",target),target.setOption(arguments[0].option)):"option"==arguments[0]&&(arguments[2]?eval(arguments[1])(arguments[2]):eval(arguments[1]+"()"))}})}return directive.restrict="A",directive.scope={dashboard:"="},directive.link=function(a,n,e){timeout(function(){variables.dashboardView.then(function(e){var r,t=e.data,i=e.viewId;variables.changeView=function(e){$(n).find("#dropBody").children().remove(),r=new bootEditor({root:$(n).find("#dropBody"),data:e,dashboard:a.dashboard})},r=new bootEditor({root:$(n).find("#dropBody"),data:t,dashboard:a.dashboard}),a.dashboard.save=function(){var e,t,i=a.dashboard.solutionId;i?(e=r.toJSON(),solutionUIService.saveManageViewContent(i,JSON.stringify(e),function(e){0==e.code?(window.open("index.html#/myView","_self"),growl.success("解决方案视图修改成功",{})):growl.error("解决方案视图修改失败",{})})):(e=r.toJSON(),t={viewTitle:"dashboard",viewName:"dashboard",viewType:"dashboard",content:JSON.stringify(e)},viewFlexService.saveManageDashboard(t,function(e){0==e.code?(window.open("index.html","_self"),growl.success("视图首页修改成功",{})):growl.error("视图首页修改失败",{})}))},a.dashboard.delete=function(){viewFlexService.deleteViews([i],function(e){i=void 0,window.open("index.html","_self")})}},function(e){})},100)},directive}directives.initDirective("editBtn",editBtn_directive),editBtn_directive.$inject=["$timeout","variables","$route"],directives.initDirective("colorSelector",colorSelector_directive),colorSelector_directive.$inject=["$timeout","variables"],directives.initDirective("iconSelector",iconSelector_directive),iconSelector_directive.$inject=["$timeout","variables"],directives.initDirective("ciSelectmenu",ciSelectmenu_directive),ciSelectmenu_directive.$inject=["$timeout","variables"],directives.initDirective("aciSelectmenu",aciSelectmenu_directive),aciSelectmenu_directive.$inject=["$timeout","variables"],directives.initDirective("ciSelectmenuChart",ciSelectmenuChart_directive),ciSelectmenuChart_directive.$inject=["$timeout","variables"],directives.initDirective("kpiSelectmenuChart",kpiSelectmenuChart_directive),kpiSelectmenuChart_directive.$inject=["$timeout","variables"],directives.initDirective("kpiSelectmenu",selectmenu_directive),selectmenu_directive.$inject=["$timeout","variables"],directives.initDirective("attrSelectmenu",attrSelectmenu_directive),attrSelectmenu_directive.$inject=["$timeout","variables"],directives.initDirective("bootinputfree",bootinputfree_directive),bootinputfree_directive.$inject=["$timeout","variables"],directives.initDirective("bootinput",bootinput_directive),bootinput_directive.$inject=["$timeout","variables"],directives.initDirective("drag",draggable_directive),draggable_directive.$inject=["$timeout","variables"],directives.initDirective("dashboardDrop",droppable_directive),droppable_directive.$inject=["$q","$timeout","variables","kpiDataService","resourceUIService","viewFlexService","growl","basicline","basicpie","$location","$window","Info","ticketTaskService","solutionUIService"]});
//# sourceMappingURL=../../map/js/directives/dashboard-dom.js.map
