function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}define(["../services/services.js"],function(services){"use strict";function serviceCenterService(q,timeout,userLoginUIService,resourceUIService,dictionaryService,kpiDataService,viewFlexService,window,location,SwSocket,unitService,solutionUIService,Info){var factory={};function getAll(cache){var cached;cached=null==cache||cache;var cur=this,deferred=q.defer();function success(e){delete cur.defer,cur.status="COMPLETE",cur.valueCached=e,deferred.resolve(e)}function error(e){cur.status="ERROR",cur.valueCached=[],cur.errObj=e,deferred.reject(cur.errObj)}return"COMPLETE"==cur.status&&cached?deferred.resolve(cur.valueCached):"INPROGRESS"==cur.status&&cached?cur.promise&&cur.promise.then(success,error):"WAIT"==cur.status||0==cached?(cur.status="INPROGRESS",cur.promise=deferred.promise,eval(cur.fun)(function(e){try{if(!e.data)throw cur.errObj={caller:cur.fun,message:"databack is undefined !!"},cur.errObj;success(e.data)}catch(e){deferred.reject(e)}},error)):"ERROR"==cur.status&&cached&&deferred.reject(cur.errObj),deferred.promise}function getBymodelId(modelId){var cur=this,deferred=q.defer(),findModel=cur.models.find(function(e){return e.id==modelId});if(findModel){if("COMPLETE"==findModel.status){var findValue=cur.valueCached.filter(function(e){return e.modelId==modelId});deferred.resolve(findValue)}else if("INPROGRESS"==findModel.status){var promise=findModel.promise;promise.then(success,error)}}else cur.models.push({id:modelId,promise:deferred.promise,status:"INPROGRESS"}),modelId?eval(cur.fun)(modelId,function(e){try{if(!e.data)throw"API-getBymodelId["+modelId+"]databack is undefined !!";success(e.data)}catch(e){deferred.reject(e)}},error):deferred.reject("modelId为空");function success(e){for(var t in e)e[t].modelId=modelId;var r=cur.models.find(function(e){return e.id==modelId});delete r.promise,r.status="COMPLETE",cur.valueCached=cur.valueCached.filter(function(e){return e.modelId!=modelId}),cur.valueCached=cur.valueCached.concat(e),deferred.resolve(e)}function error(e){}return deferred.promise}return factory.devices=Object.create({status:"WAIT",fun:"resourceUIService.getDevices",getAll:getAll}),factory.resources=Object.create({status:"WAIT",fun:"resourceUIService.getResources",getAll:getAll,getBymodelId:function(r){var e=this,i=q.defer();if("COMPLETE"==e.status){var t=e.valueCached.filter(function(e){return r==e.modelId});i.resolve(t)}else"INPROGRESS"==e.status?e.promise.then(function(e){var t=e.filter(function(e){return r==e.modelId});i.resolve(t)}):"WAIT"==e.status&&e.getAll().then(function(e){var t=e.filter(function(e){return r==e.modelId});i.resolve(t)});return i.promise}}),factory.rootDomain=Object.create({status:"WAIT",fun:"resourceUIService.getRootDomain",get:getAll}),factory.models=Object.create({status:"WAIT",fun:"resourceUIService.getModels",getAll:getAll}),factory.groupModels=Object.create({status:"WAIT",fun:"solutionUIService.getGroupModels",getAll:getAll}),factory.units=Object.create({status:"WAIT",fun:"unitService.getAllUnits",getAll:getAll}),factory.deviceGroups=Object.create({status:"WAIT",fun:"resourceUIService.getDeviceGroups",getAll:getAll}),factory.views=Object.create({status:"WAIT",fun:"viewFlexService.getAllMyViews",getAll:getAll}),factory.deviceGroupModels=Object.create({status:"WAIT",fun:"resourceUIService.getDeviceGroupModels",getAll:getAll}),factory.attrs=Object.create({models:[],valueCached:[],fun:"resourceUIService.getAttrsByModelId",getBymodelId:getBymodelId}),factory.directives=Object.create({models:[],valueCached:[],fun:"resourceUIService.getDirectivesByModelId",getBymodelId:getBymodelId}),factory.getValues=function(r,i,e){var n=q.defer(),t={category:"ci",isRealTimeData:!1,timePeriod:0,nodeIds:r,kpiCodes:i,startTime:null,endTime:null,timeRange:"",statisticType:"psiot",condList:[]};for(var a in e)t[a]=e[a];var o=["kpi",t];return kpiDataService.getValueList(o,function(e){var t;"0"==(t=e).code?n.resolve(t.data):n.reject("通过设备["+r.toString()+"], 指标["+i.toString()+"]获取数据列表失败。")}),n.promise},factory.getValuesByCi=function(o,c,e,t,r){var s,u,d=q.defer();o&&(u=o.map(function(e){return!!e&&e.id})),"alert"==c&&(c=[{id:999999,label:"节点告警状态"}]),s=c.map(function(e){return e.id});var i={category:"ci",isRealTimeData:!0,nodeIds:u,kpiCodes:s,startTime:null,endTime:null,timeRange:"",statisticType:"psiot",condList:[]};r&&(i.orderCond=r),e&&(i.orderType=e),t&&(i.topN=t);var n=["kpi",i];return kpiDataService.getValueList(n,function(e){r?function(e){if("0"==e.code){var t=[],r=[];for(var i in e.data)null!=e.data[i].instance&&(r.push({name:{ci:e.data[i].instance,kpi:""},value:e.data[i]?e.data[i].value:0}),t.push({ci:e.data[i].instance,kpi:""}));d.resolve({series:[{name:{ci:"设备",kpi:"指标"},data:r}],legends:t})}else d.reject("通过设备["+u.toString()+"], 指标["+s.toString()+"]获取数据列表失败。")}(e):function(e){if("0"==e.code){var t=[],r=[];for(var i in o)for(var n in c){var a=e.data.find(function(e){return e.nodeId==o[i].id&&e.kpiCode==c[n].id});r.push({name:{ci:o[i].label,kpi:c[n].label},value:a?a.value:0}),t.push({ci:o[i].label,kpi:c[n].label})}d.resolve({series:[{name:{ci:"设备",kpi:"指标"},data:r}],legends:t})}else d.reject("通过设备["+u.toString()+"], 指标["+s.toString()+"]获取数据列表失败。")}(e)}),d.promise},factory.getValuesByTimealert=function(){var n=q.defer(),e=["alert",{category:"ci",isRealTimeData:!0,timePeriod:0,kpiCodes:["alert_code_count"]}];return kpiDataService.getKpiHierarchyValueList(e,function(e){!function(e){if("0"==e.code){var t=[],r=[];for(var i in e.data.recordList)r.push({name:e.data.recordList[i].category,value:e.data.recordList[i].alert_code_count}),t.push(e.data.recordList[i].category);n.resolve({series:[{name:"设备，指标",data:r}],legends:t})}else n.reject("通过设备[alert_code_count]方法，获取数据列表失败。")}(e)}),n.promise},factory.getValuesList=function(e,t){var s=q.defer(),r=["kpi",{category:"time",isRealTimeData:!0,timePeriod:864e5,nodeIds:e,kpiCodes:t,startTime:null,endTime:null,timeRange:"",statisticType:"psiot",condList:[]}];return kpiDataService.getValueList(r,function(e){!function(i){var n,a;"0"==i.code&&function(e){n=0;var t=(t=i.data).reduce(c,{});for(var r in t)t[r]=t[r].reduce(o,[]);s.resolve(t)}();function o(e,t){var r=new Date(t.arisingTime).getTime();return 0==e.length?(a=r,[t]):(r-a<n||(a=r,e.push(t)),e)}function c(e,t){var r=t.nodeId+"?"+t.kpiCode;return e.hasOwnProperty(r)?e[r].push(t):e[r]=[t],e}}(e)}),s.promise},factory.getValueListBytime=function(nodesDescription,kpisDescription,timespan,frequency,format,category,type,method,cod,extension,kpiQueryModel){var deferred=q.defer(),nodeDefers=[],instance,nodes=[],kpis=[],nodesDes=[],kpisDes=[],aggregate_type=[],modelId,customCategory,simulate,aggregate_rule,autoFillBlank,condition=cod.$clone(),getTime=function(e){if(!e)return 0;switch(e.unit){case"second":return 1e3*e.value;case"minute":return 60*e.value*1e3;case"hour":return 60*e.value*60*1e3;case"day":return 24*e.value*60*60*1e3;case"month":return 30*e.value*24*60*60*1e3;default:return e.value}},merge=function(e,t){require(["../../toolkit/component/explainer/"+(customCategory||e)],function(e){t(e)})},defers=[],rs={},getValueList=function getValueList(type,category,method,condition){var cond;condition instanceof Array?(cond=condition,"object"==_typeof(condition[1])&&(cond[1].startTime=condition[1].startTime),"object"==_typeof(condition[1])&&(cond[1].endTime=condition[1].endTime)):cond=condition;var object={kpiQueryModel:kpiQueryModel||{category:category,isRealTimeData:!0,nodeIds:nodes,kpiCodes:kpis,startTime:null,endTime:null,timeRange:"",statisticType:"psiot",includeInstance:!0,condList:[]}};if(extension&&(object.kpiQueryModel.aggregateType=aggregate_type=extension.aggregate_type,object.kpiQueryModel.granularityUnit=extension.granularityUnit,extension.aggregate_instance instanceof Array&&0<extension.aggregate_instance.length&&(object.kpiQueryModel.instances=extension.aggregate_instance),aggregate_rule=extension.aggregate_rule,autoFillBlank=extension.autoFillBlank),"time"==category){var tspan=getTime(timespan);object.kpiQueryModel.timePeriod=tspan||864e5}var traverse=function r(i){var e=function(e,t){"object"==_typeof(t)?r(t):"string"==typeof t&&(i[e]=function(e){var t=/^\{object\:(\w+)\}$/.exec(e);if(null==t)return e;var r=t[1];return object[r]}(t))};for(var t in i)e(t,i[t])},params=[],callback=function(r){merge(category,function(e){0==nodesDes.length||kpisDes.length;var t={Info:Info,format:format,frequency:getTime(frequency),timespan:getTime(timespan),freqObj:frequency,nodesDes:nodesDes,kpisDes:kpisDes,instance:instance,aggregate_type:aggregate_type,aggregate_rule:aggregate_rule,autoFillBlank:autoFillBlank,dictionaryService:dictionaryService,kpiDataService:kpiDataService,resourceUIService:resourceUIService,q:q};simulate&&(t.simulate=simulate);e(0==r.code?r.data:[],t,function(e){rs[category]=e,deferred.resolve(rs)})})};""!=cond&&("object"==_typeof(cond)&&traverse(cond),params.push(cond)),params.push(callback),eval(method).apply(null,params)},loopNode=function(r){var i=q.defer();if("object"==_typeof(r))timeout(function(){nodes.push(r.id),modelId=r.modelId,nodesDes.push(r),i.resolve("success")},100);else{nodes.push(parseInt(r)),factory.resources.getAll().then(function(e){var t=e.find(function(e){return e.id==r});t&&(nodesDes.push(t),modelId=t.modelId),i.resolve("success")})}return i.promise},nodeLoaded=function(e){var t=function(r){var i=q.defer();if("object"==_typeof(r))kpis.push(r.id),kpisDes.push(r),i.resolve("success");else{kpis.push(parseInt(r)),modelId&&factory.kpis.getBymodelId(modelId).then(function(e){var t=e.find(function(e){return e.id==r});kpisDes.push(t),i.resolve("success")})}};for(var r in kpisDescription)t(kpisDescription[r]);q.all([]).then(function(e){getValueList(type,category,method,condition)})},init=function(){for(var e in nodesDescription)nodeDefers.push(loopNode(nodesDescription[e]));q.all(nodeDefers).then(nodeLoaded)},simuData=function(r){aggregate_rule=extension.aggregate_rule,autoFillBlank=extension.autoFillBlank,merge(category,function(e){0==nodesDes.length||kpisDes.length;var t={Info:Info,format:format,frequency:getTime(frequency),nodesDes:nodesDescription,kpisDes:kpisDescription,instance:instance,aggregateType:aggregate_type,aggregate_rule:aggregate_rule,autoFillBlank:autoFillBlank,dictionaryService:dictionaryService,kpiDataService:kpiDataService,resourceUIService:resourceUIService,q:q};simulate&&(t.simulate=simulate);e(r,t,function(e){rs[category]=e,deferred.resolve(rs)})})};if(extension)if(extension.simuData)simuData(extension.simuData);else{simulate=extension.simulate,customCategory=extension.customCategory;var instanceId=extension.aggregate_instance,insCode;0==instanceId||(insCode=1==instanceId?"industryType":2==instanceId?"energyType":3==instanceId?"energyType":4==instanceId?"industryShortType":"industryType"),insCode?dictionaryService.getDictValues(insCode,function(e){0==e.code&&(instance=e.data,init())}):init()}else init();return deferred.promise},factory.getValuesListAndMergeByTime=function(m,v,e,t,g){var y=t,I=q.defer(),h=m.map(function(e){return e.id}),S=v.map(function(e){return e.id}),r=["kpi",{category:"time",isRealTimeData:!0,timePeriod:e||864e5,nodeIds:h,kpiCodes:S,startTime:null,endTime:null,timeRange:"",statisticType:"psiot",condList:[]}];return kpiDataService.getValueList(r,function(e){!function(e){var t,r;if("0"==e.code){t=y||0;var i=e.data,u=[],d=[],o=[],i=i.map(function(e){var t=new Date(e.arisingTime).getTime();return{kpiCode:e.kpiCode,nodeId:e.nodeId,time:e.arisingTime,timeStamp:t,value:e.value}}),n=i.map(function(e){return e.timeStamp}),a=Math.min.apply(null,n),c=Math.max.apply(null,n),s=a;if(0<t)for(;s<=c;)d.push(s),s+=t;else d=n;if(d[d.length-1]!=c&&d.push(c),"scatter"==g){var l=i.reduce(function(e,t){var r=t.nodeId,i=t.kpiCode,n=m.find(function(e){return e.id==r}),a=v.find(function(e){return e.id==i}),o=e.find(function(e){return e.resource.id==r});if(o){o.valueGroup;var c=o.valueGroup.find(function(e){return e.kpi.id==i});c?c.data.push({time:t.time,timeStamp:t.timeStamp,value:t.value}):o.valueGroup.push({kpi:a,data:[{time:t.time,timeStamp:t.timeStamp,value:t.value}]})}else e.push({resource:n,valueGroup:[{kpi:a,data:[{time:t.time,timeStamp:t.timeStamp,value:t.value}]}]});return e},[]);for(var f in l)!function(e,t){if(u[f]={},u[f].name={ci:t.resource.label},0<d.length){u[e].data=[];for(var r=0;r<d.length-1;r++){var i=d[r],n=d[r+1],a=[];for(var o in t.valueGroup)c=t.valueGroup[o],s=void 0,s=c.data.find(function(e){return i<=e.timeStamp&&e.timeStamp<n}),a.push(s?s.value:void 0);u[e].data.push(a)}}else u[f].data=[];var c,s}(f,l[f])}else{var p=i.reduce(function(e,t){var r=t.nodeId,i=t.kpiCode,n=m.find(function(e){return e.id==r}),a=v.find(function(e){return e.id==i}),o=e.find(function(e){return e.resource.id==r&&e.kpi.id==i});o?o.valueList.push({time:t.time,timeStamp:t.timeStamp,value:t.value}):e.push({resource:n,kpi:a,valueList:[{time:t.time,timeStamp:t.timeStamp,value:t.value}]});return e},[]);for(var f in p)!function(e,t){if(u[f]={},u[f].name={ci:t.resource.label,kpi:t.kpi.label},o.push({ci:t.resource.label,kpi:t.kpi.label}),0<d.length){u[e].data=[];for(var r=0;r<d.length-1;r++){var i=d[r],n=d[r+1],a=t.valueList.find(function(e){return i<=e.timeStamp&&e.timeStamp<n});u[e].data.push(a?a.value:void 0)}}else u[f].data=[]}(f,p[f])}r={xAxis:d,series:u,legend:o},I.resolve(r)}else I.reject("通过设备["+h.toString()+"], 指标["+S.toString()+"]获取数据列表失败。")}(e)}),I.promise},factory.kpis=Object.create({models:[],valueCached:[],fun:"resourceUIService.getKpisByModelId",getMinTimeSpan:function(e){var t=q.defer();return resourceUIService.getKpisByKpiIds(e,function(e){e.minTimespan&&t.resolve(e.minTimespan)},function(e){}),t.promise},getByKpiIds:function(e){var i,r,n=q.defer(),a=this;return i=[],r=[],function(){for(var e in arguments)!function(t){var e=a.valueCached.filter(function(e){return t==e.id});0<e.length?i.push(e[0]):r.push(t)}(arguments[e])}.apply(null,e),resourceUIService.getKpisByKpiIds(r,function(e){try{if(!e)throw"data is undefined !!";var t=[];for(var r in delete e.minTimespan,e)t.push(e[r]),a.valueCached.push(e[r]);n.resolve(i.concat(t))}catch(e){n.reject(e)}},function(e){throw e}),n.promise},getBymodelId:getBymodelId}),factory}services.factory("serviceCenterService",serviceCenterService),serviceCenterService.$inject=["$q","$timeout","userLoginUIService","resourceUIService","dictionaryService","kpiDataService","viewFlexService","$window","$location","SwSocket","unitService","solutionUIService","Info"]});
//# sourceMappingURL=../../map/js/services/service-center-service.js.map
