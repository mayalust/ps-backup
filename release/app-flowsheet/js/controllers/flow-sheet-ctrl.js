define(["controllers/controllers","keyboardJS","rappid-joint"],function(e,N,D){"use strict";e.controller("flowCtrl",["$scope","workflowService","workflowDefinitionService","Info","$routeParams","$compile","$rootScope","userEnterpriseService","viewFlexService","resourceUIService","kpiDataService","SwSocket","growl","$timeout","$location",function(l,i,a,e,t,d,n,r,o,s,c,p,u,m,g){var f,h,w,y,v,b,S,k,I=t.viewId,T=function(){},x=!(l.selectedView={}),V=!1,E=!1,C=!1;l.userGroupList="",l.userList="",l.userAryList="",l.userRoleList="",-1<location.hash.search("#/displayView")&&(x=!0),-1<location.hash.search("#/historyView")&&(C=!0);var G={arrowheadMarkup:"<g></g>",toolMarkup:"<g></g>",vertexMarkup:"<g></g>"};l.selectedItem={cell:null,userIds:0,userGroupIds:0,roleIds:0,taskType:0,taskTypeParam:"user",userType:""},N.bind("shift",function(e){V=!0},function(e){V=!1}),N.bind("shift",null,function(e){V=!1}),N.bind("backspace",function(e){E=!0},function(e){E=!1}),N.bind("backspace",null,function(e){E=!1}),l.evenType="start";l.initialization=[function(e,t){var n=!1;x||(n=!0),h=new D.dia.Graph({type:"bpmn"}),f=new D.dia.Paper({width:1200,height:700,gridSize:10,perpendicularLinks:!0,model:h,markAvailable:!0,interactive:n,defaultLink:new D.shapes.bpmn.Flow,validateConnection:function(e,t,n,o,i,a){return e!=n&&!(("target"===i?n:e)instanceof D.dia.LinkView)},embeddingMode:!0,frontParentOnly:!1,validateEmbedding:function(e,t){var n=D.shapes.bpmn.Pool;return t.model instanceof n&&!(e.model instanceof n)}}),(w=new D.ui.PaperScroller({paper:f,autoResizePaper:!0,padding:0})).$el.css("background-color","hsl(0, 0%, 100%)"),$("#paper-container1",t).append(w.el),e.components.paper=f,e.components.scroller=w,e.components.graph=h},function(e,t){function n(e){D.layout.GridLayout.layout(e,{columnWidth:y.options.width/2-10,columns:2,rowHeight:80,resizeToFit:!0,dy:10,dx:10})}y=new D.ui.Stencil({graph:h,paper:f,width:230,dropAnimation:!0,groups:e.data.stencil.groups,search:e.data.stencil.search}).on("filter",n),$(".stencil-container",t).append(y.render().el),_.each(e.data.stencil.shapes,function(e,t){y.load(e,t),n(y.getGraph(t)),y.getPaper(t).fitToContent(1,1,10)}),e.components.stencil=y},function(o,e){v=new Backbone.Collection,S=new D.ui.SelectionView({paper:f,graph:h,model:v}),f.on("blank:pointerdown",function(e,t,n){o.selectedView.inspector=V?(S.startSelecting(e,t,n),!0):(S.cancelSelection(),w.startPanning(e,t,n),!1),o.$apply()}),f.on("element:pointerup",function(e,t){if("bpmn.Activity"===e.model.get("type"))$(t.target).closest(".lane").data("lane-path")}),f.on("cell:pointerdown",function(e,t){!t.ctrlKey&&!t.metaKey||e.model instanceof D.dia.Link||(S.createSelectionBox(e),v.add(e.model))}),S.on("selection-box:pointerdown",function(e){if(e.ctrlKey||e.metaKey){var t=v.get($(e.target).data("model"));S.destroySelectionBox(f.findViewByModel(t)),v.reset(v.without(t))}}),f.el.oncontextmenu=function(e){e.preventDefault()},N.on("delete, backspace",function(e){$.contains(e.target,f.el)&&(k.initBatchCommand(),v.invoke("remove"),k.storeBatchCommand(),S.cancelSelection(),E&&!$(e.target).is("input, textarea")&&e.preventDefault())})},function(s,e){var c=$(".inspector-container",e);function i(e){var o=e.model||e;if(x?new D.ui.Halo({cellView:e}).render().removeHandles():new D.ui.Halo({cellView:e}).render(),!l.selectedItem.cell||l.selectedItem.cell.id!=o.id){var t,n={cell:null,userIds:0,userGroupIds:0,roleIds:0,taskType:0,taskTypeParam:"user",userType:""};if(T(),T=l.$watch("selectedItem.dataExtractExpression",function(e,t,n){e&&o.prop("dataExtractExpression",e)}),(n.cell=o).get("userType")){var i=o.get("userType").toString().split(":");0<i.length&&"?"!=i[i.length-1]&&(n.userType=String(i[i.length-1]))}if(o.get("userIds"))0<(t=o.get("userIds").toString().split(":")).length&&"?"!=t[t.length-1]&&(n.userIds=Number(t[t.length-1]));if(o.get("userGroupIds"))0<(t=o.get("userGroupIds").toString().split(":")).length&&"?"!=t[t.length-1]&&(n.userGroupIds=Number(t[t.length-1]));if(o.get("roleIds"))0<(t=o.get("roleIds").toString().split(":")).length&&"?"!=t[t.length-1]&&(n.roleIds=Number(t[t.length-1]));if(o.get("content")&&(n.content=o.get("content")),o.get("taskType")){var a=o.get("taskType").toString().split(":");0<a.length&&"?"!=a[a.length-1]&&(n.taskTypeParam=String(a[a.length-1]))}if("bpmn.Activity"==o.get("type")&&"service"==o.get("icon")?(n.taskType="2",n.taskTypeParam="service"):(n.taskType="0",n.taskTypeParam="user"),n.dataExtractExpression=o.get("dataExtractExpression"),l.selectedItem=n,!b||b.options.cell!==o){b&&b.remove();var r=s.inspectorDefs[o.get("type")];b=new D.ui.Inspector({inputs:r&&r.inputs?r.inputs:s.commonInspectorInputs,groups:r&&r.groups?r.groups:s.commonInspectorGroups,cell:o}).on("render",function(){this.$("[data-tooltip]").each(function(){var e=$(this);new D.ui.Tooltip({target:e,content:e.data("tooltip"),right:".inspector",direction:"right"})}),d(c)(l)}),s.selectedView.inspector=!0,s.$apply(),c.html(b.render().el),d(c)(l)}S.cancelSelection(),v.reset([e.model])}}f.on("cell:pointerup",function(e){x||e.model instanceof D.dia.Element&&!v.contains(e.model)&&(s.selectedView.inspector=!0,s.$apply(),i(e))}),S.on("selection-box:pointerdown",function(e){if(e.ctrlKey||e.metaKey){var t=v.get($(e.target).data("model"));S.destroySelectionBox(f.findViewByModel(t)),v.reset(v.without(t))}}),f.on("link:options",function(e,t,n,o){i(t)})},function(e,t){$(".toolbar-container [data-tooltip]",t).each(function(){new D.ui.Tooltip({target:$(this),content:$(this).data("tooltip"),top:".toolbar-container",direction:"top"})})},function(i,e){k=new D.dia.CommandManager({graph:h}),N.on("ctrl + z",function(){k.undo(),S.cancelSelection()}),N.on("ctrl + y",function(){k.redo(),S.cancelSelection()}),i.components.commander=k,i.components.commander.setDimensions=function(){f.setDimensions(f.options.width,f.options.height),w.options.baseWidth=f.options.width,w.options.baseHeight=f.options.height,w.$el.css("padding-top",0)},i.components.commander.mould=function(){if(""!=i.data.mouldType&&null!=i.data.mouldType)for(var e in i.data.mould)i.data.mould[e].content==i.data.mouldType&&i.components.graph.fromJSON(i.data.mould[e].view)},i.components.commander.setGrid=function(){var e=f.options.gridSize,t=n(e);i.data.bgcolor?f.$el.css("background-color",i.data.bgcolor):(f.$el.css("background-color","#fff"),f.$el.css("box-shadow","0 0 2px white")),i.data.bgimage?x?(f.$el.css("background-image",'url(""),url("'+i.data.bgimage+'")'),f.$el.css("margin-right",0)):f.$el.css("background-image",'url("'+t+'"),url("'+i.data.bgimage+'")'):x?(f.$el.css("background-image",'url(""),url("")'),f.$el.css("margin-right",0)):f.$el.css("background-image",'url("'+t+'")')};var n=function(e,t){var n=$("<canvas/>",{width:e,height:e});n[0].width=e,n[0].height=e;var o=n[0].getContext("2d");return o.beginPath(),o.rect(1,1,1,1),o.fillStyle=t||"#AAAAAA",o.fill(),n[0].toDataURL("image/png")};i.components.commander.save4Json=function(){var e=h.toJSON(),t=!0;if(e.cells.forEach(function(e){"bpmn.Activity"==e.type&&"user"==e.taskType&&(""==e.userType&&(u.warning("请选择{"+e.content+"}任务的处理类型",{}),t=!1),"user"!=e.userType||e.userIds||(u.warning("请设置{"+e.content+"}任务的处理用户",{}),t=!1),"expression"!=e.userType||e.userExpression||(u.warning("请设置{"+e.content+"}任务的用户表达式",{}),t=!1),"role"!=e.userType||e.roleIds||(u.warning("请设置{"+e.content+"}任务的处理角色",{}),t=!1),"userGroup"!=e.userType||e.userGroupIds||(u.warning("请设置{"+e.content+"}任务的处理用户组",{}),t=!1))}),t){e.gridSize=f.options.gridSize,e.width=f.options.width,e.height=f.options.height,e.bgimage=i.data.bgimage,e.bgcolor=i.data.bgcolor;var n=JSON.stringify(e);try{var o={id:i.selectedView.id,domainPath:"",name:i.selectedView.name,desc:i.selectedView.desc,viewContent:n,createTime:i.selectedView.createTime,updateTime:i.selectedView.updateTime};0==o.viewId?a.saveWorkflowDefinition(o,function(e){0==e.code&&u.success("保存成功")}):a.saveWorkflowDefinition(o,function(e){0==e.code&&u.success("保存成功")})}catch(e){alert(e)}}},i.components.commander.toJSON=function(){var e=_.uniqueId("json_output");window.open("",e,"menubar=no,location=no,resizable=yes,scrollbars=yes,status=no").document.write(JSON.stringify(h.toJSON()))},i.components.commander.toFront=function(){v.invoke("toFront")},i.components.commander.toBack=function(){v.invoke("toBack")},i.components.commander.embed=function(){var t;S.model.models.forEach(function(e){t?t.attributes.z>e.attributes.z&&(t=e):t=e}),S.model.models.forEach(function(e){t.id!=e.id&&t.embed(e)})},i.components.commander.unembed=function(){S.model.models.forEach(function(t){t.attributes.embeds&&t.attributes.embeds.forEach(function(e){t.unembed(h.getCell(e))})})}},function(e,t){var o,n;r.queryEnterpriseGroup(function(e){if(0==e.code)if(0!=e.data.length){var t=[];for(var n in e.data){var o={};o.id=e.data[n].groupID,o.name=e.data[n].groupName,t.push(o)}l.userGroupList=t}else l.userGroupList=[]}),r.queryEnterpriseUser(function(e){if(0==e.code)if(0!=e.data.length){var t={},n=[];for(var o in e.data)(t={}).id=e.data[o].userID,t.name=e.data[o].userName,n.push(t);l.userAryList=n}else l.userAryList=[]}),r.queryEnterpriseRole(function(e){if(0==e.code)if(0!=e.data.length){var t={},n=[];for(var o in e.data)(t={}).id=e.data[o].roleID,t.name=e.data[o].roleName,n.push(t);l.userRoleList=n}else l.userRoleList=[]}),o=e,n=I,C?i.getWorkflowById(n,function(e){if(0==e.code)if(o.selectedView=e.data,o.data.viewContent=l.selectedView.viewContent,o.selectedView.inspector=!1,e.data.viewContent){var t=JSON.parse(e.data.viewContent);if(x)for(var n=t.cells.length-1;-1<n;n--)"bpmn.Flow"==t.cells[n].type&&(jQuery.extend(t.cells[n],G),t.cells[n].attrs[".connection-wrap"]={display:"none"});o.components.graph.fromJSON(t),o.components.paper.options.gridSize=t.gridSize,o.components.paper.options.width=t.width,o.components.paper.options.height=t.height,o.data.bgimage=t.bgimage,o.data.bgcolor=t.bgcolor,o.data.mouldType="",o.data.width=t.width,o.data.height=t.height,o.components.commander.setDimensions(),o.components.commander.setGrid()}else o.components.graph.fromJSON(o.data.init)}):a.getWorkflowDefinitionById(n,function(e){if(0==e.code)if(o.selectedView=e.data,o.data.viewContent=l.selectedView.viewContent,o.selectedView.inspector=!1,e.data.viewContent){var t=JSON.parse(e.data.viewContent);if(x)for(var n=t.cells.length-1;-1<n;n--)"bpmn.Flow"==t.cells[n].type&&(jQuery.extend(t.cells[n],G),t.cells[n].attrs[".connection-wrap"]={display:"none"});o.components.graph.fromJSON(t),o.components.paper.options.gridSize=t.gridSize,o.components.paper.options.width=t.width,o.components.paper.options.height=t.height,o.data.bgimage=t.bgimage,o.data.bgcolor=t.bgcolor,o.data.mouldType="",o.data.width=t.width,o.data.height=t.height,o.components.commander.setDimensions(),o.components.commander.setGrid()}else o.components.graph.fromJSON(o.data.init)})}]}])});
//# sourceMappingURL=../../../map/app-flowsheet/js/controllers/flow-sheet-ctrl.js.map
