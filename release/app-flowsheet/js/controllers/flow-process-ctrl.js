define(["controllers/controllers","keyboardJS","rappid-joint"],function(e,V,D){"use strict";e.controller("flowProcessCtrl",["$scope","ticketLogService","ticketTaskService","workflowService","workflowDefinitionService","Info","$routeParams","$compile","$rootScope","userEnterpriseService","viewFlexService","resourceUIService","kpiDataService","SwSocket","growl","$timeout","$location",function(s,n,i,a,r,e,t,o,c,l,d,u,p,f,m,g,w){var h,k,v,b,y,S,T,x=t.viewId,I=(s.selectedView="",!1),N=!1;s.userGroupList="",s.userList="",s.userAryList="";var C={arrowheadMarkup:"<g></g>",toolMarkup:"<g></g>",vertexMarkup:"<g></g>"};s.selectedItem={cell:null,userIds:0,userGroupIds:0,userType:""},V.bind("shift",function(e){I=!0},function(e){I=!1}),V.bind("shift",null,function(e){I=!1}),V.bind("backspace",function(e){N=!0},function(e){N=!1}),V.bind("backspace",null,function(e){N=!1}),s.evenType="start",s.historyGo=function(){var e=t.state;"task"==s.workType?location.href="index.html#/workOrderRecord/"+e:"alert"==s.workType?location.href="index.html#/configAlert":"manage"==s.workType?location.href="index.html#/workOrder/"+e:"message"==s.workType?location.href="../app-uc/index.html#/message":"read"==s.workType?location.href="../app-uc/index.html#/read":"unread"==s.workType&&(location.href="../app-uc/index.html#/unread")},s.viewShow=function(c,s,l,e){i.getTicket(e,function(e){if(0==e.code){for(var t={fill:"#ff8040"},o={fill:"#13c865"},n={fill:"#ffff00"},i={fill:"#cccccc"},a=l.cells.length-1;-1<a;a--)for(var r in"bpmn.Flow"==l.cells[a].type&&(jQuery.extend(l.cells[a],C),l.cells[a].attrs[".connection-wrap"]={display:"none"}),"end"==l.cells[a].eventType&&200==e.data.status&&(l.cells[a].attrs[".body"]=o),s)if("userTask"==s[r].logType){if(l.cells[a].id==s[r].workflowNodeId){if(l.cells[a].desc=s[r].desc,100==s[r].ticketTask.taskStatus){l.cells[a].attrs[".body"]=t;break}if(200==s[r].ticketTask.taskStatus){l.cells[a].attrs[".body"]=o;break}if(10==s[r].ticketTask.taskStatus){l.cells[a].attrs[".body"]=n;break}}}else if("startEvent"==s[r].logType){if(l.cells[a].id==s[r].workflowNodeId){l.cells[a].attrs[".body"]=o;break}}else if("exclusiveGateway"==s[r].logType){if(l.cells[a].id==s[r].workflowNodeId){l.cells[a].attrs[".body"]=o;break}}else if("serviceTask"==s[r].logType){if(l.cells[a].id==s[r].workflowNodeId){l.cells[a].attrs[".body"]=o;break}}else if("notExecute"==s[r].logType&&l.cells[a].id==s[r].workflowNodeId){l.cells[a].attrs[".body"]=i;break}c.components.graph.fromJSON(l),c.components.paper.options.gridSize=l.gridSize,c.components.paper.options.width=l.width,c.components.paper.options.height=l.height,c.data.bgimage=l.bgimage,c.data.bgcolor=l.bgcolor,c.data.width=l.width,c.data.height=l.height,c.components.commander.setDimensions(),c.components.commander.setGrid()}})};s.initialization=[function(e,t){var o=!1;k=new D.dia.Graph({type:"bpmn"}),h=new D.dia.Paper({width:1200,height:700,gridSize:10,perpendicularLinks:!0,model:k,markAvailable:!0,interactive:o,defaultLink:new D.shapes.bpmn.Flow,validateConnection:function(e,t,o,n,i,a){return e!=o&&!(("target"===i?o:e)instanceof D.dia.LinkView)},embeddingMode:!0,frontParentOnly:!1,validateEmbedding:function(e,t){var o=D.shapes.bpmn.Pool;return t.model instanceof o&&!(e.model instanceof o)}}),v=new D.ui.PaperScroller({paper:h,autoResizePaper:!0,padding:0}),$("#paper-container1",t).append(v.el),e.components.paper=h,e.components.scroller=v,e.components.graph=k},function(e,t){function o(e){D.layout.GridLayout.layout(e,{columnWidth:b.options.width/2-10,columns:2,rowHeight:80,resizeToFit:!0,dy:10,dx:10})}b=new D.ui.Stencil({graph:k,paper:h,width:230,dropAnimation:!0,groups:e.data.stencil.groups,search:e.data.stencil.search}).on("filter",o),$(".stencil-container",t).append(b.render().el),_.each(e.data.stencil.shapes,function(e,t){b.load(e,t),o(b.getGraph(t)),b.getPaper(t).fitToContent(1,1,10)}),e.components.stencil=b},function(e,t){y=new Backbone.Collection,S=new D.ui.SelectionView({paper:h,graph:k,model:y}),h.on("blank:pointerdown",function(e,t,o){I?S.startSelecting(e,t,o):(S.cancelSelection(),v.startPanning(e,t,o))}),h.on("cell:pointerdown",function(e,t){!t.ctrlKey&&!t.metaKey||e.model instanceof D.dia.Link||(S.createSelectionBox(e),y.add(e.model))}),S.on("selection-box:pointerdown",function(e){if(e.ctrlKey||e.metaKey){var t=y.get($(e.target).data("model"));S.destroySelectionBox(h.findViewByModel(t)),y.reset(y.without(t))}}),h.el.oncontextmenu=function(e){e.preventDefault()},V.on("delete, backspace",function(e){$.contains(e.target,h.el)&&(T.initBatchCommand(),y.invoke("remove"),T.storeBatchCommand(),S.cancelSelection(),N&&!$(e.target).is("input, textarea")&&e.preventDefault())})},function(a,e){var r;$(".inspector-container",e);h.on("cell:pointerup",function(e){!function(e){a.components.cellView=e,r&&(r.updateCell(),r.remove());var t=a.selectedTask.taskDefinitionId.split("id");if(a.data.flowOrder,e.model.id==t[1]&&200!=a.selectedTask.taskStatus)r=new D.ui.Inspector({inputs:s.inputsList,cellView:e});else{var o="";for(var n in a.data.flowOrder){var i=a.data.flowOrder[n].taskDefinitionId.split("id");if(e.model.id==i[1]){o=1;break}}r=1==o?new D.ui.Inspector({inputs:{desc:{type:"textarea",group:"属性",label:"处理记录",index:1,attrs:{textarea:{class:"form-control input-sm","ng-model":"selectedTask.desc",disabled:"disabled",style:"height: 100px;"}}}},cellView:e}):new D.ui.Inspector({cellView:e})}$(".inspector-container").html(r.render().el)}(e)}),h.on("link:options",function(e,t,o,n){openCellTools(t)})},function(n,e){T=new D.dia.CommandManager({graph:k}),V.on("ctrl + z",function(){T.undo(),S.cancelSelection()}),V.on("ctrl + y",function(){T.redo(),S.cancelSelection()}),n.components.commander=T,n.components.commander.setDimensions=function(){h.setDimensions(h.options.width,h.options.height),v.options.baseWidth=h.options.width,v.options.baseHeight=h.options.height,v.$el.css("padding-top",0)},n.components.commander.setGrid=function(){var e=h.options.gridSize;t(e);n.data.bgcolor?h.$el.css("background-color",n.data.bgcolor):h.$el.css("background-color","#fff"),n.data.bgimage?h.$el.css("background-image",'url(""),url("'+n.data.bgimage+'")'):h.$el.css("background-image",'url(""),url("")'),h.$el.css("margin-right",0)};var t=function(e,t){var o=$("<canvas/>",{width:e,height:e});o[0].width=e,o[0].height=e;var n=o[0].getContext("2d");return n.beginPath(),n.rect(1,1,1,1),n.fillStyle=t||"#AAAAAA",n.fill(),o[0].toDataURL("image/png")};n.components.commander.save=function(o){n.selectedTask.taskStatus=o,n.selectedTask.desc=$("textarea").val(),i.doTask(n.selectedTask,function(e){if(0==e.code)if(100==o){var t=new D.ui.Inspector({inputs:{attrs:{".body":{fill:"red"}}},cellView:n.components.cellView});$(".inspector-container").html(t.render().el),m.success("任务已确认",{})}else 200==o&&(m.success("任务已完成",{}),location.href="../app-oc/index.html#/workorderrecord");else m.success("任务操作失败",{})})},n.components.commander.save4Json=function(){var e=k.toJSON();e.gridSize=h.options.gridSize,e.width=h.options.width,e.height=h.options.height,e.bgimage=n.data.bgimage,e.bgcolor=n.data.bgcolor;var t=JSON.stringify(e);try{var o={id:n.selectedView.id,domainPath:"",name:n.selectedView.name,desc:n.selectedView.desc,viewContent:t,createTime:n.selectedView.createTime,updateTime:n.selectedView.updateTime};0==o.viewId?r.saveWorkflowDefinition(o,function(e){0==e.code&&m.success("保存成功")}):r.saveWorkflowDefinition(o,function(e){0==e.code&&m.success("保存成功")})}catch(e){alert(e)}},n.components.commander.toJSON=function(){var e=_.uniqueId("json_output");window.open("",e,"menubar=no,location=no,resizable=yes,scrollbars=yes,status=no").document.write(JSON.stringify(k.toJSON()))},n.components.commander.toFront=function(){y.invoke("toFront")},n.components.commander.toBack=function(){y.invoke("toBack")},n.components.commander.embed=function(){var t;S.model.models.forEach(function(e){t?t.attributes.z>e.attributes.z&&(t=e):t=e}),S.model.models.forEach(function(e){t.id!=e.id&&t.embed(e)})},n.components.commander.unembed=function(){S.model.models.forEach(function(t){t.attributes.embeds&&t.attributes.embeds.forEach(function(e){t.unembed(k.getCell(e))})})}},function(e,t){var c,o;l.queryEnterpriseGroup(function(e){if(0==e.code)if(0!=e.data.length){var t={},o=[];for(var n in e.data)t.id=e.data[n].groupID,t.name=e.data[n].groupName,o.push(t);s.userGroupList=o}else s.userGroupList=[]}),l.queryEnterpriseUser(function(e){if(0==e.code)if(0!=e.data.length){var t={},o=[];for(var n in e.data)(t={}).id=e.data[n].userID,t.name=e.data[n].userName,o.push(t);s.userAryList=o}else s.userAryList=[]}),c=e,o=x,i.getTicketTaskById(o,function(r){0==r.code&&(c.selectedTask=r.data,a.getWorkflowById(r.data.processDefinitionId,function(e){if(0==e.code&&(c.selectedView=e.data,c.data.viewContent=s.selectedView.viewContent,e.data.viewContent)){var a=JSON.parse(e.data.viewContent);e.data.handerConfs.length,n.getHistoricActivityInstance(r.data.ticketNo,function(e){if(0==e.code&&""!=e.data&&null!=e.data){var t=e.data.notExecute,o=e.data.executed;if(t&&0<t.length)for(var n in t){var i={id:0,ticketNo:"",message:"",executeTime:"",logType:"notExecute",ticketTask:"",workflowNodeId:""};i.workflowNodeId=t[n],o.push(i)}s.viewShow(c,o,a,r.data.ticketNo)}})}}))})}]}])});
//# sourceMappingURL=../../../map/app-flowsheet/js/controllers/flow-process-ctrl.js.map
