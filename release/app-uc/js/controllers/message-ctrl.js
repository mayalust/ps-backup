define(["controllers/controllers","bootstrap-dialog"],function(controllers,BootstrapDialog){"use strict";controllers.initController("AllMessageCtrl",["$scope","$location","userLoginUIService","configUIService","psMessageService","growl",function($scope,$location,userLoginUIService,configUIService,psMessageService,growl){$scope.msgStatus="全部消息",$scope.statusMsg="0",$scope.messageList="",$scope.readMsgStatus=$location.path();var chGMT=function(e){return new Date(e).Format("yyyy-MM-dd hh:mm:ss")};$scope.msgGridData={columns:[$.ProudSmart.datatable.selectCol,{title:"消息标题",data:"message.title"},{title:"接收时间",data:"message.insertTime"},{title:"消息类型",data:"message.msgType"}],columnDefs:[{targets:0,orderable:!1,data:"message.messageId",render:function(e,s,a){return"display"==s?e?'<input class="itemCheckBox" value="'+a.message.messageId+'" checked type="checkbox">':'<input class="itemCheckBox" value="'+a.message.messageId+'" type="checkbox">':""}},{targets:1,data:"message.title",render:function(e,s,a){return 0==a.status?'<dt><a href class="hov-slide" style="color: #444;" >'+e+"</a></dt>":'<span class="contacts-list-msg"><a  href style="color: #999;"   class="hov-slide"  >'+e+"</a></span>"}},{targets:2,data:"message.insertTime",render:function(e,s,a){return 0==a.status?"<dt>"+chGMT(e)+"</dt>":'<span class="contacts-list-msg">'+chGMT(e)+"</span>"}},{targets:3,data:"message.msgType",render:function(e,s,a){var t="";return 0==a.status&&null!=$scope.messageTypeDic[e]?t="<dt>"+$scope.messageTypeDic[e].senderTxt+"</dt>":null!=$scope.messageTypeDic[e]&&(t='<span class="contacts-list-msg">'+$scope.messageTypeDic[e].senderTxt+"</span>"),t}}]},$scope.activeListTab="tab1";var initEvent=function(){$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){if(0<$(e.target).closest("li.disabled").length)return $(e.target).closest("li.disabled").removeClass("active"),void $(e.target).closest("ul").children("[name="+$scope.activeListTab+"]").addClass("active");var s=$(e.target).closest("li").attr("name"),a=$(e.target).attr("name");s&&($scope.activeListTab=s,$scope.$apply(),tabMessage(a))})},tabMessage=function(e){"all"==e?initGetDB():"order"==e?statusQuery("ticket_message"):"bulletin"==e?statusQuery("bulletin_message"):"payment"==e?statusQuery("payment_message"):"maintenance"==e?statusQuery("maintenance_message"):"notice"==e&&statusQuery("notify_message")},statusQuery=function(n){"/message"==$location.path()?psMessageService.queryMessageByUserID(function(e){if(0==e.code){$scope.msgGridData.data=e.data,$scope.messageList=e.data;var s=$scope.messageList,a=[];for(var t in s)"notify_message"==n?"payment_message"!=s[t].message.msgType&&"maintenance_message"!=s[t].message.msgType&&"maintenance_msg"!=s[t].message.msgType&&"notice"!=s[t].message.msgType&&"gateway_message"!=s[t].message.msgType||a.push(s[t]):s[t].message.msgType==n&&a.push(s[t]);$scope.msgGridData.data=a,$scope.$broadcast(Event.USERCENTERINIT+"_msg",$scope.msgGridData)}}):"/unread"==$location.path()?psMessageService.queryMessageByStatusAndUserID("0",function(e){if(0==e.code){$scope.msgGridData.data=e.data,$scope.messageList=e.data;var s=$scope.messageList,a=[];for(var t in s)"notify_message"==n?"payment_message"!=s[t].message.msgType&&"maintenance_message"!=s[t].message.msgType&&"maintenance_msg"!=s[t].message.msgType&&"notice"!=s[t].message.msgType&&"gateway_message"!=s[t].message.msgType||a.push(s[t]):s[t].message.msgType==n&&a.push(s[t]);$scope.msgGridData.data=a,$scope.$broadcast(Event.USERCENTERINIT+"_msg",$scope.msgGridData)}}):"/read"==$location.path()&&psMessageService.queryMessageByStatusAndUserID("1",function(e){if(0==e.code){$scope.msgGridData.data=e.data,$scope.messageList=e.data;var s=$scope.messageList,a=[];for(var t in s)"notify_message"==n?"payment_message"!=s[t].message.msgType&&"maintenance_message"!=s[t].message.msgType&&"maintenance_msg"!=s[t].message.msgType&&"notice"!=s[t].message.msgType&&"gateway_message"!=s[t].message.msgType||a.push(s[t]):s[t].message.msgType==n&&a.push(s[t]);$scope.msgGridData.data=a,$scope.$broadcast(Event.USERCENTERINIT+"_msg",$scope.msgGridData)}})};$scope.messageTypeDic={},$scope.configGroupsDic={};var configList=function configList(){configUIService.getAllConfigs(function(returnObj){if(0==returnObj.code){if(returnObj.data.forEach(function(e){$scope.configGroupsDic[e.groupName]=e}),$scope.configGroups=returnObj.data,0<returnObj.data.length&&null!=$scope.configGroupsDic.messageType&&$scope.configGroupsDic.messageType.value){var messageType=eval("("+$scope.configGroupsDic.messageType.value+")");$scope.messageTypeDic=messageType}initGetDB()}})},queryMessage=function(e){psMessageService.queryMessageByStatusAndUserID(e,function(e){0==e.code&&($scope.msgGridData.data=e.data,$scope.messageList=e.data,$scope.$broadcast(Event.USERCENTERINIT+"_msg",$scope.msgGridData))})},initGetDB=function(){"/message"==$location.path()?($scope.msgStatus="全部消息",$scope.statusMsg="0",allQueryMessage()):"/unread"==$location.path()?($scope.msgStatus="未读消息",$scope.statusMsg="0",queryMessage("0")):"/read"==$location.path()&&($scope.msgGridData={columns:[{title:"消息标题",data:"message.title"},{title:"接收时间",data:"message.insertTime"},{title:"消息类型",data:"message.msgType"}],columnDefs:[{targets:0,data:"message.title",render:function(e,s,a){return 0==a.status?'<dt><a href class="hov-slide" style="color: #444;" >'+e+"</a></dt>":'<span class="contacts-list-msg"><a  href style="color: #999;"   class="hov-slide"  >'+e+"</a></span>"}},{targets:1,data:"message.insertTime",render:function(e,s,a){return 0==a.status?"<dt>"+chGMT(e)+"</dt>":'<span class="contacts-list-msg">'+chGMT(e)+"</span>"}},{targets:2,data:"message.msgType",render:function(e,s,a){var t="";return 0==a.status&&null!=$scope.messageTypeDic[e]?t="<dt>"+$scope.messageTypeDic[e].senderTxt+"</dt>":null!=$scope.messageTypeDic[e]&&(t='<span class="contacts-list-msg">'+$scope.messageTypeDic[e].senderTxt+"</span>"),t}}]},$scope.msgStatus="已读消息",queryMessage("1"),$scope.statusMsg="1")},allQueryMessage=function(){psMessageService.queryMessageByUserID(function(e){0==e.code&&($scope.msgGridData.data=e.data,$scope.messageList=e.data,$scope.$broadcast(Event.USERCENTERINIT+"_msg",$scope.msgGridData))})};$scope.statusUpdate=function(n){psMessageService.modifyMsgStatus([n.message.messageId],function(e){if(0==e.code)if("ticket_message"==n.message.msgType){var s=(t=$.trim(n.message.content)).split("任务ID：")[1],a=t.split("任务地址：")[1];location.href=a?a+"/"+s.split(",")[0]:"../app-oc/index.html#/orderdetail/"+s.split(",")[0]+"/task/message"}else if("ticket_maintenance_message"==n.message.msgType){var t;s=(t=$.trim(n.message.content)).split("任务ID：")[1];location.href="../app-oc/index.html#/deviceTask/"+s.split(",")[0]}else"payment_message"==n.message.msgType?($("#info").css("display","none"),$("#exp").css("display","block"),location.href="../app-uc/index.html#/expenses"):"alert_message_insystem"==n.message.msgType?location.href="../app-oc/index.html#/configAlert/"+$.trim(n.message.content)+"/alert":"maintenance_msg"==n.message.msgType?location.href="../app-oc/index.html#/maintenance/"+$.trim(n.message.content):location.href="#/messageDetail/"+n.message.messageId})},$scope.deleteMsg=function(s){$scope.messageInfo=[];var e=$scope.msgGridData.data;e.forEach(function(e){(e.selected&&0==e.status&&"2"==s||e.selected&&"1"==s)&&(e.message.messageId+",",$scope.messageInfo.push(e.message.messageId))}),"1"==s?0<$scope.messageInfo.length?BootstrapDialog.show({title:"提示",closable:!1,message:"您确认要删除选中的"+$scope.messageInfo.length+"条消息吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){psMessageService.deleteMessageUser($scope.messageInfo,function(e){0==e.code&&(growl.success("删除消息成功",{}),initGetDB())}),e.close()}},{label:"取消",action:function(e){e.close()}}]}):growl.warning("请选择要删除的消息",{}):"2"==s&&(0<$scope.messageInfo.length?BootstrapDialog.show({title:"提示",closable:!1,message:"您确认要标记选中的"+$scope.messageInfo.length+"条消息为已读吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){psMessageService.modifyMsgStatus($scope.messageInfo,function(e){0==e.code&&(growl.success("消息标记已读成功",{}),tabMessage($(".nav-tabs .active  a ").attr("name")))}),e.close()}},{label:"取消",action:function(e){e.close()}}]}):growl.warning("请选择要标记为已读的消息,已读消息不算数哦！",{}))},userLoginUIService.user.isAuthenticated?(initEvent(),configList()):$scope.$on("loginStatusChanged",function(e,s){userLoginUIService.user.isAuthenticated&&(initEvent(),configList())})}]),controllers.initController("messageDetailCtrl",["$scope","$sce","$routeParams","$location","userLoginUIService","psMessageService","growl",function(s,a,e,t,n,c,o){var i=e.msgId;s.detailMessage="",s.TrustAsHtml=function(e){return a.trustAsHtml(e)},c.queryMessageByID(i,function(e){0==e.code&&(s.detailMessage=e.data)})}])});
//# sourceMappingURL=../../../map/app-uc/js/controllers/message-ctrl.js.map
