define(["controllers/controllers","bootstrap-dialog"],function(e,t){"use strict";e.initController("expensesPreviewCtrl",["$scope","$sce","chargeUIService","kpiDataService","userLoginUIService","resourceUIService","psMessageService","growl",function(r,e,t,o,n,i,a,d){r.orderUser="";var s=r.rootCi;r.device="0",r.gather="0",r.pass="0",r.client="0";var u=function(){var e=["kpi",{category:"ci",isRealTimeData:!0,timePeriod:0,nodeIds:[s],kpiCodes:[3001,3002,3022],startTime:null,endTime:null,timeRange:"",statisticType:"psiot",condList:[]}];o.getValueList(e,function(e){if(0==e.code)for(var t in e.data)3001==e.data[t].kpiCode?r.device=e.data[t].value:3002==e.data[t].kpiCode?r.gather=e.data[t].value:3022==e.data[t].kpiCode&&(r.client=e.data[t].value)})};t.getCurrentUserProduct(function(e){0==e.code&&(r.orderUser=e.data)}),null==s?i.getRootDomain(function(e){0==e.code&&(s=e.data.id,u())}):u()}]),e.initController("expensesRecordCtrl",["$scope","chargeUIService","userLoginUIService","userEnterpriseService","growl","resourceUIService",function(t,e,r,o,n,i){t.recordGridData={columns:[{title:"资费方式",data:"resourceType"},{title:"付费模式",data:"durationUnit"},{title:"数量",data:"resourceCount"},{title:"开通时长",data:"duration"},{title:"价格",data:"netAmount"},{title:"状态",data:"state"},{title:"订单提交时间",data:"createDate"},{title:"操作",orderable:!1,data:"option"}],columnDefs:[{targets:0,render:function(e,t,r){var o="";return 1==e?o="接入设备数量":2==e?o="采集监控点数量":3==e&&(o="交互消息数量"),o}},{targets:1,render:function(e,t,r){var o="";return 1==e?o="月":2==e&&(o="年"),o}},{targets:2,render:function(e,t,r){var o="";return 1==r.resourceType||2==r.resourceType?o=e+"个":3==r.resourceType&&(o=e+"条"),o}},{targets:3,render:function(e,t,r){var o="";return 1==r.durationUnit?o="月":2==r.durationUnit&&(o="年"),""+e+o}},{targets:4,render:function(e,t,r){var o="0元";return""!=e&&null!=e&&(o=function(e,t,r){try{e+="",e=parseFloat(e).toFixed(t);var o="";for(r||"-"==e.substring(0,1)&&(o="-"),e=(e=e.replace(/[^0-9|\.]/g,"")).replace(/^0+/,""),/\./.test(e)||(e+=".0000"),/^\./.test(e)&&(e="0"+e),e+="0000",2==t&&(e=e.match(/\d+\.\d{2}/)[0]),4==t&&(e=e.match(/\d+\.\d{4}/)[0]);/\d{4}(\.|,)/.test(e);)e=e.replace(/(\d)(\d{3}(\.|,))/,"$1,$2");return o+e}catch(e){alert(e)}}(e,2,!0)+"元"),o}},{targets:5,render:function(e,t,r){return"<span class='label "+(1==e?"label-warning":"label-info")+"'>"+(2==e?"已支付":"未支付")+"</span>"}},{targets:6,render:function(e,t,r){var o="";return""!=e&&null!=e&&(o=newDateJson(e).Format(GetDateCategoryStrByLabel())),o}},{targets:7,render:function(e,t,r){var o="";return 1==r.state?o+="<a id='price-btn' class='btn btn-default btn-sm'><i class='proudsmart ps-pay  hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'> 支付</span></a>":2==r.state&&(o="已购买"),o}}]},e.getCurrentUserOrder(function(e){0==e.code&&(t.recordGridData.data=e.data,t.$broadcast(Event.USERINFOSINIT+"_record",t.recordGridData))})}]),e.initController("expensesRenewCtrl",["$scope","$sce","$routeParams","chargeUIService","userLoginUIService","resourceUIService","psMessageService","growl",function(d,t,e,r,o,n,i,a){d.product="",d.unit="月",d.code="",d.codeMoney="",d.CouponList="",d.orderUser="",d.orderNo=e.orderNo,d.orderList={duration:"",durationUnit:"1",resourceType:"1",resourceCount:"0",totalAmount:"",balanceAmount:"",price:"",netAmount:""};var s=function(e,t,r){try{e+="",e=parseFloat(e).toFixed(t);var o="";for(r||"-"==e.substring(0,1)&&(o="-"),e=(e=e.replace(/[^0-9|\.]/g,"")).replace(/^0+/,""),/\./.test(e)||(e+=".0000"),/^\./.test(e)&&(e="0"+e),e+="0000",2==t&&(e=e.match(/\d+\.\d{2}/)[0]),4==t&&(e=e.match(/\d+\.\d{4}/)[0]);/\d{4}(\.|,)/.test(e);)e=e.replace(/(\d)(\d{3}(\.|,))/,"$1,$2");return o+e}catch(e){alert(e)}};r.getAllPrice(function(e){0==e.code&&(d.product=e.data,null!=d.orderNo&&u())});var u=function(){r.getOrderByOrderNo(d.orderNo,function(e){0==e.code&&(d.CouponList=e.data,d.orderList.resourceType=e.data.resourceType,d.orderList.durationUnit=e.data.durationUnit,d.orderList.duration=e.data.duration,d.orderList.resourceCount=e.data.resourceCount,d.orderList.totalAmount=s(e.data.price,2,!0),d.orderList.netAmount=s(e.data.netAmount,2,!0),d.orderUser="order")})};d.$watch("orderList.resourceCount",function(e,t,r){if("order"!=d.orderUser)if(null!=e&&null!=e){var o="";for(var n in d.product)if(d.product[n].resourceCount==e&&d.product[n].resourceType==d.orderList.resourceType&&d.product[n].durationUnit==d.orderList.durationUnit){o=d.product[n];break}if(""!=o)if(d.orderList.duration="1",d.orderList.totalAmount=s(o.price,2,!0),""!=d.codeMoney){if(1==d.CouponList.couponType){var i=o.price*d.orderList.duration;if(i>d.CouponList.amount){var a=i-d.CouponList.amount;d.orderList.netAmount=s(a,2,!0)}else d.orderList.netAmount="0.00"}else if(2==d.CouponList.couponType){a=o.price*d.orderList.duration*d.CouponList.discount;d.orderList.netAmount=s(a,2,!0)}}else d.orderList.netAmount=s(o.price,2,!0)}else c()}),d.typeClick=function(){c()};var c=function(){d.orderList.duration="",d.orderList.resourceCount="",d.orderList.totalAmount="",d.orderList.price="",d.orderList.netAmount="",d.codeMoney="",d.code=""};d.promoCode=function(){""!=d.orderList.totalAmount?""!=d.code?r.getCouponByPromoCode(d.code,function(e){if(0==e.code&&null!=e.data){if(1==e.data.couponType){d.codeMoney="-"+s(e.data.amount,2,!0)+"元";var t=d.orderList.totalAmount.replace(",","")*d.orderList.duration;if(t>e.data.amount){var r=t-e.data.amount;d.orderList.netAmount=s(r,2,!0)}else d.orderList.netAmount="0.00"}else if(2==e.data.couponType){d.codeMoney=e.data.discount+"折";r=d.orderList.totalAmount.replace(",","")*d.orderList.duration*e.data.discount;d.orderList.netAmount=s(r,2,!0)}d.CouponList=e.data}else d.codeMoney=""}):a.warning("请输入优惠券",{}):a.warning("请先选择套餐",{})},d.dict="个",d.$watch("orderList.resourceType",function(e,t,r){1==e?d.dict="个":2==e?d.dict="个":3==e&&(d.dict="条")}),d.$watch("orderList.durationUnit",function(e,t,r){"order"!=d.orderUser&&(d.orderList.netAmount="",d.orderList.resourceCount="0",d.orderList.totalAmount="",d.orderList.duration=""),1==e?d.unit="月":2==e&&(d.unit="年")}),d.timeOpen=function(){if(/^[0-9]*[1-9][0-9]*$/.test(d.orderList.duration)){var e=d.orderList.duration*d.orderList.totalAmount.replace(",","");""!=d.codeMoney?1==d.CouponList.couponType?e>d.CouponList.amount?d.orderList.netAmount=s(e-d.CouponList.amount,2,!0):d.orderList.netAmount="0.00":2==d.CouponList.couponType&&(d.orderList.netAmount=s(e*d.CouponList.discount,2,!0)):d.orderList.netAmount=s(e,2,!0)}else d.orderList.duration=""},d.subAjax="";var l=function(e){r.saveOrder(d.orderList,function(e){0==e.code&&("true"==e.data?(a.success("续费成功",{}),location.href="#/expenses"):"false"==e.data?(a.success("续费失败",{}),location.href="#/record"):d.subAjax=e.data)})};d.TrustAsHtml=function(e){return t.trustAsHtml(e)},d.saveOrder=function(){if(""!=d.orderList.resourceCount&&null!=d.orderList.resourceCount)if(d.orderList.duration<=0||""==d.orderList.duration)a.warning("开通时长大于0且不能为空");else if(null!=d.orderNo)d.orderList=d.CouponList,l(d.orderList);else if(""!=d.codeMoney&&(d.orderList.couponList=[d.CouponList]),6<d.orderList.netAmount.length&&(d.orderList.netAmount=d.orderList.netAmount.replace(",","")),d.orderList.netAmount<=2e5){6<d.orderList.totalAmount.length?d.orderList.price=d.orderList.totalAmount.replace(",",""):d.orderList.price=d.orderList.totalAmount;var e=d.orderList.price*d.orderList.duration;d.orderList.totalAmount=e,l(d.orderList)}else a.warning("单笔支付不能超过20万",{});else a.warning("请选择数量")}}])});
//# sourceMappingURL=../../../map/app-uc/js/controllers/expenses-manage-ctrl.js.map
