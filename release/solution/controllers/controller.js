define(function(){var N=function e(t,r){e[t]=r};return[{route:"/rview",templateUrl:"tree.html",name:"ctrlTest3",injector:["$scope","$rootScope","$q","$location","resourceUIService","$routeParams","commonMethodService","serviceProxy","growl"],controller:function(i,e,c,t,r,n,o,a,l){i.navigators=[{label:"设备视图管理",active:!0}],i.a=10;var u,s,v={root:[]},d=[],g=[];function f(e){setTimeout(e,100)}function p(t){return function(e){return tostring.call(e)=="[object "+t+"]"&&e==e}}function w(e,t){for(var r in t)e[r]=t[r]}function h(e,t){var r;for(e=e||[],r=0;r<e.length;r++)t&&t(e[r],r)}function m(e){_onlyDeviceClickable&&e.modelId<1e3||(a.removeAllRequest(),e.setHighlight&&e.setHighlight(!0),f(function(){_onlyDeviceClickable?function(t){t.$location;target.trigger("changeNavString",y.call(t)),I(t.id,function(e){w(t,e),target.setValue("global/resource",t),target.trigger("tree_resourceChange",{resource:t}),target.trigger("analysisShakeNavigateTo",0)})}(e):b(e)}))}function b(t){var r=t.$location;target.trigger("changeNavString",y.call(t)),I(t.id,function(e){w(t,e),target.setValue("global/resource",t),target.trigger("pathChange",r),target.trigger("tree_resourceChange",{resource:t}),target.trigger("analysisShakeNavigateTo",0)})}function y(){for(var e=[this.label],t=this.parent;t;)99!=t.id&&e.push(t.label),t=t.parent;return e.reverse(),e.join(" > ")}function I(e,t){target.getResourceById(e,function(e){t&&t(e)})}function D(e,t){var n=new RegExp("/\\d+/","g"),r=e.values&&e.values.number||null,i=t.values&&t.values.number||null;function o(e){for(var t=0,r=n.exec(e.label);null!=r;){var i=r[0].length;t<i&&(t=i),r=n.exec(e.label)}return t}function a(e){for(var t=u-e.length,r=0;r<t;r++)e="0"+e;return e}if(r||i)return r<i;var c=o(e),l=o(t),u=Math.max(c,l);return e.label.replace(n,function(e){return a(e)})<t.label.replace(n,function(e){return a(e)})}function T(n,e){var o,a,c;return h(e,function(e,t){e.domains.split("/").filter(function(e){return e});var r=e.domains.split("/").filter(function(e){return e}).slice(-2),i=e.id==r[1]?r[0]:r[1];i!==e.id?(e.parentID=i,o=e.id,c=e.modelId,a=1e3<c?1e3:c,(n[o]=e).resourceType=LOC[a]):(console.err("此节点为错误或无效节点",e),g.push(e))}),n}function S(){var e,t=target.getParameter("id");_onlyDeviceClickable&&"device"!==this.resourceType?(event.preventDefault(),this.toggle()):t!=this.id&&(_backToMainWhileDeviceChange&&target.getParameter("sub")?(e=this,_onlyDeviceClickable&&e.modelId<1e3||(a.removeAllRequest(),f(function(){target.setParameter("sub",null),target.navigateTo("index",{main:target.getParameter("main")},"self")}))):m(this))}function C(e){var t,r,i,n=e.domains,o=(e.modelId,a(e));function a(e){if(e.parentID)return v[e.parentID];console.err("没有设置PARENTID属性")}n=n.split("/").filter(function(e){return e}),o?(o.children=o.children||[],function(e,t,r){for(var i=e.length-1;-1<i&&r(t,e[i]);)e[i+1]=e[i],i--;e[i+1]=t}(o.children,e,D)):(v.root.push(e),console.assert(!1,"无根节点的节点",e)),e.label,e.values&&e.values.view?e.view=e.values.view:(e.view=treeViewData[e.id],e.view&&(t=e.id,r=e.view,i=c.defer(),target.postService("resourceUIService","updateDeviceValue",[t,"view",r],function(e){e.code&&i.resolve(e.data)}),i.promise).then(function(e){})),e.click=S,e.$on=function(e,t){events[e]=t}}function x(e,t,r){r([])}function k(t){var o=[],r=[300,301,302];!function i(n){var e=r[n];e&&target.getResourceByModelId(e,function(e){var t,r;t=o,r=e,isArray(r)?push.apply(t,r):push.call(t,r),i(n+1)},extendstr),!e&&t&&t(o)}(0)}function _(e){u=e,k(A)}function A(e){T(v,e);var t,r=[];h(e,function(e){C(e),r.push(e.id)}),dev=v.root,function t(e){h(e,function(e){!e.children&&d.push(e),e.children&&t(e.children)})}(dev),_onlyDeviceClickable||(u?u.modelId<1e3&&(t=v[u.id]):t=v.root[0],t&&(t.$location?b(t):t.postponed=!0)),x(0,0,M)}function M(e){var t;t=function(e){!function(e){runtime("getResourceSuccess开始");var t=[];T(v,e),h(e,function(e){C(e),t.push(e.id)}),runtime("MAP全完成",v.root),x(0,0,P)}(e)},runtime("resource开始加载"),target.getDevicesByCondition({},function(e){runtime("resource完成加载"),t&&t(e)},extendstr)}function P(e){!N.treeData&&N("treeData",v.root),!N.treeMap&&N("treeMap",v);var t=d.find(function(e){return e.children instanceof Array&&0<e.children.length});v.firstDevice=isObject(t)&&isArray(t.children)&&t.children[0];var r=i.$root.$$phase;"$apply"==r||"$digest"===r?i.option=N.treeData:i.$apply(function(){i.option=N.treeData}),runtime("resource加载完成")}function j(){var t,e,r;treeViewData=function(e){var t={};for(var r in e)for(var i=0;i<e[r].length;i++)t[e[r][i].id]=e[r][i].view;return t}(N.treeview),N.treeData?P():(t=_,e=target.getValue("global/resource")||{},(r=target.getParameter("id")||e.id)&&target.getResourceById(r,function(e){t&&t(e)}),!r&&t&&t(null))}events={},push=Array.prototype.push,tostring=Object.prototype.toString,isObject=p("Object"),isNull=p("Null"),isUndefined=p("Undefined"),isArray=p("Array"),isNumber=p("Number"),isFunction=p("Function"),isString=p("String"),target=o(),treenavigator=$('<div class="tree-menu"></div>'),resource=target.getParameter("resource"),_role=target.getValue("global/ROLE"),icons=["tag tag-green","tag tag-yellow","tag tag-orange","tag tag-red"],extendstr="includeFields=id,label,modelId,values.view.viewTitle,values.view.viewId,domains,resourcetype,viewType",_LOCATION=[null,"index","navigate","factory","production"],_onlyDeviceClickable="device"==(target.parameters||{}).navitype,_backToMainWhileDeviceChange=!1,LOC={300:"domain",301:"customer",302:"project",1e3:"device"},i.searchContent="",i.oninit=function(e){i.search=function(){e.search(i.searchContent)}},i.save=function(){target.saveEditorStatus("DomainAreaLineTree",N.treeview,function(){l.success("保存完成")})},N.treeview?j():(s=j,target.getEditorStatus("DomainAreaLineTree",function(e){N("treeview",e),s&&s()}))}},{route:"/rview_select/:mid/:id",templateUrl:"test.html",name:"dialogtest",injector:["$scope","$location","resourceUIService","$routeParams","viewFlexService","commonMethodService","growl"],controller:function(e,o,t,r,i,n,a){var c,l=r.mid,u=r.id,s=n();function v(){e.navigators=[{label:"选择组态视图",active:!0}],e.source={showSelector:!1,data:N.configureview.filter(function(e){return!0}),body:{viewTitle:{label:"组态视图名称",on:{click:function(n){t.getResourceById(u,function(e){if(0==e.code){var t,r,i=e.data;300==l?r=N.treeview.domains:301==l?r=N.treeview.customers:302==l?r=N.treeview.projects:1e3<l&&(r=N.treeview.devices),(t=r.find(function(e){return e.id==u}))?(t.view.viewId=n.viewId,t.view.viewTitle=n.viewTitle):r.push({id:parseInt(u),modelId:parseInt(l),label:i.label,view:{viewId:n.viewId,viewTitle:n.viewTitle}}),N.treeMap[u].view={viewId:n.viewId,viewTitle:n.viewTitle},a.info("保存中请稍后"),s.postService("resourceUIService","updateDeviceValue",[u,"view",N.treeMap[u].view],function(e){e.code&&a.success("修改成功"),o.path("/rview")})}})}}},viewId:{label:"组态视图链接",bind:function(e){return e.viewId},style:function(e){return{color:"blue","text-decoration":"underline"}},type:"text",on:{click:function(e){window.open('../app-free-style/index.html#/topoview/index/%5B%7B"viewId":'+e.viewId+"%7D%5D","_blank")}}}}}}N.treeview||o.path("/rview"),function(e){var t={};for(var r in e)for(var i=0;i<e[r].length;i++)t[e[r][i].view.viewId]=e[r][i].view}(N.treeview),N.configureview?v():(c=v,i.getManagedViewsByType("configure",null,function(e){0==e.code&&(N("configureview",e.data),c())}))}}]});
//# sourceMappingURL=../../map/solution/controllers/controller.js.map
