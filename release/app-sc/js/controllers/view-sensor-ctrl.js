function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}define(["controllers/controllers","bootstrap-dialog"],function(e,J){"use strict";e.initController("ViewSensorCtrl",["$scope","$routeParams","$timeout","kpiDataService","userLoginUIService","resourceUIService","alertService","SwSocket","Info","viewFlexService","unitService","growl","userDomainService","userEnterpriseService","$window","$q","$location",function(m,l,t,f,a,w,s,y,e,c,g,u,i,n,o,r,d){console.info("切换到传感器管理"),m.$on("$locationChangeSuccess",function(e){"/servers"==d.path()&&a.changePos()});var k={};m.groupModel=!1,m.resourceTree=[],m.modelIds,m.alertsDic={},m.viewDics={},m.selectView=void 0,m.displayState=!1,m.serviceViews={},m.cam=Object.create({showCam:function(){var e=this;e.openCam&&e.openCam(),e.show=!0},hideCam:function(){var e=this;e.closeCam&&e.closeCam(),e.show=!1}}),m.changeDispaly=function(){m.displayState=!m.displayState},m.showGis=function(){m.mapShow=!m.mapShow},m.backMainPage=function(){m.selectView=void 0},m.viewEdit=function(e,i){m.groupModel?location.href="../app-topo/index.html#topology/deviceGroup/"+i+"/"+a.user.appData.solutionId+"/"+e.id:location.href="../app-topo/index.html#topology/device/"+i+"/"+a.user.appData.solutionId+"/"+e.id},m.viewDelete=function(s){J.show({title:"提示",closable:!1,message:"确认删除 "+s.label+" 吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(i){if(m.groupModel){var t=function(){for(var e in i.close(),delete m.viewDics[s.label],m.resourceTree)m.resourceTree[e].id==s.id&&(m.resourceTree.splice(e,1),y.unregister(s.uuid),delete k[s.uuid])};w.deleteDeviceGroup(s.id,function(e){m.viewDics[s.label]?c.deleteViews([m.viewDics[s.label].viewId],function(e){0==e.code&&(t(),u.success("关联视图清空",{}))}):t()})}else{t=function(){for(var e in i.close(),delete m.viewDics[s.label],m.resourceTree)m.resourceTree[e].label==s.label&&(m.resourceTree.splice(e,1),y.unregister(s.uuid),delete k[s.uuid])};var a=function(){w.deleteDevice(s.id,function(e){0==e.code&&(m.viewDics[s.label]?c.deleteViews([m.viewDics[s.label].viewId],function(e){0==e.code&&(t(),u.success("关联视图清空",{}))}):t(),u.success("关联对象已删除",{}))})};w.deactivateDevice(s.id,function(e){0==e.code&&(a(),u.success("关联对象已停用",{}))})}}},{label:"取消",action:function(e){e.close()}}]})},m.popClose=function(){m.selectedElement=void 0},m.elePos=function(e,i){return i=$(o).width()<=1365?(e=e/960*720,i/540*405):$(o).width()<=1599?(e=e/960*840,i/540*472):$(o).width()<=1919?(e=e/960*1054,i/540*596):(e=e/960*1280,i/540*720),{top:e+"px",left:i+"px"}},m.getBgImg=function(){var e="topo_bg.png";if(m.selectView.content.bgImgId,m.selectView.content.bgImgId){var i=m.selectView.content.bgImgId.split("/");e=i[i.length-1]}return{"background-image":"url(../images/topo/"+e+")"}},m.elemCLick=function(e){m.selectedElement=e},m.addResource=function(){location.href="../app-topo/index.html#/topology/deviceGroup/0/"+a.user.appData.solutionId},m.addGateway=function(){location.href="#gateway"},m.viewDetail=function(e){var i;if((i=m.groupModel?m.viewDics[e.id]:m.viewDics[e.label])&&i.viewId&&0<i.viewId){var t=e.values.model?e.values.model:"草莓";if(m.news=m.info[t],m.reports=m.info[t+"_记录"],m.selectView=i,m.selectItem=e,m.selectViewElems=[],m.groupModel)for(var a in m.selectView.JSON.elements){if((n=m.selectView.JSON.elements[a]).id=m.selectView.JSON.elements[a].resource.id,n.modelId=n.resourceDes.modelId,m.selectView.JSON.elements[a].kpi.displayParamObj&&(n.chartinterval=m.selectView.JSON.elements[a].kpi.displayParamObj.chartInterval),n.min=m.selectView.JSON.elements[a].kpi.min,n.max=m.selectView.JSON.elements[a].kpi.max,!n.directive&&n.kpi)for(var s in m.modelIds[m.selectItem.modelId].directives)if(n.kpi.name==m.modelIds[m.selectItem.modelId].directives[s].label){n.directive=m.modelIds[m.selectItem.modelId].directives[s];break}m.selectViewElems.push(n)}else for(var a in m.selectView.content.elements){var n;if((n=m.selectView.content.elements[a]).modelId=e.modelId,m.selectView.content.elements[a].kpi.displayParamObj&&(n.chartinterval=m.selectView.content.elements[a].kpi.displayParamObj.chartInterval),m.selectView.JSON?(n.min=m.selectView.JSON.elements[a].kpi.min,n.max=m.selectView.JSON.elements[a].kpi.max):(n.min=m.selectView.content.elements[a].kpi.min,n.max=m.selectView.content.elements[a].kpi.max),!n.directive&&n.kpi)for(var s in m.modelIds[m.selectItem.modelId].directives)if(n.kpi.name==m.modelIds[m.selectItem.modelId].directives[s].label){n.directive=m.modelIds[m.selectItem.modelId].directives[s];break}m.selectViewElems.push(n)}var o={times:[],data:[]},r=new Date,d=0;for(a=6;-1<a;a--){var l=new Date(r.getTime()-24*a*3600*1e3);o.times.push(l.getDate()+"日");var c=Math.floor(10+10*Math.random());o.data.push(c),d+=c}m.selectItem.avgprice=(d/7).toFixed(2),V(o)}else u.warning("当前没有详细内容可以查看,请点击编辑进行编辑",{})};var I=function(e){var i;switch(e){case-1:i="btn-ps-unknow";break;case 0:i="btn-ps-normal";break;default:i="btn-ps-critical"}return i},b=function(e){var i=k[e.uuid][0],t=k[e.uuid][1];e.data.arisingTime;for(var a in t)if(e.data.nodeId==t[a].id&&e.data.kpiCode==t[a].kpiCode){if(e.data.instance&&e.data.instance!=t[a].instance)continue;t[a].kpiValue=e.data.value,t[a].value=t[a].kpi&&null!=t[a].kpi.rangeObj?t[a].kpi.rangeObj[t[a].kpiValue]:t[a].kpiValue,t[a].state=0,t[a].stateStyle=I(t[a].state)}m.$broadcast("kpiSlickValue",{id:i.id,value:t}),h(i,t,!0)},h=function(o,r,d){var e,i=[];if(m.groupModel){for(var t in o.JSON.elements)e=o.JSON.elements[t],i.push(e.resource.id);var l={nodeIds:i.toString(),states:"0,5,10"}}else l={nodeIds:o.id,states:"0,5,10"};s.queryFromCache(l,function(e){if(0==e.code){var i=[];for(var t in e.data){var a=!1;for(var s in r)if(e.data[t].nodeId==r[s].id&&e.data[t].kpiCode==r[s].kpiCode){if(e.data[t].instance&&e.data[t].instance!=r[s].instance)continue;r[s].state=e.data[t].severity,r[s].stateStyle=I(r[s].state),a=!0}if(a){e.data[t].time=newDateJson(e.data[t].receiveTime).Format("yyyy-MM-dd hh:mm:ss");var n="";switch(e.data[t].severity){case 4:n="text-red";break;case 3:n="text-orange";case 2:n="text-orange";break;default:n="text-yellow"}e.data[t].stateStyle=n,i.push(e.data[t])}}0<i.length?o.stateStyle="box-danger":o.stateStyle="box-success",m.alertsDic[l.nodeIds]=i,m.groupModel,o.kpis=r,o.alerts=i,d&&m.$broadcast("kpiSlickValue",{id:o.id,value:r})}})},p=function(o,e){var i,r,d=[],t=[];if(m.groupModel)r=m.viewDics[o.id].content.elements;else if(m.viewDics[o.label])r=m.viewDics[o.label].content.elements;else{var a={content:{elements:[],nodeId:o.id}};e.forEach(function(e){var i={kpi:{id:e.id,label:e.label,nodeId:o.id},resource:{id:o.id,label:o.label}};a.content.elements.push(i)}),m.viewDics[o.label]=a,r=a.content.elements}if(m.groupModel)for(var s in e=[],r){var n=r[s];e=e.concat(m.modelIds[n.resourceDes.modelId].kpis)}for(var l in r=r.filter(function(i){return!!e.find(function(e){return!!i.kpi&&e.id==i.kpi.id})})){var c=r[l].resource.id;t.push(c),-1==t.indexOf(c)&&t.push(c);var u=r[l];for(var s in u.instance&&(u.title=u.instance,delete u.instance),e)(u.kpi.id&&e[s].id==u.kpi.id||u.kpi&&e[s].id==u.kpi.id)&&(u.kpiCode=e[s].id,d.push(e[s].id),u.label=u.title?u.title:e[s].label,u.icon=e[s].icon,u.unit=null!=g.unitDics&&"Amount"!=g.unitDics[e[s].unit]?g.unitDics[e[s].unit]:"",u.state=-1,u.stateStyle=I(u.state),m.groupModel?(u.id=c,u.instance,u.valueName=c+"?"+e[s].id):(u.id=o.id,u.instance,u.valueName=o.id+"?"+e[s].id),u.kpiValue=0,u.kpi.name=e[s].name,e[s].rangeObj&&(u.kpi.rangeObj=e[s].rangeObj,u.value=e[s].rangeObj[u.kpiValue]),e[s].displayParamObj&&(u.kpi.displayParamObj=e[s].displayParamObj),u.kpi.min=e[s].min,u.kpi.max=e[s].max)}var p={category:"time",isRealTimeData:!0,timePeriod:0,nodeIds:i=m.groupModel?t:[o.id],kpiCodes:d},v=function(n){f.getKpiValueList(n,function(e){if(0==e.code){var i=n[1];for(var t in r){var a=r[t];for(var s in a.kpiValue="NA",a.value="NA",e.data.recordList)e.data.recordList[s][a.valueName],null!=e.data.recordList[s][a.valueName]&&(a.kpiValue=e.data.recordList[s][a.valueName],a.value=a.kpi&&null!=a.kpi.rangeObj?a.kpi.rangeObj[a.kpiValue]:a.kpiValue,a.state=0,a.stateStyle=I(a.state))}!function(e,i,t){var a={ciid:i.nodeIds.toString(),kpi:i.kpiCodes.toString()},s=Math.uuid();e.uuid=s,k[s]=[e,t];var n="register";y.register(s,n,b),y.send(s,n,"kpi",a)}(o,i,r),h(o,r,!1)}})};w.getResourceByIds(i,function(e){var i;for(var t in p.nodesDic=e,p.kpisDic={},e){for(var a in i=m.modelIds[e[t].modelId].kpis,d){var s=d[a],n=i.find(function(e){return e.id==s});n&&(p.kpisDic[n.id]=n)}v(["kpi",p])}})},v=function(e){if(m.groupModel)for(var i in m.resourceTree)(t=m.resourceTree[i]).modelId==e.id&&p(t,e.kpis);else for(var i in m.resourceTree)m.resourceTree[i].modelId==e.id&&p(m.resourceTree[i],e.kpis);var t},S=function(o,r){w.getKpisByModelId(o.id,function(e){if(0==e.code){o.kpis=e.data;var i=/\{|\[.*\}|\]/;for(var t in o.kpis){if(o.kpis[t].range){var a=[];if(s=i.test(o.kpis[t].range))try{a=s?JSON.parse(o.kpis[t].range):[]}catch(e){}(o.kpis[t].rangeAry=a)instanceof Array?2==(o.kpis[t].rangeAry=a).length&&(o.kpis[t].min=a[0],o.kpis[t].max=a[1]):a instanceof Object&&(o.kpis[t].rangeObj=a)}if(o.kpis[t].displayParam){var s,n={};(s=i.test(o.kpis[t].displayParam))&&(n=JSON.parse(o.kpis[t].displayParam)),o.kpis[t].displayParamObj=n}w.kpisDic[o.id+"??"+o.kpis[t].id]=o.kpis[t],w.kpisDic[o.kpis[t].id]=o.kpis[t]}r&&r(o)}})},D=function(i){w.getAlertsByModelId(i.id,function(e){0==e.code&&(i.alertsConfig=e.data)})},O=function(e){function t(e){if(0==e.code)for(var i in e.data){for(var t in c.viewList)if("Sensor"!=e.data[i].category&&e.data[i].label==c.viewList[t].viewTitle){"designView"==c.viewList[t].viewType&&(e.data[i].viewId=c.viewList[t].viewId);break}m.modelIds[e.data[i].id]={id:e.data[i].id,viewId:e.data[i].viewId,model:e.data[i],directives:null}}a()}m.modelIds={},m.groupModel?w.getDeviceGroupModels(function(e){for(var i in e.data)m.modelIds[e.data[i].id]={id:e.data[i].id,viewId:e.data[i].viewId,model:e.data[i],directives:null};w.getModels(t)}):w.getModels(t);var s=[],a=function(){function i(e){var o,i,t;if(0==e.code){for(var a in o=e.data,c.viewList)i=c.viewList[a],t=void 0,(t=/\{.*}/.test(i.content)?JSON.parse(i.content):void 0)&&(t.elements instanceof Array&&(t.elements=t.elements.sort(function(e,i){return e.kpi&&i.kpi?e.kpi.id>i.kpi.id?1:-1:1})),i.JSON=t);for(var a in s)!function(i){var e=c.viewList.find(function(e){return!!e.JSON&&e.JSON.nodeId==i.id});if(e){m.viewDics[i.id]=e,i.JSON=e.JSON;var t=JSON.parse(JSON.stringify(i.JSON.elements));for(var a in t){var s=t[a].resource.id,n=o.find(function(e){return e.id==s&&(m.viewDics[e.label]={},m.viewDics[e.label].content=i.JSON),e.id==s});n?t[a].resourceDes=n:t[a].removed=!0}i.JSON.elements=t.filter(function(e){return 1!=e.removed}),m.viewDics[i.id].content=i.JSON}}(s[a]);m.resourceTree=s.map(function(e){var i=JSON.parse(JSON.stringify(e));if(i.kpis=[],i.alerts=[],i.viewId=null,i.values.hasOwnProperty("standardAddress")){var t=i.values.standardAddress.split(",");1==t.length?t[0]?i.city=t[0]:i.city="北京":-1<t[0].indexOf("市")?i.city=t[0]:i.city=t[1]}else i.city="北京";return i.values.hasOwnProperty("introduce")&&(i.introduce=i.values.introduce),i.values.hasOwnProperty("installationPosition")&&(i.installationPosition=i.values.installationPosition),i.values.hasOwnProperty("specialty")&&(i.specialty=i.values.specialty),i.stateStyle="box-default",i}),function(e){var i=[];for(var t in m.modelIds){var a=r.defer();!function(e,i){S(e,function(e){i.resolve("success")}),D(e)}(m.modelIds[t],a),i.push(a.promise)}r.all(i).then(function(){e()})}(function(){for(var e in m.modelIds)v(m.modelIds[e])})}}function t(e){if(0==e.code){var i=[];for(var t in e.data)if("Sensor"!=e.data[t].category&&m.modelIds[e.data[t].modelId]&&!(null==e.data[t].label||-1<e.data[t].label.indexOf("农业大棚模拟"))){if(null==m.modelIds[e.data[t].modelId].directives&&N(m.modelIds[e.data[t].modelId]),e.data[t].kpis=[],e.data[t].alerts=[],e.data[t].viewId=m.modelIds[e.data[t].modelId].viewId,e.data[t].values.hasOwnProperty("standardAddress")){var a=e.data[t].values.standardAddress.split(",");1==a.length?a[0]?e.data[t].city=a[0]:e.data[t].city="北京":-1<a[0].indexOf("市")?e.data[t].city=a[0]:e.data[t].city=a[1]}else e.data[t].city="北京";for(var s in e.data[t].values.hasOwnProperty("introduce")&&(e.data[t].introduce=e.data[t].values.introduce),e.data[t].values.hasOwnProperty("installationPosition")&&(e.data[t].installationPosition=e.data[t].values.installationPosition),e.data[t].values.hasOwnProperty("specialty")&&(e.data[t].specialty=e.data[t].values.specialty),e.data[t].stateStyle="box-default",m.viewDics[e.data[t].label]=m.serviceViews[e.data[t].modelId],c.viewList)o=c.viewList[s],r=void 0,"string"==typeof(d=o.content)?r=JSON.parse(d):"object"==_typeof(d)&&(r=d),r&&r.nodeId==e.data[t].id&&(m.viewDics[e.data[t].label]=o,m.viewDics[e.data[t].label].content=r,e.data[t].title=r.label);i.push(e.data[t])}if(m.resourceTree=i,l.level)for(var t in m.resourceTree)m.resourceTree[t].id==l.nodeId&&m.viewDetail(m.resourceTree[t]);for(var n in m.modelIds)S(m.modelIds[n],v),D(m.modelIds[n])}var o,r,d}m.groupModel?w.getDeviceGroups(function(e){0==e.code&&(s=e.data),w.getResources(i)}):c.getServiceViewMap(function(e){0==e.code&&(m.serviceViews=e.data?e.data:{}),w.getResources(t)})}};m.getHierarchyValue=function(e,i,t,r){var d=w.kpisDic[i[0]],a={category:"time",isRealTimeData:!0,timePeriod:432e5,nodeIds:e,kpiCodes:i,kpisDic:{minTimespan:w.getMSvalue(0,d)}};w.getResourceByIds(e,function(e){var o;a.nodesDic=e,a.kpisDic[d.id]=d,o=["kpi",a],f.getKpiValueList(o,function(e){if(0==e.code){var i=o[1],t=i.nodeIds[0]+"?"+i.kpiCodes[0];i.queryInstances&&(t+="?"+i.queryInstances);var a={data:[],times:[]};for(var s in e.data.recordList){var n;a.data.push(e.data.recordList[s][t]),n="SECOND"==d.granularityUnit?newDateJson(e.data.recordList[s].arisingTime).Format("hh:mm:ss"):newDateJson(e.data.recordList[s].arisingTime).Format("hh:mm"),a.times.push(n)}r(a)}})})};var V=function(e){var i={tooltip:{trigger:"axis"},grid:{x:35,y:30,x2:40,y2:30},toolbox:{show:!1,feature:{mark:{show:!0},dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},calculable:!0,xAxis:[{type:"category",boundaryGap:!1,data:e.times,splitLine:{show:!1}}],yAxis:[{type:"value",scale:!0,axisLabel:{formatter:"{value}"},splitLine:{show:!1}}],series:[{name:"每公斤",type:"line",data:e.data,markPoint:{textStyle:{fontSize:10},data:[{symbolSize:10,type:"max",name:"最大值"},{symbolSize:10,type:"min",name:"最小值"}]}}]};t(function(){m.$broadcast(Event.ECHARTINFOSINIT,{name:"priceMain",option:i})})},N=function(i){i.directives=[],w.getDirectivesByModelId(i.id,function(e){0==e.code&&(i.directives=e.data)})},x=function(){m.$on("switchChange",function(e,i){var t;(t=i).nodeId=m.selectItem.id,t.itemDirValues={value:t.itemDirValues},w.sendDeviceDirective(t.nodeId,Number(t.id),t.itemDirValues,function(e){0==e.code&&u.success("指令发送成功",{})})})},T=function(){c.viewLoadFinished&&a.user.isAuthenticated&&(202==a.user.appData.serviceViewTemplate&&0==a.user.appData.managedByGroup?m.groupModel=!1:m.groupModel=!0,m.serviceViewId=a.user.appData.serviceViewTemplate,m.camDisp=204==a.user.appData.serviceViewTemplate,e.get("localdb/news.json",function(e){m.info=e}),O(),x())};m.$on("viewLoadFinished",function(){T()}),a.user.isAuthenticated?T():m.$on("loginStatusChanged",function(e,i){a.user.isAuthenticated&&T()}),m.$on("$destroy",function(){for(var e in k)y.unregister(e)})}])});
//# sourceMappingURL=../../../map/app-sc/js/controllers/view-sensor-ctrl.js.map
