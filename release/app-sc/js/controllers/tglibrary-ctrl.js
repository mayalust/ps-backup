function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}define(["controllers/controllers","Array"],function(e){"use strict";function t(r,e,o,t,i,n,a,c,l,u){var s,d,p;r.$on("$locationChangeSuccess",function(e){"/servers"==n.path()&&i.changePos()}),i.user.appData?p=i.user.appData.solutionId:r.$on("loginStatusChanged",function(){p=i.user.appData.solutionId}),(d=function(e){for(var t in e)this[t]=e[t]}).prototype.edit=function(){var e=this.id;n.path("tongji/edit/"+p+"/"+e)},d.prototype.detail=function(){var e=this.id;n.path("tongji/detail/"+e)},r.addResource=function(){n.path("tongji/edit/"+p)},d.prototype.remove=function(){var t=this.id,e=this.view.viewId;a.deleteViews([e],function(e){c.deleteDeviceGroup(t,function(e){r.deviceGroups=r.deviceGroups.filter(function(e){return e.id!=t})})})},o.views.getAll(!1).then(function(e){s=e.filter(function(e){return"tongji_deviceGroup"==e.viewTitle});var a=[],c=[];for(var t in s)!function(e,t){var i,r={},n=t.content;if("{"==n.slice(0,1)&&"}"==n.slice(-1))for(var o in(r=JSON.parse(n)).preview.list)(i=r.preview.list[o]).resource&&-1==a.indexOf(i.resource.id)&&a.push(i.resource.id),i.kpi&&-1==a.indexOf(i.kpi.id)&&c.push(i.kpi.id);t.JSON=r}(0,s[t]);function i(e){r.deviceGroups=e.map(function(e){var t={id:e.id,label:e.label,view:null},i=s.find(function(e){return e.JSON.deviceGroupId==t.id});return t.view=i,new d(t)})}function n(e){}o.getValues(a,c).then(function(r){for(var e in s)!function(e,t){for(var i in t.JSON.preview.list)!function(e,t){var i=r.find(function(e){return!(!t.kpi||!t.resource)&&(e.kpiCode==t.kpi.id&&e.nodeId==t.resource.id)});i&&i.value?t.value=i.value:t.value="-"}(0,t.JSON.preview.list[i])}(0,s[e]);o.deviceGroups.getAll(!1).then(i,n)},n)},function(e){})}function i(u,e,s,t,o,a,r,n,c,i){var l,d,p,f,h,v,g,w,m,y,b,k;function I(t){null!=t.kpi&&"object"==_typeof(t.resource)&&null!=t.resource&&s.getValues([t.resource.id],[t.kpi.id]).then(function(e){0<e.length?"function"==typeof t.setValue?t.setValue(parseInt(e[0].value)):t.value=parseInt(e[0].value):t.value="-"},function(e){})}function O(){function e(e){0==e.code&&(l=e.data),s.views.getAll().then(function(e){var t=e;for(var i in t)if("tongji_deviceGroup"==t[i].viewTitle){var r=JSON.parse(t[i].content);r.deviceGroupId==y&&((d=r).viewId=t[i].viewId),S(l)}})}function t(n){var e=JSON.parse(JSON.stringify(u.deviceGroupModel));e.modelId=e.id,delete e.id,r.saveDeviceGroup(e,function(e){var t=e.data;n.deviceGroupId=t.id;var i=JSON.stringify(n);try{var r={viewTitle:"tongji_deviceGroup",viewName:"tongji_deviceGroup",viewType:"tongji_deviceGroup",content:i};a.addView(r,function(e){o.path("tongji/prev")})}catch(e){alert(e)}})}function i(n){var e=JSON.parse(JSON.stringify(l));r.saveDeviceGroup(e,function(e){var t=e.data;n.deviceGroupId=t.id;var i=JSON.stringify(n);try{var r={viewId:d.viewId,viewTitle:"tongji_deviceGroup",viewName:"tongji_deviceGroup",viewType:"tongji_deviceGroup",content:i};a.updateView(r,function(e){o.path("tongji/prev")})}catch(e){alert(e)}})}"editmodel"==u.mode?m?(p=function(e){var t=JSON.stringify(e);n.saveServiceViewContent(m,b,0,t,function(e){c.location.href="../app-ac/index.html#/myView"})},n.getServiceViewContent(m,b,0,function(e){"0"==e.code&&"string"==typeof e.data&&(d=JSON.parse(e.data));m?null==d?n.getModelsByGroupId(m,b,function(e){"0"==e.code&&(u.allModels=e.data.map(function(e){return new k(e)}),u.preview=new h({list:[]}),u.drawarea={list:[],backgroundImage:"images/tongji/bg.png"},u.charts=new v({list:[]}))}):n.getModelsByGroupId(m,b,function(e){if("0"==e.code){for(var t in u.allModels=e.data.map(function(e){return new k(e)}),u.preview=new h(d.preview),u.drawarea=d.drawarea,u.drawarea.list=u.drawarea.list.map(function(e){return new w(e)}),u.charts=new v(d.charts),u.preview.list)n=u.preview.list[t],o.call(n);for(var t in u.drawarea.list)r=u.drawarea.list[t],o.call(r);for(var t in u.charts.list)i=u.charts.list[t],o.call(i)}var i,r,n;function o(){var e,t=this;t.model&&(e=u.allModels.find(function(e){return t.model.id==e.id})),(t.modelObj=e)&&s.kpis.getBymodelId(e.id).then(function(e){t.model.kpi=e.map(function(e){return{id:e.id,label:e.label,icon:e.icon?e.icon:"ps-irrigation",unit:e.unit}}),t.kpi=t.model.kpi.find(function(e){return e.id==t.kpi.id}),I(t)},function(e){})}}):S(l)})):y?(p=i,r.getResourceById(y,e)):(p=t,s.deviceGroupModels.getAll().then(function(e){function t(e){u.resources=e.map(function(e){return new f(e)})}function i(e){}u.deviceGroupModels=e,u.deviceGroupModels instanceof Array&&0<u.deviceGroupModels.length&&(u.deviceGroupModel=u.deviceGroupModels[0]),u.preview=new h({list:[]}),u.drawarea={list:[],backgroundImage:"images/tongji/bg.png"},u.charts=new v({list:[]}),s.resources.getAll().then(t,i)},function(e){})):"edit"==u.mode&&(y?(p=i,r.getResourceById(y,e)):(p=t,a.getServiceViewMap(function(e){var r,l;r=e.data,s.deviceGroupModels.getAll().then(function(e){function t(e){u.resources=e.map(function(e){return new f(e)});var t,i,r,n=l?l.preview:{list:[]},o=l?l.charts:{list:[]};for(var a in u.preview=new h(n),u.drawarea=l?l.drawarea:{list:[],backgroundImage:"images/tongji/bg.png"},u.drawarea.list=u.drawarea.list.map(function(e){return new w(e)}),u.charts=new v(o),u.preview.list)t=u.preview.list[a],c.call(t);for(var a in u.drawarea.list)i=u.drawarea.list[a],c.call(i);for(var a in u.charts.list)r=u.charts.list[a],c.call(r);function c(){var e,t=this;function i(e){t.resource&&(t.resource.kpi=e.map(function(e){return{id:e.id,label:e.label,icon:e.icon?e.icon:"ps-irrigation",unit:e.unit}}),t.kpi=t.resource.kpi.find(function(e){return e.id==t.kpi.id})),I(t)}function r(e){}t.model&&(e=u.resources.find(function(e){return t.model.id==e.modelId})),e&&(t.resource={id:e.id,label:e.label},t.resourceObj=e,s.kpis.getBymodelId(e.modelId).then(i,r))}}function i(e){}u.deviceGroupModels=e,u.deviceGroupModels instanceof Array&&0<u.deviceGroupModels.length&&(u.deviceGroupModel=u.deviceGroupModels[0],r[u.deviceGroupModel.id]&&(l=JSON.parse(r[u.deviceGroupModel.id]))),s.resources.getAll().then(t,i)},function(e){})})))}function S(l){s.resources.getAll().then(function(e){u.resources=e.map(function(e){return new f(e)}),s.deviceGroupModels.getAll().then(function(e){u.deviceGroupModels=e,u.deviceGroupModel=u.deviceGroupModels.find(function(e){return l.modelId==e.id});var t=d.preview,i=d.charts;for(var r in u.preview=new h(t),u.drawarea=d.drawarea,u.drawarea.list=u.drawarea.list.map(function(e){return new w(e)}),u.charts=new v(i),u.preview.list)n=u.preview.list[r],c.call(n);var n;for(var r in u.drawarea.list)o=u.drawarea.list[r],c.call(o);var o;for(var r in u.charts.list)a=u.charts.list[r],c.call(a);var a;function c(){var e,t=this;function i(e){t.resource.kpi=e.map(function(e){return{id:e.id,label:e.label,icon:e.icon?e.icon:"ps-irrigation",unit:e.unit}}),t.kpi=t.resource.kpi.find(function(e){return e.id==t.kpi.id}),I(t)}function r(e){}t.resource&&(e=u.resources.find(function(e){return t.resource.id==e.id})),(t.resourceObj=e)&&s.kpis.getBymodelId(e.modelId).then(i,r)}},function(e){})},function(e){})}u.$on("$locationChangeSuccess",function(e){"/servers"==o.path()&&i.changePos()}),s.units.getAll().then(function(e){e}),t.current?(-1!=t.current.$$route.originalPath.indexOf("modeledit")?u.mode="editmodel":-1!=t.current.$$route.originalPath.indexOf("edit")&&(u.mode="edit"),b=t.current.params.groupId,y=t.current.params.deviceGroupId,u.solutionId=m=t.current.params.solutionId,O()):u.$on("locationChanged",function(){b=t.current.params.groupId,y=t.current.params.deviceGroupId,m=t.current.params.solutionId,-1!=t.current.$$route.originalPath.indexOf("modeledit")?u.mode="editmodel":-1!=t.current.$$route.originalPath.indexOf("edit")&&(u.mode="edit"),O()}),u.kpiChange=I,u.alertOn=!1,(w=function(e){for(var t in e)this[t]=e[t]}).prototype.stopMove=function(e){var t=e.offset.top-$(".drawingArea").offset().top,i=e.offset.left-$(".drawingArea").offset().left;this.top=t,this.topPortion=t/$(".drawingArea").height(),this.left=i,this.leftPortion=i/$(".drawingArea").width()},w.prototype.stopResize=function(e){var t=this;t.width=$(e.element).width(),t.widthPortion=t.width/$(".drawingArea").width(),t.height=$(e.element).height(),t.heightPortion=t.height/$(".drawingArea").height()},w.prototype.remove=function(){var t=this;u.drawarea.list=u.drawarea.list.filter(function(e){return e!==t})},w.prototype.focusOn=function(){u.parametersEditor=this},u.step=0,u.exit=function(){"0"!=m?c.location.href="../app-ac/index.html#/myView":i.changePos()},u.createNew={type:"bar",show:!0,bar:{scale:!0,width:50,height:131},switch:{scale:!1,width:100,height:50,bgimageOpen:"images/tongji/switch_green1.png",bgimageClose:"images/tongji/switch_red1.png"},open:{scale:!0,width:80,height:80},blink:{scale:!1,width:100,height:100,bgimage:"images/tongji/tank1_red.png"},resource:null,kpi:null},u.ondrop=function(e){var t=e.offset.top-$(".drawingArea").offset().top,i=e.offset.left-$(".drawingArea").offset().left,r=new w({top:t,topPortion:t/$(".drawingArea").height(),left:i,leftPortion:i/$(".drawingArea").width(),type:u.createNew.type,scale:u.createNew[u.createNew.type].scale,model:u.createNew.model,modelObj:u.createNew.modelObj,resource:u.createNew.resource,resourceObj:u.createNew.resourceObj,kpi:u.createNew.kpi,show:u.createNew.show,width:u.createNew[u.createNew.type].width,widthPortion:u.createNew[u.createNew.type].width/$(".drawingArea").width(),height:u.createNew[u.createNew.type].height,heightPortion:u.createNew[u.createNew.type].height/$(".drawingArea").height(),bgimageOpen:u.createNew[u.createNew.type].bgimageOpen,bgimageClose:u.createNew[u.createNew.type].bgimageClose,bgBlinkImage:u.createNew[u.createNew.type].bgimage,value:u.createNew.value});r[r.type]=JSON.parse(JSON.stringify(u.createNew[u.createNew.type])),u.drawarea.list?u.drawarea.list.push(r):u.drawarea.list=[r]},u.drawPos=function(e){return{top:e.top,left:e.left,width:e.width,height:e.height,position:"absolute",transform:"rotate(0deg)"}},u.calcuRotation=function(e){return{transform:"rotate(-"+e.value+"deg)","-ms-transform":"rotate(-"+e.value+"deg)","-moz-transform":"rotate(-"+e.value+"deg)","-webkit-transform":"rotate(-"+e.value+"deg)","-o-transform":"rotate(-"+e.value+"deg)"}},u.saveAndExit=function(){var e={};function t(){var e={list:this.list.map(function(e){var t={};return t.label=e.label,t.type=e.type,e.model&&(t.model={id:e.model.id,label:e.model.label}),e.resource&&(t.resource={id:e.resource.id,label:e.resource.label}),e[e.type]&&(t[t.type]={id:e[e.type].id,label:e[e.type].label,unit:e[e.type].unit},e[e.type].icon&&(t[t.type].icon=e[e.type].icon)),t})};return this.title&&(e.title=this.title),e}e.preview=t.call(u.preview),e.drawarea=function(){var e;return(e={list:this.list.map(function(e){var t={};return e.model&&(t.model={id:e.model.id,label:e.model.label}),e.resource&&(t.resource={id:e.resource.id,label:e.resource.label}),e.kpi&&(t.kpi={id:e.kpi.id,label:e.kpi.label}),t.show=e.show,t.scale=e.scale,t.type=e.type,t.width=e.width,t.widthPortion=e.widthPortion,t.height=e.height,t.heightPortion=e.heightPortion,t.top=e.top,t.topPortion=e.topPortion,t.left=e.left,t.leftPortion=e.leftPortion,e.bgimageOpen&&(t.bgimageOpen=e.bgimageOpen),e.bgimageClose&&(t.bgimageClose=e.bgimageClose),e.bgBlinkImage&&(t.bgBlinkImage=e.bgBlinkImage),t})}).backgroundImage=this.backgroundImage,e}.call(u.drawarea),e.charts=t.call(u.charts),p(e)},g=function(e){var t={};for(var i in e)"$$hashKey"!=i&&e.hasOwnProperty(i)&&(t[i]=e[i]);return t},(k=function(e){for(var t in e)"$$hashKey"!=t&&e.hasOwnProperty(t)&&("object"==_typeof(e[t])&&null!=typeof e[t]?this[t]=JSON.parse(JSON.stringify(e[t])):this[t]=e[t])}).prototype.onChange=function(t){var i=this,e=i.id;null!=t&&(t.model=g(i)),null==i.kpi?s.kpis.getBymodelId(e).then(function(e){i.kpi=e.map(function(e){return{id:e.id,label:e.label,icon:e.icon?e.icon:"ps-irrigation",unit:e.unit}}),null!=t&&(t.model.kpi=i.kpi)},function(e){}):null!=t&&(t.model.kpi=i.kpi),null==i.attr?s.attrs.getBymodelId(e).then(function(e){i.attr=e.map(function(e){return{id:e.id,label:e.label}}),null!=t&&(t.model.attr=i.attr)},function(e){}):null!=t&&(t.model.attr=i.attr)},(f=function(e){this.id=e.id,this.label=e.label,this.modelId=e.modelId}).prototype.onChange=function(t){var i=this,e=i.modelId;null!=t&&(t.resource=g(i)),null==i.kpi?s.kpis.getBymodelId(e).then(function(e){i.kpi=e.map(function(e){return{id:e.id,label:e.label,icon:e.icon?e.icon:"ps-irrigation",unit:e.unit}}),null!=t&&(t.resource.kpi=i.kpi)},function(e){}):null!=t&&(t.resource.kpi=i.kpi),null==i.attr?s.attrs.getBymodelId(e).then(function(e){i.attr=e.map(function(e){return{id:e.id,label:e.label}}),null!=t&&(t.resource.attr=i.attr)},function(e){}):null!=t&&(t.resource.attr=i.attr)},(v=function(e){for(var t in e)this[t]=e[t]}).prototype.add=function(){this.list=this.list.concat([{kpi:null,model:null,resource:null,label:"",type:"kpi"}])},v.prototype.remove=function(t){this.list=this.list.filter(function(e){return e!=t})},(h=function(e){for(var t in e)this[t]=e[t]}).prototype.add=function(){this.list=this.list.concat([{kpi:null,model:null,resource:null,label:"",type:"kpi"}])},h.prototype.remove=function(t){t.resource&&(t.resource.used=!1),this.list=this.list.filter(function(e){return e!=t})}}function r(o,e,l,t,i,r,u,n,s,d,a,c){o.$on("$locationChangeSuccess",function(e){"/servers"==r.path()&&c.changePos()});var p,f,h,v=[],g=!1;function w(e){u.getResourceById(e,m)}function m(e){0==e.code&&e.data,l.views.getAll().then(y)}function y(e){for(var t in e)if("tongji_deviceGroup"==e[t].viewTitle){var i=JSON.parse(e[t].content);i.deviceGroupId==p&&(f=i)}o.charts=f.charts,function(){var t=[],i=[],n=[],o=[],e=[],r=[];for(var a in f.drawarea.list)!function(e,r){"switch"==r.type&&(r.onChange=function(e){}),"blink"==r.type?v.push(r):("object"==_typeof(r.resource)&&null!=r.resource&&(-1==t.indexOf(r.resource.id)&&t.push(r.resource.id),"bar"==r.type&&-1==n.indexOf(r.resource.id)&&n.push(r.resource.id),"switch"==r.type&&-1==n.indexOf(r.resource.id)&&u.getResourceById(r.resource.id,function(e){if(e.data){var t=e.data.modelId;l.directives.getBymodelId(t).then(function(e){try{if(!(e instanceof Array))throw e.message;var t=e[0].id,i=r.resource.id;r.sendDeviceDirective=function(e){u.sendDeviceDirective(i,t,{value:e},function(e){})}}catch(e){}})}}),"open"==r.type&&-1==n.indexOf(r.resource.id)&&u.getResourceById(r.resource.id,function(e){if(e.data){var t=e.data.modelId;l.directives.getBymodelId(t).then(function(e){try{if(!(e instanceof Array&&null!=e[0]))throw e.message;var t=e[0].id,i=r.resource.id;r.sendDeviceDirective=function(e){u.sendDeviceDirective(i,t,{value:e},function(e){})}}catch(e){}})}})),"object"==_typeof(r.kpi)&&null!=r.kpi&&(-1==i.indexOf(r.kpi.id)&&i.push(r.kpi.id),-1==o.indexOf(r.kpi.id)&&o.push(r.kpi.id)))}(0,f.drawarea.list[a]);for(var a in f.charts.list)"object"==_typeof((c=f.charts.list[a]).resource)&&null!=c.resource&&(-1==e.indexOf(c.resource.id)&&e.push(c.resource),-1==n.indexOf(c.resource.id)&&n.push(c.resource.id)),"object"==_typeof(c.kpi)&&null!=c.kpi&&(-1==e.indexOf(c.kpi.id)&&r.push(c.kpi),-1==o.indexOf(c.kpi.id)&&o.push(c.kpi.id));var c;(function(e,t){h=Math.uuid();var i={ciid:e.toString(),kpi:t.toString()};d(function(){!function e(){for(var t in f.charts.list){var i=f.charts.list[t],r=i._option_.series[0].data[i._option_.series[0].data.length-1],n=i._option_.xAxis.data[i._option_.xAxis.data.length-1];r=parseInt(r)+parseInt(parseInt(r*(Math.random()-.5)/100)),f.charts.list[t].pushData(r,parseInt(n)+100),d(function(){e()},25e3)}}()},2e3),s.send(h,"register","kpi",i)})(n,o),l.getValues(t,i).then(b),l.getValuesListAndMergeByTime(e,r,6048e5,1e5).then(k)}()}function b(i){for(var e in f.drawarea.list)t=f.drawarea.list[e],n.call(t);var t,r;function n(){var t=this,e=i.find(function(e){return"object"==_typeof(t.kpi)&&null!=t.kpi&&"object"==_typeof(t.resource)&&null!=t.resource&&(e.kpiCode==t.kpi.id&&e.nodeId==t.resource.id)});e&&e.value?t.value=e.value:t.value="-"}r=f,o.drawarea=r.drawarea}function k(r){var n=["#d99a37","#c25262","#39a4d9","#d97c39","#4ccbb4"];for(var e in o.charts.list)!function(e,t){if("object"==_typeof(t.resource)&&null!=t.resource&&"object"==_typeof(t.kpi)&&null!=t.kpi){var i=r.legend.find(function(e){return e.ci==t.resource.label&&e.kpi==t.kpi.label});r.legend.indexOf(i);0==r.$attr("series/"+e+"/data/length")||null==r.$attr("series/"+e+"/data/length")?I.call(t,{legend:["设备－指标"],xAxis:function(){for(var e=[],t=(new Date).getTime(),i=0;i<14;i++)e.push(t-36e4);return e.sort(),e}(),series:function(){for(var e=[],t=0;t<14;t++)e.push(parseInt(100*Math.random()));return[{name:{ci:"设备",kpi:"指标"},data:e}]}()},n[e%5],!0):I.call(t,{legend:[r.legend[e]],xAxis:r.xAxis,series:[r.series[e]]},n[e%5])}}(e,o.charts.list[e])}function I(e,t,i){var r=new n.linechart;r.setTitle({show:!1}),r.setGrid({top:"5%",left:"5%",width:"90%",height:"80%"}),r.setTimeformat("时分"),r.setxAxis({data:e.xAxis}),e.series[0].$extension({itemStyle:{normal:{color:t}},lineStyle:{normal:{color:t}},areaStyle:{type:"default",normal:{color:t}}}),r.setSeriesByCiKpi(e.series),"function"==typeof this.setOption&&this.setOption(r.returnOption())}o.health={},o.wholeClick=function(){o.panelShow=!1},o.orderHandlerClick=function(){i.location.href="../app-oc/index.html#/workorder"},o.overviewClick=function(){i.location.href="../app-oc/index.html#/dashboard"},o.equipmentClick=function(){i.location.href="../app-oc/index.html#/gateways2"},o.malfunctionClick=function(){i.location.href="../app-oc/index.html#/configAlert/0"},o.chartClick=function(){i.location.href="../app-oc/index.html#/designView"},o.panelShow=!1,o.$on("$destroy",function(){s.unregister(h)}),o.panelClick=function(){o.panelShow=!o.panelShow},o.ipcam={},o.camClick=function(){o.ipcam.openCam&&o.ipcam.openCam(),g=!0},o.closeCam=function(){o.ipcam.closeCam&&o.ipcam.closeCam(),g=!1},o.showCam=function(){return g},o.blinkClick=function(){if(o.alertOn=!o.alertOn,o.alertOn){for(var e in v)v[e].startBlink();o.health.startBlink()}else{for(var e in v)v[e].stopBlink();o.health.stopBlink()}},o.drawPos=function(e){return{top:100*e.topPortion+"%",left:100*e.leftPortion+"%",width:100*e.widthPortion+"%",height:100*e.heightPortion+"%",transform:"rotate(0deg)",position:"absolute"}},o.calcuRotation=function(e){return{transform:"rotate(-"+e.value+"deg)","-ms-transform":"rotate(-"+e.value+"deg)","-moz-transform":"rotate(-"+e.value+"deg)","-webkit-transform":"rotate(-"+e.value+"deg)","-o-transform":"rotate(-"+e.value+"deg)"}},t.current?w(p=t.current.params.deviceGroupId):o.$on("locationChanged",function(){w(p=t.current.params.deviceGroupId)})}e.initController("tglibraryPrevCtrl",t),t.$inject=["$scope","$q","serviceCenterService","$route","userLoginUIService","$location","viewFlexService","resourceUIService","$timeout","$window"],e.initController("tgedit",i),i.$inject=["$scope","$q","serviceCenterService","$route","$location","viewFlexService","resourceUIService","solutionUIService","$window","userLoginUIService"],e.initController("tglibraryCtrl",r),r.$inject=["$scope","$q","serviceCenterService","$route","$window","$location","resourceUIService","chartOptionService","SwSocket","$timeout","solutionUIService","userLoginUIService"]});
//# sourceMappingURL=../../../map/app-sc/js/controllers/tglibrary-ctrl.js.map
