define(["directives/directives","bootstrap-dialog","datatables.net","datatables.net-bs","datatables.net-select"],function(e,t){"use strict";e.initDirective("workFlowDom",["$timeout","$compile","growl","ngDialog","resourceUIService","commonMethodService","userRoleUIService",function(e,f,u,n,t,m,p){return{restrict:"EA",scope:!0,controller:["$scope","$element","$attrs",function(i,e,s){var r,a=e,o=new m,d=!1;function c(e,t){if(null!=e){var s="";for(var a in s+='<div class="nav-tabs-custom">',s+='<ul class="nav nav-tabs pull-left">',t)0==a?(i.flowList.userType=t[a].userType,i.flowList.taskId=t[a].taskId,i.tabStatus(t[a].userType,i.handerConfsData),s+='<li class="active"><a data-taskId="'+t[a].taskId+'" data-toggle="tab"  userType="'+t[a].userType+'"  taskId="'+t[a].taskId+'">'+t[a].taskName+"</a></li>"):s+='<li><a userType="'+t[a].userType+'" data-taskId="'+t[a].taskId+'"  taskId="'+t[a].taskId+'" data-toggle="tab">'+t[a].taskName+"</a></li>";s+="</ul>",s+='<div class="tab-content col-md-12">',s+='<form  class="form-horizontal tab-pane active" role="form" >',s+='<div class="table-responsive">',s+='<div class="col-md-12" ng-show="flowList.userType == \'role\'">',s+='<label class="col-md-1" class="control-label">已分配角色：{{}}</label>',s+='<div class="col-md-2" class="no-padding-lr" >',s+='<input maxlength="50" style="width: 80%;"  class="form-control input-sm" type="text" ng-model="flowList.assignedUser" disabled>',s+="</div>",s+='<label class="col-md-1" class="control-label">请选择用户：</label>',s+='<div class="col-md-4" class="no-padding-lr" >',s+='<select  id="userRole" name="userRole"  multiple="multiple"  numberdisplayed="1"  class="form-control input-sm" bootstrap-multiselect  nonselectedtext="所有用户" ng-options="item.userInfo.loginName as item.userInfo.userName for item in flowList.roleUser"  ng-change="changeRoleUsers(roleUsersMap)"  ng-model="roleUsersMap" >',s+="</select>",s+='<label style="color: #f56e00;" class="form-control no-border no-margin padding-left-20 light-label bg-transparent">(如果没有选用户默认所有用户)</label>',s+="</div>",s+='<label class="col-md-1" class="control-label">流程关联专业：</label>',s+='<div class="col-md-1" class="no-padding-lr" ><input type="checkbox" ng-model="handerConfsData[flowList.taskId].diffSpecialty" class="control-label"></div>',s+='<div><table class="table table-striped"><tr><td>用户名称</td><td>登录名</td><td>管理域</td><td>管理设备</td><td>操作</td></tr><tr ng-repeat="roleUser in roleUsers"><td>{{roleUser.userInfo.userName}}</td><td>{{roleUser.userInfo.loginName}}</td><td>{{roleUser.userInfo.customName}}</td><td>{{roleUser.userInfo.checkedName}}</td><td><button class="btn btn-primary btn-sm" ng-click="selectDevice(roleUser,$index)">设备选择</button><button class="btn btn-default btn-sm" ng-click="deleteDevice($index)">删除</button></td></tr></table></div>',s+="</div>",s+='<div  class="col-md-6" ng-show="flowList.userType == \'expression\'">',s+='<label class="col-sm-3 control-label">请输入表达式：</label>',s+='<div class=" col-sm-9 no-padding-lr" >',s+='<input maxlength="50" style="width: 80%;"  ng-model="handerConfsData[flowList.taskId].userExpressionOfCategory" class="form-control input-sm" type="text" >',s+="</div>",s+="</div>",s+='<div  class="col-md-6" ng-show="flowList.userType == \'user\'">',s+='<label class="col-sm-4 control-label">已分配的用户：</label>',s+='<div class="col-sm-8 no-padding-lr" >',s+='<input maxlength="50" style="width: 80%;"  class="form-control input-sm" type="text" ng-model="flowList.assignedUser" disabled>',s+="</div>",s+="</div>",s+='<div  class="col-md-6" ng-show="flowList.userType == \'group\'">',s+='<label class="col-sm-3 control-label">请选择用户：</label>',s+='<div class="no-padding-lr" >',s+='<select  id="userRole" name="userRole"  multiple="multiple"  numberdisplayed="1"  class="form-control input-sm" bootstrap-multiselect  nonselectedtext="所有用户" ng-options="item.userID as item.userName for item in flowList.groupUser "  ng-model="handerConfsData[flowList.taskId].userIdsOfRole">',s+="</select>",s+='<label style="color: #f56e00;" class="form-control no-border no-margin padding-left-20 light-label bg-transparent">(如果没有选用户默认所有用户)</label>',s+="</div>",s+="</div>",s+="</div>",s+="</form>",s+="</div>",s+="</div>"}return s}function l(e){var n={};if(e.userTaskConfigs&&0<e.userTaskConfigs.length&&(e.userTaskConfigs.forEach(function(e){n[e.userId]=e}),i.roleUsers=e.userTaskConfigs,i.roleUsersMap=e.userTaskConfigs.map(function(e){return e.userInfo.loginName})),"role"==e.userType){i.flowList.assignedUser=i.flowList.allRoles[e.roleIds].roleName;var t={roleID:e.roleIds[0]};p.getAssociateRole2User(t,function(e){0==e.code&&(i.flowList.roleUser=[],e.data.forEach(function(e){for(var t=o.getdomainNameHandler(e.domains,[]),s="",a=0;a<t.length;a++)s+=t[a]+"/";var l={userInfo:{customName:s,userName:e.userName,loginName:e.loginName,checkedName:n[e.userID]?n[e.userID].userInfo.checkedName:""},userId:e.userID,deviceList:n[e.userID]?n[e.userID].deviceList:""};i.flowList.roleUser.push(l)}))})}else"user"==e.userType&&(i.flowList.assignedUser=i.flowList.allUser[e.userIds].userName)}i.$on("WORKFLOW",function(e,t){r&&(r.destroy(),a.empty()),r=a.DataTable({dom:t&&0<t.length?$.ProudSmart.datatable.footerdom:"",language:$.ProudSmart.datatable.language,data:t,order:[[5,"desc"]],columns:[{data:"name",title:"名称"},{data:"desc",title:"描述"},{data:"category",title:"工单分类"},{data:"workflowId",title:"关联流程"},$.ProudSmart.datatable.optionCol2,{data:"createTime",visible:!1}],columnDefs:[{targets:0,data:"name",render:function(e,t,s){return 2!=s.isEdit&&3!=s.isEdit||"display"!=t?escape(e):"<input style='width:100%' class='form-control input-sm' type='text' value='"+escape(e)+"'>"}},{targets:1,data:"desc",render:function(e,t,s){return 2!=s.isEdit&&3!=s.isEdit||"display"!=t?escape(e):"<input maxlength='20' style='width:100%' class='form-control input-sm' type='text' value='"+escape(e)+"'>"}},{targets:2,data:"category",render:function(e,t,s){var a="";if(2!=s.isEdit&&3!=s.isEdit||"display"!=t){for(var l in i.workOrderType)if(i.workOrderType[l].valueCode==e){a=i.workOrderType[l].label;break}return a}return a='<div class="full-width padding-right-30"><select id="category"   name="category" class="form-control input-sm full-width" ng-model="flowList.category"  ng-options="item.valueCode as item.label  for item in workOrderType">><option value="">选择分类</option></select></div>'}},{targets:3,data:"workflowId",orderable:!1,render:function(e,t,s){var a="";return 3==s.isEdit&&"display"==t?a+='<div class="full-width padding-right-30"><select  id="flowId"   name="flowId"  class="form-control input-sm" ng-model="flowList.workflowId"  ng-options="item.id as item.name + &apos;:&apos; + item.version  for item in flows" select2><option  value="">选择流程</option></select></div>':2==s.isEdit&&"display"==t?a+='<div class="full-width padding-right-30"><select  id="flowId"   name="flowId"  class="form-control input-sm" ng-model="flowList.workflowId"  ng-options="item.id as item.name + &apos;:&apos; + item.version  for item in flows"><option  value="">选择流程</option></select></div>':e&&i.flowListDic&&null!=i.flowListDic[e]&&(a=i.flowListDic[e].name+":"+i.flowListDic[e].version),a}},{targets:4,data:"option",render:function(e,t,s){var a="<div class='btn-group btn-group-sm'>";return 2==s.isEdit||3==s.isEdit?(a+="<button id='save-btn'   class='btn btn-primary' ><i class='fa fa-edit hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'> 保存</span></button>",a+="<button id='cancel-btn'   class='btn btn-default' ><i class='fa fa-trash hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'> 取消</span></button>"):(i.menuitems.A02_S20&&(a+="<button id='edit-btn'  ng-click='addMod("+s.id+");'  class='btn btn-primary' ><i class='fa fa-edit hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'> 编辑</span></button>"),i.menuitems.A03_S20&&(a+="<button id='del-btn'   class='btn btn-default' ><i class='fa fa-trash hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'> 删除</span></button>")),a+="</div>"}}],rowCallback:function(e,t,s){f(e)(i)}})}),i.$on("table-search-handle",function(e,t){t.name==s.name&&r.search(t.value).draw()}),a.on("init.dt",function(){var e=$(".special-btn").parent();e.html('<a ng-click="addViews()" class="btn btn-default btn-sm"><i class="fa fa-plus"></i><span class="hidden-xs"> 新建关联流程</span></a>'),f(e)(i)}),i.changeRoleUsers=function(t){i.roleUsers=[],i.flowList.roleUser.forEach(function(e){-1<t.toString().indexOf(e.userInfo.loginName)&&i.roleUsers.push(e)})},i.queryDeviceName=function(e){i.deviceList=[],t.getDevicesByUserId(i.roleUser.userId,{label:e},function(e){if(0==e.code){var n=new m;e.data.forEach(function(e){for(var t=n.getdomainNameHandler(e.domains,[]),s="",a=3;a<t.length;a++)s+=t[a]+"/";if(-1==i.roleUser.userInfo.checkedName.indexOf(s+e.label)){var l={deviceId:e.id,label:s+e.label};i.deviceList.push(l)}})}})},i.selectDevice=function(e,t){i.index=t,i.roleUser=e,i.queryDeviceName(),e.userInfo.checkedName?i.checked=e.deviceList:i.checked=[],n.open({template:"../partials/dialogue/select_device_dia.html",className:"ngdialog-theme-plain",scope:i})},i.deleteDevice=function(e){i.roleUsers.splice(e,1),i.roleUsersMap=i.roleUsers.map(function(e){return e.userInfo.loginName})},i.checked=[],i.selectAll=function(e){e?angular.forEach(i.deviceList,function(e){e.checked=!0}):angular.forEach(i.deviceList,function(e){e.checked=!1})},i.selectAll2=function(e){e?angular.forEach(i.checked,function(e){e.checked=!0}):angular.forEach(i.checked,function(e){e.checked=!1})},i.moveSelectedDeviceList=function(){var t=[];i.deviceList.forEach(function(e){e.checked?i.checked.push(e):t.push(e)}),i.deviceList=t},i.moveOriginalDeviceList=function(){var t=[];i.checked.forEach(function(e){e.checked?i.deviceList.push(e):t.push(e)}),i.checked=t},i.saveSelectDevice=function(){var t="";i.checked.forEach(function(e){t+=e.label+";"}),i.roleUsers[i.index].deviceList=i.checked,i.roleUsers[i.index].userInfo.checkedName=t,i.handerConfsData[i.flowList.taskId].userTaskConfigs=i.roleUsers,n.close()},a.on("click","td",function(e){}),a.on("click","#view-btn",function(e){e.preventDefault();var t=$(this).closest("tr"),s=r.row(t).data();location.href="../app-flowsheet/index.html#/displayView/"+s.id}),a.on("click","#design-btn",function(e){e.preventDefault();var t=$(this).closest("tr");r.row(t);i.sx()}),a.on("click","#copy-btn",function(e){e.preventDefault();var t=$(this).closest("tr"),s=r.row(t).data();i.doAction("view-copy",s)}),i.$on("handerConfsData",function(e,t){l(t)}),a.on("click",'a[data-toggle="tab"]',function(e){l(i.handerConfsData[$(this).attr("data-taskId")])}),a.on("click","#edit-btn",function(e){if(e.preventDefault(),d)u.warning("当前有未保存的数据，请先保存",{});else{d=!0;var t=$(this).closest("tr"),s=r.row(t),a=s.data();if(s.data().isEdit=2,i.flowList.category=s.data().category,i.flowList.workflowId=s.data().workflowId,i.handerConfsData={},null!=a&&a.handerConfs){var l=a.handerConfs,n=[];for(var o in l)n.push(l[o]),i.handerConfsData[l[o].taskId]=l[o];0<n.length&&(s.child(c(s.data(),n)).show(),i.initEvent())}s.invalidate(),f(t)(i),f(t.next())(i)}}),a.on("click","#save-btn",function(e){e.preventDefault();var t=$(this).closest("tr"),s=r.row(t),a=s.data();if(2==a.isEdit||3==a.isEdit){var l=$(this).parents("tr").children(),n=!0;$.each(l,function(e,t){var s=$(t);if(0==e&&(0<s.children("input").length&&!(a=s.children("input").val())))return u.warning("视图名称不能空"),n=!1;if(0==e||1==e){var a=s.children("input").val();s.html(a),r.cell(s).data(a)}}),i.roleUsers&&0<i.roleUsers.length&&i.roleUsers.forEach(function(e){0==e.deviceList.length&&(n=!1,u.warning("所选用户的管理设备不能为空",{}))})}if(n){if(""==i.flowList.category||null==i.flowList.category)return u.warning("请选择工单分类",{}),void(n=!1);if(""==i.flowList.workflowId||null==i.flowList.workflowId)return u.warning("请选择关联流程",{}),void(n=!1);s.data().workflowId=i.flowList.workflowId,s.data().category=i.flowList.category,d=!1,i.doAction("view-save",a,function(e){e&&(d=!1,s.data().isEdit=0,s.cells().invalidate())})}}),a.on("click","#cancel-btn",function(e){e.preventDefault();var t=$(this).closest("tr"),s=r.row(t).data();d=!1,i.doAction("cancel",s)}),a.on("click","#del-btn",function(e){e.preventDefault();var t=$(this).closest("tr"),s=r.row(t);s.data().isDel=!0;var a=s.data();i.doAction("attr-delete",a,function(e){e&&s.remove().draw(!1)})}),a.on("click","#release-btn",function(e){e.preventDefault();var t=$(this).closest("tr"),s=r.row(t);s.data().isDel=!0;var a=s.data();i.doAction("release",a)}),a.on("change","#flowId",function(e){e.preventDefault();var t=$(this).closest("tr"),s=r.row(t),a=i.flowListDic[i.flowList.workflowId];if(null!=a&&a.handerConfs){var l=a.handerConfs,n=[];for(var o in l)n.push(l[o]),i.handerConfsData[l[o].taskId]=l[o];0<n.length&&(s.child(c(s.data(),n)).show(),f(t.next())(i),i.initEvent())}})}]}}])});
//# sourceMappingURL=../../../map/app-oc/js/directives/workorder-procedure-copy-dom.js.map
