define(["controllers/controllers","bootstrap-dialog"],function(e,b){"use strict";e.initController("alertRulesCtrl",["$scope","resourceUIService","$q","dictionaryService","unitService","customerUIService","projectUIService","userDomainService","ngDialog","$location","$routeParams","$timeout","userLoginUIService","Info","growl",function(a,l,n,e,t,s,i,o,r,c,d,u,f,m,p){a.routePathNodes={},a.alertRulesLists=[],a.modelLists=[],a.showType=d.type,a.mistakeMesg={};var I=[];function y(){a.selectedItem={title:"",modelId:"",nodeIds:"",domain:""},a.alertRulesInfo={id:0,title:"",kpiCode:"",desc:"",enabled:!1,condition:"",refValue:"",severity:"",modelId:"",alertCode:"",ruleType:"",domain:"",nodeIds:"",customerId:"",projectId:"",classify:"",risingTime:new Date}}a.selectedCount=0,a.abled=!1,a.unabled=!1,a.Category=[{index:"",label:"全部"},{index:"FAULT",label:"故障"},{index:"ALERT",label:"测点"}],a.severiesList=[{severNo:1,severName:"警告"},{severNo:2,severName:"次要"},{severNo:3,severName:"重要"},{severNo:4,severName:"严重"}],a.condition=[{name:"大于",value:"compare(value,refValue)>0"},{name:"大于等于",value:"compare(value,refValue)>=0"},{name:"等于",value:"compare(value,refValue)=0"},{name:"小于",value:"compare(value,refValue)<0"},{name:"小于等于",value:"compare(value,refValue)<=0"},{name:"表达式",value:""}],a.closeDialog=function(){r.close()},a.addAlertRules=function(e){y(),"global"==e?location.href="#/alertRules/global/0/edit":"special"==e&&(location.href="#/alertRules/special/0/edit")},a.saveData=function(){var i=$.extend({},a.alertRulesInfo,!0);if(i.title)if(i.domain)if(i.modelId||"global"!=a.showType)if(i.kpiCode)if(i.refValue)if(i.alertCode)if(i.severity){if("global"!=a.showType){var e=i.modelId;if((!e||300==e)&&i.domain){i.modelId=300;var t=i.domain.split("/");i.nodeIds=t[t.length-2]}e&&301!=e||!i.customerId||(i.modelId=301,i.nodeIds=i.customerId),e&&302!=e||!i.projectId||(i.modelId=302,i.nodeIds=i.projectId)}0<i.id?l.updateKpiThreshold(i,function(e){if(0==e.code){0<d.rulesId&&(300!=i.modelId&&301!=i.modelId&&302!=i.modelId||(i.nodeIds="")),a.alertRulesInfo=i,p.success("告警规则信息修改完成",{});var t=a.alertRulesLists;for(var s in t)if(t[s].id==i.id){$.extend(t[s],i);break}u(function(){a.$broadcast(Event.ALERTRULESINIT+"_rules",{option:[a.alertRulesLists]})})}}):0==i.id&&l.addKpiThreshold(i,function(e){0==e.code&&(i=e.data,0<d.rulesId&&(300!=i.modelId&&301!=i.modelId&&302!=i.modelId||(i.nodeIds="")),a.alertRulesInfo.id=i.id,a.alertRulesLists.push(i),u(function(){a.$broadcast(Event.ALERTRULESINIT+"_rules",{option:[a.alertRulesLists]})}),p.success("告警规则信息添加成功",{}))})}else p.warning("请选择告警级别",{});else p.warning("请选择告警类别",{});else p.warning("请填写阈值",{});else p.warning("请选择数据项",{});else p.warning("请选择资源类型",{});else p.warning("请选择管理域",{});else p.warning("请输入规则名称",{})},a.doAction=function(e,o,n,t){if("deleteAlertRules"==e)b.show({title:"提示",closable:!1,message:t?"确认要删除此告警规则吗？":"当前有 "+o.length+"个告警规则可删除，确认要删除吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){l.deleteKpiThresholds([o],function(e){if(n(e),0==e.code){var t=a.alertRulesLists;for(var s in o)for(var i in t)t[i].id==o[s]&&t.splice(i,1);a.selectedCount=0,a.abled=!1,a.unabled=!1}}),e.close()}},{label:"取消",action:function(e){n(!1),e.close(),a.selectedCount=0,a.abled=!1,a.unabled=!1,a.$apply()}}]});else if("AlertEnable"==e){var s=o[1];b.show({title:"提示",closable:!1,message:s?t?"确认要启用此告警规则吗？":"当前有 "+o[0].length+"个告警规则未启用，确认要启用吗？":t?"确认要停用此告警规则吗？":"当前有 "+o[0].length+"个告警规则未停用，确认要停用吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){l.enabledKpiThresholds(o,function(e){if(n(e),0==e.code)return a.unabled=a.abled=!1,void(a.selectedCount=0)}),e.close()}},{label:"取消",action:function(e){n(!1),a.selectedCount=0,a.abled=!1,a.unabled=!1,a.$apply(),e.close()}}]})}else"copy"==e&&l.copyKpiThresholdById([o.id],function(e){0==e.code&&(p.success("告警规则信息复制成功",{}),a.alertRulesLists.push(e.data),u(function(){a.$broadcast(Event.ALERTRULESINIT+"_rules",{option:[a.alertRulesLists]})}),n(e))})},a.selectModel=function(){a.queryKpis(a.alertRulesInfo.classify)};var v=!(a.selkpisByDevice=function(e){var t=e.id.replace(/[^0-9]+/g,"").split("").join("");for(var s in a.allDeveicesList)if($.trim(t)==a.allDeveicesList[s].id){a._modelId=a.allDeveicesList[s].modelId,a.alertRulesInfo.modelId=a.allDeveicesList[s].modelId;break}a.queryKpis(a.alertRulesInfo.classify)});a.selkpisByDomains=function(){"global"!=a.showType&&a.alertRulesInfo.domain&&v&&(a.alertRulesInfo.modelId="300",a.alertRulesInfo.customerId="",a.alertRulesInfo.projectId="",a.alertRulesInfo.classify="",a.alertRulesInfo.nodeIds="",a.queryKpis("")),v=!0},a.selkpisByCustomer=function(){a.alertRulesInfo.customerId&&(a.alertRulesInfo.modelId="301",a.alertRulesInfo.projectId="",a.alertRulesInfo.classify="",a.alertRulesInfo.nodeIds="",a.queryKpis(""))},a.selkpisByProject=function(){a.alertRulesInfo.projectId&&(a.alertRulesInfo.modelId="302",a.alertRulesInfo.classify="",a.alertRulesInfo.nodeIds="",a.queryKpis(""))},a.kpisLists=[],a.queryKpis=function(e){var t=a.alertRulesInfo.modelId,s=[];if(a.kpiListsDic&&a.kpiListsDic[t]){for(var i in a.kpiListsDic[t]){var o=a.kpiListsDic[t][i];"fault"==o.type&&"FAULT"==e?s.push(o):"kpi"==o.type&&"ALERT"==e?s.push(o):"FAULT"!=e&&"ALERT"!=e&&s.push(o)}a.kpisLists=s,u(function(){a.$apply()})}},a.changeVal=function(){a.alertRulesInfo.refValue&&(a.alertRulesInfo.refValue="",a.mistakeMesg.number=!1)},a.verifyFun=function(e,t){var s;if("phone"==t){s=/^((1[34578]\d{9})|(0\d{2,4}\-\d{7,8})|\d{8})$/.test(e),a.mistakeMesg.phone=!s}else"email"==t?(s=/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/.test(e),a.mistakeMesg.email=!s):"number"==t&&a.alertRulesInfo.condition?(s=/^[+-]?([1-9][0-9]*|0)(\.[0-9]+)?%?$/.test(e),a.mistakeMesg.number=!s):"number"!=t||a.alertRulesInfo.condition||(0==$.trim(e).length?a.mistakeMesg.number=!0:a.mistakeMesg.number=!1)},a.kpiLists={},a.kpiListsDic={};var h=function(){a.kpiLists={};var t=n.defer();l.getModels(function(e){var i=[];if(0==e.code){var o=[];e.data.push({id:300,label:"管理域类型"}),a.baseConfig&&a.baseConfig.customerConfig&&a.baseConfig.customerConfig.display&&e.data.push({id:301,label:"客户域类型"}),a.baseConfig&&a.baseConfig.projectConfig&&a.baseConfig.projectConfig.display&&e.data.push({id:302,label:"项目域类型"}),e.data.forEach(function(e){var t,s;i.push((t=e.id,s=n.defer(),l.getDataItemsByModelId(t,function(e){0==e.code&&(e.data.forEach(function(e){e.text=e.label,a.kpiLists[e.id]=e}),a.kpiListsDic[t]=e.data,s.resolve("success"))}),s.promise)),e.text=e.label,e.id=e.id,o.push(e)}),a.allModelLists=o}n.all(i).then(function(){t.resolve("success")})}),I.push(t.promise)};var T,g;T=n.defer(),i.findProjectsByCondition({},function(e){if(0==e.code){var t=[];e.data.forEach(function(e){e.text=e.projectName,e.id=e.id,t.push(e)}),a.projectList=t,T.resolve("asdasd")}}),I.push(T.promise),g=n.defer(),s.findCustomersByCondition({},function(e){if(0==e.code){var t=[];e.data.forEach(function(e){e.text=e.customerName,e.id=e.id,t.push(e)}),a.CustomerList=t,a.customerDic=e.customerDic}g.resolve("asdasd")}),I.push(g.promise),a.allAlertClassify=function(t){var s=n.defer();l.findAlertDefinitions({},function(e){0==e.code&&(e.data.forEach(function(e){e.name?e.text=e.label+"（"+e.name+"）":e.text=e.label}),a.alertClassifyLists=[{id:0,text:"请选择..."}].concat(e.data)),t?p.success("操作成功!"):s.resolve("success")}),t||I.push(s.promise)},a.getChange=function(){1==a.queryState?(a.selectedItem.modelId="",a.selectedItem.nodeIds="",a.selectedItem.domain=""):2==a.queryState?(a.selectedItem.domain="",a.selectedItem.nodeIds="",a.selectedItem.title=""):3==a.queryState?(a.selectedItem.domain="",a.selectedItem.modelId="",a.selectedItem.title=""):4==a.queryState&&(a.selectedItem.title="",a.selectedItem.modelId="",a.selectedItem.nodeIds="")},a.searchData=function(){var e={nodeIds:d.nodeId?d.nodeId:a.selectedItem.nodeIds,alertCode:d.alertCode?d.alertCode:a.selectedItem.alertCode,modelId:a.selectedItem.modelId,domain:a.selectedItem.domain?a.selectedItem.domain:"",id:d.rulesId?d.rulesId:a.selectedItem.id,title:a.selectedItem.title};l.findKpiThresholds(e,function(e){if(0==e.code){if(0<d.rulesId)return e.data[0].nodeIds=parseInt(e.data[0].nodeIds),300!=e.data[0].modelId&&301!=e.data[0].modelId&&302!=e.data[0].modelId||(e.data[0].nodeIds=""),a.alertRulesInfo=e.data[0],void a.queryKpis(a.alertRulesInfo.classify);a.alertRulesLists=e.data,u(function(){a.$broadcast(Event.ALERTRULESINIT+"_rules",{option:[a.alertRulesLists]})})}})};var L=function(){var s,t;y(),a.allAlertClassify(),s=n.defer(),l.getDevicesByCondition({},function(e){if(0==e.code){var t=[];e.data.forEach(function(e){e.text=e.label,e.id=e.id,t.push(e)}),a.allDeveicesList=t}s.resolve("success")}),I.push(s.promise),t=n.defer(),o.queryDomainTree(f.user.userID,function(e){a.domainListTree=e.domainListTree,a.domainListDic=e.domainListDic,t.resolve("success")}),I.push(t.promise),h(),n.all(I).then(function(){a.searchData()}),"edit"==d.viewType?a.showView=!0:a.showView=!1};f.user.isAuthenticated?L():a.$on("loginStatusChanged",function(e,t){f.user.isAuthenticated&&L()})}]),e.initController("alertClassifyCtrl",["$scope","resourceUIService","userDomainService","ngDialog","$location","$routeParams","$timeout","userLoginUIService","Info","growl",function(a,t,e,o,s,i,n,l,r,c){function d(){a.selectedItem={orCondition:"",label:"",name:"",description:""},a.alertClassifyInfo={id:0,label:"",name:"",description:"",risingTime:new Date}}a.alertClassifyLists=[],a.mistakeMesg={},a.selectedCount=0,a.closeDialog=function(){o.close()},a.addalertClassify=function(){d(),o.open({template:"../partials/dialogue/alert_classification_dia.html",className:"ngdialog-theme-plain",scope:a})},a.saveData=function(){var i=a.alertClassifyInfo;0<i.id?t.updateAlertDefinition(i,function(e){if(0==e.code){c.success("告警类别修改完成",{});var t=a.alertClassifyLists;for(var s in t)if(t[s].id==i.id){$.extend(t[s],i);break}n(function(){a.$broadcast(Event.ALERTRULESINIT+"_classify",{option:[a.alertClassifyLists]})}),o.close()}}):0==i.id&&t.addAlertDefinition(i,function(e){0==e.code&&(c.success("告警类别添加成功",{}),a.alertClassifyLists.push(e.data),n(function(){a.$broadcast(Event.ALERTRULESINIT+"_classify",{option:[a.alertClassifyLists]})}),o.close())})},a.doAction=function(e,o,n){"deleteAlertClassify"==e&&b.show({title:"提示",closable:!1,message:"确认删除已选中告警类别记录？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){t.deleteAlertDefinition([o],function(e){if(n(e.code),0==e.code){var t=a.alertClassifyLists;for(var s in o)for(var i in t)t[i].id==o[s]&&t.splice(i,1);return a.selectedCount=0,void c.success("告警类别记录已删除",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]})},a.getChange=function(){a.selectedItem.orCondition=a.queryState?null:a.selectedItem.orCondition,a.selectedItem.label=1==a.queryState?a.selectedItem.label:null,a.selectedItem.name=2==a.queryState?a.selectedItem.name:null,a.selectedItem.description=3==a.queryState?a.selectedItem.description:null},a.verifyFun=function(e,t){var s;"length"==t&&(s=/^(?!.{33}|^\s*$)/.test(e),a.mistakeMesg.length=!s)},a.searchData=function(){var e={id:i.id?i.id:a.selectedItem.id,orCondition:a.selectedItem.orCondition,name:a.selectedItem.name,description:a.selectedItem.description?a.selectedItem.description:"",label:a.selectedItem.label};t.findAlertDefinitions(e,function(e){0==e.code&&(a.alertClassifyLists=e.data,n(function(){a.$broadcast(Event.ALERTRULESINIT+"_classify",{option:[a.alertClassifyLists]})}))})};var u=function(){d(),a.searchData()};l.user.isAuthenticated?u():a.$on("loginStatusChanged",function(e,t){l.user.isAuthenticated&&u()})}]),e.initController("alertInformCtrl",["$scope","resourceUIService","$q","dictionaryService","userEnterpriseService","userDomainService","ngDialog","$location","$routeParams","$timeout","userLoginUIService","Info","growl",function(a,l,n,e,i,t,r,s,o,c,d,u,f){a.routePathNodes={},a.alertInformLists=[],a.allModelLists=[],a.selectedCount=0;var m=[],p=o.alertInformsId;function I(){a.selectedItem={label:"",modelId:"",name:""},a.alertInformsInfo={id:0,kpiThresholdId:p,ruleName:"",personType:"",noticeRole:"",templates:[{noticeWay:"",noticeRole:"",noticeTemplate:"",contact:""}],risingTime:new Date}}a.mistakeMesg={email:!1,phone:!1};a.closeDialog=function(){r.close()},a.addalertInforms=function(){I(),a.templates.forEach(function(e){e.state=!0,e.contact=""}),r.open({template:"../partials/dialogue/alert_inform_dia.html",className:"ngdialog-theme-plain",scope:a})},a.saveData=function(){var s=a.alertInformsInfo,e=a.templates.filter(function(e){return 1==e.state&&e.personType==s.personType});if(0!=(s.templates=e).length||"outSystem"!=s.personType){if("outSystem"==s.personType)for(var t in e)if(""==e[t].contact)return void f.warning("请输入完成"+e[t].noticeWayLabel+"信息");if(a.mistakeMesg.phone&&"outSystem"==s.personType)f.warning("请正确输入手机号",{});else if(a.mistakeMesg.email&&"outSystem"==s.personType)f.warning("请输入正确的邮箱地址",{});else if(0!=s.noticeRole&&""!=s.noticeRole||"inSystem"!=s.personType){var i=v(s);if(0<s.id){if(a.alertInformDic[i])if(!a.alertInformDic[i].find(function(e){return e.id==s.id}))return void f.warning("该通知信息已经有类似的，请选中【"+a.alertInformDic[i][0].ruleName+"】",{});var o=[];a.alertInformDic[s.ruleTempName].forEach(function(e){var t=n.defer();e.ruleName=s.ruleName,e.noticeRole=s.noticeRole,e.templates=s.templates,e.personType=s.personType,l.updateNoticeRule(e,function(e){0==e.code&&t.resolve("success")}),o.push(t.promise)}),n.all(o).then(function(){f.success("告警通知信息修改完成",{});var e=a.alertInformLists;for(var t in e)if(e[t].id==s.id){$.extend(e[t],s);break}c(function(){a.$broadcast(Event.ALERTRULESINIT+"_informs",{option:[a.alertInformLists]})}),r.close()})}else if(0==s.id){if(a.alertInformDic[i])return void f.warning("该通知信息已经有类似的，请选中【"+a.alertInformDic[i][0].ruleName+"】",{});l.addNoticeRule(s,function(e){if(0==e.code){f.success("告警通知信息添加成功",{});var t=e.data;t.ruleTempName=i,t.kpiThresholdIds=[p],t.selected=!0,a.alertInformLists.push(t),a.alertInformDic[i]=[t],c(function(){a.$broadcast(Event.ALERTRULESINIT+"_informs",{option:[a.alertInformLists]})}),r.close()}})}}else f.warning("请选择通知角色",{})}else f.warning("请手机号或邮箱选其一进行填写",{})},a.doAction=function(e,s,i){if("deleteAlertForm"==e)b.show({title:"提示",closable:!1,message:"如删除该告警通知记录，则基于该通知的告警规则都会失效，确认要删除么？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){var t=[];a.alertInformDic[s.ruleTempName].forEach(function(e){t.push(e.id)}),l.deleteNoticeRule([t],function(e){if(0==e.code){for(var t in i(e.code),a.alertInformLists)a.alertInformLists[t].id==s.id&&a.alertInformLists.splice(t,1);return delete a.alertInformDic[s.ruleTempName],a.selectedCount=0,void f.success("告警通知信息已删除",{})}i(e.code)}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("enabled"==e){var t=jQuery.extend(!0,{},s);t.id=0,t.kpiThresholdId=p,l.addNoticeRule(t,function(e){if(0==e.code){f.success("告警通知信息启用成功",{});var t=e.data;t.ruleTempName=s.ruleTempName,s.kpiThresholdIds.push(p),a.alertInformDic[s.ruleTempName]=[t]}})}else if("disabled"==e){for(var o=null,n=a.alertInformDic[s.ruleTempName].length-1;-1<n;n--)a.alertInformDic[s.ruleTempName][n].kpiThresholdId==p&&(o=a.alertInformDic[s.ruleTempName][n],a.alertInformDic[s.ruleTempName].splice(n,1));0<a.alertInformDic[s.ruleTempName].length?l.deleteNoticeRule([[o.id]],function(e){0==e.code&&f.success("告警通知信息停用成功",{})}):(o.kpiThresholdId=0,l.updateNoticeRule(o,function(e){0==e.code&&f.success("告警通知信息停用成功",{})}))}},a.changeRole=function(e){"outSystem"==e&&(a.alertInformsInfo.noticeRole="")},a.alertFun=function(e){e.state?(e.state=!1,e.contact=""):e.state=!0},a.verifyFun=function(e,t){var s;if("sms"==t){if(!e)return void(a.mistakeMesg.phone=!1);s=/^((1[34578]\d{9})|(0\d{2,4}\-\d{7,8})|\d{8})$/.test(e),a.mistakeMesg.phone=!s}else if("email"==t){if(!e)return void(a.mistakeMesg.email=!1);s=/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/.test(e),a.mistakeMesg.email=!s}},a.queryType=function(e){for(var t in a.alertInformsInfo.resourceType="",a.notifications=[],a.notificationList){"sysmessage"==a.notificationList[t].valueCode&&"outSystem"==e||a.notifications.push(a.notificationList[t])}a.alertInformsInfo.noticeWay&&a.queryMesg(a.alertInformsInfo.noticeWay)},a.queryMesg=function(t){a.alertInformsInfo.resourceType="",a.queryTemplLists=[],y.forEach(function(e){e.noticeWay==t&&e.personType==a.alertInformsInfo.personType&&a.queryTemplLists.push(e)}),"sms"==a.alertInformsInfo.noticeWay?a.verifyFun(a.alertInformsInfo.contact,"phone"):"email"==a.alertInformsInfo.noticeWay&&a.verifyFun(a.alertInformsInfo.contact,"email")};var y=[];a.getChange=function(){1==a.queryState?(a.selectedItem.modelId="",a.selectedItem.name=""):2==a.queryState?(a.selectedItem.label="",a.selectedItem.name=""):3==a.queryState&&(a.selectedItem.label="",a.selectedItem.modelId="")},a.searchData=function(){var e={ruleName:a.selectedItem.ruleName,personType:a.selectedItem.personType?a.selectedItem.personType:"",noticeWay:a.selectedItem.noticeWay?a.selectedItem.noticeWay:""};l.findNoticeRules(e,function(e){if(0==e.code){a.alertInformDic={};var t=[];for(var s in e.data.forEach(function(e){if(!e.kpiThresholdIds||e.kpiThresholdId&&0==e.kpiThresholdIds.length){var t=v(e);a.alertInformDic[t]||(a.alertInformDic[t]=[]),a.alertInformDic[t].push(e)}else{t=v(e);a.alertInformDic[t]||(a.alertInformDic[t]=[]),a.alertInformDic[t].push(e)}}),a.alertInformDic){var i=null;a.alertInformDic[s].forEach(function(e){i||((i=jQuery.extend(!0,{},e)).ruleTempName=s,i.kpiThresholdIds=[]),e.kpiThresholdId==p&&(i.selected=!0),i.kpiThresholdIds.push(e.kpiThresholdId)}),t.push(i)}a.alertInformLists=t,c(function(){a.$broadcast(Event.ALERTRULESINIT+"_informs",{option:[a.alertInformLists]})})}})};var v=function(e){var t="";return e.templates&&e.templates.forEach(function(e){t+=e.noticeWay+e.contact+"|"}),"noticeRole:"+e.noticeRole+"&personType:"+e.personType+"&templates:"+t},h=function(){var s=function(){var t,s;a.notificationType=a.myDicts.noticePersonType,a.notificationList=a.myDicts.noticeWay,a.templates=[],a.notificationList.forEach(function(s){"sysmessage"!=s.valueCode&&a.notificationType.forEach(function(e){var t={personType:e.valueCode,personTypeLabel:e.label,noticeWay:s.valueCode,noticeWayLabel:s.label,state:!0,noticeRole:"",noticeTemplate:"",contact:""};a.templates.push(t)})}),a.templates.push({personType:"inSystem",personTypeLabel:"系统人员",noticeWay:"sysmessage",noticeWayLabel:"站内消息",state:!0,noticeRole:"",noticeTemplate:"",contact:""}),I(),t=n.defer(),i.queryEnterpriseRole(function(e){0==e.code&&(e.data.forEach(function(e){e.id=e.roleID,e.text=e.roleName}),a.allRoles=e.data?e.data:[]),t.resolve("success")}),m.push(t.promise),s=n.defer(),l.findTemplateByCondition("alert",function(e){0==e.code&&(y=e.data,a.templLists=e.data,a.templates.forEach(function(t){y.forEach(function(e){t.noticeWay==e.noticeWay&&t.personType==e.personType&&(t.noticeTemplate=e.id,t.noticeTemplateDesc=e.desc)})})),s.resolve("success")}),m.push(s.promise),n.all(m).then(function(){a.searchData()})};a.myDicts?s():a.$watch("myDicts",function(e,t){e&&s()})};d.user.isAuthenticated?h():a.$on("loginStatusChanged",function(e,t){d.user.isAuthenticated&&h()})}]),e.initController("kpiTypeCtrl",["$scope","resourceUIService","userDomainService","ngDialog","$location","$routeParams","$timeout","userLoginUIService","Info","growl",function(a,t,e,o,s,i,n,l,r,c){function d(){a.selectedItem={orCondition:"",label:"",name:"",description:""},a.kpiTypeInfo={id:0,label:"",name:"",unit:"",number:"",type:"",range:"",icon:""}}a.kpiTypeLists=[],a.mistakeMesg={},a.selectedCount=0,a.closeDialog=function(){o.close()},a.addkpiType=function(){d(),o.open({template:"../partials/dialogue/kpi_type_dia.html",className:"ngdialog-theme-plain",scope:a})},a.saveKpiType=function(){var i=a.kpiTypeInfo;0<i.id?t.saveKpiType(i,function(e){if(0==e.code){c.success("数据项修改完成",{});var t=a.kpiTypeLists;for(var s in t)if(t[s].id==i.id){$.extend(t[s],i);break}n(function(){a.$broadcast(Event.ALERTRULESINIT+"_kpitype",{option:[a.kpiTypeLists]})}),o.close()}}):0==i.id&&t.saveKpiType(i,function(e){0==e.code&&(c.success("数据项添加成功",{}),a.kpiTypeLists.push(e.data),n(function(){a.$broadcast(Event.ALERTRULESINIT+"_kpitype",{option:[a.kpiTypeLists]})}),o.close())})},a.doAction=function(e,o,n){"deleteAlertClassify"==e&&b.show({title:"提示",closable:!1,message:"确认删除已选中数据项？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){t.deleteKpiTypeByIds([o],function(e){if(n(e.code),0==e.code){var t=a.kpiTypeLists;for(var s in o)for(var i in t)t[i].id==o[s]&&t.splice(i,1);return a.selectedCount=0,void c.success("数据项记录已删除",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]})},a.getChange=function(){a.selectedItem.orCondition=a.queryState?null:a.selectedItem.orCondition,a.selectedItem.label=1==a.queryState?a.selectedItem.label:null,a.selectedItem.name=2==a.queryState?a.selectedItem.name:null,a.selectedItem.description=3==a.queryState?a.selectedItem.description:null},a.verifyFun=function(e,t){var s;"length"==t&&(s=/^(?!.{33}|^\s*$)/.test(e),a.mistakeMesg.length=!s)},a.searchData=function(){var e={label:a.selectedItem.label};t.getKpiTypeByFilter(e,function(e){0==e.code&&(a.kpiTypeLists=e.data,n(function(){a.$broadcast(Event.ALERTRULESINIT+"_kpitype",{option:[a.kpiTypeLists]})}))})};var u=function(){d(),a.searchData()};l.user.isAuthenticated?u():a.$on("loginStatusChanged",function(e,t){l.user.isAuthenticated&&u()})}])});
//# sourceMappingURL=../../../map/app-oc/js/controllers/alert-rules-ctrl.js.map
