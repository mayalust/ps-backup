define(["controllers/controllers","bootstrap-dialog"],function(e,d){"use strict";e.initController("UserClientCtrl",["$scope","$routeParams","$timeout","ngDialog","distributorUIService","userLoginUIService","customerUIService","userEnterpriseService","growl","userRoleUIService","userFunctionService","userDomainService","solutionUIService","userUIService","$location",function(c,l,u,m,p,i,h,e,f,t,a,v,n,b,I){c.userSearch={};var g=null;c.selectedItem={orCondition:"",customerName:"",customerAddress:"",domainPath:"",customerPhone:""};var s=!(c.selectedDealItem={domainPath:"",id:"",distributorName:"",distributorAddress:"",contactPhone:"",orCondition:""});function r(){c.inputItem={userMain:{customerName:"",customerEmail:"",customerPhone:"",customerAddress:"",customerContact:"",domainPath:"",duty:"",values:{},risingTime:new Date},dealer:{domainPath:"",distributorName:"",distributorContact:"",contactDuty:"",contactPhone:"",email:"",distributorAddress:"",risingTime:new Date},clientOther:{contactName:"",contactDuty:"",contactPhone:"",contactEmail:""}}}function D(e,t){"client"==e&&"other"==t?u(function(){c.$broadcast(Event.CLIENTMANAGEINIT,c.userGridData)}):"dealer"==e&&u(function(){c.$broadcast(Event.CLIENTMANAGEINIT+"_dealer",c.dealerGridData)})}-1<location.hash.search("#/dealerInfo")&&(s=!0),c.mistakeMesg={email:!1,phone:!1},c.$watch("myDicts",function(e,t){e&&(c.jobs=c.myDicts.jobTitle)}),c.othercontactlist=[],c.getChange=function(e){"searchDealer"==e?(c.selectedDealItem.orCondition=c.queryState?null:c.selectedDealItem.orCondition,c.selectedDealItem.domainPath=1==c.queryState?c.selectedDealItem.domainPath:null,c.selectedDealItem.distributorName=2==c.queryState?c.selectedDealItem.distributorName:null,c.selectedDealItem.distributorAddress=3==c.queryState?c.selectedDealItem.distributorAddress:null,c.selectedDealItem.contactPhone=4==c.queryState?c.selectedDealItem.contactPhone:null):(c.selectedItem.orCondition=c.queryState?null:c.selectedItem.orCondition,c.selectedItem.domainPath=1==c.queryState?c.selectedItem.domainPath:null,c.selectedItem.customerName=2==c.queryState?c.selectedItem.customerName:null,c.selectedItem.customerAddress=3==c.queryState?c.selectedItem.customerAddress:null,c.selectedItem.customerPhone=4==c.queryState?c.selectedItem.customerPhone:null)},c.userGridData={columns:[{title:(c.menuitems.S12&&c.menuitems.S12.label?c.menuitems.S12.label:"客户")+"归属",data:"domainPath"},{title:(c.menuitems.S12&&c.menuitems.S12.label?c.menuitems.S12.label:"客户")+"名称",data:"customerName"},{title:"主要联系人",data:"customerContact"},{title:"联系人职务",data:"duty"},{title:"联系电话",data:"customerPhone"},{title:"邮箱地址",data:"customerEmail"},{title:(c.menuitems.S12&&c.menuitems.S12.label?c.menuitems.S12.label:"客户")+"地址",data:"customerAddress",render:function(e,t,a,i){var n=e;return null!=a.values&&null!=a.values&&null!=a.values.standardAddress&&null!=a.values.standardAddress&&(n=a.values.standardAddress.split(",").join("")+" "+e),n}},{title:"",data:"risingTime",visible:!1},$.ProudSmart.datatable.optionCol3],columnDefs:[{targets:0,data:"domainPath",render:function(e,t,a){var i="";return(e=escape(e))&&c.domainListDic[e]&&(i=c.domainListDic[e].label),i}},{targets:1,data:"customerName",render:function(e,t,a){return escape(e)}},{targets:2,data:"customerContact",render:function(e,t,a){return escape(e)}},{targets:3,data:"duty",render:function(e,t,a){var i="";for(var n in c.jobs)c.jobs[n].valueCode==e&&(i=c.jobs[n].label);return i}},{targets:4,data:"customerPhone",render:function(e,t,a){return e}},{targets:5,data:"customerEmail",render:function(e,t,a){return e}},{targets:6,data:"customerAddress",render:function(e,t,a){var i=e;return null!=a.values&&null!=a.values&&null!=a.values.standardAddress&&null!=a.values.standardAddress&&(i=a.values.standardAddress.split(",").join("")+" "+e),i}},{targets:8,data:"option",render:function(e,t,a){var i="<div class='btn-group btn-group-sm'>";return c.menuitems.A03_S12&&(i+="<button id='edit-btn' class='btn btn-primary btn-sm' ><i class='fa fa-edit hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'> 编辑</span></button>"),c.menuitems.A04_S12&&(i+="<button id='del-btn' class='btn btn-default btn-sm'><i class='fa fa-edit hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'>删除</span></button>"),c.menuitems.A01_S12&&(i+="<button  type='button' class='btn btn-default btn-sm dropdown-toggle' data-toggle='dropdown'> 更多<span class='caret'></span></button>",i+="<ul class='dropdown-menu' role='menu'>",c.menuitems.A01_S12&&(i+="<li><a  href='#/projectManagement/"+a.id+"'>项目信息</a></li></ul>")),i+="</div>"}}]},c.provinceClick=function(e){c.inputItem.userMain.county="",c.cityDics[e]&&(c.cityList=c.cityDics[e])},c.cityClick=function(e){c.districtDics[e]&&(c.districtList=c.districtDics[e])},c.dealerGridData={columns:[{title:"经销商归属",data:"domainPath"},{title:"经销商名称",data:"distributorName"},{title:"联系人",data:"distributorContact"},{title:"联系人职务",data:"contactDuty"},{title:"联系电话",data:"contactPhone"},{title:"邮箱地址",data:"email"},{title:"经销商地址",data:"distributorAddress"},{title:"",data:"risingTime",visible:!1},$.ProudSmart.datatable.optionCol3],columnDefs:[{targets:0,data:"domainPath",render:function(e,t,a){return 2==a.isEdit&&"display"==t?"<div class='dropdowntree select-sm' name='domainPath' key='domainPath' placeholder='请选择...' model='"+e+"' change='' options='domainListTree' mark='nodes' />":e&&c.domainDealerListDic[e]?c.domainDealerListDic[e].name:""}},{targets:1,data:"distributorName",render:function(e,t,a){return 2==a.isEdit&&"display"==t?"<input class='form-control col-xs-6' type='text'  maxlength='20'  style='border: 1px solid #F18282;width:100%;' value='"+escape(e)+"'>":escape(e)}},{targets:2,data:"distributorContact",render:function(e,t,a){return 2==a.isEdit&&"display"==t?"<input class='form-control col-xs-6' type='text'  maxlength='20'  style='border: 1px solid #F18282;width:100%;' value='"+escape(e)+"'>":escape(e)}},{targets:3,data:"contactDuty",render:function(e,t,a){if(2==a.isEdit&&"display"==t){var i='<select class="form-control input-sm " style="border: 1px solid #F18282;width:100%;"><option value=""></option>';for(var n in c.jobs)c.jobs[n].valueCode==e&&(i+='<option value="'+c.jobs[n].valueCode+'" selected="selected">'+c.jobs[n].label+"</option>"),i+='<option value="'+c.jobs[n].valueCode+'">'+c.jobs[n].label+"</option>";return i+="</select>"}for(var n in c.jobs)if(c.jobs[n].valueCode==e)return c.jobs[n].label}},{targets:4,data:"customerPhone",render:function(e,t,a){return 2==a.isEdit&&"display"==t?"<input class='form-control col-xs-6' type='text'style='border: 1px solid #F18282;width:100%;' value='"+e+"'>":e}},{targets:5,data:"email",render:function(e,t,a){return 2==a.isEdit&&"display"==t?"<input class='form-control col-xs-6' style='width:100%;border: 1px solid #F18282;width:100%;' type='text'  value='"+e+"'>":e}},{targets:6,data:"distributorAddress",render:function(e,t,a){return 2==a.isEdit&&"display"==t?"<input class='form-control col-xs-6' style='width:100%;border: 1px solid #F18282;width:100%;' type='text'  value='"+e+"'>":e}},{targets:8,data:"option",render:function(e,t,a){if(2==a.isEdit&&"display"==t)return"<a id='save-btn' class='btn btn-primary btn-sm'>  <i class='fa fa-save  hidden-lg hidden-md hidden-sm'></i> <span class='hidden-xs'> 保存</span></a><a id='cancel-btn' class='btn btn-default btn-sm' > <i class='fa fa-times  hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'> 取消</span>  </a>";var i="<div class='btn-group btn-group-sm'>";return c.menuitems.A03_S46&&(i+="<button id='edit-btn' class='btn btn-primary btn-sm' ><i class='fa fa-edit hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'> 编辑</span></button>"),c.menuitems.A04_S46&&(i+="<button id='del-btn' class='btn btn-default btn-sm'><i class='fa fa-edit hidden-lg hidden-md hidden-sm'></i><span id='block'>删除</span></button>"),c.menuitems.A01_S46&&(i+="<button type='button' class='btn btn-default btn-sm dropdown-toggle' data-toggle='dropdown'> 更多<span class='caret'></span></button>",i+="<ul class='dropdown-menu' role='menu'>",c.menuitems.A01_S46&&(i+="<li><a  href='#/projectManagement////"+a.id+"'>项目信息</a></li></ul>")),i+="</div>"}}]},c.inputFun={addOther:function(){c.mistakeMesg.email=!1,c.mistakeMesg.phone=!1,c.othercontactlist&&5<=c.othercontactlist.length?f.error("其他联系人最多只能添加5个人",{}):(c.inputItem.clientOther.contactName="",c.inputItem.clientOther.contactDuty="",c.inputItem.clientOther.contactPhone="",c.inputItem.clientOther.contactEmail="",c.inputItem.clientOther.id=-1,m.open({template:"../partials/dialogue/client_other_dia.html",className:"ngdialog-theme-plain",scope:c}))},saveOther:function(){if(c.mistakeMesg.phone)f.warning("请正确填写联系电话",{});else if(c.mistakeMesg.email)f.warning("请正确填写联系邮箱",{});else{var t=c.inputItem.clientOther;if(-1==t.id){var e={contactName:t.contactName,contactDuty:t.contactDuty,contactPhone:t.contactPhone,contactEmail:t.contactEmail,id:0,createTime:new Date};c.othercontactlist.unshift(e)}if(3==t.isEdit)for(var a in 0==t.id?c.othercontactlist.forEach(function(e){e.createTime==t.createTime&&$.extend(e,t)}):0<t.id&&c.othercontactlist.forEach(function(e){e.id==t.id&&$.extend(e,t)}),c.othercontactlist)3==c.othercontactlist[a].isEdit&&delete c.othercontactlist[a].isEdit;u(function(){c.$broadcast(Event.CLIENTMANAGEINIT+"_Other",c.othercontactlist)}),m.close()}},doActionOther:function(e,a,i){if("cancel"==e){for(var t=c.othercontactlist.length-1;-1<t;t--)a.createTime&&c.othercontactlist[t].createTime==a.createTime?c.othercontactlist.splice(t,1):!a.createTime&&a.id&&c.othercontactlist[t].id==a.id?c.othercontactlist.splice(t,1):c.othercontactlist[t].isEdit=0;c.$broadcast(Event.CLIENTMANAGEINIT+"_Other",c.othercontactlist)}else if("save"==e)i&&i();else if("delete"==e){for(var t in c.othercontactlist)if(a.createTime&&c.othercontactlist[t].createTime==a.createTime)return c.othercontactlist.splice(t,1),c.$apply(),void(i&&i(!0));d.show({title:"提示",closable:!1,message:"确定删除该联系人记录？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){for(var t in c.othercontactlist)!a.createTime&&a.id&&c.othercontactlist[t].id==a.id&&(c.othercontactlist.splice(t,1),c.saveUser("saveClientOther"));i&&i(!0),e.close()}},{label:"取消",action:function(e){e.close()}}]})}}},c.addUser=function(e){"addDealer"==e?(r(),m.open({template:"../partials/dialogue/dealer_info_dia.html",className:"ngdialog-theme-plain",scope:c})):location.href="#/userclient//0"},c.saveUser=function(e,t){var i=c.inputItem.dealer;if("saveDealer"==e){if(c.mistakeMesg.phone)return void f.warning("请正确输入座机或手机号",{});if(c.mistakeMesg.email)return void f.warning("请正确输入邮箱地址",{});0<i.id?p.updateDistributor(i,function(e){if(0==e.code){f.success("经销商信息修改完成",{});var t=c.dealerGridData.data;for(var a in t)if(t[a].id==i.id){$.extend(t[a],i);break}return D("dealer"),void m.close()}}):p.addDistributor(c.inputItem.dealer,function(e){if(0==e.code)return f.success("经销商信息添加成功",{}),e.data.isEdit=0,c.dealerGridData.data.push(e.data),D("dealer"),void m.close()})}else if("saveClientOther"==e){var a={};g&&0==l.id?a.id=g.id:a.id=l.type,$.extend(a,c.inputItem.userMain),a.otherContacts=c.othercontactlist,y(a,function(e){h.updateCustomer(e,function(e){if(0==e.code)return f.success("其他联系人已删除",{}),void u(function(){c.othercontactlist=e.data.otherContacts,c.$broadcast(Event.CLIENTMANAGEINIT+"_Other",c.othercontactlist)})})})}else if(e="saveClient"){var n=c.inputItem.userMain,s=c.menuitems.S12&&c.menuitems.S12.label?c.menuitems.S12.label:"客户";if(null!=c.inputItem.userMain.values&&null!=c.inputItem.userMain.values||(c.inputItem.userMain.values={}),c.inputItem.userMain.values.standardAddress=n.county?n.county:n.city?n.city:n.province,!c.inputItem.userMain.domainPath)return void f.warning("请选择"+s+"归属",{});if(!c.inputItem.userMain.customerName)return void f.warning("请输入"+s+"名称",{});if(!c.inputItem.userMain.customerContact)return void f.warning("请输入主要联系人",{});if(!c.inputItem.userMain.duty)return void f.warning("请选择联系人职务",{});if(!c.inputItem.userMain.customerPhone)return void f.warning("请输入联系人电话",{});if(c.mistakeMesg.userphone)return void f.warning("请正确填写联系人电话",{});if(c.inputItem.userMain.customerEmail&&c.mistakeMesg.useremail)return void f.warning("请输入正确的邮箱地址",{});if(!c.inputItem.userMain.values.standardAddress)return void f.warning("请选择所属区域",{});if(0!=l.id||g){var r={};0==l.id&&g?r.id=g.id:r.id=l.type,$.extend(r,c.inputItem.userMain),r.otherContacts=c.othercontactlist,y(r,function(i){h.updateCustomer(i,function(e){if(0==e.code){f.success(s+"信息修改完成",{});var t=c.userGridData.data;for(var a in t)t[a].id==i.id&&$.extend(t[a],e.data);return D("client","other"),c.othercontactlist=e.data.otherContacts,void u(function(){c.$broadcast(Event.CLIENTMANAGEINIT+"_Other",c.othercontactlist)})}})})}else{var o={};$.extend(o,c.inputItem.userMain),o.otherContacts=c.othercontactlist,y(o,function(e){h.addCustomer(e,function(e){if(0==e.code)return f.success(s+"添加成功",{}),g=e.data,c.userGridData.data.push(e.data),D("client","other"),I.url("/userclient/"+e.data.id),void I.replace()})})}if("createUser"==t){var d=c.domainListDic[c.inputItem.userMain.domainPath];if(!d)return void f.warning("无法创建"+s+"用户",{});v.addDomain(d.id,{name:c.inputItem.userMain.customerName,description:"",values:{standardAddress:c.inputItem.userMain.values.standardAddress}},function(e){if(0==e.code){var t={};t.userType=c.baseConfig.customerConfig.typeCode?c.baseConfig.customerConfig.typeCode:100,t.status=0,t.userName=c.inputItem.userMain.customerContact,t.loginName=c.inputItem.userMain.customerPhone,t.mobilePhone=c.inputItem.userMain.customerPhone;var a={userID:"",domainID:e.data.id,domainPath:e.data.domainPath,name:e.data.name},i=[{roleID:c.baseConfig.customerConfig.role?c.baseConfig.customerConfig.role:102}];b.enterpriseUserRegister(t,a,i,function(e){f.success(s+"的用户添加成功",{})})}})}}},c.doAction=function(e,t,a){"delete"==e?d.show({title:"提示",closable:!1,message:"确认删除该记录？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){h.deleteCustomerById(t.id,function(e){a(e.code),0==e.code&&f.success("记录已删除",{})}),e.close()}},{label:"取消",action:function(e){e.close()}}]}):"editClient"==e&&(location.href="#/userclient/"+$.trim(t.id)+"/")},c.doDealerAction=function(e,i,n){if("cancel"==e){for(var t=c.dealerGridData.data.length-1;-1<t;t--)0==c.dealerGridData.data[t].id&&c.dealerGridData.data.splice(t,1);D("dealer")}else"save"==e||"delete"==e&&d.show({title:"提示",closable:!1,message:"确认删除该经销商记录？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){p.deleteDistributorById(i.id,function(e){if(n(e.code),0!=e.code);else{var t=c.dealerGridData.data;for(var a in t)t[a].id==i.id&&t.splice(a,1);f.success("经销商信息已删除",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]})},c.searchData=function(e){if("searchDealer"==e){var t={orCondition:c.selectedDealItem.orCondition,distributorName:c.selectedDealItem.distributorName,distributorAddress:c.selectedDealItem.distributorAddress,domainPath:c.selectedDealItem.domainPath,contactPhone:c.selectedDealItem.contactPhone};p.findDistributorsByCondition(t,function(e){0==e.code&&(c.dealerGridData.data=e.data,D("dealer"))})}else{t={id:l.type,orCondition:c.selectedItem.orCondition,customerName:c.selectedItem.customerName,customerAddress:c.selectedItem.customerAddress,domainPath:c.selectedItem.domainPath,customerPhone:c.selectedItem.customerPhone};h.findCustomersByCondition(t,function(e){if(0==e.code){if(c.userGridData.data=e.data,l.type){if(c.inputItem.userMain=e.data[0],c.inputItem.userMain.values.standardAddress){var t=c.inputItem.userMain.values.standardAddress.split(",");c.inputItem.userMain.province=t[0],t[1]&&(c.inputItem.userMain.city=t[0]+","+t[1]),t[2]&&(c.inputItem.userMain.county=c.inputItem.userMain.values.standardAddress)}else c.inputItem.userMain.province="",c.inputItem.userMain.city="",c.inputItem.userMain.county="";c.othercontactlist=e.data[0].otherContacts,u(function(){c.$broadcast(Event.CLIENTMANAGEINIT+"_Other",c.othercontactlist)})}D("client","other")}})}},c.verifyFun=function(e,t,a){if("phone"==t){/^((1[34578]\d{9})|(0\d{2,4}\-\d{7,8})|\d{8})$/.test(e)?"user"==a?c.mistakeMesg.userphone=!1:c.mistakeMesg.phone=!1:"user"==a?c.mistakeMesg.userphone=!0:c.mistakeMesg.phone=!!e}else"email"==t&&(/^[a-zA-Z0-9_-].+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/.test(e)?"user"==a?c.mistakeMesg.useremail=!1:c.mistakeMesg.email=!1:"user"==a?c.mistakeMesg.useremail=!0:c.mistakeMesg.email=!!e)};c.closeDialog=function(){m.close()};var o=function(){var t,a;r(),s?(a=function(){c.searchData("searchDealer")},v.queryEnterpriseDomainTree(i.user.userID,function(e){c.domainDealerListTree=e.domainListTree,c.domainDealerListDic=e.domainListDic,a&&a()})):(t=function(){c.searchData()},v.queryDomainTree(i.user.userID,function(e){c.domainListTree=e.domainListTree,c.domainListDic=e.domainListDic,t&&t()})),0!=l.id||l.type||u(function(){c.$broadcast(Event.CLIENTMANAGEINIT+"_Other",[])})},y=function(t,a){t.values.latitude="",t.values.longitude="",i.getAddressPoint(t.values.standardAddress.split(",").join("")+t.customerAddress,function(e){t.values.latitude=e.location.lat.toFixed(6),t.values.longitude=e.location.lng.toFixed(6),a&&a(t)})};i.user.isAuthenticated?o():c.$on("loginStatusChanged",function(e,t){i.user.isAuthenticated&&o()})}]),e.initController("userSupplierCtrl",["$scope","userLoginUIService","userEnterpriseService","userUIService","growl","userRoleUIService","userFunctionService","userDomainService","marketplaceUIService",function(i,a,t,e,n,s,r,o,d){i.userSearch={};i.userGridData={columns:[{title:"供应商名称",data:"supplierName"},{title:"供应商联系人",data:"supplierContact"},{title:"联系方式（手机/邮箱）",data:"supplierEmail"},{title:"联系地址",data:"supplierAddress"},{title:"供应商状态",data:"supplierStatus"}],columnDefs:[]},i.getDBdata=function(e){t.querySupplier(function(e){if(0==e.code){for(var t in e.data){var a=e.data[t];a.isEdit=0,null==a.supplierEmail||""==a.supplierEmail?a.supplierEmail=a.supplierPhone:a.supplierEmail=a.supplierEmail}i.userGridData.data=e.data,i.$broadcast(Event.SUPPLIERMANAGEINIT,i.userGridData)}})},a.user.isAuthenticated?i.getDBdata({}):i.$on("loginStatusChanged",function(e,t){a.user.isAuthenticated&&i.getDBdata({})})}])});
//# sourceMappingURL=../../../map/app-oc/js/controllers/client-ctrl.js.map
