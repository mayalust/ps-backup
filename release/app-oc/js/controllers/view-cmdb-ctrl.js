define(["controllers/controllers","bootstrap-dialog"],function(e,B){"use strict";e.controller("ViewCmdbCtrl",["$scope","$routeParams","$timeout","kpiDataService","userLoginUIService","resourceUIService","alertService","SwSocket","Info","viewFlexService","unitService","growl","userDomainService","userEnterpriseService",function(l,c,i,r,a,m,e,t,s,u,n,v,f,o){console.info("切换到资源管理"),l.routePaths=[],l.routePathNodes={},l.selectedDitem=null,l.selectedDomainitem=null,l.selectedGateitem=null,l.selectedDirective=null,l.visible=!1,l.editVisible=!1,l.treeAry=[],l.domainsAry=[],l.gatewaysAry=[],l.activeMainTab="设备类型视图",l.activeTab="属性",l.previousMainTab,l.activeListTab="tab1",l.queryDomin="";var b,D,d=Math.uuid(),g=!1,p=(s.get("localdb/icon.json",function(e){l.iconList=e.qualityIcon,l.kpiIconList=e.kpiIcon}),function(e){var t;switch(!0){case.9<e:t="fa fa-hospital-o";break;case.8<e:t="fa fa-truck";break;case.7<e:t="fa fa-tv";break;case.6<e:t="fa fa-users";break;case.5<e:t="fa fa-bolt";break;case.4<e:t="fa fa-bank";break;default:t="fa fa-plus"}return t}),h=function(a,e){m.getResourcesByDomainPath(a.domainPath,function(e){var t=e.data;a.count=t.length})},I=function(a,i){m.getResourceByModelId(a.id,function(e){if(0==e.code){var t=e.data;a.count=t.length,a.resources=t,a.isLoaded=a.isLoaded+1,i&&i()}})},y=function(){var e=l.selectedDomainitem.domainPath;""!=e?f.getAssociateDomain2User(e,function(e){if(0==e.code){for(var t in e.data){e.data[t].isEdit=0}l.domainUserData.data=e.data,l.$broadcast(Event.DOMAININFOSINIT,l.domainUserData)}}):(l.domainUserData.data=[],l.$broadcast(Event.DOMAININFOSINIT,l.domainUserData))};l.domainUsers=[];l.gatewayDevices=[],l.gatewayactiveDevices=[];var w=function(e){for(var t in l.gatewayDevices=[],l.gatewayactiveDevices=[],e.devices=e.devices?e.devices:[],e.devices)"active"!=e.devices[t].managedStatus&&l.gatewayDevices.push(e.devices[t]);l.$broadcast(Event.CMDBINFOSINIT+"GATE",{data:l.gatewayDevices}),m.getResourcesByGatewayId(e.id,function(e){if(0==e.code){for(var t in e.data)"active"==e.data[t].managedStatus&&l.gatewayactiveDevices.push(e.data[t]);l.$broadcast(Event.CMDBINFOSINIT+"GATEACTIVE",{data:l.gatewayactiveDevices})}})},T=function(t,a){m.getAttrsByModelId(t.id,function(e){0==e.code&&(t.attrs=e.data,t.isLoaded=t.isLoaded+1,a&&a())})},A=function(e,t){e.count=0;var a,i,s,n=Math.random();return e.alertlv=.75<n?"bg-red":.5<n?"bg-orange":.25<n?"bg-yellow":"bg-green",e.isLoaded=0,(e.type=0)==t?(I(e,function(){2<=l.selectedDitem.isLoaded&&E(l.selectedDitem)}),T(e,function(){2<=l.selectedDitem.isLoaded&&E(l.selectedDitem)})):(I(e),T(e)),a=e,m.getKpisByModelId(a.id,function(e){0==e.code&&(a.kpis=e.data)}),i=e,m.getAlertsByModelId(i.id,function(e){if(0==e.code){i.alerts=e.data,i.thresholds=[];for(var t=0;t<i.alerts.length;t++)!function(t,e,a){m.getThresholds(e,a,function(e){0==e.code&&0<e.data.length&&t.thresholds.push({alertCode:a,thresholdsData:e.data})})}(i,i.id,i.alerts[t].id)}}),(s=e).directives=[],m.getDirectivesByModelId(s.id,function(e){0==e.code&&(s.directives=e.data)}),e},N=function(e,t){e.id=e.id?e.id:0,e.domainID=e.domainID?e.domainID:0,e.domainPath=e.domainPath?e.domainPath:"",e.domainName=e.domainName?e.domainName:"",e.description=e.description?e.description:"",e.count=0;var a=Math.random();return e.icon=p(a),e.alertlv=.75<a?"bg-red":.5<a?"bg-orange":.25<a?"bg-yellow":"bg-green",e.isLoaded=0,e.type=1,e.label=e.name,h(e),e},M=function(e,t){e.id=e.id?e.id:0,e.name=e.name?e.name:"新增网关",e.externalGwId=e.externalGwId?e.externalGwId:"",e.accessName=e.accessName?e.accessName:"",e.accessPassword=e.accessPassword?e.accessPassword:"",e.protocolType=e.protocolType?e.protocolType:"",e.count=e.devices?e.devices.length:0;var a=Math.random();return e.icon=p(a),e.alertlv=4==e.operationStatus?"bg-red":3==e.operationStatus?"bg-orange":2==e.operationStatus?"bg-yellow":"bg-green",e.isLoaded=0,e.label=e.name,e.onlineStatus=e.onlineStatus?e.onlineStatus:"online",e.managedStatus=e.managedStatus?e.managedStatus:"deactive",e.activeTime=e.activeTime?newDateJson(e.activeTime).Format(GetDateCategoryStrByLabel("")):"",e.expireTime=e.expireTime?newDateJson(e.expireTime).Format(GetDateCategoryStrByLabel("")):"",e.validTime="",e.activeTime&&e.expireTime&&(e.validTime="从"+e.activeTime+"到"+e.expireTime),e},P=function(e){m.getModels(function(e){if(m.treeAry=[],0==e.code){var t=e.data;for(var a in t){var i=t[a];l.routePathNodes[i.parentModelId]||(l.routePathNodes[i.parentModelId]=[]),l.routePathNodes[i.parentModelId].push(i),l.routePathNodes[i.id]||(l.routePathNodes[i.id]=[]),m.treeAry.push(jQuery.extend(!0,{},i)),A(i)}if(function e(t){for(var a in l.routePathNodes)if(a==t.id)for(var i in t.nodes=l.routePathNodes[a],t.nodes)e(t.nodes[i])}(m.rootModel),c.modelId)if(l.routePathNodes[c.modelId]){var s=[];!function e(t,a){for(var i in t.nodes){if(c.modelId==t.nodes[i].id){a.push(t);break}e(t.nodes[i],a)}}(m.rootModel,s),s.push(m.rootModel),l.routePaths=s.reverse();var n=s[s.length-1];for(var a in n.nodes)if(c.modelId==n.nodes[a].id){l.click(n.nodes[a]),A(n.nodes[a],0),l.treeAry=n.nodes;break}}else l.click(m.rootModel.nodes[0]),A(m.rootModel.nodes[0],0),l.treeAry=m.rootModel.nodes;else l.click(m.rootModel.nodes[0]),A(m.rootModel.nodes[0],0),l.treeAry=m.rootModel.nodes}})},E=function(e){var t,a=[],i=[],s=function(e){for(var t in u.viewList){var a=u.viewList[t];if("designView"==a.viewType&&-1<e.search(a.viewTitle))return a.viewId}return 0}(e.label);for(var n in e.resources){var o=e.resources[n],d={option:""};d.id=o.id,d.label=o.label,d.viewId=s,d.createTime=newDateJson(o.createTime).Format(GetDateCategoryStrByLabel()),d.state=1,d.onlineStatus=o.onlineStatus?o.onlineStatus:"online",d.alertlv=Math.floor(4*Math.random()),d.externalDevId=o.externalDevId?o.externalDevId:"",d.values=o.values,d.data=o,d.health=100,d.isEdit=0,d.selected=!1,d.id==c.nodeId&&(d.selected=!0),a.push(d),i.push(o.id)}t=i,r.getRealTimeKpiData(t,[999999],function(e){if(0==e.code)for(var t in e.data){for(var a in m.selectedInstances)e.data[t].nodeId==m.selectedInstances[a].id&&(m.selectedInstances[a].health=100-20*e.data[t].value);l.$broadcast(Event.CMDBINFOSINIT,{option:[m.selectedInstances,m.selectedAttrs]})}}),m.selectedInstances=a,m.selectedAttrs=e.attrs,l.$broadcast(Event.CMDBINFOSINIT,{option:[m.selectedInstances,m.selectedAttrs]})},G=function(){l.selectedDitem.isLoaded=1,I(l.selectedDitem,function(){E(l.selectedDitem)})},S=function(){null==l.activeTab||"属性"==l.activeTab||("指标"==l.activeTab?l.$broadcast(Event.KPIEDITINIT,{data:l.selectedDitem.kpis}):"告警"==l.activeTab?l.$broadcast(Event.ALERTEDITINIT,{data:l.selectedDitem}):"指令"==l.activeTab&&l.$broadcast(Event.DIRECTIVESINIT,{data:l.selectedDitem.directives}))};l.domainUserData={columns:[{title:"姓名",data:"userName"},{title:"Email",data:"emailAddress"},{title:"移动电话",data:"mobilePhone"},{title:"办公电话",data:"officePhone"},{title:"操作",orderable:!1,data:"option"}],data:[{}],columnDefs:[{targets:0,data:"userName",render:function(e,t,a){if(2!=a.isEdit||"display"!=t)return e;var i='<select id="userDomainName" name="userName" class="combobox form-control"><option value="">请选择用户</option>';for(var s in l.userGridData.data)i+='<option value="'+l.userGridData.data[s].userID+'">'+l.userGridData.data[s].userName+"</option>";return i+="</select>",l.domainUserData.data=[],i}},{targets:4,data:"option",render:function(e,t,a){if(2==a.isEdit){var i="<div class='input-group'>";return i+="<a id='save-btn' class='btn btn-social-icon'><i class='fa fa-check'></i></a>",i+="<a id='del-btn' class='btn btn-social-icon'><i class='fa fa-close'></i></a>",i+="</div>"}i="<div class='input-group'>";return i+="<a id='removeDomain-btn' class='btn btn-social-icon' data-toggle='tooltip' title='删除'><i class='fa fa-minus-square-o'></i></a>",i+="</div>"}}]},l.domainDeviceData={columns:[{data:"id",title:"编码"},{data:"label",title:"名称"},{data:"createTime",title:"上线时间"},{data:"onlineStatus",title:"在线状态"},{data:"health",title:"健康度",visible:!1},{data:"domainPath",title:"资源域"},{data:"option",title:"操作",orderable:!1}],columnDefs:[{targets:3,data:"onlineStatus",render:function(e,t,a){return"<span class='label "+("online"==e?"label-primary":"label-warning")+"'>"+("online"==e?"在线":"离线")+"</span>"}},{targets:4,data:"health",render:function(e,t,a){return"<div class='progress progress-xs progress-striped active'><div class='progress-bar "+(90<(e=100*Math.random())?"progress-bar-success":60<e?"progress-bar-yellow":"progress-bar-red")+"' style='width:"+e+"%'></div></div>"}},{targets:5,data:"domainPath",render:function(e,t,a){var i="";if(null!=e&&""!=e)for(var s in l.domainsAry)l.domainsAry[s].domainPath==e&&(i+="<input name='domainPath' domain-Picker class='form-control' type='text' value='"+l.domainsAry[s].label+"' domainPath='"+l.domainsAry[s].domainPath+"' data-original-title title>");return i||(i+="<input name='domainPath'  domain-Picker class='form-control' type='text' domainPath='' value='请选择...'>"),i}},{targets:6,data:"option",render:function(e,t,a){return'<div class="input-group"><a id="save-btn" class="btn btn-social-icon" data-toggle="tooltip" title="保存"><i class="fa fa-check hidden-lg hidden-md hidden-sm"></i></a></div>'}}]};var k=function(){var e=l.selectedDomainitem.domainPath;""!=e?m.getResourcesByDomainPath(e,function(e){if(0==e.code){for(var t in e.data){var a=e.data[t];a.isEdit=0,a.onlineStatus=a.onlineStatus?a.onlineStatus:"online"}l.domainDeviceData.data=e.data,l.$broadcast(Event.DOMAINDEVICESINIT,l.domainDeviceData)}}):(l.domainDeviceData.data=[],l.$broadcast(Event.DOMAINDEVICESINIT,l.domainDeviceData))};l.delDomainSubItem=function(e){l.editVisible=!1,v.success("取消添加资源域成功",{}),L()},l.click=function(e){if(l.editVisible=!1,l.selectedDirective=null,"设备类型视图"==l.activeMainTab){if(l.selectedDitem==e)return;for(var t in l.routePaths)l.selectedDitem&&l.routePaths[t].id==l.selectedDitem.id&&l.routePaths.splice(t,1);l.selectedDitem=e,l.routePaths.push(e),l.visible=!0,2<=e.isLoaded&&(E(e),S()),l.activeListTab="tab1"}else if("资源域视图"==l.activeMainTab){if(l.selectedDomainitem=e,0==l.selectedDomainitem.domainID)return;l.visible=!0,"tab3"==l.activeListTab?k():"tab4"==l.activeListTab&&y()}else"网关视图"==l.activeMainTab&&(l.selectedGateitem=e,w(l.selectedGateitem))},l.eidtModel=function(){l.editVisible=!l.editVisible},l.addModel=function(){if("设备类型视图"==l.activeMainTab){if(l.selectedDitem){B.show({title:"提示",closable:!1,message:'设备类型名称: <input type="text" onkeydown="validatorHTML(event)" onpaste="return false" value="新建'+l.selectedDitem.label+'" class="form-control">',buttons:[{label:"确定",cssClass:"btn-success",action:function(e){!function(e){for(var t in l.treeAry)if(e==l.treeAry[t].label)return v.warning("当前有重复设备类型名称，请修改",{});var a={};a.label=e,a.id=0,a.count=0,a.icon=p(0),a.isLoaded=0,a.resources=[],a.parentModelId=l.selectedDitem.id,m.addModel(a,function(e){0==e.code&&(l.selectedDitem=A(e.data,0),l.treeAry.push(l.selectedDitem),l.click(l.selectedDitem),l.editVisible=!0)})}(e.getModalBody().find("input").val()),e.close()}},{label:"取消",action:function(e){e.close()}}]})}}else if("资源域视图"==l.activeMainTab){for(var e in l.domainsAry){if(0==l.domainsAry[e].domainID)return void v.warning("当前有未保存资源域",{})}b=l.selectedDomainitem.domainID,D=l.selectedDomainitem.domainPath,l.selectedDomainitem=(t={id:0,domainID:0,domainPath:"",domainName:"",description:"",count:0},a=Math.random(),t.icon=p(a),t.alertlv=.75<a?"bg-red":.5<a?"bg-orange":.25<a?"bg-yellow":"bg-green",t.isLoaded=0,t.type=1,t.label=t.name,t),l.domainsAry.push(l.selectedDomainitem),l.editVisible=!0,$("#domain-form input").eq(0).attr("autofocus","autofocus"),k(),l.domainUsers=[],y()}else if("网关视图"==l.activeMainTab){for(var e in l.gatewaysAry){if(0==l.gatewaysAry[e].id)return void v.warning("当前有未保存网关",{})}l.selectedGateitem=M({}),l.gatewaysAry.push(l.selectedGateitem),l.editVisible=!0,l.gatewayDevices=[],l.gatewayactiveDevices=[],l.$broadcast(Event.CMDBINFOSINIT+"GATE",{data:l.gatewayDevices}),l.$broadcast(Event.CMDBINFOSINIT+"GATEACTIVE",{data:l.gatewayactiveDevices})}var t,a},l.delModel=function(){if("设备类型视图"==l.activeMainTab){for(var e in l.treeAry)if(l.selectedDitem.id==l.treeAry[e].parentModelId)return void v.warning(l.selectedDitem.label+" 设备类型有子域，不能删除",{});B.show({title:"提示",closable:!1,message:"确认删除 "+l.selectedDitem.label+" 设备类型吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){if(0!=l.selectedDitem.count)return v.warning(l.selectedDitem.label+" 设备类型关联着设备，不能删除",{}),void e.close();l.selectedDitem&&m.deleteModel(l.selectedDitem.id,function(e){if(0==e.code){for(var t in l.treeAry)l.treeAry[t].id==l.selectedDitem.id&&l.treeAry.splice(t,1);v.success("删除 "+l.selectedDitem.label+" 设备类型成功"),l.editVisible=!1,l.selectedDitem=A(l.treeAry[l.treeAry.length-1],0)}}),e.close()}},{label:"取消",action:function(e){e.close()}}]})}else if("资源域视图"==l.activeMainTab){if(0==l.selectedDomainitem.domainID)return L(),l.editVisible=!1,void v.success("资源域删除成功",{});var t={domainID:l.selectedDomainitem.domainID,domainPath:l.selectedDomainitem.domainPath};f.queryDeleteDomain(t,function(e){"true"==e.data?B.show({title:"提示",closable:!1,message:"确认删除 "+l.selectedDomainitem.name+" 资源域吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){l.selectedDomainitem&&f.deleteDomain(l.selectedDomainitem.domainID,l.selectedDomainitem.domainPath,function(e){if(0==e.code){for(var t in l.editVisible=!1,l.domainsAry)l.selectedDomainitem.domainID==l.domainsAry[t].domainID&&(l.domainsAry.splice(t,1),l.selectedDomainitem=1<t?l.domainsAry[t-1]:l.domainsAry[0]);v.success("删除资源域成功",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]}):v.warning(e.data,{})})}else if("网关视图"==l.activeMainTab){if("active"==l.selectedGateitem.managedStatus)return void v.warning("激活状态的网关不能删除，请先停用该网关。",{});B.show({title:"删除网关",closable:!1,message:"确认删除"+l.selectedGateitem.name+"网关以及该网关下的设备吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){l.selectedGateitem&&m.deleteGateway(l.selectedGateitem.id,function(e){0==e.code&&(l.editVisible=!1,l.selectedGateitem=null,x(),v.success("删除网关成功",{}))}),e.close()}},{label:"取消",action:function(e){e.close()}}]})}},l.updateModel=function(){if(l.selectedDitem){for(var e in m.treeAry)if(m.treeAry[e].id==l.selectedDitem.id&&m.treeAry[e].label==l.selectedDitem.label&&m.treeAry[e].icon==l.selectedDitem.icon)return;var t={};t.id=l.selectedDitem.id,t.label=l.selectedDitem.label,t.icon=l.selectedDitem.icon,m.updateModel(t,function(e){if(0==e.code){for(var t in l.treeAry)l.treeAry[t].id==l.selectedDitem.id&&(l.treeAry[t].label=e.data.label,m.treeAry[t].label=e.data.label,l.selectedDitem.label=e.data.label);v.success("修改设备类型视图成功",{})}})}},l.addModelSubItem=function(){if(null==l.activeTab||"属性"==l.activeTab){for(var e=l.selectedDitem.attrs.length-1;-1<e;e--)if(l.selectedDitem.attrs[e].isNew){if(!l.selectedDitem.attrs[e].isDel)return void v.warning("当前有未保存属性",{});l.selectedDitem.attrs.splice(e,1)}var t={canEdit:!0,label:"",name:"",dataType:0,id:Math.uuid(),isNew:!0};l.selectedDitem.attrs.push(t)}else if("指标"==l.activeTab){for(e=l.selectedDitem.kpis.length-1;-1<e;e--)if(l.selectedDitem.kpis[e].isNew){if(!l.selectedDitem.kpis[e].isDel)return void v.warning("当前有未保存指标",{});l.selectedDitem.kpis.splice(e,1)}var a={isEdit:2,canEdit:!0,label:"",name:"",unit:"",range:"",number:"",granularity:"",granularityUnit:"",option:"",id:Math.uuid(),isNew:!0};l.selectedDitem.kpis.push(a),l.$broadcast(Event.KPIEDITINIT,{data:l.selectedDitem.kpis})}else if("告警"==l.activeTab){for(e=l.selectedDitem.alerts.length-1;-1<e;e--)if(l.selectedDitem.alerts[e].isNew){if(!l.selectedDitem.alerts[e].isDel)return void v.warning("当前有未保存告警",{});l.selectedDitem.alerts.splice(e,1)}var i={isEdit:2,canEdit:!0,label:"",name:"",description:"",option:"",id:Math.uuid(),isNew:!0};l.selectedDitem.alerts.push(i),l.$broadcast(Event.ALERTEDITINIT,{data:l.selectedDitem})}else if("指令"==l.activeTab){for(e=l.selectedDitem.directives.length-1;-1<e;e--)if(l.selectedDitem.directives[e].isNew){if(!l.selectedDitem.directives[e].isDel)return void v.warning("当前有未保存指令",{});l.selectedDitem.directives.splice(e,1)}l.selectedDitem.directives.push({isEdit:2,canEdit:!0,label:"",name:"",description:"",option:"",expression:"",protocolType:"",id:0,isNew:!0}),l.$broadcast(Event.DIRECTIVESINIT,{data:l.selectedDitem.directives})}},l.attrLabel="",l.iconClick=function(e,t,a){"图标"!=$("#label"+t).val()&&(l.attrLabel=$("#label"+t).val()),"icon"==e?($("#label"+t).val("图标"),$("#label"+t).attr("disabled",!0),l.selectedDitem.attrs[t].label="图标"):("图标"==$("#label"+t).val()&&$("#label"+t).val(l.attrLabel),$("#label"+t).attr("disabled",!1))},l.delModelSubItem=function(a){null==l.activeTab||"属性"==l.activeTab?B.show({title:"提示",closable:!1,message:"确认删除 "+l.selectedDitem.label+" 设备的属性吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){for(var t in l.selectedDitem.attrs){if(l.selectedDitem.attrs[t].id==a.id){l.selectedDitem.attrs.splice(t,1);break}}v.info("设备属性删除成功，请点击保存按钮以保存修改",{}),e.close()}},{label:"取消",action:function(e){e.close()}}]}):"指标"==l.activeTab||"告警"==l.activeTab||l.activeTab},l.saveModelSubItem=function(){var e=!0;if("设备类型视图"==l.activeMainTab)if(null==l.activeTab||"属性"==l.activeTab){for(var t in l.selectedDitem.attrs){if((a=l.selectedDitem.attrs[t]).isNew&&(a.id=0),!a.label)return void v.warning("请输入显示名称",{});if(!a.name)return void v.warning("请输入属性名称",{});if(!a.dataType)return void v.warning("请选择数据类型",{})}m.saveAttrs(l.selectedDitem.id,l.selectedDitem.attrs,function(e){0==e.code&&(e.data&&(l.selectedDitem.attrs=e.data),v.success("保存属性成功",{}))})}else if("指标"==l.activeTab){for(t=l.selectedDitem.kpis.length-1;-1<t;t--){if(!(a=l.selectedDitem.kpis[t]).label||!a.name){if(a.isNew){l.selectedDitem.kpis.splice(t,1);continue}e=!(a.err=".danger")}if(a.isNew){if(0<a.isEdit)return void v.info("请√当前修改的数据",{});a.id=0}a.isDel&&l.selectedDitem.kpis.splice(t,1)}e?m.saveKpis(l.selectedDitem.id,l.selectedDitem.kpis,function(e){0==e.code&&(e.data&&(l.selectedDitem.kpis=e.data),v.success("保存指标定义成功",{}),S())}):v.warning("检查数据完整性",{})}else if("告警"==l.activeTab){for(t=l.selectedDitem.alerts.length-1;-1<t;t--){var a;if(!(a=l.selectedDitem.alerts[t]).label||!a.name){if(a.isNew){l.selectedDitem.alerts.splice(t,1);continue}e=!(a.err=".danger")}if(a.isNew){if(0<a.isEdit)return void v.warning("请√当前修改的数据",{});a.id=0}a.isDel&&l.selectedDitem.alerts.splice(t,1)}e?m.saveAlerts(l.selectedDitem.id,l.selectedDitem.alerts,function(e){0==e.code&&(v.success("保存告警定义成功",{}),e.data&&(l.selectedDitem.alerts=e.data),S())}):v.warning("检查数据完整性",{})}else"指令"==l.activeTab&&m.saveDirectives(l.selectedDitem.id,l.selectedDitem.directives,function(e){if(0==e.code){for(var t in l.selectedDitem.directives)l.selectedDitem.directives[t].isNew&&(l.selectedDitem.directives[t].isNew=!1);v.success("保存指令成功",{})}});else if("资源域视图"==l.activeMainTab){var i=$.trim($("#domain-form input").eq(0).val()),s=$.trim($("#domain-form input").eq(1).val());if(!/^[\u4E00-\u9FA5\w\d]+$/.test(i))return void v.warning("域名只能输入字母、数字、汉字、下划线",{});if(""==i||""==$.trim(i))return void v.warning("域名为必填项，并且不能为空格",{});if(0==l.selectedDomainitem.domainID){var n=b,o=D;f.addDomain(n,o,i,s,function(e){0==e.code?(e.data&&(l.selectedDomainitem.domainID=e.data.domainID,l.selectedDomainitem.domainPath=e.data.domainPath,l.selectedDomainitem.name=e.data.name,l.selectedDomainitem.description=e.data.description,l.selectedDomainitem.parentID=e.data.parentID,l.domainsAry[l.domainsAry.length-1]=l.selectedDomainitem),l.editVisible=!1,v.success("新增资源域成功",{})):v.warning("新增资源域失败",{})})}else f.modifyDomain(l.selectedDomainitem.domainID,i,s,function(e){0==e.code?(e.data&&L(),l.editVisible=!1,v.success("修改资源域成功",{})):v.warning("修改资源域失败",{})})}else if("网关视图"==l.activeMainTab){if(!l.selectedGateitem.type)return void v.warning("请选择网关类型",{});if(!l.selectedGateitem.protocolType)return void v.warning("请选择协议类型",{});if(!l.selectedGateitem.cloudAdapter)return void v.warning("请选择适配器类型",{});if(!l.selectedGateitem.domain)return void v.warning("请选网关所属域",{});if(!l.selectedGateitem.externalGwId)return void v.warning("请选输入网关标识",{});if(!l.selectedGateitem.name)return void v.warning("请选输入网关名称",{});B.show({title:"提示",closable:!1,message:"确认保存"+l.selectedGateitem.name+"吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){d(),e.close()}},{label:"取消",action:function(e){e.close()}}]});var d=function(){0==l.selectedGateitem.id?m.addGateway(l.selectedGateitem,function(e){if(0==e.code){if(e.data)for(var t in l.gatewaysAry){0==l.gatewaysAry[t].id&&(l.gatewaysAry[t]=M(e.data),l.selectedGateitem=l.gatewaysAry[t])}l.editVisible=!1,v.success("新增网关成功",{})}}):m.updateGateway(l.selectedGateitem,function(e){if(0==e.code){if(e.data)for(var t in l.gatewaysAry){l.gatewaysAry[t].id==e.data.id&&(l.gatewaysAry[t]=M(e.data),l.selectedGateitem=l.gatewaysAry[t])}l.editVisible=!1,v.success("修改网关成功",{})}})}}},l.userGridData={columns:[{title:"姓名",data:"userName"},{title:"Email",data:"emailAddress"},{title:"移动电话",data:"mobilePhone"},{title:"办公电话",data:"officePhone"},{title:"操作",orderable:!1,data:"option"}],columnDefs:[{targets:0,data:"userName",render:function(e,t,a){if(2!=a.isEdit||"display"!=t)return e;var i='<select id="userDomainName" name="userName" class="combobox form-control"><option value="">请选择用户</option>';for(var s in l.userGridData.data)i+='<option value="'+l.userGridData.data[s].userID+'">'+l.userGridData.data[s].userName+"</option>";return i+="</select>",l.domainUserData.data=[],i}},{targets:4,data:"option",render:function(e,t,a){if(2==a.isEdit){var i="<div class='input-group'>";return i+="<a id='save-btn' class='btn btn-social-icon'><i class='fa fa-check'></i></a>",i+="<a id='del-btn' class='btn btn-social-icon'><i class='fa fa-close'></i></a>",i+="</div>"}i="<div class='input-group'>";return i+="<a id='removeDomain-btn' class='btn btn-social-icon' data-toggle='tooltip' title='删除'><i class='fa fa-minus-square-o'></i></a>",i+="</div>"}}]},l.addUserToDomain=function(){if(0==g){if(g=!0,l.selectedDomainitem){for(var e in l.domainUsers){if(0==l.domainUsers[e].domainID)return void v.warning("当前有未保存资源域",{})}var t={userName:"选择用户",emailAddress:"",mobilePhone:"",officePhone:"",id:0,domainId:"",domainPath:"",isEdit:2,userType:2,userTypeLabel:"普通用户",jobTitle:"",discription:"",edit:"",userID:null};for(var e in l.domainUserData.data)if(null==l.domainUserData.data[e].userID)return l.domainUserData.data[e]=t,l.domainUserData.columnDefs[e]={targets:4,data:"option",render:function(e,t,a){var i="<div class='input-group'>";return 0==a.id?i+="<a id='save-btn' class='btn btn-social-icon'><i class='fa fa-save'></i></a>":i+="<a id='save-btn' class='btn btn-social-icon'><i class='fa fa-check'></i></a>",i+="<a id='del-btn' class='btn btn-social-icon'><i class='fa fa-minus-square-o'></i></a>",i+="</div>"}},void l.$broadcast(Event.DOMAININFOSINIT,l.domainUserData);l.domainUserData.data.push(t),l.$broadcast(Event.DOMAININFOSINIT,l.domainUserData)}}else v.warning("当前正在添加域用户",{})},l.addIns=function(){var e=l.selectedGateitem;if(e){for(var t in l.gatewayDevices){if(0==l.gatewayDevices[t].id)return void v.warning("当前有未添加到网关设备，请点击保存按钮",{})}var a={gatewayId:e.id,label:"新增设备"+l.gatewayDevices.length,id:0,domainPath:"",domainId:"",modelId:"",externalDevId:"",managedStatus:"deactive",onlineStatus:"offline",operationStatus:0,isEdit:2};l.gatewayDevices.push(a),l.$broadcast(Event.CMDBINFOSINIT+"GATE",{data:l.gatewayDevices})}},l.doAction=function(e,a){if("设备类型视图"==l.activeMainTab)if("save"==e){if((a.isEdit=0)==a.id){var t={};t.label=a.label,t.id=a.id,t.values=a.values,t.modelId=l.selectedDitem.id,m.addResource(t,function(e){0==e.code&&(G(),v.success("保存成功",{}))})}else if(0<a.id){var i=a.data;i.label=a.label,i.id=a.id,i.values=a.values,m.updateResource(i,function(e){0==e.code&&(G(),v.success("保存成功",{}))})}}else if("cancel"==e){for(var s in m.selectedInstances)m.selectedInstances[s].isEdit=0;l.$broadcast(Event.CMDBINFOSINIT,{option:[m.selectedInstances,l.selectedDitem.attrs]})}else if("delete"==e)B.show({title:"提示",closable:!1,message:"是否要删除设备:"+a.label,buttons:[{label:"确定",cssClass:"btn-success",action:function(e){m.deleteResource(a.id,function(e){0==e.code&&G()}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("change"==e)B.show({title:"提示",closable:!1,message:"是否要改变设备状态为:"+(1==a.state?"离线":"在线"),buttons:[{label:"确定",cssClass:"btn-success",action:function(e){for(var t in m.selectedInstances)m.selectedInstances[t].id==a.id&&(1==a.state?m.selectedInstances[t].state=0:m.selectedInstances[t].state=1);l.$broadcast(Event.CMDBINFOSINIT,{option:[m.selectedInstances,m.selectedAttrs]}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("eidterror"==e)v.warning("当前有正在编辑的设备",{});else if("directive"==e)location.href="#directiveview/"+a.data.modelId+"/"+a.id;else if("directive-save"==e)for(s=l.selectedDitem.directives.length-1;-1<s;s--)l.selectedDitem.directives[s].id==a.id&&(l.selectedDitem.directives[s]=a,l.selectedDirective&&(l.selectedDitem.directives[s].params=l.selectedDirective.params));else"params"==e?m.checkDirectiveParam(a,function(e){0==e.code&&(0<e.data.params.length?l.selectedDirective=e.data:v.info("当前表达式无法解析出参数",{}))}):"message"==e?"指令"==l.activeTab?B.show({title:"提示",closable:!1,message:"确认删除:"+l.selectedDitem.label+"设备下的指令吗",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){for(var t in l.selectedDitem.directives){if(l.selectedDitem.directives[t].id==item.id){l.selectedDitem.directives.splice(t,1);break}}v.warning("指令删除成功，请点击保存按钮",{}),e.close()}},{label:"取消",action:function(e){e.close()}}]}):"告警"==l.activeTab?B.show({title:"提示",closable:!1,message:"确认删除:"+l.selectedDitem.label+"设备下的告警吗",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){for(var t in l.selectedDitem.alerts){if(l.selectedDitem.alerts[t].id==item.id){l.selectedDitem.alerts.splice(t,1);break}}v.warning("告警删除成功，请点击保存按钮",{}),e.close()}},{label:"取消",action:function(e){e.close()}}]}):"指标"==l.activeTab&&B.show({title:"提示",closable:!1,message:"确认删除:"+l.selectedDitem.label+"设备下的指标吗",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){for(var t in l.selectedDitem.kpis){if(l.selectedDitem.kpis[t].id==item.id){l.selectedDitem.kpis.splice(t,1);break}}v.warning("指标删除成功，请点击保存按钮",{}),e.close()}},{label:"取消",action:function(e){e.close()}}]}):"thresholdMessage"==e&&v.warning(a,{});else if("资源域视图"==l.activeMainTab){if("save"==e){a.isEdit=0;var n=a.userID;$("#domain-selector").val().split(" ")[0],$("#domain-selector").val().split(" ")[1],l.selectedDomainitem.domainID}else if("cancel"==e)v.success("取消切换域",{}),C();else if("removeDomain"==e)B.show({title:"提示",closable:!1,message:"确认将用户 "+a.userName+" 移出 "+l.selectedDomainitem.name+" 资源域吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){if(3==a.userType&&0==l.selectedDomainitem.parentID)return v.warning("根域："+l.selectedDomainitem.name+" 下的管理员用户："+a.userName+"不能被移出",{}),void e.close();var t=a.userID;f.deleteDomain2User(l.selectedDomainitem.domainID,t,function(e){0==e.code&&(v.success("用户移出域成功",{}),C())}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("saveChangedDomain"==e)B.show({title:"提示",closable:!1,message:"确认将资源域 "+l.selectedDomainitem.name+" 切换到资源域  "+a.domainName+" 吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){var t=a.domainPath;a.id;m.changeDeviceDomain(a.id,t,function(e){0==e.code&&L()}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("delDomain"==e)C();else if("cancelAddUser2Domain"==e)g=!1,v.success("取消添加用户到该域",{}),C();else if("saveUserToDomain"==e){var o=l.selectedDomainitem.domainID,d=l.selectedDomainitem.domainPath,c=(n=$("#userDomainName").val().split(" ")[0],$("#userDomainName").val().split(" ")[1],{domainID:o,domainPath:d});if(""==n)return void v.warning("请选择用户",{});f.addDomainUser(c,n,function(e){0==e.code?(v.success("添加用户到域成功",{}),g=!1,y()):v.warning("用户已经存在该域中，添加失败",{})})}}else if("网关视图"==l.activeMainTab)if("gateSave"==e){if(!a.label)return void v.warning("名称不能为空",{});if(!a.externalDevId)return void v.warning("设备地址不能为空",{});m.registerDevice(l.selectedGateitem.id,a,function(e){0==e.code&&(x(),v.success("注册成功",{}))})}else if("gateActive"==e){if("active"!=l.selectedGateitem.managedStatus)return void v.warning("网关不是激活状态，无法启用设备!",{});if(!a.modelId)return void v.warning("模型不能为空",{});if(!a.domainPath)return void v.warning("资源域不能为空",{});B.show({title:"提示",closable:!1,message:"确认从 "+l.selectedGateitem.name+" 网关启用 "+(a.label?a.label:"")+" 设备吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){m.activateDevice(a,function(e){0==e.code&&(x(),v.success("启用成功",{}))}),e.close()}},{label:"取消",action:function(e){e.close()}}]})}else"gateDel"==e?B.show({title:"提示",closable:!1,message:"确认从 "+l.selectedGateitem.name+" 网关注销 "+a.label+" 设备吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){m.unregisterDevice(l.selectedGateitem.id,a.id,function(e){0==e.code&&(x(),v.success("注销成功",{}))}),e.close()}},{label:"取消",action:function(e){e.close()}}]}):"gateActivedelete"==e&&B.show({title:"提示",closable:!1,message:"确认从 "+l.selectedGateitem.name+" 网关停用 "+a.label+" 设备吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){m.deactivateDevice(a.id,function(e){0==e.code&&(x(),v.success("停用成功",{}))}),e.close()}},{label:"取消",action:function(e){e.close()}}]})};var C=function(){g=!1,0!=l.selectedDomainitem.domainID?"tab3"==l.activeListTab?k():"tab4"==l.activeListTab&&y():v.warning("请先保存新添加的资源域，再进行以下操作",{})},L=function(){3==a.user.userType?($("#showbyusertype").show(),o.queryEnterpriseUser(function(e){0==e.code&&(l.userGridData.data=e.data,l.$broadcast(Event.DOMAININFOSINIT,l.userGridData))})):1!=a.user.userType&&2!=a.user.userType||$("#showbyusertype").hide(),null==l.domainsAry&&null==l.domainsAry&&""==l.domainsAry||(l.domainsAry=[],f.queryDomainByUser(a.user.userID,function(e){if(0==e.code){var t=e.data;for(var a in t)l.domainsAry.push(N(t[a])),null==l.selectedDomainitem&&0==a?(l.selectedDomainitem=l.domainsAry[a],k()):l.selectedDomainitem.domainPath==l.domainsAry[a].domainPath&&(l.selectedDomainitem=l.domainsAry[a],k())}}))},x=function(){l.gatewaysAry=[],m.getAllGateways(function(e){if(0==e.code)for(var t in e.data)l.gatewaysAry.push(M(e.data[t])),null==l.selectedGateitem&&0==t?(l.selectedGateitem=l.gatewaysAry[t],w(l.selectedGateitem)):l.selectedGateitem.id==l.gatewaysAry[t].id&&(l.selectedGateitem=l.gatewaysAry[t],w(l.selectedGateitem))})};l.changeManagedStatus=function(){"deactive"==l.selectedGateitem.managedStatus?B.show({title:"提示",closable:!1,message:"确认启用 "+l.selectedGateitem.name+" 网关吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){m.activateGateway(l.selectedGateitem.id,function(e){0==e.code&&(x(),v.success("启用成功",{}))}),e.close()}},{label:"取消",action:function(e){e.close()}}]}):B.show({title:"提示",closable:!1,message:"停用网关的操作会使该网关下所有的设备一并停用，请确认要停用 "+l.selectedGateitem.name+" 网关吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){m.deactivateGateway(l.selectedGateitem.id,function(e){0==e.code&&(x(),v.success("停用成功",{}))}),e.close()}},{label:"取消",action:function(e){e.close()}}]})},l.qrCode=function(){var e=$('<div style="padding-left:157px"></div>');e.qrcode({text:""+l.selectedGateitem.id}),B.show({title:"扫一扫加入"+l.selectedGateitem.label,closable:!0,message:e,buttons:[{label:"下载APP",cssClass:"btn-success",action:function(e){window.open("http://7mj4hc.com1.z0.glb.clouddn.com/index.html"),e.close()}},{label:"关闭",action:function(e){e.close()}}]})};var U=function(){$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){l.selectedDirective=null;var t=$(e.target).attr("name"),a=$(e.target).text();t?(l.activeListTab=t,l.$apply(),"tab2"==l.activeListTab&&i(function(){l.$broadcast(Event.CMDBINFOS4MAPINIT,{option:[m.selectedInstances,m.selectedAttrs]})}),C()):-1<a.search("视图")?(l.activeMainTab=$.trim($(e.target).text()),l.previousMainTab=$(e.relatedTarget).text(),l.editVisible=!1,"设备类型视图"==l.activeMainTab?(l.activeTab="属性",l.activeListTab="tab1",P()):"资源域视图"==l.activeMainTab?(L(),l.activeListTab="tab3"):"网关视图"==l.activeMainTab&&(x(),l.activeListTab="tab5"),l.$apply()):(l.activeTab=$.trim($(e.target).text()),$.trim($(e.relatedTarget).text()),S())})};l.$on("$destroy",function(){t.unregister(d)});l.gotoPath=function(e){if(e.nodes!=l.treeAry){var t=[];for(var a in l.routePaths){if(l.routePaths[a].id==e.id){t.push(l.routePaths[a]);break}t.push(l.routePaths[a])}l.routePaths=t,l.showChildren(e)}},l.showChildren=function(e){l.treeAry=e.nodes,l.selectedDitem=null,l.click(l.treeAry[0])};var V=function(){m.getRootModel(function(e){0==e.code&&(m.rootModel=e.data,l.routePaths.push(e.data),P())}),L(),U(),f.queryDomainTree(a.user.userID,function(e){l.domainListDic=e.domainListDic,l.domainListTree=e.domainListTree})};l.directiveBack=function(){l.doAction("directive-save",l.selectedDirective),l.selectedDirective=null},l.saveThresholds=function(i,s,e){m.saveThresholds(e,function(e){if(0==e.code){v.success("阈值设置保存成功",{});for(var t=!1,a=0;a<i.thresholds.length;a++)if(i.thresholds[a].alertCode==s){i.thresholds[a].thresholdsData=e.data,t=!0;break}t||i.thresholds.push({alertCode:s,thresholdsData:e.data})}})},a.user.isAuthenticated?V():l.$on("loginStatusChanged",function(e,t){a.user.isAuthenticated&&V()})}])});
//# sourceMappingURL=../../../map/app-oc/js/controllers/view-cmdb-ctrl.js.map
