define(["controllers/controllers","Array"],function(e){"use strict";e.initController("dataModelCtrl",["$scope","$q","$rootScope","$location","$routeParams","$timeout","kqiManagerUIService","userRoleUIService","resourceUIService","userLoginUIService","Info","growl","userEnterpriseService","viewFlexService","userDomainService","$window","freeboardservice","dialogue","ngDialog",function(H,e,a,t,l,i,P,n,o,r,d,j,c,u,p,s,b,v,B){var f,W="确定",z="取消",J=[{id:"all",label:"全库"},{id:"root",label:"企业级"},{id:"domain",label:"资源域"},{id:"model",label:"模型"},{id:"device",label:"设备"}],G=[{id:"js",label:"js"},{id:"python",label:"python"},{id:"groovy",label:"groovy"},{id:"spring",label:"spring"}],L=[{id:0,label:"原始数据"},{id:1,label:"聚合数据"},{id:2,label:"预测数据"}],V=[{id:"MINUTE",label:"每分钟"},{id:"HOUR",label:"每小时"},{id:"DAY",label:"每天"},{id:"WEEK",label:"每周"},{id:"MONTH",label:"每月"},{id:"YEAR",label:"每年"}],X=[{id:0,label:"不汇聚"},{id:1,label:"所有域"},{id:2,label:"企业域"}],g=function(a){$$.cacheAsyncData.call(P.getKqiModels,[],function(e){0==e.code&&a(e.data)})},y=function(a){$$.cacheAsyncData.call(o.getModels,[],function(e){0==e.code&&a(e.data)})},Z=function(e,a){$$.cacheAsyncData.call(P.getKqiModelById,[e],function(e){0==e.code&&a(e.data)})};y(function(){}),g(function(){}),f=function(e){var a,_={nodes:e,domainInfos:e};a=function(Y){var a=function(Q){g(function(q){y(function(e){var K=[{id:300,label:"管理域"},{id:301,label:"客户"},{id:302,label:"项目"}].concat(e),R=function(){for(var e=[],a=0;a<24;a++)e.push({id:a,label:a});return e}(),T=[{id:1,label:"一"},{id:2,label:"二"},{id:3,label:"三"},{id:4,label:"四"},{id:5,label:"五"},{id:6,label:"六"},{id:7,label:"日"}],U=[{id:1,label:"一"},{id:2,label:"二"},{id:3,label:"三"},{id:4,label:"四"},{id:5,label:"五"},{id:6,label:"六"},{id:7,label:"七"},{id:8,label:"八"},{id:9,label:"九"},{id:10,label:"十"},{id:11,label:"十一"},{id:12,label:"十二"}],O=Y.map(function(e){return e.name}),C=K[0].id,F=0,N={};Q&&(C=Q.targetResource?parseInt(Q.targetResource):-1),Q&&(F=null!=Q.expertDataModelId?Q.expertDataModelId:0),Q&&((N=Q.inputMapping)||(N={}));var a,t,l=function(e,a){var t,l={};if(a)for(var i in a.variables)t=a.variables[i],l[t.name]=N[t.name]?N[t.name]:0;var n={label:"计算时间",maxlength:12,value:H.$tabInx=0,right:!0,data:"second",apply:(H.naviClick=function(e){H.$tabInx=e},!1),textAfter:"秒",type:"input",composory:!0,events:{change:function(e){}},filterFormat:{label:"label",value:"id"}},o={label:"开始计算",maxlength:12,value:0,right:!0,data:"day",apply:!1,textAfter:"日",type:"input",composory:!0,events:{change:function(e){}},filterFormat:{label:"label",value:"id"}},r={label:"开始计算",maxlength:12,value:0,apply:!1,right:!0,data:"minute",textAfter:"分",type:"input",composory:!0,filterFormat:{label:"label",value:"id"}},d={label:"开始计算",maxlength:12,value:0,apply:!0,right:!0,data:"hour",textAfter:"点",type:"select",composory:!0,events:{change:function(e){}},options:R,filterFormat:{label:"label",value:"id"}},c={label:"开始计算",maxlength:12,value:0,apply:!1,right:!0,data:"week",textBefore:"星期",options:T,type:"select",composory:!0,events:{change:function(e){}},filterFormat:{label:"label",value:"id"}},u={label:"开始计算",apply:!1,maxlength:12,value:0,right:!0,data:"month",textAfter:"月",type:"select",options:U,composory:!0,events:{change:function(e){}},filterFormat:{label:"label",value:"id"}},p={label:"开始计算",maxlength:12,value:0,apply:!0,right:!0,data:"schedule",type:"groupSelect",composory:!0,groups:[d,r]},s=function(e,a){"MINUTE"==e?(p.apply=!0,n.value=a?a[0]:0,p.groups=[n]):"HOUR"==e?(p.apply=!0,r.value=a?(n.value=a[0],a[1]):n.value=0,p.groups=[r,n]):"DAY"==e?(p.apply=!0,d.value=a?(r.value=a[0],a[1]):r.value=0,p.groups=[d,r]):"WEEK"==e?(p.apply=!0,c.value=a?(d.value=a[0],a[1]):(d.value=0,1),p.groups=[c,d]):"MONTH"==e?(p.apply=!0,o.value=a?(d.value=a[0],a[1]):(d.value=0,1),p.groups=[o,d]):"YEAR"==e&&(p.apply=!0,u.value=a?(o.value=a[0],a[1]):o.value=1,p.groups=[u,o])};if(Q){var b=function(a){var e=[{name:"MINUTE",regExp:/(\d+)\ \*\ \*\ \*\ \*\ \?\ \*/},{name:"HOUR",regExp:/(\d+)\ (\d+)\ \*\ \*\ \*\ \?\ \*/},{name:"DAY",regExp:/0\ (\d+)\ (\d+)\ \*\ \*\ \?\ \*/},{name:"MONTH",regExp:/0\ 0\ (\d+)\ (\d+)\ \*\ \?\ \*/},{name:"YEAR",regExp:/0\ 0\ 0\ (\d+)\ (\d+)\ \?\ \*/},{name:"WEEK",regExp:/0\ 0\ (\d+)\ \?\ \*\ (\d+)\ \*/}].find(function(e){return e.regExp.test(a)});if(e){for(var t=[],l=1;l<3;l++){var i=$$.runRegExp(a,e.regExp,l);i&&t.push(parseInt(i))}return{granular:e.name,data:t}}return null}(Q.schedule);b?s(b.granular,b.data):s("DAY")}else s("DAY");var v={label:"KQI名称",maxlength:12,value:Q?Q.name:"",right:!!Q,composory:!0,data:"name",placeholder:"变量名称",events:{change:function(e){""==e.value?(e.error="变量名不可为空",e.right=!1):-1!=O.indexOf(e.value)?(e.error="变量名已存在",e.right=!1):(e.error=void 0,e.right=!0)}},type:"input"},f={label:"目标ID",maxlength:32,value:Q?Q.kpiId:"",right:!0,composory:!1,data:"kpiId",placeholder:"目标ID",type:"input"},g={label:"描述",maxlength:12,value:Q?Q.desc:"",right:!0,composory:!1,data:"desc",placeholder:"描述",type:"textarea"},y={label:"偏移周期数",value:Q?Q.timeOffsetPeriod:"",right:!0,composory:!1,data:"timeOffsetPeriod",placeholder:"偏移周期数",type:"number",events:{change:function(e){e.value&&4<e.value.toString().length?(e.error="长度不能大于4位数",e.right=!1):(e.error=void 0,e.right=!0)}}},h={label:"域路径",value:Q?Q.domainPath:"",right:!!Q,type:"tree",sortable:!0,filterable:!0,composory:!0,data:"domainPath",key:"domainPath",mark:"nodes",options:_,modes:{default:{type:"text"}},events:{change:function(e){""==e.value?(e.error="变量名不可为空",e.right=!1):(e.error=void 0,e.right=!0)}}},m={label:"资源模版",maxlength:12,value:C,right:!0,data:"targetResource",type:"select",composory:!0,options:K,events:{}},x=(Q&&Q.schedule,{label:"脚本类型",maxlength:12,value:Q?Q.scriptType:G[0].id,right:!0,apply:!1,data:"scriptType",type:"select",composory:!0,options:G,events:{change:function(e){0==e.value.length?(e.error="脚本类型不可为空",e.right=!1):(e.error=void 0,e.right=!0)}}}),I={label:"目标类型",maxlength:12,value:Q?Q.dataType:L[0].id,right:!0,data:"dataType",type:"select",composory:!0,options:L,events:{change:function(e){0==e.value.length?(e.error="目标资源类型不可为空",e.right=!1):(e.error=void 0,e.right=!0)}}},w={label:"域汇聚类型",maxlength:12,value:X[0].id,right:!0,data:"domainCalcType",type:"select",apply:!0,disabled:!1,composory:!0,options:X,events:{change:function(e){0==e.value.length?(e.error="域汇聚类型不可为空",e.right=!1):(e.error=void 0,e.right=!0)}}},A={label:"目标资源类型",maxlength:12,value:"model",apply:!1,right:!0,data:"targetType",type:"select",disabled:!0,composory:!0,options:J,events:{change:function(e){}}},D={label:"统计频率",maxlength:12,value:Q?Q.granularityUnit:V[2].id,right:!0,data:"granularityUnit",type:"select",composory:!0,options:V,events:{change:function(e){var a=e.value;s(a)}}},$={label:"预测方法",apply:!1,maxlength:12,value:Q?Q.forecastMethod:"",right:!0,composory:!1,data:"forecastMethod",placeholder:"预测方法",type:"input",events:{change:function(e){0==e.value.length?(e.error="预测方法不可为空",e.right=!1):(e.error=void 0,e.right=!0)}}},E={label:"计算方式",maxlength:12,value:0==F?0:1,right:!0,apply:!0,data:"",type:"radio",options:[{id:0,label:"专家模版"},{id:1,label:"表达式"}],composory:!0,events:{click:function(e){E.value=e.id,0==e.id?(M.apply=!0,k.apply=!0,S.apply=!1,M.calculable=!0,k.calculable=!0,S.calculable=!1):(M.apply=!1,k.apply=!1,S.apply=!0,M.calculable=!1,k.calculable=!1,S.calculable=!0)}}},M={label:"专家模版",maxlength:12,value:F,right:!0,data:"expertDataModelId",type:"select",apply:0==F,calculable:!1,composory:!0,options:q,events:{change:function(e){Z(e.value,function(e){var a,t={};if(e){var l=JSON.parse(e.viewContent);for(var i in l.variables)a=l.variables[i],t[a.name]="";k.value=t}})}}},k={label:"专家模版参数设置",maxlength:12,value:l,right:!0,apply:0==F,calculable:!1,data:"inputMapping",type:"kpiSelector",options:e,composory:!0,events:{change:function(e){}}},S={label:"表达式",right:!0,apply:!0,calculable:!0,value:Q?Q.expression:"",data:"expression",type:"codeMirror"};H.dialog={title:"KQI",note:{message:"KQI自定义统计指标"},tabs:[{id:0,label:"基础信息",inputs:[v,f,I,w,y,g,x,A,$]},{id:1,label:"资源配置",inputs:[h,m]},{id:2,label:"计算策略",inputs:[D,p]},{id:3,label:"表达式",inputs:[S]}],button:[{label:W,icon:"btn btn-primary",disabledFn:function(){var e=[];for(var a in H.dialog.tabs)e=e.concat(H.dialog.tabs[a].inputs);return e.some(function(e){return 0==e.right&&0!=e.apply})},fn:function(){var e=H.dialog,a=[];for(var t in e.tabs)a=a.concat(e.tabs[t].inputs);var l=function(n){var o="",r=["second","minute","hour","day","month","week","year"],e=n.find(function(e){return"week"==e.data||"day"==e.data}),d="week";e&&(d="week"==e.data?"day":"week");var c=!1;return function e(a){var t,l,i=(t=r[a],(l=n.find(function(e){return e.data==t}))?l.value:void 0);null!=i?(c=!0,o+=i):o+=1==c?r[a]==d?"?":"*":"0",r[++a]&&(o+=" ",e(a))}(0),o};if(Q){var i=function(e){"function"!=typeof e.value&&0!=e.calculable&&""!=e.data&&("groupSelect"==e.type?Q[e.data]=l(e.groups):Q[e.data]=e.value)};for(var t in a)i(a[t]);1==E.value&&(Q.expertDataModelId=0),P.updateKqiCalcRule(Q,function(e){if("0"==e.code){for(var a in j.success("KQI编辑完成"),Q=e.data,Y)if(Y[a].id==e.data.id){Y[a]=e.data;break}B.close()}})}else{var n={};for(var t in i=function(e){"function"!=typeof e.value&&0!=e.calculable&&""!=e.data&&("groupSelect"==e.type?n[e.data]=l(e.groups):n[e.data]=e.value)},a)i(a[t]);1==E.value?n.expertDataModelId=0:n.expression="var a=1",P.addKqiCalcRule(n,function(e){"0"==e.code&&(Y.pushbefore(e.data),j.success("KQI添加完成"),B.close())})}}},{label:z,icon:"btn btn-default",fn:function(){B.close()}}]}},i=function(t){0!=F?Z(F,function(e){var a=JSON.parse(e.viewContent);l(t,a)}):l(t)};C?(a=C,t=function(e){i(e)},$$.cacheAsyncData.call(o.getKpisByModelId,[a],function(e){0==e.code&&t(e.data)})):i()})}),B.open({template:"../partials/dialogue/config_alert_dia2.html",className:"ngdialog-theme-plain",scope:H})},e={},t={},l={},i=[];H.menuitems.A01_S97&&(e={icon:"fa fa-plus",class:"btn btn-primary btn-sm",label:"添加KQI",style:{margin:"2px"},type:"button",events:{click:function(){a()}}}),H.menuitems.A02_S97&&(t={label:"编辑",type:"button",class:"btn btn-default",events:{click:function(e){a(jQuery.extend(!0,{},e))}}},i.push(t)),H.menuitems.A03_S97&&(l={label:"删除",type:"button",class:"btn btn-default",events:{click:function(a){var e,t,l;e=a.id,t=function(e){0==e.code&&(j.success("删除KQI成功！"),a.remove())},l=[{label:W,icon:"btn btn-success",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){B.close(),P.deleteKqiCalcRule(e,function(e){t(e)})}},{label:z,icon:"btn btn-default",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){B.close()}}],H.dialog={title:{label:"提示"},description:{label:"确认要删除此KQI吗？"},fnlist:l},B.open({template:"../partials/dialogue/common_dia_prompt.html",className:"ngdialog-theme-plain",scope:H})}}},i.push(l)),H.calcRules={source:Y,showSelector:!1,header:[e],columnDefs:[{label:"标识",width:"10%",editable:!0,sortable:!0,filterable:!0,data:"id",type:"text",modes:{default:{type:"text"},edit:{type:"input",placeholder:"例如：请填写用户名，用户名不可为空"}}},{label:"名称",width:"20%",editable:!0,sortable:!0,filterable:!0,data:"name",type:"text",modes:{default:{type:"text"},edit:{type:"input",placeholder:"例如：请填写用户名，用户名不可为空"}}},{label:"对应指标",width:"10%",editable:!0,sortable:!0,filterable:!0,data:"kpiId",type:"text",modes:{default:{type:"text"},edit:{type:"input",placeholder:"例如：请填写用户名，用户名不可为空"}}},{label:"创建时间",data:"createTime",type:"date",format:"yy-mm-dd hh:nn:ss",filterable:!1,sortable:!0,modes:{default:{type:"date"}}},{label:"脚本类型",width:"10%",editable:!0,sortable:!0,filterable:!0,data:"scriptType",type:"select",options:G,filterFormat:{label:"label",value:"id"},modes:{default:{type:"text"},edit:{type:"input",placeholder:"例如：请填写用户名，用户名不可为空"}}},{label:"计算频率",width:"auto",editable:!0,sortable:!0,filterable:!0,data:"granularityUnit",type:"select",options:V,filterFormat:{label:"label",value:"id"},modes:{default:{type:"text"},edit:{type:"input",placeholder:"例如：请填写用户名，用户名不可为空"}}},{label:"操作",type:"buttonGroup",filterable:!1,sortable:!1,width:"141px",modes:{default:{options:i}}}]}},$$.cacheAsyncData.call(P.getKqiCalcRules,[],function(e){0==e.code&&a(e.data)})},$$.cacheAsyncData.call(p.queryDomainTree,[r.user.userID],function(e){0==e.code&&f(e.data)})}])});
//# sourceMappingURL=../../../map/app-oc/js/controllers/data-model-ctrl.js.map
