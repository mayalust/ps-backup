define(["controllers/controllers","bootstrap-dialog","Array"],function(e,m){"use strict";e.initController("enterpriseCtrl",["$scope","$routeParams","$timeout","$q","$location","ngDialog","userLoginUIService","energyConsumeUIService","growl","userDomainService",function(h,e,t,i,n,a,r,s,o,c){h.selectedCount=0;var l=[];h.$watch("myDicts",function(e,t){e&&(h.industryList=h.myDicts.industryShortType,h.industryList.forEach(function(e){e.id=e.valueCode,e.text=e.param}))}),h.dialog={title:"企业信息",input:{name:"",statisticsType:"",industryType:"",province:"",city:"",county:"",address:"",id:-1,createTime:new Date},list:{provincesList:h.provinces,periodList:[{id:"MONTH",label:"月"},{id:"QUARTER",label:"季度"},{id:"YEAR",label:"年"}],cityList:null,districtList:null},event:{provinceClick:function(e){h.dialog.input.districtId="",h.cityDics[e]&&(h.dialog.list.cityList=h.cityDics[e])},cityClick:function(e){h.districtDics[e]&&(h.dialog.list.districtList=h.districtDics[e])}},button:[{label:"确定",disabled:function(){},fn:function(){h.dialog.input.values={},h.dialog.input.values.standardAddress=h.dialog.input.county?h.dialog.input.county:h.dialog.input.city?h.dialog.input.city:h.dialog.input.province;-1==h.dialog.input.id?s.addEnterpriseInfo(h.dialog.input,function(e){0==e.code&&(h.searchData(),o.success("添加企业信息成功",{}))}):0<h.dialog.input.id&&s.updateEnterpriseInfo(h.dialog.input,function(e){0==e.code&&(h.searchData(),o.success("修改企业信息成功",{}))}),a.close()}},{label:"取消",fn:function(){a.close()}}]};h.addNewClick=function(){var e;e={},h.dialog.input={name:e.name?e.name:"",statisticsType:e.statisticsType?e.statisticsType:"",industryType:e.industryType?e.industryType:"",province:e.province?e.province:"",city:e.city?e.city:"",county:e.county?e.county:"",address:e.address?e.address:"",id:e.id?e.id:-1,createTime:e.createTime?e.createTime:new Date},a.open({template:"../partials/dialogue/enterprise_dia.html",className:"ngdialog-theme-plain",scope:h})},h.tableInit={header:{label:"企业信息管理",time:""},select:{name:"",industryType:"",statisticsType:""},event:function(){h.tableInit.select.name=1==h.queryState.state?h.tableInit.select.name:null,h.tableInit.select.industryType=2==h.queryState.state?h.tableInit.select.industryType:null,h.tableInit.select.province=3==h.queryState.state?h.tableInit.select.province:null,h.tableInit.select.city=3==h.queryState.state?h.tableInit.select.city:null,h.tableInit.select.county=3==h.queryState.state?h.tableInit.select.county:null,h.tableInit.select.statisticsType=4==h.queryState.state?h.tableInit.select.statisticsType:null},clacTime:function(){h.tableInit.header.time?s.clacKqiByTime(h.tableInit.header.time,function(e){0==e.code&&o.success("已开始计算数据",{})}):o.warning("请先选择时间",{})}},h.doAction=function(e,t,i){"delete"==e&&m.show({title:"提示",closable:!1,message:"确认删除该企业信息？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){s.deleteEnterpriseInfo([t],function(e){if(i(e),0==e.code)return h.searchData(),o.success("企业信息已删除",{}),h.selectedCount=0,void h.$apply()}),e.close()}},{label:"取消",action:function(e){e.close()}}]})},h.pipeline=function(e){var y=$.extend({pages:1,url:"",data:null,method:"POST"},e),f=-1,m=null,g=null,b=null;return function(n,a,e){var t=!1,i=n.start,r=n.start,s=n.length,o=i+s,c=n.columns[n.order[0].column].data,l=n.order[0].dir;if(e.clearCache?(t=!0,e.clearCache=!1):f<0||i<f||m<o?t=!0:JSON.stringify(n.order)===JSON.stringify(g.order)&&JSON.stringify(n.columns)===JSON.stringify(g.columns)&&JSON.stringify(n.search)===JSON.stringify(g.search)||(t=!0),g=$.extend(!0,{},n),t){if(i<f&&(i-=s*(y.pages-1))<0&&(i=0),m=(f=i)+s*y.pages,n.start=i,n.length=s*y.pages,$.isFunction(y.data)){var d=y.data(n);d&&$.extend(n,d)}else $.isPlainObject(y.data)&&$.extend(n,y.data);var u={start:n.start,length:n.length,sort:c,sortType:l,statCount:1==n.draw};h.getEnterpriceByPage(h.queryList,u,function(e,t){var i={};i.data=e,i.draw=n.draw,i.recordsTotal=null!=t?-1==t?b.recordsTotal:t:e.length,i.recordsFiltered=i.recordsTotal,b=$.extend(!0,{},i),f!=r&&i.data.splice(0,r-f),-1<=s&&i.data.splice(s,i.data.length),a(i)})}else{var p=$.extend(!0,{},b);p.draw=n.draw,p.data.splice(0,i-f),p.data.splice(s,p.data.length),a(p)}}},h.getEnterpriceByPage=function(e,t,i){s.findEnterpriseInfosByCondition([e,t],function(e){0==e.code&&i&&i(e.data.data,e.data.total)})},h.searchData=function(){h.queryList={id:h.tableInit.select.id?h.tableInit.select.id:"",industryType:h.tableInit.select.industryType?h.tableInit.select.industryType:"",province:h.tableInit.select.province?h.tableInit.select.province:"",city:h.tableInit.select.city?h.tableInit.select.city:"",county:h.tableInit.select.county?h.tableInit.select.county:"",statisticsType:h.tableInit.select.statisticsType?h.tableInit.select.statisticsType:"",name:h.tableInit.select.name?h.tableInit.select.name:""},t(function(){h.$broadcast(Event.ENTERPRISEINIT+"_info",{option:[]})})};var d=function(){var t;t=i.defer(),c.queryDomainTree(r.user.userID,function(e){h.domainListTree=e.domainListTree,h.domainListDic=e.domainListDic,t.resolve("success")}),l.push(t.promise),i.all(l).then(function(){h.searchData()})};r.user.isAuthenticated?d():h.$on("loginStatusChanged",function(e,t){r.user.isAuthenticated&&d()})}]),e.initController("productCtrl",["$scope","$routeParams","$timeout","$q","$location","ngDialog","unitService","userLoginUIService","energyConsumeUIService","growl","userDomainService",function(n,t,i,e,a,r,s,o,c,l,d){n.selectedCount=0,100==o.user.userType?n.ifShowEnter=!0:n.ifShowEnter=!1;var u=[];n.unitList=s.units,n.unitDics=s.unitDics;n.dialog={title:"产品结构",input:{enterpriseId:"",name:"",desc:"",unit:"",id:-1,createTime:new Date},button:[{label:"确定",disabled:function(){return!scope.dialog.input.every(function(e){return 0!=e.right})},fn:function(){-1==n.dialog.input.id?(n.ifShowEnter||delete n.dialog.input.enterpriseId,c.addProduct(n.dialog.input,function(e){if(0==e.code){var t=e.data;n.queryAllList.push(t),p(n.queryAllList),l.success("添加产品信息成功",{})}})):0<n.dialog.input.id&&c.updateProduct(n.dialog.input,function(e){0==e.code&&n.queryAllList.forEach(function(e){e.id==n.dialog.input.id&&$.extend(e,n.dialog.input),p(n.queryAllList),l.success("产品信息修改完成",{})})}),r.close()}},{label:"取消",fn:function(){r.close()}}]};var p=function(e){i(function(){n.$broadcast(Event.ENTERPRISEINIT+"_product",{option:[e]})})};n.tableInit={header:{label:"产品结构管理",delete:"删除产品结构"},select:{name:"",desc:"",enterpriseId:""},event:{addClick:function(){var e;e={},n.dialog.input={name:e.name?e.name:"",desc:e.desc?e.desc:"",unit:e.unit?e.unit:"",id:e.id?e.id:-1,createTime:e.createTime?e.createTime:new Date},r.open({template:"../partials/dialogue/product_info_dia.html",className:"ngdialog-theme-plain",scope:n})},goClear:function(){n.tableInit.select.name=1==n.queryState.state?n.tableInit.select.name:null,n.tableInit.select.desc=2==n.queryState.state?n.tableInit.select.desc:null,n.tableInit.select.enterpriseId=3==n.queryState.state?n.tableInit.select.enterpriseId:null}}},n.doAction=function(e,t,i){"delete"==e&&m.show({title:"提示",closable:!1,message:"确认删除该产品结构？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){c.deleteProduct([t],function(e){i(e),0==e.code&&(t.forEach(function(e){for(var t in n.queryAllList)e==n.queryAllList[t].id&&n.queryAllList.splice(t,1)}),l.success("产品结构已删除",{}),n.selectedCount=0,n.$apply())}),e.close()}},{label:"取消",action:function(e){i(!1),e.close(),n.selectedCount=0,n.$apply()}}]})},n.searchData=function(){var e={id:n.tableInit.select.id?n.tableInit.select.id:"",enterpriseId:n.tableInit.select.enterpriseId?n.tableInit.select.enterpriseId:t.enterpriseId?t.enterpriseId:"",desc:n.tableInit.select.desc?n.tableInit.select.desc:"",name:n.tableInit.select.name?n.tableInit.select.name:""};c.findProducts(e,function(e){0==e.code&&(n.queryAllList=e.data,p(e.data))})},c.findEnterpriseInfosByCondition([{id:"",industryType:"",province:"",city:"",county:"",statisticsType:"",name:""},{start:0,length:1e9,sort:"createTime",sortType:"desc",statCount:!0}],function(e){0==e.code&&(e.data.data.forEach(function(e){e.text=e.name}),n.enterpriseList=e.data.data)});var y=function(){var t;t=e.defer(),d.queryDomainTree(o.user.userID,function(e){n.domainListTree=e.domainListTree,n.domainListDic=e.domainListDic,t.resolve("success")}),u.push(t.promise),e.all(u).then(function(){n.searchData()})};o.user.isAuthenticated?y():n.$on("loginStatusChanged",function(e,t){o.user.isAuthenticated&&y()})}]),e.initController("productStructureCtrl",["$scope","$routeParams","$timeout","$q","$location","ngDialog","userLoginUIService","energyConsumeUIService","growl","userDomainService",function(a,e,t,i,n,r,s,o,c,l){a.selectedCount=0;var d=[],u=e.productId;a.dialog={title:"工艺流程",input:{occupyPrcent:"",energyConsumeNodeId:"",id:-1,productId:u,createTime:new Date},event:{verifyFun:function(e,t){var i;if("number"==e){i=/^\d+(\.{0,1}\d+){0,1}$/.test(t),0==t&&(i=!0),a.mistakeMesg=!i}}},button:[{label:"确定",disabled:function(){return!scope.dialog.input.every(function(e){return 0!=e.right})},fn:function(){if(a.mistakeMesg)c.warning("请正确输入所用分钟数",{});else{a.dialog.input.productId=parseInt(u),-1==a.dialog.input.id?o.addProductStruct(a.dialog.input,function(e){if(0==e.code){var t=e.data;a.queryAllList.push(t),p(a.queryAllList),c.success("添加工艺流程成功",{})}}):0<a.dialog.input.id&&o.updateProductStruct(a.dialog.input,function(e){0==e.code&&a.queryAllList.forEach(function(e){e.id==a.dialog.input.id&&$.extend(e,a.dialog.input),p(a.queryAllList),c.success("工艺流程修改完成",{})})}),r.close()}}},{label:"取消",fn:function(){r.close()}}]};var p=function(e){t(function(){a.$broadcast(Event.ENTERPRISEINIT+"_structrue",{option:[e]})})};a.tableInit={header:{label:"工艺流程",delete:"删除工艺流程"},select:{occupyPrcent:"",energyConsumeNodeId:""},event:{addClick:function(){var e;e={},a.dialog.input={occupyPrcent:e.occupyPrcent?e.occupyPrcent:"",energyConsumeNodeId:e.energyConsumeNodeId?e.energyConsumeNodeId:"",id:e.id?e.id:-1,createTime:e.createTime?e.createTime:new Date},r.open({template:"../partials/dialogue/product_structrue_dia.html",className:"ngdialog-theme-plain",scope:a})},goClear:function(){a.tableInit.select.occupyPrcent=1==a.queryState.state?a.tableInit.select.occupyPrcent:null,a.tableInit.select.energyConsumeNodeId=1==a.queryState.state?a.tableInit.select.energyConsumeNodeId:null}}},a.doAction=function(e,i,n){"delete"==e&&m.show({title:"提示",closable:!1,message:"确认删除该工艺流程？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){o.deleteProductStruct([i],function(e){if(n(e),0==e.code){for(var t in a.queryAllList)i.forEach(function(e){a.queryAllList[t].id==e&&a.queryAllList.splice(t,1)});c.success("工艺流程已删除",{}),a.selectedCount=0,a.$apply()}}),e.close()}},{label:"取消",action:function(e){n(!1),e.close(),a.selectedCount=0,a.$apply()}}]})},a.searchData=function(){var e={productId:parseInt(a.tableInit.select.productId)?parseInt(a.tableInit.select.productId):parseInt(u)?parseInt(u):"",energyConsumeNodeId:a.tableInit.select.energyConsumeNodeId?a.tableInit.select.energyConsumeNodeId:"",occupyPrcent:parseFloat(a.tableInit.select.occupyPrcent)?parseFloat(a.tableInit.select.occupyPrcent):""};o.findProductStructs(e,function(e){0==e.code&&(a.queryAllList=e.data,p(e.data))})};function y(e){o.queryEnergyTree([e],function(e){a.energyListTree=e.energyListTree,a.energyListDic=e.energyListDic})}var f=function(){var t;t=i.defer(),l.queryDomainTree(s.user.userID,function(e){a.domainListTree=e.domainListTree,a.domainListDic=e.domainListDic,t.resolve("success")}),d.push(t.promise),100==s.user.userType?o.findProductById([parseInt(u)],function(e){y(e.data.domainPath)}):y(),i.all(d).then(function(){a.searchData()})};s.user.isAuthenticated?f():a.$on("loginStatusChanged",function(e,t){s.user.isAuthenticated&&f()})}]),e.initController("enterpriseOperateCtrl",["$scope","$routeParams","$timeout","$q","$location","ngDialog","unitService","userLoginUIService","energyConsumeUIService","growl","userDomainService",function(a,r,t,i,e,s,n,o,c,l,d){a.selectedCount=0;var u=[],p=(a.unitList=n.units,a.unitDics=n.unitDics,function(e){t(function(){a.$broadcast(Event.ENTERPRISEINIT+"_operate",{option:[e]})})}),y=function(e){if(a.ifView=!1,e.statisticsPeriod)var t=new Date(e.statisticsPeriod).Format("yyyy-M").split("-");a.dialog.input.enterpriseOperateInfo={productionValue:e.productionValue||"",additionalValue:e.additionalValue||"",id:e.id||0,statisticsPeriod:"",createTime:e.createTime||new Date},a.ignoreList={year:e.statisticsPeriod?parseInt(t[0]):"",month:e.statisticsPeriod?parseInt(t[1]):"",quarter:e.statisticsPeriod?parseInt(t[1]):""},e.hasOwnProperty("id")||a.productYields.forEach(function(e){e.yield=""})};a.ignoreList={year:"",month:"",quarter:""},a.dialog={title:"企业经营信息",statisticsType:"",input:{enterpriseOperateInfo:{productionValue:"",additionalValue:"",yieldUnit:"",statisticsPeriod:"",createTime:new Date}},select:{statisticsYear:function(){for(var e=[],t=2015;t<2026;t++)e.push({id:t,text:t+"年"});return e}(),statisticsMonth:function(){for(var e=[],t=1;t<13;t++)e.push({id:t,text:t+"月"});return e}(),statisticsQuarter:[{id:1,text:"第一季度"},{id:4,text:"第二季度"},{id:8,text:"第三季度"},{id:12,text:"第四季度"}]},button:[{label:"确定",disabled:function(){return!scope.dialog.input.every(function(e){return 0!=e.right})},fn:function(){var t=function(e){return!!/^[1-9]\d*(\.\d+)?$/.test(e)||(l.warning("请输入且为大于0的正数",{}),!1)},i=a.dialog.input.enterpriseOperateInfo;for(var e in a.dialog.input.productYields=a.productYields,"YEAR"==a.dialog.statisticsType?i.statisticsPeriod=a.ignoreList.year?new Date([a.ignoreList.year,1,1].join("-")):"":"MONTH"==a.dialog.statisticsType?i.statisticsPeriod=a.ignoreList.month?new Date([a.ignoreList.year,a.ignoreList.month,1].join("-")):"":"QUARTER"==a.dialog.statisticsType&&(i.statisticsPeriod=a.ignoreList.quarter?new Date([a.ignoreList.year,a.ignoreList.quarter,1].join("-")):""),i)if(("productionValue"==e||"additionalValue"==e)&&!t(i[e]))return;a.dialog.input.productYields.forEach(function(e){t(e.yield)});r.enterpriseId&&(a.dialog.input.enterpriseOperateInfo.enterpriseId=r.enterpriseId),0==i.id?c.addEnterpriseOperateInfoDto(a.dialog.input,function(e){if(0==e.code){var t=e.data.enterpriseOperateInfo;a.queryAllList.push(t),p(a.queryAllList),l.success("添加企业经营信息成功",{})}}):0<i.id&&c.updateEnterpriseOperateInfoDto(a.dialog.input,function(t){0==t.code&&a.queryAllList.forEach(function(e){if(e.id==i.id)return $.extend(e,t.data.enterpriseOperateInfo),p(a.queryAllList),void l.success("企业经营信息修改完成",{})})}),s.close()}},{label:"取消",fn:function(){s.close()}}]},a.tableInit={header:{label:"企业经营信息",add:"添加经营信息",delete:"删除经营信息"},select:{year:"",month:"",quarter:"",statisticsYear:[{id:0,text:"请选择..."}].concat(a.dialog.select.statisticsYear),statisticsMonth:[{id:0,text:"请选择..."}].concat(a.dialog.select.statisticsMonth),statisticsQuarter:[{id:0,text:"请选择..."}].concat(a.dialog.select.statisticsQuarter),statisticsPeriod:"",productionValue:""},event:{addClick:function(){y({}),s.open({template:"../partials/dialogue/enterprise_operate_info_dia.html",className:"ngdialog-theme-plain",scope:a})},changeYear:function(e){e||(a.tableInit.select.month="",a.tableInit.select.quarter="")}}},a.doAction=function(e,i,n){"delete"==e?m.show({title:"提示",closable:!1,message:"确认删除该企业经营信息？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){c.deleteEnterpriseOperateInfoDto([i],function(e){n(e),0==e.code&&(i.forEach(function(e){for(var t in a.queryAllList)e==a.queryAllList[t].id&&a.queryAllList.splice(t,1)}),a.selectedCount=0,a.$apply())}),e.close()}},{label:"取消",action:function(e){n(!1),e.close(),a.selectedCount=0,a.$apply()}}]}):"commit"==e?m.show({title:"提示",closable:!1,message:"确认"+(100==o.user.userType?"审核":"提交")+" 该企业经营信息？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){var t=100==o.user.userType?"pass":"yes";c.updateEnterpriseOperateInfoCommitStatus([i,t],function(e){n(e),0==e.code&&(100==o.user.userType?l.success("企业经营信息已审核",{}):l.success("企业经营信息已提交",{}),a.selectedCount=0,a.$apply())}),e.close()}},{label:"取消",action:function(e){n(!1),e.close(),a.selectedCount=0,a.$apply()}}]}):"edit"==e?c.findProductYieldsByOperateId([i.id],function(e){0==e.code&&(y(i),r.enterpriseId||(a.dialog.input.enterpriseOperateInfo.enterpriseId=i.enterpriseId),a.productYields=e.data,s.open({template:"../partials/dialogue/enterprise_operate_info_dia.html",className:"ngdialog-theme-plain",scope:a}))}):"view"==e&&c.findProductYieldsByOperateId([i.id],function(e){0==e.code&&(y(i),a.ifView=!0,a.productYields=e.data,s.open({template:"../partials/dialogue/enterprise_operate_info_dia.html",className:"ngdialog-theme-plain",scope:a}))})},a.searchData=function(){var e="";"YEAR"==a.dialog.statisticsType?e=a.tableInit.select.year?new Date(String(a.tableInit.select.year)):"":"MONTH"==a.dialog.statisticsType?e=a.tableInit.select.year&&!a.tableInit.select.month?new Date(String(a.tableInit.select.year)):a.tableInit.select.month?new Date([a.tableInit.select.year,a.tableInit.select.month].join("-")):"":"QUARTER"==a.dialog.statisticsType&&(e=a.tableInit.select.year&&!a.tableInit.select.quarter?new Date(String(a.tableInit.select.year)):a.tableInit.select.quarter?new Date([a.tableInit.select.year,a.tableInit.select.quarter].join("-")):"");var t={productionValue:a.tableInit.select.productionValue?a.tableInit.select.productionValue:"",statisticsPeriod:e||"",enterpriseId:r.enterpriseId?r.enterpriseId:""};c.findEnterpriseOperateInfos(t,function(e){0==e.code&&(a.queryAllList=e.data,p(e.data))})};var f=function(){var e,t;e=o.user.domains,t=i.defer(),r.enterpriseId?c.findEnterpriseInfoById([r.enterpriseId],function(e){0==e.code&&(a.dialog.statisticsType=e.data.statisticsType,t.resolve("success"))}):c.findEnterpriseInfoByDomainPath([e],function(e){0==e.code&&(a.dialog.statisticsType=e.data.statisticsType,t.resolve("success"))}),t.promise,c.findProducts({enterpriseId:r.enterpriseId},function(e){0==e.code&&(e.data.forEach(function(e){e.yield="",e.yieldUnit=e.unit,e.productId=e.id,e.productName=e.name,delete e.id}),a.productYields=e.data)}),i.all(u).then(function(){a.searchData()})};o.user.isAuthenticated?f():a.$on("loginStatusChanged",function(e,t){o.user.isAuthenticated&&f()})}]),e.initController("basicEnterpriseCtrl",["$scope","$routeParams","$timeout","$q","$location","ngDialog","userLoginUIService","energyConsumeUIService","growl","userDomainService",function(n,e,t,i,a,r,s,o,c,l){n.sortList=[{id:"id_1",label:"我是哈哈1"},{id:"id_2",label:"我是哈哈2"},{id:"id_3",label:"我是哈哈3"},{id:"id_4",label:"我是哈哈4"},{id:"id_5",label:"我是哈哈5"}],n.sortList2=[{id:"id_11",label:"我是try1"},{id:"id_22",label:"我是try2"},{id:"id_33",label:"我是try3"}],n.setting={boxClass:"boxClass",ulClass:"ulhaha",liClass:"lihaha",type:"sort",placeholder:"placeholder",cursor:"move",delay:50,distance:3},n.clipboard="hahaCopy",n.ifGovernment=!1,n.mistakeMesg={},n.$watch("myDicts",function(e,t){e&&(n.industryList=n.myDicts.industryShortType,n.granularityList=n.myDicts.KqiGranularityUnit,n.industryList.forEach(function(e){e.id=e.valueCode,e.text=e.param}),n.granularityList=n.granularityList.filter(function(e){return e.id=e.valueCode,e.text=e.label,"MONTH"==e.valueCode||"QUARTER"==e.valueCode||"YEAR"==e.valueCode}))}),-1<location.hash.search("#/businessManagement")&&(n.ifGovernment=!0);n.tableInit={header:{label:n.ifGovernment?"企业管理":"企业基本信息"},input:{province:"",city:"",county:"",enterpriseSize:"",address:"",contactPhone:"",contactEmail:"",website:"",business:""},select:{name:"",cityList:[],districtList:[]},event:{editClick:function(){n.mistakeMesg.phone?c.warning("请正确输入手机号码",{}):n.mistakeMesg.email?c.warning("请正确输入邮箱地址",{}):n.mistakeMesg.website?c.warning("请正确输入主页地址",{}):(n.tableInit.input.values={},n.tableInit.input.values.standardAddress=n.tableInit.input.county?n.tableInit.input.county:n.tableInit.input.city?n.tableInit.input.city:n.tableInit.input.province,o.updateEnterpriseInfo(n.tableInit.input,function(e){0!=e.code||c.success("企业信息保存成功",{})}))}}},n.verifyFun=function(e,t){var i;if("phone"==t){i=/^((1[34578]\d{9})|(0\d{2,4}\-\d{7,8})|\d{8})$/.test(e),n.mistakeMesg.phone=!i&&!!e}else"email"==t?(i=/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/.test(e),n.mistakeMesg.email=!i&&!!e):"website"==t&&(i=/(\w+):\/\/([^/:]+)(:\d+)?([^# :]{1,12}.?([^# :]*))/.test(e),n.mistakeMesg.website=!i&&!!e)};var d=function(){e.enterpriseId?o.findEnterpriseInfoById([e.enterpriseId],function(e){0==e.code&&(n.tableInit.input=e.data,n.tableInit.select.cityList=n.cityDics[e.data.province],n.tableInit.select.districtList=n.districtDics[e.data.city])}):o.findEnterpriseInfoByDomainPath([n.userInfo.domains],function(e){0==e.code&&(n.tableInit.input=e.data,n.tableInit.select.cityList=n.cityDics[e.data.province],n.tableInit.select.districtList=n.districtDics[e.data.city])})};s.user.isAuthenticated?d():n.$on("loginStatusChanged",function(e,t){s.user.isAuthenticated&&d()})}]),e.initController("publishCtrl",["$scope","$routeParams","$timeout","$q","$location","ngDialog","resourceUIService","userLoginUIService","energyConsumeUIService","growl","userDomainService",function(n,e,i,a,t,r,s,o,c,l,d){n.tab="tab1",n.ifView=!1,n.ifEnterprise=1e3==o.user.userType;var u=[];n.dialog={title:"节能指标",input:{lastReducePeriodData:"",thisReduceIndicator:"",id:-1,enterpriseId:"",createTime:new Date},event:{verifyFun:function(e,t){var i;if("number"==e){i=/^\d+(\.{0,1}\d+){0,1}$/.test(t),0==t&&(i=!0),n.mistakeMesg=!i}}},button:[{label:"确定",disabled:function(){return!scope.dialog.input.every(function(e){return 0!=e.right})},fn:function(){-1==n.dialog.input.id&&c.publishReduceEnergy(n.dialog.input,function(e){if(0==e.code){var t=e.data;n.reduceEnergyList.push(t),p(n.reduceEnergyList,"_publish"),l.success("发布节能指标成功",{})}}),r.close()}},{label:"取消",fn:function(){r.close()}}]},n.dialog2={title:"预测结果",param:{lastReducePeriodData:"",thisReduceIndicator:"",id:-1,enterpriseId:"",createTime:new Date},button:[{label:"确定",disabled:function(){return!scope.dialog.param.every(function(e){return 0!=e.right})},fn:function(){-1==n.dialog2.param.id&&c.publishForecastResult(n.dialog2.param.enterpriseId,function(e){if(0==e.code){var t=e.data;n.ForecastResult.push(t),p(n.ForecastResult,"_forecast"),l.success("发布预测结果成功",{}),r.close()}})}},{label:"取消",fn:function(){r.close()}}]},n.tableInit={select:{enterpriseId:"",reducePeriod:""},event:{addClick:function(){n.statisticsType="",n.dialog.input={lastReducePeriodData:"",thisReduceIndicator:"",id:-1,enterpriseId:"",createTime:new Date},r.open({template:"../partials/dialogue/publish_dia.html",className:"ngdialog-theme-plain",scope:n})},forecastClick:function(){n.ifView=!1,n.statisticsType="",n.dialog2.param={lastReducePeriodData:"",thisReduceIndicator:"",id:-1,enterpriseId:"",createTime:new Date},r.open({template:"../partials/dialogue/forecast_dia.html",className:"ngdialog-theme-plain",scope:n})},goClear:function(){n.tableInit.select.occupyPrcent=1==n.queryState.state?n.tableInit.select.occupyPrcent:null,n.tableInit.select.energyConsumeNodeId=1==n.queryState.state?n.tableInit.select.energyConsumeNodeId:null}}},n.mistakeMesg={},n.verifyFun=function(e,t){var i;i=/^[+-]?([1-9][0-9]*|0)(\.[0-9]+)?%?$/.test(e),n.mistakeMesg[t]=!i};var p=function(e,t){i(function(){n.$broadcast(Event.ENTERPRISEINIT+t,{option:[e]})})};n.doAction=function(e,t,i){if("complete"==e)m.show({title:"提示",closable:!1,message:"确认该节能周期已完成？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){c.saveReduceEnergy({id:t,lastCompleteStatus:"yes"},function(e){0==e.code&&i(e)}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("view"==e){n.ifView=!0,t.energyTypeForecastData.some(function(e){return e.hasOwnProperty("value")})||t.energyTypeForecastData.forEach(function(e){for(var t in e)e.energyType=t,e.value=e[t]}),n.dialog2.param.energyTypeForecastData=t.energyTypeForecastData,r.open({template:"../partials/dialogue/forecast_dia.html",className:"ngdialog-theme-plain",scope:n})}},n.queryEnterpriseById=function(e){var t=e.id.split(":")[1];c.findEnterpriseInfoById(t,function(e){0==e.code&&(n.statisticsType=e.data.statisticsType)}),c.findLastEnergyByEnterpriseId(t,function(e){0==e.code&&(n.dialog.input.lastReducePeriodData=e.data.value)}),"tab3"==n.tab&&c.findForecastResult(t,function(e){0==e.code&&(e.data.energyTypeForecastData.forEach(function(e){for(var t in e)e.energyType=t,e.value=e[t]}),n.dialog2.param.energyTypeForecastData=e.data.energyTypeForecastData)})},n.searchDate=function(){var e={enterpriseId:parseInt(n.tableInit.select.enterpriseId)?parseInt(n.tableInit.select.enterpriseId):""};"tab1"==n.tab?c.findReduceEnergyListByCondition(e,function(e){0==e.code&&(n.reduceEnergyList=e.data,p(n.reduceEnergyList,"_publish"))}):"tab3"==n.tab&&c.findForecastResultsByCondition(e,function(e){0==e.code&&(n.ForecastResult=e.data,p(n.ForecastResult,"_forecast"))})};var y=function(){var t;t=a.defer(),s.getDomainsByFilter({modelId:303,layer:2},function(e){0==e.code&&(n.EnterprisesDic={},e.data.forEach(function(e){e.text=e.label,n.EnterprisesDic[e.id]=e}),n.allEnterprises=e.data,n.queryEnterpriseList=[{id:"",text:"请选择..."}].concat(e.data),t.resolve("success"))}),u.push(t.promise),$('#deploy a[data-toggle="tab"]').on("shown.bs.tab",function(e){if(0<$(e.target).closest("li.disabled").length)return $(e.target).closest("li.disabled").removeClass("active"),void $(e.target).closest("ul").children("[name="+n.tab+"]").addClass("active");var t=$(e.target).closest("li").attr("name");t&&(n.tab=t,n.$apply()),"tab3"!=t&&"tab1"!=t||n.searchDate()}),a.all(u).then(function(){n.searchDate()})};o.user.isAuthenticated?y():n.$on("loginStatusChanged",function(e,t){o.user.isAuthenticated&&y()})}]),e.initController("benchMarkingCtrl",["$scope","$routeParams","$filter","$timeout","$q","$location","ngDialog","dictionaryService","kpiDataService","userLoginUIService","energyConsumeUIService","growl","resourceUIService",function(c,e,t,i,l,n,a,r,d,u,s,o,p){var y=require("echarts").init(document.getElementById("bardataview")),f=[],m={};function g(){var e=(new Date).getFullYear(),t=(new Date).getMonth();c.queryDitem={},c.queryDitem.industryType="",c.queryDitem.enterpriseId="",c.queryDitem.year=e,c.queryDitem.month=t,c.yearList=[],c.monthList=[];for(var i=0;i<8;i++)c.yearList.push({id:e-i,text:e-i+"年"});for(i=1;i<13;i++)c.monthList.unshift({id:i,text:i+"月"});y.clear()}c.industryDic={},c.statisticsTypeDic={MONTH:"月",QUARTER:"季度",YEAR:"年"},c.$watch("myDicts",function(e,t){e&&(c.industryList=c.myDicts.industryShortType,c.energyType=c.myDicts.energyType,c.industryList.forEach(function(e){e.id=e.valueCode,e.text=e.param,c.industryDic[e.valueCode]=e,c.industryDic[e.label]=e}),c.energyType.forEach(function(e){m[e.label]=e}))}),c.goClear=function(){g()};function b(e,t){var i,n=c.energyType.map(function(e){return e.label}),a=e.map(function(e){return e.value}),r=t.map(function(e){return e.value});i={result:[e,t],xAxis:n,legend:["节点能耗","标杆值"],series:[{name:"节点能耗",type:"bar",data:a||[]},{name:"标杆值",type:"bar",data:r||[]}]},y.setOption({title:{text:"",subtext:"",x:"center",y:"top"},tooltip:{trigger:"axis",axisPointer:{type:"cross",crossStyle:{color:"#999"}}},toolbox:{feature:{dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},legend:{data:i.legend},xAxis:[{type:"category",boundaryGap:!0,axisLabel:{interval:0},data:i.xAxis,axisPointer:{type:"shadow"}}],yAxis:[{type:"value",name:"节点能耗（单位：吨标煤）",boundaryGap:!0,axisLabel:{formatter:"{value}"}},{type:"value",name:"标杆值（单位：吨标煤）",boundaryGap:!0,axisLabel:{formatter:"{value}"}}],series:i.series})}var h=function(o){s.findEnterpriseInfoById(o.enterpriseId,function(e){var t,i,n,a,r,s;0==e.code&&(c.enterpriseInfo=e.data,a=e.data.industryType,r=l.defer(),s=["kpi",{isRealTimeData:(c.energyByIndustryCodeAry=[],!1),nodeIds:[u.user.domainID],kpiCodes:[3328],timeRange:"",statisticType:"psiot",includeInstance:!0,condList:[],timePeriod:0,dataType:1}],d.getValueList(s,function(e){0==e.code&&(e.data.forEach(function(e){var t=e.instance.split(",");e.instanceName=c.industryDic[t[0]].param,e.instanceCode=c.industryDic[t[0]].valueCode,e.energyName=t[1],e.energyCode=m[t[1]].valueCode,a==e.instanceCode&&c.energyByIndustryCodeAry.push(e)}),r.resolve("success"))}),f.push(r.promise),t=o,i=l.defer(),n=["kpi",{isRealTimeData:(c.energyByEnterpriseIdAry=[],!1),nodeIds:[t.enterpriseId],kpiCodes:[3331],startTime:new Date(t.startTime),endTime:new Date(t.endTime),timeRange:"",aggregateType:["VALENTWEIGHT"],granularityUnit:"MONTH",statisticType:"psiot",includeInstance:!0,condList:[],timePeriod:0,dataType:1}],d.getValueList(n,function(e){0==e.code&&(e.data.forEach(function(e){e.energyName=e.instance,e.energyCode=m[e.instance].valueCode,c.energyByEnterpriseIdAry.push(e)}),i.resolve("success"))}),f.push(i.promise),l.all(f).then(function(){b(c.energyByEnterpriseIdAry,c.energyByIndustryCodeAry)}))})};c.goSearch=function(e){e.startTime=new Date(e.year+"-"+e.month),e.endTime=new Date(e.year+"-"+e.month+"-02"),c.queryDitem.enterpriseId?h(e):o.info("请选择企业名称",{})};var v=function(){g(),s.findEnterpriseInfos(function(e){0==e.code&&(c.EnterprisesDic={},e.data.forEach(function(e){e.text=e.name,c.EnterprisesDic[e.id]=e}),c.allEnterprises=e.data,c.queryEnterpriseList=e.data)})};u.user.isAuthenticated?v():c.$on("loginStatusChanged",function(e,t){u.user.isAuthenticated&&v()})}]),e.initController("benchMarkSetCtrl",["$scope","$routeParams","$filter","$timeout","$q","$location","ngDialog","dictionaryService","kpiDataService","userLoginUIService","energyConsumeUIService","growl","resourceUIService",function(s,e,i,t,n,a,r,o,c,l,d,u,p){var y=require("echarts").init(document.getElementById("barsettingdataview")),f=[];s.energyDic={},s.industryDic={},s.statisticsTypeDic={MONTH:"月",QUARTER:"季度",YEAR:"年"},s.$watch("myDicts",function(e,t){e&&(s.industryList=s.myDicts.industryShortType,s.energyType=s.myDicts.energyType,s.industryList.forEach(function(e){e.id=e.label,e.text=e.param,s.industryDic[e.valueCode]=e,s.industryDic[e.label]=e}),s.energyType.forEach(function(e){s.energyDic[e.label]=e}))}),s.goClear=function(){s.queryDitem.industryType="",s.filterLastDic={},s.filterBestDic={},y.clear()};function m(e,i){var t,n=s.energyType.map(function(e){return e.label}),a=[],r=[];(n=n.sort()).forEach(function(t){e.forEach(function(e){t==e.energyName&&a.push(e.value)})}),n.forEach(function(t){i.forEach(function(e){t==e.energyName&&r.push(e.value)})}),t={result:[r,a],xAxis:n,legend:["上周期设置值","标杆值"],series:[{name:"上周期设置值",type:"bar",data:r},{name:"标杆值",type:"bar",data:a}]},y.setOption({title:{text:"",subtext:"",x:"center",y:"top"},tooltip:{trigger:"axis",axisPointer:{type:"cross",crossStyle:{color:"#999"}}},toolbox:{feature:{dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},legend:{data:t.legend},xAxis:[{type:"category",boundaryGap:!0,axisLabel:{interval:0},data:t.xAxis,axisPointer:{type:"shadow"}}],yAxis:[{type:"value",name:"上周期设置值（单位：吨标煤）",boundaryGap:!0,axisLabel:{formatter:"{value}"}},{type:"value",name:"标杆值（单位：吨标煤）",boundaryGap:!0,axisLabel:{formatter:"{value}"}}],series:t.series})}var g=function(t){var e;s.filterBestAry=[],s.filterLastAry=[],s.filterBestDic={},s.filterLastDic={},s.bestIndustryCodeAry.forEach(function(e){t.industryType==e.instanceName&&(s.filterBestAry.push(e),s.filterBestDic[e.energyName]=e)}),s.lastIndustryCodeAry.forEach(function(e){t.industryType==e.instanceName&&(s.filterLastAry.push(e),s.filterLastDic[e.energyName]=e)}),s.energyType.forEach(function(e){s.filterLastDic[e.label]||(s.filterLastDic[e.label]={value:0}),s.filterBestDic[e.label]||(s.filterBestDic[e.label]={value:0})}),s.lastTime=0<s.filterLastAry.length?(e=s.filterLastAry[0].insertTime,e=i("date")(e,"yyyy-MM-dd")):"",m(s.filterBestAry,s.filterLastAry)};s.goSearch=function(e){g(e)},s.goSubmit=function(){var e=s.industryDic[s.queryDitem.industryType].label,t={};for(var i in s.filterBestDic)t[e+","+i]=s.filterBestDic[i].value;var n=[];for(var i in t)n.push({nodeId:l.user.domainID,kpiCode:3327,value:t[i],instance:i});d.saveMarkValue(n,function(e){0==e.code&&b(function(){s.goSearch(s.queryDitem),u.success("对标设置成功")})})};var b=function(e){var t,i;!function(){var t=n.defer();s.bestIndustryCodeAry=[];var e=["kpi",{isRealTimeData:!0,nodeIds:[l.user.domainID],kpiCodes:[3327],granularityUnit:"MONTH",timeRange:"",statisticType:"psiot",includeInstance:!0,condList:[],timePeriod:1,dataType:1}];c.getValueList(e,function(e){0==e.code&&(e.data.forEach(function(e){var t=e.instance.split(",");e.instanceName=s.industryDic[t[0]].label,e.insShortName=s.industryDic[t[0]].param,e.instanceCode=s.industryDic[t[0]].valueCode,e.energyName=t[1],e.energyCode=s.energyDic[t[1]].valueCode}),s.bestIndustryCodeAry=e.data,t.resolve("success"))}),f.push(t.promise)}(),t=n.defer(),i=["kpi",{isRealTimeData:(s.lastIndustryCodeAry=[],!1),nodeIds:[l.user.domainID],kpiCodes:[3328],timeRange:"",statisticType:"psiot",includeInstance:!0,condList:[],timePeriod:0,dataType:1}],c.getValueList(i,function(e){0==e.code&&(e.data.forEach(function(e){var t=e.instance.split(",");e.instanceName=s.industryDic[t[0]].label,e.insShorteName=s.industryDic[t[0]].param,e.instanceCode=s.industryDic[t[0]].valueCode,e.energyName=t[1],e.energyCode=s.energyDic[t[1]].valueCode}),s.lastIndustryCodeAry=e.data,t.resolve("success"))}),f.push(t.promise),n.all(f).then(function(){e&&e()})};l.user.isAuthenticated?b():s.$on("loginStatusChanged",function(e,t){l.user.isAuthenticated&&b()})}]),e.initController("keyEnterpriseCtrl",["$scope","$routeParams","$timeout","$q","$location","ngDialog","dictionaryService","kpiDataService","userLoginUIService","energyConsumeUIService","growl","resourceUIService",function(a,e,t,r,i,n,s,o,c,l,d,u){a.ifView=!1;var p=require("echarts"),y=p.init(document.getElementById("piedataview")),f=p.init(document.getElementById("bardataview"));a.kpiCodeDic={3301:"综合能耗",3304:"GDP能耗",3300:"单能源消耗"},a.unitCodeDic={3301:"单位：吨标煤",3304:"单位：吨标煤/万元",3300:"单位：吨标煤"},a.industryDic={},a.statisticsTypeDic={MONTH:"月",QUARTER:"季度",YEAR:"年"},a.energyDic={};var m=s.dicts.industryShortType;a.energyType=s.dicts.energyType,m.forEach(function(e){a.industryDic[e.valueCode]=e,a.industryDic[e.label]=e}),a.energyType.forEach(function(e){a.energyDic[e.label]=e}),a.goClear=function(){a.queryDitem={topN:"",statisticsType:"",kpiCode:"",energyType:""},a.enterpriseInfoAry=[],y.clear()};var g=function(e){if(0==e.legend.length)return y.clear(),void f.clear();y.setOption({title:{text:"",subtext:"",x:"center",y:"top"},toolbox:{feature:{dataView:{show:!0,readOnly:!1},restore:{show:!0},saveAsImage:{show:!0}}},tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} (占比：{d}%)"},legend:{orient:"vertical",left:"left",data:e.legend},series:[{name:"",type:"pie",radius:"55%",center:["50%","40%"],data:e.series.data,itemStyle:{emphasis:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]}),f.setOption({tooltip:{trigger:"axis",axisPointer:{type:"cross",crossStyle:{color:"#999"}}},toolbox:{feature:{dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},legend:{data:e.legend},xAxis:[{type:"category",data:[a.kpiCodeDic[e.param.kpiCode]],axisPointer:{type:"shadow"}}],yAxis:[{type:"value",axisLabel:{margin:30,formatter:"{value}"},name:a.unitCodeDic[e.param.kpiCode]}],series:e.series1})};function b(i){a.enterpriseInfoAry=[];"3300"!=i.kpiCode&&(i.energyType="");var e=[i.topN,i.statisticsType,i.kpiCode,i.energyType,i.range];l.getTopN(e,function(e){var n=[],t=[];0==e.code&&(t=e.data,e.data.forEach(function(e){var t,i;n.push((t=e.nodeId,i=r.defer(),l.findEnterpriseInfoById(t,function(e){0==e.code&&(a.enterpriseInfoAry.push(e.data),i.resolve("success"))}),i.promise))})),r.all(n).then(function(){!function(e,i,t){e.forEach(function(t){i.forEach(function(e){e.nodeId==t.id&&(e.name=t.name)})});var n=e.map(function(e){return e.name}),a={};a.name=i.map(function(e){return e.instance}),a.data=i.map(function(e){return{value:e.value,name:e.name}});var r=[];a.data.forEach(function(e){r.push({data:[e.value],name:e.name,type:"bar"})}),g({param:t,result:[e,i],legend:n,series:a,series1:r})}(a.enterpriseInfoAry,t,i)})})}a.goSearch=function(e){e&&(e.topN?e.statisticsType?e.kpiCode?e.range?"3300"!=e.kpiCode||e.energyType?b(e):d.info("请选择能源类型",{}):d.info("请选择时间段",{}):d.info("请选择指标",{}):d.info("请选择统计周期",{}):d.info("请选择topN",{}))};c.user.isAuthenticated||a.$on("loginStatusChanged",function(e,t){c.user.isAuthenticated})}]),e.initController("potentialCtrl",["$scope","$filter","$routeParams","$timeout","$q","$location","ngDialog","dictionaryService","kpiDataService","userLoginUIService","energyConsumeUIService","growl","resourceUIService",function(f,t,e,a,u,i,n,r,s,o,p,y,c){var l=require("echarts"),m=l.init(document.getElementById("potentialdataview")),g=l.init(document.getElementById("potentialDeviceview")),d={},b={max:"最大值",min:"最小值",avg:"平均值"};f.tab="tab1",f.showTable1=!1,f.showTable2=!1,f.industryDic={},f.filterEnterprises=[],f.queryDitem={},f.statisticsTypeDic={MONTH:"月",QUARTER:"季度",YEAR:"年"};f.$watch("myDicts",function(e,t){e&&(f.industryList=f.myDicts.industryShortType,f.energyType=f.myDicts.energyType,f.industryList.forEach(function(e){e.id=e.valueCode,e.text=e.param,f.industryDic[e.valueCode]=e,f.industryDic[e.label]=e}),f.energyType.forEach(function(e){e.text=e.label,d[e.label]=e}))});var h=function(e){return e=t("date")(e,"yyyy-MM")},v=function(e,t,i,n){a(function(){f.$broadcast(Event.ENTERPRISEINIT+n,{option:[e,t,i]})})},I=function(e){0<jQuery(e).find(".fa.fa-plus").length&&jQuery.AdminLTE.boxWidget.collapse(jQuery(e))};f.goClear=function(){"tab1"==f.tab?(f.queryDitem.enterpriseIds=[],f.queryDitem.industryType="",f.queryDitem.markValue="",f.queryDitem.modelId="",f.queryDitem.startTime="",f.queryDitem.endTime="",m.clear(),f.showTable1=!1):"tab3"==f.tab&&(f.queryDitem1.industryType="",f.queryDitem1.markValue="",f.queryDitem1.enterpriseId="",f.queryDitem1.modelId="",f.queryDitem1.startTime="",f.queryDitem1.endTime="",g.clear(),f.showTable2=!1)};function D(n,i,a){var e,t,r=[],s={},o={},c=[],l=[];n.forEach(function(e){for(var t in a.nodeIdDic)s[a.nodeIdDic[t].name]||(s[a.nodeIdDic[t].name]=[]),e.nodeId==t&&s[a.nodeIdDic[t].name].push(e.value)}),a.enterpriseIds.forEach(function(e){r.push(f.enterprisesDic[e].name)}),(r=a.nodeIds.map(function(e){return a.nodeIdToEnfoDic[e].name+"-"+a.nodeIdDic[e].label})).push(b[a.markValue]),n.forEach(function(e){o[e.arisingTime]||(o[e.arisingTime]=e.arisingTime,c.push(h(e.arisingTime)))}),a.nodeIds.forEach(function(i){l.push({name:a.nodeIdToEnfoDic[i].name+"-"+a.nodeIdDic[i].label,type:"bar",data:c.map(function(t){var e=n.find(function(e){return h(e.arisingTime)==t&&e.nodeId==i});return e||{}})})}),l.push({name:b[a.markValue],type:"line",data:c.map(function(t){var e=i.find(function(e){return h(e.arisingTime)==t});return e||{}})}),t={title:{text:""},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#6a7985"}}},legend:{data:(e={xAxis:c,legend:r,series:l}).legend},toolbox:{feature:{dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:[{type:"category",boundaryGap:!0,data:e.xAxis}],yAxis:[{type:"value"}],series:e.series},"tab1"==f.tab?m.setOption(t):"tab3"==f.tab&&g.setOption(t)}var T=function(t,i,n){var e=["kpi",{category:"time",isRealTimeData:!1,kpiCodes:"enterpriseGDP"==i?[3302]:[3304],startTime:new Date(t.startTime),endTime:new Date(t.endTime),timeRange:"",statisticType:"psiot",includeInstance:!0,condList:[],timePeriod:0,dataType:1}];e[1].nodeIds="enterpriseGDP"==i?t.enterpriseIds:t.nodeIds,s.getValueList(e,function(e){0==e.code&&("enterpriseGDP"==i?(f.enterpriseGDPList=e.data,function(l,d,u,p){var t={},i=[],y=[];d.forEach(function(e){t[e.arisingTime]||(t[e.arisingTime]=e.arisingTime,i.push(e.arisingTime))}),i.forEach(function(c){p.nodeIds.forEach(function(t){var e,i,n,a,r,s,o;y.push({arisingTime:h(c),nodeName:p.nodeIdToEnfoDic[t].name+"-"+p.nodeIdDic[t].label,nodeValue:(o=d.find(function(e){return c==e.arisingTime&&e.nodeId==t}),o?o.value:"-"),markValue:(s=u.find(function(e){return c==e.arisingTime}),s?s.value:"-"),diffValue:(a=d.find(function(e){return c==e.arisingTime&&e.nodeId==t}),r=u.find(function(e){return c==e.arisingTime}),a&&r?(a.value-r.value).toFixed(2):"-"),diffToGDP:(e=d.find(function(e){return c==e.arisingTime&&e.nodeId==t}),i=u.find(function(e){return c==e.arisingTime}),n=l.find(function(e){return c==e.arisingTime&&e.nodeId==p.nodeIdToEnfoDic[t].id}),e&&i&&n?((e.value-i.value).toFixed(2)*n.value).toFixed(2):"-")})})});var e=[{data:"arisingTime",title:"时间"},{data:"nodeName",title:"节点名称"},{data:"nodeValue",title:"节点GDP能耗"},{data:"markValue",title:b[p.markValue]},{data:"diffValue",title:"差值"},{data:"diffToGDP",title:"差值能耗值"}],n=[];e.forEach(function(e,t){n.push({target:t,data:e.data,render:function(e,t,i){return escape(e)}})}),"tab1"==f.tab?v(e,n,y,"_potential_data"):"tab3"==f.tab&&v(e,n,y,"_potential_device")}(f.enterpriseGDPList,f.energyByEnterpriseIdAry,f.markValueList,t)):(f.energyByEnterpriseIdAry=[],e.data.forEach(function(e){f.energyByEnterpriseIdAry.push(e)}),D(f.energyByEnterpriseIdAry,f.markValueList,t)),n&&n())})};f.goSearch=function(n){if(n&&n.industryType)if(!n||"tab3"==f.tab&&!n.enterpriseId||"tab1"==f.tab&&0==n.enterpriseIds.length)y.info("请选择企业",{});else if(n&&n.modelId)if(n&&n.modelId){if(!n||!n.startTime){var e=(new Date).getFullYear(),t=(new Date).getMonth(),i=(new Date).getMonth()+1;n.startTime=new Date(e+"-"+t),n.endTime=new Date(e+"-"+i)}if(n&&n.markValue){var a=[],r={},s={},o=0,c=[],l=[];n.enterToNodesDic={};var d=function(t){var i=u.defer();return p.queryDomainsByEnterpriseId(t,function(e){0==e.code&&("tab1"==f.tab?(o++,(c=e.data.filter(function(e){return e.modelDefinitionId==n.modelId})).forEach(function(e){a.push(e.id),r[e.id]=e,s[e.id]=f.enterprisesDic[t]}),n.enterToNodesDic[t]||(n.enterToNodesDic[t]=c),o==n.enterpriseIds.length&&(n.nodeIds=a,n.nodeIdDic=r,n.nodeIdToEnfoDic=s)):"tab3"==f.tab&&(e.data.forEach(function(e){e.modelDefinitionId==n.modelId&&c.push(e)}),c.forEach(function(e){a.push(e.id),r[e.id]=e,s[e.id]=f.enterprisesDic[t]}),n.nodeIds=a,n.nodeIdDic=r,n.nodeIdToEnfoDic=s),i.resolve("success"))}),i.promise};"tab1"==f.tab?(m.clear(),f.showTable1=!0,I("#viewcollapse1"),I("#viewcollapse2"),n.enterpriseIds.forEach(function(e){l.push(d(e))})):"tab3"==f.tab&&(g.clear(),f.showTable2=!0,I("#devicecollapse1"),I("#devicecollapse2"),n.enterpriseIds=[n.enterpriseId],l.push(d(n.enterpriseId))),u.all(l).then(function(){var e,t,i;t=function(){T(n,"",function(){var e,t;e=n,t={},$.extend(t,e),"tab1"==f.tab?t.enterpriseIds=e.enterpriseIds:"tab3"==f.tab&&(t.enterpriseIds=[e.enterpriseId]),T(t,"enterpriseGDP")})},i=["MONTH",(e=n).industryType,e.modelId,e.markValue,[3304],e.startTime,e.endTime],p.getIndustryMarkValue(i,function(e){0==e.code&&(t&&t(),f.markValueList=e.data)})})}else y.info("请选择取值类型",{})}else y.info("请选择设备",{});else y.info("请选择设备",{});else y.info("请选择行业",{})},f.filterModel=function(e){var t=e;"tab3"==f.tab&&(t=[e]),0!=e.length&&p.getModelDefinitionsByEnterpriseIds(t,function(e){0==e.code&&(e.data.forEach(function(e){e.text=e.label}),f.flterDeviceList=e.data)})};var E=function(){p.findEnterpriseInfos(function(e){0==e.code&&(f.enterprisesDic={},e.data.forEach(function(e){e.text=e.name,f.enterprisesDic[e.id]=e}),f.allEnterprises=e.data)}),c.getModelsByCondition({},function(e){0==e.code&&(f.allModelsDic={},e.data.forEach(function(e){f.allModelsDic[e.id]=e}),f.allModels=e.data)}),p.getDeviceTypeNames("devicetype",function(e){0==e.code&&(e.data.forEach(function(e){e.text=e.label}),f.allDeviceList=e.data)}),$('#deploy a[data-toggle="tab"]').on("shown.bs.tab",function(e){if(0<$(e.target).closest("li.disabled").length)return $(e.target).closest("li.disabled").removeClass("active"),void $(e.target).closest("ul").children("[name="+f.tab+"]").addClass("active");var t=$(e.target).closest("li").attr("name");t&&(f.tab=t,f.$apply())}),jQuery.AdminLTE.boxWidget.collapse(jQuery("#viewcollapse1")),jQuery.AdminLTE.boxWidget.collapse(jQuery("#viewcollapse2")),jQuery.AdminLTE.boxWidget.collapse(jQuery("#devicecollapse1")),jQuery.AdminLTE.boxWidget.collapse(jQuery("#devicecollapse2"))};o.user.isAuthenticated?E():f.$on("loginStatusChanged",function(e,t){o.user.isAuthenticated&&E()})}]),e.initController("forecastCtrl",["$scope","$filter","$routeParams","$timeout","$q","$location","ngDialog","dictionaryService","kpiDataService","userLoginUIService","energyConsumeUIService","growl","resourceUIService",function(l,t,e,i,n,a,r,s,o,c,d,u,p){var y=require("echarts"),f=y.init(document.getElementById("areaview")),m=y.init(document.getElementById("industryview")),g=y.init(document.getElementById("energyview1")),b=y.init(document.getElementById("energyview2")),h=y.init(document.getElementById("energyview3")),v=y.init(document.getElementById("deviceView")),I=y.init(document.getElementById("enterpriseView"));l.area=l.$parent.districtDics["安徽省,合肥市"],l.tab="tab1",l.energyDic={},l.showEnergyTitle=!1,l.industryShortType=s.dicts.industryShortType,l.energyType=s.dicts.energyType,l.industryShortType.forEach(function(e){e.id=e.param,e.text=e.param}),l.energyType.forEach(function(e){e.text=e.label,e.id=e.label,l.energyDic[e.label]=e}),l.statisticsTypeList=[{id:"MONTH",text:"月"},{id:"QUARTER",text:"季度"},{id:"YEAR",text:"年"}];var D=[{id:3319,type:"area",label:"区域工业附加值能耗"},{id:3318,type:"area",label:"区域GDP能耗"},{id:3315,type:"area",label:"区域综合能耗"},{id:3330,type:"industry",label:"行业工业附加值能耗"},{id:3329,type:"industry",label:"行业GDP能耗"},{id:3312,type:"industry",label:"行业综合能耗"},{id:3332,type:"energy",label:"能源类型的工业附加值能耗"},{id:3331,type:"energy",label:"能源类型的GDP能耗"},{id:3300,type:"energy",label:"能源类型的综合能耗"},{id:3305,type:"device",label:"工业附加值能耗"},{id:3304,type:"device",label:"GDP能耗"},{id:3301,type:"device",label:"综合能耗"}];l.goClear=function(){l.queryDitem.area="",l.queryDitem.industry="",l.queryDitem.energy="",l.queryDitem.enterpriseId="",l.queryDitem.enterpriseId2="",l.queryDitem.enterpriseId5="",l.queryDitem.statisticsType1="",l.queryDitem.statisticsType2="",l.queryDitem.statisticsType3="",l.queryDitem.statisticsType4="",l.queryDitem.statisticsType5="",l.queryDitem.modelId="",l.queryDitem.nodeId="",l.showEnergyTitle=!1,f.clear(),m.clear(),g.clear(),b.clear(),h.clear(),v.clear(),I.clear()};var T=function(e){var t=[];t="tab3"==l.tab?[{name:"单位（吨标煤/万元）",boundaryGap:!0,type:"value"},{name:"单位（吨标煤）",boundaryGap:!0,type:"value"}]:[{name:"单位（吨标煤/万元）",boundaryGap:!0,type:"value",max:e.yAxis[0]},{name:"单位（吨标煤）",boundaryGap:!0,type:"value",max:e.yAxis[1]}];var i,n={title:{text:""},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#6a7985"}}},legend:{data:e.legend,selected:(i={},e.legend.forEach(function(e){i[e]="tab3"!=l.tab}),i["电力"]=!0,i["电力（真实值）"]=!0,i["水"]=!0,i["水（真实值）"]=!0,i)},toolbox:{feature:{dataView:{readOnly:!1},magicType:{type:["line","bar"]},restore:{},saveAsImage:{}}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:[{type:"category",boundaryGap:!0,data:e.xAxis}],yAxis:t,series:e.series};"tab1"==l.tab?f.setOption(n):"tab2"==l.tab?m.setOption(n):"tab3"==l.tab?3332==e.kpiCode?g.setOption(n):3331==e.kpiCode?b.setOption(n):3300==e.kpiCode&&h.setOption(n):"tab4"==l.tab?v.setOption(n):"tab5"==l.tab&&I.setOption(n)},E=function(e){return e=t("date")(e,"yyyy-MM")},C=function(e,t){o.getValueList(e,function(e){0==e.code&&t(e.data)})},x=function(r,s){var e,o=[],t=[],i=[];r.forEach(function(e){3315==e.kpiCode||3312==e.kpiCode||3300==e.kpiCode||3301==e.kpiCode?i.push(e.value):t.push(e.value),-1==o.indexOf(E(e.arisingTime))&&o.push(E(e.arisingTime))}),s&&s.forEach(function(e){3315==e.kpiCode||3312==e.kpiCode||3300==e.kpiCode||3301==e.kpiCode?i.push(e.value):t.push(e.value)}),t=t.sort(function(e,t){return e-t}),i=i.sort(function(e,t){return e-t}),e=[t[t.length-1],i[i.length-1]];var n=[];"tab1"==l.tab?n=D.filter(function(e){return"area"==e.type}):"tab2"==l.tab?n=D.filter(function(e){return"industry"==e.type}):"tab3"==l.tab?n=D.filter(function(e){return"energy"==e.type}):"tab4"!=l.tab&&"tab5"!=l.tab||(n=D.filter(function(e){return"device"==e.type}));var a=[];n.forEach(function(e){a.push(e.label,e.label+"（真实值）")});var c=[];n.map(function(n){var e=o.map(function(i){var e=r.find(function(e){var t=E(e.arisingTime);return i==t&&e.kpiCode==n.id});return e||[]}),t=o.map(function(i){if(s)var e=s.find(function(e){var t=E(e.arisingTime);return i==t&&e.kpiCode==n.id});return e||[]}),i={name:n.label,type:"bar",yAxisIndex:3315==n.id||3312==n.id||3300==n.id||3301==n.id?1:0,data:e.map(function(e){return e.value})},a={name:n.label+"（真实值）",type:"line",yAxisIndex:3315==n.id||3312==n.id||3300==n.id||3301==n.id?1:0,data:t.map(function(e){return e&&e.value?e.value:"-"})};c.push(i,a)}),T({xAxis:o,yAxis:e,legend:a,series:c})},w=function(e,i){var t=[];l.energyType.forEach(function(e){t.push(e.text,e.text+"（真实值）")});var n={},a={},r=[];D.filter(function(e){return"energy"==e.type}).forEach(function(t){n[t.id]=[],a[t.id]=[],e.forEach(function(e){t.id==e.kpiCode&&n[t.id].push(e)}),i.forEach(function(e){t.id==e.kpiCode&&a[t.id].push(e)})});for(var s in n)r.push({kpiCode:s,data:n[s],trueData:a[s],xAxis:[],legend:t,series:[]});r.forEach(function(e){var s;(s=e).data.forEach(function(e){-1==s.xAxis.indexOf(E(e.arisingTime))&&s.xAxis.push(E(e.arisingTime))}),l.energyType.map(function(n){function e(e,t){return e.map(function(i){var e=t.find(function(e){var t=E(e.arisingTime);return i==t&&e.instance==n.text});return e||[]})}var t=e(s.xAxis,s.data),i=e(s.xAxis,s.trueData),a={name:n.label,type:"bar",data:t.map(function(e){return e.value})},r={name:n.label+"（真实值）",type:"line",yAxisIndex:1,data:i.map(function(e){return e.value})};s.series.push(a,r)}),T(e)})};l.goSearch=function(e){var i=["kpi",{category:"time",isRealTimeData:!0,timeRange:"",aggregateType:[],statisticType:"psiot",includeInstance:!0,condList:[],timePeriod:15552e6,dataType:2}];if("tab1"==l.tab){i[1].granularityUnit=e.statisticsType1,i[1].nodeIds=[c.user.domainID];var t=D.filter(function(e){return"area"==e.type});i[1].kpiCodes=t.map(function(e){return e.id}),i[1].queryInstances=e.area,C(i,function(t){i[1].dataType=1,C(i,function(e){x(t,e)})})}else if("tab2"==l.tab){i[1].granularityUnit=e.statisticsType2,i[1].nodeIds=[c.user.domainID];t=D.filter(function(e){return"industry"==e.type});i[1].kpiCodes=t.map(function(e){return e.id}),i[1].queryInstances=e.industry,C(i,function(t){i[1].dataType=1,C(i,function(e){x(t,e)})})}else if("tab5"==l.tab){i[1].nodeIds=[e.enterpriseId5];t=D.filter(function(e){return"device"==e.type});i[1].kpiCodes=t.map(function(e){return e.id}),C(i,function(t){i[1].dataType=1,C(i,function(e){x(t,e)})})}else if("tab3"==l.tab){l.showEnergyTitle=!0,i[1].granularityUnit=e.statisticsType3,i[1].nodeIds=l.queryDitem.enterpriseId2?[l.queryDitem.enterpriseId2]:[c.user.domainID];t=D.filter(function(e){return"energy"==e.type});i[1].kpiCodes=t.map(function(e){return e.id}),i[1].queryInstances=e.energy,C(i,function(t){i[1].dataType=1,C(i,function(e){w(t,e)})})}else if("tab4"==l.tab){if(!e.enterpriseId)return void u.info("请选择企业",{});if(!e.modelId)return void u.info("请选择设备",{});i[1].nodeIds=[e.nodeId],i[1].granularityUnit=e.statisticsType4;t=D.filter(function(e){return"device"==e.type});i[1].kpiCodes=t.map(function(e){return e.id}),C(i,function(t){i[1].dataType=1,C(i,function(e){x(t,e)})})}},l.filterModel=function(e){l.filterNodes=[],l.queryDitem.modelId="",l.queryDitem.nodeId="";var t=e.id.split(":")[1];l.queryDitem.statisticsType4=l.enterprisesDic[t].statisticsType,l.$apply(),d.getModelDefinitionsByEnterpriseIds([t],function(e){0==e.code&&(e.data.forEach(function(e){e.text=e.label}),l.flterDeviceList=e.data)})},l.filterNodeId=function(e){var i,t={enterpriseId:l.queryDitem.enterpriseId,modelId:e.id.split(":")[1]};i=t,d.queryDomainsByEnterpriseId(i.enterpriseId,function(e){if(0==e.code){var t=e.data.filter(function(e){return e.text=e.name,e.modelDefinitionId&&e.modelDefinitionId==i.modelId});l.filterNodes=t}})},l.filterStatistic=function(e){var t=e.id.split(":")[1];"tab3"==l.tab?(l.queryDitem.statisticsType3=l.enterprisesDic[t].statisticsType,l.$apply()):"tab5"==l.tab&&(l.queryDitem.statisticsType5=l.enterprisesDic[t].statisticsType,l.$apply())};var L=function(){d.findEnterpriseInfos(function(e){0==e.code&&(l.enterprisesDic={},e.data.forEach(function(e){e.text=e.name,l.enterprisesDic[e.id]=e}),l.allEnterprises=e.data)}),d.getDeviceTypeNames("devicetype",function(e){0==e.code&&(e.data.forEach(function(e){e.text=e.label}),l.allDeviceList=e.data)}),$('#deploy a[data-toggle="tab"]').on("shown.bs.tab",function(e){if(0<$(e.target).closest("li.disabled").length)return $(e.target).closest("li.disabled").removeClass("active"),void $(e.target).closest("ul").children("[name="+l.tab+"]").addClass("active");var t=$(e.target).closest("li").attr("name");t&&(l.tab=t,l.$apply())})};c.user.isAuthenticated?L():l.$on("loginStatusChanged",function(e,t){c.user.isAuthenticated&&L()})}]),e.initController("deviceComparisonCtrl",["$scope","$filter","$routeParams","$timeout","$q","$location","ngDialog","dictionaryService","kpiDataService","userLoginUIService","energyConsumeUIService","growl","resourceUIService",function(l,t,e,i,d,n,a,r,u,s,p,o,c){var y=require("echarts"),f=y.init(document.getElementById("deviceview")),m=y.init(document.getElementById("device3view"));l.industryDic={},l.tab="tab1",l.statisticsTypeDic={MONTH:"月",QUARTER:"季度",YEAR:"年"},l.energyDic={};var g=r.dicts.industryShortType;l.energyType=r.dicts.energyType,g.forEach(function(e){l.industryDic[e.valueCode]=e,l.industryDic[e.label]=e}),l.energyType.forEach(function(e){e.id=e.label,e.text=e.label,l.energyDic[e.label]=e}),l.goClear=function(){l.queryDitem.enterpriseIds=[],l.queryDitem.modelId="",l.queryDitem.energyType="",f.clear()};var b=function(e){return e=t("date")(e,"yyyy-MM")};function h(n,t){var a=[];n.forEach(function(e){-1==a.indexOf(b(e.arisingTime))&&a.push(b(e.arisingTime))});var e,i,r=[],s=[],o=[];t.enterpriseIds.forEach(function(e){s.push(l.enterprisesDic[e].name)}),s=t.nodeIds.map(function(e){return t.nodeIdToEnfoDic[e].name+"-"+t.nodeIdDic[e].label}),t.nodeIds.forEach(function(i){var e={name:t.nodeIdToEnfoDic[i].name+"-"+t.nodeIdDic[i].label,value:a.map(function(t){var e=n.find(function(e){return b(e.arisingTime)==t&&e.nodeId==i});return e||{}})};o.push(e)}),o.forEach(function(e){r.push({name:e.name,type:"line",areaStyle:{normal:{}},data:e.value.map(function(e){return e.value})})}),i={title:{text:""},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#6a7985"}}},legend:{data:(e={xAxis:a,legend:s,series:r}).legend},toolbox:{feature:{dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:[{type:"category",boundaryGap:!1,data:e.xAxis}],yAxis:[{name:"单能源消耗（单位：吨标煤）",axisLabel:{margin:30},type:"value"}],series:e.series},"tab1"==l.tab?f.setOption(i):"tab3"==l.tab&&m.setOption(i)}l.goSearch=function(a){var r=[],s={},o={},c=0,t=[];a.enterToNodesDic={};a.enterpriseIds.forEach(function(e){var i,n;t.push((i=e,n=d.defer(),p.queryDomainsByEnterpriseId(i,function(e){if(0==e.code){c++;var t=e.data.filter(function(e){return e.modelDefinitionId==a.modelId});t.forEach(function(e){r.push(e.id),s[e.id]=e,o[e.id]=l.enterprisesDic[i]}),a.enterToNodesDic[i]||(a.enterToNodesDic[i]=t),c==a.enterpriseIds.length&&(a.nodeIds=r,a.nodeIdDic=s,a.nodeIdToEnfoDic=o),n.resolve("success")}}),n.promise))}),d.all(t).then(function(){var t,e;e=["kpi",{category:"time",isRealTimeData:!1,nodeIds:(t=a).nodeIds,kpiCodes:[3300],startTime:t.startTime,endTime:t.endTime,timeRange:"",statisticType:"psiot",queryInstances:t.energyType,aggregateType:["VALENTWEIGHT"],granularityUnit:"MONTH",includeInstance:!0,condList:[],timePeriod:15552e6,dataType:1}],u.getValueList(e,function(e){0==e.code&&h(e.data,t)})})},l.filterEnter=function(e){var t=e.id.split(":")[1];p.getEnterpriseInfosByModelDefinitionId([t],function(e){0==e.code&&(e.data.forEach(function(e){e.text=e.name}),l.filterEnterprises=e.data)})},l.filterModel=function(e){0!=e.length&&p.getModelDefinitionsByEnterpriseIds(e,function(e){0==e.code&&(e.data.forEach(function(e){e.text=e.label}),l.flterDeviceList=e.data)})};var v=function(){l.allModelAry=[],l.allModelDic={},p.findEnterpriseInfos(function(e){0==e.code&&(l.enterprisesDic={},e.data.forEach(function(e){e.text=e.name,l.enterprisesDic[e.id]=e}),l.allEnterprises=e.data,e.data.length)}),p.getDeviceTypeNames("devicetype",function(e){0==e.code&&(e.data.forEach(function(e){e.text=e.label}),l.allDeviceList=e.data)}),$('#deploy a[data-toggle="tab"]').on("shown.bs.tab",function(e){if(0<$(e.target).closest("li.disabled").length)return $(e.target).closest("li.disabled").removeClass("active"),void $(e.target).closest("ul").children("[name="+l.tab+"]").addClass("active");var t=$(e.target).closest("li").attr("name");t&&(l.tab=t,l.$apply())})};s.user.isAuthenticated?v():l.$on("loginStatusChanged",function(e,t){s.user.isAuthenticated&&v()})}]),e.initController("assessmentCtrl",["$scope","$filter","$routeParams","$timeout","$q","$location","ngDialog","dictionaryService","kpiDataService","userLoginUIService","energyConsumeUIService","growl","resourceUIService",function(i,t,e,n,a,r,s,o,c,l,d,u,p){var y=require("echarts"),f=y.init(document.getElementById("radarView")),m=y.init(document.getElementById("tendencyView")),g={3304:"GDP能耗得分",3305:"工业附加值能耗得分",3301:"节能率指标得分",3351:"节能潜力指标得分"};i.industryDic={},i.queryDitem={},i.$watch("myDicts",function(e,t){e&&(i.industryList=i.myDicts.industryShortType,i.industryList.forEach(function(e){e.id=e.valueCode,e.text=e.param,i.industryDic[e.valueCode]=e,i.industryDic[e.label]=e}))});var b=function(e){return e=t("date")(e,"yyyy-MM")},h=function(e){0<jQuery(e).find(".fa.fa-plus").length&&jQuery.AdminLTE.boxWidget.collapse(jQuery(e))};i.goClear=function(){i.queryDitem.enterpriseId="",i.queryDitem.industryType="",i.queryDitem.statisticsType="",i.queryDitem.startTime="",i.queryDitem.endTime="",f.clear(),m.clear()};function v(n,e){var t,i,a,r=[],s=[],o={},c=[],l=[],d=[];for(var u in g)r.push(g[u]),s.push({id:u,name:g[u],max:100});n.forEach(function(e){o[e.arisingTime]||(o[e.arisingTime]=e.arisingTime,c.push(b(e.arisingTime)))}),s.forEach(function(i){l.push({name:i.name,type:"line",data:c.map(function(t){var e=n.find(function(e){return b(e.arisingTime)==t&&e.kpiCode==i.id});return e?e.value:"-"})})}),c.forEach(function(i){d.push({name:i,value:s.map(function(t){var e=n.find(function(e){return b(e.arisingTime)==i&&e.kpiCode==t.id});return e?e.value:"-"})})}),i={title:{text:""},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#6a7985"}}},legend:{data:(t={xAxis:c,legend:r,series:l,indicator:s,randarSeries:d}).legend},toolbox:{feature:{dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:[{type:"category",boundaryGap:!1,data:t.xAxis}],yAxis:[{type:"value"}],series:t.series},a={title:{text:""},tooltip:{},toolbox:{feature:{dataView:{show:!0,readOnly:!1},restore:{show:!0},saveAsImage:{show:!0}}},legend:{data:t.xAxis},radar:{indicator:t.indicator},series:[{name:"",type:"radar",data:t.randarSeries}]},f.setOption(a),m.setOption(i)}i.goSearch=function(e){if(e&&e.industryType)if(e&&e.enterpriseId)if(e&&e.statisticsType){if(!e||!e.startTime){var t=(new Date).getFullYear(),i=(new Date).getMonth(),n=(new Date).getMonth()+1;e.startTime=new Date(t+"-"+i),e.endTime=new Date(t+"-"+n)}var a,r;f.clear(),r=[(a=e).statisticsType,a.industryType,a.enterpriseId,a.startTime,a.endTime],d.getEnergyEvaluations(r,function(e){if(0==e.code){var t=[];e.data.forEach(function(e){t.push(e)}),v(t)}}),h("#viewrandar1"),h("#viewrandar2")}else u.info("请选择周期类型",{});else u.info("请选择企业",{});else u.info("请选择行业",{})};var I=function(){d.findEnterpriseInfos(function(e){0==e.code&&(i.enterprisesDic={},e.data.forEach(function(e){e.text=e.name,i.enterprisesDic[e.id]=e}),i.allEnterprises=e.data)}),jQuery.AdminLTE.boxWidget.collapse(jQuery("#viewrandar1")),jQuery.AdminLTE.boxWidget.collapse(jQuery("#viewrandar2"))};l.user.isAuthenticated?I():i.$on("loginStatusChanged",function(e,t){l.user.isAuthenticated&&I()})}]),e.initController("areaEnergyCtrl",["$scope","$filter","$routeParams","$timeout","Info","$q","$location","ngDialog","dictionaryService","kpiDataService","userLoginUIService","energyConsumeUIService","growl","resourceUIService",function(f,e,t,i,n,a,r,s,o,c,l,d,u,p){var y=require("echarts"),m=y.init(document.getElementById("areaEnergyview")),g=y.init(document.getElementById("areamap")),b={"合肥":[117.29,32.0581]};n.get("../localdb/hefei2.json",function(e){e.features.forEach(function(e){var t=e.properties.cp;b[e.properties.name]=[t[0],t[1]]}),y.registerMap("hefei",e)}),f.tab="tab1";var h=[{id:3320,type:"area",label:"区域综合能耗增幅"},{id:3321,type:"area",label:"区域GDP增幅"},{id:3322,type:"area",label:"区域工业附加值增幅"},{id:3323,type:"area",label:"区域GDP能耗增幅"},{id:3324,type:"area",label:"区域工业附加值能耗增幅"},{id:3315,type:"map",label:"区域综合能耗"},{id:3318,type:"map",label:"区域GDP能耗"},{id:3319,type:"map",label:"区域工业附加值能耗"}];function v(){var e=(new Date).getFullYear(),t=(new Date).getMonth();f.queryDitem={},f.queryDitem1={},f.queryDitem.year=e,f.queryDitem.month=t,f.queryDitem1.year=e,f.queryDitem1.month=t,f.yearList=[],f.monthList=[];for(var i=0;i<8;i++)f.yearList.push({id:e-i,text:e-i+"年"});for(i=1;i<13;i++)f.monthList.unshift({id:i,text:i+"月"});m.clear(),g.clear()}f.goClear=function(){v()};var I=function(e,t){c.getValueList(e,function(e){0==e.code&&t(e.data)})},D=function(n,t){var e={"区域综合能耗":"#a6c84c","区域GDP能耗":"#ffa022","区域工业附加值能耗":"#46bee9"},a=[];n.forEach(function(e){-1==a.indexOf(e.instance)&&a.push(e.instance)});var i,r,s,o=h.filter(function(e){return e.type==t}),c=[],l=[],d=[],u={},p={};for(var y in o.map(function(i){p[i.label]=[];var e=a.map(function(t){var e=n.find(function(e){return t==e.instance&&e.kpiCode==i.id});return e?(d.push({name:i.label,from:"合肥",to:e.instance,value:e.value}),e):[]}),t={name:i.label,type:"bar",areaStyle:{normal:{show:!0}},data:e.map(function(e){return e.value})};c.push(t)}),p)d.forEach(function(e){y==e.name&&p[y].push({formName:"合肥",toName:e.to,name:e.to,coords:[b["合肥"],b[e.to]],value:b[e.to].concat(e.value)})});for(var y in p)l.push({name:y,type:"lines",zlevel:1,effect:{show:!0,period:6,trailLength:.7,color:"#fff",symbolSize:3},lineStyle:{normal:{color:e[y],width:0,curveness:.2}},data:p[y]},{name:y,type:"lines",zlevel:2,symbol:["none","arrow"],symbolSize:10,effect:{show:!0,period:6,trailLength:0,symbol:"path://M1705.06,1318.313v-89.254l-319.9-221.799l0.073-208.063c0.521-84.662-26.629-121.796-63.961-121.491c-37.332-0.305-64.482,36.829-63.961,121.491l0.073,208.063l-319.9,221.799v89.254l330.343-157.288l12.238,241.308l-134.449,92.931l0.531,42.034l175.125-42.917l175.125,42.917l0.531-42.034l-134.449-92.931l12.238-241.308L1705.06,1318.313z",symbolSize:15},lineStyle:{normal:{color:e[y],width:1,opacity:.6,curveness:.2}},data:p[y]},{name:y,type:"effectScatter",coordinateSystem:"geo",zlevel:2,rippleEffect:{brushType:"stroke"},label:{normal:{show:!0,position:"right",formatter:"{b}"}},symbolSize:function(e){return 10},itemStyle:{normal:{label:{show:!0}},emphasis:{label:{show:!0}}},data:p[y]});u="area"==t?{xAxis:[{type:"value"}],yAxis:[{type:"category",axisTick:{show:!1},data:a}],legend:{data:o.map(function(e){return e.label})},series:c}:{legend:o.map(function(e){return e.label}),series:l},r={tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#6a7985"}}},toolbox:{feature:{dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["stack","tiled"]},restore:{show:!0},saveAsImage:{show:!0}}},legend:(i=u).legend,grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:i.xAxis,yAxis:i.yAxis,series:i.series},s={backgroundColor:"rgb(208, 224, 227)",title:{text:"",subtext:"",left:"center",textStyle:{color:"#000"}},tooltip:{trigger:"item"},toolbox:{feature:{dataView:{show:!0,readOnly:!1},restore:{show:!0},saveAsImage:{show:!0}}},visualMap:{min:0,max:2500,left:"left",top:"bottom",text:["高","低"],calculable:!0,inRange:{color:["lightskyblue","yellow","orangered"]}},legend:{orient:"vertical",top:"top",left:"left",data:i.legend,textStyle:{color:"#333"},selectedMode:"single"},geo:{map:"hefei",label:{emphasis:{show:!1}},roam:!0,itemStyle:{normal:{areaColor:"rgb(111, 168, 220)",borderColor:"#404a59"},emphasis:{areaColor:"rgb(7, 55, 99)"}}},series:i.series},"tab1"==f.tab?m.setOption(r):"tab2"==f.tab&&g.setOption(s)};f.goSearch=function(e){e.startTime=new Date(e.year+"-"+e.month),e.endTime=new Date(e.year+"-"+e.month+"-02");var t=["kpi",{aggregate_instance:2,aggregate_rule:0,isRealTimeData:!1,nodeIds:[l.user.domainID],startTime:e.startTime,endTime:e.endTime,timeRange:"",granularityUnit:"MONTH",aggregateType:["VALENTWEIGHT"],statisticType:"psiot",includeInstance:!0,condList:[],timePeriod:15552e6,dataType:1}];if("tab1"==f.tab){t[1].category="time";var i=h.filter(function(e){return"area"==e.type});t[1].kpiCodes=i.map(function(e){return e.id}),I(t,function(e){D(e,"area")})}else if("tab2"==f.tab){t[1].category="ci";i=h.filter(function(e){return"map"==e.type});t[1].kpiCodes=i.map(function(e){return e.id}),I(t,function(e){D(e,"map")})}};var T=function(){v(),$('#deploy a[data-toggle="tab"]').on("shown.bs.tab",function(e){if(0<$(e.target).closest("li.disabled").length)return $(e.target).closest("li.disabled").removeClass("active"),void $(e.target).closest("ul").children("[name="+f.tab+"]").addClass("active");var t=$(e.target).closest("li").attr("name");t&&(f.tab=t,f.$apply())})};l.user.isAuthenticated?T():f.$on("loginStatusChanged",function(e,t){l.user.isAuthenticated&&T()})}])});
//# sourceMappingURL=../../../map/app-oc/js/controllers/enterprise-ctrl.js.map
