define(["controllers/controllers","bootstrap-dialog","bootstrap-multiselect"],function(e,I,s){"use strict";e.initController("WorkOrderProcedureCtrl",["$scope","$location","$routeParams","$timeout","viewFlexService","kpiDataService","resourceUIService","growl","userLoginUIService","processService","userEnterpriseService","Info","$route",function(a,e,s,t,r,o,n,i,l,u,d,c,f){a.isEditing=!1,a.procedureData=[],a.taskConfs=[];c.get("localdb/procedure.json",function(e){a.procedureStep=e.procedureStep,a.workOrderType=a.myDicts.ticketCategory,e.procedureStepBk,a.procedureModel=e.procedureStep});function p(){d.queryEnterpriseUser(function(e){0==e.code&&(0!=e.data.length?a.userData=e.data:a.userData=[])})}function v(){d.queryEnterpriseGroup(function(e){0==e.code&&(0!=e.data.length?a.groupData=e.data:a.groupData=[])})}function g(){d.querySupplier(function(e){0==e.code&&(0!=e.data.length?a.providerData=e.data:a.providerData=[])})}function C(){u.getProcessDefinitions(function(e){0==e.code&&(0!=e.length?a.procedureData=e.data:a.procedureData=[],a.$broadcast(Event.WORKORDERTYPEINIT,a.procedureData))})}a.initProcedureStep=function(){a.procedureModel=[{id:4011,dictCode:"systemProcessTemplate",valueCode:"oneStep",label:"一步工单",name:"流程任务1",param:1},{id:4012,dictCode:"systemProcessTemplate",valueCode:"twoStep",label:"二步工单",name:"流程任务2",param:2},{id:4013,dictCode:"systemProcessTemplate",valueCode:"threeStep",label:"三步工单",name:"流程任务3",param:3},{id:4014,dictCode:"systemProcessTemplate",valueCode:"fourStep",label:"四步工单",name:"流程任务4",param:4},{id:4015,dictCode:"systemProcessTemplate",valueCode:"fiveStep",label:"五步工单",name:"流程任务5",param:5}]},a.stepNumber=[{name:"a",value:1},{name:"b",value:null},{name:"c",value:null},{name:"d",value:null},{name:"e",value:null}],a.initStepData=function(e){for(var s=0;s<e;s++)a.stepNumber[s].value=s+1},a.procedureItem={label:"",category:"",desc:"",id:"",domainPath:"",processTemplateKey:""},a.taskConfsObj={name:"",userType:"user",providerId:null,userIds:null,userGroupIds:null,sendEmail:!0,sendSms:!0,sendPsMessage:!1},a.operation={prev:null,now:0},a.selectAll2Right=function(){var e,s=a.taskConfsObj;if("user"==s.userType){var t=[];if(a.userData!=[])for(var r in a.userData)t.push(String(a.userData[r].userID));s.userIds=t,a.taskConfsObj.userIds=t,e=s.userIds.length}else if("group"==s.userType){t=[];if(a.groupData!=[])for(var r in a.groupData)t.push(String(a.groupData[r].groupID));s.userGroupIds=t,a.taskConfsObj.userGroupIds=t,e=s.userGroupIds.length}else if("provider"==s.userType){var o;a.providerData!=[]&&(o=a.providerData),a.taskConfsObj.providerId=o,e=s.providerId.length}0<=e&&$(".my-select-"+a.taskConfsObj.userType).multiSelect("select_all")},a.selectAll2Left=function(){$(".my-select-"+a.taskConfsObj.userType).multiSelect("deselect_all")},a.addProcedure=function(){if(0==a.isEditing){a.isEditing=!0,a.operation.prev=0,a.operation.now=0,a.taskConfs=[],a.initProcedureStep(),a.currentEditIndex=1,a.stepNumber=[{name:"a",value:1},{name:"b",value:null},{name:"c",value:null},{name:"d",value:null},{name:"e",value:null}],a.procedureItem={label:"",category:"",desc:""},a.taskConfsObj={name:"",userType:"user",providerId:null,userIds:null,userGroupIds:null,sendEmail:!0,sendSms:!0,sendPsMessage:!1};a.procedureData.unshift({id:"",label:"",domainPath:"",category:"",processTemplateKey:"",desc:"",taskConfs:[],isEditing:!0,isEdit:1}),a.$broadcast(Event.WORKORDERTYPEINIT,a.procedureData)}else i.warning("当前有正在编辑的工单流程",{})},a.initDefaultSelect=function(){return $(".my-select-user").multiSelect("deselect_all"),$(".my-select-group").multiSelect("deselect_all"),$(".my-select-provider").multiSelect("deselect_all"),!1},a.addStep=function(){var e=[];if("user"==a.taskConfsObj.userType?e=a.taskConfsObj.userIds:"group"==a.taskConfsObj.userType?e=a.taskConfsObj.userGroupIds:"provider"==a.taskConfsObj.userType&&(e=a.taskConfsObj.providerId),null!=e&&0!=e.length)if(5!=a.stepNumber[4].value){for(var s in a.stepNumber)if(null==a.stepNumber[s].value)return a.stepNumber[s].value=parseInt(s)+1,a.currentEditIndex=parseInt(s),a.saveTaskConfs(a.currentEditIndex),a.taskConfsObj.userIds=[],a.initDefaultSelect(),$(".nav-tabs-custom>ul li").removeClass("active"),void $(".nav-tabs-custom>ul li").eq(a.currentEditIndex-1).addClass("active")}else i.warning("最多只能添加5个工单流程任务",{});else i.warning("请选择任务处理人",{})},a.deleteStep=function(){for(var e in a.stepNumber)if(4-e==0)i.warning("至少要有一个流程任务",{});else if(a.initDefaultSelect(),null!=a.stepNumber[4-e].value){a.stepNumber[4-e].value=null,$(".nav-tabs-custom>ul li").removeClass("active"),$(".nav-tabs-custom>ul li").eq(a.currentEditIndex).addClass("active");var s=a.taskConfs;for(var e in s.splice(a.currentEditIndex-1,1),a.taskConfs=s)a.procedureModel[e].name=s[e].name;return a.operation.now=a.taskConfs.length-1,a.taskConfsObj=a.taskConfs[a.operation.now],a.currentEditIndex=a.operation.now+1,$(".nav-tabs-custom ul li").removeClass("active"),$(".nav-tabs-custom ul li").eq(a.operation.now).addClass("active"),void("user"==a.taskConfsObj.userType&&a.taskConfsObj.userIds?a.initSelectUser(a.taskConfsObj.userIds):"group"==a.taskConfsObj.userType&&a.taskConfsObj.userGroupIds&&a.initSelectGroup(a.taskConfsObj.userGroupIds))}},a.currentEditIndex=1,a.operation.prev=0,a.operation.now=0,a.saveTaskConfs=function(e){a.operation.prev=a.operation.now,a.operation.now=e;var s=a.taskConfs,t=a.taskConfsObj;if(t.name=a.procedureModel[a.operation.prev].name,s[a.operation.prev]=t,a.taskConfs=s,a.taskConfs[e]){if(a.taskConfsObj=a.taskConfs[e],a.userType=a.taskConfsObj.userType,"user"==a.taskConfsObj.userType){var r=[];for(var o in a.taskConfsObj.userIds)"string"!=typeof a.taskConfsObj.userIds[o]?r[o]=a.taskConfsObj.userIds[o].toString():r[o]=a.taskConfsObj.userIds[o];a.initDefaultSelect(),a.initSelectUser(r)}else if("group"==a.taskConfsObj.userType){r=[];for(var o in a.taskConfsObj.userGroupIds)"string"!=typeof a.taskConfsObj.userGroupIds[o]?r[o]=a.taskConfsObj.userGroupIds[o].toString():r[o]=a.taskConfsObj.userGroupIds[o];a.initDefaultSelect(),a.initSelectGroup(r)}else if("provider"==a.taskConfsObj.userType){r=a.taskConfsObj.providerId.toString();a.initSelectProvider(r)}}else a.taskConfsObj={name:"",userType:"user",providerId:null,userIds:null,userGroupIds:null,sendEmail:!0,sendSms:!0,sendPsMessage:!1};a.currentEditIndex=e+1},a.saveProcedure=function(){var e=a.taskConfsObj.userIds,s=a.taskConfsObj.userGroupIds;a.taskConfsObj.providerId;if(""!=a.procedureItem.label&&null!=a.procedureItem.label&&null!=a.procedureItem.label)if(null!=a.procedureItem.category&&""!=a.procedureItem.category){if("user"==a.taskConfsObj.userType){if(null==e||0==e.length)return void i.warning("请选择任务处理人",{})}else if("group"==a.taskConfsObj.userType&&(null==s||0==s.length))return void i.warning("请选择任务处理人",{});if(""!=a.procedureModel[a.operation.now].name&&null!=a.procedureModel[a.operation.now].name){a.saveTaskConfs(a.operation.now),a.taskConfs.name=a.procedureItem.label;var t=a.taskConfs,r=a.procedureItem;for(var o in r.taskConfs=t,r.taskConfs)r.taskConfs[o]||delete r.taskConfs[o];u.saveProcessDefinition(r,function(e){0==e.code&&(r.id?i.success("修改工单流程成功",{}):i.success("新建工单流程成功",{}),a.isEditing=!1,C(),a.taskConfs=[],a.operation.prev=0,a.operation.now=0)})}else i.warning("请填写流程任务名称",{})}else i.warning("请选择工单类型",{});else i.warning("请填写流程名称",{})},a.doAction=function(e,t){if("save"==e);else{if("editError"==e)return void i.warning(t,{});"delete"==e?(1==a.isEditing&&a.isEditing,I.show({title:"提示",closable:!1,message:"确认删除工单流程 "+t.label+" 吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){var s=t.id;u.deleteProcessDefinitionById(s,function(e){0==e.code&&(C(),a.initProcedureStep(),a.isEditing=!1,a.procedureModel=void 0,i.success("删除工单流程成功",{}))}),e.close()}},{label:"取消",action:function(e){e.close()}}]})):"cancel"==e&&(a.isEditing=!1,C(),i.success(t,{}),a.operation.prev=0,a.operation.now=0,a.isEditing=!1)}},$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){a.activeTab=$(e.target).text(),$(e.relatedTarget).text()}),l.user.isAuthenticated?(g(),v(),p(),C()):a.$on("loginStatusChanged",function(e,s){l.user.isAuthenticated&&(g(),v(),p(),C())})}]),e.initController("workFlowCtrl",["$scope","$q","ticketCategoryService","$location","workflowService","$timeout","userRoleUIService","kpiDataService","resourceUIService","growl","userLoginUIService","processService","userEnterpriseService","Info","$route","commonMethodService",function(a,e,n,s,t,r,o,i,l,u,d,c,f,p,v,g){a.workOrderType="",a.flows="";var C=Math.uuid(),m=new g;a.flowList={workflowId:"",category:"",userSelect:"",roleSelect:"",expressionSelect:"",userType:"",taskId:"",assignedUser:"",roleUser:[],allUser:{},groupUser:{},taskArry:{}},a.handerConfsData={};for(var b=[],k=0;k<1;k++)b.push(e.defer());a.configureFlow=[],a.flowListDic={};a.roleIdUser=function(){var e={roleID:a.handerConfsData[a.flowList.taskId].roleIds};o.getAssociateRole2User(e,function(e){0==e.code&&(e.data.forEach(function(e){for(var s=m.getdomainNameHandler(e.domains,[]),t="",r=0;r<s.length;r++)t+=s[r]+"/";e.customName=t}),a.flowList.roleUser=e.data)})},a.allUser=function(){f.queryEnterpriseUser(function(e){if(0==e.code)for(var s in e.data)a.flowList.allUser[e.data[s].userID]=e.data[s]})},a.flowList.allRoles={},a.allRole=function(){f.queryEnterpriseRole(function(e){if(0==e.code)for(var s in e.data)a.flowList.allRoles[e.data[s].roleID]=e.data[s]})},a.allGroupUser=function(){var e=a.handerConfsData[a.flowList.taskId].userGroupIds;f.queryGroupUser(e,function(e){0==e.code&&(a.flowList.groupUser=e.data)})},a.addViews=function(){var e={id:C,workflowId:"",name:"",desc:"",category:"",createTime:new Date,isEdit:3};for(var s in a.flowList.category="",a.flowList.workflowId="",a.configureFlow)if(null==a.configureFlow[s].id||1<a.configureFlow[s].isEdit)return void u.warning("当前有未保存的数据，请先保存",{});a.configureFlow.push(e),a.$broadcast("WORKFLOW",a.configureFlow)},a.doAction=function(e,t,r){"attr-delete"==e?I.show({title:"提示",closable:!1,message:"确认删除流程关联吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){n.deleteTicketCategoryById([t.id],function(e){if(0==e.code){for(var s=0;s<a.configureFlow.length;s++)if(a.configureFlow[s].id==t.id){a.configureFlow.splice(s,1);break}r&&r(!0),u.success("流程关联删除成功",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]}):"view-save"==e?function(t,e){var s=[],r=a.handerConfsData;for(var o in r)s.push(r[o]);t.handerConfs=s,3==t.isEdit&&(t.id=0),n.saveTicketCategory(t,function(e){if(0==e.code){if(3==t.isEdit){for(var s in a.configureFlow)if(3==a.configureFlow[s].isEdit){a.configureFlow[s].isEdit=0,a.configureFlow[s]=e.data;break}}else for(s=a.configureFlow.length-1;-1<s;s--)a.configureFlow[s].id==e.data.id&&(a.configureFlow[s]=e.data);a.$broadcast("WORKFLOW",a.configureFlow),0<t.id?u.success("编辑成功"):u.success("添加成功")}})}(t):"cancel"==e&&n.getTicketCategorys(function(e){0==e.code&&(a.configureFlow=e.data,a.$broadcast("WORKFLOW",a.configureFlow))})},a.tabStatus=function(e,s){if(s)if(a.handerConfsData=s,"role"==e)a.$broadcast("handerConfsData",s[a.flowList.taskId]);else if("user"==e){var t=a.handerConfsData[a.flowList.taskId].userIds;a.flowList.assignedUser=a.flowList.allUser[t].userName}else if("group"==e)a.allGroupUser();else if("expression"==e){var r=a.handerConfsData[a.flowList.taskId].userExpressionOfCategory;""!=r&&null!=r||(a.handerConfsData[a.flowList.taskId].userExpressionOfCategory=a.handerConfsData[a.flowList.taskId].userExpression)}},a.initEvent=function(){$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){var s=$(e.target).attr("userType"),t=$(e.target).attr("taskId");a.flowList.userType=s,a.flowList.taskId=t,a.tabStatus(s,a.handerConfsData),a.$apply()})};var w=[];for(var k in b)w.push(b[k].promise);e.all(w).then(function(e){n.getTicketCategorys(function(e){0==e.code&&(a.configureFlow=e.data,a.$broadcast("WORKFLOW",a.configureFlow))}),a.allUser(),a.allRole()}),t.getWorkflows(function(e){if(0==e.code){if(e.data&&null!=e.data)for(var s in e.data)a.flowListDic[e.data[s].id]=e.data[s];a.flows=e.data,b[0].resolve("success")}}),p.get("localdb/procedure.json",function(e){a.workOrderType=a.myDicts.ticketCategory})}])});
//# sourceMappingURL=../../../map/app-oc/js/controllers/workorder-procedure-copy-ctrl.js.map
