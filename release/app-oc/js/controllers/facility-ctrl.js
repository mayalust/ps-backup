define(["controllers/controllers","bootstrap-dialog"],function(controllers,BootstrapDialog){"use strict";controllers.initController("FacilityCtrl",["$scope","$q","FileUploader","$controller","$routeParams","growl","userUIService","userEnterpriseService","kpiDataService","resourceUIService","Info","viewFlexService","userDomainService","userLoginUIService","customerUIService","projectUIService","ngDialog","deviceAccessUIService","SwSocket",function($scope,q,FileUploader,$controller,$routeParams,growl,userUIService,userEnterpriseService,kpiDataService,resourceUIService,Info,viewFlexService,userDomainService,userLoginUIService,customerUIService,projectUIService,ngDialog,deviceAccessUIService,SwSocket){$scope.serviceOrigin=userUIService.uploadFileUrl+"/api/rest/import/resourceUIService/importPhysicalConfig",$scope.fileFormat="xls、xlsx",$scope.fileMaxSize=10,$controller("AppUploadCtrl",{$scope:$scope,growl:growl,FileUploader:FileUploader}),$scope.uploadExcel=function(e){$scope.uploader.formData.push({resourceId:$scope.selectDevice.id,config:"physicalConfig"}),$scope.uploader.uploadAll()},$scope.$on("uploadTemplate",function(e,o){0==o.response.code&&growl.success("解析协议导入成功",{})}),$scope.uploader.onAfterAddingFile=function(e){$scope.uploader.queue.length>$scope.queueLimit&&$scope.uploader.removeFromQueue(0),$scope.uploadExcel()},$scope.routePathNodes={};var type=$routeParams.type,gatewayId=$routeParams.gatewayid,uuid;$scope.selLength=10,$scope.queryDitem={domainPath:"",sn:"",customerId:"",projectId:"",modelId:""},$scope.docError={name:"",conter:""},$scope.selectDevice,$scope.gatewayPhysical={},$scope.queryAttrList=[],$scope.queryAttrObj={},$scope.queryKeyValue=[],$scope.selQueryAttr={attr:""},$scope.seniorQuery=!1,$scope.userGridData={list:"",arrData:{},enterpriseDomain:{}},$scope.downClick=function(e){var o=userUIService.uploadFileUrl+e;window.open(o)},$scope.facilityList={},$scope.modelListSelect,$scope.access={status:"0",allGateways:"",accessMode:"",accessGwId:"",accessProtocol:"",allDevices:"",accessConfig:""};var info=Info.get("../localdb/icon.json",function(e){$scope.iconList=e.qualityIcon,$scope.kpiIconList=e.kpiIcon});$scope.$watch("access.accessGwId",function(e,o){$scope.access.accessProtocol=""!=e?e.protocol:""}),$scope.UploadFile=function(){var e=$scope.selectDevice.deviceDocData;for(var o in e)if(e[o].name==$scope.uploadParam.name)return $scope.docError.name="name",void($scope.docError.conter="文档名称已存在");$scope.formObj={deviceId:$scope.selectDevice.id,name:encodeURIComponent($scope.uploadParam.name),description:encodeURIComponent($scope.uploadParam.description)},$scope.$broadcast("UploadFile1")},$scope.successDoc=function(e){var o=escape(decodeURIComponent(e.name));if(e.name=o,e.description=escape(decodeURIComponent(e.description)),$scope.selectDevice.deviceDocData&&null!=$scope.selectDevice.deviceDocData)$scope.selectDevice.deviceDocData.push(e);else{var c=[];c.push(e),$scope.selectDevice.deviceDocData=c}};var domainTreeQuery=function(){var e=function(e){if(0==e.code){var o=e.data;$scope.domainListTree=o,$scope.domainListDic=e.domainListDic,defers[1].resolve("success")}};$scope.baseConfig&&$scope.baseConfig.extendDomain?resourceUIService.getExtendDomainsByFilter({},e):userDomainService.queryDomainTree(userLoginUIService.user.userID,e)};$scope.modelList=function(r){resourceUIService.getModels(function(e){if(0==e.code){$scope.modelListSelect=e.data,resourceUIService.rootModelDic={};var o=e.data;for(var c in o){var s=o[c];s.text=s.label,$scope.routePathNodes[s.parentModelId]||($scope.routePathNodes[s.parentModelId]=[]),$scope.routePathNodes[s.parentModelId].push(s),$scope.routePathNodes[s.id]||($scope.routePathNodes[s.id]=[]);var a=jQuery.extend(!0,{},s);resourceUIService.rootModelDic[a.id]=a}var t=function e(o){for(var c in $scope.routePathNodes)if(c==o.id){for(var s in o.nodes=$scope.routePathNodes[c],o.nodes)e(o.nodes[s]);0==o.nodes.length&&(o.nodes=null)}};for(var i in t(resourceUIService.rootModel),$scope.routePathNodes)if(i!=resourceUIService.rootModel.id&&!resourceUIService.rootModelDic[i])for(var c in $scope.routePathNodes[i])t($scope.routePathNodes[i][c]),resourceUIService.rootModel.nodes||(resourceUIService.rootModel.nodes=[]),resourceUIService.rootModel.nodes.push($scope.routePathNodes[i][c]);resourceUIService.rootModelDic[resourceUIService.rootModel.id]=resourceUIService.rootModel,$scope.rootModel=resourceUIService.rootModel,$scope.rootModelDic=resourceUIService.rootModelDic,r?growl.success("操作成功！"):defers[2].resolve("success")}})};var saveCheck=function(o){if($scope.baseConfig&&$scope.baseConfig.projectConfig&&($scope.baseConfig.projectConfig.check||$scope.baseConfig.projectConfig.devCheck)&&(!jQuery.trim(o.projectId)||0==o.projectId))return growl.warning($scope.menuitems.S13&&$scope.menuitems.S13.label?$scope.menuitems.S13.label:"项目名称不能为空",{}),!1;if(!jQuery.trim(o.gatewayId))return growl.warning("所属网关不能为空",{}),!1;if(!jQuery.trim(o.modelId))return growl.warning("设备模板不能为空",{}),!1;if(!jQuery.trim(o.sn))return growl.warning("序列号不能为空",{}),!1;if(!jQuery.trim(o.label))return growl.warning("设备名称不能为空",{}),!1;var e=$scope.gatewayPhysical[o.gatewayId].protocol;if("single"==$scope.selectDevice.accessMode&&"flexem"==e){if(!jQuery.trim(o.physicalConfig.analysisConfigs.connectPointId))return growl.warning("网关连接点不能为空",{}),!1;if(!jQuery.trim(o.physicalConfig.stationNo))return growl.warning("站号不能为空",{}),!1}else if("modbus"==e){if(!jQuery.trim(o.physicalConfig.analysisProtocol))return growl.warning("解析协议不能为空",{}),!1;if(!jQuery.trim(o.externalDevId))return growl.warning("设备地址不能为空",{}),!1;if(!jQuery.trim(o.physicalConfig.stationNo))return growl.warning("站号不能为空",{}),!1;if(!jQuery.trim(o.physicalConfig.analysisConfigs.byteOrder16))return growl.warning("16字节序不能为空",{}),!1;if(!jQuery.trim(o.physicalConfig.analysisConfigs.byteOrder32))return growl.warning("32字节序不能为空",{}),!1;if(!jQuery.trim(o.physicalConfig.analysisConfigs.floatbyteOrder))return growl.warning("浮点字节序不能为空",{}),!1}else if("baogang"==e){if(!jQuery.trim(o.physicalConfig.analysisProtocol))return growl.warning("解析协议不能为空",{}),!1}else if("multiple"!=$scope.selectDevice.accessMode&&!jQuery.trim(o.externalDevId))return growl.warning("设备地址不能为空",{}),!1;return o.values||(o.values={}),$scope.attrType.forEach(function(e){e.arr.forEach(function(e){!o.values[e.name]&&e.sourceValue&&("numberic"==e.dataType?o.values[e.name]=Number(e.sourceValue):"string"==e.dataType&&(o.values[e.name]=e.sourceValue))})}),!0};$scope.saveResource=function(o){saveCheck($scope.selectDevice)&&($scope.selectDevice.isLoading=!0,"multiple"==$scope.selectDevice.accessMode&&($scope.selectDevice.physicalConfig.analysisConfigs.connectPointId="",$scope.selectDevice.physicalConfig.stationNo=0,$scope.selectDevice.physicalConfig.analysisProtocol="",$scope.selectDevice.externalDevId=0),$scope.baseConfig&&$scope.baseConfig.projectConfig&&$scope.baseConfig.projectConfig.devEnabled&&($scope.selectDevice.domains=-1<$scope.selectDevice.gateInfo.domains.search($scope.selectDevice.projectId)?$scope.selectDevice.gateInfo.domains:$scope.selectDevice.gateInfo.domains+$scope.selectDevice.projectId+"/"),$scope.selectDevice.domains=$scope.selectDevice.extendDomains?$scope.selectDevice.extendDomains:$scope.selectDevice.domains,getAddressPoint($scope.selectDevice,function(){0==$scope.selectDevice.id?resourceUIService.addResource($scope.selectDevice,function(e){$scope.selectDevice.isLoading=!1,0==e.code&&($scope.selectDevice.id=e.data.id,$scope.selectDevice.domains=e.data.domains,$scope.selectDevice.managedStatus=e.data.managedStatus,$scope.selectDevice.values=e.data.values,o?o():growl.success("保存成功",{}))}):resourceUIService.updateDevice($scope.selectDevice,function(e){$scope.selectDevice.isLoading=!1,0==e.code&&($scope.selectDevice.managedStatus=e.data.managedStatus,$scope.selectDevice.values=e.data.values,o?o():growl.success("保存成功",{}))})}))},$scope.attrDist={},$scope.dictInit=function(attr){if(!$scope.attrDist[attr.name])try{var str=attr.sourceValue,str1=eval("("+str+")");$scope.attrDist[attr.name]=str1}catch(e){$scope.attrDist[attr.name]=str1}},$scope.doAction=function(e,c,o){if("save"==e)(c.isEdit=0)==c.id?resourceUIService.addResource(c,function(e){if(0==e.code){for(var o in growl.success("保存成功",{}),$scope.facilityList.data)0==$scope.facilityList.data[o].id&&($scope.facilityList.data[o]=e.data);$scope.$broadcast(Event.CMDBINFOSINIT+"_facility",$scope.facilityList)}}):0<c.id&&resourceUIService.updateDevice(c,function(e){if(0==e.code){for(var o in growl.success("保存成功",{}),$scope.facilityList.data)$scope.facilityList.data[o].id==e.data.id&&($scope.facilityList.data[o]=e.data);$scope.$broadcast(Event.CMDBINFOSINIT+"_facility",$scope.facilityList)}});else if("delete"==e)BootstrapDialog.show({title:"提示",closable:!1,message:"是否要删除设备:"+escape(c.label),buttons:[{label:"确定",cssClass:"btn-success",action:function(e){resourceUIService.deleteResource(c.id,function(e){if(0==e.code){for(var o in growl.success("删除设备成功",{}),$scope.facilityList.data)$scope.facilityList.data[o].id==c.id&&$scope.facilityList.data.splice(o,1);$scope.$broadcast(Event.CMDBINFOSINIT+"_facility",$scope.facilityList)}}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("cancelFacility"==e){for(var s in $scope.facilityList.data)3==$scope.facilityList.data[s].isEdit?$scope.facilityList.data.splice(s,1):2==$scope.facilityList.data[s].isEdit&&$scope.facilityList.data[s].id==c.id&&(c.isEdit=0,$scope.facilityList.data[s]=c);$scope.$broadcast(Event.CMDBINFOSINIT+"_facility",$scope.facilityList)}else"export"==e&&(location.href=userUIService.uploadFileUrl+"/api/rest/download/resourceUIService/exportKpiDataTemplate/data.txt/"+c.id+"/")},$scope.goBack=function(){1==$scope.seniorQuery?($scope.seniorQuery=!1,$scope.queryKeyValue=[],$scope.queryModelChange()):$scope.seniorQuery=!0};var allAttrs=function(){resourceUIService.getAllAttrs(function(e){if(0==e.code){for(var o=e.data,c=[],s=0;s<o.length;s++){var a=o[s];if("1"!=a.values.sensitive||$scope.menuitems.A08_S02){var t=-1;if(a.label){for(var i in c)a.label==c[i].label&&(t=i);-1==t&&null==$scope.queryAttrObj[a.uid]&&(a.value="",a.endTime="",a.startdate="",a.endNumberic="",a.startNumberic="",c.push(a),$scope.queryAttrObj[a.uid]=a)}}}$scope.queryAttrList=c}})};$scope.queryModelChange=function(){if(resourceUIService.rootModelsDic[$scope.queryDitem.modelId]){var o=[];resourceUIService.rootModelsDic[$scope.queryDitem.modelId].attrs.forEach(function(e){("1"!=e.values.sensitive||$scope.menuitems.A08_S02)&&o.push(jQuery.extend(!1,{},e))}),$scope.queryAttrList=o}else{var e=[];for(var c in $scope.queryAttrObj)e.push($scope.queryAttrObj[c]);$scope.queryAttrList=e}$scope.queryKeyValue=[]},$scope.attrChang=function(){var e=$scope.baseConfig.attrSearchCount?$scope.baseConfig.attrSearchCount:6;if($scope.queryKeyValue.length<e){for(var o in $scope.queryAttrList)if($scope.queryAttrList[o].uid==$scope.selQueryAttr.attr){$scope.queryKeyValue.push($scope.queryAttrList[o]),$scope.queryAttrList.splice(o,1);break}}else $scope.queryKeyValue.length>=e&&(growl.warning("最多只能选择"+e+"个属性",{}),$scope.selQueryAttr.attr="")},$scope.removeAttr=function(e){for(var o in $scope.queryKeyValue)if($scope.queryKeyValue[o].id==e){$scope.queryAttrList.push($scope.queryKeyValue[o]),$scope.queryKeyValue[o].endTime="",$scope.queryKeyValue[o].value="",$scope.queryKeyValue[o].startdate="",$scope.queryKeyValue[o].endNumberic="",$scope.queryKeyValue[o].startNumberic="",$scope.queryKeyValue.splice(o,1);break}},$scope.devicesChange=function(o,e,c,s){var a,t=function(){$scope.rootModelDic[a.modelId].kpisfinish?c.sourceModelId=a.modelId:resourceUIService.getKpisByModelId(a.modelId,function(e){0==e.code&&($scope.rootModelDic[a.modelId].kpisfinish=!0,$scope.rootModelDic[a.modelId].kpis=e.data,c.sourceModelId=a.modelId)})};if(o&&e&&e.forEach(function(e){if(o==e.id)return a=e,!1}),a)t();else{if(!o)return;resourceUIService.getPhysicalDeviceById(o,function(e){0==e.code&&(a=e.data,t())})}};var getDevices=function(o){resourceUIService.getPhysicalDevicesByGatewayId(o.id,function(e){0==e.code&&(e.data.forEach(function(e){e.text=e.label}),o.devices=e.data)})};$scope.physical=function(o,e,c){$scope.gatewayPhysical[o]?$scope.gatewayPhysical[o].devices||getDevices($scope.gatewayPhysical[o]):o&&resourceUIService.getPhysicalDevicesByGatewayId(o,function(e){0==e.code&&($scope.gatewayPhysical[o]=e.data,getDevices($scope.gatewayPhysical[o]))}),c&&(e.physicalDeviceId="",e.sourceId="")},$scope.optionStatus={search:"",deploy:"",selectDevice:""},$scope.attrTypeList=[],$scope.modelIdAttrs=function(){$scope.selectDevice.modelId&&resourceUIService.getAttrsByModelId($scope.selectDevice.modelId,function(e){if(0==e.code){$scope.attrTypeList=e.data;var o=e.data,c=[],s=[];for(var a in $scope.selectDevice.values||($scope.selectDevice.values={}),o){var t=o[a],i={name:"",id:"",arr:[]},r=-1;if("default"==t.attrType&&0<s.length)r=a,s[0].arr.push(t);else for(var n in c)if(c[n].name==t.attrType){c[r=n].arr.push(t);break}if(-1==r&&(i.name=t.attrType,i.id=t.id,i.arr.push(t),"default"==t.attrType?(i.attrTypeSort=0,s.push(i)):(i.attrTypeSort=t.attrTypeSort,c.push(i))),!$scope.selectDevice.values[o[a].name]&&o[a].sourceValue)if("standardAddress"==o[a].dataType){var l=o[a].sourceValue.split(",");$scope.selectDevice.values[o[a].name]=o[a].sourceValue,l[0]&&null!=l[0]&&($scope.selectDevice.values[o[a].name+"province"]=l[0]),l[1]&&null!=l[1]&&($scope.selectDevice.values[o[a].name+"city"]=l[0]+","+l[1]),l[2]&&null!=l[2]&&($scope.selectDevice.values[o[a].name+"district"]=l[0]+","+l[1]+","+l[2])}else"dict"!=o[a].dataType&&($scope.selectDevice.values[o[a].name]=o[a].sourceValue)}$scope.selectDevice.attrType=s.concat(c),$scope.selectDevice.attrType.sort(doubleCompare(["attrTypeSort",""],"")),$scope.attrType=$scope.selectDevice.attrType}})},$scope.modelType=[],$scope.modelTypeObj={},$scope.getAllModelType=function(){resourceUIService.getAllModelType(function(e){if(0==e.code)for(var o in $scope.modelType=e.data,e.data)$scope.modelTypeObj[""+e.data[o].valueCode]=e.data[o]})};var modelKpi=function(){$scope.selectDevice.modelId&&resourceUIService.getDataItemsByModelId($scope.selectDevice.modelId,function(e){0==e.code&&($scope.selectDevice.kpi=e.data)})},modelConfig=function(){$scope.selectDevice.modelId&&resourceUIService.getModelConfigByModelId($scope.selectDevice.modelId,function(e){0==e.code&&($scope.selectDevice.config=e.data)})},taskInit=function(){$scope.selectDevice.modelId&&resourceUIService.findCollectionTaskDefinitionByModelId($scope.selectDevice.modelId,function(e){0==e.code&&($scope.selectDevice.taskData=e.data,$scope.selectDevice.physicalConfig.taskConfigs&&$scope.selectDevice.physicalConfig.taskConfigs.forEach(function(o){$scope.selectDevice.taskData.forEach(function(e){e.taskCode==o.taskCode&&(e.cycleUnit=o.cycleUnit,e.taskCycle=o.taskCycle)})}))})},docInit=function(){$scope.selectDevice.modelId&&resourceUIService.getUploadModelFileList($scope.selectDevice.modelId,function(e){if(0==e.code){var o=[];if(0<e.data.length)for(var c in e.data){var s=escape(decodeURIComponent(e.data[c].name)),a=escape(decodeURIComponent(e.data[c].description));e.data[c].name=s,e.data[c].description=a,o.push(e.data[c])}$scope.selectDevice.docData=o}})};$scope.addDoc=function(){$scope.docUrl="api/rest/upload/resourceUIService/uploadDeviceFile",$scope.uploadParam={modelId:"",name:"",type:"",url:"",description:"",postfix:"",size:""},ngDialog.open({template:"../partials/dialogue/add_doc.html",scope:$scope,controller:"addDocCtrl",className:"ngdialog-theme-plain"})};var deviceDocInit=function(){$scope.selectDevice.id&&resourceUIService.getUploadDeviceFileList($scope.selectDevice.id,function(e){if(0==e.code){var o=[];if(0<e.data.length)for(var c in e.data){var s=escape(decodeURIComponent(e.data[c].name)),a=escape(decodeURIComponent(e.data[c].description));e.data[c].name=s,e.data[c].description=a,o.push(e.data[c])}$scope.selectDevice.deviceDocData=o}})},getExtendDomains=function(e){if($scope.baseConfig&&$scope.baseConfig.extendDomain&&(1==$scope.baseConfig.extendDomain||"true"==$scope.baseConfig.extendDomain)){var o={domains:e};resourceUIService.getExtendDomainsByFilter(o,function(e){0==e.code&&($scope.subDomainListTree=e.domainListTree,$scope.subDomainListDic=e.domainListDic)})}},getAllCollectionPlugins=function(){$scope.protocols=[],resourceUIService.getAllCollectionPlugins(function(e){var o={};0==e.code&&(e.data.forEach(function(e){o[e.protocol]||(o[e.protocol]=e,$scope.protocols.push(e))}),$scope.protocolVersions=e.data)})},getAllResolutionProtocols=function(){resourceUIService.getAllResolutionProtocol("",function(e){0==e.code&&($scope.resolutionProtocolDic={},e.data.forEach(function(e){$scope.resolutionProtocolDic[e.label]=e}),$scope.resolutionProtocols=e.data)})};$scope.connectPointsInit=function(e){var o=$scope.gatewayPhysical[$scope.selectDevice.gatewayId];"flexem"==o.protocol&&($scope.connectPointsDic={},e?(growl.info("网关连接点刷新请求中，请稍后...",{}),$scope.selectDevice.isLoading=!0,resourceUIService.loadConnectionPoint(o.externalGwId,function(e){$scope.selectDevice.isLoading=!1,0==e.code?(e.data.forEach(function(e){$scope.connectPointsDic[e.id]=e}),$scope.connectPoints=e.data,growl.success("刷新成功",{})):growl.error("刷新失败，请再试！",{})})):resourceUIService.getConnectionPoint(o.externalGwId,function(e){0==e.code&&(e.data.forEach(function(e){$scope.connectPointsDic[e.id]=e}),$scope.connectPoints=e.data)}))},$scope.accessMode=function(){"multiple"==$scope.selectDevice.accessMode&&$scope.showProtocol()};var deviceHandler=function(e,o){var c=$scope.gatewayPhysical[o];c?(e.gatewayId=c.id,e.projectId=e.projectId?e.projectId:c.projectId,e.domainPath=c.domain,e.customerId=c.customerId,e.gateInfo=c,e.physicalConfig.accessProtocol=c.protocol,e.physicalConfig.analysisProtocol=e.physicalConfig.analysisProtocol?e.physicalConfig.analysisProtocol:null,e.accessMode="single",$scope.selectDevice=e,$scope.selectDevice.attrType=$scope.selectDevice.attrType?$scope.selectDevice.attrType:{default:[]},0<e.id&&"flexem"==c.protocol&&(null==e.physicalConfig.analysisConfigs.connectPointId||""==e.physicalConfig.analysisConfigs.connectPointId)&&(e.accessMode="multiple"),$scope.connectPointsInit(),$scope.modelIdAttrs(),modelKpi(),modelConfig(),taskInit(),docInit(),deviceDocInit(),getExtendDomains(c.domains)):(growl.warning("网关不存在，联系管理员!",{}),window.location.href="#/facility")};$scope.infoPageManage=function(e){if("FBOX"==e){var o=$scope.gatewayPhysical[$scope.selectDevice.gatewayId];deviceAccessUIService.getFlexemCloudConfAddr(o.externalGwId,location.href,function(e){0==e.code&&window.open(e.data)})}else if("设备启用"==e){if("active"!=$scope.selectDevice.gateInfo.managedStatus)return void growl.warning("网关不是启用状态，无法启用设备!",{});BootstrapDialog.show({title:"提示",closable:!1,message:"确认启用 "+escape($scope.selectDevice.label)+" 设备吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){$scope.selectDevice.isLoading=!0,$scope.saveResource(function(){resourceUIService.activateDevice($scope.selectDevice.id,function(e){$scope.selectDevice.isLoading=!1,0==e.code&&($scope.selectDevice.managedStatus=e.data.managedStatus,growl.success("启用成功",{}))})}),e.close()}},{label:"取消",action:function(e){e.close()}}]})}else if("设备停用"==e)BootstrapDialog.show({title:"提示",closable:!1,message:"确认停用 "+escape($scope.selectDevice.label)+" 设备吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){$scope.selectDevice.isLoading=!0,resourceUIService.deactivateDevice($scope.selectDevice.id,function(e){$scope.selectDevice.isLoading=!1,0==e.code&&($scope.selectDevice.managedStatus=e.data.managedStatus,growl.success("停用成功",{}))}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("管理当前网关"==e)location.href="#/gatewayInfo/"+$scope.selectDevice.gatewayId,resourceUIService.activeListTab="";else if("管理当前模板"==e){if(!$scope.selectDevice.modelId||0==$scope.selectDevice.modelId)return void growl.warning("请选择一个模板");location.href="#/editModel/"+$scope.selectDevice.modelId}},$scope.showData=function(e){$scope.addDataObj=jQuery.extend(!0,{},e),$scope.addDataObj.deviceMode=!0,"active"==$scope.selectDevice.managedStatus?$scope.addDataObj.displayMode=!0:$scope.addDataObj.displayMode=!1,$scope.selectDevice.physicalConfig.storageConfigs&&0<$scope.selectDevice.physicalConfig.storageConfigs.length&&$scope.selectDevice.physicalConfig.storageConfigs.forEach(function(e){e.uid==$scope.addDataObj.uid&&($scope.addDataObj.compress=e.compress,$scope.addDataObj.compressTime=e.compressTime,$scope.addDataObj.deadZone=e.deadZone,$scope.addDataObj.deadZoneRange=e.deadZoneRange,$scope.addDataObj.interval=e.interval,$scope.addDataObj.intervalTime=e.intervalTime)}),ngDialog.open({template:"../partials/dialogue/add_data.html",scope:$scope,className:"ngdialog-theme-plain"})},$scope.saveKpi=function(){$scope.selectDevice.physicalConfig.storageConfigs||($scope.selectDevice.physicalConfig.storageConfigs=[]);var e={};for(var o in e.uid=$scope.addDataObj.uid,e.compress=$scope.addDataObj.compress,e.compressTime=$scope.addDataObj.compressTime,e.deadZone=$scope.addDataObj.deadZone,e.deadZoneRange=$scope.addDataObj.deadZoneRange,e.interval=$scope.addDataObj.interval,e.intervalTime=$scope.addDataObj.intervalTime,$scope.selectDevice.physicalConfig.storageConfigs){if($scope.selectDevice.physicalConfig.storageConfigs[o].uid==e.uid){$scope.selectDevice.physicalConfig.storageConfigs.splice(o,1);break}}$scope.selectDevice.physicalConfig.storageConfigs.push(e),growl.info("请点击保存按钮，并重新启用设备",{}),$scope.closeDialog()},$scope.showCollection=function(e){$scope.taskObj=jQuery.extend(!0,{},e),$scope.taskObj.deviceMode=!0,"active"==$scope.selectDevice.managedStatus?$scope.taskObj.displayMode=!0:$scope.taskObj.displayMode=!1;var o=jQuery.extend(!0,[],$scope.selectDevice.kpi);$scope.selectValueLeft=[],$scope.selectValueRight=[];var c=$scope.taskObj.kpiDefinitionIds;if(0<c.length){for(var s=0;s<c.length;s++){for(var a=-1,t=0;t<o.length;t++)if(o[t].uid==c[s]){a=t;break}-1<a&&$scope.selectValueRight.push(o.splice(a,1)[0])}$scope.selectValueLeft=o}else $scope.selectValueLeft=o;0<$scope.selectDevice.physicalConfig.taskConfigs.length&&$scope.selectDevice.physicalConfig.taskConfigs.forEach(function(e){e.id==$scope.taskObj.id&&($scope.taskObj.cycleUnit=e.cycleUnit,$scope.taskObj.taskCycle=e.taskCycle)}),ngDialog.open({template:"../partials/dialogue/add_collection.html",scope:$scope,className:"ngdialog-theme-plain"})},$scope.saveCollection=function(){if($scope.selectDevice.physicalConfig.taskConfigs||($scope.selectDevice.physicalConfig.taskConfigs=[]),0<$scope.selectDevice.physicalConfig.taskConfigs.length)$scope.selectDevice.physicalConfig.taskConfigs.forEach(function(e){e.taskCode==$scope.taskObj.taskCode&&(e.cycleUnit=$scope.taskObj.cycleUnit,e.taskCycle=$scope.taskObj.taskCycle)});else{var e={taskCode:$scope.taskObj.id,cycleUnit:$scope.taskObj.cycleUnit,taskCycle:$scope.taskObj.taskCycle};$scope.selectDevice.physicalConfig.taskConfigs.push(e)}for(var o in $scope.selectDevice.taskData)$scope.selectDevice.taskData[o].taskCode==$scope.taskObj.taskCode&&($scope.selectDevice.taskData[o].cycleUnit=$scope.taskObj.cycleUnit,$scope.selectDevice.taskData[o].taskCycle=$scope.taskObj.taskCycle);growl.info("请点击保存按钮，并重新启用设备",{}),$scope.closeDialog()},$scope.reg=function(o,e){$scope.protocolObj.resolutionProtocol&&$scope.protocolObj.resolutionProtocol.regs.forEach(function(e){if(o.registers==e.label)return o.kpiRegisters=e.attributes,!0})},$scope.regsKpiList={},$scope.dataByte=function(e){var o=function(e,o){var c="";if("flexem"==$scope.protocolObj.accessProtocol){if("flexem"==$scope.protocolObj.accessProtocol&&"multiple"==$scope.selectDevice.accessMode&&o.analysisConfigs&&o.analysisConfigs.connectPointId){var s=$scope.connectPointsDic[o.analysisConfigs.connectPointId].resolutionProtocolName;null!=$scope.resolutionProtocolDic[s]&&(c=$scope.resolutionProtocolDic[s].regs)}else $scope.protocolObj.resolutionProtocol&&(c=$scope.protocolObj.resolutionProtocol.regs);if(c){var a=[];for(var t in c)0<=$.inArray(c[t].extAttributes.ioWidth,e)&&a.push(c[t]);$scope.regsKpiList[o.kpiId]=a}}},c=$scope.allDataTypes,s={};for(var a in c)if(c[a].id==e.dataTypeId){s=c[a];break}switch(e.kpiRegisters=[],s.byteSize){case 1:o([0],e);break;case 2:o([2],e);break;case 4:o([2,4],e);break;case 8:o([2,4,8],e);break;default:$scope.regsKpiList[e.kpiId]=[]}},$scope.saveProtocol=function(){$scope.selectDevice.physicalConfig.accessConfigs=$scope.protocolInfoData,$scope.closeDialog(),growl.info("请点击保存按钮，并重新启用设备",{})},$scope.showMeasurePoint=function(){var measurePointDatas,sourceValue=eval($scope.selectDevice.values.MeasurePointLocate);if(0<sourceValue.length)for(var i=0;i<sourceValue.length;i++)sourceValue[i].Z&&(measurePointDatas=sourceValue[i].Z);$scope.measurePointDatas=measurePointDatas.filter(function(e){return e.name<1e3});var propsList=$scope.myDicts.pointParamType;for(var i in $scope.specialtyProps=[],propsList)$scope.specialtyProps.push({value:propsList[i].valueCode,label:propsList[i].label});$scope.pointTypes=$scope.myDicts.pointType,$scope.pointTypeDataFunc=function(e){$scope.pointType=e},$scope.measurePointDataFunc=function(e){$scope.measurePoint=e},$scope.domainFunc=function(e){$scope.domain=e},$scope.protocolInfoData=$scope.selectDevice.pointParamItemList?$scope.selectDevice.pointParamItemList:[],$scope.protocolInfoData.forEach(function(o){o.pointName=$scope.measurePointDatas.find(function(e){return o.pointId==e.name}).label,o.paramName=$scope.specialtyProps.find(function(e){return o.paramKey==e.value}).label});var checkoutSelectVerify=function(){return $scope.pointType?$scope.measurePoint?!!$scope.domain||(growl.warning("请选择数据项",{}),!1):(growl.warning("请选择测点",{}),!1):(growl.warning("请选择测点类型",{}),!1)};$scope.addConfiguration=function(){if(checkoutSelectVerify()){var e={pointType:$scope.pointType.label,pointTypeAlias:"",pointId:$scope.measurePoint.name,pointName:$scope.measurePoint.label,paramKey:$scope.domain.value,paramName:$scope.domain.label,paramValue:""};$scope.protocolInfoData.push(e)}},$scope.deleteMeasurePointLocateChange=function(e,o){$scope.protocolInfoData.splice(o,1)},ngDialog.open({template:"../partials/dialogue/measure_point.html",scope:$scope,className:"ngdialog-theme-plain"})},$scope.saveMeasurePoint=function(){$scope.selectDevice.pointParamItemList=$scope.protocolInfoData,function(){for(var e=0;e<$scope.protocolInfoData.length;e++){if(""==$scope.protocolInfoData[e].pointTypeAlias)return growl.warning("测点别名不能为空",{}),!1;if(""==$scope.protocolInfoData[e].paramValue)return growl.warning("参数不能为空",{}),!1}return!0}()&&($scope.closeDialog(),growl.info("请点击保存按钮，并重新启用设备",{}))},$scope.importPhysicalConfig=function(){$("#fileName").click()},$scope.exportPhysicalConfig=function(){location.href=userUIService.uploadFileUrl+"/api/rest/export/resourceUIService/exportPhysicalConfig/"+$scope.selectDevice.id+".xlsx/"+$scope.selectDevice.id+"/physicalConfig/"},$scope.cleanDomainPath=function(){$scope.selectDevice.extendDomains=null},$scope.showProtocol=function(){if($scope.selectDevice.physicalConfig.analysisProtocol||"single"!=$scope.selectDevice.accessMode){if($scope.protocolObj=null,0==$scope.selectDevice.physicalConfig.accessConfigs.length)$scope.selectDevice.config&&$scope.selectDevice.config.forEach(function(config){if(config.accessProtocol==$scope.selectDevice.physicalConfig.accessProtocol&&config.analysisProtocol==$scope.selectDevice.physicalConfig.analysisProtocol){for(var j in config.accessConfigs)"modbus"==config.accessProtocol&&config.accessConfigs[j].registers&&(config.accessConfigs[j].registers=parseInt(config.accessConfigs[j].registers)),null==config.analysisConfigs&&"flexem"==config.accessProtocol&&(config.accessConfigs[j].analysisConfigs={},config.accessConfigs[j].analysisConfigs.connectPointId="",config.accessConfigs[j].analysisConfigs.stationNo=1,config.accessConfigs[j].analysisConfigs.externalDevId="");if($scope.protocolObj=jQuery.extend(!0,{},config),"baogang"==$scope.protocolObj.accessProtocol){var propsList=$scope.myDicts.specialtyProps;for(var i in $scope.specialtyProps=[],propsList)$scope.specialtyProps.push({value:propsList[i].valueCode,label:propsList[i].label});$scope.domainFunc=function(e){$scope.domain=e,$scope.indicatorDatas=[],$scope.selectDevice.kpi.forEach(function(o){if(e.value==o.values.specialtyProp){var c={label:o.label,uid:o.uid,dataItemId:o.id};$scope.indicatorDatas.push(c)}});var sourceValue=eval($scope.selectDevice.values.MeasurePointLocate);if(0<sourceValue.length)for(var i=0;i<sourceValue.length;i++){if(sourceValue[i][e.value])return void($scope.measurePointDatas=sourceValue[i][e.value]);$scope.measurePointDatas=null}},$scope.measurePointDataFunc=function(e){$scope.measurePoint=e},$scope.indicatorFunc=function(e){$scope.indicator=e};var checkoutSelectVerify=function(){if(!$scope.domain)return growl.error("请选择专业",{}),!1;if(!$scope.measurePoint)return growl.error("请选择测点",{}),!1;if(!$scope.indicator)return growl.error("请选择数据项",{}),!1;if(0<$scope.protocolInfoData.length)for(var e=0;e<$scope.protocolInfoData.length;e++)if($scope.protocolInfoData[e].specialtyPropName==$scope.domain.label&&$scope.protocolInfoData[e].instanceName==$scope.measurePoint.label&&$scope.protocolInfoData[e].kpiName==$scope.indicator.label)return growl.warning("这个数据项检测点位已存在",{}),!1;return!0};$scope.protocolInfoData=[],$scope.addConfiguration=function(e){if(checkoutSelectVerify()&&checkoutSelectVerify()){var o={specialtyPropName:$scope.domain.label,specialtyProp:$scope.domain.value,instance:$scope.measurePoint.name,instanceName:$scope.measurePoint.label,dataItemId:$scope.indicator.dataItemId,anOtherName:"",kpiName:$scope.indicator.label,kpiId:$scope.indicator.uid,writeExpression:"",readExpression:"",isShowExpand:!1};$scope.protocolInfoData.push(o)}$scope.deleteMeasurePointLocateChange=function(e,o){$scope.protocolInfoData.splice(o,1)}}}}});else{if("modbus"==$scope.selectDevice.physicalConfig.accessProtocol){var phyArr=$scope.selectDevice.physicalConfig.accessConfigs;for(var j in phyArr)phyArr[j].registers&&(phyArr[j].registers=parseInt(phyArr[j].registers))}if($scope.protocolObj=jQuery.extend(!0,{},$scope.selectDevice.physicalConfig),$scope.protocolObj.id=Number.MAX_VALUE,"baogang"==$scope.protocolObj.accessProtocol){var propsList=$scope.myDicts.specialtyProps;for(var i in $scope.specialtyProps=[],$scope.indicatorDatas=[],propsList)$scope.specialtyProps.push({value:propsList[i].valueCode,label:propsList[i].label});$scope.domainFunc=function(e){$scope.domain=e,$scope.indicatorDatas=[],$scope.selectDevice.kpi.forEach(function(o){if(e.value==o.values.specialtyProp){var c={label:o.label,uid:o.uid,dataItemId:o.id};$scope.indicatorDatas.push(c)}});var sourceValue=eval($scope.selectDevice.values.MeasurePointLocate);if(0<sourceValue.length)for(var i=0;i<sourceValue.length;i++){if(sourceValue[i][e.value])return void($scope.measurePointDatas=sourceValue[i][e.value]);$scope.measurePointDatas=null}},$scope.measurePointDataFunc=function(e){$scope.measurePoint=e},$scope.indicatorFunc=function(e){$scope.indicator=e};var checkoutSelectVerify=function(){if(!$scope.domain)return growl.warning("请选择专业",{}),!1;if(!$scope.measurePoint)return growl.warning("请选择测点",{}),!1;if(!$scope.indicator)return growl.warning("请选择数据项",{}),!1;if(0<$scope.protocolInfoData.length)for(var e=0;e<$scope.protocolInfoData.length;e++)if($scope.protocolInfoData[e].specialtyPropName==$scope.domain.label&&$scope.protocolInfoData[e].instanceName==$scope.measurePoint.label&&$scope.protocolInfoData[e].kpiName==$scope.indicator.label)return growl.warning("这个数据项检测点位已存在",{}),!1;return!0};$scope.protocolInfoData=$scope.selectDevice.physicalConfig.accessConfigs,$scope.protocolInfoData.forEach(function(protocolInfoData){var specialtyPropName=propsList.find(function(e){return e.valueCode==protocolInfoData.specialtyProp}),sourceValue=eval($scope.selectDevice.values.MeasurePointLocate);if(0<sourceValue.length)for(var measurePointArr=[],i=0;i<sourceValue.length;i++)for(var k in sourceValue[i])for(var j=0;j<sourceValue[i][k].length;j++)measurePointArr.push(sourceValue[i][k][j]);$scope.measurePointDatas=measurePointArr||[];var measurePointData=$scope.measurePointDatas.find(function(e){return e.name==protocolInfoData.instance});protocolInfoData.specialtyPropName=specialtyPropName.label,measurePointData&&(protocolInfoData.instanceName=measurePointData.label)}),$scope.addConfiguration=function(e){if(checkoutSelectVerify()){var o={specialtyPropName:$scope.domain.label,specialtyProp:$scope.domain.value,instance:$scope.measurePoint.name,instanceName:$scope.measurePoint.label,dataItemId:$scope.indicator.dataItemId,anOtherName:"",kpiName:$scope.indicator.label,kpiId:$scope.indicator.uid,writeExpression:"",readExpression:"",isShowExpand:!1};$scope.protocolInfoData.push(o)}},$scope.deleteMeasurePointLocateChange=function(e,o){$scope.protocolInfoData.splice(o,1)}}}$scope.protocolObj||($scope.protocolObj={id:Number.MAX_VALUE,accessProtocol:$scope.gatewayPhysical[parseInt(gatewayId)].protocol,analysisProtocol:$scope.selectDevice.physicalConfig.analysisProtocol}),ngDialog.open({template:"../partials/dialogue/gateways_protocol.html",scope:$scope,className:"ngdialog-theme-plain"})}else growl.warning("请选择一个解析协议",{})},$scope.measurePointLocateChange=function(e,o){if(e.instance){var c=e.instance;e.instance="";var s=$.extend(!0,{},e);delete s.$$hashKey;for(var a=-1,t=0,i=[],r=$scope.connectPoints,n=[],l=$scope.protocolObj.accessConfigs.length-1;-1<l;l--){if("delete"!=o&&$scope.protocolObj.accessConfigs[l].kpiId==s.kpiId&&$scope.protocolObj.accessConfigs[l].instance==c){a=l,growl.warning("这个数据项检测点位已存在",{});break}$scope.protocolObj.accessConfigs[l].kpiId==s.kpiId&&(i.push($scope.protocolObj.accessConfigs[l]),t=l)}if(a<0){for(var l in e.instance=c,r){var p=-1;for(var d in i)if(r[l].id==i[d].instance){p=l;break}p<0&&n.push(r[l])}"delete"==o?1<i.length?$scope.protocolObj.accessConfigs.splice(t,1):(e.instance="",growl.warning("最后一个不让删除",{})):0<n.length&&i.length<r.length&&$scope.protocolObj.accessConfigs.splice(t,0,s)}}},$scope.expandObj={},$scope.optionExpand=function(e){$scope.expandObj[e.kpiId]?1==$scope.expandObj[e.kpiId].option?$scope.expandObj[e.kpiId].option=!1:$scope.expandObj[e.kpiId].option=!0:(e.option=!0,$scope.expandObj[e.kpiId]=e)},$scope.analysisChange=function(){$scope.protocolObj.resolutionProtocol=$scope.resolutionProtocolDic[$scope.protocolObj.analysisProtocol];var e=$scope.selectDevice.kpi,s=[];e.forEach(function(e){var o=jQuery.extend(!0,{},e);if($scope.protocolObj.accessConfigs){var c=!1;$scope.protocolObj.accessConfigs.forEach(function(e){if(o.uid==e.kpiId)return c=!0,null==e.analysisConfigs&&(e.analysisConfigs={},"flexem"==$scope.protocolObj.accessProtocol&&(e.analysisConfigs.connectPointId=$scope.selectDevice.physicalConfig.analysisConfigs.connectPointId,e.analysisConfigs.stationNo=parseInt($scope.selectDevice.physicalConfig.stationNo),e.analysisConfigs.externalDevId=$scope.selectDevice.externalDevId)),e.dataItemId=o.id,s.push(e),!0}),c||(getWayKpiInit(o,{config:{}}),s.push(o))}else getWayKpiInit(o,{config:{}}),s.push(o)}),$scope.protocolObj.accessConfigs=s},$scope.downClick=function(e){var o=userUIService.uploadFileUrl+e;window.open(o)},$scope.deleteDeviceDoc=function(c){BootstrapDialog.show({title:"提示",closable:!1,message:"确认删除文档吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){resourceUIService.deleteDeviceFile(c,function(e){if(0==e.code){for(var o in $scope.selectDevice.deviceDocData)if(c.id==$scope.selectDevice.deviceDocData[o].id){$scope.selectDevice.deviceDocData.splice(o,1);break}growl.success("删除成功",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]})};var getSearchResourceState=function(e,s,a){kpiDataService.getRealTimeKpiData(e,[999999,999998],function(e){if(0==e.code)for(var o in s)for(var c in e.data)e.data[c].nodeId==s[o].id&&("999998"==e.data[c].kpiCode&&(s[o].onlineStatus=e.data[c].value),"999999"==e.data[c].kpiCode&&(s[o].severity=e.data[c].value));a&&a(s)})};$scope.pipeline=function(e){var f=$.extend({pages:1,url:"",data:null,method:"POST"},e),g=-1,v=null,y=null,m=null;return function(s,a,e){var o=!1,c=s.start,t=s.start,i=s.length,r=c+i,n=s.columns[s.order[0].column].data,l=s.order[0].dir;if(e.clearCache?(o=!0,e.clearCache=!1):g<0||c<g||v<r?o=!0:JSON.stringify(s.order)===JSON.stringify(y.order)&&JSON.stringify(s.columns)===JSON.stringify(y.columns)&&JSON.stringify(s.search)===JSON.stringify(y.search)||(o=!0),y=$.extend(!0,{},s),o){if(c<g&&(c-=i*(f.pages-1))<0&&(c=0),v=(g=c)+i*f.pages,s.start=c,s.length=i*f.pages,$.isFunction(f.data)){var p=f.data(s);p&&$.extend(s,p)}else $.isPlainObject(f.data)&&$.extend(s,f.data);var d={start:s.start,length:s.length,sort:n,sortType:l,statCount:1==s.draw};$scope.getDevicesByPage($scope.queryDitemList,d,function(e,o){var c={};c.data=e,c.draw=s.draw,c.recordsTotal=null!=o?-1==o?m.recordsTotal:o:e.length,c.recordsFiltered=c.recordsTotal,m=$.extend(!0,{},c),g!=t&&c.data.splice(0,t-g),-1<=i&&c.data.splice(i,c.data.length),a(c)})}else{0<$scope.socketList.length&&(m.data=$scope.socketList);var u=$.extend(!0,{},m);u.draw=s.draw,u.data.splice(0,c-g),u.data.splice(i,u.data.length),a(u)}}},$scope.socketList=[];var stateCallback=function(o){var e=$scope.facilityResourceState;e.forEach(function(e){if(e.id==o.data.nodeId)return e.onlineStatus=o.data.value,!1}),$scope.socketList=e,$scope.fnData(o.data)};$scope.getDevicesByPage=function(e,o,t){resourceUIService.getDevicesByConditionWithPage(e,o,function(s){if(0==s.code){var a=[];for(var e in s.data.data)a.push(s.data.data[e].id);$scope.facilityList=s.data.data,getSearchResourceState(a,s.data.data,function(e){if(t&&($scope.facilityResourceState=e,t(e,s.data.total),"WebSocket"in window)){var o={ciid:a.toString(),kpi:"999998"},c="register";SwSocket.register(uuid,c,stateCallback),SwSocket.send(uuid,c,"kpi",o)}})}})},$scope.goSearch=function(){$scope.queryDitemList={};var e=$routeParams.id;$scope.chooseType=type;var o={autoActive:null,modelConfig:{},stationNo:1,analysisConfigs:{},taskConfigs:[],analysisProtocol:null,accessConfigs:[],storageConfigs:[]};if("customer"==type&&e){type="";var c=parseInt(e),s=$scope.customersList;for(var a in s)if(s[a].id==c){$scope.queryDitem.domainPath=s[a].domainPath,$scope.queryDitemList.customerId=c,$scope.queryDitem.customerId=c;break}}else if("domain"==type&&e)type="",$scope.queryDitemList.domainPath=e,$scope.queryDitem.domainPath=e;else if("sn"==type&&e)type="",$scope.queryDitemList.sn=e,$scope.queryDitem.sn=e;else if("model"==type&&e)type="",$scope.queryDitemList.modelId=e,$scope.queryDitem.modelId=e;else if("project"==type&&e){type="";var t=parseInt(e),i=$scope.projectsList;for(var a in i)if(i[a].id==t){$scope.queryDitem.domainPath=i[a].domainPath,$scope.queryDitemList.projectId=t,$scope.queryDitem.customerId=i[a].customerId,$scope.queryDitem.projectId=t;break}}else if("DEVICE"==type)$scope.queryDitemList.gatewayId=gatewayId,$scope.queryDitemList.resourceId=e;else if("DETAIL"==type||"DEPLOY"==type||"DEVICESEARCH"==type)$scope.queryDitemList.resourceId=e;else if("UNDEVICE"==type)return void(resourceUIService.selectUnComfirmedDevice&&resourceUIService.selectUnComfirmedDevice.id==e?(resourceUIService.selectUnComfirmedDevice.physicalConfig||(resourceUIService.selectUnComfirmedDevice.physicalConfig=jQuery.extend(!0,{},o)),deviceHandler(resourceUIService.selectUnComfirmedDevice,gatewayId)):deviceHandler({id:0,physicalConfig:jQuery.extend(!0,{},o)},gatewayId));if($scope.access.status="",$scope.queryDitem.modelId&&($scope.queryDitemList.modelId=$scope.queryDitem.modelId),$scope.queryDitem.domainPath&&($scope.queryDitemList.domains=$scope.queryDitem.domainPath),$scope.queryDitem.customerId&&($scope.queryDitemList.customerId=$scope.queryDitem.customerId),$scope.queryDitem.projectId&&($scope.queryDitemList.projectId=$scope.queryDitem.projectId),$scope.queryDitem.sn&&($scope.queryDitemList.orCondition=$scope.queryDitem.sn,$scope.queryDitemList.conditionField=["sn","label"]),$scope.seniorQuery){var r={};for(var n in $scope.queryKeyValue)"datetime"==$scope.queryKeyValue[n].dataType||"date"==$scope.queryKeyValue[n].dataType?r[$scope.queryKeyValue[n].name]=[$scope.queryKeyValue[n].startTime,$scope.queryKeyValue[n].endTime]:"numberic"==$scope.queryKeyValue[n].dataType?r[$scope.queryKeyValue[n].name]=[$scope.queryKeyValue[n].startNumberic,$scope.queryKeyValue[n].endNumberic]:r[$scope.queryKeyValue[n].name]=$scope.queryKeyValue[n].value;$scope.queryDitemList.values=r}"DEVICE"==type||"DETAIL"==type||"DEPLOY"==type?resourceUIService.getDevicesByCondition($scope.queryDitemList,function(e){0==e.code&&deviceHandler(0<e.data.length?e.data[0]:{id:0,from:"gateway",physicalConfig:jQuery.extend(!0,{},o)},gatewayId)}):$scope.$broadcast(Event.CMDBINFOSINIT+"_facility",{option:[]})},$scope.goClear=function(){for(var e in $scope.queryDitem={domainPath:"",sn:"",customerId:"",projectId:"",modelId:""},$scope.queryKeyValue)"datetime"==$scope.queryKeyValue[e].dataType||"date"==$scope.queryKeyValue[e].dataType?($scope.queryKeyValue[e].startTime="",$scope.queryKeyValue[e].endTime=""):"numberic"==$scope.queryKeyValue[e].dataType?($scope.queryKeyValue[e].startNumberic="",$scope.queryKeyValue[e].endNumberic=""):$scope.queryKeyValue[e].value="";$scope.queryModelChange()},$scope.addDirectives=function(){var e={customerId:"",projectId:"",sn:"",label:"",domainSelect:"",domainPath:"",physicalDeviceDomain:"",id:0,isEdit:3};null==$scope.facilityList.data?$scope.facilityList.data=[e]:$scope.facilityList.data.unshift(e),$scope.$broadcast(Event.CMDBINFOSINIT+"_facility",$scope.facilityList)},$scope.connectChange=function(){if($scope.selectDevice.config){var c=-1,s=$scope.connectPointsDic[$scope.protocolObj.connectGateways].resolutionProtocolName;if($scope.selectDevice.config.forEach(function(e){if(e.accessProtocol==$scope.protocolObj.accessProtocol&&e.analysisProtocol==s){for(var o in c=1,e.accessConfigs)e.accessConfigs[o].analysisConfigs={},e.accessConfigs[o].analysisConfigs.connectPointId=$scope.protocolObj.connectGateways,e.accessConfigs[o].analysisConfigs.stationNo=1,e.accessConfigs[o].analysisConfigs.externalDevId="";$scope.protocolObj.accessConfigs=e.accessConfigs}}),-1==c){var e=$scope.protocolObj.accessConfigs;for(var o in e)e[o].analysisConfigs.connectPointId=$scope.protocolObj.connectGateways,e[o].analysisConfigs.stationNo=1,e[o].analysisConfigs.externalDevId="",e[o].readExpression="",e[o].registers="",e[o].writeExpression="",e[o].dataTypeId="",e[o].config={}}}else{e=$scope.protocolObj.accessConfigs;if($scope.protocolObj.connectGateways)for(var o in $scope.protocolObj.analysisProtocol=$scope.connectPointsDic[$scope.protocolObj.connectGateways].resolutionProtocolName,e)e[o].analysisConfigs.connectPointId=$scope.protocolObj.connectGateways}},$scope.gatewayDate={};var getWayKpiInit=function(e,o){e.kpiId=e.uid,e.kpiName=e.label,e.deviceAddress=o.config.deviceAddress,e.registerType=o.config.registerType,e.startPoint=o.config.startPoint,e.length=o.config.length,e.byteOrder=o.config.byteOrder,e.readExpression=o.readExpression,e.writeExpression=o.writeExpression,e.dataItemId=e.id,null==e.analysisConfigs&&"flexem"==$scope.protocolObj.accessProtocol&&(e.analysisConfigs={},e.analysisConfigs.connectPointId="",e.analysisConfigs.stationNo=1,e.analysisConfigs.externalDevId="")},gatewayHandler=function(e,o){resourceUIService.getPhysicalDeviceById(e.physicalDeviceId,function(e){if(0==e.code){e.data&&($scope.access.accessGwId=$scope.gatewayPhysical[e.data.gatewayId]);var c=[],s=e.data?e.data.accessConfigs:null;o.forEach(function(e){var o=jQuery.extend(!0,{},e);s?s.forEach(function(e){if(o.id==e.kpiId)return getWayKpiInit(o,e),!0}):getWayKpiInit(o,{config:{}}),c.push(o)}),$scope.gatewayDate.data=c}})},pointKpiInit=function(e,o){e.gatewayId=o.gatewayId,e.resourceId=o.resourceId,e.sourceId=o.sourceId,e.physicalDeviceId=o.physicalDeviceId},pointHandler=function(e,o){resourceUIService.findResourceAccesses(e.id,function(e){if(0==e.code){var c=e.data,s=[];o.forEach(function(e){var o=jQuery.extend(!0,{},e);c?c.forEach(function(e){if(o.uid==e.kpiId)return pointKpiInit(o,e),!0}):pointKpiInit(o,{config:{}}),s.push(o)}),$scope.kpisList.data=s}})};$scope.kpisList=function(o){0==jQuery("#devicecollapse").find(".fa.fa-plus").length&&jQuery.AdminLTE.boxWidget.collapse(jQuery("#devicecollapse")),$scope.access.accessGwId="",$scope.access.accessProtocol="",o.accessMode=o.accessMode?o.accessMode:"gateway",$scope.access.accessMode=o.accessMode,$scope.rootModelDic[o.modelId].kpisfinish?"gateway"==o.accessMode?gatewayHandler(o,$scope.rootModelDic[o.modelId].kpis):"point"==o.accessMode&&pointHandler(o,$scope.rootModelDic[o.modelId].kpis):resourceUIService.getKpisByModelId(o.modelId,function(e){0==e.code&&($scope.rootModelDic[o.modelId].kpisfinish=!0,$scope.rootModelDic[o.modelId].kpis=e.data,"gateway"==o.accessMode?gatewayHandler(o,$scope.rootModelDic[o.modelId].kpis):"point"==o.accessMode&&pointHandler(o,$scope.rootModelDic[o.modelId].kpis))}),$scope.access.status="access",$scope.optionStatus.selectDevice=o},$scope.accessModeChange=function(){var e=$scope.optionStatus.selectDevice;e.accessMode=$scope.access.accessMode,"gateway"==e.accessMode?gatewayHandler(e,$scope.rootModelDic[e.modelId].kpis):"point"==e.accessMode&&pointHandler(e,$scope.rootModelDic[e.modelId].kpis)},$scope.closeTable=function(){0<jQuery("#devicecollapse").find(".fa.fa-plus").length&&jQuery.AdminLTE.boxWidget.collapse(jQuery("#devicecollapse")),$scope.access.status=""},$scope.listSaveValue={deviceAddress:"",registerType:"",startPoint:"",length:"",byteOrder:"",expression:""};var updateData=function(e){for(var o in $scope.facilityList.data)$scope.facilityList.data[o].id==e.id&&($scope.facilityList.data[o]=e);$scope.$broadcast(Event.CMDBINFOSINIT+"_facility",$scope.facilityList)};$scope.saveTable=function(){if($scope.selectDevice){if(0<jQuery("#devicecollapse").find(".fa.fa-plus").length&&jQuery.AdminLTE.boxWidget.collapse(jQuery("#devicecollapse")),"gateway"==$scope.access.accessMode){if($scope.selectDevice.gatewayId=$scope.access.accessGwId.id,$scope.selectDevice.accessMode=$scope.access.accessMode,""==$scope.gatewayDate.data||null==$scope.gatewayDate.data||null==$scope.gatewayDate.data)return void growl.warning("当前设备下的模型没测点，请先配置测点……",{});var c=[],e=$scope.gatewayDate.data;for(var o in e){var s={kpiId:"",kpiName:"",readExpression:"",writeExpression:"",config:{}};s.kpiId=e[o].id,s.kpiName=e[o].label,s.readExpression=e[o].readExpression,s.writeExpression=e[o].writeExpression,s.config.byteOrder=e[o].byteOrder,s.config.registerType=e[o].registerType,s.config.startPoint=e[o].startPoint,s.config.length=e[o].length,s.config.deviceAddress=e[o].deviceAddress,c.push(s)}null==$scope.selectDevice.gatewayId&&($scope.selectDevice.gatewayId=0),resourceUIService.updateDevice($scope.selectDevice,function(o){0==o.code&&resourceUIService.getPhysicalDeviceById(o.data.physicalDeviceId,function(e){0==e.code&&e.data?(e.data.gatewayId=$scope.access.accessGwId.id,e.data.accessConfigs=c,resourceUIService.savePhysicalDevice(e.data,function(e){0==e.code&&(growl.success("接入配置保存成功",{}),$scope.access.status="",updateData(o.data))})):growl.warning("您的物理设备数据有问题，请联系技术人员",{})})})}else if("point"==$scope.access.accessMode){if(""==$scope.kpisList.data||null==$scope.kpisList.data||null==$scope.kpisList.data)return void growl.warning("当前设备下的模型没测点，请先配置测点……",{});e=$scope.kpisList.data;var a=[];for(var t in e){var i={gatewayId:"",resourceId:"",physicalDeviceId:"",sourceId:"",kpiId:""};i.gatewayId=e[t].gatewayId,i.resourceId=$scope.selectDevice.id,i.physicalDeviceId=e[t].physicalDeviceId,i.sourceId=e[t].sourceId,i.kpiId=e[t].uid,a.push(i)}$scope.selectDevice.accessMode="point",resourceUIService.updateDevice($scope.selectDevice,function(o){0==o.code&&resourceUIService.addResourceAccesses([a],function(e){0==e.code&&(growl.success("接入配置成功",{}),$scope.access.status="",updateData(o.data))})})}}else growl.warning("您现在没有设备",{})},$scope.currentTab="default",$scope.isAttr=!0,$scope.attrClick=function(e,o){$scope.currentTab=e,$scope.isAttr=o},$scope.customersList,$scope.customersDic={};var queryCustomer=function(){customerUIService.findCustomersByCondition({},function(e){$scope.customersDic=e.customerDic,e.data.forEach(function(e){e.text=e.customerName}),$scope.customersList=e.data,defers[0].resolve("success")})};$scope.modelIdChange=function(){$scope.modelIdAttrs(),modelKpi(),modelConfig(),taskInit(),docInit()},$scope.projectsList,$scope.projectsDic={},$scope.queryProject=function(o){projectUIService.findProjectsByCondition({},function(e){0==e.code&&(e.data.forEach(function(e){($scope.projectsDic[e.id]=e).text=e.projectName}),$scope.projectsList=e.data,o?growl.success("操作成功！"):defers[4].resolve("success"))})},$scope.getAllgateWays=function(s){resourceUIService.getAllGateways(function(e){if(0==e.code){var o=[];for(var c in e.data)o.push(e.data[c]);$scope.access.allGateways=o,$scope.access.allGateways.forEach(function(e){$scope.gatewayPhysical[e.id]=e}),s?growl.success("操作成功！"):defers[3].resolve("success")}})};for(var promises=[],defers=[],i=0;i<5;i++)defers.push(q.defer());var initList=function(){for(var e in uuid=Math.uuid(),defers)promises.push(defers[e].promise);if(q.all(promises).then(function(e){$scope.goSearch()}),queryCustomer(),$scope.queryProject(),$scope.menuitems.isloaded)$scope.menuitems.A07_S02&&allAttrs(),domainTreeQuery();else var o=$scope.$watch("menuitems",function(e){$scope.menuitems.isloaded&&($scope.menuitems.A07_S02&&allAttrs(),domainTreeQuery(),o())},!0);resourceUIService.getRootModel(function(e){0==e.code&&(resourceUIService.rootModel=e.data,$scope.modelList())}),$scope.look=function(e){window.location.href="#/facility_detail/DETAIL/"+e.gatewayId+"/"+e.id},$scope.getAllgateWays(),resourceUIService.getAllDataItems(function(e){0==e.code&&($scope.access.allDataItems=e.data)}),getAllCollectionPlugins(),getAllResolutionProtocols()},getAddressPoint=function(o,c){o.values.standardAddressdetail=o.values.standardAddressdetail?o.values.standardAddressdetail:"",!o.values.standardAddress||o.values.latitude&&o.values.longitude&&"null"!=o.values.latitude&&"null"!=o.values.longitude?c&&c(o):userLoginUIService.getAddressPoint(o.values.standardAddress.split(",").join("")+o.values.standardAddressdetail,function(e){e&&(o.values.latitude=e.location.lat,o.values.longitude=e.location.lng),c&&c(o)})};userLoginUIService.user.isAuthenticated?initList():$scope.$on("loginStatusChanged",function(e,o){userLoginUIService.user.isAuthenticated&&initList()})}])});
//# sourceMappingURL=../../../map/app-oc/js/controllers/facility-ctrl.js.map
