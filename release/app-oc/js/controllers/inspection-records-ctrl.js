define(["controllers/controllers","bootstrap-dialog","echarts"],function(e,O,g){"use strict";e.initController("inspectionRecordsCtrl",["$scope","userInitService","$location","$routeParams","$timeout","maintenanceUIService","userLoginUIService","Info","growl","userEnterpriseService",function(i,e,t,a,o,d,s,n,r,c){function l(){i.inspectionRecords={teamId:"",userId:"",startDate:"",endDate:""}}i.teamTypes=[{teamType:"polling",typeName:"巡检组"},{teamType:"security",typeName:"保安组"}],i.ifTables=!0,i.allTeams=null,i.usersByTeam=null,i.selectedTeam=function(e){!function(e){if(""!=e&&null!=e){var t=e;d.getUsersByTeamId(t,function(e){0==e.code&&(i.usersByTeam=e.data)})}else i.inspectionRecords.userId=""}(e)},i.saveRecords=function(){i.ifTables=!0;var e=[];for(var t in i.inspectionRecords)e.push(i.inspectionRecords[t]);d.getInspectionRecordsByCondition(e,function(e){if(0==e.code){for(var t in e.data)e.data[t].imgUrl&&(e.data[t].imgUrl=e.data[t].imgUrl.split(";"));o(function(){i.$broadcast(Event.INSPECTIONRECORDS,{option:[e.data]})})}})},i.cancelRecords=function(){l(),i.ifTables=!1};l(),d.getAllTeams(function(e){0==e.code&&(i.allTeams=e.data)})}]),e.initController("queryDeviceDataCtrl",["$scope","ngDialog","userInitService","unitService","userDomainService","resourceUIService","$location","$routeParams","$timeout","kpiDataService","userLoginUIService","Info","growl","customerUIService","projectUIService","userUIService","configUIService",function(c,o,e,t,d,n,i,a,s,r,l,m,u,p,I,f,D){c.domainListDic={},c.domainListTree={},c.rootModel={},c.selectedItem={},c.rootModelDic={},c.routePathNodes={},c.selectedDitem={devices:[]},c.copy={devicesData:[],nodeIds:[]},c.kpiQueryModelObj="",c.showDeviceData=[],c.queryState=!1,c.ifTables=!0,c.tableDataLoading=!1,c.times=null,c.timePeriod="10";m.get("../localdb/info.json",function(e){e.emcsAlertColor,c.times=e.emcsSetTime});var v=function(e){return{title:{text:e.title},tooltip:{trigger:"axis"},legend:{data:[]},toolbox:{feature:{saveAsImage:{}},right:"5%"},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},xAxis:[{type:"category",boundaryGap:!1,data:e.xData}],yAxis:[{type:"value"}],series:[{name:e.title,type:"line",stack:"总量",label:{normal:{show:!0,position:"top"}},areaStyle:{normal:{}},data:e.series.data}]}};c.expObj={},c.kPIsExportOrder;var g=function(){if(c.kPIsExportOrder?"[object Object]"!==Object.prototype.toString.call(c.kPIsExportOrder.value)&&(c.kPIsExportOrder.value=JSON.parse(c.kPIsExportOrder.value)):D.getConfigsByGroupName("KPIsExportOrder",function(e){0==e.code&&0<e.data.length&&(e.data[0].value&&(e.data[0].value=JSON.parse(e.data[0].value)),c.kPIsExportOrder=e.data[0])}),c.expObj={packNumber:1,packType:"天",censusNumber:1,censusType:"分钟"},c.expObj.paramkpis=[],c.selectedItem.kpiCodes){var i=0;c.selectedItem.kpiCodes.forEach(function(e){if(null!=c.selectedDitem.kpisObj[e]){var t=jQuery.extend(!0,{},c.selectedDitem.kpisObj[e]);t.index=c.kPIsExportOrder.value[t.id]?c.kPIsExportOrder.value[t.id]:i,c.expObj.paramkpis.push(t),i++}})}},h=function(e,t,i,a,o){var d=new Date(c.selectedItem.startTime).getTime(),s=new Date(c.selectedItem.endTime).getTime()-d,n=0,r=!0;return"小时"==o?0<a&&(n=parseInt(s/36e5))<a&&(r="您选择的"+e+o+"大于时间范围，最大值不能超过"+n+o):"天"==o?0<a&&(n=parseInt(s/864e5))<a&&(r="您选择的"+e+o+"大于时间范围，最大值不能超过"+n+o):"分钟"==o?0<a&&(n=parseInt(s/6e4))<a&&(r="您选择的"+e+o+"大于时间范围，最大值不能超过"+n+o):"秒钟"==o&&0<a&&(n=parseInt(s/1e3))<a&&(r="您选择的"+e+o+"大于时间范围，最大值不能超过"+n+o),r},y=function(e,t){var i="";return"小时"==t?0<e&&(i=36e5*e):"天"==t?0<e&&(i=864e5*e):"分钟"==t?0<e&&(i=6e4*e):"秒钟"==t&&0<e&&(i=1e3*e),i};function b(){g(),c.selectedItem={domain:"",modelId:null,nodeIds:[],nodeId:"",kpiCodes:[],kpiId:"",startTime:"",endTime:"",customerId:"",projectId:"",time:null},c.selectedDitem.devices=[],c.selectedDitem.kpis=[],c.selectedDitem.nodeIds=[],c.selectedDitem.kpiCodes=[],c.clearSelectTime&&c.clearSelectTime()}c.exportKpi=function(){var e;if(c.expObj.packNumber&&c.expObj.packType&&1!=(e=h("打包时间",c.selectedItem.startTime,c.selectedItem.endTime,c.expObj.packNumber,c.expObj.packType)))return void u.warning(e,{});if(c.expObj.censusNumber&&c.expObj.censusType&&1!=(e=h("统计周期",c.selectedItem.startTime,c.selectedItem.endTime,c.expObj.censusNumber,c.expObj.censusType)))return void u.warning(e,{});c.closeDialog(),c.loadingShow=!0,c.expObj.paramkpis.sort(function(e,t){return parseInt(e.index)-parseInt(t.index)});var t=[];c.expObj.paramkpis.forEach(function(e){t.push(e.id),c.kPIsExportOrder.value[e.id]=e.index}),c.kPIsExportOrder&&(c.kPIsExportOrder.value=JSON.stringify(c.kPIsExportOrder.value),D.saveConfig(c.kPIsExportOrder,function(e){e.code}));var i=0,a=0,o={isRealTimeData:!1,startTime:new Date(c.selectedItem.startTime),endTime:new Date(c.selectedItem.endTime),nodeIds:c.selectedItem.nodeIds,kpiCodes:t};0<c.expObj.packNumber&&c.expObj.packType?(i=y(c.expObj.packNumber,c.expObj.packType),0<c.expObj.censusNumber&&c.expObj.censusType?(a=y(c.expObj.censusNumber,c.expObj.censusType),r.exportKpiValueList(["kpi",o,a,i,!1],function(e){if(c.loadingShow=!1,0==e.code){var t=e.data;0<t.indexOf("download")?window.location.href=f.uploadFileUrl+"/"+t:O.show({title:"提示",closable:!1,message:e.data,buttons:[{label:"确定",cssClass:"btn-success",action:function(e){c.loadingShow=!0,r.exportKpiValueList(["kpi",o,a,i,!0],function(e){0==e.code&&(c.loadingShow=!1,0<e.data.indexOf("/")?window.location.href=f.uploadFileUrl+"/"+e.data:u.info("操作异常请联系管理员"))}),e.close()}},{label:"取消",action:function(e){e.close()}}]})}})):u.warning("统计周期不能填0哦！",{})):u.warning("打包时间不能填0哦！",{})},c.exportClick=function(){var e=new Date(c.selectedItem.endTime).Format("yyyy-MM-dd"),t=new Date(c.selectedItem.startTime).Format("yyyy-MM-dd"),i=e.split("-"),a=t.split("-");parseInt(i[0])<parseInt(a[0])||parseInt(i[1])<parseInt(a[1])||parseInt(i[1])==parseInt(a[1])&&parseInt(i[2])<parseInt(a[2])?u.warning("您选择的开始时间小于结束时间",{}):(g(),o.open({template:"../partials/dialogue/query_device.html",scope:c,className:"ngdialog-theme-plain"}))};var k=function(e){return e=new Date(e).Format("yyyy-MM-dd hh:mm:ss")};function T(e,t){if(null==e||null==e||""==e)return t;if(-1<e.indexOf("{")&&-1<e.indexOf(":"))try{t=(e=JSON.parse(e))[t]}catch(e){}return t}function x(e,o){var d="";c.tableDataLoading=!0,c.kpiQueryModelObj=e,r.queryDeviceData(e,function(e){if(0==e.code){for(var t in c.tableDataLoading=!1,e.data){for(var i in c.showDeviceData[t]=e.data[t],c.showDeviceData[t].deviceName=o,null!=e.data[t].instance&&"null"!=e.data[t].instance||(c.showDeviceData[t].instance=""),c.selectedDitem.devices)e.data[t].nodeId==c.selectedDitem.devices[i].id&&(c.showDeviceData[t].deviceName=c.selectedDitem.devices[i].label);for(var a in c.selectedDitem.kpis)e.data[t].kpiCode==c.selectedDitem.kpis[a].id&&(c.showDeviceData[t].kpiName=c.selectedDitem.kpis[a].label,d=T(c.selectedDitem.kpis[a].range,e.data[t].value),c.showDeviceData[t].kpiValue=d+c.selectedDitem.kpis[a].unit)}s(function(){var e,t,i,a;c.tableData={name:"",unit:"",data:[]},0!=c.showDeviceData.length&&(e=c.showDeviceData,t={title:"",xData:[],series:{data:[]}},i={name:"",unit:"",data:[]},a={},c.selectedItem.kpiCodes.forEach(function(e){null!=c.selectedDitem.kpisObj[e]&&(t.title=c.selectedDitem.kpisObj[e].name,a[e]=jQuery.extend(!0,{},t))}),e.forEach(function(e){a[e.kpiCode].title=e.kpiName,a[e.kpiCode].xData.push(k(e.arisingTime)),a[e.kpiCode].series.data.push(e.value),i.data.push({name:k(e.arisingTime),value:e.value})}),c.selectedItem.kpiCodes.forEach(function(e){c.$broadcast(Event.ECHARTINFOSINIT,{name:e,option:v(a[e])})}),i.data.reverse(),c.tableData=i),c.$broadcast(Event.DEVICEDATAINIT,{option:[c.showDeviceData]})})}})}t.getAllUnits(function(e){0==e.code&&(c.formatUnits=e.data)}),c.getDeviceByDeviceType=function(e){var t;c.selectedItem.kpiId="",c.selectedItem.nodeId="",e?(c.queryState=!0,t=e,c.selectedItem.nodeIds=[],c.selectedDitem.devices=[],n.getDevicesByCondition({modelId:t},function(e){if(0==e.code){var t=[];for(var i in e.data)t.push(e.data[i].id),e.data[i].visible=!0;c.selectedItem.nodeIds=t,c.selectedDitem.nodeIds=t,c.selectedDitem.devices=e.data,c.selectedItem.domain&&c.getDevices(c.selectedItem.domain)}}),C(e)):c.queryState=!1},c.projectsCustomerList=[],c.customerChange=function(){c.selectedItem.customerId?(c.projectsCustomerList=c.projectsListAll,c.projectsList=c.projectsListAll):(c.projectsCustomerList=[],c.projectsList=[]),c.selectedDitem.modelId||c.selectedItem.projectId||C(301)},c.projectChange=function(){c.selectedDitem.modelId||C(302)},c.getDevices=function(e){if(e){var t=[];for(var i in c.selectedDitem.devices)-1<c.selectedDitem.devices[i].domainPath.indexOf(e)?(t.push(c.selectedDitem.devices[i].id),c.selectedDitem.devices[i].visible=!0):c.selectedDitem.devices[i].visible=!1;c.selectedItem.nodeIds=t,c.selectedDitem.nodeIds=t,c.selectedItem.modelId||c.selectedItem.projectId||c.selectedItem.customerId||C(300)}},c.getselectedDevice=function(e){e?(c.selectedItem.nodeIds=[],c.selectedItem.nodeIds.push(e)):null==e&&(c.selectedItem.nodeIds=c.selectedDitem.nodeIds)},c.getKpi=function(e){e&&0<e.length?(c.selectedItem.kpiCodes=[],c.selectedItem.kpiCodes=e):c.selectedItem.kpiCodes=c.selectedDitem.kpiCodes},c.clearSearch=function(e){"domain"==e?(c.selectedItem.customerId="",c.selectedItem.projectId="",c.selectedItem.modelId="",c.selectedItem.nodeId="",c.selectedDitem.devices=[]):"customers"==e?(c.selectedItem.projectId="",c.selectedItem.modelId="",c.selectedItem.nodeId="",c.selectedDitem.devices=[]):"project"==e&&(c.selectedItem.modelId="",c.selectedItem.nodeId="",c.selectedDitem.devices=[])},c.searchData=function(){var e=c.baseConfig&&c.baseConfig.attrSearchCount?c.baseConfig.attrSearchCount:99999;if(!c.selectedItem.kpiCodes&&0==c.selectedItem.kpiCodes.length)return u.info("测点数量不能为空",{}),void(c.queryState=!1);if(c.selectedItem.kpiId&&c.selectedItem.kpiId.length>e)return u.info("测点数量最多不超过"+e+"个",{}),void(c.queryState=!1);c.ifTables=!0,c.showDeviceData=[];(new Date).getTime();var t=[],i="";if(c.selectedItem.nodeIds&&0<c.selectedItem.nodeIds.length)t=c.selectedItem.nodeIds;else if(c.selectedItem.projectId)t=[c.selectedItem.projectId],i=c.projectsDic[c.selectedItem.projectId].projectName;else if(c.selectedItem.customerId)t=[c.selectedItem.customerId],i=c.customersDic[c.selectedItem.customerId].customerName;else if(c.selectedItem.domain){var a=c.domainListDic[c.selectedItem.domain];t=[a.id],i=a.label}c.selectedItem.startTime&&c.selectedItem.endTime?x({isRealTimeData:!1,startTime:new Date(c.selectedItem.startTime),endTime:new Date(c.selectedItem.endTime),nodeIds:t,kpiCodes:c.selectedItem.kpiCodes,includeInstance:!0},i):x({isRealTimeData:!0,nodeIds:t,kpiCodes:c.selectedItem.kpiCodes,includeInstance:!0},i)},c.cancelRecords=function(){b(),c.queryState=!1,c.projectsList=[]};var j=function(){n.getModels(function(e){0==e.code&&(c.modelListSelect=e.data,function(e){if(0==e.code){for(var t in n.rootModelDic={},e.data){var i=e.data[t];c.routePathNodes[i.parentModelId]||(c.routePathNodes[i.parentModelId]=[]),c.routePathNodes[i.parentModelId].push(i),c.routePathNodes[i.id]||(c.routePathNodes[i.id]=[]),n.rootModelDic[i.id]=i}var a=function e(t){for(var i in c.routePathNodes)if(i==t.id){for(var a in t.nodes=c.routePathNodes[i],t.nodes)e(t.nodes[a]);0==t.nodes.length&&(t.nodes=null)}};for(var o in a(n.rootModel),c.routePathNodes)if(o!=n.rootModel.id&&!n.rootModelDic[o])for(var t in c.routePathNodes[o])a(c.routePathNodes[o][t]),n.rootModel.nodes||(n.rootModel.nodes=[]),c.routePathNodes[o][t].parentModelId=n.rootModel.id,n.rootModel.nodes.push(c.routePathNodes[o][t]);n.rootModelDic[n.rootModel.id]=n.rootModel,c.rootModelDic=n.rootModelDic,c.rootModel=n.rootModel}}(e))})};function C(s){if(c.selectedItem.kpiCodes=[],c.selectedDitem.kpis=[],c.selectedDitem.kpisObj={},c.rootModelDic[s]||(c.rootModelDic[s]={}),c.rootModelDic[s].kpiloaded)for(var e in c.selectedDitem.kpis=c.rootModelDic[s].kpis,c.selectedDitem.kpiCodes=c.rootModelDic[s].kpiCodes,c.selectedItem.kpiCodes=c.rootModelDic[s].kpiCodes,c.rootModelDic[s].kpis)c.selectedDitem.kpisObj[c.rootModelDic[s].kpis[e].id]=c.rootModelDic[s].kpis[e];else n.getDataItemsByModelId(s,function(t){if(0==t.code){var e=/\{|\[.*\}|\]/,i=[];for(var a in t.data)if(i.push(t.data[a].id),c.selectedDitem.kpisObj[t.data[a].id]=t.data[a],c.formatUnits.forEach(function(e){e.unitCode==t.data[a].unit&&(t.data[a].unit=e.unitName)}),t.data[a].range){var o=e.test(t.data[a].range),d=[];if(o)try{d=o?JSON.parse(t.data[a].range):[]}catch(e){}(t.data[a].rangeAry=d)instanceof Array?2==(t.data[a].rangeAry=d).length&&(t.data[a].min=d[0],t.data[a].max=d[1]):d instanceof Object&&(t.data[a].rangeObj=d)}c.rootModelDic[s].kpiloaded=!0,c.rootModelDic[s].kpis=t.data,c.selectedDitem.kpis=t.data,c.rootModelDic[s].kpiCodes=i,c.selectedDitem.kpiCodes=i,c.selectedItem.kpiCodes=i}})}c.customersList,c.customersDic={};c.projectsList,c.projectsListAll,c.projectsDic={},c.queryProject=function(){I.findProjectsByCondition({},function(e){if(0==e.code){e.data.forEach(function(e){(c.projectsDic[e.id]=e).text=e.projectName});e.data.unshift({text:"请选择",value:"-1"}),c.projectsListAll=e.data}})},c.activeListTab="tab1";var M=function(){var i;i=c.baseConfig&&c.baseConfig.attrSearchCount?c.baseConfig.attrSearchCount:99999,$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){var t=$(e.target).attr("name");$(e.target).text(),t&&("tab2"==(c.activeListTab=t)&&(""==c.selectedItem.nodeId||null==c.selectedItem.nodeId?u.info("请选择一个设备",{}):c.selectedItem.kpiId.length<=0?u.info("请选择一个测点",{}):c.selectedItem.kpiId.length>i&&u.info("测点最多不超过"+i+"个",{})),c.$apply(),s(function(){$(".chart").resize()},300))}),b(),c.kpiData={idArray:[],unitArray:[],labelArray:[],granularityArray:[],granularityUnitArray:[]},function(){var i=function(e){c.domainListTree=e.domainListTree,c.domainListDic=e.domainListDic};if(c.menuitems.isloaded)c.baseConfig.extendDomain?n.getExtendDomainsByFilter({},i):d.queryDomainTree(l.user.userID,i);else var a=c.$watch("menuitems",function(e,t){c.menuitems.isloaded&&(c.baseConfig.extendDomain?n.getExtendDomainsByFilter({},i):d.queryDomainTree(l.user.userID,i),a())},!0)}(),p.findCustomersByCondition({},function(e){c.customersDic=e.customerDic,e.data.forEach(function(e){e.text=e.customerName}),e.data.unshift({text:"请选择",value:"-1"}),c.customersList=e.data}),c.queryProject(),n.getRootModel(function(e){0==e.code&&(n.rootModel=e.data,j())}),s(function(){c.$broadcast(Event.DEVICEDATAINIT,{option:[]})})};l.user.isAuthenticated?M():c.$on("loginStatusChanged",function(e,t){l.user.isAuthenticated&&M()})}]),e.initController("statisticsDeviceDataCtrl",["$scope","$filter","userInitService","unitService","userDomainService","resourceUIService","$location","$routeParams","$timeout","kpiDataService","userLoginUIService","Info","growl",function(n,a,e,t,i,r,o,d,s,c,l,m,u){n.domainListDic={},n.domainListTree={},n.rootModel={},n.rootModelDic={},n.routePathNodes={},n.modelListSelect,n.chartData={xData:[],series:{name:"",type:"line",data:[]}};var p=g.init($("#linedataview")[0]);function I(){n.selectedItem={nodeType:"",domain:"",nodeIds:[],kpiCodes:[],kpiId:"",statisticType:"",statisticTimeType:"",startTime:"",endTime:"",kpilabel:""},n.selectedDitem.label=[],n.selectedDitem.kpis=[]}n.selectedDitem={label:[],kpisObj:{}},n.statiMethod=[{smId:"max",smName:"最大值"},{smId:"min",smName:"最小值"},{smId:"avg",smName:"平均值"},{smId:"sum",smName:"求和"}],n.copy={devicesData:[],nodeIds:[]},n.showDeviceData=[],n.ifTables=!1,n.history="",t.getAllUnits(function(e){0==e.code&&(n.formatUnits=e.data)});var f=function(o){return{title:{text:"",subtext:"",x:"center",y:"top"},tooltip:{trigger:"axis",formatter:function(e){var t=(e=e[0]).name,i=e.value||0==e.value?e.value:"",a=o.series.name?o.series.name:"";return t?t+"<br>"+a+" : "+i:"没有数据"}},xAxis:[{type:"category",boundaryGap:!1,data:o.xData}],yAxis:[{type:"value",axisLabel:{formatter:"{value}"}}],series:o.series}};function D(e){c.queryDeviceData(e,function(e){var t,i;0==e.code&&(n.ifTables=!0,0<jQuery("#devicecollapse").find(".fa.fa-plus").length&&jQuery.AdminLTE.boxWidget.collapse(jQuery("#devicecollapse")),t=e.data,i={xData:[],series:{name:"",type:"line",data:[]}},t.forEach(function(t){"hour"==n.selectedItem.statisticTimeType?i.xData.push(a("date")(new Date(t.timeflag),"yyyy-MM-dd HH:mm:ss")):"day"==n.selectedItem.statisticTimeType&&i.xData.push(a("date")(new Date(t.timeflag),"yyyy-MM-dd")),i.series.data.push(t.value),n.selectedDitem.kpis.forEach(function(e){e.id==t.kpiCode&&(i.series.name=e.label,e.rangeObj&&e.rangeObj)})}),p.setOption(f(i)),s(function(){window.onresize=function(){p.resize()}}),n.chartData=i)})}function v(){i.queryDomainTree(l.user.userID,function(e){var t=[],i={parentID:"",domainPath:"",name:"",description:"",domains:e.data};t.push(i);var a=function e(t){if(t.domains){for(var i in t.nodes=[],t.domains)t.nodes.push(e(t.domains[i]));t.tags=[t.nodes.length]}return 1==t.belong?t.state={checked:!0}:t.state={checked:!1},t.text=t.name,t.icon="ion ion-ios-color-filter",(n.domainListDic[t.domainPath]=t).domainID?n.domainListDic[t.domainID]=t:n.domainListDic[0]=t,t}(t[0]);n.domainListTree=a.nodes})}n.getDeviceByDeviceType=function(e){var t,i;t=e,n.selectedItem.domain="",n.selectedItem.nodeIds=[],n.selectedDitem.label=[],r.getDevicesByCondition({modelId:t},function(e){if(0==e.code){var t=[];for(var i in n.selectedDitem.label=e.data,n.copy.devicesData=e.data,e.data)t.push(e.data[i].id);n.copy.nodeIds=t}}),i=e,n.selectedItem.kpiCodes=[],r.getDataItemsByModelId(i,function(t){if(0==t.code){var e=/\{|\[.*\}|\]/;for(var i in t.data)if(n.formatUnits.forEach(function(e){e.unitCode==t.data[i].unit&&(t.data[i].unit=e.unitName)}),t.data[i].range){var a=e.test(t.data[i].range),o=[];if(a)try{o=a?JSON.parse(t.data[i].range):[]}catch(e){}(t.data[i].rangeAry=o)instanceof Array?2==(t.data[i].rangeAry=o).length&&(t.data[i].min=o[0],t.data[i].max=o[1]):o instanceof Object&&(t.data[i].rangeObj=o)}n.selectedDitem.kpis=t.data}})},n.getDevices=function(e){var t=[],i=[];for(var a in n.copy.devicesData)-1<n.copy.devicesData[a].domainPath.indexOf(e)&&(t.push(n.copy.devicesData[a].id),i.push(n.copy.devicesData[a]));n.selectedItem.nodeIds=t,n.copy.nodeIds=t,n.selectedDitem.label=i},n.getselectedDevice=function(e){e?(n.selectedItem.nodeIds=[],n.selectedItem.nodeIds.push(e)):null==e&&(n.selectedItem.nodeIds=[])},n.getKpi=function(e){if(null==(n.kpiId=e))n.selectedItem.kpilabel="";else for(var t in n.selectedDitem.kpis)if(n.selectedDitem.kpis[t].id==e){n.selectedItem.kpilabel=n.selectedDitem.kpis[t].label;break}},n.searchData=function(){n.showDeviceData=[],n.selectedItem.kpiCodes=[];(new Date).getTime();var e=new Date(n.selectedItem.startTime).getTime(),t=new Date(n.selectedItem.endTime).getTime();if(""==n.selectedItem.nodeType||null==n.selectedItem.nodeType)return u.info("请选择设备模板再进行查询",{}),void(n.ifTables=!1);if(""==n.kpiId||null==n.kpiId||null==n.kpiId||0==n.selectedItem.nodeIds.length)return u.info("请选择完整必选项",{}),void(n.ifTables=!1);if(n.selectedItem.kpiCodes.push(n.kpiId),!(n.selectedItem.endTime&&n.selectedItem.startTime&&n.selectedItem.statisticType&&n.selectedItem.statisticTimeType))return u.info("请选择完整必选项",{}),void(n.ifTables=!1);if(n.selectedItem.startTime&&n.selectedItem.endTime){if(2592e6<t-e)return u.info("时间选择范围请控制在30天之内",{}),void(n.ifTables=!1);if(t-e<0)return u.info("请正确输入时间范围",{}),void(n.ifTables=!1);D({isRealTimeData:!1,startTime:n.selectedItem.startTime,endTime:n.selectedItem.endTime,nodeIds:n.selectedItem.nodeIds,kpiCodes:n.selectedItem.kpiCodes,statisticTimeType:n.selectedItem.statisticTimeType,includeInstance:!0,statisticType:n.selectedItem.statisticType})}},n.cancelRecords=function(){I(),n.ifTables=!1},r.rootModel?(n.rootModel=r.rootModel,r.getModels(function(e){if(0==e.code){r.rootModelDic={};var t=e.data;for(var i in t){var a=t[i];a.text=a.label,n.routePathNodes[a.parentModelId]||(n.routePathNodes[a.parentModelId]=[]),n.routePathNodes[a.parentModelId].push(a),n.routePathNodes[a.id]||(n.routePathNodes[a.id]=[]);var o=jQuery.extend(!0,{},a);r.rootModelDic[o.id]=o}var d=function e(t){for(var i in n.routePathNodes)if(i==t.id){for(var a in t.nodes=n.routePathNodes[i],t.nodes)e(t.nodes[a]);0==t.nodes.length&&(t.nodes=null)}};for(var s in d(r.rootModel),n.routePathNodes)if(s!=r.rootModel.id&&!r.rootModelDic[s])for(var i in n.routePathNodes[s])d(n.routePathNodes[s][i]),r.rootModel.nodes||(r.rootModel.nodes=[]),r.rootModel.nodes.push(n.routePathNodes[s][i]);r.rootModelDic[r.rootModel.id]=r.rootModel,n.rootModel=r.rootModel,n.rootModelDic=r.rootModelDic}}),v()):r.getRootModel(function(e){0==e.code&&(r.rootModel=e.data,v())});I()}])});
//# sourceMappingURL=../../../map/app-oc/js/controllers/inspection-records-ctrl.js.map
