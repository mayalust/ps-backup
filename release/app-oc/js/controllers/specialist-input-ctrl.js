define(["controllers/controllers","Array"],function(controllers){"use strict";controllers.initController("specialistInputCtrl",["$scope","$q","$rootScope","$location","$routeParams","$timeout","kqiManagerUIService","userRoleUIService","resourceUIService","userLoginUIService","Info","growl","userEnterpriseService","viewFlexService","userDomainService","$window","freeboardservice","dialogue","ngDialog","specialListService",function(scope,q,rootScope,$location,$routeParams,timeout,kqiManagerUIService,userRoleUIService,resourceUIService,userLoginUIService,Info,growl,userEnterpriseService,viewFlexService,userDomainService,window,freeboardservice,dialogue,ngDialog,specialListService){var TEXT={SUBMIT:"确定",CANCEL:"取消"},currentGraph={},kqiModel,kqiModelId=parseInt($routeParams.id),pos=$routeParams.pos,timePeriod=[{id:0,label:"秒"},{id:1,label:"分钟"},{id:2,label:"小时"},{id:3,label:"天"}];scope.thumbs=[{label:"灰色背景",url:"../app-freeboard/images/dataModel/dataModel1.jpg",color:"#fff"},{label:"水滴背景",url:"../app-freeboard/images/dataModel/dataModel2.jpg",color:"#fff"},{label:"白色背景",url:"../app-freeboard/images/dataModel/dataModel3.jpg",color:"#000"}],scope.kqiModelThumb=scope.thumbs[0].url;var expertChange=function(){console.log(this.id)};scope.expertModelTypes=specialListService(expertChange),scope.expertModelTypes.shift(),scope.instance={},scope.$watch("currentNav",function(e,o,i){if(3==e){var n=function(e){var o={layout:e.layout,setting:e.setting},i=new freeboardservice.replaceCiKpi(o,function(){console.log(i),timeout(function(){scope.instance.setMode(!0),scope.instance.renderLayout(i,null,scope)})})};if(currentGraph.viewId){scope.insText="编辑分析视图";var r=currentGraph.content;n(JSON.parse(r))}else{scope.insText="导出到分析视图";var t={layout:{type:"column",children:[{label:"高级视图",type:"advanceEchart",source:"ADVANCEECHART",parameters:{theme:"default"},style:{margin:"auto",width:"100%",height:"600px"},advance:{expression:"expression = "+("{\n            on : {\n              init : "+("function(event){\n            var target = event.target;\n            var global = event.global;\n            var inx = 0;\n            var execute = "+scope.expression.toString()+"\n            console.log('execute', execute);\n            var option = {\n              title: {\n                text: \""+scope.kqiModelName+"\"\n              },\n              tooltip: {               trigger: 'axis'              },\n              legend: {\n                data: execute().map(function(elem){return elem.name;})\n              },\n              xAxis: {\n                data: execute()[0].data.map(function(elem){ inx++;return inx; })\n              },\n              yAxis: {},\n              series: execute().map(function(elem){ elem.type = elem.type || 'line'; return elem;})\n            };\n            target.render(option);\n          }\n")+"\n            }\n          }\n")}}],col:12},setting:'{\n  "theme": "default"\n}'};n(t),currentGraph={viewTitle:scope.kqiModelName+"(专家模型)",viewType:"designView",content:JSON.stringify(t)}}}});var runEval=function runEval(expression){var fun;try{fun=eval("("+expression+")")}catch(e){console.log(e)}return fun},getKqiModels=function(o){kqiManagerUIService.getKqiModels(function(e){0==e.code&&o(e.data)})},saveKqiModel=function(e,o){kqiManagerUIService.saveKqiModel(e,function(e){0==e.code&&o(e.data)})},deleteKqiModel=function(e,o){kqiManagerUIService.deleteKqiModel(e,function(e){0==e.code&&o(e.data)})},getKqiModelById=function(e,o){kqiManagerUIService.getKqiModelById(e,function(e){0==e.code&&o(e.data)})};scope.a="aba",scope.navigation=[{id:0,label:"基础设置"},{id:1,label:"公式输入"},{id:3,label:"图形展示"}],scope.createGraphView=function(){if(kqiModelId){var o=function(){window.open("/app-freeboard/index.html#/editor/view/editor/"+currentGraph.viewId+"/0")};currentGraph.viewId?o():(currentGraph.template={resourceType:"kqiModel",resourceId:kqiModelId},viewFlexService.addView(currentGraph,function(e){0==e.code&&(currentGraph=e.data||{},scope.insText="编辑仪表板",o())}))}else growl.error("请先保存您的专家模版")},scope.currentNav=scope.navigation[0].id,scope.navigateClick=function(e){scope.currentNav=e},scope.saveSpecialist=function(){if(scope.kqiModelName||(growl.error("请填写视图名称."),0)){var i={};i.expression=scope.expression,i.simulate=scope.simulate,i.variables=scope.variables,i.thumb=scope.kqiModelThumb,i.fontcolor=scope.thumbs.find(function(e){return e.url==scope.kqiModelThumb}).color,i.kqiModelNameEn=scope.kqiModelNameEn;var o=function(e){var o=(kqiModel=e)||{};o.label=scope.kqiModelName,console.log(JSON.stringify(i,null,2)),o.viewContent=JSON.stringify(i),saveKqiModel(o,function(e){kqiModelId?growl.success("修改专家模型成功。"):growl.success("保存专家模型成功。"),$location.path("specialist/input/"+e.id)})};kqiModelId?getKqiModelById(kqiModelId,function(e){o(e)}):o()}},scope.addSimulate=function(){scope.simulate.push({})},scope.removeSim=function(i){scope.simulate.$remove(function(e,o){return i==o})},scope.runKqi=function(e){var o={};for(var i in e)o[i]=e[i].split(",").map(function(e){return parseInt(e)});var n,r=runEval(scope.expression);try{n=r(o)}catch(e){console.log(e)}finally{n=n||""}return n};var init=function(){var o=function(i){if(i){scope.kqiModelName=i.label,scope.expertModelType=i.expertModelType;var e=JSON.parse(i.viewContent);scope.kqiModelNameEn=e.kqiModelNameEn,scope.expression=e.expression,scope.simulate=e.simulate,scope.variables=e.variables,scope.kqiModelThumb=e.thumb,viewFlexService.getManagedViewsByTypeAndRole("designView",function(e){if(0==e.code){var o=e.data.find(function(e){var o=!1;return e.template&&"kqiModel"==e.template.resourceType&&(o=e.template.resourceId==i.id),o});o?viewFlexService.getViewById(o.viewId,function(e){0==e.code&&(currentGraph=e.data||{},scope.currentNav=pos?scope.navigation[pos].id:scope.navigation[0].id)}):scope.currentNav=pos?scope.navigation[pos].id:scope.navigation[0].id}})}else scope.currentNav=pos?scope.navigation[pos].id:scope.navigation[0].id,scope.expertModelType=0,scope.expression='function(){\n    return [{\n        name : "专家模型",\n        data : [5,7,3,5,8,2,4,7]\n    }]\n}',scope.simulate=[],scope.variables=[]};kqiModelId?getKqiModelById(kqiModelId,function(e){o(e)}):o()};init()}])});
//# sourceMappingURL=../../../map/app-oc/js/controllers/specialist-input-ctrl.js.map
