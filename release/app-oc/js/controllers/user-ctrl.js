define(["controllers/controllers","bootstrap-dialog"],function(controllers,BootstrapDialog){"use strict";controllers.initController("UserListCtrl",["$scope","ngDialog","userInitService","userLoginUIService","userEnterpriseService","userUIService","growl","userRoleUIService","userFunctionService","userDomainService","marketplaceUIService",function(d,r,t,l,e,u,c,p,f,m,a){d.userSearch={},d.domainListTree=[],d.domainUser="",d.domainListDic={},d.tab="user",d.userManager=l.user,d.queryDitem={state:""};var i=function(){$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){var r=$(e.target).attr("name");"user"==r?(d.addUserName="新建用户",d.$broadcast(Event.USERINFOSINIT,d.userGridData)):"role"==r&&(d.addUserName="新建角色",d.$broadcast(Event.CURRENTINFOSINIT,d.currentGridData)),d.tab=r,d.$apply()})};d.associateUserList="",d.functionRoleName="",d.functionData="",d.roleId="",d.roleArr={roleName:"",description:"",domainID:"",domainPath:"",roleID:""};var n=function(){m.queryDomainTree(l.user.userID,function(e){d.domainListTree=e.domainListTree,d.domainListDic=e.domainListDic,d.getDBdata({})})};d.dialog=function(e){d.treeUserId=e,r.open({template:"partials/roleAllot.html",showClose:!1,controller:"RoleAllotCtrl",bodyClassName:"bg-transparent",width:"600px",scope:d,closeByDocument:!1,appendClassName:"ngdialog-updata-bg",className:"ngdialog-theme-plain"})},d.dialogFun=function(e){d.roleFunction=e,d.functionRoleName="1010",r.open({template:"partials/functionAllot.html",showClose:!1,controller:"FunctionAllotCtrl",width:"600px",scope:d,closeByDocument:!1,appendClassName:"ngdialog-updata-bg",className:"ngdialog-theme-plain"})},d.dialogUser=function(e){d.roleUser=e,r.open({template:"partials/userAllot.html",showClose:!1,controller:"userAllotCtrl",width:"600px",scope:d,closeByDocument:!1,appendClassName:"ngdialog-updata-bg",className:"ngdialog-theme-plain"})},d.functionGridData={columns:[{title:"操作",orderable:!1,data:"option"},{title:"名称",data:"name"},{title:"描述",data:"description"}],columnDefs:[{targets:0,data:"option",render:function(e,r,a){return'<i class="fa fa-plus-circle" id="circle-1" style="color:#1bb6e1;"></i>'}}]},d.domainGridData={columns:[{title:"",orderable:!1,data:"option"},{title:"名称",data:"name"},{title:"描述",data:"description"}],columnDefs:[{targets:0,data:"option",render:function(e,r,a){return'<i class="fa fa-plus-circle" id="circle-1" style="color:#1bb6e1;"></i>'}}]},d.userGridData={},d.currentGridData={},d.userRoleOdd=function(){var e=d.functionRoleName;if("001"==e){d.userInfoId=[];var r=d.currentGridData.data;for(var a in r)1003==r[a].domainID&&d.userInfoId.push(r[a].roleID);p.addRole2User(d.roleId,d.userInfoId,function(e){0==e.code?(c.success("角色分配成功",{}),d.functionRoleName="0"):c.warning("角色分配失败!",{})})}else if("002"==e){d.userInfoId=[];r=d.userGridData.data;for(var a in r)1001==r[a].check&&d.userInfoId.push(r[a].userID);p.addUser2Role(d.userInfoId,d.roleId,function(e){0==e.code?(c.success("用户分配成功",{}),d.functionRoleName=""):c.warning("用户分配失败!",{})})}else if("003"==e){for(var t in d.userInfo=[],d.domainGridData.baseNode)if(d.domainGridData.baseNode[t])for(var i in d.domainGridData.baseList)t==d.domainGridData.baseList[i].domainID&&d.userInfo.push(d.domainGridData.baseList[i]);m.addDomain2User(d.userInfo,d.roleId,function(e){0==e.code?(c.success("域分配成功",{}),d.functionRoleName=""):c.warning("域分配失败!",{})})}else if("1010"==e){d.userInfo=[];var n=$.fn.zTree.getZTreeObj("roleTree").getCheckedNodes(!0);if(n){for(var t in n)d.userInfo.push(n[t].functionCode);f.addFunction2Role(d.roleFunction.roleID,d.userInfo,function(e){0==e.code?(c.success("功能分配成功",{}),d.functionRoleName=""):c.warning("功能分配失败!",{}),d.closeDialog()})}}},d.allClick=function(){var e=d.functionRoleName;"002"==e?$("input[name='allBox_002']").is(":checked")?angular.forEach(d.associateUserList,function(e,r){2001!=e.manageCheck&&(e.isEdit="1001")}):angular.forEach(d.associateUserList,function(e,r){2001!=e.manageCheck&&(e.isEdit="")}):"001"==e&&($("input[name='allBox_001']").is(":checked")?angular.forEach(d.userAllRoleList,function(e,r){e.domainID="1003"}):angular.forEach(d.userAllRoleList,function(e,r){102!=e.roleID&&(e.domainID="")}))},d.functionOdd=function(){d.userInfo=[],$("input[name='allFun']").each(function(){$(this).is(":checked")&&($(this).val()+",",d.userInfo.push($(this).val()))}),p.addUser2Role(d.userInfo,d.roleId,function(e){0==e.code?(c.success("角色分配成功",{}),d.functionRoleName=""):c.warning("角色分配失败!",{})})},d.addUser=function(){r.open({template:"addUser",showClose:!1,width:"600px",scope:d,appendClassName:"ngdialog-updata-bg",className:"ngdialog-theme-plain"})},d.closeTable=function(){d.functionRoleName="0"},d.doActiveHanddler=function(e,r,a){t.deleteInitUser(e.userID,function(e){0==e.code&&("del"==a&&c.warning("删除用户成功!",{}),r(!0))})},d.doActivePwd=function(e,r,a){""==e.emailAddress||null==e.emailAddress?u.sendSMSPassword(e.mobilePhone,function(e){0==e.code&&("pwd"==a&&c.warning("重置密码成功,请查收",{}),r(!0))}):u.sendModifyPassword(e.emailAddress,function(e){0==e.code&&("pwd"==a&&c.warning("重置密码成功,请查收",{}),r(!0))})},d.doAction=function(e,t,a){if("save"==e)if(null==t.userID)if(3==t.userType||2==t.userType){var r="";for(var i in d.domainUser)if(t.domainPath==d.domainUser[i].domainPath){r=d.domainUser[i];break}"email"==t.userEmalStatus?(t.emailAddress=t.userEmail,t.mobilePhone=""):"phone"==t.userEmalStatus&&(t.mobilePhone=t.userEmail,t.emailAddress=""),t.userName=$.trim(t.userName),u.enterpriseUserRegister(t,d.domainListDic[r.domainID],[],function(e){if(0==e.code){for(var r in d.userGridData.data){if(null==d.userGridData.data[r].userID){d.userGridData.data[r]=e.data,3==e.data.userType?d.userGridData.data[r].userTypeLabel="管理员":2==e.data.userType?d.userGridData.data[r].userTypeLabel="普通用户":4==e.data.userType&&(d.userGridData.data[r].userTypeLabel="终端用户"),d.userGridData.data[r].isEdit=0,null==d.userGridData.data[r].emailAddress||""==d.userGridData.data[r].emailAddress?d.userGridData.data[r].userEmail=d.userGridData.data[r].mobilePhone:d.userGridData.data[r].userEmail=d.userGridData.data[r].emailAddress;break}null==d.userGridData.data[r].emailAddress||""==d.userGridData.data[r].emailAddress?d.userGridData.data[r].userEmail=d.userGridData.data[r].mobilePhone:d.userGridData.data[r].userEmail=d.userGridData.data[r].emailAddress}d.userGridData.addData="marking",a(e.data),c.success("新增用户成功",{})}else a(!1)})}else 4==t.userType&&("email"==t.userEmalStatus?(t.emailAddress=t.userEmail,t.mobilePhone=""):"phone"==t.userEmalStatus&&(t.mobilePhone=t.userEmail,t.emailAddress=""),u.enterpriseIndividualRegister(t,l.user.enterprise,function(e){if(0==e.code){for(var r in d.userGridData.data)if(null==d.userGridData.data[r].userID){d.userGridData.data[r]=e.data,2==e.data.userType?d.userGridData.data[r].userTypeLabel="管理员":3==e.data.userType?d.userGridData.data[r].userTypeLabel="普通用户":4==e.data.userType&&(d.userGridData.data[r].userTypeLabel="终端用户"),d.userGridData.data[r].isEdit=0,null==d.userGridData.data[r].emailAddress||""==d.userGridData.data[r].emailAddress?d.userGridData.data[r].userEmail=d.userGridData.data[r].mobilePhone:d.userGridData.data[r].userEmail=d.userGridData.data[r].emailAddress;break}d.userGridData.addData="marking",c.success("新增用户成功",{}),a(e.data)}else a(!1)}));else t.userID&&(t.userName=$.trim(t.userName),u.modifyUser(t,function(e){if(0==e.code){for(var r in d.userGridData.data)if(t.userID==d.userGridData.data[r].userID){d.userGridData.data[r]=e.data,3==d.userGridData.data[r].userType?d.userGridData.data[r].userTypeLabel="管理员":2==d.userGridData.data[r].userType?d.userGridData.data[r].userTypeLabel="普通用户":4==d.userGridData.data[r].userType&&(d.userGridData.data[r].userTypeLabel="终端用户"),d.userGridData.data[r].isEdit=0,null==d.userGridData.data[r].emailAddress||""==d.userGridData.data[r].emailAddress?d.userGridData.data[r].userEmail=d.userGridData.data[r].mobilePhone:d.userGridData.data[r].userEmail=d.userGridData.data[r].emailAddress;break}c.success("修改用户成功",{}),a(!0)}else a(!1)}));else if("delete"==e){if(l.user.userID==t.userID)return void c.warning("不能操作自己账号!",{});BootstrapDialog.show({title:"提示",closable:!1,message:"确认要删除该用户",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){d.doActiveHanddler(t,a,"del"),e.close()}},{label:"取消",action:function(e){e.close()}}]})}else if("modifyRole"==e)d.roleArr.roleName=stripscript(t.roleName),d.roleArr.description=stripscript(t.description),d.roleArr.roleID=t.roleID,p.modifyRole(d.roleArr,function(e){if(0==e.code){for(var r in d.currentGridData.data)d.currentGridData.data[r].isEdit=0,d.currentGridData.data[r].roleID==t.roleID&&(d.currentGridData.data[r]=e.data);c.success("修改角色成功",{}),a(!0)}else c.warning("修改角色失败!",{})});else if("resetPwd"==e){if(l.user.userID==t.userID)return void c.warning("不能重置自己密码!",{});BootstrapDialog.show({title:"提示",closable:!1,message:"是否要重置该用户密码",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){d.doActivePwd(t,a,"pwd"),e.close()}},{label:"取消",action:function(e){e.close()}}]})}else if("addRole"==e)if(null==t.roleID){for(var n in d.currentGridData.data)if(null!=d.currentGridData.data[n].roleID&&d.currentGridData.data[n].roleName==t.roleName)return void c.warning("角色名称已存在!",{});d.roleArr.domainID=l.user.domainID,d.roleArr.domainPath=l.user.domainPath,d.roleArr.roleName=$.trim(t.roleName),d.roleArr.description=$.trim(t.description),p.addRole(d.roleArr,function(e){if(0==e.code){for(var r in d.currentGridData.data)if(null==d.currentGridData.data[r].roleId){d.currentGridData.data[r]=e.data;break}c.success("新增角色成功",{}),a(e.data)}else a(!1)})}else{for(var n in d.currentGridData.data)if(d.currentGridData.data[n].roleID!=t.roleID&&d.currentGridData.data[n].roleName==t.roleName)return void c.warning("角色名称已存在!",{});d.roleArr.roleID=t.roleID,d.roleArr.roleName=$.trim(t.roleName),d.roleArr.description=$.trim(t.description),p.modifyRole(d.roleArr,function(e){if(0==e.code){for(var r in d.currentGridData.data)d.currentGridData.data[r].roleID==t.roleID&&(d.currentGridData.data[r]=e.data);a(!0),c.success("修改角色成功",{})}else a(!1)})}else if("allotUserRole"==e)p.getAssociateRole2User({roleID:t.roleID},function(e){if(0==e.code)for(var r in d.functionRoleName="002",d.roleId=t.roleID,d.userGridData.data){for(var a in d.userGridData.data[r].check="",null==d.userGridData.data[r].userID&&d.userGridData.data.splice(r,1),e.data)d.userGridData.data[r].userID==e.data[a].userID&&(d.userGridData.data[r].check=1001);d.$broadcast(Event.CURRENTINFOSINIT+"_userRole",d.userGridData)}});else if("domainUserRole"==e){if(l.user.userID==t.userID)return void c.warning("不能操作自己账号!",{});d.roleId=t.userID,d.functionRoleName="003";var o=[],s=function(e,r){if(e.domains){for(var a in e.nodes=[],e.domains)e.nodes.push(s(e.domains[a],r));e.tags=[e.nodes.length]}return 1==e.belong?(e.domainPath==t.domainPath?e.state={disabled:!0,expanded:!0,checked:!0}:e.state={expanded:!0,checked:!0},r[e.domainID]=!0):(e.state={expanded:!0,checked:!1},r[e.domainID]=!1),e.text=e.name,""!=e.name&&o.push(e),e};m.queryDomainTreeByUser(t.userID,function(e){if(0==e.code){var r={},a={parentID:"",domainPath:"",name:"",description:"",domains:e.data};d.functionData=a;var t=s(a,r);d.domainGridData.data=a.domains,d.domainGridData.treeData=t.nodes,d.domainGridData.baseNode=r,d.domainGridData.baseList=o,d.$broadcast(Event.DOMAININFOSINIT,d.domainGridData)}}),$("html,body").animate({scrollTop:1e3},500)}else if("roleUserRole"==e){if(l.user.userID==t.userID)return void c.warning("不能操作自己账号!",{});p.queryRoleByUser(t.userID,function(e){if(0==e.code){for(var r in d.functionRoleName="001",d.roleId=t.userID,d.currentGridData.data){for(var a in d.currentGridData.data[r].domainID="",e.data)d.currentGridData.data[r].roleID==e.data[a].roleID&&(d.currentGridData.data[r].domainID=1003);d.$broadcast(Event.CURRENTINFOSINIT+"_roleUser",d.currentGridData)}$("html,body").animate({scrollTop:1e3},500)}})}else if("funRole"==e){d.roleId=t.roleID,d.treeData=[],d.functionRoleName="1010";s=function(e,r){if(e.function)for(var a in e.nodes=[],e.function)e.nodes.push(s(e.function[a],r));return e.id=e.functionCode,e.pId=e.parentCode,e.open=!0,1==e.belong&&(e.checked=!0),e.name&&d.treeData.push(e),e};1==l.user.userID||100!=t.roleID&&102!=t.roleID&&1e3!=t.roleID&&101!=t.roleID&&103!=t.roleID?(d.functionGridData.statusCheck=!0,f.queryAllFunctionByUser(l.user.userID,t.roleID,function(e){if(0==e.code&&0<e.data.length){var r={parentID:"",domainPath:"",name:"",description:"",function:e.data};d.functionData=r;s(r,{});d.functionGridData.data=d.treeData,d.functionGridData.setting={view:{showIcon:!1},check:{enable:!0},data:{simpleData:{enable:!0}}},d.$broadcast(Event.FUNCTIONINFOSINIT+"_ztree",d.functionGridData),$("html,body").animate({scrollTop:1e3},500)}})):(d.functionGridData.statusCheck=!1,f.queryFunction2Role(t.roleID,function(e){if(0==e.code&&0<e.data.length){var r={parentID:"",domainPath:"",name:"",description:"",function:e.data};s(r,{});d.functionGridData.data=d.treeData,d.functionGridData.setting={view:{showIcon:!1},data:{simpleData:{enable:!0}}},d.$broadcast(Event.FUNCTIONINFOSINIT+"_ztree",d.functionGridData),$("html,body").animate({scrollTop:1e3},500)}}))}else if("deleteRole"==e){if(102==t.roleID||100==t.roleID||101==t.roleID||2e3==t.roleID||2001==t.roleID)return void c.warning("此角色不能删除!",{});BootstrapDialog.show({title:"提示",closable:!1,message:"确认要删除该角色？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){d.delectRole={roleID:t.roleID},p.deleteRole(d.delectRole,function(e){0==e.code?(c.warning("删除角色成功",{}),d.functionRoleName="0",a(!0)):c.warning("删除角色失败",{})}),e.close()}},{label:"取消",action:function(e){e.close()}}]})}},d.getDBdata=function(){e.queryEnterpriseUser(function(e){if(0==e.code){for(var r in e.data){var a=e.data[r];a.isEdit=0,3==a.userType?a.userTypeLabel="管理员":2==a.userType?a.userTypeLabel="普通用户":4==a.userType&&(a.userTypeLabel="终端用户"),null==a.emailAddress||""==a.emailAddress?a.userEmail=a.mobilePhone:a.userEmail=a.emailAddress}d.userGridData.data=e.data,d.$broadcast(Event.USERINFOSINIT,d.userGridData)}}),e.queryEnterpriseRole(function(e){if(0==e.code){for(var r in e.data)e.data[r]&&""!=e.data[r]&&null!=e.data[r]||e.data.splice(r,1);d.currentGridData.data=e.data}}),m.queryDomainByUser(l.user.userID,function(e){0==e.code&&(d.domainUser=e.data)})},l.user.isAuthenticated?(i(),n()):d.$on("loginStatusChanged",function(e,r){l.user.isAuthenticated&&(i(),n())})}]),controllers.initController("FunctionAllotCtrl",["$scope","$rootScope","ngDialog","$routeParams","userInitService","userLoginUIService","userEnterpriseService","userUIService","growl","userRoleUIService","userFunctionService","userDomainService",function(i,e,r,a,t,n,o,s,d,l,u,c){i.role=i.roleFunction;var p=i.roleFunction;if(i.treeData=[],i.role){var f=function e(r,a){if(r.function)for(var t in r.nodes=[],r.function)r.nodes.push(e(r.function[t],a));return r.id=r.functionCode,r.pId=r.parentCode,1==r.belong&&(r.checked=!0),r.name&&i.treeData.push(r),r};1==n.user.userID||100!=p.roleID&&102!=p.roleID&&1e3!=p.roleID&&101!=p.roleID&&103!=p.roleID?(i.functionGridData.statusCheck=!0,u.queryAllFunctionByUser(n.user.userID,p.roleID,function(e){if(0==e.code&&0<e.data.length){var r={parentID:"",domainPath:"",name:"",description:"",function:e.data};i.functionData=r;f(r,{});i.functionGridData.data=i.treeData,i.functionGridData.setting={view:{showIcon:!1},check:{enable:!0},data:{simpleData:{enable:!0}}},i.$broadcast(Event.FUNCTIONINFOSINIT+"_ztree",i.functionGridData)}})):(i.functionGridData.statusCheck=!1,u.queryFunction2Role(p.roleID,function(e){if(0==e.code&&0<e.data.length){var r={parentID:"",domainPath:"",name:"",description:"",function:e.data};f(r,{});i.functionGridData.data=i.treeData,i.functionGridData.setting={view:{showIcon:!1},data:{simpleData:{enable:!0}}},i.$broadcast(Event.FUNCTIONINFOSINIT+"_ztree",i.functionGridData)}}))}}]),controllers.initController("RoleAllotCtrl",["$scope","$rootScope","ngDialog","$routeParams","userInitService","userLoginUIService","userEnterpriseService","userUIService","growl","userRoleUIService","userFunctionService","userDomainService","marketplaceUIService",function(n,e,r,a,t,i,o,s,d,l,u,c,p){var f=n.treeUserId;n.userObj={},n.domainGridData={columns:[{title:"",orderable:!1,data:"option"},{title:"名称",data:"name"},{title:"描述",data:"description"}],columnDefs:[{targets:0,data:"option",render:function(e,r,a){return'<i class="fa fa-plus-circle" id="circle-1" style="color:#1bb6e1;"></i>'}}]},f&&s.queryUser(f,function(e){0==e.code&&(n.userObj=e.data,m())});var m=function(){if(f){var i=[];c.queryDomainTreeByUser(f,function(e){if(0==e.code){var r={},a={parentID:"",domainPath:"",name:"",description:"",domains:e.data},t=function e(r,a){if(r.domains){for(var t in r.nodes=[],r.domains)r.nodes.push(e(r.domains[t],a));r.tags=[r.nodes.length]}return 1==r.belong?(r.domainPath==n.userObj.domainPath?r.state={disabled:!0,expanded:!0,checked:!0}:r.state={expanded:!0,checked:!0},a[r.domainID]=!0):(r.state={expanded:!0,checked:!1},a[r.domainID]=!1),r.text=r.name,""!=r.name&&i.push(r),r}(n.functionData=a,r);n.domainGridData.data=a.domains,n.domainGridData.treeData=t.nodes,n.domainGridData.baseNode=r,n.$broadcast(Event.DOMAININFOSINIT,n.domainGridData)}})}}}]),controllers.initController("userAllotCtrl",["$scope","$rootScope","ngDialog","$routeParams","userInitService","userLoginUIService","userEnterpriseService","userUIService","growl","userRoleUIService","userFunctionService","userDomainService","marketplaceUIService",function(t,e,r,a,i,n,o,s,d,l,u,c,p){var f=t.roleUser;l.getAssociateRole2User({roleID:f.roleID},function(e){if(0==e.code){for(var r in t.roleId=f.roleID,t.userGridData.data)for(var a in t.userGridData.data[r].check="",null==t.userGridData.data[r].userID&&t.userGridData.data.splice(r,1),e.data)t.userGridData.data[r].userID==e.data[a].userID&&(t.userGridData.data[r].check=1001);t.$broadcast(Event.CURRENTINFOSINIT+"_userRole",t.userGridData)}})}]),controllers.initController("SuperListCtrl",["$scope","userLoginUIService","userEnterpriseService","userUIService","configUIService","growl","userRoleUIService","userFunctionService","userDomainService","marketplaceUIService","resourceUIService",function($scope,userLoginUIService,userEnterpriseService,userUIService,configUIService,growl,userRoleUIService,userFunctionService,userDomainService,marketplaceUIService,resourceUIService){$scope.userTypeAry={},$scope.configGroupsDic={},$scope.userGridData={columns:[{title:"用户类型",data:"userTypeLabel"},{title:"用户名称",data:"userName"},{title:"登录名",data:"loginName"},{title:"登录账户（手机/邮箱）",data:"userEmail"},{title:"办公电话",data:"officePhone"},$.ProudSmart.datatable.optionCol3],columnDefs:[{targets:5,data:"option",render:function(e,r,a){return"<a id='save-btn' class='btn btn-default btn-sm' ><span class='hidden-xs'> 切换登录</span></a>"}}]},$scope.loginin=function(e){userLoginUIService.loginin(e,function(e){0==e.code&&(location.href="")})};var getDBdata=function(){var a=function(e){0==e.code&&($scope.enterpriseDomain=e.data)};if($scope.menuitems.isloaded)$scope.baseConfig.extendDomain?resourceUIService.getDomainsByFilter({},a):userEnterpriseService.findEnterpriseDomain(a);else var t=$scope.$watch("menuitems",function(e,r){$scope.menuitems.isloaded&&($scope.baseConfig.extendDomain?resourceUIService.getDomainsByFilter({},a):userEnterpriseService.findEnterpriseDomain(a),t())},!0);userUIService.querAllUserInfo(function(e){if(0==e.code){for(var r in e.data){var a=e.data[r];a.isEdit=0,$scope.userTypeAry&&null!=$scope.userTypeAry[a.userType]?a.userTypeLabel=$scope.userTypeAry[a.userType].label:3==a.userType?a.userTypeLabel="管理员":2==a.userType?a.userTypeLabel="普通用户":4==a.userType?a.userTypeLabel="终端用户":300==a.userType?a.userTypeLabel="企业":301==a.userType?a.userTypeLabel="客户":10==a.userType?a.userTypeLabel="企业管理员":a.userTypeLabel="错误",null==a.emailAddress||""==a.emailAddress?a.userEmail=a.mobilePhone:a.userEmail=a.emailAddress,a.enterprise?a.enterpriseName=a.enterprise.name:a.enterpriseName=""}$scope.userGridData.data=e.data,$scope.$broadcast(Event.USERINFOSINIT+"_super",$scope.userGridData)}})},configList=function configList(){configUIService.getAllConfigs(function(returnObj){if(0==returnObj.code){if(returnObj.data.forEach(function(e){$scope.configGroupsDic[e.groupName]=e}),$scope.configGroups=returnObj.data,0<returnObj.data.length&&null!=$scope.configGroupsDic.UserType&&$scope.configGroupsDic.UserType.value){var userType=eval("("+$scope.configGroupsDic.UserType.value+")");userType.forEach(function(e){$scope.userTypeAry[e.typeCode]=e})}getDBdata()}})};userLoginUIService.user.isAuthenticated?configList():$scope.$on("loginStatusChanged",function(e,r){userLoginUIService.user.isAuthenticated&&configList()})}]),controllers.initController("addEnterpriseCtrl",["$scope","userLoginUIService","userEnterpriseService","userUIService","growl","solutionUIService","userFunctionService","userDomainService","resourceUIService",function(n,e,r,a,t,i,o,s,d){n.parObj={userName:"",loginName:"",password:"",mobilePhone:"",emailAddress:"",isDemo:"1",industry:444774823897601},n.enterpriseObj={name:"",contactEmail:"",province:"",closingDate:"",city:""},n.provinces="",n.districts="",n.citys="",n.configPwd="",n.emailOnly="",n.$watch("configPwd",function(e,r){e!=n.parObj.password?n.emailOnly=4:n.emailOnly=0}),n.$watch("parObj.password",function(e,r){n.emailOnly=0});var l=function(){d.getSimpleDistricts(function(e){if(0==e.code){for(var r in n.provinces=e.data,n.provinces)if(n.provinces[r].label==n.enterpriseObj.province){if("北京市"==n.enterpriseObj.province||"天津市"==n.enterpriseObj.province||"上海市"==n.enterpriseObj.province||"重庆市"==n.enterpriseObj.province){var a=n.provinces[r].children;for(var t in a)a[t].label==n.enterpriseObj.province&&(n.citys=a[t].children)}else n.citys=n.provinces[r].children;n.districts=[]}for(var i in n.citys)n.citys[i].label==n.enterpriseObj.city&&(n.districts=n.citys[i].children)}})};n.proChang=function(){l()},l(),i.getSolutions(function(e){0==e.code&&(n.activeedAppDatas=e.data)});n.savaEnterprise=function(){if(""!=n.enterpriseObj.name&&null!=n.enterpriseObj.name&&void 0!==n.enterpriseObj.name)if(""!=n.enterpriseObj.province&&null!=n.enterpriseObj.province&&void 0!==n.enterpriseObj.province)if(""!=n.enterpriseObj.city&&null!=n.enterpriseObj.city&&void 0!==n.enterpriseObj.city)if(""!=n.parObj.userName&&null!=n.parObj.userName&&void 0!==n.parObj.userName)if(""!=n.parObj.mobilePhone&&null!=n.parObj.mobilePhone&&void 0!==n.parObj.mobilePhone)if(""!=n.parObj.emailAddress&&null!=n.parObj.emailAddress&&void 0!==n.parObj.emailAddress)if(""!=n.parObj.industry&&null!=n.parObj.industry&&void 0!==n.parObj.industry)if(""!=n.parObj.loginName&&null!=n.parObj.loginName&&void 0!==n.parObj.loginName)if(""!=n.parObj.password&&null!=n.parObj.password&&void 0!==n.parObj.password)if(""!=n.parObj.password&&null!=n.parObj.password&&void 0!==n.parObj.password)if(""!=n.configPwd&&null!=n.configPwd&&void 0!==n.configPwd)if(n.configPwd==n.parObj.password){var e=new Date(n.enterpriseObj.closingDate).Format("yyyy-MM-dd");0!=checkDate(e)?a.individualUserRegister(n.enterpriseObj,n.parObj,function(e){0==e.code&&(t.success("新建企业账号成功",{}),location.href="#/enterpriseMaintain")}):t.warning("您选择的试用结束时间小于当前时间",{})}else n.emailOnly="4";else n.emailOnly="1001";else n.emailOnly="1002";else t.warning("密码不能为空",{});else t.warning("登录名不能为空",{});else t.warning("应用方案不能为空",{});else t.warning("申请人邮箱不能为空或者格式不对请检查",{});else t.warning("申请人电话不能为空",{});else t.warning("申请人姓名不能为空",{});else t.warning("企业所在地城市不能为空",{});else t.warning("企业所在地省份不能为空",{});else t.warning("企业名称不能为空",{})}}]),controllers.initController("EnterpriseListCtrl",["$scope","$routeParams","FileUploader","ngDialog","userLoginUIService","userEnterpriseService","userUIService","growl","userRoleUIService",function(s,e,r,d,a,l,t,u,i){s.enterpriseObj={},s.enterId="";var n=s.uploader=new r({url:t.uploadFileUrl+"/api/rest/upload/userUIService/uploadFile"}),c="确定",p="取消";n.filters.push({name:"customFilter",fn:function(e,r){return this.queue.length<10}}),n.onWhenAddingFileFailed=function(e,r,a){console.info("onWhenAddingFileFailed",e,r,a)},n.onAfterAddingFile=function(e){var r=f(e._file);$("#imgLook").attr("src",r)},n.onAfterAddingAll=function(e){console.info("onAfterAddingAll",e)},n.onBeforeUploadItem=function(e){console.info("onBeforeUploadItem",e)},n.onProgressItem=function(e,r){console.info("onProgressItem",e,r)},n.onProgressAll=function(e){console.info("onProgressAll",e)},n.onSuccessItem=function(e,r,a,t){0==r.code&&l.modifyLogo(s.enterId,r.data,function(e){0==e.code&&(o(),u.success("上传图片成功",{}))})},n.onErrorItem=function(e,r,a,t){console.info("onErrorItem",e,r,a,t)},n.onCancelItem=function(e,r,a,t){console.info("onCancelItem",e,r,a,t)},n.onCompleteItem=function(e,r,a,t){console.info("onCompleteItem",e,r,a,t)},n.onCompleteAll=function(){console.info("onCompleteAll")};s.controller={isImage:function(e){var r="|"+e.type.slice(e.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(r)}};s.userGridData={columns:[{title:"企业ID",data:"enterpriseID"},{title:"企业名称",data:"name"},{title:"域路径",data:"domainPath"},{title:"企业类型",data:"enterpriseTypeName"},{title:"logo地址",data:"enterpriseLogo"},{title:"状态",data:"enterpriseStatus"},{title:"操作",orderable:!1,data:"option"}],columnDefs:[{targets:5,data:"enterpriseStatus",render:function(e,r,a){return"0"==a.enterpriseStatus?"启用":"停用"}},{targets:6,data:"option",render:function(e,r,a){var t="";return t+="<div class='btn-group table-option-group' ><button type='button' class='btn btn-default btn-sm'>操作</button><button type='button' class='btn btn-default btn-sm dropdown-toggle' data-toggle='dropdown'><span class='caret'></span><span class='sr-only'>Toggle Dropdown</span></button><ul class='dropdown-menu' role='menu'><li><a style='cursor: pointer;' id='file-txt'>上传logo文件</a></li><li><a style='cursor: pointer;' id='block' >"+("0"==a.enterpriseStatus?"停用":"启用")+"</a></li><li><a style='cursor: pointer;' id='edit-btn'>编辑</a></li><li><a style='cursor: pointer;' id='copy-right-btn'>修改版权</a></li><li><a style='cursor: pointer;' id='role-btn'>角色分配</a></li></ul></div>"}}]},s.roleEdit=function(r){var e=r.defaultRole,a=[];if(e){var t=e.split(",");for(var i in s.roleList){var n=-1;for(var o in t)s.roleList[i].roleID==t[o]&&(n=o);-1!=n&&(s.roleList[i].applied=!0),0==r.enterpriseType&&101!=s.roleList[i].roleID&&103!=s.roleList[i].roleID?a.push(s.roleList[i]):1==r.enterpriseType&&100!=s.roleList[i].roleID&&102!=s.roleList[i].roleID&&a.push(s.roleList[i])}}else for(var i in s.roleList)0==r.enterpriseType&&101!=s.roleList[i].roleID&&103!=s.roleList[i].roleID?a.push(s.roleList[i]):1==r.enterpriseType&&100!=s.roleList[i].roleID&&102!=s.roleList[i].roleID&&a.push(s.roleList[i]);s.dialog={title:"角色分配",titles:["未分配角色","已分配角色"],mark:"roleName",characters:a,button:[{label:c,icon:"btn btn-primary",fn:function(){var e=s.roleList.filter(function(e){return 1==e.applied}).map(function(e){return e.roleID});l.modifyDefaultRole(r.enterpriseID,e,function(e){if(0==e.code){for(var r in u.success("角色分配成功",{}),d.close(),s.userGridData.data)if(s.userGridData.data[r].enterpriseID==e.data.enterpriseID){0==e.data.enterpriseType?e.data.enterpriseTypeName="A企业":1==e.data.enterpriseType&&(e.data.enterpriseTypeName="B企业"),s.userGridData.data[r]=e.data;break}s.$broadcast(Event.USERINFOSINIT+"_enter",s.userGridData)}})}},{label:p,icon:"btn btn-default",fn:function(){d.close()}}]},d.open({template:"../partials/dialogue/character_assign_dia.html",className:"ngdialog-theme-plain",scope:s})},s.addEnterprise=function(){location.href="#/addEnterprise"},s.modifyEnterpriseInfo=function(e){l.adminModifyEnterprise(e,function(e){0==e.code&&(u.success("修改企业信息成功",{}),o())})},s.editEnterprise=function(e,r,a){l.modifyCopyRight(e,r,a,function(e){0==e.code&&(u.success("修改企业信息成功",{}),o())})},s.blockClick=function(r){var a="";a="0"==r.enterpriseStatus?"停用":"启用",BootstrapDialog.show({title:"提示",closable:!1,message:"是否要"+a+"该企业",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){l.modifyEnterpriseStatus(r.enterpriseID,function(e){0==e.code&&(u.warning(a+"企业成功!",{}),o())}),e.close()}},{label:"取消",action:function(e){e.close()}}]})},s.loginin=function(e){a.loginin(e,function(e){0==e.code&&(location.href=location.origin)})},s.cancel=function(){s.$broadcast(Event.USERINFOSINIT+"_enter",s.userGridData)},s.roleList=[];var o=function(){l.queryAllEnterprise(function(e){if(0==e.code){for(var r in e.data)e.data[r].enterpriseTypeName="",0==e.data[r].enterpriseType?e.data[r].enterpriseTypeName="A企业":1==e.data[r].enterpriseType&&(e.data[r].enterpriseTypeName="B企业");s.userGridData.data=e.data,s.$broadcast(Event.USERINFOSINIT+"_enter",s.userGridData)}}),l.queryEnterpriseRole(function(e){if(0==e.code){var r=[];e.data.forEach(function(e){100==e.roleID||102==e.roleID?e.roleName=e.roleName+"A":101!=e.roleID&&103!=e.roleID||(e.roleName=e.roleName+"B"),r.push(e)}),s.roleList=r}})};a.user.isAuthenticated?o():s.$on("loginStatusChanged",function(e,r){a.user.isAuthenticated&&o()});var f=function(e){var r=null;return null!=window.createObjectURL?r=window.createObjectURL(e):null!=window.URL?r=window.URL.createObjectURL(e):null!=window.webkitURL&&(r=window.webkitURL.createObjectURL(e)),r}}])});
//# sourceMappingURL=../../../map/app-oc/js/controllers/user-ctrl.js.map
