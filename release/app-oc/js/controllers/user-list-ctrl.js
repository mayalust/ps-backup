define(["controllers/controllers","Array"],function(e){"use strict";e.initController("UserListCtrl",["$scope","$state","$rootScope","$routeParams","$location","ngDialog","configUIService","resourceUIService","userInitService","userLoginUIService","userEnterpriseService","userUIService","growl","userRoleUIService","userFunctionService","userDomainService","commonMethodService",function(P,e,m,t,n,A,k,O,a,S,C,T,U,j,i,o,z){var E="确定",R="取消";P.cache={},P.navigateTo=function(e){n.path("usermanager/"+e)},P.panel=t.panel?t.panel:"user";var L=function(e,t){for(var a in P.userlist.setWholeDisabled(!1),t)t[a].disabled=!1;e.isEdit="default"},r=function(){var c,h,b,v,g=[],f=[],n=[],i={},o=[],r=function(t,e){var a=t.cached,n=a.userName,i=a.officePhone,o=a.domainID;for(var r in P.userlist.setWholeDisabled(!1),e)e[r].disabled=!1;t.isEdit="default",delete t.cached;var l=t.$clone();l.userName=n,l.officePhone=i,l.domainID=o;T.modifyUser(l,function(e){0==e.code&&(t.userName=e.data.userName,t.officePhone=e.data.officePhone,t.domainID=e.data.domainID,U.success("用户修改成功",{}))})},l=function(t,e){var a=[{label:E,icon:"btn btn-success",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){A.close(),T.deleteUser(t.userID,function(e){0==e.code&&(t.remove(),U.success("删除用户成功!",{}))})}},{label:R,icon:"btn btn-default",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){A.close()}}];P.dialog={title:{label:"提示"},description:{label:"确认要删除此用户吗？"},fnlist:a},A.open({template:"../partials/dialogue/common_dia_prompt.html",className:"ngdialog-theme-plain",scope:P})},s=function(s,e){var t=(new z).getRootScope("myDicts").specialtyProps,a=!1;0<g.length&&(a=g.find(function(e){return 10==e.typeCode}));var n=[];$.extend(n,g),a||(n=n.concat([{modelId:300,label:"企业管理员",typeCode:10,name:"管理员"}])),s.closingDate&&(s.closingDate=new Date(s.closingDate).toISOString().replace(/T/g," ").replace(/\.[\d]{3}Z/,""));var i,o,r=s.$clone(),l=b.filter(function(e){return e.userName!=s.userName}).map(function(e){return e.userName}),u=b.filter(function(e){return e.loginName!=s.loginName}).map(function(e){return e.loginName});if(v){var d=n.find(function(e){return r.userType==e.typeCode});d&&(i=d.modelId),o=r.userType=n.find(function(e){return r.userType==e.typeCode})}var c=!1;r.userID==S.user.userID&&(c=!0);var f={apply:!(300==i||10==r.userType||0==r.userType||null==r.userType||!v),value:"",label:"",right:!0,data:"subDomain",type:"select",composory:!0,options:[],events:{change:function(e){null==e.value?(e.error=f.label+"不可为空",e.right=!1):(e.error=void 0,e.right=!0)}}};if(300!=i&&v){var p=n.find(function(e){return!!o&&e.typeCode==r.userType.typeCode});f.label=p?p.name:"";var m={modelId:o?o.modelId:void 0,layer:o?r.userType.layer:""};O.getDomainsByFilter(m,function(e){0==e.code&&(f.options=e.data);var t=f.options.find(function(e){return e.domainPath==r.subDomain});t&&(f.value=t.id)})}P.dialog={title:"用户信息",input:[{value:r.domainPath,label:"管理域",data:"domainID",type:"tree",key:"domainPath",width:200,composory:!0,right:!0,options:h,mark:"nodes",apply:!0,disabled:c,events:{change:function(e){if(v&&null!=r.userType){P.dialog.input.find(function(e){"subDomain"==e.data&&(e.value="",e.right=!1)});var t={domainPath:e.value,modelId:r.userType.modelId,layer:r.userType.layer};O.getDomainsByFilter(t,function(e){0==e.code&&(f.options=e.data)})}e.value?(e.error=void 0,e.right=!0):(e.error="默认域不可为空",e.right=!1)}}},{value:r.userType,apply:v,label:"用户类型",data:"userType",type:"userType",disabled:!0,composory:!0,right:!0,options:n,events:{change:function(t){if(300!=t.value){var a={};P.baseConfig&&P.baseConfig.extendDomain||P.dialog.input.forEach(function(e){"domainID"==e.data&&(a.domainPath=e.value)}),a.modelId=t.value,f.apply=!0,f.right=!1,f.value="",f.label=t.options.find(function(e){return e.id==t.value}).name,O.getDomainsByFilter(a,function(e){0==e.code&&(f.options=e.data)})}else f.apply=!1,f.right=!0;null==t.value?(t.error="用户类型不可为空",t.right=!1):(t.error=void 0,t.right=!0)}}},f,{apply:!0,label:"用户名称",value:r.userName,maxlength:32,data:"userName",type:"input",composory:!0,right:!0,events:{change:function(e){""==e.value?(e.error="用户名称不可为空",e.right=!1):-1!=l.indexOf(e.value)?(e.error="用户名已存在",e.right=!1):(e.error=void 0,e.right=!0)}}},{label:"登录名",apply:!0,value:r.loginName,maxlength:32,composory:!0,right:!0,events:{change:function(e){if(""==e.value)e.error="登录名不可为空",e.right=!1;else if(-1!=u.indexOf(e.value))e.error="登录名已存在",e.right=!1;else{/^[A-Za-z0-9][A-Za-z0-9_-]{5,32}$/.test(e.value)?(e.error=void 0,e.right=!0):(e.error="请输入不低于6位的字母、数字和下划线，首字符不能是下划线。",e.right=!1)}},blur:function(t){t.value&&!t.error&&t.value!=s.loginName&&T.checkLoginName(t.value,function(e){0==e.code&&(e.data?(t.error="",t.right=!0):(t.error="登录名已存在",t.right=!1))})}},data:"loginName",type:"input"},{value:function(e){if(e){var t=e.split(","),a=[];return t.forEach(function(e){a.push(e)}),a}}(r.specialties),label:"专业",data:"specialties",type:"multiple",options:t,format:{id:"valueCode",label:"label"}},{label:"到期日期",value:r.closingDate?new Date(r.closingDate).Format("yyyy-MM-dd"):"",apply:r.userID!=S.user.userID,maxlength:32,data:"closingDate",type:"data",resetdis:!0,events:{change:function(e){var t=new Date(e.value).Format("yyyy-MM-dd"),a=checkDate(t);e.right=0==a?!(e.error="您选择的到期日期小于当前时间！"):!(e.error=void 0)},reset:function(e){e.value=""}}},{label:"办公电话",maxlength:12,value:r.officePhone,right:!0,composory:!1,data:"officePhone",placeholder:"7－11位, 例如：53463333",events:{change:function(e){if(""==e.value)e.error=void 0,e.right=!0;else{var t=checkValidmobile(e.value);e.right=0==t?!(e.error="不是有效的电话号码"):!(e.error=void 0)}}},type:"input"},{label:"备注",value:r.description,data:"description",maxlength:200,type:"textarea"}],button:[{label:E,icon:"btn btn-primary",disabledFn:function(){return!P.dialog.input.every(function(e){var t=e.right&&e.value||null==e.right||1!=e.apply;return t})},fn:function(){var e,t,a=-1;if(P.dialog.input.forEach(function(e){e.error&&(a=1)}),-1==a){var n=P.dialog,i={},o={},r=function(t){i[t.data]=t.value,"domainID"==t.data?i[t.data]=t.value.substring(0,t.value.length-1).substring(t.value.substring(0,t.value.length-1).lastIndexOf("/")+1):"subDomain"==t.data?i.subDomain&&(i[t.data]=f.options.find(function(e){return i.subDomain==e.id}).domainPath):"userType"==t.data&&t.value?i[t.data]=t.value.typeCode:"specialties"==t.data&&t.value&&(i[t.data]="",t.value.forEach(function(e){e&&(i[t.data]+=e+",")}))};for(var l in n.input)r(n.input[l]);(o=function(){for(var e,t=[].slice.call(arguments),a=t.shift();e=t.shift();)for(var n in e)a[n]=e[n];return a}({},s,i)).domainID=i.domainID==(e=s.domainPath,(t=/\/(\d+)\/$/.exec(e))?t[1]:0)?null:i.domainID,T.modifyUser(o,function(e){if(0==e.code){for(var t in e.data,n.input)a=n.input[t],s[a.data]=e.data[a.data],"domainID"==a.data&&(s.domainPath=e.data.domainPath);U.success("编辑用户成功",{})}var a}),A.close()}}},{label:R,icon:"btn btn-default",fn:function(){A.close()}}]},A.open({template:"../partials/dialogue/config_alert_dia.html",className:"ngdialog-theme-plain",scope:P})};var u=function(e){var t=(new z).getRootScope("myDicts").specialtyProps,a=b.map(function(e){return e.userName}),n=b.map(function(e){return e.loginName}),i=b.map(function(e){return e.emailAddress}),o=b.map(function(e){return e.mobilePhone});$$.duplicateName("新建用户",a),$$.duplicateName("newuser1",n,!1);P.checkDisabled=function(e){return"function"==typeof e?e():e};var r=P.userInfo.userType?P.userInfo.userType.toString():"",l=[];if(r&&!P.menuitems.A99_S17){for(var s in g){var u=g[s].typeCode.toString();0==u.indexOf(r)&&1==u.substring(r.length).length&&l.push(g[s])}g=l}var d={apply:!1,value:void 0,label:"",right:!1,data:"subDomain",type:"select",composory:!0,options:[],events:{change:function(e){null==e.value?(e.error=d.label+"不可为空",e.right=!1):(e.error=void 0,e.right=!0)}}};P.dialog={title:"用户信息",note:{message:"系统将自动发送密码到所填手机号或邮箱，手机号或邮箱必选其一填写。"},input:[{value:void 0,label:"管理域",data:"domainID",type:"tree",right:!1,key:"domainPath",width:200,composory:!0,options:h,mark:"nodes",events:{change:function(e){v?P.dialog.input.find(function(e){"userType"!=e.data&&"subDomain"!=e.data||(e.value="",e.right=!1)}):P.dialog.input.find(function(e){"userType"!=e.data&&"subDomain"!=e.data||(e.value="",e.right=!0)}),null==e.value?(e.error="默认域不可为空",e.right=!1):(e.error=void 0,e.right=!0)}}},{value:"",apply:v,label:"用户类型",data:"userType",type:"userType",composory:!0,right:!0,options:g,events:{change:function(t){if(t.value&&300!=t.value.modelId){var a={};P.baseConfig&&P.baseConfig.extendDomain||P.dialog.input.find(function(e){"domainID"==e.data&&(a.domainPath=e.value)}),a.modelId=t.value.modelId,a.layer=t.value.layer,d.apply=!0,d.right=!1,d.label=t.options.find(function(e){return e==t.value}).name,O.getDomainsByFilter(a,function(e){0==e.code&&(d.options=e.data)})}else d.apply=!1,d.right=!0;null==t.value||""==t.value?(t.error="用户类型不可为空",t.right=!1):(t.error=void 0,t.right=!0)}}},d,{value:void 0,label:"默认角色",right:!1,data:"role",type:"multiple",composory:!0,options:f,events:{change:function(e){0==e.value.length?(e.error="默认角色不可为空",e.right=!1):(e.error=void 0,e.right=!0)}}},{value:void 0,label:"专业",data:"specialties",type:"multiple",options:t,format:{id:"valueCode",label:"label"}},{label:"用户名称",value:"",right:!1,maxlength:32,composory:!0,data:"userName",events:{change:function(e){""==e.value?(e.error="用户名称不可为空",e.right=!1):-1!=a.indexOf(e.value)?(e.error="用户名已存在",e.right=!1):(e.error=void 0,e.right=!0)}},type:"input"},{label:"登录名",value:"",maxlength:32,right:!1,composory:!0,data:"loginName",type:"input",events:{change:function(e){if(""==e.value)e.error="登录名不可为空",e.right=!1;else if(-1!=n.indexOf(e.value))e.error="登录名已存在",e.right=!1;else{/^[A-Za-z0-9][A-Za-z0-9_-]{5,32}$/.test(e.value)?(e.error=void 0,e.right=!0):(e.error="请输入不低于6位的字母、数字和下划线，首字符不能是下划线。",e.right=!1)}},blur:function(t){t.value&&!t.error&&T.checkLoginName(t.value,function(e){0==e.code&&(e.data?(t.error="",t.right=!0):(t.error="登录名已存在",t.right=!1))})}}},{label:"到期日期",value:"",maxlength:32,right:!0,composory:!1,data:"closingDate",type:"data",resetdis:!0,events:{change:function(e){var t=new Date(e.value).Format("yyyy-MM-dd"),a=checkDate(t);e.right=0==a?!(e.error="您选择的到期日期小于当前时间！"):!(e.error=void 0)},reset:function(e){e.value="",e.error=void 0,e.right=!0}}},{label:"手机号",maxlength:12,value:"",right:!0,composory:!1,data:"mobilePhone",placeholder:"手机号或邮箱必选其一填写",events:{change:function(e){if(""==e.value)return e.error="",void(e.right=!0);if(0==/^1\d{10}$/.test(e.value))e.error="手机号必须是以1开头的11位数字",e.right=!1;else if(-1!=o.indexOf(e.value))e.error="手机号码已存在",e.right=!1;else{e.error=void 0,e.right=!0;var t=/^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\.[a-zA-Z0-9_-]{2,3}){1,2})$/;P.dialog.input.find(function(e){"emailAddress"==e.data&&(""==e.value||e.value&&t.test(e.value))&&(e.right=!0)})}}},type:"input"},{label:"邮箱",maxlength:32,value:"",composory:!1,right:!0,placeholder:"手机号或邮箱必选其一填写",data:"emailAddress",events:{change:function(e){if(""==e.value)return e.error="",void(e.right=!0);if(0==/^[a-zA-Z0-9_-].+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/.test(e.value))e.right=!1,e.error="不是正确的邮箱格式";else if(-1!=i.indexOf(e.value))e.error="邮箱已存在",e.right=!1;else{e.error=void 0,e.right=!0;var t=/^1\d{10}$/;P.dialog.input.find(function(e){"mobilePhone"==e.data&&(""==e.value||e.value&&t.test(e.value))&&(e.right=!0)})}}},type:"input"},{label:"办公电话",maxlength:12,value:"",right:!0,composory:!1,data:"officePhone",placeholder:"7－11位, 例如：53463333",events:{change:function(e){if(""==e.value)e.error=void 0,e.right=!0;else{var t=checkValidmobile(e.value);e.right=0==t?!(e.error="不是有效的电话号码"):!(e.error=void 0)}}},type:"input"},{label:"备注",value:"",data:"description",maxlength:200,type:"textarea"},{label:"启用",value:!0,data:"status",type:"toggle"}],button:[{label:E,icon:"btn btn-primary",disabledFn:function(){return!P.dialog.input.every(function(e){var t=0!=e.right||0==e.apply;return t})},fn:function(){var e,a=[],t=P.dialog,n={},i=function(t){n[t.data]=t.value,"domainID"==t.data?n[t.data]=t.value.substring(0,t.value.length-1).substring(t.value.substring(0,t.value.length-1).lastIndexOf("/")+1):"subDomain"==t.data?n.subDomain&&(n[t.data]=d.options.find(function(e){return n.subDomain==e.id}).domainPath):"role"==t.data?t.value.forEach(function(e){a.push({roleID:e})}):"userType"==t.data?n[t.data]=t.value.typeCode:"specialties"==t.data&&t.value&&(n[t.data]="",t.value.forEach(function(e){n[t.data]+=e+","}))};for(var o in t.input)i(t.input[o]);for(var r in c)c[r].id==n.domainID&&(e=c[r]);e&&(e={userID:"",domainID:e.id,domainPath:e.domainPath,name:e.name}),delete n.domainID,delete n.role,n.status=n.status?0:-1,P.baseConfig&&P.baseConfig.extendDomain&&(n.domains=e.domainPath),n.mobilePhone||n.emailAddress?T.enterpriseUserRegister(n,e,a,function(e){if(0==e.code){var t=e.data;j.queryRoleByUser(e.data.userID,function(e){t.roles=e.data}),b.pushbefore(t),U.success("创建新用户成功",{}),A.close()}}):U.warning("请手机号或邮箱选其一进行填写",{})}},{label:R,icon:"btn btn-default",fn:function(){A.close()}}]},A.open({template:"../partials/dialogue/config_alert_dia.html",className:"ngdialog-theme-plain",scope:P})},a=function(l){var s=0,u=[],d=l,e=function(){var a=function(){var r=P.cache.role.$clone(),e=[];l.some(function(e){return 2==e.userType});if(1<l.length)for(var t in r)r[t].applied=!1,101==r[t].roleID&&103==r[t].roleID||e.push(r[t]);else if(1==l.length)for(var t in r)-1!=u.indexOf(r[t].roleID)?(r[t].applied=!0,e.push(r[t])):101!=r[t].roleID&&103!=r[t].roleID&&e.push(r[t]);P.dialog={title:"角色分配",titles:["未分配角色","已分配角色"],mark:"roleName",characters:e,button:[{label:E,icon:"btn btn-primary",fn:function(){var i=0,o=r.filter(function(e){return 1==e.applied}).map(function(e){return e.roleID});if(o.length<=0)U.warning("必须要有一个已分配角色",{});else{var e=function(e){A.close(),function(e){var t=[];for(var a in r){var n=-1;for(var i in o)if(r[a].roleID==o[i]){n=i;break}-1==n&&t.push(r[a].roleID)}0<t.length&&j.removeRole(l[0].userID,t,function(t){if(0==t.code){for(var e in d)d[e].roleID=o.join(",");$$.cacheAsyncData.call(j.queryRoleByUser,[l[0].userID],function(e){0==e.code&&(l[0].roles=t.data)}),U.success("角色分配成功",{})}})}()};!function t(a){var n=a[i];a[i]?(a[i].selected=!1,j.appendRole(a[i].userID,o,function(e){0==e.code&&(e.data.find(function(e){return 100==e.roleID||101==e.roleID||102==e.roleID||103==e.roleID}),$$.cacheAsyncData.call(j.queryRoleByUser,[n.userID],function(e){0==e.code&&(n.roles=e.data)}),i++,t(a))},function(e){i++,t(a)})):e()}(l)}}},{label:R,icon:"btn btn-default",fn:function(){A.close()}}]},A.open({template:"../partials/dialogue/character_assign_dia.html",className:"ngdialog-theme-plain",scope:P})};null==P.cache.role?C.queryEnterpriseRole(function(e){if(0==e.code){var t=[];e.data.forEach(function(e){e.id=e.roleID,e.label=e.roleName,(S.user.domainPath.split("/").length<=4||-1<e.domainPath.search(S.user.domainPath))&&t.push(e)}),P.cache.role=t.map(function(e){return 1==S.user.userID&&101!=e.roleID&&103!=e.roleID&&(100!=e.roleID&&102!=e.roleID||(e.roleName+="A")),e}),a()}}):a()};!function o(r){r[s]?$$.cacheAsyncData.call(j.queryRoleByUser,[r[s].userID],function(e){if("0"==e.code){var t=r[s].roles;for(var a in t)n=t[a],i=void 0,i=u.map(function(e){return e.roleID}),n&&-1==i.indexOf(n.roleID)&&u.push(n.roleID)}var n,i;s++,o(r)}):e()}(l)},t=function(e,n){var i=e.filter(function(e){return 0!=e.status&&e.userID!=S.user.userID}),t=(e.filter(function(e){return 0==e.status&&e.userID!=S.user.userID}),[{label:E,icon:"btn btn-success",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){var e=i.map(function(e){return e.userID});T.enableUsers(e,function(e){if(0==e.code){for(var t in i)i[t].status=0;if(b.removeAllChecked(),n)n();else{var a="启用用户，成功"+e.data.successObj.length+"个,失败"+e.data.failObj.length+"个";U.success(a,{})}A.close()}})}},{label:R,icon:"btn btn-default",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){A.close()}}]);P.dialog={title:{label:"提示"},description:{label:1<i.length?"当前有"+i.length+"个用户未启用状态，确认要启用吗？":"确认要启用"+i[0].userName+"用户吗？"},fnlist:t},A.open({template:"../partials/dialogue/common_dia_prompt.html",className:"ngdialog-theme-plain",scope:P})},d=function(e){t(e)},p=function(e){t([e],function(){U.success("已启用成功",{})})},m=function(e,n){var i=e.filter(function(e){return 0==e.status&&e.userID!=S.user.userID}),a=e.filter(function(e){return 0!=e.status&&e.userID!=S.user.userID}),t=[{label:E,icon:"btn btn-success",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){var e=i.map(function(e){return e.userID});if(0<e.length)T.disableUsers(e,function(e){if(0==e.code){for(var t in i)i[t].status=-1;if(b.removeAllChecked(),n)n();else{var a="停用用户，成功"+e.data.successObj.length+"个, 失败"+e.data.failObj.length+"个";U.success(a,{})}A.close()}});else{if(n)n();else{var t="停用用户，成功"+i.length+"个, 失败"+a.length+"个";U.success(t,{})}A.close()}}},{label:R,icon:"btn btn-default",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){A.close()}}];i.length<=0?U.info("不能停用自己的账号",{}):(P.dialog={title:{label:"提示"},description:{label:1<i.length?"当前有 "+i.length+" 个用户启用状态，停用后将禁止登录系统，确认要停用吗":"用户停用后将禁止登录系统，确认要停用 "+i[0].userName+" 用户吗？"},fnlist:t},A.open({template:"../partials/dialogue/common_dia_prompt.html",className:"ngdialog-theme-plain",scope:P}))},y=function(e){m(e)},D=function(e){m([e],function(){U.success("已停用成功",{})})},I=function(e,t){a([e])};P.allDomain=[],P.allDomainDic={},P.defaultDeviceIds=[],P.allDomainTree={},P.accredit="domain",P.all={check:!1},P.allDevice=[];var x=function(e,t){window.location.href="/app-oc/index.html#/prod_authorize_domain/"+e.userID};P.defaultDomainAction=function(e,t){if("add"==t&&P.domainObj.domainIds){for(var a in P.domainList){var n=P.allDomainDic[P.domainObj.domainIds].domainPath,i=P.domainList[a].domainPath.split("/");if(P.allDomainDic[P.domainObj.domainIds].id==P.domainList[a].id)return U.warning("您选择的域已存在",{}),void(P.domainObj.domainIds="");for(var o in i)if(i[o]==""+P.allDomainDic[P.domainObj.domainIds].id)return U.warning("不能选当前域的父域",{}),void(P.domainObj.domainIds="");if(-1!=n.indexOf(""+P.domainList[a].id))return U.warning("不能选当前域的低级别域，删除父域在添加",{}),void(P.domainObj.domainIds="")}P.allDomain.splice(jQuery.inArray(P.allDomainDic[P.domainObj.domainIds],P.allDomain),1),P.domainList.push(P.allDomainDic[P.domainObj.domainIds]),P.domainObj.domainIds=""}else if("del"==t){for(var o in P.domainObj.domainIds="",P.domainList)if(P.domainList[o].id==e.id){P.allDomain.push(P.domainList[o]),P.domainList.splice(o,1);break}}else if("save"==t){var r="";for(var o in P.domainList)r+=P.domainList[o].id+",";var l=[];for(var a in P.devices)P.devices[a].check&&l.push(P.devices[a].id);P.domainObj.domainIds=r,P.domainObj.deviceIds=l,P.domainObj.deviceDomainId=e.split("/")[e.split("/").length-2],T.modifyUser(P.domainObj,function(e){0==e.code&&U.success("默认扩展域修改成功",{})})}};P.queryDevice=function(a,n){P.department=a;var o="";T.queryUserDeviceByDeviceDomains(P.domainObj.userID,a,function(e){var t,i;e&&0<e.data.length&&e.data.forEach(function(e){o+=e.deviceId+";"}),t={domains:a,label:n},i=o,O.getDevicesByCondition(t,function(e){0==e.code&&(e.data.forEach(function(e){for(var t=(new z).getdomainNameHandler(e.domains,[]),a="",n=1;n<t.length;n++)a+=t[n]+"/";e.customName=a,e.check=!1,-1<i.indexOf(e.id)&&(e.check=!0)}),P.devices=e.data)},"includeFields=label,domains,id")})};var _=function(e,t){var a=[{label:E,icon:"btn btn-primary",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){A.close(),e.userID!=S.user.userID?""==e.emailAddress||null==e.emailAddress?T.sendModifyPassword(e.mobilePhone,function(e){0==e.code&&U.success("重置密码成功,请查收",{})}):T.sendModifyPassword(e.emailAddress,function(e){0==e.code&&U.success("重置密码成功,请查收",{})}):U.warning("不能重置自己密码!",{})}},{label:R,icon:"btn btn-default",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){A.close()}}];P.dialog={title:{label:"提示"},description:{label:"确认要重置该用户密码？"},fnlist:a},A.open({template:"../partials/dialogue/common_dia_prompt.html",className:"ngdialog-theme-plain",scope:P})},N=0,w=function(){b.forEach(function(t){t.roleID&&(t.roles=[],t.roleID.split(",").forEach(function(e){t.roles.push(i[e])}))});var e=[],t=[];P.menuitems.D02_A01_S17&&e.push({icon:"fa fa-plus",class:"btn btn-primary btn-sm",label:"添加用户",style:{margin:"2px"},type:"button",events:{click:u}}),P.menuitems.D05_A01_S17&&e.push({icon:"fa fa-play",class:"btn btn-default btn-sm",label:"启用",style:{margin:"2px"},type:"button",disabled:function(e){return!e.some(function(e){return 1==e.selected&&-1==e.status})},events:{click:d}}),P.menuitems.D06_A01_S17&&e.push({icon:"fa fa-stop",class:"btn btn-default btn-sm",label:"停用",style:{margin:"2px"},type:"button",disabled:function(e){return!e.some(function(e){return 1==e.selected&&0==e.status})},events:{click:y}}),P.menuitems.D03_A01_S17&&t.push({label:"编辑",type:"button",class:"btn btn-primary",events:{click:s}}),P.menuitems.D04_A01_S17&&t.push({label:"删除",type:"button",class:"btn btn-default",disabled:function(e,t){return e.userID==S.user.userID||0==e.status},events:{click:l}}),P.menuitems.D07_A01_S17&&t.push({label:"角色分配",type:"button",class:"btn btn-default",events:{click:I}}),P.menuitems.D08_A01_S17&&t.push({label:"重置密码",type:"button",class:"btn btn-default",visible:function(e,t){return e.userID!=S.user.userID},events:{click:_}}),P.menuitems.D09_A01_S17&&t.push({label:"数据授权 ",type:"button",class:"btn btn-default",visible:function(e,t){return e.userID!=S.user.userID},events:{click:x}}),P.menuitems.D05_A01_S17&&t.push({label:"启用",type:"button",class:"btn btn-default",visible:function(e){return-1==e.status},events:{click:p}}),P.menuitems.D06_A01_S17&&t.push({label:"停用",type:"button",class:"btn btn-default",visible:function(e){return 0==e.status&&e.userID!=S.user.userID},events:{click:D}});var a=[{label:"用户名称",width:"10%",editable:!0,sortable:!0,filterable:!0,data:"userName",type:"text",modes:{default:{type:"text"},edit:{type:"input",placeholder:"例如：请填写用户名，用户名不可为空"}}},{label:"登录名",width:"10%",editable:!0,sortable:!0,filterable:!0,data:"loginName",type:"text",modes:{default:{type:"text"},edit:{type:"input",placeholder:"例如：请填写用户名，用户名不可为空"}}},{label:"手机号",width:"10%",editable:!0,sortable:!0,filterable:!0,data:"mobilePhone",type:"text",format:function(e){return e||"-"},modes:{default:{type:"text"},edit:{type:"input",placeholder:"例如：请填写用户名，用户名不可为空"}}},{label:"邮箱",width:"10%",type:"text",sortable:!0,filterable:!0,data:"emailAddress",format:function(e){return e||"-"},modes:{default:{type:"text"},edit:{type:"text"}}},{label:"已分配角色",type:"selectObj",sortable:!0,filterable:!0,filterFormat:{label:"roleName",value:"roleID"},data:"roles",options:n,format:function(e){return e?(e=e.map(function(e){if(e&&null!=e.roleName)return e.roleName})).toString():""},modes:{default:{type:"text"},edit:{type:"input",placeholder:"例如：010-66668888"}}},{label:"管理域",type:"tree",sortable:!0,filterable:!0,data:"domainPath",key:"domainPath",mark:"nodes",options:h,format:function(e){if(!e)return"-";var t=c[e];return t?t.label:"-"},modes:{default:{type:"text"}}},{label:"状态",width:"30px",type:"status",sortable:!0,filterable:!0,class:function(e){return 0==e.status?"label-success":"label-default"},style:function(e){return{cursor:"default"}},format:function(e){return 0==e?"已启用":"未启用"},data:"status"},{label:"操作",type:"buttonGroup",filterable:!1,sortable:!1,width:"141px",modes:{default:{options:t},edit:{options:[{label:"保存",type:"button",class:"btn btn-primary",events:{click:r}},{label:"取消",type:"button",class:"btn btn-default",events:{click:L}}]}}}];1==v&&(a[1]={label:"用户类型",apply:!0,editable:!0,sortable:!0,data:"userType",type:"text",format:function(t){var e=o.find(function(e){return e.id==t});return e?e.label:10==t?"企业管理员":"-"},modes:{default:{type:"text"},edit:{type:"input"}}}),P.userlist={source:b,header:e,columnDefs:a}};C.queryEnterpriseRole(function(e){if(0==e.code){f=[];var t=[];for(var a in e.data)e.data[a]&&t.push(e.data[a]);t.forEach(function(e){e.id=e.roleID,e.label=e.roleName,n.push(e),i[e.id]=e,(S.user.domainPath.split("/").length<=4||-1<e.domainPath.search(S.user.domainPath))&&f.push(e)}),P.cache.role=f.map(function(e){return 1==S.user.userID&&101!=e.roleID&&103!=e.roleID&&(100!=e.roleID&&102!=e.roleID||(e.roleName+="A")),e}),4==++N&&w()}}),O.getExtendDomainsByFilter({},function(e){c=e.domainListDic,h={nodes:e.data,domainInfos:e.data},P.allDomainTree=e.data,P.allDomainDic=e.domainListDic,P.allDomainInit=e.data[0].domainInfos,4==++N&&w()});k.getConfigsByGroupName("UserType",function(e){0==e.code&&e.data[0]?(v=!0,o=JSON.parse(e.data[0].value),g=JSON.parse(e.data[0].value),o.forEach(function(e){e.id=e.typeCode})):0==e.code&&0==e.data.length&&(g=[{typeCode:10,modelId:300,name:"企业用户"}],o=[{id:300,typeCode:10,modelId:300,label:"企业用户"}],v=!1),4==++N&&w()}),T.queryUserByCondition({},function(e){0==e.code&&(b=P.menuitems.A99_S17?e.data:e.data.filter(function(e){return-1<e.domainPath.search(S.user.domainPath)}),4==++N&&w())})},l=function(){var s=[],o=function(e){return(e+"").length<5},r=function(e){m.currentRole=e.roleID,n.path("usermanager/permission/menus/"+e.roleID)},a=function(a){var o=0,r=[],e=function(){var t=function(){var t=P.cache.role.$clone();if(1<a.length)for(var e in t)t[e].applied=!1;else if(1==a.length)for(var e in t)-1!=r.indexOf(t[e].userID)&&(t[e].applied=!0);P.dialog={title:"用户分配",titles:["未分配用户","已分配用户"],mark:"userName",characters:t,button:[{label:E,icon:"btn btn-primary",fn:function(){var n=0,i=t.filter(function(e){return 1==e.applied}).map(function(e){return e.userID}),e=function(e){A.close(),function(e){for(var t in i)r.splice($.inArray(i[t],r),1);j.removeUser(r,e[0].roleID,function(e){0==e.code&&U.success("用户分配成功",{})})}(e)};!function t(a){a[n]?(a[n].selected=!1,j.appendUser(i,a[n].roleID,function(e){e.code,n++,t(a)},function(e){n++,t(a)})):e(a)}(a)}},{label:R,icon:"btn btn-default",fn:function(){A.close()}}]},A.open({template:"../partials/dialogue/character_assign_dia.html",className:"ngdialog-theme-plain",scope:P})};null==P.cache.role?T.queryUserByCondition({},function(e){0==e.code&&(P.cache.role=e.data.map(function(e){return e}),t())}):t()};!function n(i){i[o]?j.getAssociateRole2User({roleID:i[o].roleID},function(e){if("0"==e.code)for(var t in e.data)a=e.data[t],-1==r.map(function(e){return e.userID}).indexOf(a.userID)&&r.push(a.userID);var a;o++,n(i)}):e()}(a)},l=function(e,t){a([e])},u=function(i,e){s.filter(function(e){return e.roleID!=i.roleID}).map(function(e){return e.roleName});P.dialog={title:{label:"角色信息"},input:[{label:"角色名称",value:i.roleName,composory:!0,data:"roleName",type:"input",maxlength:32,onChange:function(e){""==e.value?(e.error="角色名称不可为空",e.right=!1):(e.error=void 0,e.right=!0)}},{label:"角色描述",value:i.description,composory:!1,maxlength:200,data:"description",type:"textarea"}],fnlist:[{label:E,icon:"btn btn-primary",disabledFn:function(){return!P.dialog.input.every(function(e){return 0!=e.right})},fn:function(){var e,n=P.dialog,t=i.$clone();for(var a in t.domainID=S.user.domainID,t.domainPath=S.user.domainPath,n.input)e=n.input[a],t[e.data]=e.value;j.modifyRole(t,function(e){if(0==e.code){for(var t in e.data,n.input)a=n.input[t],i[a.data]=e.data[a.data];U.success("角色修改成功",{})}var a}),A.close()}},{label:R,icon:"btn btn-default",fn:function(){A.close()}}]},A.open({template:"../partials/dialogue/common_dia.html",className:"ngdialog-theme-plain",scope:P})},d=function(e){s.map(function(e){return e.roleName});P.dialog={title:{label:"角色信息"},input:[{label:"角色名称",value:"新建角色",composory:!0,data:"roleName",type:"input",maxlength:32,onChange:function(e){""==e.value?(e.error="角色名称不可为空",e.right=!1):(e.error=void 0,e.right=!0)}},{label:"角色描述",value:"角色描述",composory:!1,maxlength:200,data:"description",type:"textarea"}],fnlist:[{label:E,icon:"btn btn-primary",disabledFn:function(){return!P.dialog.input.every(function(e){return 0!=e.right})},fn:function(){var e,t=P.dialog,a={};for(var n in a.domainID=S.user.domainID,a.domainPath=S.user.domainPath,t.input)e=t.input[n],a[e.data]=e.value;j.addRole(a,function(e){if(0==e.code){var t=e.data;s.pushbefore(t),U.success("创建新角色成功",{})}}),A.close()}},{label:R,icon:"btn btn-default",fn:function(){A.close()}}]},A.open({template:"../partials/dialogue/common_dia.html",className:"ngdialog-theme-plain",scope:P})},c=function(e){var t=[{label:E,icon:"btn btn-success",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){A.close();var n=e.filter(function(e){return 1==e.selected}),i=0,o="";!function t(a){if(a){i++;var e={roleID:a.roleID};j.deleteRole(e,function(e){0==e.code&&(a.remove(),o="角色删除成功"),t(n[i])})}else""!=o&&U.success("角色删除成功",{})}(n[i])}},{label:R,icon:"btn btn-default",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){A.close()}}];P.dialog={title:{label:"提示"},description:{label:"确认要删除所选角色吗？"},fnlist:t},A.open({template:"../partials/dialogue/common_dia_prompt.html",className:"ngdialog-theme-plain",scope:P})},f=function(t,e){var a=s.filter(function(e){return t.roleName!=e.roleName}).map(function(e){return e.roleName}),n=t.cached.roleName;if(""==n)U.warning("角色名不可为空",{});else if(-1==a.indexOf(n)){var i=t.cached.description,o=t.roleID;for(var r in P.userlist.setWholeDisabled(!1),e)e[r].disabled=!1;t.isEdit="default",delete t.cached;var l={roleName:n,description:i,roleID:o};j.modifyRole(l,function(e){0==e.code?(t.roleName=e.data.roleName,t.description=e.data.description,U.success("修改角色成功",{}),callback(!0)):U.warning("修改角色失败!",{})})}else U.warning("角色名已存在，请跟换",{})},p=function(t,e){var a=[{label:E,icon:"btn btn-success",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){A.close();var e={roleID:t.roleID};j.deleteRole(e,function(e){0==e.code&&(t.remove(),U.success("删除角色成功",{}))})}},{label:R,icon:"btn btn-default",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){A.close()}}];P.dialog={title:{label:"提示"},description:{label:"确认要删除这个角色吗？"},fnlist:a},A.open({template:"../partials/dialogue/common_dia_prompt.html",className:"ngdialog-theme-plain",scope:P})},t=function(e){if(0==e.code){if(null!=e.data)if(0<e.data.length){var t=[];for(var a in e.data)e.data[a]&&101!=e.data[a].roleID&&103!=e.data[a].roleID&&t.push(e.data[a]);s=function(e){var t=[];for(var a in e)(S.user.domainPath.split("/").length<=4||null!=e[a]&&-1<e[a].domainPath.search(S.user.domainPath))&&t.push(e[a]);return t}(t);var n=[],i=[];P.menuitems.D02_A02_S17&&n.push({icon:"fa fa-plus",class:"btn btn-primary btn-sm",label:"添加角色",style:{margin:"2px"},type:"button",events:{click:d}}),P.menuitems.D04_A02_S17&&n.push({icon:"glyphicon glyphicon-minus",class:"btn btn-default btn-sm",label:"删除角色",style:{margin:"2px"},type:"button",disabled:function(e){var t=e.filter(function(e){return 1==e.selected});if(0==t.length)return!0;for(var a in t)if(100==t[a].roleID)return!0},events:{click:c}}),P.menuitems.D03_A02_S17&&i.push({label:"编辑",type:"button",class:"btn btn-primary",disabled:function(e){return 1!=S.user.userID&&o(e.roleID)},events:{click:u}}),P.menuitems.D04_A02_S17&&i.push({label:"删除",type:"button",class:"btn btn-default",disabled:function(e){return 1!=S.user.userID&&(100==e.roleID||void 0)},events:{click:p}}),P.menuitems.D05_A02_S17&&i.push({label:"权限设置",type:"button",class:"btn btn-default",visible:function(e){return 1==S.user.userID||!o(e.roleID)},events:{click:r}}),P.menuitems.D06_A02_S17&&i.push({label:"用户分配",type:"button",class:"btn btn-default",events:{click:l}}),P.userlist={source:s,rowclass:function(e){return m.currentRole==e.roleID?"current":""},header:n,columnDefs:[{label:"角色名称",type:"text",filterable:!0,data:"roleName",width:"30%",modes:{default:{type:"text"},edit:{type:"input"}},format:function(e,t){return 1==S.user.userID?100==t.roleID||102==t.roleID?e+"A":101==t.roleID||103==t.roleID?e+"B":e:e}},{label:"角色描述",type:"text",filterable:!0,data:"description",modes:{default:{type:"text"},edit:{type:"input"}}},{label:"操作",type:"buttonGroup",filterable:!1,sortable:!1,width:"161px",modes:{default:{options:i},edit:{options:[{label:"保存",type:"button",class:"btn btn-primary",events:{click:f}},{label:"取消",type:"button",class:"btn btn-default",events:{click:L}}]}}}]}}else U.error("角色列表为空，请刷新页面重试");else U.error("角色列表为空，请刷新页面重试")}};T.queryUserByCondition({},function(e){0==e.code&&(null!=e.data&&0<e.data.length?(P.menuitems.A99_S17?e.data:e.data.filter(function(e){return-1<e.domainPath.search(S.user.domainPath)}),C.queryEnterpriseRole(t)):U.error("用户列表为空，请刷新页面重试"))})},s=function(){"user"==P.panel?r():l()};S.user.isAuthenticated?s():P.$on("loginStatusChanged",function(e,t){S.user.isAuthenticated&&s()})}])});
//# sourceMappingURL=../../../map/app-oc/js/controllers/user-list-ctrl.js.map
