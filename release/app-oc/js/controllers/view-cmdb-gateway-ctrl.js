define(["controllers/controllers","bootstrap-dialog"],function(e,U){"use strict";e.initController("ViewCmdbGatewayCtrl",["$scope","$controller","FileUploader","ngDialog","$q","$location","$routeParams","$timeout","kpiDataService","userLoginUIService","resourceUIService","alertService","SwSocket","Info","viewFlexService","unitService","growl","userDomainService","userEnterpriseService","customerUIService","projectUIService","deviceAccessUIService","configUIService",function(n,e,t,a,s,i,c,o,d,r,l,u,f,y,v,g,m,w,p,b,h,D,G){console.info("切换到网关管理"),n.activeMainTab="网关视图",n.activeListTab=l.activeListTab?l.activeListTab:"tab1",n.routePathNodes={},n.selectedGateitem=null,n.gatewaysAry=[],n.domainListTree=[],n.domainListDic={},n.querySuppliers=[],n.selLength=10,n.gatewayactiveDevices=[],n.selectUnComfirmedDevice,n.serviceOrigin=G.origin+"/api/rest/import/resourceUIService/importDevice",n.fileFormat="xls、xlsx",n.fileMaxSize=10,e("AppUploadCtrl",{$scope:n,growl:m,FileUploader:t}),n.toggle=function(){$("#fileName").click()},n.uploadExcel=function(e){n.uploader.formData.push({config:"deviceInfo"}),n.uploader.uploadAll()},n.$on("uploadTemplate",function(e,t){0==t.response.code&&m.success("设备导入成功",{})}),n.exportModel=function(){var e=n.selectedDevices,t="";for(var a in e)t+=e[a].id+",";location.href=G.origin+"/api/rest/export/resourceUIService/exportDevice/"+c.gatewayId+".xlsx/"+t+"/deviceInfo/"};var I=!(n.uploader.onAfterAddingFile=function(e){n.uploader.queue.length>n.queueLimit&&n.uploader.removeFromQueue(0),n.uploadExcel()}),C=(y.get("../localdb/icon.json",function(e){n.iconList=e.qualityIcon,n.kpiIconList=e.kpiIcon}),function(){n.$broadcast(Event.CMDBINFOSINIT+"GATEACTIVE",{data:n.gatewayactiveDevices})}),S=function(e){n.gatewayactiveDevices=[],e.devices?(n.gatewayactiveDevices=e.devices,C()):l.getDevicesByCondition({gatewayId:e.id},function(e){0==e.code&&(n.gatewayactiveDevices=e.data,C())})},A=function(e,t){return e.selected=!1,e.id=e.id?e.id:0,e.customerId=e.customerId?e.customerId:null,e.projectId=e.projectId?e.projectId:null,e.name=e.name?e.name:"",e.externalGwId=e.externalGwId?e.externalGwId:"",e.accessName=e.accessName?e.accessName:"",e.accessPassword=e.accessPassword?e.accessPassword:"",e.protocolType=e.protocolType?e.protocolType:"",e.protocol=e.protocol?e.protocol:"",e.count=e.count,e.icon=(Math.random(),"glyphicon glyphicon-hdd"),e.alertlv=4==e.operationStatus?"bg-red":3==e.operationStatus?"bg-orange":2==e.operationStatus?"bg-yellow":"bg-green",e.isLoaded=0,e.label=e.name,e.onlineStatus=e.onlineStatus?e.onlineStatus:"无数据",e.managedStatus=e.managedStatus?e.managedStatus:"deactive",e.activeTime=e.activeTime?newDateJson(e.activeTime).Format(GetDateCategoryStrByLabel("")):"",e.expireTime=e.expireTime?newDateJson(e.expireTime).Format(GetDateCategoryStrByLabel("")):"",e.validTime="",e.activeTime&&e.expireTime&&(e.validTime="从"+e.activeTime+"到"+e.expireTime),2==n.choseGateWayTab&&e.values&&(e.enterpriseId=e.values.enterpriseId,e.productId=e.values.productId),e},T=function(e){for(var t in n.selectedGateitem.devices)if(n.selectedGateitem.devices[t].id==e.id){n.selectedGateitem.devices[t]=e;break}n.gatewayactiveDevices=n.selectedGateitem.devices};n.click=function(e){"网关视图"==n.activeMainTab&&(n.selectedGateitem=e,S(n.selectedGateitem),O(n.selectedGateitem),n.protocolVersionChange())},n.delGateWay=function(i,s){if("网关视图"==n.activeMainTab){if("active"==i.managedStatus)return void m.warning("启用状态的网关不能注销，请先停用该网关。",{});U.show({title:"提示",closable:!1,message:"确认注销【"+i.name+"】网关吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){i&&l.deleteGateway(i.id,function(e){if(0==e.code){var t=[];for(var a in n.gatewaysAry)n.gatewaysAry[a].id!=i.id&&t.push(n.gatewaysAry[a]);n.gatewaysAry=t,s&&s(i),n.selectedHandler("gateway",!0),m.success("注销网关成功",{}),j(t)}}),e.close()}},{label:"取消",action:function(e){e.close()}}]})}},n.gatewayHandler=function(e,t){"add"==e?location.href="#/gatewayInfo/0":"update"==e&&(location.href="#/gatewayInfo/"+t),l.activeListTab=""},n.addModel=function(){if("网关视图"==n.activeMainTab){var e=[];for(var t in n.gatewaysAry){var a=n.gatewaysAry[t];if(e.push(a),0==a.id)return void m.warning($.ProudSmart.message.saveVerify("网关"),{})}n.activeListTab=l.activeListTab="tab1",n.selectedGateitem=A({}),n.gatewaysAry=[n.selectedGateitem].concat(e),e=null,n.gatewayactiveDevices=[]}},n.attrLabel="",n.iconClick=function(e,t,a){"图标"!=$("#label"+t).val()&&(n.attrLabel=$("#label"+t).val()),"icon"==e?($("#label"+t).val("图标"),$("#label"+t).attr("disabled",!0),n.selectedDitem.attrs[t].label="图标"):("图标"==$("#label"+t).val()&&$("#label"+t).val(n.attrLabel),$("#label"+t).attr("disabled",!1))},n.saveModelSubItem=function(t){if("网关视图"==n.activeMainTab){if(2!=n.choseGateWayTab){if(!n.selectedGateitem.protocol)return void m.warning("请选接入协议",{});if(!n.selectedGateitem.protocolVersion)return void m.warning("请选接入版本",{})}else{if(!n.selectedGateitem.enterpriseId)return void m.warning("请选接入厂商",{});if(n.selectedGateitem.values||(n.selectedGateitem.values={}),n.selectedGateitem.values.enterpriseId=n.selectedGateitem.enterpriseId,!n.selectedGateitem.productId)return void m.warning("请选接入网关",{});n.selectedGateitem.values||(n.selectedGateitem.values={}),n.selectedGateitem.values.productId=n.selectedGateitem.productId}if("flexem"==n.selectedGateitem.protocol){if(!n.selectedGateitem.accessAddress)return void m.warning("请输入接入地址",{});if(!n.selectedGateitem.accessPassword)return void m.warning("请输入网关密码",{})}if(!n.selectedGateitem.domain)return void m.warning("请选择管理域",{});if(!n.selectedGateitem.customerId&&n.baseConfig.customerConfig.check&&n.baseConfig.customerConfig.display)return void m.warning("请选择"+(n.menuitems.S12&&n.menuitems.S12.label?n.menuitems.S12.label:"客户")+"名称",{});if(!n.selectedGateitem.projectId&&n.baseConfig.projectConfig.check&&n.baseConfig.projectConfig.display)return void m.warning("请选择"+(n.menuitems.S13&&n.menuitems.S13.label?n.menuitems.S13.label:"项目")+"名称",{});if(!n.selectedGateitem.domains&&n.baseConfig.enterpriseConfig&&n.baseConfig.enterpriseConfig.check)return void m.warning("请选择企业名称",{});if((n.selectedGateitem.externalGwId||n.selectedGateitem.name)&&!/^[\u4e00-\u9fa5_a-zA-Z][\u4e00-\u9fa5_a-zA-Z0-9._-]{1,32}$/.test(n.selectedGateitem.name))return void m.warning("网关名称输入格式不正确，请重新输入",{});if(!n.selectedGateitem.externalGwId)return void m.warning("请输入网关标识",{});if(!n.selectedGateitem.name)return void m.warning("请输入网关名称",{});if(0==n.selectedGateitem.id)for(var e in n.gatewaysAry)if(0!=n.gatewaysAry[e].id&&n.gatewaysAry[e].externalGwId==n.selectedGateitem.externalGwId)return void m.warning("网关标识已经存在",{});0==n.selectedGateitem.id?l.addGateway(n.selectedGateitem,function(e){0==e.code&&(e.data&&(n.selectedGateitem=A(e.data)),t?t(!0):(m.success("添加网关成功",{}),i.url("/gatewayInfo/"+n.selectedGateitem.id),i.replace()))}):l.updateGateway(n.selectedGateitem,function(e){0==e.code&&(e.data&&(n.selectedGateitem=A(e.data)),t?t():m.success("更新网关成功",{}))})}},n.addIns=function(){var e=n.selectedGateitem;if(e){if(0==e.id)return void m.warning("当前网关没有保存，请先保存网关",{});for(var t in n.gatewayactiveDevices){var a=n.gatewayactiveDevices[t];if(0==a.id)return void m.warning("当前有未添加到网关设备，请点击保存按钮",{});if(4==a.isEdit)return void m.warning("当前有在编辑的网关设备，请点击保存按钮",{})}var i={gatewayId:e.id,label:"注册设备"+n.gatewayactiveDevices.length,id:0,domainPath:"",domainId:"",modelId:"",externalDevId:"",managedStatus:"deactive",onlineStatus:"offline",operationStatus:0,sn:"",gatewayDomainPath:e.domain,isEdit:2,selected:!1,createTime:new Date};n.gatewayactiveDevices.unshift(i),n.$broadcast(Event.CMDBINFOSINIT+"GATEACTIVE",{data:n.gatewayactiveDevices})}else m.warning("请先添加一个网关",{})},n.doActionUn=function(e,a,i){"select"==e?(n.selectUnComfirmedDevice=a,n.$apply()):"save"==e?(n.selectUnComfirmedDevice=a,l.selectUnComfirmedDevice=a,l.selectUnComfirmedDevice.from="unReco",n.infoPageManage("UNDEVICE")):"delete"==e&&U.show({title:"提示",closable:!1,message:"确认从 "+escape(n.selectedGateitem.name)+" 网关删除未识别设备吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){l.deleteUnRecognizedDevice(a.id,function(e){if(0==e.code){for(var t in n.unComfirmedDevice)if(n.unComfirmedDevice[t].id==a.id){n.unComfirmedDevice.splice(t,1);break}i&&i(!0),m.success("注销成功",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]})},n.doAction=function(e,a,i){if("网关视图"==n.activeMainTab)if("gateSave"==e){if(!jQuery.trim(a.label))return void m.warning("名称不能为空",{});if(!jQuery.trim(a.externalDevId))return void m.warning("设备地址不能为空",{});if(!jQuery.trim(a.sn))return void m.warning("序列号不能为空",{});if(!jQuery.trim(a.modelId)||0==a.modelId)return void m.warning("设备模板不能为空",{});if(0<a.id)l.savePhysicalDevice(a,function(e){0==e.code?(T(e.data),i(e.data),m.success("保存成功",{})):i(!1)});else{for(var t in n.gatewayactiveDevices)if(0!=n.gatewayactiveDevices[t].id&&a.externalDevId==n.gatewayactiveDevices[t].externalDevId)return void m.warning("设备地址不能重复",{});l.registerDevice(n.selectedGateitem.id,a,function(e){0==e.code?(n.selectedGateitem.count++,T(e.data),i(e.data),m.success("注册成功",{})):i(!1)})}}else if("deviceEdit"==e)location.href="#/facility/DEVICE/"+n.selectedGateitem.id+"/"+a.id;else if("deviceActive"==e){if("active"!=n.selectedGateitem.managedStatus)return void m.warning("网关不是启用状态，无法启用设备!",{});if(!jQuery.trim(a.label))return void m.warning("名称不能为空",{});if(!jQuery.trim(a.modelId)||0==a.modelId)return void m.warning("设备模板不能为空",{});U.show({title:"提示",closable:!1,message:"确认从 "+escape(n.selectedGateitem.name)+" 网关启用 "+escape(a.label)+" 设备吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){l.activateDevice(a.id,function(e){if(0==e.code){for(var t in n.gatewayactiveDevices)if(n.gatewayactiveDevices[t].id==a.id){n.gatewayactiveDevices[t].managedStatus=a.managedStatus;break}i&&i(!0),n.selectedHandler("device",!0),m.success("启用成功",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]})}else if("deviceDel"==e)if(a.id<=0){for(var t in n.gatewayactiveDevices)if(n.gatewayactiveDevices[t].id==a.id){n.gatewayactiveDevices.splice(t,1),i(!0);break}}else U.show({title:"提示",closable:!1,message:"确认从 "+escape(n.selectedGateitem.name)+" 网关注销 "+escape(a.label)+" 设备吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){var t=function(){for(var e in n.gatewayactiveDevices)if(n.gatewayactiveDevices[e].id==a.id){n.gatewayactiveDevices.splice(e,1);break}i&&i(!0),n.selectedHandler("device",!0),m.success("注销成功",{})};0!=a.id?l.unregisterDevice(n.selectedGateitem.id,a.id,function(e){0==e.code&&t()}):t(),e.close()}},{label:"取消",action:function(e){e.close()}}]});else"deviceDeActive"==e&&U.show({title:"提示",closable:!1,message:"确认从 "+escape(n.selectedGateitem.name)+" 网关停用 "+escape(a.label)+" 设备吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){l.deactivateDevice(a.id,function(e){if(0==e.code){for(var t in n.gatewayactiveDevices)if(n.gatewayactiveDevices[t].id==a.id){n.gatewayactiveDevices[t].managedStatus=a.managedStatus;break}i&&i(!0),n.selectedHandler("device",!0),m.success("停用成功",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]})},n.doActiveHanddler=function(e,t,a){"active"==n.selectedGateitem.managedStatus?(e.providerDomainPath=null!=n.querySuppliers&&0<n.querySuppliers.length?n.querySuppliers[0].domainPath:"",l.activateDevice(e,function(e){0==e.code&&(a?t(!0,a):(t(!0),m.success("启用成功",{}),T(e.data)))})):m.warning("网关不是启用状态，无法启用设备!",{})},n.infoPageManage=function(e){var t=function(t){n.changeManagedStatus(n.selectedGateitem,function(e){n.selectedGateitem=e,t&&i.url("/gatewayInfo/"+n.selectedGateitem.id),i.replace()})};if("网关启用"==e)n.saveModelSubItem(function(e){t(e)});else if("网关停用"==e)t();else if("设备停用"==e)U.show({title:"提示",closable:!1,message:"当前有 "+n.activeDevices.length+" 个设备启用状态，确认要停用吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){var t=[];n.activeDevices.forEach(function(e){t.push(e.id)}),l.deactivateDevices(t,function(e){if(0==e.code){for(var t in n.gatewayactiveDevices)e.data.successObj.forEach(function(e){if(n.gatewayactiveDevices[t].id==e.id)return n.gatewayactiveDevices[t].managedStatus=e.managedStatus,!0}),n.gatewayactiveDevices[t].selected=!1;n.selectedHandler("device",!0),C(n.gatewayactiveDevices),m.success("停用成功"+e.data.successObj.length+"个设备,失败"+e.data.failObj.length+"个设备",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("设备启用"==e){if("active"!=n.selectedGateitem.managedStatus)return void m.warning("网关不是启用状态，无法启用设备!",{});U.show({title:"提示",closable:!1,message:"当前有 "+n.deactiveDevices.length+" 个设备未启用状态，确认要启用吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){var t=[];n.deactiveDevices.forEach(function(e){t.push(e.id)}),l.activateDevices(t,function(e){if(0==e.code){for(var t in n.gatewayactiveDevices)e.data.successObj.forEach(function(e){if(n.gatewayactiveDevices[t].id==e.id)return n.gatewayactiveDevices[t].managedStatus=e.managedStatus,!0}),n.gatewayactiveDevices[t].selected=!1;n.selectedHandler("device",!0),C(n.gatewayactiveDevices),m.success("启用成功"+e.data.successObj.length+"个设备,失败"+e.data.failObj.length+"个设备",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]})}else"设备注销"==e?U.show({title:"提示",closable:!1,message:"当前有 "+n.deactiveDevices.length+" 个设备未启用状态，确认要注销吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){var t=[];n.deactiveDevices.forEach(function(e){t.push(e.id)}),l.unregisterDevices(n.selectedGateitem.id,t,function(e){0==e.code&&(e.data.successObj.forEach(function(e){for(var t in n.gatewayactiveDevices){if(n.gatewayactiveDevices[t].id==e){n.gatewayactiveDevices.splice(t,1);break}n.gatewayactiveDevices[t].selected=!1}}),n.selectedHandler("device",!0),C(n.gatewayactiveDevices),m.success("注销成功"+e.data.successObj.length+"个设备,失败"+e.data.failObj.length+"个设备",{}))}),e.close()}},{label:"取消",action:function(e){e.close()}}]}):"DEVICE"==e?location.href="#/facility/DEVICE/"+n.selectedGateitem.id+"/0":"UNDEVICE"==e?location.href="#/facility/UNDEVICE/"+n.selectedGateitem.id+"/"+n.selectUnComfirmedDevice.id:"FBOX"==e&&D.getFlexemCloudConfAddr(n.selectedGateitem.externalGwId,location.href,function(e){0==e.code&&window.open(e.data)})},n.changeManagedStatus=function(i,s){"active"==i.managedStatus?U.show({title:"提示",closable:!1,message:"停用网关的操作会使该网关下所有的设备一并停用，请确认要停用 "+escape(i.name)+" 网关吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){E=!0,l.deactivateGateway(i.id,function(e){if(0==e.code){var t=A(e.data);for(var a in n.gatewaysAry)if(n.gatewaysAry[a].id==t.id){n.gatewaysAry[a].managedStatus=t.managedStatus,n.gatewaysAry[a].simulated=!1;break}for(var a in i.devices)i.devices[a].managedStatus="deactive";s&&s(t),n.selectedHandler("gateway",!0),m.success("停用成功",{})}E=!1}),e.close()}},{label:"取消",action:function(e){e.close()}}]}):U.show({title:"提示",closable:!1,message:"确认启用 "+escape(i.name)+" 网关吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){E=!0,l.activateGateway(i.id,function(e){if(0==e.code){var t=A(e.data);for(var a in n.gatewaysAry)if(n.gatewaysAry[a].id==t.id){n.gatewaysAry[a].managedStatus=t.managedStatus,n.gatewaysAry[a].simulated=!1;break}s&&s(t),n.selectedHandler("gateway",!0),m.success("启用成功",{})}E=!1}),e.close()}},{label:"取消",action:function(e){e.close()}}]})};var E=!(n.domainTreeQuery=function(t){var e=function(e){n.domainListDic=e.domainListDic,n.domainListTree=e.domainListTree,t&&m.success("操作成功！")};n.baseConfig&&n.baseConfig.extendDomain,w.queryDomainTree(r.user.userID,e)}),j=function(e){P(e,function(){E||n.$broadcast(Event.CMDBINFOSINIT+"GATES",{data:e})})};n.queryDitem={statelabel:"",state:0,name:null,customerId:null,projectId:null,domain:null,managedStatus:null,externalGwId:null},n.goSearch=function(){n.activeGateways=[],n.deactiveGateways=[],n.queryDitem.name=0==n.queryDitem.state?n.queryDitem.name:null,n.queryDitem.externalGwId=1==n.queryDitem.state?n.queryDitem.externalGwId:null,n.queryDitem.customerId=2==n.queryDitem.state?n.queryDitem.customerId:null,n.queryDitem.projectId=3==n.queryDitem.state?n.queryDitem.projectId:null,n.queryDitem.managedStatus=4==n.queryDitem.state?n.queryDitem.managedStatus:null,n.queryDitem.domain=5==n.queryDitem.state?n.queryDitem.domain:null,M()};var M=function(){c.gatewayId?0==c.gatewayId?(n.selectedGateitem=A(n.defaultGatewayType),L(),n.queryenterprise({data:""})):l.getGatewayById(c.gatewayId,function(e){0==e.code&&(n.queryenterprise({data:e.data.domianPath}),n.selectedGateitem=A(e.data),"gateway2"==n.activeListTab?q():L())}):l.getAllGatewaysByCondition(n.queryDitem,function(e){if(n.gatewaysAry=[],n.gatewaysIdAry=[],n.gatewaysObj={},0==e.code){for(var t in e.data)n.gatewaysAry.push(A(e.data[t])),n.gatewaysIdAry.push(e.data[t].id),e.data[t].devices=[],n.gatewaysObj[e.data[t].id]=e.data[t];j(n.gatewaysAry),n.activeListTab="tab1",L()}})};n.customersList,n.customersDic={},n.queryCustomer=function(t){var a=s.defer();b.findCustomersByCondition({},function(e){n.customersDic=e.customerDic,e.data.forEach(function(e){e.text=e.customerName}),n.customersList=e.data,a.resolve("success"),t&&m.success("操作成功！")}),N.push(a.promise)},n.projectsList,n.projectsDic={},n.queryProject=function(t){var a=s.defer();h.findProjectsByCondition({},function(e){0==e.code&&(e.data.forEach(function(e){(n.projectsDic[e.id]=e).text=e.projectName}),n.projectsList=e.data,a.resolve("success"),t&&m.success("操作成功！"))}),N.push(a.promise)},n.enterpriseList,n.enterpriseDic={},n.queryenterprise=function(e){if(n.menuitems.S34){var t={domainPath:e.data,modelId:303,layer:2};l.getDomainsByFilter(t,function(e){0==e.code&&(e.data.forEach(function(e){(n.enterpriseDic[e.id]=e).text=e.label}),n.enterpriseList=e.data)})}},n.protocols=[],n.protocolVersions=[],n.collectionTemplateDic=[];n.unComfirmedDevice="";var O=function(e){l.findUnRecognizedDevice(e.id,function(e){"0"==e.code&&(n.unComfirmedDevice=e.data,n.$broadcast(Event.CMDBINFOSINIT+"not",{data:e.data}))})};n.activeGateways=[],n.deactiveGateways=[],n.activeDevices=[],n.deactiveDevices=[],n.selectedDevices=[],n.selectedHandler=function(e,t){if("gateway"==e){var a=[],i=[];n.gatewaysAry.forEach(function(e){e.selected&&("active"==e.managedStatus?a.push(e):i.push(e))}),n.activeGateways=a,n.deactiveGateways=i,t||n.$apply()}else if("device"==e){var s=[],c=[],o=[];n.gatewayactiveDevices.forEach(function(e){e.selected&&(o.push(e),"active"==e.managedStatus?s.push(e):c.push(e))}),n.activeDevices=s,n.deactiveDevices=c,n.selectedDevices=o,t||n.$apply()}},n.customerDomain=function(e){e&&(n.selectedGateitem.domain=n.customersDic[e].domainPath)},n.changeDomain=function(e){n.selectedGateitem.customerId&&(e!=n.customersDic[n.selectedGateitem.customerId].domainPath&&(n.selectedGateitem.customerId="",n.selectedGateitem.projectId=""))},n.gatesActive=function(){U.show({title:"提示",closable:!1,message:"当前有 "+n.deactiveGateways.length+" 个网关未启用状态，确认要启用吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){var t=[];n.deactiveGateways.forEach(function(e){t.push(e.id)}),l.activateGateways(t,function(e){if(0==e.code){for(var t in n.gatewaysAry)e.data.successObj.forEach(function(e){if(n.gatewaysAry[t].id==e.id)return n.gatewaysAry[t].managedStatus=e.managedStatus,!(n.gatewaysAry[t].simulated=!1)}),n.gatewaysAry[t].selected=!1;n.selectedHandler("gateway",!0),j(n.gatewaysAry),m.success("启用成功"+e.data.successObj.length+"个网关,失败"+e.data.failObj.length+"个网关",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]})},n.gatesSimulate=function(){U.show({title:"提示",closable:!1,message:"当前有 "+n.activeGateways.length+" 个网关启用状态。确认要进行数据仿真吗？注意：停用网关即可关闭仿真。",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){var t=[];n.activeGateways.forEach(function(e){t.push(e.id)}),l.activateSimulatedGateways(t,function(e){if(0==e.code){for(var t in n.gatewaysAry)e.data.successObj.forEach(function(e){if(n.gatewaysAry[t].id==e.id)return n.gatewaysAry[t].simulated=e.simulated,!0}),n.gatewaysAry[t].selected=!1;n.selectedHandler("gateway",!0),j(n.gatewaysAry),m.success("仿真成功"+e.data.successObj.length+"个网关,失败"+e.data.failObj.length+"个网关",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]})},n.gatesDeactive=function(){U.show({title:"提示",closable:!1,message:"当前有 "+n.activeGateways.length+" 个网关启用状态，停用网关的操作会使该网关下所有的设备一并停用。确认要停用吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){var t=[];n.activeGateways.forEach(function(e){t.push(e.id)}),l.deactivateGateways(t,function(e){if(0==e.code){for(var t in n.gatewaysAry)e.data.successObj.forEach(function(e){if(n.gatewaysAry[t].id==e.id)return n.gatewaysAry[t].managedStatus=e.managedStatus,!0}),n.gatewaysAry[t].selected=!1;n.selectedHandler("gateway",!0),j(n.gatewaysAry),m.success("停用成功"+e.data.successObj.length+"个网关,失败"+e.data.failObj.length+"个网关",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]})},n.gatesDelete=function(){U.show({title:"提示",closable:!1,message:"当前有 "+n.deactiveGateways.length+" 个网关未启用状态，确认要注销吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){var t=[];n.deactiveGateways.forEach(function(e){t.push(e.id)}),l.deleteGateways(t,function(e){0==e.code&&(e.data.successObj.forEach(function(e){for(var t in n.gatewaysAry){if(n.gatewaysAry[t].id==e.id){n.gatewaysAry.splice(t,1);break}n.gatewaysAry[t].selected=!1}}),n.selectedHandler("gateway",!0),j(n.gatewaysAry),m.success("注销成功"+e.data.successObj.length+"个网关,失败"+e.data.failObj.length+"个网关",{}))}),e.close()}},{label:"取消",action:function(e){e.close()}}]})},n.devicesActive=function(){U.show({title:"提示",closable:!1,message:"当前有 "+n.deactiveGateways.length+" 个网关未启用状态，确认要启用吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){var t=[];n.deactiveGateways.forEach(function(e){t.push(e.id)}),l.activateGateways(t,function(e){if(0==e.code){for(var t in n.gatewaysAry)e.data.successObj.forEach(function(e){if(n.gatewaysAry[t].id==e.id)return n.gatewaysAry[t].managedStatus=e.managedStatus,!(n.gatewaysAry[t].simulated=!1)}),n.gatewaysAry[t].selected=!1;n.selectedHandler("gateway",!0),j(n.gatewaysAry),m.success("启用成功"+e.data.successObj.length+"个网关,失败"+e.data.failObj.length+"个网关",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]})},n.devicesDeactive=function(){U.show({title:"提示",closable:!1,message:"当前有 "+n.activeGateways.length+" 个网关启用状态，停用网关的操作会使该网关下所有的设备一并停用。确认要停用吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){var t=[];n.activeGateways.forEach(function(e){t.push(e.id)}),l.deactivateGateways(t,function(e){if(0==e.code){for(var t in n.gatewaysAry)e.data.successObj.forEach(function(e){if(n.gatewaysAry[t].id==e.id)return n.gatewaysAry[t].managedStatus=e.managedStatus,!(n.gatewaysAry[t].simulated=!1)}),n.gatewaysAry[t].selected=!1;n.selectedHandler("gateway",!0),j(n.gatewaysAry),m.success("停用成功"+e.data.successObj.length+"个网关,失败"+e.data.failObj.length+"个网关",{})}}),e.close()}},{label:"取消",action:function(e){e.close()}}]})},n.devicesDelete=function(){U.show({title:"提示",closable:!1,message:"当前有 "+n.deactiveGateways.length+" 个网关未启用状态，确认要注销吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){var t=[];n.deactiveGateways.forEach(function(e){t.push(e.id)}),l.deleteGateways(t,function(e){0==e.code&&(e.data.successObj.forEach(function(e){for(var t in n.gatewaysAry){if(n.gatewaysAry[t].id==e.id){n.gatewaysAry.splice(t,1);break}n.gatewaysAry[t].selected=!1}}),n.selectedHandler("gateway",!0),j(n.gatewaysAry),m.success("注销成功"+e.data.successObj.length+"个网关,失败"+e.data.failObj.length+"个网关",{}))}),e.close()}},{label:"取消",action:function(e){e.close()}}]})};var P=function(e,i){var t=[],a={};e.forEach(function(e){t.push(e.id),a[e.id]=e});if(d.getRealTimeKpiData(t,[999998],function(t){if(0==t.code){for(var a in t.data)e.forEach(function(e){e.id==t.data[a].nodeId&&(e.onlineStatus=0==t.data[a].value?"离线":"在线")});i(e)}},!0),"WebSocket"in window){var s={ciid:t.toString(),kpi:"999998"},c="register";f.register(x,c,function(t){e.forEach(function(e){if(e.id==t.data.nodeId)return e.onlineStatus=0==t.data.value?"离线":"在线",!1}),i(e)}),f.send(x,c,"kpi",s)}};n.$on("$destroy",function(){x&&f.unregister(x)});var x,q=function(){for(var e in n.gatewaysAry)n.gatewaysObj[n.gatewaysAry[e].id]&&(n.gatewaysObj[n.gatewaysAry[e].id].devices=[]);l.getDevicesByCondition({gatewayIds:n.gatewaysIdAry},function(e){if(0==e.code){var t=e.data;for(var a in t)n.gatewaysObj[t[a].gatewayId]&&n.gatewaysObj[t[a].gatewayId].devices.push(t[a]);n.$broadcast(Event.ECHARTINFOSINIT+"_graph",{optionData:n.gatewaysAry,optionObj:n.gatewaysObj})}}),o(function(){$(".chart").resize()},300)},L=function(){"tab2"==n.activeListTab?S(n.selectedGateitem):"tab3"==n.activeListTab?O(n.selectedGateitem):"gateway2"==n.activeListTab&&q()},N=[],k=function(){if(!I){x=Math.uuid(),I=!0,$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){if(0<$(e.target).closest("li.disabled").length)return $(e.target).closest("li.disabled").removeClass("active"),void $(e.target).closest("ul").children("[name="+n.activeListTab+"]").addClass("active");var t=$(e.target).closest("li").attr("name");t&&(n.activeListTab=l.activeListTab=t,n.$apply(),L())}),p.querySupplier(function(e){0==e.code&&(n.querySuppliers=e.data)}),n.queryCustomer(),n.queryProject(),l.getRootModel(function(e){0==e.code&&(l.rootModel=e.data,l.getModels(function(e){if(0==e.code){l.rootModelDic={};var t=e.data;for(var a in t){var i=t[a];i.text=i.label,n.routePathNodes[i.parentModelId]||(n.routePathNodes[i.parentModelId]=[]),n.routePathNodes[i.parentModelId].push(i),n.routePathNodes[i.id]||(n.routePathNodes[i.id]=[]);var s=jQuery.extend(!0,{},i);l.rootModelDic[s.id]=s}var c=function e(t){for(var a in n.routePathNodes)if(a==t.id){for(var i in t.nodes=n.routePathNodes[a],t.nodes)e(t.nodes[i]);0==t.nodes.length&&(t.nodes=null)}};for(var o in c(l.rootModel),n.routePathNodes)if(o!=l.rootModel.id&&!l.rootModelDic[o])for(var a in n.routePathNodes[o])c(n.routePathNodes[o][a]),l.rootModel.nodes||(l.rootModel.nodes=[]),l.rootModel.nodes.push(n.routePathNodes[o][a]);l.rootModelDic[l.rootModel.id]=l.rootModel,n.rootModel=l.rootModel,n.rootModelDic=l.rootModelDic}}))});var a,i=s.defer();n.gatewayConfig={},n.defaultGatewayType={},a=function(){G.getConfigsByGroupName("DefaultGateWayType",function(e){if(0==e.code&&0<e.data.length){n.gatewayConfig=e.data[0],n.defaultGatewayType=JSON.parse(e.data[0].value),n.choseGateWayTab=n.defaultGatewayType.type;var t={};n.baseConfig.gatewayManufacturer.forEach(function(e){n.defaultGatewayType.enterpriseIds&&-1<n.defaultGatewayType.enterpriseIds.search(e.id)?(t[e.id]=e,t[e.id].selectCount=0,e.selected=!0):e.selected=!1}),n.baseConfig.gatewayModel.forEach(function(e){n.defaultGatewayType.productIds&&-1<n.defaultGatewayType.productIds.search(e.id)?(t[e.manufacturerId].selectCount+=1,e.selected=!0):e.selected=!1}),n.protocols.forEach(function(e){n.defaultGatewayType.protocols&&-1<n.defaultGatewayType.protocols.search(e.protocol)?e.selected=!0:e.selected=!1}),n.defaultGatewayType.display&&(n.gatewayModal=!0)}i.resolve("success")})},l.getAllCollectionPlugins(function(e){var t={};0==e.code&&(e.data.forEach(function(e){t[e.protocol]||(t[e.protocol]=e,n.protocols.push(e)),n.collectionTemplateDic[e.protocol+e.protocolVersion]=e.collectionTemplates}),n.protocolVersions=e.data),a&&a()}),N.push(i.promise),s.all(N).then(function(){M(),n.domainTreeQuery()})}};n.gateWayProtocolFilter=function(e){return!n.defaultGatewayType||!n.defaultGatewayType.protocols||-1<n.defaultGatewayType.protocols.search(e.protocol)},n.gateWayEnterPriseFilter=function(e){return!(n.selectedGateitem&&n.defaultGatewayType&&n.defaultGatewayType.enterpriseIds)||-1<n.defaultGatewayType.enterpriseIds.search(e.id)},n.gateWayProductFilter=function(e){return!(n.selectedGateitem&&n.defaultGatewayType&&n.defaultGatewayType.productIds)||n.selectedGateitem.enterpriseId==e.manufacturerId&&-1<n.defaultGatewayType.productIds.search(e.id)},n.productChange=function(){n.baseConfig.gatewayModel.forEach(function(e){e.id==n.selectedGateitem.productId&&(n.selectedGateitem.protocol=e.protocol,n.selectedGateitem.protocolVersion=e.protocolVersion)})},n.choseGateWayTab,n.choseGateWayTabHandler=function(e){n.choseGateWayTab=e},n.selectedEnterPrise={},n.gatewayEnterpriseChose=function(t){(n.selectedEnterPrise[t.index]=t).showProduct=!t.showProduct,n.baseConfig.gatewayManufacturer.forEach(function(e){e.id!=t.id&&(e.showProduct=!1)})},n.gatewayProductChose=function(t){t.selected=!t.selected,n.baseConfig.gatewayManufacturer.forEach(function(e){e.id==t.manufacturerId&&(t.selected?e.selectCount?e.selectCount+=1:e.selectCount=1:e.selectCount?e.selectCount-=1:e.selectCount=0,0<e.selectCount?e.selected=!0:e.selected=!1)})},n.closeGateWayModal=function(){n.gatewayModal=!1},n.applyGateWayConfig=function(){if(null!=n.gatewayConfig.value){var t=JSON.parse(n.gatewayConfig.value);t.type=n.choseGateWayTab,t.display=n.defaultGatewayType.display,2!=t.type?(t.protocols="",n.protocols.forEach(function(e){e.selected&&(t.protocols+=e.protocol+",")})):(t.enterpriseIds="",t.productIds="",n.baseConfig.gatewayModel.forEach(function(e){e.selected&&(t.enterpriseIds+=e.manufacturerId+",",t.productIds+=e.id+",")})),n.defaultGatewayType.enterpriseIds=t.enterpriseIds,n.defaultGatewayType.productIds=t.productIds,n.defaultGatewayType.protocols=t.protocols,n.gatewayConfig.value=JSON.stringify(t),G.saveConfig(n.gatewayConfig,function(e){0==e.code&&(n.gatewayModal=!1)})}else m.warning("请检查一下您的全局配置是否配了网关类型默认设置",{})},r.user.isAuthenticated?k():n.$on("loginStatusChanged",function(e,t){r.user.isAuthenticated&&k()})}])});
//# sourceMappingURL=../../../map/app-oc/js/controllers/view-cmdb-gateway-ctrl.js.map
