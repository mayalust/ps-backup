define(["controllers/controllers","bootstrap-dialog","Array"],function(e,h){"use strict";e.initController("energyStructureCtrl",["$scope","$routeParams","$q","$timeout","$location","ngDialog","userLoginUIService","resourceUIService","energyConsumeUIService","growl",function(a,e,t,n,i,o,r,l,s,c){var u;a.$watch("myDicts",function(e,t){e&&(a.energyTypeList=a.myDicts.energyType,a.dataSourceTypeList=a.myDicts.dataSourceType)}),a.energyStrucInfo={title:"能耗结构管理",query:"",statisticsType:"",statisticsTypeList:{MONTH:"月",YEAR:"年",QUARTER:"季度"},ifShow:1e3==r.user.userType,commitFun:function(){h.show({title:"提示",closable:!1,message:"提交后将不能进行修改和删除，确认提交吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(t){s.saveEnergyConsumeTree(function(e){0==e.code&&(a.ifCommit=!0,c.success("能耗结构已提交",{}),a.$broadcast("commit"),t.close())})}},{label:"取消",action:function(e){a.ifCommit=!1,e.close()}}]})}};var d=function(n){var i,e=function(e){var t=e.parentID,a=n.find(function(e){return t==e.id});a?(null==a.children&&(a.children=[]),e.parent=a,Object.defineProperty(e,"parent",{enumerable:!1}),a.children.push(e)):(e.parent=null,Object.defineProperty(e,"parent",{enumerable:!1}),i=e)};for(var t in n)e(n[t]);return i};a.startSearch=function(){var e=u.filter(function(e){return-1!=e.name.indexOf(a.query)});""!=a.query&&null!=a.query?a.$broadcast("FILTERDATA",e):a.$broadcast("FILTERDATA_allData")},n(function(){a.$broadcast(Event.ENTERPRISEINIT+"_energy",{option:[]})}),e.enterpriseId?s.queryDomainsByEnterpriseId(e.enterpriseId,function(e){0==e.code&&(u=e.data,a.structureData=d(u))}):l.getDomainsByFilter([{modelId:303}],function(e){if(0==e.code){var t=e.data.some(function(e){return"yes"==e.commit});u=e.data,a.structureData=d(u),a.ifCommit=!!t}});r.user.isAuthenticated||a.$on("loginStatusChanged",function(e,t){r.user.isAuthenticated})}]),e.initController("energySignatureCtrl",["$scope","$routeParams","$timeout","$q","$location","ngDialog","unitService","userLoginUIService","energyConsumeUIService","growl","userDomainService",function(n,e,a,t,i,o,r,l,s,c,u){"View"==e.viewType&&(n.view=!0);var d=e.signatureId;n.selectedCount=0,n.$watch("myDicts",function(e,t){if(e){var a=n.myDicts.energyType;(n.energyTypeList=a).forEach(function(e){e.id=e.valueCode,e.text=e.label})}});var p=function(e,t){"edit_convert"==e?a(function(){n.$broadcast(Event.ENTERPRISEINIT+"_convertedit",{option:[t]})}):"convert"==e&&a(function(){n.$broadcast(Event.ENTERPRISEINIT+"_convert",{option:[t]})})};n.dialog={title:"能源折标系数",input:{energyType:"",valentweight:"",equal:"",createTime:new Date},select:{},button:[{label:"确定",disabled:function(){return!scope.dialog.input.every(function(e){return 0!=e.right})},fn:function(){if(n.tableInit.input.convertStandardYear){var t=n.dialog.input,a=0;n.queryConvertList.forEach(function(e){e.createTime==t.createTime&&(e.energyType=t.energyType,e.equal=t.equal,e.valentweight=t.valentweight,a++)}),0==a&&(delete t.id,n.queryConvertList.push(t)),p("edit_convert",n.queryConvertList),c.info("请点击“保存模板”按钮，以便对修改的内容进行保存！",{}),o.close()}else c.warning("请选择生效年度",{})}},{label:"取消",fn:function(){o.close()}}]},n.mistakeMesg={},n.verifyFun=function(e,t){var a;a=/^[+-]?([1-9][0-9]*|0)(\.[0-9]+)?%?$/.test(e),n.mistakeMesg[t]=!a},n.tableInit={header:{label:"能源折标系数管理",delete:"删除折标系数"},input:{convertStandardYear:"",state:"",id:-1},select:{year:function(){for(var e=[],t=2015;t<2026;t++)e.push({id:t,text:t+"年"});return e}()},event:{addClick:function(){window.location.href="./index.html#/energySignatureInfo/0"},addEnergyClick:function(){n.dialog.input={energyType:"",valentweight:"",equal:"",createTime:new Date,id:-1},o.open({template:"../partials/dialogue/energy_signatrue_dia.html",className:"ngdialog-theme-plain",scope:n})},saveClick:function(){if(n.tableInit.input.convertStandardYear){if(-1==n.tableInit.input.id){var e=[{energyConvertStandard:{convertStandardYear:n.tableInit.input.convertStandardYear},energyConvertStandardDetails:n.queryConvertList}];s.addEnergyConvertStandardDto(e,function(e){0==e.code&&(n.tableInit.input.id=e.data.energyConvertStandard.id,c.success("能源折标系数添加成功",{}))})}else if(0<n.tableInit.input.id){e=[{energyConvertStandard:{id:parseInt(n.tableInit.input.id),convertStandardYear:n.tableInit.input.convertStandardYear},energyConvertStandardDetails:n.queryConvertList}];s.updateEnergyConvertStandardDto(e,function(e){0!=e.code||c.success("能源折标系数修改成功",{})})}}else c.warning("请选择生效年度",{})},copyClick:function(){s.copyEnergyConvertStandardDto([n.selectedCount],function(e){0==e.code&&(n.queryAllList.push(e.data),p("convert",n.queryAllList),c.success("成功复制折标系数",{}),n.selectedCount=0)})},goClear:function(){n.tableInit.select.convertStandardYear=1==n.queryState.state?n.tableInit.select.convertStandardYear:null,n.tableInit.select.state=1==n.queryState.state?n.tableInit.select.state:null}}},n.doAction=function(e,t,a){"delete"==e?h.show({title:"提示",closable:!1,message:"确认删除该折标系数？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){s.deleteEnergyConvertStandardDto([t],function(e){a(e),0==e.code&&(t.forEach(function(e){for(var t in n.queryAllList)e==n.queryAllList[t].id&&n.queryAllList.splice(t,1)}),c.success("折标系数已删除",{}),n.selectedCount=0,n.$apply())}),e.close()}},{label:"取消",action:function(e){a(!1),e.close(),n.selectedCount=0,n.$apply()}}]}):"deleteDetail"==e?h.show({title:"提示",closable:!1,message:"确认删除该折标系数？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){a({code:0}),t.forEach(function(e){for(var t in n.queryConvertList)e==n.queryConvertList[t].id&&n.queryConvertList.splice(t,1)}),c.info("请点击“保存模板”按钮，以便对修改的内容进行保存！",{}),n.selectedCount=0,n.$apply(),e.close()}},{label:"取消",action:function(e){a(!1),e.close(),n.selectedCount=0,n.$apply()}}]}):"effect"==e&&h.show({title:"提示",closable:!1,message:"确认生效该折标系数？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){s.effectEnergyConvertStandard(t,function(e){a(e),0==e.code&&c.success("折标系数已生效",{})}),e.close()}},{label:"取消",action:function(e){a(!1),e.close(),n.selectedCount=0,n.$apply()}}]})},n.searchData=function(){var e={id:d||"",convertStandardYear:n.tableInit.select.convertStandardYear?n.tableInit.select.convertStandardYear:"",state:n.tableInit.select.state?n.tableInit.select.state:""};s.findEnergyConvertStandards([e],function(e){0==e.code&&(0<d&&(n.tableInit.input.convertStandardYear=e.data[0].convertStandardYear),n.queryAllList=e.data,p("convert",e.data))})};var f=function(){0<d?(n.tableInit.input.id=d,s.convertStandardByEnergyId([d],function(e){0==e.code&&(n.queryConvertList=e.data,p("edit_convert",e.data))})):(n.queryConvertList=[],p("edit_convert",[])),n.searchData()};l.user.isAuthenticated?f():n.$on("loginStatusChanged",function(e,t){l.user.isAuthenticated&&f()})}]),e.initController("energyTasksCtrl",["$scope","$routeParams","$timeout","$controller","kpiDataService","FileUploader","$q","userUIService","$location","ngDialog","unitService","userLoginUIService","energyConsumeUIService","growl","userDomainService",function(u,e,t,a,d,n,i,o,r,p,l,f,v,g,s){u.ifshowState=!1,u.userType=f.user.userType,-1<location.hash.search("#/InfoOnStateManagement")&&(u.ifshowState=!0),100==f.user.userType?u.state=[{id:"commit",label:"未审核"},{id:"pass",label:"审核"}]:u.state=[{id:"commit",label:"提交"},{id:"nocommit",label:"草稿"}],u.ifView=!1,u.selectedCount=0;var y={};u.$watch("myDicts",function(e,t){e&&u.myDicts.energyType.forEach(function(e){y[e.valueCode]=e})}),u.serviceOrigin=o.uploadFileUrl+"/api/rest/import/energyConsumeUIService/importEnergyConsumeRecords",u.fileFormat="|xls|xlsx|",a("AppUploadCtrl",{$scope:u,growl:g,FileUploader:n});u.$on("uploadTemplate",function(e,t){0==t.response.code&&g.success("能耗录入导入成功",{})}),u.uploader.onAfterAddingFile=function(e){u.uploader.queue.length>u.queueLimit&&u.uploader.removeFromQueue(0),u.uploader.formData=[],u.uploader.formData.push({config:"energyConsumeRecordModel"}),u.uploader.uploadAll(),g.info("能耗记录导入处理中，请耐心等待...")};var c=function(e){t(function(){u.$broadcast(Event.ENTERPRISEINIT+"_recordTask",{option:[e]})})};u.dialog={title:"能耗统计信息",button:[{label:"确定",fn:function(){var t=[];u.energyConsumeRecords.forEach(function(e){t.push({id:e.id,energyConsumeValue:e.energyConsumeValue})});v.saveEnergyConsumeRecords([t,u.selectedId],function(e){0==e.code&&g.success("能耗统计信息保存成功",{})}),p.close()}},{label:"取消",fn:function(){p.close()}}]},u.mistakeMesg={},u.verifyFun=function(e,t){var a;a=/^[+-]?([1-9][0-9]*|0)(\.[0-9]+)?%?$/.test(e),u.mistakeMesg[t]=!a},u.tableInit={header:{label:u.ifshowState?"信息状态管理":"统计数据上报",time:""},select:{enterpriseName:"",statisticsType:"",state:"",overdue:""},event:{goClear:function(){u.tableInit.select.enterpriseName=1==u.queryState.state?u.tableInit.select.enterpriseName:null,u.tableInit.select.statisticsType=2==u.queryState.state?u.tableInit.select.statisticsType:null,u.tableInit.select.state=3==u.queryState.state?u.tableInit.select.state:null,u.tableInit.select.overdue=4==u.queryState.state?u.tableInit.select.overdue:null},import:function(e){$("#nv-file-select-task").click()},timeImport:function(){if(u.tableInit.header.time){var e=new Date(u.tableInit.header.time).getFullYear(),t=new Date(u.tableInit.header.time).getMonth()+1;t<10&&(t="0"+t);var a=e+"-"+t,n=f.user.domains.split("/"),i=[a,n[n.length-2]];v.generateEnergyConsumeRecordTaskByTime(i,function(e){0==e.code&&(0<e.data.length?(u.queryAllList.push(e.data[0]),c(u.queryAllList)):g.info("新建任务数据为空，请重新选择时间范围",{}))})}else g.warning("请先选择时间",{})},export:function(e){location.href=o.uploadFileUrl+"/api/rest/export/energyConsumeUIService/exportEnergyConsumeRecord/"+encodeURI(encodeURI(e.statisticsPeriod))+".xls/"+e.id+"/energyConsumeRecord/"}}},u.doAction=function(e,l,a){var s="",c="",t="",n="";"MONTH"==l.statisticsType||"QUARTER"==l.statisticsType?(t=l.statisticsPeriod.substring(0,4),n=l.statisticsPeriod.substring(5),s=new Date(t+"-"+n+"-01"),c=new Date(t+"-"+n+"-02")):"YEAR"==l.statisticsType&&(s=new Date(l.statisticsPeriod+"-01-01"),c=new Date(l.statisticsPeriod+"-01-02"));var i=function(r,e){v.findEnergyConsumeRecordsByTaskId([e],function(e){if(0==e.code){var t={};t.nodeIdsAry=e.data.map(function(e){return e.energyConsumeNodeId}),t.energyAry=e.data.map(function(e){return y[e.energyType].label}),t.startTime=s,t.endTime=c,t.statisticsType=l.statisticsType,"pass"==r?(a=t,n=e.data,o=["kpi",{category:"time",isRealTimeData:!(i=function(){p.open({template:"../partials/dialogue/consume_record_tasks_dia.html",className:"ngdialog-theme-plain",scope:u})}),startTime:a.startTime,endTime:a.endTime,nodeIds:a.nodeIdsAry,kpiCodes:[3300],granularityUnit:a.statisticsType,aggregateType:["ORIGINAL"],queryInstances:a.energyAry.join(","),timeRange:"",statisticType:"psiot",includeInstance:!0,condList:[],timePeriod:0,dataType:1}],d.getValueList(o,function(e){if(0==e.code){var t={};n.forEach(function(e){t[e.energyConsumeNodeId]=e}),e.data.forEach(function(e){e.energyTypeName=e.instance,e.energyConsumeValue=e.value,e.energyConsumeNodeName=t[e.nodeId].energyConsumeNodeName,e.energyTypeUnit=t[e.nodeId].energyTypeUnit,e.energyConsumeTreeNodeName=t[e.nodeId].energyConsumeTreeNodeName}),u.energyConsumeRecords=e.data,i&&i()}})):(e.data.forEach(function(e){e.energyTypeName=y[e.energyType].label}),u.energyConsumeRecords=e.data,p.open({template:"../partials/dialogue/consume_record_tasks_dia.html",className:"ngdialog-theme-plain",scope:u}))}var a,n,i,o})};"edit"==e?(u.selectedId=l.id,u.ifView=!1,i(l.state,l.id)):"commit"==e?h.show({title:"提示",closable:!1,message:"确认"+(100==f.user.userType?"审核":"提交")+"该能耗统计信息？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){var t=100==f.user.userType?"pass":"commit";v.updateEnergyConsumeRecordTaskState([l,t],function(e){a(e),0==e.code&&(100==f.user.userType?g.success("能耗统计信息已审核",{}):g.success("能耗统计信息已提交",{}))}),e.close()}},{label:"取消",action:function(e){a(!1),e.close(),u.selectedCount=0,u.$apply()}}]}):"view"==e&&(u.ifView=!0,i(l.state,l.id))},u.searchData=function(){if(100==u.userType||3==u.userType)var e={enterpriseName:u.tableInit.select.enterpriseName?u.tableInit.select.enterpriseName:"",overdue:u.tableInit.select.overdue?u.tableInit.select.overdue:"",statisticsType:u.tableInit.select.statisticsType?u.tableInit.select.statisticsType:"",state:u.tableInit.select.state?u.tableInit.select.state:""};else e={statisticsType:u.tableInit.select.statisticsType?u.tableInit.select.statisticsType:"",state:u.tableInit.select.state?u.tableInit.select.state:""};v.findConsumeRecordTasksByCondition([e],function(e){0==e.code&&(u.queryAllList=e.data,c(e.data))})};var m=function(){u.searchData()};f.user.isAuthenticated?m():u.$on("loginStatusChanged",function(e,t){f.user.isAuthenticated&&m()})}]),e.initController("instructCtrl",["$scope","$routeParams","$timeout","$controller","directiveStrategyUIService","kqiManagerUIService","$q","resourceUIService","$location","ngDialog","unitService","userLoginUIService","energyConsumeUIService","growl","userDomainService",function(L,a,n,e,O,t,i,o,r,P,l,s,c,F,u){var M="确定",Y="取消",_=[{id:"MINUTE",label:"每分钟"},{id:"HOUR",label:"每小时"},{id:"DAY",label:"每天"},{id:"WEEK",label:"每周"},{id:"MONTH",label:"每月"},{id:"YEAR",label:"每年"}],H=[{label:"大于",id:"GT"},{label:"大于等于",id:"GE"},{label:"等于",id:"EQ"},{label:"不等于",id:"NE"},{label:"小于",id:"LT"},{label:"小于等于",id:"LE"},{label:"js脚本",id:"JS"}],V=function(e,t){$$.cacheAsyncData.call(o.getDirectivesByModelIdNotByRole,[e],function(e){0==e.code&&(e.data.forEach(function(e){e.label=e.name}),t(e.data))})},K=function(e,t){$$.cacheAsyncData.call(o.getDevicesByCondition,[e],function(e){0==e.code&&t(e.data)})},J=function(e,a){$$.cacheAsyncData.call(o.getDataItemsByModelId,[e],function(e){if(0==e.code){var t={};e.data.forEach(function(e){t[e.id]=e}),a(e.data)}})},d=function(){var t;t=function(e){var t,B={nodes:e,domainInfos:e};t=function(U){var t;t=function(R){var t=function(T){var C=function(){for(var e=[],t=0;t<24;t++)e.push({id:t,label:t});return e}(),S=function(){for(var e=[],t=0;t<60;t++)e.push({id:t,label:t});return e}(),E=function(){for(var e=[],t=1;t<32;t++)e.push({id:t,label:t});return e}(),A=function(){for(var e=[],t=1;t<13;t++)e.push({id:t,label:t});return e}(),D=[{id:1,label:"一"},{id:2,label:"二"},{id:3,label:"三"},{id:4,label:"四"},{id:5,label:"五"},{id:6,label:"六"},{id:7,label:"日"}],$={label:"KPI指标",value:"",right:!0,data:"kpi",type:"select",composory:!1,options:[],events:{change:function(e){}}},w=R.map(function(e){return e.name}),N=[],k=[],q={label:"",value:0,apply:!0,right:!0,data:"thresholds",message:"如若需要选择数据项，则条件和值都必须填写",type:"table",composory:!1,groups:[{composory:!0,value:1,label:"配置项"},{composory:!0,value:2,label:"取值"},{composory:!1,value:3,label:"数据项"},{composory:!1,value:4,label:"条件"},{composory:!1,value:5,label:"值"}],options:[]};if(T&&T.deviceModelId){var t=T.deviceModelId;K({modelId:t||"",domainPath:T.directiveDomainPath?T.directiveDomainPath:""},function(e){N=e}),V(t,function(e){k=e,J(t,function(e){$.options=e;var t=k.find(function(e){return e.id==T.directiveId}).params;t&&(q.options=t,q.options.forEach(function(t){t.inputs=[],t.inputs=t.inputs.concat([{label:"配置项",text:t.label,right:!0,data:"value",type:"text",composory:!1},{label:"取值",value:T.params.find(function(e){return e.kpiId==t.id}).value,maxlength:12,right:!0,data:"value",type:"input",placeholder:"请填写取值",composory:!1,events:{change:function(e){}}},{label:"KPI指标",value:T.thresholds.find(function(e){return e.targetKpiId==t.id}).kpiId,right:!0,data:"kpiId",type:"select",composory:!1,options:$.options,events:{change:function(e){}}},{label:"条件",value:T.thresholds.find(function(e){return e.targetKpiId==t.id}).compareType,right:!0,data:"compareType",type:"select",composory:!1,options:H,events:{change:function(e){}}},{label:"阈值",value:T.thresholds.find(function(e){return e.targetKpiId==t.id}).thresholdValue,right:!0,maxlength:12,data:"thresholdValue",type:"input",placeholder:"请填写内容",composory:!1,events:{change:function(e){}}}])})),a()})})}function a(){L.$tabInx=0,L.naviClick=function(e){L.$tabInx=e};var a={label:"计算方式",value:T&&-1<T.cron.indexOf("/")?"count":"assign",right:!0,data:"calmode",type:"select",composory:!1,options:[{id:"assign",label:"指定方式"},{id:"count",label:"执行次数"}],events:{change:function(e){var t=e.value,a=f.value;b(a,"",t)}}},n={label:"计算时间",maxlength:12,value:0,right:!0,data:"second",apply:!1,textAfter:"秒",type:"select",composory:!0,options:S,events:{change:function(e){}},filterFormat:{label:"label",value:"id"}},i={label:"计算时间",maxlength:12,value:0,right:!0,data:"secondcount",apply:!1,textAfter:"秒",type:"select",options:S,composory:!0,events:{change:function(e){}},filterFormat:{label:"label",value:"id"}},o={label:"开始计算",maxlength:12,value:0,right:!0,data:"day",apply:!1,options:E,textAfter:"日",type:"select",composory:!0,events:{change:function(e){}},filterFormat:{label:"label",value:"id"}},r={label:"开始计算",maxlength:12,value:0,right:!0,data:"daycount",apply:!1,options:E,textAfter:"日",type:"select",composory:!0,events:{change:function(e){}},filterFormat:{label:"label",value:"id"}},l={label:"开始计算",maxlength:12,value:0,apply:!1,right:!0,data:"minute",options:S,textBefore:"",textAfter:"分",type:"select",composory:!0,filterFormat:{label:"label",value:"id"}},s={label:"开始计算",maxlength:12,value:0,apply:!1,right:!0,data:"minutecount",options:S,textBefore:"",textAfter:"分",type:"select",composory:!0,filterFormat:{label:"label",value:"id"}},c={label:"开始计算",maxlength:12,value:0,apply:!0,right:!0,data:"hour",textAfter:"点",type:"select",composory:!0,events:{change:function(e){}},options:C,filterFormat:{label:"label",value:"id"}},u={label:"开始计算",maxlength:12,value:0,apply:!0,right:!0,data:"hourcount",textAfter:"点",type:"select",composory:!0,events:{change:function(e){}},options:C,filterFormat:{label:"label",value:"id"}},d={label:"开始计算",maxlength:12,value:0,apply:!1,right:!0,data:"week",textBefore:"星期",options:D,type:"select",composory:!0,events:{change:function(e){}},filterFormat:{label:"label",value:"id"}},p={label:"开始计算",apply:!1,maxlength:12,value:0,right:!0,data:"month",textAfter:"月",type:"select",options:A,composory:!0,events:{change:function(e){}},filterFormat:{label:"label",value:"id"}},f={label:"统计频率",maxlength:12,value:T?T.frequency:_[2].id,right:!0,data:"frequency",type:"select",composory:!0,options:_,events:{change:function(e){var t=e.value;a.value="assign",""==e.value?(e.error="统计频率不可为空",e.right=!1):(e.error=void 0,e.right=!0),b(t,"","assign")}}},v={label:"开始计算",maxlength:12,value:0,apply:!0,right:!0,data:"cron",type:"groupSelect",composory:!0,groups:[c,l]},e={label:"指令策略名称",maxlength:32,value:T?T.name:"",right:!!T,composory:!0,data:"name",placeholder:"指令策略名称",events:{change:function(e){""==e.value?(e.error="指令策略名称不可为空",e.right=!1):-1!=w.indexOf(e.value)?(e.error="指令策略名称已存在",e.right=!1):(e.error=void 0,e.right=!0)}},type:"input"},t={label:"指令策略描述",maxlength:200,value:T?T.description:"",right:!0,composory:!1,data:"description",placeholder:"描述",type:"textarea"},g={label:"域路径",value:T?T.directiveDomainPath:"",right:!!T,type:"tree",sortable:!0,filterable:!0,composory:!0,data:"directiveDomainPath",key:"domainPath",mark:"nodes",options:B,modes:{default:{type:"text"}},events:{change:function(e){""==e.value?(e.error="域路径不可为空",e.right=!1):(e.error=void 0,e.right=!0,K({domainPath:e.value,modelId:L.dialog.tabs[1].inputs[1].value?L.dialog.tabs[1].inputs[1].value:""},function(e){L.dialog.tabs[1].inputs[3].options=e}))}}},y={label:"资源模板",maxlength:12,value:T?T.deviceModelId:"",right:!!T,data:"deviceModelId",type:"select",composory:!0,options:U,events:{change:function(e){if(e.value){var t=e.value;K({domainPath:L.dialog.tabs[1].inputs[0].value?L.dialog.tabs[1].inputs[0].value:"",modelId:t},function(e){L.dialog.tabs[1].inputs[3].options=e}),V(t,function(e){L.dialog.tabs[1].inputs[2].options=e}),J(t,function(e){$.options=e}),e.error="",e.right=!0}else e.error="资源模版不可为空",e.right=!1}}},m={label:"设备",value:T?T.deviceIds:[],right:!0,data:"deviceIds",type:"multiple",composory:!1,options:T&&N?N:[],events:{change:function(e){}}},h={label:"指令",value:T?T.directiveId:"",right:!!T,data:"directiveId",type:"select",composory:!0,options:T&&0<k.length?k:[],events:{change:function(t){if(t.value){var e=L.dialog.tabs[1].inputs[2].options.find(function(e){return e.id==t.value}).params;e&&(L.dialog.tabs[3].inputs[0].options=e,L.dialog.tabs[3].inputs[0].options.forEach(function(e){e.inputs=[],e.inputs=e.inputs.concat([{label:"配置项",text:e.label,right:!0,data:"value",type:"text",composory:!1,events:{change:function(e){}}},{label:"取值",value:e.data,maxlength:12,right:!1,data:"value",type:"input",placeholder:"请填写取值",composory:!1,events:{change:function(e){""==e.value?(e.error="取值不可为空",e.right=!1):(e.error=void 0,e.right=!0)}}},{label:"KPI指标",value:"undefined"==e.kpiId?"请选择kpi指标":e.kpiId,right:!0,data:"kpiId",type:"select",composory:!1,options:$.options,events:{change:function(e){}}},{label:"条件",value:"undefined"==e.condition?"请选择条件":e.condition,right:!0,data:"compareType",type:"select",composory:!1,options:H,events:{change:function(e){}}},{label:"阈值",value:e.value,right:!0,maxlength:12,data:"thresholdValue",type:"input",placeholder:"请填写阈值",composory:!1,events:{change:function(e){}}}])})),t.error=void 0,t.right=!0}else t.error="指令不可为空",t.right=!1}}},b=function(e,t,a){"MINUTE"==e||"MINUTECOUNT"==e?(v.apply=!0,n.value=t?t[0]:0,i.value="count"==a?t[1]:0,"assign"==a?(n.textBefore="",n.textAfter="秒",v.groups=[n]):"count"==a&&(n.textBefore="从",n.textAfter="秒开始",i.textBefore="每",i.textAfter="秒，执行一次",v.groups=[n,i])):"HOUR"==e||"HOURCOUNT"==e?(v.apply=!0,"assign"==a?(l.value=t?(n.value=t[0],t[1]):n.value=0,l.textBefore="",l.textAfter="分",n.textBefore="",n.textAfter="秒",v.groups=[l,n]):"count"==a&&(l.value=t?(n.value=t[0],s.value=t[2],t[1]):(n.value=0,s.value=0),l.textBefore="从",l.textAfter="分开始",s.textBefore="每",s.textAfter="分执行一次",n.textBefore="",n.textAfter="秒",v.groups=[l,s,n])):"DAY"==e||"DAYCOUNT"==e?(v.apply=!0,"assign"==a?(c.value=t?(l.value=t[0],t[1]):l.value=0,c.textBefore="",c.textAfter="时",l.textBefore="",l.textAfter="分",v.groups=[c,l]):"count"==a&&(c.value=t?(l.value=t[0],u.value=t[2],t[1]):(l.value=0,u.value=0),c.textBefore="从",c.textAfter="时开始",u.textBefore="每",u.textAfter="时执行一次",l.textBefore="",l.textAfter="分",v.groups=[c,u,l])):"WEEK"==e?(d.value=t?(c.value=t[0],t[1]):(c.value=0,1),"assign"==a?(v.apply=!0,d.textBefore="星期",d.textAfter="",c.textBefore="",c.textAfter="点",v.groups=[d,c]):"count"==a&&(v.apply=!1)):"MONTH"==e||"MONTHCOUNT"==e?(v.apply=!0,"assign"==a?(o.value=t?(c.value=t[0],t[1]):(c.value=0,1),o.textBefore="",o.textAfter="日",c.textBefore="",c.textAfter="点",v.groups=[o,c]):"count"==a&&(o.value=t?(c.value=t[0],r.value=t[2],t[1]):(c.value=0,r.value=1),o.textBefore="从",o.textAfter="日开始",r.textBefore="每",r.textAfter="日执行一次",c.textBefore="",c.textAfter="点",v.groups=[o,r,c])):"YEAR"==e&&(p.value=t?(o.value=t[0],t[1]):o.value=1,"assign"==a?(v.apply=!0,p.textBefore="",p.textAfter="月",o.textBefore="",o.textAfter="日",v.groups=[p,o]):"count"==a&&(v.apply=!1))};if(T){var I=-1<T.cron.indexOf("/")?"count":"assign",x=function(t,e){var a=[{name:"MINUTECOUNT",regExp:/(\d+)\/(\d+)\ \*\ \*\ \*\ \*\ \?\ \*/},{name:"MINUTE",regExp:/(\d+)\ \*\ \*\ \*\ \*\ \?\ \*/},{name:"HOURCOUNT",regExp:/(\d+)\ (\d+)\/(\d+)\ \*\ \*\ \*\ \?\ \*/},{name:"HOUR",regExp:/(\d+)\ (\d+)\ \*\ \*\ \*\ \?\ \*/},{name:"DAYCOUNT",regExp:/0\ (\d+)\ (\d+)\/(\d+)\ \*\ \*\ \?\ \*/},{name:"DAY",regExp:/0\ (\d+)\ (\d+)\ \*\ \*\ \?\ \*/},{name:"MONTHCOUNT",regExp:/0\ 0\ (\d+)\ (\d+)\/(\d+)\ \*\ \?\ \*/},{name:"MONTH",regExp:/0\ 0\ (\d+)\ (\d+)\ \*\ \?\ \*/},{name:"YEAR",regExp:/0\ 0\ 0\ (\d+)\ (\d+)\ \?\ \*/},{name:"WEEK",regExp:/0\ 0\ (\d+)\ \?\ \*\ (\d+)\ \*/}].find(function(e){return e.regExp.test(t)});if(a){var n=[];if("assign"==e)for(var i=1;i<3;i++)(o=$$.runRegExp(t,a.regExp,i))&&n.push(parseInt(o));else if("count"==e)for(i=1;i<4;i++){var o;(o=$$.runRegExp(t,a.regExp,i))&&n.push(parseInt(o))}return{granular:a.name,type:e,data:n}}return null}(T.cron,I);x?b(x.granular,x.data,x.type):b("DAY","","assign")}else b("DAY","","assign");L.dialog={title:"指令策略",note:"",tabs:[{id:0,label:"基础信息",inputs:[e,t]},{id:1,label:"资源配置",inputs:[g,y,h,m]},{id:2,label:"定时策略",inputs:[f,a,v]},{id:3,label:"指令参数",inputs:[q]}],button:[{label:M,icon:"btn btn-primary",disabledFn:function(){var e=[];for(var t in L.dialog.tabs)e=e.concat(L.dialog.tabs[t].inputs);var a=e.some(function(e){return 0==e.right});if(0<L.dialog.tabs[3].inputs[0].options.length){var n=L.dialog.tabs[3].inputs[0].options;for(var i in n){var o=n[i].inputs;for(var r in o)if("取值"==o[r].label&&!o[r].value&&null==o[r].value)return!0}}return a},fn:function(){var e=L.dialog,t=[],a={kpiDefinitionIds:[],thresholds:[],params:[]};for(var n in e.tabs)t=t.concat(e.tabs[n].inputs);var i=function(a,e){var i,o="",r=["second","minute","hour","day","month","week","year"];i=["secondcount","minutecount","hourcount","daycount","monthcount","weekcount","yearcount"];var t=a.find(function(e){return"week"==e.data||"day"==e.data}),l="week";t&&(l="week"==t.data?"day":"week");var s=function(t){var e=a.find(function(e){return e.data==t});return e?e.value:void 0},c=!1;return"assign"==e.value?function e(t){var a=s(r[t]);null!=a?(c=!0,o+=a):o+=1==c?r[t]==l?"?":"*":"0",r[++t]&&(o+=" ",e(t))}(0):"count"==e.value&&function e(t){var a=s(r[t]);null!=a?(c=!0,o+=a):o+=1==c?r[t]==l?"?":"*":"0";var n=s(i[t]);o+=n?"/"+n+" ":" ",r[++t]&&e(t)}(0),o},o=function(e){for(var t in e.params){if(!(a=e.params[t]).value)return F.warning("请输入完整配置项的取值"),!1}for(var t in e.thresholds){var a;if((a=e.thresholds[t]).kpiId){if(!a.compareType)return F.warning("请选择数据项的条件"),!1;if(!a.thresholdValue)return F.warning("请输入完整数据项的值"),!1}else if(a.compareType||a.thresholdValue)return F.warning("请选择数据项"),!1}return!0};if(T){T.kpiDefinitionIds=[],T.thresholds=[],T.params=[];var r=t.find(function(e){return"calmode"==e.data}),l=function(e){"function"!=typeof e.value&&0!=e.calculable&&""!=e.data&&("groupSelect"==e.type?T[e.data]=i(e.groups,r):"table"==e.type?e.options.forEach(function(e){T.kpiDefinitionIds.push(e.id),T.thresholds.push({targetKpiId:e.id,kpiId:e.inputs[2].value,compareType:e.inputs[3].value,thresholdValue:e.inputs[4].value}),T.params.push({kpiId:e.id,name:e.name,value:e.inputs[1].value})}):T[e.data]=e.value)};for(var n in t)l(t[n]);if(!o(T))return;O.updateDirectiveStrategys(T,function(e){"0"==e.code&&(F.success("指令策略修改完成"),P.close())})}else{r=t.find(function(e){return"calmode"==e.data}),l=function(e){"function"!=typeof e.value&&0!=e.calculable&&""!=e.data&&("groupSelect"==e.type?a[e.data]=i(e.groups,r):"table"==e.type?e.options.forEach(function(e){a.kpiDefinitionIds.push(e.id),a.thresholds.push({targetKpiId:e.id,kpiId:e.inputs[2].value,compareType:e.inputs[3].value,thresholdValue:e.inputs[4].value}),a.params.push({kpiId:e.id,name:e.name,value:e.inputs[1].value})}):a[e.data]=e.value)};for(var n in t)l(t[n]);if(!o(a))return;O.addDirectiveStrategys(a,function(e){"0"==e.code&&(R.pushbefore(e.data),F.success("指令策略添加完成"),P.close())})}}},{label:Y,icon:"btn btn-default",fn:function(){P.close()}}]}}T||a(),P.open({template:"../partials/dialogue/config_alert_dia2.html",className:"ngdialog-theme-plain",scope:L})},e={},a={},n={},i=[];L.menuitems.A01_S34&&(e={icon:"fa fa-plus",class:"btn btn-primary btn-sm",label:"添加指令策略",style:{margin:"2px"},type:"button",events:{click:function(){t()}}}),L.menuitems.A02_S34&&(a={class:"btn btn-primary",label:"编辑",type:"button",events:{click:function(e){t(e)}}},i.push(a)),L.menuitems.A03_S34&&(n={class:"btn btn-default",label:"删除",type:"button",events:{click:function(t){var e,a,n;e=t.id,a=function(e){0==e.code&&(F.success("删除指令策略成功！"),t.remove())},n=[{label:M,icon:"btn btn-success",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){P.close(),O.deleteDirectiveStrategy(e,function(e){a(e)})}},{label:Y,icon:"btn btn-default",style:{width:"50%","border-radius":0,"font-size":"18px","font-weight":"bold",padding:10},fn:function(){P.close()}}],L.dialog={title:{label:"提示"},description:{label:"确认要删除此指令策略吗？"},fnlist:n},P.open({template:"../partials/dialogue/common_dia_prompt.html",className:"ngdialog-theme-plain",scope:L})}}},i.push(n)),L.menuitems.A04_S34&&(n={class:"btn btn-default",label:"详情",type:"button",events:{click:function(e){location.href="../app-oc/index.html#/instructionStrategy/"+e.id}}},i.push(n)),L.instructions={source:R,showSelector:!1,header:[e],columnDefs:[{label:"标识",width:"10%",editable:!0,sortable:!0,filterable:!0,data:"id",type:"text",modes:{default:{type:"text"},edit:{type:"input",placeholder:""}}},{label:"名称",width:"20%",editable:!0,sortable:!0,filterable:!0,data:"name",type:"text",modes:{default:{type:"text"},edit:{type:"input",placeholder:""}}},{label:"设备模板",width:"10%",editable:!0,sortable:!0,filterable:!0,data:"deviceModelId",type:"select",options:U,filterFormat:{label:"label",value:"id"},format:function(t,e){return e?U.find(function(e){return e.id==t}).label:"-"},modes:{default:{type:"text"},edit:{type:"input",placeholder:""}}},{label:"创建时间",data:"createTime",type:"date",format:"yy-mm-dd hh:nn:ss",filterable:!1,sortable:!0,modes:{default:{type:"date"}}},{label:"计算频率",width:"auto",editable:!0,sortable:!0,filterable:!0,data:"frequency",type:"select",options:_,filterFormat:{label:"label",value:"id"},format:function(t,e){return e?_.find(function(e){return e.id==t}).label:"-"},modes:{default:{type:"text"},edit:{type:"input",placeholder:""}}},{label:"操作",type:"buttonGroup",filterable:!1,sortable:!1,width:"141px",modes:{default:{options:i}}}]}},$$.cacheAsyncData.call(O.getDirectiveStrategys,[],function(e){0==e.code&&(null!=e.data&&null!=e.data||(e.data=[]),t(e.data))})},$$.cacheAsyncData.call(o.getModels,[],function(e){0==e.code&&t(e.data)})},$$.cacheAsyncData.call(u.queryDomainTree,[s.user.userID],function(e){0==e.code&&t(e.data)})},p=function(t){L.pipeline=function(e){var f=$.extend({pages:1,url:"",data:null,method:"POST"},e),v=-1,g=null,y=null,m=null;return function(n,i,e){var t=!1,a=n.start,o=n.start,r=n.length,l=a+r,s=n.columns[n.order[0].column].data,c=n.order[0].dir;if(e.clearCache?(t=!0,e.clearCache=!1):v<0||a<v||g<l?t=!0:JSON.stringify(n.order)===JSON.stringify(y.order)&&JSON.stringify(n.columns)===JSON.stringify(y.columns)&&JSON.stringify(n.search)===JSON.stringify(y.search)||(t=!0),y=$.extend(!0,{},n),t){if(a<v&&(a-=r*(f.pages-1))<0&&(a=0),g=(v=a)+r*f.pages,n.start=a,n.length=r*f.pages,$.isFunction(f.data)){var u=f.data(n);u&&$.extend(n,u)}else $.isPlainObject(f.data)&&$.extend(n,f.data);var d={start:n.start,length:n.length,sort:s,sortType:c,statCount:1==n.draw};L.getHistoryByPage(L.queryList,d,function(e,t){var a={};a.data=e,a.draw=n.draw,a.recordsTotal=null!=t?-1==t?m.recordsTotal:t:e.length,a.recordsFiltered=a.recordsTotal,m=$.extend(!0,{},a),v!=o&&a.data.splice(0,o-v),-1<=r&&a.data.splice(r,a.data.length),i(a)})}else{var p=$.extend(!0,{},m);p.draw=n.draw,p.data.splice(0,a-v),p.data.splice(r,p.data.length),i(p)}}},L.getHistoryByPage=function(e,t,a){O.getDirectiveStrategyHistory([e[0],e[1],t],function(e){0==e.code&&a&&a(e.data.data,e.data.total)})},L.goSearch=function(e){L.queryList=[t,e.way],n(function(){L.$broadcast(Event.ENTERPRISEINIT+"_history",{option:[]})})},t&&L.goSearch({way:""})};s.user.isAuthenticated?a.instrId?p(a.instrId):d():L.$on("loginStatusChanged",function(e,t){s.user.isAuthenticated&&(a.instrId?p(a.instrId):d())})}])});
//# sourceMappingURL=../../../map/app-oc/js/controllers/energy-ctrl.js.map
