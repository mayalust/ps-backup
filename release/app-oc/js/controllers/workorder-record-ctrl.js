define(["controllers/controllers","bootstrap-dialog"],function(t,e){"use strict";t.initController("WorkOrderRecordCtrl",["$scope","$rootScope","$location","$routeParams","$timeout","growl","userLoginUIService","userEnterpriseService","Info","$route","ticketTaskService","ticketCategoryService",function(r,s,t,a,e,i,o,n,d,c,l,u){r.processType={},r.activeListTab="tab1",r.ordercount={notdeal:0,dealing:0,done:0};var p=function(t){return t&&(t=newDateJson(t).Format(GetDateCategoryStrByLabel())),t};r.herfList=function(t,e,a){if(null!=(s.dataList=e)&&null!=e.ticketNo)if(""!=e.templateURL&&null!=e.templateURL&&null!=e.templateURL){var i=$.trim(e.templateURL)+"/"+e.id;location.href=i}else location.href="index.html#/orderdetail/"+e.id+"/task"},r.getRecordCount=function(){l.getTicketTasksByStatus(10,function(t){0==t.code&&(r.ordercount.notdeal=t.data.length)}),l.getTicketTasksByStatus(100,function(t){0==t.code&&(r.ordercount.dealing=t.data.length)}),l.getTicketTasksByStatus(200,function(t){0==t.code&&(r.ordercount.done=t.data.length)})},r.getRecordData=function(a){l.getTicketTasksByStatus(a,function(t){if(0==t.code){var e=null;10==a?(r.ordercount.notdeal=t.data.length,e="notdeal"):100==a?(r.ordercount.dealing=t.data.length,e="dealing"):200==a&&(r.ordercount.done=t.data.length,e="done"),r.recordData={columns:[{data:"ticketTitle",title:"工单名称"},{data:"ticketNo",title:"工单号"},{data:"processDefinitionId",title:"工单流程"},{data:"taskConfigName",title:"任务名称"},{data:"ticketPriorityCode",title:"紧急度"},{data:"senderName",title:"发送人"},{data:"sendTime",title:"发送时间"},{data:"finishedTime",title:"完成时间",visible:!1},{data:"option",orderable:!1,visible:null!=r.menuitems.A01_S08,title:"操作"}],columnDefs:[{targets:0,data:"ticketTitle",render:function(t,e,a){return"<span style='cursor:pointer;'>"+t+"</span>"}},{targets:1,data:"ticketNo",render:function(t,e,a){return"<span style='cursor:pointer;'>"+t+"</span>"}},{targets:2,data:"processDefinitionId",render:function(t,e,a){var i="";return r.processType&&null!=r.processType[t]&&(i=r.processType[t].name),"<span style='cursor:pointer;'>"+i+"</span>"}},{targets:3,data:"taskConfigName",render:function(t,e,a){return"<span style='cursor:pointer;'>"+t+"</span>"}},{targets:5,data:"senderName",render:function(t,e,a){return"<span style='cursor:pointer;'>"+t+"</span>"}},{targets:4,data:"ticketPriorityCode",render:function(t,e,a){var i,r;return 0==t?(i="alerts-minor",r="低"):100==t?(i="alerts-major",r="中"):200==t&&(i="alerts-critical",r="高"),'<span class="label '+i+'" style="cursor: pointer;">'+r+"</span>"}},{targets:6,data:"sendTime",render:function(t,e,a){return"<span style='cursor:pointer;'>"+p(t)+"</span>"}},{targets:7,data:"sendTime",render:function(t,e,a){return"<span style='cursor:pointer;'>"+p(t)+"</span>"}},{targets:8,data:"option",render:function(t,e,a){var i="";return r.menuitems.A01_S09&&(i="<a id='process' class='btn btn-default btn-sm' style='cursor: pointer;' ><i class='fa fa-close hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'>执行历史</span></a>"),i}}],data:[]},r.recordData.data=t.data,r.recordData.state=e,r.$broadcast(Event.WORKORDERRECORDINIT,r.recordData)}})};!function(){if($('a[data-toggle="tab"]').on("shown.bs.tab",function(t){if(0<$(t.target).closest("li.disabled").length)return $(t.target).closest("li.disabled").removeClass("active"),void $(t.target).closest("ul").children("[name="+r.activeListTab+"]").addClass("active");var e=$(t.target).closest("li").attr("name");if(e){r.activeListTab=e,r.$apply(),r.activeTab=$(t.target).text();var a=null;"tab1"==e?a=10:"tab2"==e?a=100:"tab3"==e&&(a=200),r.getRecordData(a)}}),u.getTicketCategorys(function(t){if(0==t.code)for(var e in t.data)r.processType[t.data[e].workflowId]=t.data[e]}),r.getRecordCount(),a&&a.state){var t=null,e=null;switch(a.state){case"notdeal":t=0,e=10;break;case"dealing":t=1,e=100;break;case"done":t=2,e=200}$("#myTab li:eq("+t+") a").tab("show"),r.getRecordData(e)}else r.getRecordData(10)}()}]),t.initController("orderDetailCtrl",["$scope","$rootScope","$location","$routeParams","$timeout","growl","resourceUIService","workflowService","faultKnowledgeUIService","userEnterpriseService","Info","$route","ticketTaskService","ticketCategoryService",function(o,t,e,a,i,r,s,n,d,c,l,u,p,f){var m=a.id;o.workType=a.workType,o.state=a.state,o.orderType="",o.priorityCode="",o.processType=[],o.workList="",o.tasksList="",o.historyData="",o.process="",o.processTime="",o.myObj={},o.myObjTop={},o.historyData={columns:[{title:"处理人",data:"handlerName"},{title:"处理时间",data:"finishedTime"}],columnDefs:[{targets:1,data:"option",render:function(t,e,a){return v(t)}}]},o.devicesAll="",o.allFault="";l.get("../localdb/info.json",function(t){o.orderType=o.myDicts.ticketCategory,o.priorityCodeList=t.priorityData});f.getTicketCategorys(function(t){if(0==t.code)for(var e in t.data)o.processType=t.data}),s.getDevicesByCondition({},function(t){0==t.code&&(o.devicesAll=t.data)}),d.getAllFaultKnowledges(function(t){0==t.code&&(o.allFault=t.data)}),o.findFault=function(){s.findFaultKnowledgeByModelId(o.orderAddData.deviceId.modelId,function(t){0==t.code&&(o.initData.faultList=t.data)})},o.formAryList=[],o.definitions={};o.startList="";var k=function(a,i){p.getTicket(a,function(t){var e,s;0==t.code&&(t.data.commitTime=v(t.data.commitTime),t.data.finishedTime=v(t.data.finishedTime),o.workList=t.data,"task"==o.workType&&(null!=o.workList.finishedTime&&""!=o.workList.finishedTime||(o.processTime="0"),null!=t.data.values&&""!=t.data.values&&(e=i,s=t.data.values,n.getWorkflowById(e,function(t){if(0==t.code){var e=t.data.startAttributeDefinitions,a=[];for(var i in e){var r={};r.label=e[i].label,r.name=e[i].name,r.dataType=e[i].dataType,r.value=s[e[i].label],a.push(r)}o.startList=a}}))),p.getTicketTasks(a,function(t){if(0==t.code){var e=[];for(var a in t.data)200!=t.data[a].taskStatus&&100!=t.data[a].taskStatus||e.push(t.data[a]);o.historyData.data=e,o.$broadcast(Event.WORKORDERRECORDINIT+"_history",o.historyData)}}))})},v=function(t){return t&&(t=newDateJson(t).Format(GetDateCategoryStrByLabel())),t};o.historyGo=function(){a.state;location.href="index.html#/workorderrecord"},o.save=function(e){o.detail.taskStatus=e,o.detail.values=o.definitions,0!=o.myObj.ticketStatus&&p.doTask(o.detail,function(t){0==t.code?100==e?r.success("工单已确认",{}):200==e&&(r.success("工单已完成",{}),o.historyGo()):r.success("工单操作失败",{})})};navigator.userAgent.toLowerCase().indexOf("webkit")<0&&(o.browserClass="wrong",o.myObj={display:"inline-flex"},o.myObjTop={"margin-top":"6px"}),"task"==o.workType?(p.getTicketTaskById(m,function(t){if(0==t.code)if(o.detail=t.data,t.data&&""!=t.data.attributeDefinitions&&null!=t.data.attributeDefinitions){var e=t.data.attributeDefinitions;for(var a in e){var i={};if(i.label=e[a].label,i.name=e[a].name,i.dataType=e[a].dataType,"200"==t.data.taskStatus||"100"==t.data.taskStatus){var r=t.data.values;o.definitions[e[a].label]=r[e[a].label]}else o.definitions[e[a].label]="";o.formAryList.push(i)}k(t.data.ticketNo,t.data.processDefinitionId)}else k(t.data.ticketNo,t.data.processDefinitionId)}),p.isMyTicketTask(m,function(t){0==t.code&&(o.myObj.ticketStatus=t.data)})):"order"==o.workType&&k(m,0)}]),t.initController("processDetailCtrl",["$scope","$rootScope","FileUploader","$location","$controller","$routeParams","$timeout","userUIService","sparePartUIService","growl","workflowService","userEnterpriseService","Info","$route","projectUIService","ticketTaskService","maintenanceUIService",function(n,t,e,a,i,r,s,o,d,c,l,u,p,f,m,k,v){n.status=r.status;var g=r.id;n.workType=r.workType,n.sparePartsArray={},n.devicesList=[],n.imgList=[],n.selectMajor="",n.taskList={ticketNo:"",ticketTitle:"",ticketCommitTime:"",ticketCreatorName:"",customerName:"",projectName:"",projectID:"",modelName:"",modelID:"",deviceSn:"",faultNo:"",faultPhenomenon:""},n.selectList={},n.urlService=o.uploadFileUrl,n.definitions={faultPhenomenon:"",stockOrderItemList:"",ticketTaskDesc:""},n.addAttachment=function(){var t=[];for(var e in n.selectList.allSparePartsList){var a=-1;for(var i in n.sparePartsInitList.data)n.selectList.allSparePartsList[e].id==n.sparePartsInitList.data[i].id&&(a=i);-1==a&&t.push(n.selectList.allSparePartsList[e])}for(var r in n.sparePartsInitList.data)if(null==n.sparePartsInitList.data[r].id)return void c.warning("当前有未保存的备件",{});n.sparePartsInitList.data.unshift({name:"",label:"",stockNumber:"",isEdit:3,id:null}),n.definitions.selectList=""},n.sparePartsInitList={},n.serviceOrigin=o.uploadFileUrl+"/api/rest/upload/maintenanceUIService/uploadTaskImage",i("AppUploadCtrl",{$scope:n,growl:c,FileUploader:e}),n.toggle=function(){$("#nv-file-select").click()},n.uploadExcel=function(t){n.uploader.uploadAll()},n.$on("uploadTemplate",function(t,e){0==e.response.code&&(c.success("上传成功",{}),n.imgList.push(e.response.data.file),n.$apply())}),n.uploader.onAfterAddingFile=function(t){n.uploader.queue.length>n.queueLimit&&n.uploader.removeFromQueue(0),n.uploadExcel()},n.saveAttachment=function(t){var e=-1;for(var a in n.sparePartsInitList.data)if(n.selectMajor==n.sparePartsInitList.data[a].id){c.warning("该备件已经使用",{}),e=n.selectMajor;break}-1==e&&(n.sparePartsInitList.data||(n.sparePartsInitList.data=[]),n.sparePartsArray[n.selectMajor].edit=7,n.sparePartsArray[n.selectMajor].editNumber="",n.sparePartsInitList.data.unshift(n.sparePartsArray[n.selectMajor]),n.selectMajor="",n.$broadcast(Event.WORKORDERRECORDINIT+"_deviceTask",n.sparePartsInitList))},n.cancelAttach=function(t){for(var e in n.sparePartsInitList.data)3==n.sparePartsInitList.data[e].isEdit&&3==t.isEdit?n.sparePartsInitList.data.splice(e,1):n.sparePartsInitList.data[e].id==t.id&&n.sparePartsInitList.data.splice(e,1);n.$broadcast(Event.WORKORDERRECORDINIT+"_deviceTask",n.sparePartsInitList)},n.processTask=function(e){var t=$('table[name="major"]').DataTable().$("input").serializeArray(),a=n.sparePartsInitList.data,i=[],r=n.detail.taskStatus;for(var s in t)for(var o in a)if(t[s].name==a[o].id){if(!t[s].value)return void c.warning("您有备件数量没有输入,请输入之后再保存",{});a[o].stockNumber=t[s].value,i.push(a[o])}n.definitions.stockOrderItemList=i,n.detail.values=n.definitions,n.detail.maintenanceContent=n.devicesList,n.detail.images=n.imgList,n.detail.taskStatus=e,n.selectList.ticketStatus&&k.doTask(n.detail,function(t){0==t.code?200==e?(c.success("处理任务成功",{}),location.href="index.html#/workorderrecord"):c.success("任务已确认",{}):n.detail.taskStatus=r})};var T=function(t){v.getInspectionItemsByDeviceId(t,function(t){0==t.code&&(t.data.forEach(function(t){t.status="0"}),n.devicesList=t.data)})},y=function(){k.isMyTicketTask(g,function(t){0==t.code&&(n.selectList.ticketStatus=t.data)}),n.sparePartsInitList.data=[],d.getAllSpareParts(function(t){if(0==t.code){var e=[];e.push({text:"请选择",label:"请选择",id:-1}),t.data.forEach(function(t){t.text=t.name,n.sparePartsArray[t.id]=t,e.push(t)}),k.getTicketTaskById(g,function(t){if(0==t.code){if(t.data.deviceId&&(t.data.maintenanceContent&&0<t.data.maintenanceContent.length?n.devicesList=t.data.maintenanceContent:T(t.data.deviceId)),n.detail=t.data,n.taskList.ticketNo=t.data.ticketNo,n.taskList.ticketTitle=t.data.ticketTitle,""!=t.data.variables&&null!=t.data.variables&&(n.taskList.ticketCommitTime=newDateJson(t.data.variables.ticketCommitTime).Format(GetDateCategoryStrByLabel()),n.taskList.projectId=t.data.variables.device.projectId),n.taskList.ticketCreatorName=t.data.variables.ticketCreatorName,n.taskList.modelName=t.data.variables.modelName,n.taskList.modelID=t.data.variables.modelID,n.taskList.customerID=t.data.variables.customerID,n.taskList.customerName=t.data.variables.customerName,n.taskList.faultNo=t.data.variables.faultNo,n.taskList.deviceSn=t.data.variables.deviceSn,n.taskList.faultPhenomenon=t.data.variables.faultPhenomenon,t.data.images&&(n.imgList=t.data.images),null!=t.data.values&&""!=t.data.values&&(n.definitions.ticketTaskDesc=t.data.values.ticketTaskDesc,null!=t.data.values.stockOrderItemList&&""!=t.data.values.stockOrderItemList)){n.sparePartsInitList.data=t.data.values.stockOrderItemList;var e=t.data.values.stockOrderItemList;for(var a in e)null!=n.sparePartsArray[e[a].id]&&(n.sparePartsArray[e[a].id].editNumber=e[a].stockNumber)}n.$broadcast(Event.WORKORDERRECORDINIT+"_deviceTask",n.sparePartsInitList)}}),n.allSpareParts=e}})};n.projectsList,n.projectsDic={},n.queryProject=function(){m.findProjectsByCondition({},function(t){0==t.code&&(t.data.forEach(function(t){(n.projectsDic[t.id]=t).text=t.projectName}),n.projectsList=t.data,y())})},n.queryProject()}]),t.initController("workTimeLineCtrl",["$scope","$rootScope","$location","$routeParams","$timeout","ticketLogService","growl","workflowService","userEnterpriseService","Info","$route","ticketTaskService","processService",function(e,t,a,i,r,s,o,n,d,c,l,u,p){var f=i.id;e.historyList=null,e.workOrderId=f,e.workOrderDetail=null,""!=f&&null!=f&&(u.getTicket(f,function(t){0==t.code&&(e.workOrderDetail=t.data)}),s.getByTicketNo(f,function(t){0==t.code&&(e.historyList=t.data)}))}])});
//# sourceMappingURL=../../../map/app-oc/js/controllers/workorder-record-ctrl.js.map
