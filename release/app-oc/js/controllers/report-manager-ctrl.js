define(["controllers/controllers","bootstrap-dialog"],function(e,p){"use strict";e.initController("reportTemplateCtrl",["$scope","$routeParams","ngDialog","FileUploader","userLoginUIService","userDomainService","reportFlexService","reportUIService","growl",function(r,e,t,a,o,l,n,i,c){var s=r.uploader=new a({url:n.origin+"/api/rest/uploadReport/reportUIService/updateTemplateFileName",withCredentials:!0});s.filters.push({name:"fileFilter",fn:function(e,t){var a=e.name.split("."),o=a[a.length-1];return 51200<e.size/1024?(c.warning("您选择的文件大于50M，请重新选择",{}),!1):"jrxml"==o||(c.warning("文件格式仅支持jrxml文件，请重新选择",{}),!1)}}),s.onWhenAddingFileFailed=function(e,t,a){s.clearQueue(),s.destroy(),console.info("onWhenAddingFileFailed",e,t,a)},s.onAfterAddingFile=function(e){r.selectedTemplate.tplFileName=e._file.name,s.queue[0].file.name=e._file.name,console.info("onAfterAddingFile",e)},s.onAfterAddingAll=function(e){console.info("onAfterAddingAll",e)},s.onBeforeUploadItem=function(e){Array.prototype.push.apply(e.formData,s.formData),console.info("onBeforeUploadItem",e)},s.onProgressItem=function(e,t){console.info("onProgressItem",e,t)},s.onProgressAll=function(e){console.info("onProgressAll",e)},s.onSuccessItem=function(e,t,a,o){console.info("onSuccessItem",e,t,a,o)},s.onErrorItem=function(e,t,a,o){c.warning("上传模版文件失败",{}),console.info("onErrorItem",e,t,a,o)},s.onCancelItem=function(e,t,a,o){console.info("onCancelItem",e,t,a,o)},s.onCompleteItem=function(e,t,a,o){console.info("onCompleteItem",e,t,a,o);var l=e.file.name.split(".");l[0],e.file.name;"zip"==l[l.length-1]?c.warning("次功能暂时还不能用",{}):n.getReportTemplateMeta(t.file,function(e){0==e.code&&(r.selectedTemplate.tplFileName=t.file,r.selectedTemplate.reportParams=e.data.reportParams,s.clearQueue(),r.$broadcast("uploadTemplate",!0))})},s.onCompleteAll=function(){console.info("onCompleteAll")},r.clearUploader=function(){s.clearQueue()},r.uploadImage=function(e){if(0!=s.queue.length){var t={templateId:e};s.formData.push(t),s.uploadAll()}else r.$broadcast("uploadTemplate",!0)},r.queryDitem={};r.reportDataSourceModel={id:0,name:"",driver:"",url:"",userName:"",passWord:""},r.dataSources=[],r.dataSourcesDic={},r.catalogs=[],r.catalogsDic={},r.reportTemplateModel={id:0,name:"",title:"",catalogId:1,catalogName:"",dataSourceId:1,dataSourceName:"",tplFileName:"",folder:"",insertUser:"",updateUser:"",insertTime:new Date,updateTime:null,reportParams:[],reportParamXML:"",columns:[],existBuildPolicy:0,zipFileName:"",fileName:"",domainPath:"",domain:"",isEdit:3},r.selectedTemplate,r.reportTemplates,r.goSearch=function(){var e={};r.queryDitem.domainPath&&null!=r.queryDitem.domainPath?e=r.queryDitem:(e=jQuery.extend(!0,{},r.queryDitem)).domainPath=o.user.domainPath,n.getReportTemplatesByCondition(e,function(e){0==e.code&&(e.data.forEach(function(e){e.fileName=e.tplFileName?e.tplFileName:e.zipFileName}),r.reportTemplates=e.data,r.$broadcast(Event.REPORTMODULE+"_template",{data:r.reportTemplates}))})},r.closeParams=function(){r.selectedTemplate=null,r.closeDialog()},r.goClear=function(){r.queryDitem={name:"",title:"",dataSourceId:"",catalogId:"",domainPath:"",insertUser:""}},r.addtemplate=function(){r.selectedTemplate?c.warning("当前有未保存的数据"):(r.reportTemplates||(r.reportTemplates=[]),r.selectedTemplate=jQuery.extend({},r.reportTemplateModel),r.reportTemplates.unshift(jQuery.extend({},r.reportTemplateModel)),r.$broadcast(Event.REPORTMODULE+"_template",{data:r.reportTemplates}))},r.updateParams=function(){n.updateReportTemplate(r.selectedTemplate,function(e){0==e.code&&(c.success("参数设置更新成功",{}),r.selectedTemplate=null,r.closeDialog())})},r.doAction=function(e,a,o){if("saveTemplate"==e){var l=r.$on("uploadTemplate",function(e,t){n.updateReportTemplate(r.selectedTemplate,function(e){0==e.code&&(0==a.id?c.success("添加报表模板成功",{}):c.success("更新报表模板成功",{}),o&&o(e.data),l())})});a.zipFileName=r.selectedTemplate.zipFileName,a.tplFileName=r.selectedTemplate.tplFileName,a.reportParams=r.selectedTemplate.reportParams,0==a.id?(a.tplFileName="",n.addReportTemplate(a,function(e){0==e.code&&(r.uploadImage(e.data.id),r.selectedTemplate=e.data,e.data.fileName=e.data.tplFileName?e.data.tplFileName:e.data.zipFileName)})):r.uploadImage(a.id)}else if("deleteTemplate"==e)p.show({title:"提示",closable:!1,message:"确认删除报表模板吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){n.deleteReportTemplate(a.id,function(e){if(0==e.code){for(var t=r.reportTemplates.length-1;-1<t;t--)r.reportTemplates[t].id==a.id&&r.reportTemplates.splice(t,1);r.selectedTemplate=null,c.success("删除报表模板成功",{}),r.reportTemplates.length<=0&&r.$broadcast(Event.REPORTMODULE+"_template",{data:r.reportTemplates}),o&&o(!0)}}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("paramsHandler"==e){r.selectedTemplate=a;var i=function(){t.open({template:"../partials/dialogue/report_params_dia.html",className:"ngdialog-theme-plain",scope:r})};r.paramShowList?i():n.getParamShowList(function(e){if(0==e.code){var t=[{label:"请选择",value:"-99"}];t=t.concat(e.data),r.paramShowList=t,i()}})}};r.closeDialog=function(){t.close()};var d=function(){i.getDataSourceConfigList(function(e){if(0==e.code){for(var t in e.data)r.dataSourcesDic[e.data[t].id]=e.data[t];r.dataSources=e.data}}),i.getReportCatalogList(function(e){if(0==e.code){for(var t in e.data)r.catalogsDic[e.data[t].id]=e.data[t];r.catalogs=e.data}}),l.queryDomainTree(o.user.userID,function(e){if(0==e.code){var t=e.data;r.domainListTree=t,r.domainListDic=e.domainListDic,r.goSearch()}})};o.user.isAuthenticated?d():r.$on("loginStatusChanged",function(e,t){o.user.isAuthenticated&&d()})}]),e.initController("reportSearchCtrl",["$scope","$routeParams","userLoginUIService","userDomainService","reportFlexService","growl","userUIService",function(a,e,o,t,i,l,r){a.iframeSrc="",a.queryDitem={};a.goClear=function(){a.selectedTemplate={}},a.reportDataSourceModel={id:0,name:"",driver:"",url:"",userName:"",passWord:""},a.dataSources=[{dataSourceId:0,dataSourceName:"无数据源",driver:"",url:"",userName:"",passWord:""},{dataSourceId:1,dataSourceName:"postgres",driver:"org.postgresql.Driver",url:"jdbc:postgresql://192.168.1.112:5432/psiot",userName:"postgres",passWord:"psiot2015"}],a.dataSourcesDic={},a.catalogs=[{catalogId:0,catalogName:"无分类"},{catalogId:1,catalogName:"默认分类"}],a.catalogsDic={},a.selectedTemplate,a.reportTemplates,a.getTemplates=function(){var e={};e.domainPath=o.user.domainPath,i.getReportTemplatesByCondition(e,function(e){0==e.code&&(e.data.forEach(function(e){e.domainPath=e.domain,e.fileName=e.tplFileName?e.tplFileName:e.zipFileName}),a.reportTemplates=e.data)})},a.doAction=function(e,t,a){if("pdfTemplate"==e){var o=[],l=(new Date).getTime();t.reportParams.forEach(function(e){var t={};t.label=e.name,t.value="STARTTIME"==e.name?new Date(l-36e5).Format("yyyy-MM-dd hh:mm:ss"):"ENDTIME"==e.name?(new Date).Format("yyyy-MM-dd hh:mm:ss"):"",o.push(t)}),i.getReportPdf(t.id,o,[],function(e){0==e.code&&alert("")})}},a.goSearch=function(e){if(a.selectedTemplate){var t=(new Date).getTime();a.selectedTemplate.reportParams.forEach(function(e){e.label=e.name,e.value||(e.value="STARTTIME"==e.name?new Date(t-864e5).Format("yyyy-MM-dd hh:mm:ss"):"ENDTIME"==e.name?(new Date).Format("yyyy-MM-dd hh:mm:ss"):"")}),e&&"HTML"!=e?"PDF"==e?i.getReportPdf(a.selectedTemplate.id,a.selectedTemplate.reportParams,[],function(e){0==e.code&&window.open(r.uploadFileUrl+"/api/rest/downloadReport/reportUIService/download?reportName="+e.data+"&reportFileName="+e.data)}):"WORD"==e?i.getReportWord(a.selectedTemplate.id,a.selectedTemplate.reportParams,[],function(e){0==e.code&&(location.href=""+r.uploadFileUrl+e.data)}):"XLS"==e?i.getReportXls(a.selectedTemplate.id,a.selectedTemplate.reportParams,[],function(e){0==e.code&&(location.href=""+r.uploadFileUrl+e.data)}):"PPT"==e&&i.getReportPpt(a.selectedTemplate.id,a.selectedTemplate.reportParams,[],function(e){0==e.code&&(location.href=""+r.uploadFileUrl+e.data)}):i.getReportHTML(a.selectedTemplate.id,a.selectedTemplate.reportParams,[],function(e){0==e.code&&(a.iframeSrc=r.uploadFileUrl+e.data)})}else l.warning("请选择一个报表模板")};var n=function(){t.queryDomainTree(o.user.userID,function(e){if(0==e.code){var t=e.data;a.domainListTree=t,a.domainListDic=e.domainListDic}}),a.getTemplates(),a.queryDitem={name:"",title:"",dataSourceId:"",catalogId:"",insertUser:""}};o.user.isAuthenticated?n():a.$on("loginStatusChanged",function(e,t){o.user.isAuthenticated&&n()})}]),e.initController("reportPolicyCtrl",["$scope","$routeParams","ngDialog","userLoginUIService","userDomainService","reportFlexService","growl",function(l,e,i,a,t,r,n){l.queryDitem={};var o=function(){l.queryDitem={name:"",periodTypeValue:"",dataSourceId:"",catalogId:"",domainPath:"",id:"",cronExp:""}};l.escapeCheck=function(e){return""+e},l.goClear=function(){o()},l.selectedPolicy,l.reportTemplates,l.reportTemplatePolicys,l.periodList,l.reportPolicyObj={},l.savePolicy=function(){l.selectedPolicy.id?(l.selectedPolicy.reportParamXML=null,l.selectedPolicy.reportParams=l.selectedPolicy.template.reportParams,r.updateReportBuildPolicy(l.selectedPolicy,function(e){0==e.code&&(l.goSearch(),n.success("更新报表生成策略成功",{}),l.closeDialog())})):(l.selectedPolicy.id=l.selectedPolicy.template.id,l.selectedPolicy.tplName=l.selectedPolicy.template.name,l.selectedPolicy.tplTitle=l.selectedPolicy.template.title,l.selectedPolicy.reportParams=l.selectedPolicy.template.reportParams,l.selectedPolicy.reportParamXML=null,r.addReportBuildPolicy(l.selectedPolicy,function(e){0==e.code?(l.goSearch(),n.success("添加报表生成策略成功",{}),l.closeDialog()):l.selectedPolicy.id=0}))},l.reportTemplatesAll=[],l.policyhandler=function(e){var t=l.reportTemplatesAll,a=[];for(var o in t)l.reportPolicyObj[t[o].id]||a.push(t[o]);null!=e&&0<e.id?l.reportTemplates=l.reportTemplatesAll:l.reportTemplates=a,e?(l.selectedPolicy=e,l.reportTemplates.forEach(function(e){e.id==l.selectedPolicy.id&&(l.selectedPolicy.template=e,l.selectedPolicy.template.reportParams=l.selectedPolicy.reportParams)})):l.selectedPolicy={template:{}},i.open({template:"../partials/dialogue/report_policy_dia.html",className:"ngdialog-theme-plain",scope:l})},l.initTemplateInfo=function(){var e={};e.domainPath=a.user.domainPath,r.getReportTemplatesByCondition(e,function(e){0==e.code&&(e.data.forEach(function(e){e.domainPath=e.domain,e.fileName=e.tplFileName?e.tplFileName:e.zipFileName}),l.reportTemplatesAll=e.data,l.reportTemplates=e.data)}),l.periodListObj={},r.getSendPeriod(function(e){if(0==e.code){for(var t in e.data)l.periodListObj[e.data[t].value]=e.data[t];l.periodList=e.data}})},l.getTemplatePolicys=function(){r.getReportBuildPolicyListByCondition({},function(e){0==e.code&&(l.reportTemplatePolicys=e.data);var t=e.data;for(var a in t)l.reportPolicyObj[""+t[a].id]=t[a];l.$broadcast(Event.REPORTMODULE+"_policy",{data:l.reportTemplatePolicys})})},l.doAction=function(e,t,a){if("deletepolicy"==e)p.show({title:"提示",closable:!1,message:"确认删除报表生成策略吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){r.deleteReportBuildPolicy(t.id,function(e){0==e.code&&(l.goSearch(),delete l.reportPolicyObj[t.id],n.success("删除报表生成策略成功",{}))}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("editpolicy"==e)l.policyhandler(t);else if("AlertEnable"==e){var o=t.enabled;p.show({title:"提示",closable:!1,message:1==o?"确认要启用此报表生成策略吗？":"确认要停用此报表生成策略吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){r.updateReportBuildPolicy(t,function(e){0==e.code&&a(e)}),e.close()}},{label:"取消",action:function(e){a(!1),e.close()}}]})}},l.goSearch=function(){l.queryDitem.domainPath&&null!=l.queryDitem.domainPath?l.queryDitem:jQuery.extend(!0,{},l.queryDitem).domainPath=a.user.domainPath,r.getReportBuildPolicyListByCondition(l.queryDitem,function(e){0==e.code&&(l.reportTemplatePolicys=e.data);var t=e.data;for(var a in t)l.reportPolicyObj[""+t[a].id]=t[a];l.$broadcast(Event.REPORTMODULE+"_policy",{data:e.data})})};var c=function(){t.queryDomainTree(a.user.userID,function(e){if(0==e.code){var t=e.data;l.domainListTree=t,l.domainListDic=e.domainListDic}}),l.initTemplateInfo(),l.goSearch(),o()};l.closeDialog=function(){i.close()},a.user.isAuthenticated?c():l.$on("loginStatusChanged",function(e,t){a.user.isAuthenticated&&c()})}])});
//# sourceMappingURL=../../../map/app-oc/js/controllers/report-manager-ctrl.js.map
