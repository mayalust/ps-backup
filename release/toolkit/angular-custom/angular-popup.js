function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(V,T,M){"use strict";var c=function(){var e,t=[];for(var n in arguments)0==n?e=arguments[n]:t.push(arguments[n]);"function"==typeof e&&e.apply(V,t)},O=function(e){for(var t in e)e[t]=e[t].value;return e},N=function(e,i){var o=[];for(var t in e)!function(e,t){if(!i||-1==i.indexOf(e)){var n=t.$clone();n.$name=e,o.push(n)}}(t,e[t]);return o},D=function(e){var t,n={};for(var i in e)t=e[i].$clone(),n[t.$name]=t,delete n[t.$name].$name;return n},e=["$timeout","popup","angular-style","keySet","growl","$rootScope",function(e,o,t,r,a,n){return{restrict:"A",priority:600,templateUrl:"../partials/popup.html",link:function(n,e,t){function i(){n.show=!1,o.checkDataValiad(function(e){"success"==e?c(o.onPanelSubmit,{index:o.getIndex(),parameters:o.getParameters(),style:o.getStyle(),echart:o.getEchart(),data:o.getSource(),advance:o.getAdvance()}):a.error(e)})}n.show=!1,n.$panelCancel=function(){n.show=!1,c(o.onPanelClose)},n.$panelSubmit=i,n.selectedView={items:[],item:null},n.initViewItems=function(){if(!(0<n.selectedView.items.length)){var e=o.getAdvance();e.data.condition?n.selectedView.items=JSONparse(e.data.condition):n.selectedView.items=[]}},n.saveViewItems=function(){n.selectedView.items.sort(function(e,t){return parseInt(e.index)-parseInt(t.index)});var t=[];n.selectedView.items.forEach(function(e){t.push({id:e.index,index:e.index,label:e.label,name:e.label,viewTitle:e.viewTitle,default:e.viewTitle,viewId:e.viewId,show:e.show})});var e=o.content[o.content.length-1];e.content.condition=t,e.list.forEach(function(e){"condition"==e.$name&&(e.value=t)})},n.addViewItem=function(){if(n.selectedView.item&&0==n.selectedView.items.filter(function(e){if(e.viewId==n.selectedView.item.viewId)return!0}).length){var e=jQuery.extend({},n.selectedView.item,!0);e.index=n.selectedView.items.length,n.selectedView.items.push(e)}},n.deleteViewItem=function(e){for(var t=n.selectedView.items.length-1;-1<t;t--)if(n.selectedView.items[t].viewId==e){n.selectedView.items.splice(t,1);break}},o.open=function(){n.show=!0,c(o.onPanelOpen)},r.onCommandKeyWith("enter",function(){i()}),n.popup=o}}}],t=["$timeout",function(t){return{scope:{template:"=",element:"="},restrict:"A",link:function(a,c,e){t(function(){var e=a.template.label?$("<div>"+a.template.label+"</div>"):null,t=$($("<table style='width:100%;height:100%;'><tr><td style='vertical-align: middle;'></td></tr></table>")),n=$(a.element);n.removeAttr("css");t.css({width:"100%",height:"80px",position:"relative",overflow:"hidden"}),"css"==a.template.type?(r=a.template.style,n.css(r),n.css("height","50px")):"image"==a.template.type?(o=a.template.url,n.css({"background-size":"contain","background-position":"center","background-repeat":"none",width:"100%",height:"100%","background-image":"url("+o+")"})):"text"==a.template.type&&(i=a.template.style,n.text("文字样例"),n.css(i));var i;var o;var r;t.find("td").append(n),null!=e&&c.append(e);c.append(t)}),a.$root.$$childHead.initViewItems()}}}],n=["$timeout",function(n){return{scope:{ngModel:"=",source:"="},restrict:"A",link:function(i,e,t){var r=$("<input class='form-control'/>");n(function(){e.append(r),r.autocomplete({select:function(e,n){i.$apply(function(){var t=n.item.value,e=i.source.find(function(e){return e.label==t.split("(")[0]});i.ngModel=e.$name})}}),i.$watch("ngModel",function(e,t,n){e==M&&r.val("")}),i.$watch("source",function(o,e,t){if(o){r.autocomplete("option","source",function(e,t){var n=e.term,i=o.map(function(e){return e.label+"("+e.$name+")"}).filter(function(e){return"___ALL___"==n||-1!=e.indexOf(n)});t(i)})}}),r.on("click",function(e){var t=""!=$(this).val()?$(this).val():"___ALL___";r.autocomplete("search",t)})})}}}];T.module("ngAngularPopup",[]).directive("example",t).directive("autocompletecustom",n).directive("popup",e).provider("popup",function(){var _=this;this.$get=["angular-style","kqiManagerUIService","serviceCenterService","dictionaryService","resourceUIService","dialogue","configUIService","$timeout","keySet","growl",function(e,l,u,h,y,t,r,a,c,i){var b={},x={},w={},k={},I={},S={};function A(r){return{getUsed:function(e){var t,n,i=e.$clone();if("object"==_typeof(r)&&null!=r)for(var o in i)n=i[t=o],r.hasOwnProperty(t)?"object"==_typeof(r[t])&&null!=r[t]&&(i[t]=r[t],i[t].value=n):delete i[t];return i},getUsedAll:function(e){var c;return"object"==_typeof(r)&&null!=r&&(c=r.$clone(),function e(t,n){for(var i in n)r=n[o=i],a=t?t+"/"+o:o,"object"!=_typeof(r)||"data"==o||r instanceof Array?"object"==_typeof(c[a])&&(c[a].value=r):e(a,r);var o,r,a}(M,e)),c},getNoused:function(e){var t,n;if("object"==_typeof(r)&&null!=r)for(var i in t=r.$clone(),e)e[n=i],delete t[n];return t},getAll:function(){return r.$clone()},getcss:function(e){return r[e]}}}return _.style=e.getStyle(),_.echart=e.getEchart(),_.parameters=e.getParameters(),_.source=e.getSource(),_.advance=e.getAdvance(),b={content:{},on:function(e,t){b[e]=t},getIndex:function(){return[_.index?_.index:0,_.subIndex?_.subIndex:0]},getStyle:function(){var e=O(D(D(this.content).$attr("style/list")));return{isDiff:JSON.stringify(e)!=JSON.stringify(I),data:e}},getEchart:function(){var e=function(e){var t={},c=_.echart;function l(e,t,n){for(var i in t)o=t[i],r=o.$name,o.value!=n.content[r].value&&e.$attr(r,o.value);var o,r}function u(e,t,n){for(var i in t)o=t[i],r=o.$name,o.value==n.content[r].value&&"type"!=r||e.$attr(r,o.value);var o,r}return function(r,e){for(var t in e){var a=e[t].$name;if(e[t].arraylike){if(e[t].hasOwnProperty("children"))for(var n in r[a]=[],e[t].children)!function(e,t){var n,i={};if("series"==a||"visualMap"==a){var o=t.children.find(function(e){return"type"==e.$name}).value;n=c[a].options[o],r[a].push(i),u(i,t.children,n)}else n=c[o=a].options[o],r[a].push(i),l(i,t.children,n)}(0,e[t].children[n])}else if(e[t].hasOwnProperty("children")){var i=c[a];r[a]={},l(r[a],e[t].children,i)}}}(t,e),t}(D(this.content).$attr("echart/list"));return{isDiff:JSON.stringify(e)!=JSON.stringify(w),data:e}},setContent:function(m,e,g,t,n,i){var o;b.domHtml=(o=e,$("<div></div>").append(o).html()),c.onCommandKeyWith("e",function(e){var t=b.content.find(function(e){return"advance"==e.$name});if(t){_.index=b.content.indexOf(t);var n=t.list.find(function(e){return"expression"==e.$name});b.selected=t,a(function(){n.open()})}}),b.content=m.map(function(e){var s=e.$clone();function d(l,e){0!=e&&(w=l.content.$clone());var t,n,i,o,r=function(e){var t=_[l.$name].$attr(e);return t},a=function(e,t){return r(e)!=M?A(r(e).content).getUsedAll(t):M},u=function(e){return A(r(e).content).getAll()};for(var s in l.content)t=s,n=l.content[s],l.content[t]=function(n,e){if(T.isArray(e)){var i=[],t=function(e){if("series"==n||"visualMap"==n)var t=a(n+"/options/"+e.type,e);else t=a(n+"/options/"+n,e);t&&i.push(t)};for(var o in e)t(e[o]);return i}return a(n,e)}(t,n);if(l.list=function(e,o){var t,n,i=[];for(var r in e)n=e[t=r],i.push(a(t,n));function a(n,i){var e=i?i.$clone():{},t=!o||-1==o.indexOf(n);return T.isArray(i)?{$name:n,folder:function(){var e=[];for(var t in i)e.push(a(n,i[t]));return e}()}:(e.$name=n,t?e:void 0)}return i}(l.content,!1),i=l.list,o=function(e,t,n){var i=t.$name,o=r(i);if(o)return function i(o,r,e){var a={},t=function(){_.subIndex=l.list.indexOf(this),l.selected=a},n=function(){e.$remove(function(e,t){return a==t})},c=function(){a.visible=!a.visible};return a={add:"series"==r.$name||"visualMap"==r.$name?function(e){var t=u(a.$name+"/options/"+e,m[s]);a.children.push(i(o,t,a.children))}:function(){var e,t;if("series"==a.$name||"visualMap"==r.$name){var n=a.children[a.children.length-1];t=n.children.find(function(e){return"type"==e.$name}).value}else t=a.$name;e=u(a.$name+"/options/"+t,m[s]),a.children.push(i(o,e,a.children))},click:t,delete:n,select:c,arraylike:r.folder!=M,$name:o.$name,label:o.label,visible:!1},r.folder==M?a.children=N(r,["$name"]):a.children=r.folder,a}(o,t,n)},function e(t){for(var n in t)t[n].folder&&e(t[n].folder),t[n]=o(n,t[n],t)}(i),g)if(1<g.length){var c=g[1];c=c>l.list.length?0:c}else c=0;else c=0;l.selected=l.list[c]}function f(e,t){0!=t&&(k=e.content.$clone());var n=A(_[e.$name]);e.list=N(n.getUsed(e.content)).map(function(e){return function(n){n.change=function(){};var t=function(){var e=function(e){n.select==e.value&&(n.selectItem=e),e.click=function(){n.select=e.value,n.selectItem=e},e.change=function(){}};if(n.options)for(var t in n.options)e(n.options[t])};return"fileInput"==n.$name&&(n.on=function(e,t){n.$EVENTS||(n.$EVENTS={}),n.$EVENTS[e]=t},n.trigger=function(e,t){n.$EVENTS[e](t)},n.on("imageFileUploaded",function(e){})),"imgSrc"==n.$name?r.getConfigsByGroupName("dashboardImage",function(e){"0"==e.code&&(Array.prototype.push.apply(n.options,e.data),t())}):t(),n}(e)})}function p(r,e){0!=e&&(I=r.content.$clone());var a=A(_[r.$name]);function c(){r.format={label:function(e){return e.label},value:"$name"},r.list=N(a.getUsed(r.content)).map(function(e){var t=e.$name;return e.change=function(){},e.delete=function(){var e=D(r.list);delete e[t],r.content=O(e),c()},e}),"function"==typeof a.getNoused?r.rest=N(a.getNoused(r.content)):r.rest=[]}r.addVal=function(t){var e=r.rest.find(function(e){return e.$name==t});if(e){var n=e.$name,i=e.value;b.inputvalue=M,b.inputname=M;var o=D(r.list);o[n]=a.getcss(n),o[n].value=i,r.content=O(o),c()}},c()}function v(e,t){0!=t&&(S=e.content.$clone());var n=A(_[e.$name]);e.list=N(n.getUsed(e.content)).map(function(e){return function(t){var e=function(e){t.select==e.value&&(t.selectItem=e),e.click=function(){t.select=e.value,t.selectItem=e},e.change=function(){}};if(t.options)for(var n in t.options)e(t.options[n]);return t.change=function(){},t}(e)})}return s.click=function(){_.index=b.content.indexOf(this),b.selected=s},"style"==e.$name?p(s):"parameters"==e.$name?f(s):"template"==e.$name?s.content&&(s.list=s.content.map(function(r){var a=r.style,c=r.echart,l=r.advance,u=r.parameters;return delete r.chosen,r.choseTemplate=function(){for(var e in s.content)delete s.content[e].chosen;if(r.chosen=!0,a){var t=b.content.find(function(e){return"style"==e.$name});t.content=a,p(t,!1)}if(c){var n=b.content.find(function(e){return"echart"==e.$name});n.content=c,d(n,!1)}if(l){var i=b.content.find(function(e){return"advance"==e.$name});i.content=l,v(i,!1)}if(u){var o=b.content.find(function(e){return"parameters"==e.$name});o.content=u,f(o,!1)}},r})):"echart"==e.$name?d(s):"source"==e.$name?function(c,e){0!=e&&((x=c.content.$clone()).resource=x.resource||[],x.kpi=x.kpi||[]),c.preview={};var n=_[c.$name];for(var t in c.content)!function(e){if(n[e]){var t=c.content[e];c.content[e]=n[e],c.content[e].value=t}}(t);u.rootDomain.get().then(function(e){var t=function(e){var o=function(e){var t=function(e){return e},i=[];c.kpis=e.map(t);var n=function(t,n){if("object"!=_typeof(n[t])){var e=c.kpis.find(function(e){return e.id==n[t]});e&&i.push(e)}else i.push(n[t])};for(var o in c.content.kpi)n(o,c.content.kpi);c.content.kpi=i},r=function(e){var t=function(e){return e},i=[];c.resources=e.map(t);var n=function(t,n){if("object"!=_typeof(n[t])){var e=c.resources.find(function(e){return e.id==n[t]});e&&i.push(e)}else i.push(n[t])};for(var o in c.content.resource)n(o,c.content.resource);c.content.resource=i},t=function(e){return c.content.modelTypeOnChange=function(t){0!=t?(y.getDataItemsByModelId(t,function(e){0==e.code&&o(e.data)}),u.kpis.getBymodelId(t).then(o),V["model_"+t]?r(V["model_"+t]):y.getResourceByModelId([t],function(e){0==e.code&&(V["model_"+t]=e.data,r(e.data))}),c.content.resource=[],c.content.kpi=[]):(c.content.model=c.models[0],c.content.model.onChange())},c.modelTypes=[{id:0,label:"模版"},{id:300,label:"管理域"},{id:301,label:"客户"},{id:302,label:"项目"}],c.resfilltypes=[{id:"manual",label:"指定"},{id:"parameter",label:"传递参数"}],c.aggregate_rules=[{id:0,label:"取区间末位"},{id:1,label:"取区间首位"},{id:2,label:"取区平均值"}],e.onChange=function(){y.getDataItemsByModelId(this.id,function(e){0==e.code&&o(e.data)}),u.kpis.getBymodelId(this.id).then(o);var t=this;V["model_"+t.id]?r(V["model_"+t.id]):y.getResourceByModelId([this.id],function(e){0==e.code&&(V["model_"+t.id]=e.data,r(e.data))}),c.content.resource=[],c.content.kpi=[]},e},n=function(e){var t=function(e){var t=[{label:"无",valueCode:null}];c.granularityUnits=t.concat(e)},n=function(e){c.aggregate_types=e},i=function(e){c.aggregate_instances=e};y.getDataItemsByModelId(e,function(e){0==e.code&&o(e.data)}),y.getResourceByModelId(e,function(e){0==e.code&&r(e.data)}),h.getDictValues("KqiGranularityUnit",function(e){0==e.code&&t(e.data.filter(function(e){return"月"==e.label||"季度"==e.label||"年"==e.label}))}),h.getDictValues("aggregateType",function(e){0==e.code&&n(e.data)}),i([{label:"不使用",id:0},{label:"行业",id:1},{label:"区域",id:2},{label:"能源",id:3},{label:"行业简称",id:4}])};c.models=e.map(t),c.content.model=c.models.find(function(e){return!!c.content.model&&e.id==c.content.model.id});var i=function(e){c.kqiModels=e,c.content.kqiModel=c.kqiModels.find(function(e){return!!c.content.kqiModel&&e.id==c.content.kqiModel.id})};if(l.getKqiModels(function(e){0==e.code&&i(e.data)}),0==c.content.modelType)c.content.model?n(c.content.model.id):c.content.model=c.models[0];else{var a=c.content.modelType;n(a)}},n=function(e){u.models.getAll().then(t)};y.getModelByIds([e.modelId],n)}),c.renderData=function(){for(var e in c.content.bind)c.content.hasOwnProperty(e)&&(c.content[e].value=c.content.bind[e]);c.content.legend.render(c.content.legend.value),c.content.xAxis.render(c.content.xAxis.value),c.content.yAxis.render(c.content.yAxis.value),c.content.series.render(c.content.series.value)}}(s):"advance"==e.$name&&v(s),s}),b.selected=b.content[g?g[0]:0],b.toHelpDoc=function(){n=n||"../app-free-style/index.html#/help",V.open(n,"blank")},b.label=t,b.type=i},getParameters:function(){var e=O(D(D(this.content).$attr("parameters/list")));return{isDiff:JSON.stringify(e)!=JSON.stringify(k),data:e}},getSource:function(){var e=D(this.content).$attr("source/content");if(e){e.legend=e.legend?e.$attr("legend/value"):M,e.xAxis=e.xAxis?e.$attr("xAxis/value"):M,e.series=e.series?e.$attr("series/value"):M,e.kpi=e.kpi||[],e.resource=e.resource||[];var t={applied:e.applied,dataToX:e.dataToX,text:e.text,model:e.model,kpi:e.kpi,modelType:e.modelType,resfilltype:e.resfilltype,resource:e.resource,kqiModel:e.kqiModel,timespan:e.timespan,format:e.format,multipleCi:e.multipleCi,multipleKpi:e.multipleKpi,frequency:e.frequency,aggregate_type:e.aggregate_type,granularityUnit:e.granularityUnit,aggregate_instance:e.aggregate_instance,aggregate_rule:e.aggregate_rule,autoFillBlank:e.autoFillBlank,condition:e.condition,legend:e.legend,xAxis:e.xAxis,xAxisType:e.xAxisType?e.xAxisType:M,yAxis:e.yAxis?e.yAxis:M,yAxisType:e.yAxisType?e.yAxisType:M,series:e.series};for(var n in t)t[n]==M&&delete t[n];return{isDiff:JSON.stringify(e)!=JSON.stringify(x),data:t}}return{isDiff:!1,data:null}},checkDataValiad:function(c){var l=D(this.content).$attr("source/content");l?$$.loadExternalJs(["toolkit/date-handler","toolkit/value-list-handler"],function(e,t){var n=l.frequency,i=l.timespan;if(i){var o=e.init(),r=e.init(o.getTimeStamp()-function(e){if(!e)return 0;switch(e.unit){case"second":return 1e3*e.value;case"minute":return 60*e.value*1e3;case"hour":return 60*e.value*60*1e3;case"day":return 24*e.value*60*60*1e3;case"month":return 30*e.value*24*60*60*1e3;default:return e.value}}(i)),a=t.init();try{a.setTimeRange(r,o,n),c("success")}catch(e){c(e.message)}}else c("success")},function(e){}):c("success")},getAdvance:function(){var e=O(D(D(this.content).$attr("advance/list")));return{isDiff:JSON.stringify(e)!=JSON.stringify(S),data:e}},submitPanel:function(t){var n=this;n.checkDataValiad(function(e){"success"==e?t({index:n.getIndex(),parameters:n.getParameters(),style:n.getStyle(),echart:n.getEchart(),data:n.getSource(),advance:n.getAdvance()}):(i.error(e),t(null))})}}}]})}(window,angular);
//# sourceMappingURL=../../map/toolkit/angular-custom/angular-popup.js.map
