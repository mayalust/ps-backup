define(["toolkit/itree/tree-data-handler","pstree"],function(e,K){return function(e){var o,a,n,t,r,i=999999,l={root:[]},c=e,u=[],d=[],s=[],g={},f=Array.prototype.push,h=Object.prototype.toString,v=x("Object"),m=(x("Null"),x("Undefined"),x("Array")),p=(x("Number"),x("Function")),y=(x("String"),c.element),I=$('<div class="tree-menu"></div>'),b=(y.getParameter("resource"),y.getValue("global/ROLE"),["tag tag-green","tag tag-yellow","tag tag-orange","tag tag-red"]),P="includeFields=id,label,modelId,values.viewType,values.view.viewTitle,values.view.viewId,values.number,domains,resourcetype,viewType",T=e.serviceProxy,w="device"==(y.parameters||{}).navitype,S=y.parameters.backToMainWhileDeviceChange,D={300:"domain",301:"customer",302:"project",1e3:"device"};function R(e){setTimeout(e,100)}function x(n){return function(e){return h.call(e)=="[object "+n+"]"&&e==e}}function A(e,n){for(var t in n)e[t]=n[t]}function N(e,n){var t;for(e=e||[],t=0;t<e.length;t++)n&&n(e[t],t)}function V(e){w&&e.modelId<1e3||(T.removeAllRequest(),e.setHighlight&&e.setHighlight(!0),R(function(){w?function(n){n.$location;y.setParameter("id",n.id),y.trigger("changeNavString",C.call(n)),j(n.id,function(e){A(n,e),y.setValue("global/resource",n),y.trigger("tree_resourceChange",{resource:n}),y.trigger("analysisShakeNavigateTo",0)})}(e):k(e)}))}function k(i){var o=i.$location,a={motor:"motor",wind:"wind",reality:"reality",UPS:"UPS",electric:"electric",screen:"screen"};y.setParameter("id",i.id),y.trigger("changeNavString",C.call(i)),j(i.id,function(r){y.getAttrsByModelId(r.modelId,function(e){var n=e.find(function(e){return"viewType"===e.name}),t=n&&n.sourceValue;o=t&&a[t]||i.$location,A(i,r),y.setValue("global/resource",i),y.trigger("pathChange",o),y.trigger("tree_resourceChange",{resource:i}),y.trigger("analysisShakeNavigateTo",0)})})}function C(){var e=[this.label],n=t(this);function t(e){return e.parentID&&l[e.parentID]||e.parent}for(;n;)99!=n.id&&e.push(n.label),n=t(n);return e.reverse(),e.join(" > ")}function j(e,n){y.getResourceById(e,function(e){n&&n(e)})}function B(e){return b[e-1]||"tag tag-green"}function M(e,n){var i=new RegExp("/\\d+/","g"),t=e.values&&e.values.number||null,r=n.values&&n.values.number||null;function o(e){for(var n=0,t=i.exec(e.label);null!=t;){var r=t[0].length;n<r&&(n=r),t=i.exec(e.label)}return n}function a(e){for(var n=u-e.length,t=0;t<n;t++)e="0"+e;return e}if(t||r)return t<r;var l=o(e),c=o(n),u=Math.max(l,c);return e.label.replace(i,function(e){return a(e)})<n.label.replace(i,function(e){return a(e)})}function U(i,e){var o,a,l;return N(e,function(e,n){e.domains.split("/").filter(function(e){return e});var t=e.domains.split("/").filter(function(e){return e}).slice(-2),r=e.id==t[1]?t[0]:t[1];r!==e.id?(e.parentID=r,o=e.id,l=e.modelId,a=1e3<l?1e3:l,(i[o]=e).resourceType=D[a]):(console.err("此节点为错误或无效节点",e),s.push(e))}),i}function O(){var e,n=y.getParameter("id");y.setValue("global/alertTime",null),w&&"device"!==this.resourceType?(event.preventDefault(),this.toggle()):n!=this.id&&(S&&y.getParameter("sub")?(e=this,w&&e.modelId<1e3||(T.removeAllRequest(),R(function(){y.setParameter("id",e.id),y.setParameter("sub",null),y.navigateTo("index",{main:y.getParameter("main")},"self")}))):V(this))}function E(e){var n,t,r=e.domains,i=e.modelId,o=a(e);function a(e){return e.parentID?l[e.parentID]:console.err("没有设置PARENTID属性")}r=r.split("/").filter(function(e){return e}),o?(o.children=o.children||[],function(e,n,t){for(var r=e.length-1;-1<r&&t(n,e[r]);)e[r+1]=e[r],r--;e[r+1]=n}(o.children,e,M)):(l.root.push(e),console.assert(!1,"无根节点的节点",e)),1e3<i?e.$location=(t=(t=(n=e).values&&n.values.viewType)||null)?{motor:"motor",wind:"wind",reality:"reality",UPS:"UPS",electric:"electric",screen:"screen"}[t]:"device":300==i?(function(e){for(var n=[],t=e.modelId,r=e;(r=a(r))&&r.modelId==t;)n.push(r);return n}(e),1==e.layer?e.$location="index":2==e.layer?e.$location="navigate":3==e.layer?e.$location="factory":(e.$location={error:"unhandled node",message:"[300]layer is over 3, cannot handle"},console.error("管理域出现"+e.layer+"级，不可被处理",e.label,e.modelId,e.layer))):301==i?e.$location="production":302==i&&(e.children&&e.children[0]&&1e3<e.children[0].modelId||1==e.layer?e.$location="devicegroup":e.$location="virtual"),e.click=O,e.$on=function(e,n){g[e]=n},console.assert(e.$location,"$location没正确倒入",e.label,e.modelId,e.layer)}function q(e,n,t){runtime("getStatus开始加载"),y.getKpiValueCi(e,n,function(e){runtime("getStatus完成加载"),t&&t(e)},{isRealTimeData:!0})}function F(n){var o=[],t=[300,301,302];!function r(i){var e=t[i];e&&y.getResourceByModelId(e,function(e){var n,t;n=o,m(t=e)?f.apply(n,t):f.call(n,t),r(i+1)},P),!e&&n&&n(o)}(0)}function H(e){U(l,e);var n,t=[];N(e,function(e){E(e),t.push(e.id)}),dev=l.root,function n(e){N(e,function(e){!e.children&&u.push(e),e.children&&n(e.children)})}(dev),w||(a?a.modelId<1e3&&(n=l[a.id]):n=l.root[0],n&&(n.$location?k(n):n.postponed=!0)),q(t,[i],L)}function L(e){var n;N(e,function(e){l[e.nodeId].status=e.value,l[e.nodeId].icon=B(e.value)}),n=function(e){!function(e){runtime("getResourceSuccess开始");var n=[];U(l,d=e),N(e,function(e){E(e),n.push(e.id)}),runtime("MAP全完成",l.root),q(n,[i],_)}(e)},runtime("resource开始加载"),y.getDevicesByCondition({},function(e){runtime("resource完成加载"),n&&n(e)},P)}function _(e){N(e,function(e,n){l[e.nodeId].status=e.value,l[e.nodeId].icon=B(e.value)});var n=l.root,t=u.find(function(e){return e.children instanceof Array&&0<e.children.length});l.firstDevice=v(t)&&m(t.children)&&t.children[0],console.assert(l.firstDevice,"没有找到任何设备"),n=n&&n[0]&&1==n[0].layer&&300==n[0].modelId?n[0].children:n,(o=K(I[0],{data:m(n)?n:[],animate:!1,themes:"show-line folder-pull-right steel-industry condense",on:{init:function(){this.icon=this.icon||"tag tag-green",this.open=this.depth<2},click:O}}))&&y.trigger("deviceTreeLoaded",o);var r=w?v(a)&&1e3<a.modelId&&d.some(function(e){return e.id==a.id})?a:l.firstDevice||null:a||(l.root?l.root[0]:null),i=o.find(function(e){return(r&&r.id)==e.id});v(i)&&p(i.eachParent)&&i.eachParent(function(e){!e.open&&e.toggle()}),v(i)&&p(i.highlight)&&i.highlight(),v(i)&&!i.open&&p(i.toggle)&&i.toggle(),i&&(w?V(i):(1e3<i.modelId||i.postponed)&&(delete i.postponed,V(i))),runtime("allfinished",n)}return n=function(e){a=e,F(H)},t=y.getValue("global/resource")||{},(r=y.getParameter("id")||t.id)&&y.getResourceById(r,function(e){n&&n(e)}),!r&&n&&n(null),y.on("treeSelect",function(){var n=y.getParameter("id"),e=o.find(function(e){return e.id==n});e&&p(e.eachParent)&&e.eachParent(function(e){!e.open&&e.toggle()}),e&&p(e.highlight)&&e.highlight()}),y.on("searchtree",function(n){o.search(function(e){return-1!=e.label.indexOf(n)})}),I}});
//# sourceMappingURL=../../map/toolkit/component/treenavigator.js.map
