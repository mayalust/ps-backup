function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}define([],function(){return function(data){var elemData=data,uuid;if(null==elemData)throw new Error("undefined");var self=elemData.element,viewId=self.viewId,all_resources=[],all_kpis=[],viewFlexService=elemData.viewFlexService,serviceProxy=elemData.serviceProxy,userLoginUIService=elemData.userLoginUIService,element=elemData.element,commonMethod=element.constructor,q=elemData.q,global=elemData.global,SwSocket=elemData.SwSocket,parentheight,parentwidth,json=element.JSON,taDom,completeCallback=data.complete,svgId="svg_"+Math.uuid(),defer=elemData.defer,traverseRow=elemData.traverseRow,traverseCol=elemData.traverseCol,timeout=elemData.timeout,route=elemData.route,previewMode=elemData.previewMode,openAngles={},persentage=0,events={},expression,mm=defer.id,factory=JSON.parse(JSON.stringify(serviceProxy)),topo=$("<div></div>"),wrap=$("<div></div>");function extend(e,t){for(var n in t)e[n]=t[n];return e}function runExpression(expression){var resourceUIService=elemData.resourceUIService,max_height,max_width;topo.css("position","relative");var resourceUIService=elemData.resourceUIService,serviceCenterService=elemData.serviceCenterService,kpiDataService=elemData.kpiDataService,displayModeLink={arrowheadMarkup:"<g></g>",toolMarkup:"<g></g>",vertexMarkup:"<g></g>"},itemins;"function"==typeof element.setSelfDom&&element.setSelfDom(topo),element.$on=function(e,t){events[e]=t},element.off("$loadCiKpiComplete"),element.off("$renderGraphComplete"),topo.append(wrap),self.error=function(e){wrap.children().remove();var t=$("<p>"+e+"</p>");t.css({"font-size":"12px","min-height":"300px","text-align":"center","line-height":"300px"}),wrap.append(t)},self.setResources=function(e){self.composoryRes=e,Object.defineProperty(self,"composoryRes",{enumerable:!1})},self.createDeviceDropList=function(e,t,n){var i=persentage||1,o=$("<div></div>"),r=$("<div></div>"),a=$("<div></div>"),s=(n=n||{}).$attr("click"),l=n.$attr("titleClick");$("#devicelistscroll").remove(),o.attr("id","devicelistscroll"),r.css("width","100%"),r.css("height","50px"),o.css("position","absolute"),o.css("z-index",199),a.css("padding","2px"),a.css("background-color","#1e415d"),a.css("border","1px solid #000"),a.css("box-shadow","1px 1px 10px 1px rgba(0,0,0,.5)"),a.css("max-height","150px"),a.css("overflow-x","hidden"),a.css("overflow-y","auto"),o.css("cursor","pointer"),o.css("top",t.y/i-(n.y||30)+"px"),o.css("left",t.x/i-(n.x||50)+"px"),o.css("background-color","rgba(0,0,0,0)"),o.on("mouseleave",function(e){$("#devicelistscroll").remove()}),r.on("click",function(e){l()});var c=function(t){var n=$("<div></div>"),e=$("<span></span>"),i=$("<div></div>");return n.attr("id","wrap"),i.css("margin-right","5px"),i.css("width","10px"),i.css("height","10px"),i.css("border-radius","50%"),i.css("background-color",self.getAlertColor(t.status)),i.css("display","inline-block"),n.css("padding","5px 15px"),e.text(t.label),e.css("padding-right","10px"),n.append(i),n.append(e),n.on("mouseenter",function(e){o.find("#wrap").css("background-color","rgba(0,0,0,0)"),n.css("background-color","rgba(0,0,0,.3)")}),n.on("mouseleave",function(e){n.css("background-color","rgba(0,0,0,0)")}),n.on("click",function(e){s(t)}),t.$on("statusChanged",function(e){i.css("background-color",self.getAlertColor(t.status))}),n};for(var d in e)a.append(c(e[d]));o.append(r),o.append(a),topo.prepend(o)},self.createAttrDisp=function(u,n,i,f,g){var o,r,a,s,l=["速度有效值","冲击平均值","震动","冲击","速度","温度","电压","电流"];function c(e,t){var n;for(n=0;n<e.length;n++)if(t(e[n],n))return n}function e(){o=$("<div></div>"),r=$("<div></div>"),a=$("<div></div>"),s=$("<table></table>"),o.css("position","absolute"),o.css("padding","2px"),o.css("background-color","rgba(30,65,93,.9)"),o.css("border","1px solid #000"),o.css("box-shadow","1px 1px 10px 1px rgba(0,0,0,.5)"),o.css("z-index",99),g?(r.css("max-height","300px"),r.css("min-width","380px")):(n.sort(function(t,n){return ka=c(l,function(e){return-1!=(t.kpiName||t.label).indexOf(e)})||t.label,kb=c(l,function(e){return-1!=(n.kpiName||n.label).indexOf(e)})||n.label,ka<kb?-1:1}),r.css("max-height","50px")),r.css("overflow-y","auto"),r.css("overflow","auto"),a.css("text-align","center"),a.css("font-weight","bold"),a.css("padding","3px"),a.css("color","#fff"),a.css("background-color","#295375"),a.text(u),o.css("top",i.y+"px"),o.css("left",i.x+"px"),o.append(a);var e=function(t){var e=$("<tr></tr>"),n=$("<td></td>"),i=$("<td></td>"),o=$("<td></td>"),r=$("<td></td>"),a=useMomentFormat(t.arisingTime,"yyyy-MM-dd hh:mm:ss");n.css("padding","5px 6px 1px 6px"),i.css("padding","5px 6px 1px 6px"),o.css("padding","5px 6px 1px 6px"),r.css("padding","5px 6px 1px 6px"),n.css("vertical-align","middle"),i.css("vertical-align","middle"),o.css("vertical-align","middle"),r.css("vertical-align","middle");var s=$("<span></span>"),l=$('<button id="button" rel="popover" ></button>');if(g){var c=$("<span>"+t.devName+"</span>"),d=$("<span>"+t.message+"</span>"),p=$("<span>"+useMomentFormat(t.arisingTime,"yyyy-MM-dd hh:mm:ss")+"</span>");c.css("white-space","normal"),d.css("white-space","normal"),p.css("white-space","normal"),c.css("display","inline-block"),d.css("display","inline-block"),p.css("display","inline-block"),c.css("max-width","100px"),d.css("max-width","220px"),n.append(c),o.append(d),r.append(p)}else l.popover({placement:"right",trigger:"manual",title:"上报时间",container:"body",content:function(){return a}}).on("mouseenter",function(){u&&$(this).popover("show")}).on("mouseleave",function(){$(this).popover("hide")}),s.text(t.label),n.append(s);return t.valueStr?l.text(t.valueStr):"-"!=t.value?l.text(self.toFix(t.value,2)):l.text("-"),s.css("color","#aaa"),s.css("padding-right","10px"),t.updateValue=function(e,t){var n=null!=e?e:"-";n="number"==typeof n?self.toFix(n,2):n,"NA"!=t&&t&&(n+=t),l.text(n),this.value=e},t.updateStatus=function(e){this.status=e,l.css("background-color",self.getAlertColor(e))},t.updateTime=function(e){e&&(a=useMomentFormat(e,"yyyy-MM-dd hh:mm:ss"))},l.css("min-width","50px"),l.css("text-align","center"),l.css("line-height","12px"),l.css("border",0),l.css("color","#fff"),l.css("border-radius","10px"),l.css("background-color",self.getAlertColor(t.status)),l.on("click",function(e){$(this).popover("destroy"),f&&f(t)}),t.label&&e.append(n),g&&(e.append(o),e.append(r)),e.append(i),i.append(l),e};for(var t in n)s.append(e(n[t]));r.append(s),o.append(r),topo.append(o)}return e.prototype.destroy=function(){o.remove()},e.prototype.getData=function(){return n},new e},self.createCurrentStatus=function(t,i,n){var o,r=topo.find("div#cStatus"),a=$("<div></div>"),s=$("<div></div>"),l=$("<div></div>");function c(){$("body").off("click"),o.destroy(),itemins&&itemins.destroy()}function d(e){var t=persentage||1,n=self.getValue("device/alerts");o&&o.destroy(),$("body").off("click"),n&&(0<n.length?(o=self.createAttrDisp("告警信息",n,{x:i.x/t-200,y:i.y/t+15},function(r){var t=r.nodeId;self.getValue("global/ROLE");self.getDomainAreaLineTree_alertStatus(function(e){e.traverse(function(o){o.id==t&&self.getResourceById(o.id,function(i){self.getAttrsByModelId(i.modelId,function(e){extend(o,i);var t,n=(o.physicalConfig.accessConfigs||{}).find(function(e){return e.instance===r.instance})||null;self.setParameter("id",o.id),self.setValue("global/alertTime",r.arisingTime),self.setValue("global/resource",o),self.setValue("global/sensor",n),self.setValue("global/instance",r.instance),self.setParameter("sensorId",n.dataItemId),t="Z"==r.specialty?0:"D"==r.specialty?1:7,self.navigateToTab("analysis",t,1)})})})})},!0),setTimeout(function(){$("body").on("click",c)})):self.growl("暂无未处理的告警信息！"))}function e(){r.css("position","absolute");var e=persentage||1;r.css("cursor","pointer"),r.css("top",i.y/e+"px"),r.css("left",i.x/e+"px"),a.text(t),a.css("padding-right","6px"),a.css("font-weight","bold"),a.css("line-height","14px"),a.css("display","inline-block"),a.css("color","#fff"),s.css("display","inline-block"),l.css("display","block"),l.css("position","absolute"),l.css("top","1px"),l.css("width","14px"),l.css("height","14px"),l.css("border-radius","50%"),l.css("background-color",self.getAlertColor(n)),l.css("box-shadow","1px 1px 10px 1px rgba(0,0,0,1)"),0<n&&(a.css("text-decoration","underline"),r.off("click"),r.on("click",d)),s.append(l),r.append(a),r.append(s),topo.append(r)}return(r=r.size()?r:$('<div id="cStatus"></div>')).children().remove(),e.prototype.setAlarmStatus=function(e){l.css("background-color",self.getAlertColor(e)),0<e&&(a.css("text-decoration","underline"),r.off("click"),r.on("click",d))},new e},self.createCurrentStatusByItem=function(t,e){function n(){$("body").off("click"),itemins&&itemins.destroy()}var i,o;i=persentage||1,o=self.getValue("device/alerts"),itemins&&itemins.destroy(),o=o.filter(function(e){return e.nodeId==t}),$("body").off("click"),0<o.length?(itemins=self.createAttrDisp("告警信息",o,{x:e.x/i,y:e.y/i},function(n){var i=n.nodeId,o=self.getValue("global/ROLE");self.getDomainAreaLineTree_alertStatus(function(e){e.traverse(function(e){var t;e.id==i&&(self.setValue("global/resource",e),self.setValue("global/instance",n.instance),self.setValue("global/sensor",n),self.setValue("global/alertTime",n.arisingTime),self.setParameter("sensorId",n.id),t="Z"==e.specialty?0:"D"==e.specialty?1:7,1==o?self.navigateTo("index",{main:2,sub:t,backHistory:1},"self"):2==o?self.navigateTo("index",{main:2,sub:t,backHistory:1},"self"):3==o?self.navigateTo("index",{main:2,sub:t,backHistory:1},"self"):self.growl("此角色无法显示特征曲线"))})})},!0),setTimeout(function(){$("body").on("click",n)})):self.growl("此设备暂无未处理的告警信息！")},self.createMarker=function(n,i){$$.loadExternalJs(["toolkit/configure/marker"],function(e){var t=e.init(svgId,{title:n});i(t)})},self.createAlarm=function(n,i){$$.loadExternalJs(["toolkit/configure/alarm"],function(e){var t=e.init(svgId,{title:n});i(t)})},self.createAlarmSmall=function(n,i){$$.loadExternalJs(["toolkit/configure/alarm"],function(e){var t=e.init(svgId,{title:n,smallMode:!0});i(t)})},self.create3Dbar=function(n,i){$$.loadExternalJs(["toolkit/configure/3dbarchart"],function(e){var t=e.init(svgId,{title:n});i(t)})},self.getPersentageSite=function(e){var t=persentage||1,n={x:0,y:0};return n.x=e.x/t,n.y=e.y/t,n},self.render=function(inputJson,cb_fun){var run=function run(json){if("object"==_typeof(json)&&null!=json){var callback=function callback(joint){timeout(function(){parentheight=topo.parent().height(),parentwidth=topo.parent().width();var domwidth=topo.width(),graph=new joint.dia.Graph,oldwidth=json.width,oldheight=json.height,config=json.$clone();wrap.children().remove(),config.el=wrap[0],element.style.height||topo.css("height",domwidth*oldheight/oldwidth+"px");var domheight=topo.height(),PatternLinkView=joint.dia.LinkView.extend({patternMarkup:['<pattern id="pattern-<%= id %>" patternUnits="userSpaceOnUse">','<image xlink:href=""/>',"</pattern>"].join(""),render:function(){if(joint.dia.LinkView.prototype.render.apply(this,arguments),!this.model||this.model.get("pattern"))return this.listenTo(this.model,"change:pattern change:patternColor",this.update),this},remove:function(){joint.util.cancelFrame(this.frameId),joint.dia.LinkView.prototype.remove.apply(this,arguments),this.pattern&&(this.pattern.remove(),this.pattern=null)},update:function(){if(joint.dia.LinkView.prototype.update.apply(this,arguments),!this.model||this.model.get("pattern"))return this.pattern||(this.pattern=joint.V(_.template(this.patternMarkup)({id:this.id})),this.patternImage=factory.origin+this.pattern.findOne("image"),joint.V(this.paper.svg).defs().append(this.pattern)),this._V.connection.attr({stroke:"url(#pattern-"+this.id+")"}),this.strokeWidth=this._V.connection.attr("stroke-width")||1,joint.util.cancelFrame(this.frameId),this.frameId=joint.util.nextFrame(_.bind(this.fillWithPattern,this)),this},fillWithPattern:function(){var e=this.strokeWidth,t=joint.g.rect(joint.V(this.el).bbox(!0)).moveAndExpand({x:-e,y:-e,width:2*e,height:2*e}),n=[].concat(this.sourcePoint,this.route,this.targetPoint);n=_.map(n,function(e){return joint.g.point(e.x-t.x,e.y-t.y)});var i=document.createElement("canvas");i.width=t.width,i.height=t.height;var o=i.getContext("2d");o.lineWidth=e,o.lineJoin="round",o.lineCap="round";for(var r=0,a=n.length-1;r<a;r++){o.save();var s=this.gradientPoints(n[r],n[r+1],e),l=o.createLinearGradient.apply(o,s);this.drawPattern.call(this,o,n[r],n[r+1],e,l,n,r),o.restore()}var c=factory.origin+i.toDataURL("image/png");this.pattern.attr(t),this.patternImage.attr({width:t.width,height:t.height,"xlink:href":c})},gradientPoints:function(e,t,n){var i=joint.g.toRad(e.theta(t)-90),o=joint.g.line(e,t).midpoint(),r=joint.g.point.fromPolar(n/2,i,o),a=joint.g.point.fromPolar(n/2,Math.PI+i,o);return[r.x,r.y,a.x,a.y]},drawPattern:function(e,t,n,i,o){e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(n.x,n.y),e.stroke(),e.closePath(),e.beginPath(),e.strokeStyle="white",e.lineWidth=i-2,e.moveTo(t.x,t.y),e.lineTo(n.x,n.y),e.stroke(),e.closePath()}});config.model=graph,config.interactive=!1,config.perpendicularLinks=!0,config.gridSize=10,config.markAvailable=!0,config.linkConnectionPoint=joint.util.shapePerimeterConnectionPoint,config.defaultLink=new joint.dia.Link({attrs:{".marker-source":{d:"M 10 0 L 0 5 L 10 10 z",transform:"scale(0.001)"},".marker-target":{d:"M 10 0 L 0 5 L 10 10 z"},".connection":{stroke:"black"}}}),config.linkView=PatternLinkView.extend({drawPattern:function(e,t,n,i,o){var r=i-4,a=i,s=(joint.g.point(t).move(n,-a/2),joint.g.point(n).move(t,-a/2),"blue");this.model.get("attrs")&&this.model.get("attrs")[".connection"]&&(s=this.model.get("attrs")[".connection"].stroke?this.model.get("attrs")[".connection"].stroke:s),o.addColorStop(.3,s);var l="#ffffff";this.model.get("patternColor")&&(l=this.model.get("patternColor")),o.addColorStop(.5,l),o.addColorStop(.7,s),e.beginPath(),e.lineWidth=r,e.strokeStyle=o,e.moveTo(t.x,t.y),e.lineTo(n.x,n.y),e.stroke(),e.closePath()}}),delete config.cells;var repeat=function e(t){t.attr("circle/opacity",1),t.attr("circle/r",1),t.transition("attrs/circle/r",30,{delay:0,duration:1e3,timingFunction:function(e){return e*e},valueFunction:function(t,n){return function(e){return t+(n-t)*e}}}),t.transition("attrs/circle/opacity",0,{delay:0,duration:1e3,timingFunction:function(e){return e*e},valueFunction:function(t,n){return function(e){return t+(n-t)*e}}}),timeout(function(){e(t)},1600)},scale=1,portion,translate="0,0",ys=0,Qc;if(portion=oldwidth/oldheight,persentage=oldwidth/oldheight<domwidth/domheight?(scale=domheight/oldheight,config.width=domheight*portion,config.height=domheight,ys=(domwidth-config.width)/2,oldheight/domheight):(scale=domwidth/oldwidth,config.width=domwidth,config.height=domwidth/portion,oldwidth/domwidth),wrap.children().remove(),wrap.css("width",config.width),wrap.css("height",config.height),0<config.width&&0<config.height){var paper=new joint.dia.Paper(config);for(var i in json.cells)Qc=json.cells[i],"basic.Image"==Qc.type&&(Qc.attrs.image["xlink:href"]=factory.origin+Qc.attrs.image["xlink:href"].substring(1));graph.fromJSON(json),events.$renderGraphComplete&&events.$renderGraphComplete(graph.getCells()),element.trigger("$renderGraphComplete",graph.getCells()),paper.on("cell:pointerup",function(e){e.model instanceof joint.dia.Element&&openCellTools(e)}),paper.on("link:options",function(e,t,n,i){openCellTools(t)}),$$.isString(json.bgimage)&&wrap.find("svg").css("background-image","url("+factory.origin+json.bgimage+")"),wrap.find("svg").css("background-size","contain"),wrap.find("svg").css("background-repeat","no-repeat"),wrap.find("svg").css("background-position","center center"),wrap.find("svg").attr("id",svgId),wrap.find(".viewport").attr("transform","scale("+scale+")"),wrap.find(".chart.Plot").css("display","none");var defers=[],nodes=[],kpis=[],pages=[];elemData.routeParam.page&&(pages=elemData.routeParam.page.split("|"));var distype=self.getParameter("type"),currentPath=pages[pages.length-1],mleft=element.style.margin;try{mleft&&(mleft=parseInt(mleft.split("px")[0]))}catch(e){}var loop=function(r){var n,i,o=q.defer(),e=r.id,a=graph.getCell(e),t=r.type,s=a.get("nodeId"),l=a.get("kpiId"),c=/^number\:(.*)/,d=a.get("extend");if("angle"==d&&(a.attr("text/style/display","none"),a.attr("rect/style/display","none"),$$.loadExternalJs(["toolkit/configure/openAngle"],function(e){var t=e.init(svgId);(openAngles[r.id]=t).setPos(r.position),t.setValue(0)})),"panel"!=currentPath&&"panel"!=distype?("?"!=s&&(n=$$.runRegExp(s,c,1)),n&&(n=parseInt(n)),-1==nodes.indexOf(n)&&n&&nodes.push(n)):self.composoryRes?-1==nodes.indexOf(self.composoryRes.id)&&nodes.push(self.composoryRes.id):(n=self.getParameter("resourceId"),-1==nodes.indexOf(n)&&nodes.push(n)),"?"!=l&&(i=$$.runRegExp(l,c,1)),i&&"null"!=i&&(i=parseInt(i)),-1==kpis.indexOf(i)&&n&&"null"!=i&&i&&kpis.push(i),"chart.Plot"==t){var p=r.position,u=r.size,f=(c=/^number\:(.*)/,$$.runRegExp(r.echartViewId,c,1));self.getViewById(f,function(e){if(e){var t=$("<div></div>");t.css("width",u.width*scale+"px"),t.css("height","auto"),t.css("top",p.y*scale+"px"),t.css("left",p.x*scale+ys+5+"px"),t.css("position","absolute"),t.css("background-color","#eee"),t.css("box-shadow","1px 1px 10px 1px rgba(0,0,0,.2)"),t.css("border-radius","2px"),wrap.prepend(t);var n=JSON.parse(e.content);n.layout=n.layout.$remapByChild(function(e){return new commonMethod(e)});var o=n.layout;if(element.children=o.children,element.traverse(function(e){}),r.nodeIds)if(r.nodeIds.$remove(function(e,t){return 0==t}),0<r.nodeIds.length){resourceUIService.getResourceByIds(function(e){for(var t in e)if("string"==typeof e[t]&&-1!=e[t].indexOf("number:")){var n=e[t].split("number:")[1];e[t]=parseInt(n)}return e}(r.nodeIds),function(e){if(e){var i=e[r.nodeIds[0]];i&&serviceCenterService.kpis.getBymodelId(i.modelId).then(function(n){o.traveseByChild(function(e){if("echart"==e.type){e.data.resource=[i];var t=e.data.kpi;e.data.kpi=n.filter(function(e){return-1!=t.indexOf(e.id)})}}),traverseRow(t,o.children,!0)})}})}else traverseRow(t,o.children,!0);else traverseRow(t,o.children,!0)}}),o.resolve("success")}else if("link"==r.type&&(jQuery.extend(r,displayModeLink),r.attrs[".connection-wrap"]={display:"none"}),a.attributes.nodeId)if(n){resourceUIService.getResourceByIds([n],function(e){if(e){var t=e[n];r.resourceObj=t,a.resourceObj=t,all_resources.push(r.resourceObj),t?"alert"==d?(a.kpiObj=r.kpiObj={id:999999},o.resolve("success")):null!=i&&"0"!=i&&null!=i?serviceCenterService.kpis.getBymodelId(t.modelId).then(function(e){a.kpiObj=r.kpiObj=e.find(function(e){return e.id==i}),all_kpis.push(r.kpiObj),o.resolve("success")}):o.resolve("success"):o.resolve("success")}else o.resolve("success")})}else o.resolve("success");else o.resolve("success");return o.promise};for(var i in json.cells)defers.push(loop(json.cells[i]));q.all(defers).then(function(){var cellsDic={},getData_success=function getData_success(data){var loop=function loop(cell,find,findState){var elementId=cell.id,elDom=graph.getCell(elementId);if(cell.resourceObj){var findNumber=/^number\:(.*)/;if("panel"!=currentPath&&"panel"!=distype){var nodeStr=elDom.get("nodeId"),nodeId;nodeId=$$.runRegExp(nodeStr,findNumber,1)}else if(self.composoryRes)var nodeId=self.composoryRes.id;else var nodeId=self.getParameter("resourceId");var kpiId=cell.$attr("kpiObj/id");if(find||findState){var createData=function createData(find){var setLevel=function setLevel(cell,value){var range=cell.attributes.range;range&&(range=eval(range));var persent=(value-range[0])/(range[1]-range[0]);cell.prop("attrs/text/text",""),cell.transition("attrs/rect",{transform:"translate(0,0)",height:60*persent},{delay:0,duration:1e3,valueFunction:function(n,i){return function(e){var t=n.height+(i.height-n.height)*e;return{transform:"translate(0,"+(60-t)+")",height:t}}}})},setOpenAngle=function(e,t,n){e.attributes.range;var i=e.id;openAngles[i].setValue(t)},fillColor=function(e,t,n,i,o){var r=e.get("stateId");if(r){i<1&&(i=0),e.state=i;var a=[n,"#25bce7","#e1cd0a","#ed9700","#e7675d"],s=[o,"#25bce7","#e1cd0a","#ed9700","#e7675d"];"number:1"!=r&&"number:3"!=r||t&&a[i]&&e.transition("attrs/"+t+"/fill",a[i],{delay:300,duration:500,valueFunction:joint.util.interpolate.hexColor}),"number:2"!=r&&"number:3"!=r||!s[i]||e.transition("attrs/text/fill",s[i],{delay:300,duration:500,valueFunction:joint.util.interpolate.hexColor})}},breathFlash=function(e,n,t,i,r){var o=e.get("stateId"),a=function(e){var o=r?1:e.opacity;e.transition("attrs/"+n+"/opacity",o,{delay:0,duration:3e3,timingFunction:joint.util.timing.inout,valueFunction:function(n,i){return function(e){var t=n+i*(o-Math.abs(o-2*o*e));return Number(t.toFixed(2))}}})};if(o){i<0&&(i=0);var s=[t,"#25bce7","#e1cd0a","#ed9700","#e7675d"];if("number:2"==o&&(n="text"),n)if(e.opacity||(e.opacity=jQuery.isNumeric(e.prop("attrs/"+n+"/opacity"))?e.prop("attrs/"+n+"/opacity"):1),e.state=i,e.prop("attrs/"+n+"/opacity",.1),e.prop("attrs/"+n+"/fill",s[i]),0<e.state){if(_.contains(e.getTransitions(),"attrs/"+n+"/opacity"))return;e.on("transition:end",function(e,t){0<e.state?a(e):(e.off("transition:end"),e.prop("attrs/"+n+"/opacity",e.opacity))}),a(e)}else e.prop("attrs/"+n+"/opacity",e.opacity)}},bubbleFlash=function(t,n,e,i,o){var r=t.get("stateId"),a=function(){t.prop("attrs/"+n+"/r",0),t.prop("attrs/"+n+"/opacity",o?1:t.opacity),t.transition("attrs/"+n,{r:t.r,opacity:0},{delay:0,duration:1500,valueFunction:function(t,n){return function(e){return{r:t.r+(n.r-t.r)*e,opacity:t.opacity-t.opacity*e}}}})};if(r){i<0&&(i=0);var s=[e,"#25bce7","#e1cd0a","#ed9700","#e7675d"];if("number:2"==r&&(n="text"),n)if(t.opacity||(t.opacity=jQuery.isNumeric(t.prop("attrs/"+n+"/opacity"))?t.prop("attrs/"+n+"/opacity"):1,t.r=t.prop("attrs/"+n+"/r"),t.prop("attrs/"+n+"/opacity",o?1:t.opacity)),t.state=i,t.prop("attrs/"+n+"/fill",s[i]),0<t.state){if(_.contains(t.getTransitions(),"attrs/"+n))return;t.on("transition:end",function(e){0<e.state?a():(t.prop("attrs/"+n+"/opacity",t.opacity),t.prop("attrs/"+n+"/r",t.r))}),a()}else t.prop("attrs/"+n+"/opacity",t.opacity),t.prop("attrs/"+n+"/r",t.r)}},changeIconAndText=function(t,n,e){if(e||(e="alertConfig"),"alertConfig"==e)t.get("alertIcon")&&(n<1&&(n=0),t.get(e).forEach(function(e){e.id==n&&(e.alertText&&t.prop("attrs/text/text",e.alertText),e.alertIcon&&t.prop("attrs/image/xlink:href",factory.origin+e.alertIcon))}));else if("valueConfig"==e){t.get(e).forEach(function(e){e.stateDisplay=!1,e.valueText==n&&(e.stateDisplay=!0,e.valueText&&t.prop("attrs/text/text",e.valueText),e.valueIcon&&t.prop("attrs/image/xlink:href",factory.origin+e.valueIcon))})}},getFill=function(e){var t={};for(var n in e){t=e[n];break}return t.fill},getType=function(e){return"basic.Rect"==e?"rect":"basic.Circle"==e?"circle":void 0},getTextFill=function(e){return e.text.fill},getAllUnit_success=function(e){var n,t=elDom.get("extend");if("alert"==t&&findState)changeIconAndText(elDom,findState.value);else if("value"==t&&find)changeIconAndText(elDom,find.value,"valueConfig");else if("level"==t&&find)setLevel(elDom,find.value);else if("angle"==t&&find)setOpenAngle(elDom,find.value,cell);else{if(findState){var i=cell.stateType;"number:1"==i?breathFlash(elDom,getType(cell.type),getFill(cell.attrs),findState.value,!1):"number:2"==i?bubbleFlash(elDom,getType(cell.type),getFill(cell.attrs),findState.value,!1):"number:3"==i?breathFlash(elDom,getType(cell.type),getFill(cell.attrs),findState.value,!0):"number:4"==i?bubbleFlash(elDom,getType(cell.type),getFill(cell.attrs),findState.value,!0):fillColor(elDom,getType(cell.type),getFill(cell.attrs),findState.value,getTextFill(cell.attrs))}if(find){var r=e;n=function(e){var t,n=r.find(function(e){return cell.kpiObj?e.unitCode==cell.kpiObj.unit:""}),i=!1;elDom.get("unitType")&&(i=1==elDom.get("unitType").split("number:")[1]),cell.resourceObj.modelId&&(t=resourceUIService.$attr("rootModelsDic/"+cell.resourceObj.modelId+"/kpiDic/"+find.kpiCode+"/rangeObj"),find.value=t?t[find.value]:find.value);var o=elDom.attributes.position.y;n&&i?elDom.prop("attrs/text/text",find.value+""+n.unitName):elDom.prop("attrs/text/text",find.value),elDom.prop("position/y",o)},cell.kpiObj?n(cell.kpiObj):target.getResourceById(nodeId,function(e){var t=e.modelId;target.getKpisByModelId(t,function(e){var t=e.find(function(e){return"number:"+e.id==cell.kpiId});cell.kpiObj=t,n(cell.kpiObj)})})}}},error=function(e){elDom.prop("attrs/text/text",find.value)};serviceCenterService.units.getAll().then(getAllUnit_success,error)};createData(find)}}};data.forEach(function(i){999999==i.kpiCode?cellsDic[i.nodeId]?cellsDic[i.nodeId].forEach(function(e){if(e.state!=i.value){var t=!0;if(e.kpiId&&"number:0"!=e.kpiId?i.instance?"number:"+i.instance!=e.kpiId&&(t=!1):t=!1:i.instance&&(t=!1),!t)return;loop(e,null,i)}}):json.cells.forEach(function(e){if(e.nodeId){var t=e.nodeId.split(":");if(0<t.length&&t[t.length-1]==i.nodeId){cellsDic[i.nodeId]||(cellsDic[i.nodeId]=[]),cellsDic[i.nodeId].push(e);var n=!0;if(e.kpiId&&"number:0"!=e.kpiId?i.instance?"number:"+i.instance!=e.kpiId&&(n=!1):n=!1:i.instance&&(n=!1),!n)return;loop(e,null,i)}}}):cellsDic[i.nodeId+"_"+i.kpiCode]?cellsDic[i.nodeId+"_"+i.kpiCode].forEach(function(e){loop(e,i,null)}):graph.getCells().forEach(function(e){if(e.$attr("resourceObj/id")==i.nodeId&&(e.kpiId||e.$attr("kpiObj/id"))){if(e.kpiId)var t=e.kpiId.split(":");if(e.$attr("kpiObj/id"))t=[e.$attr("kpiObj/id")];0<t.length&&t[t.length-1]==i.kpiCode&&(null==cellsDic[i.nodeId+"_"+i.kpiCode]&&(cellsDic[i.nodeId+"_"+i.kpiCode]=[]),cellsDic[i.nodeId+"_"+i.kpiCode].push(e),loop(e,i,null))}})})};kpiDataService.getRealTimeKpiData(nodes,[999999],function(e){0==e.code&&getData_success(e.data)},!0),kpiDataService.getRealTimeKpiData(nodes,kpis,function(e){0==e.code&&getData_success(e.data)}),kpis.push(999999);var paramSocket={ciid:nodes.toString(),kpi:kpis.toString()};uuid=Math.uuid();var operation="register";SwSocket.register(uuid,operation,function(e){getData_success([e.data])}),SwSocket.send(uuid,operation,"kpi",paramSocket),events.$loadCiKpiComplete&&events.$loadCiKpiComplete(graph.getCells()),element.trigger("$loadCiKpiComplete",graph.getCells())}),$("g.marker-vertices").attr("display","none"),$("g.marker-arrowheads").attr("display","none"),$("g.link-tools").attr("display","none"),$("#free-board").on("naviClick",function(){SwSocket.unregister(uuid)})}})};$$.loadExternalJs(["rappid-joint","lodash","backbone"],callback)}else wrap.append(warning)};inputJson?(json=inputJson,run(json)):self.getViewById(viewId,function(e){json=JSON.parse(e.content),run(json)})},delete element.self,topo.css("width","100%"),topo.css("background-position","top"),topo.css("background-size","contain"),expression=expression||{};var initEvent=expression.$attr("on/init"),clickEvent=expression.$attr("on/click"),wholeClickEvent=expression.$attr("on/wholeClick");if(element.style&&topo.css(element.style),"function"==typeof initEvent)try{topo.underWatch=initEvent({target:self,self:self,global:global,tools:elemData},function(){defer.resolve("underwatch")},defer.id)}catch(e){console.error(e)}else self.render(json);topo.on("click",function(e){if("function"==typeof wholeClickEvent)try{wholeClickEvent({target:self,global:global})}catch(e){console.error(e)}})}return factory.origin=factory.origin+"/",$$.runExpression(element.$attr("advance/expression"),function(e){if("0"==e.code){var t=e.data;expression=t}runExpression(expression)}),topo}});
//# sourceMappingURL=../../map/toolkit/component/topo.bak.js.map
