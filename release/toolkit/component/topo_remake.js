define([],function(){return function(data){var elemData=data,newDimension={},uuid,cellDiction={},graph,tostring=Object.prototype.toString,extendTools=[],extendTools={},registry={},self=elemData.element,viewId=self.viewId,all_resources=[],all_kpis=[],viewFlexService=elemData.viewFlexService,serviceProxy=elemData.serviceProxy,userLoginUIService=elemData.userLoginUIService,element=elemData.element,commonMethod=element.constructor,q=elemData.q,global=elemData.global,SwSocket=elemData.SwSocket,parentheight,parentwidth,json=element.JSON,taDom,completeCallback=data.complete,svgId="svg_"+Math.uuid(),defer=elemData.defer,traverseRow=elemData.traverseRow,traverseCol=elemData.traverseCol,timeout=elemData.timeout,route=elemData.route,previewMode=elemData.previewMode,openAngles={},events={},expression,mm=defer.id,factory=JSON.parse(JSON.stringify(serviceProxy));if(null==elemData)throw new Error("undefined");function isObject(e){return"[object Object]"==tostring.call(e)}function isNull(e){return"[object Null]"==tostring.call(e)}function isUndefined(e){return"[object Undefined]"==tostring.call(e)}function isArray(e){return"[object Array]"==tostring.call(e)}function isNumber(e){return"[object Number]"==tostring.call(e)&&e==e}function isFunction(e){return"[object Function]"==tostring.call(e)}function isString(e){return"[object String]"==tostring.call(e)}function isNaN(e){return e!=e}function bind(e,t){return function(){t.apply(e,arguments)}}function find(e,t){e=e||[];for(var n=0;n<e.length;n++)if(t(e[n],n))return e[n]}function filter(e,t){var n=[];e=e||[];for(var i=0;i<e.length;i++)t(e[i],i)&&n.push(e[i]);return n}function clone(e){return JSON.parse(JSON.stringify(e))}function extend(e,t){for(var n in t)e[n]=t[n]}function each(e,t){var n;for(e=e||[],n=0;n<e.length;n++)t&&t(e[n],n)}function eachProp(e,t){for(var n in e=e||{})t&&t(e[n],n)}function addCss(n,e){eachProp(e,function(e,t){n.css(t,e)})}function getId(e){var t;return isObject(e)&&(t=e.id),isString(e)&&(t=e),isNumber(e)&&(t=e),t}function getResourceById(e,t){e&&element.getResourceById(e,t)||t(null)}function getKpisByModelId(e,t){e&&element.getKpisByModelId(e,t)||t([])}factory.origin=factory.origin+"/",$$.runExpression(element.$attr("advance/expression"),function(e){if("0"==e.code){var t=e.data;expression=t}});var resourceUIService=elemData.resourceUIService,max_height,max_width,topo=$("<div></div>"),wrap=$("<div></div>");topo.css("position","relative");var resourceUIService=elemData.resourceUIService,serviceCenterService=elemData.serviceCenterService,kpiDataService=elemData.kpiDataService,itemins;function render(inputJson,cb_fun){var context;function getView(e,t){e?getViewSuccess(json=e):self.getViewById(viewId,function(e){getViewSuccess(json=JSON.parse(e.content))})}function waitload(e){setTimeout(e,4)}function loadJointJs(){$$.loadExternalJs(["rappid-joint","lodash","backbone"],loadJointJsSuccess)}function reDrawImageAddress(){each(json.cells,function(e){"basic.Image"==e.type&&(e.attrs.image["xlink:href"]=factory.origin+e.attrs.image["xlink:href"].substring(1))})}function getExtendTools(){var r=[];return each(json.cells,function(e){var t=e.extend,n=e.type,i=extendTools("extend",t)||extendTools("type",n);i&&(i(e),r.push(e))}),r}function getViewSuccess(){reDrawImageAddress(),extendTools=getExtendTools(),loadJointJs()}function drawCell(cell,find,findState){var setLevel=function setLevel(cell,value){var range=cell.attributes.range;range&&(range=eval(range));var persent=(value-range[0])/(range[1]-range[0]);cell.prop("attrs/text/text",""),cell.transition("attrs/rect",{transform:"translate(0,0)",height:60*persent},{delay:0,duration:1e3,valueFunction:function(n,i){return function(e){var t=n.height+(i.height-n.height)*e;return{transform:"translate(0,"+(60-t)+")",height:t}}}})},setOpenAngle=function(e,t,n){e.attributes.range;var i=e.id;openAngles[i].setValue(t)},fillColor=function(e,t,n,i,r){var o=e.get("stateId");if(o){i<1&&(i=0),e.state=i;var a=[n,"#25bce7","#e1cd0a","#ed9700","#e7675d"],s=[r,"#25bce7","#e1cd0a","#ed9700","#e7675d"];"number:1"!=o&&"number:3"!=o||t&&a[i]&&e.transition("attrs/"+t+"/fill",a[i],{delay:300,duration:500,valueFunction:joint.util.interpolate.hexColor}),"number:2"!=o&&"number:3"!=o||!s[i]||e.transition("attrs/text/fill",s[i],{delay:300,duration:500,valueFunction:joint.util.interpolate.hexColor})}},breathFlash=function(e,n,t,i,o){var r=e.get("stateId"),a=function(e){var r=o?1:e.opacity;e.transition("attrs/"+n+"/opacity",r,{delay:0,duration:3e3,timingFunction:joint.util.timing.inout,valueFunction:function(n,i){return function(e){var t=n+i*(r-Math.abs(r-2*r*e));return Number(t.toFixed(2))}}})};if(r){i<0&&(i=0);var s=[t,"#25bce7","#e1cd0a","#ed9700","#e7675d"];if("number:2"==r&&(n="text"),n)if(e.opacity||(e.opacity=jQuery.isNumeric(e.prop("attrs/"+n+"/opacity"))?e.prop("attrs/"+n+"/opacity"):1),e.state=i,e.prop("attrs/"+n+"/opacity",.1),e.prop("attrs/"+n+"/fill",s[i]),0<e.state){if(_.contains(e.getTransitions(),"attrs/"+n+"/opacity"))return;e.on("transition:end",function(e,t){0<e.state?a(e):(e.off("transition:end"),e.prop("attrs/"+n+"/opacity",e.opacity))}),a(e)}else e.prop("attrs/"+n+"/opacity",e.opacity)}},bubbleFlash=function(t,n,e,i,r){var o=t.get("stateId"),a=function(){t.prop("attrs/"+n+"/r",0),t.prop("attrs/"+n+"/opacity",r?1:t.opacity),t.transition("attrs/"+n,{r:t.r,opacity:0},{delay:0,duration:1500,valueFunction:function(t,n){return function(e){return{r:t.r+(n.r-t.r)*e,opacity:t.opacity-t.opacity*e}}}})};if(o){i<0&&(i=0);var s=[e,"#25bce7","#e1cd0a","#ed9700","#e7675d"];if("number:2"==o&&(n="text"),n)if(t.opacity||(t.opacity=jQuery.isNumeric(t.prop("attrs/"+n+"/opacity"))?t.prop("attrs/"+n+"/opacity"):1,t.r=t.prop("attrs/"+n+"/r"),t.prop("attrs/"+n+"/opacity",r?1:t.opacity)),t.state=i,t.prop("attrs/"+n+"/fill",s[i]),0<t.state){if(_.contains(t.getTransitions(),"attrs/"+n))return;t.on("transition:end",function(e){0<e.state?a():(t.prop("attrs/"+n+"/opacity",t.opacity),t.prop("attrs/"+n+"/r",t.r))}),a()}else t.prop("attrs/"+n+"/opacity",t.opacity),t.prop("attrs/"+n+"/r",t.r)}},changeIconAndText=function(t,n,e){if(e||(e="alertConfig"),"alertConfig"==e)t.get("alertIcon")&&(n<1&&(n=0),t.get(e).forEach(function(e){e.id==n&&(e.alertText&&t.prop("attrs/text/text",e.alertText),e.alertIcon&&t.prop("attrs/image/xlink:href",factory.origin+e.alertIcon))}));else if("valueConfig"==e){t.get(e).forEach(function(e){e.stateDisplay=!1,e.valueText==n&&(e.stateDisplay=!0,e.valueText&&t.prop("attrs/text/text",e.valueText),e.valueIcon&&t.prop("attrs/image/xlink:href",factory.origin+e.valueIcon))})}},getFill=function(e){var t={};for(var n in e){t=e[n];break}return t.fill},getType=function(e){return"basic.Rect"==e?"rect":"basic.Circle"==e?"circle":void 0},getTextFill=function(e){return e.text.fill};function getAllUnit_success(e){var t=getCell(cell),n=t.get("extend");if("alert"==n&&findState)changeIconAndText(t,findState.value);else if("value"==n&&find)changeIconAndText(t,find.value,"valueConfig");else if("level"==n&&find)setLevel(t,find.value);else if("angle"==n&&find)setOpenAngle(t,find.value,cell);else{if(findState){var i=cell.stateType;"number:1"==i?breathFlash(t,getType(cell.type),getFill(cell.attrs),findState.value,!1):"number:2"==i?bubbleFlash(t,getType(cell.type),getFill(cell.attrs),findState.value,!1):"number:3"==i?breathFlash(t,getType(cell.type),getFill(cell.attrs),findState.value,!0):"number:4"==i?bubbleFlash(t,getType(cell.type),getFill(cell.attrs),findState.value,!0):fillColor(t,getType(cell.type),getFill(cell.attrs),findState.value,getTextFill(cell.attrs))}if(find){var r,o=data.find(function(e){return cell.kpiObj?e.unitCode==cell.kpiObj.unit:""}),a=!1;t.get("unitType")&&(a=1==t.get("unitType").split("number:")[1]),cell.resourceObj.modelId&&(r=resourceUIService.$attr("rootModelsDic/"+cell.resourceObj.modelId+"/kpiDic/"+find.kpiCode+"/rangeObj"),find.value=r?r[find.value]:find.value);var s=t.attributes.position.y;o&&a?t.prop("attrs/text/text",find.value+""+o.unitName):t.prop("attrs/text/text",find.value),t.prop("position/y",s)}}}serviceCenterService.units.getAll().then(getAllUnit_success)}function getData_success(t){each(t,function(e){999999==e.kpiCode?drawCell(cellDiction[e.nodeId+"_"+e.kpiCode],null,t):drawCell(cellDiction[e.nodeId+"_"+e.kpiCode],t,null)})}function ciKpiDefindSuccess(e,t){nodes=e.map(getId),kpis=t.map(getId),getRealTimeKpiData(nodes,[999999],getData_success,!0),getRealTimeKpiData(nodes,kpis,getData_success),kpis.push(999999),getWebSocket(nodes,kpis,getData_success),events.$loadCiKpiComplete&&events.$loadCiKpiComplete(graph.getCells()),element.trigger("$loadCiKpiComplete",graph.getCells())}function loadJointJsSuccess(e){waitload(function(){context.init(e),context.ciKpiDefination(ciKpiDefindSuccess)})}function getCell(e){return isObject(e)?graph.getCell(e.id):graph.getCell(e)}function getNumber(e){if(isString(e)){var t=parseInt(e.replace(new RegExp("number\\:","g"),""));return t!=t?null:t}return isNumber(e)?e:null}function getRealTimeKpiData(e,t,n,i){kpiDataService.getRealTimeKpiData(e,t,function(e){0==e.code&&n&&n(e.data)},i)}function getWebSocket(e,t,n){var i={ciid:e.toString(),kpi:t.toString()},r="register";uuid=uuid||Math.uuid(),SwSocket.register(uuid,r,function(e){n&&n([e.data])}),SwSocket.send(uuid,r,"kpi",i)}function ciKpiDefination(t){var a=[],s=[],n=[];each(json.cells,function(e){n.push(function(t){var n=q.defer(),e=getCell(t),i=getNumber(e.get("nodeId")),r=getNumber(e.get("kpiId"));function o(e){t.kpiObj=e.find(function(e){return e.id==r})||null,t.resourceObj&&t.kpiObj&&(cellDiction[t.resourceObj.id+"_"+t.kpiObj.id]=t),n.resolve(t)}return getResourceById(i,function(e){getKpisByModelId((t.resourceObj=e)&&e.modelId,o)}),i&&a.push(i),r&&s.push(r),n.promise}(e))}),q.all(n).then(function(e){t&&t(a,s)})}function clearWrap(){wrap.children().remove()}function resetDimension(e,t,n,i){var r=t/e,o={};return n=n||1/0,o.persentage=t/e<i/n?(o.scale=n/e,o.width=n*r,e/(o.height=n)):(o.scale=i/t,o.width=i,o.height=i/r,t/i),o}function init(d){var e,t=d.dia.LinkView.extend({patternMarkup:['<pattern id="pattern-<%= id %>" patternUnits="userSpaceOnUse">','<image xlink:href=""/>',"</pattern>"].join(""),render:function(){if(d.dia.LinkView.prototype.render.apply(this,arguments),!this.model||this.model.get("pattern"))return this.listenTo(this.model,"change:pattern change:patternColor",this.update),this},remove:function(){d.util.cancelFrame(this.frameId),d.dia.LinkView.prototype.remove.apply(this,arguments),this.pattern&&(this.pattern.remove(),this.pattern=null)},update:function(){if(d.dia.LinkView.prototype.update.apply(this,arguments),!this.model||this.model.get("pattern"))return this.pattern||(this.pattern=d.V(_.template(this.patternMarkup)({id:this.id})),this.patternImage=factory.origin+this.pattern.findOne("image"),d.V(this.paper.svg).defs().append(this.pattern)),this._V.connection.attr({stroke:"url(#pattern-"+this.id+")"}),this.strokeWidth=this._V.connection.attr("stroke-width")||1,d.util.cancelFrame(this.frameId),this.frameId=d.util.nextFrame(_.bind(this.fillWithPattern,this)),this},fillWithPattern:function(){var e=this.strokeWidth,t=d.g.rect(d.V(this.el).bbox(!0)).moveAndExpand({x:-e,y:-e,width:2*e,height:2*e}),n=[].concat(this.sourcePoint,this.route,this.targetPoint);n=_.map(n,function(e){return d.g.point(e.x-t.x,e.y-t.y)});var i=document.createElement("canvas");i.width=t.width,i.height=t.height;var r=i.getContext("2d");r.lineWidth=e,r.lineJoin="round",r.lineCap="round";for(var o=0,a=n.length-1;o<a;o++){r.save();var s=this.gradientPoints(n[o],n[o+1],e),l=r.createLinearGradient.apply(r,s);this.drawPattern.call(this,r,n[o],n[o+1],e,l,n,o),r.restore()}var c=factory.origin+i.toDataURL("image/png");this.pattern.attr(t),this.patternImage.attr({width:t.width,height:t.height,"xlink:href":c})},gradientPoints:function(e,t,n){var i=d.g.toRad(e.theta(t)-90),r=d.g.line(e,t).midpoint(),o=d.g.point.fromPolar(n/2,i,r),a=d.g.point.fromPolar(n/2,Math.PI+i,r);return[o.x,o.y,a.x,a.y]},drawPattern:function(e,t,n,i,r){e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(n.x,n.y),e.stroke(),e.closePath(),e.beginPath(),e.strokeStyle="white",e.lineWidth=i-2,e.moveTo(t.x,t.y),e.lineTo(n.x,n.y),e.stroke(),e.closePath()}}).extend({drawPattern:function(e,t,n,i,r){var o=i-4,a=i,s=(d.g.point(t).move(n,-a/2),d.g.point(n).move(t,-a/2),"blue");this.model.get("attrs")&&this.model.get("attrs")[".connection"]&&(s=this.model.get("attrs")[".connection"].stroke?this.model.get("attrs")[".connection"].stroke:s),r.addColorStop(.3,s);var l="#ffffff";this.model.get("patternColor")&&(l=this.model.get("patternColor")),r.addColorStop(.5,l),r.addColorStop(.7,s),e.beginPath(),e.lineWidth=o,e.strokeStyle=r,e.moveTo(t.x,t.y),e.lineTo(n.x,n.y),e.stroke(),e.closePath()}}),n=clone(json),i=new d.dia.Link({attrs:{".marker-source":{d:"M 10 0 L 0 5 L 10 10 z",transform:"scale(0.001)"},".marker-target":{d:"M 10 0 L 0 5 L 10 10 z"},".connection":{stroke:"black"}}});graph=new d.dia.Graph,extend(n,{el:wrap[0],model:graph,interactive:!1,perpendicularLinks:!0,gridSize:10,markAvailable:!0,linkConnectionPoint:d.util.shapePerimeterConnectionPoint,defaultLink:i,linkView:t}),delete n.cells,clearWrap(),newDimension=resetDimension(n.height,n.width,topo.height(),topo.width()),n.width=newDimension.width,n.height=newDimension.height,new d.dia.Paper(n),graph.fromJSON(json),(e=wrap.find("svg")).attr("id",svgId),waitload(function(){isString(json.bgimage)&&addCss(e,{"background-image":"url("+factory.origin+json.bgimage.slice(1)+")","background-size":"contain","background-position":"center center","background-repeat":"no-repeat"}),wrap.find(".viewport").attr("transform","scale("+newDimension.scale+")"),wrap.find(".chart.Plot").css("display","none")}),events.$renderGraphComplete&&events.$renderGraphComplete(graph.getCells()),element.trigger("$renderGraphComplete",graph.getCells())}extendTools=function(){function e(e,t){return registry[e+":"+t]}return e.register=function(e,t){registry[e]=t},e}(),extendTools.register("extend:angle",function(n){elDom.attr("text/style/display","none"),elDom.attr("rect/style/display","none"),$$.loadExternalJs(["toolkit/configure/openAngle"],function(e){var t=e.init(svgId);(openAngles[n.id]=t).setPos(n.position),t.setValue(0)})}),extendTools.register("type:link",function(e){jQuery.extend(e,{arrowheadMarkup:"<g></g>",toolMarkup:"<g></g>",vertexMarkup:"<g></g>"}),e.attrs[".connection-wrap"]={display:"none"}}),extendTools.register("type:chart.Plot",function(o){var i=o.position,a=o.size,e=getNumber(o.echartViewId);self.getViewById(e,function(e){if(e){var t=$("<div></div>");t.css("width",a.width*scale+"px"),t.css("height","auto"),t.css("top",i.y*scale+"px"),t.css("left",i.x*scale+ys+5+"px"),t.css("position","absolute"),t.css("background-color","#eee"),t.css("box-shadow","1px 1px 10px 1px rgba(0,0,0,.2)"),t.css("border-radius","2px"),wrap.prepend(t);var n=JSON.parse(e.content);n.layout=n.layout.$remapByChild(function(e){return new commonMethod(e)});var r=n.layout;if(element.children=r.children,element.traverse(function(e){}),o.nodeIds)if(o.nodeIds.$remove(function(e,t){return 0==t}),0<o.nodeIds.length){resourceUIService.getResourceByIds(function(e){for(var t in e)if("string"==typeof e[t]&&-1!=e[t].indexOf("number:")){var n=e[t].split("number:")[1];e[t]=parseInt(n)}return e}(o.nodeIds),function(e){if(e){var i=e[o.nodeIds[0]];i&&serviceCenterService.kpis.getBymodelId(i.modelId).then(function(n){r.traveseByChild(function(e){if("echart"==e.type){e.data.resource=[i];var t=e.data.kpi;e.data.kpi=n.filter(function(e){return-1!=t.indexOf(e.id)})}}),traverseRow(t,r.children,!0)})}})}else traverseRow(t,r.children,!0);else traverseRow(t,r.children,!0)}})}),context={init:init,ciKpiDefination:ciKpiDefination},getView(inputJson,cb_fun)}"function"==typeof element.setSelfDom&&element.setSelfDom(topo),element.$on=function(e,t){events[e]=t},element.off("$loadCiKpiComplete"),element.off("$renderGraphComplete"),topo.append(wrap),self.error=function(e){wrap.children().remove();var t=$("<p>"+e+"</p>");t.css({"font-size":"12px","min-height":"300px","text-align":"center","line-height":"300px"}),wrap.append(t)},self.setResources=function(e){self.composoryRes=e,Object.defineProperty(self,"composoryRes",{enumerable:!1})},self.createDeviceDropList=function(e,t,n){var i=newDimension.persentage||1,r=$("<div></div>"),o=$("<div></div>"),a=$("<div></div>"),s=(n=n||{}).$attr("click"),l=n.$attr("titleClick");$("#devicelistscroll").remove(),r.attr("id","devicelistscroll"),o.css("width","100%"),o.css("height","50px"),r.css("position","absolute"),r.css("z-index",199),a.css("padding","2px"),a.css("background-color","#1e415d"),a.css("border","1px solid #000"),a.css("box-shadow","1px 1px 10px 1px rgba(0,0,0,.5)"),a.css("max-height","150px"),a.css("overflow-x","hidden"),a.css("overflow-y","auto"),r.css("cursor","pointer"),r.css("top",t.y/i-(n.y||30)+"px"),r.css("left",t.x/i-(n.x||50)+"px"),r.css("background-color","rgba(0,0,0,0)"),r.on("mouseleave",function(e){$("#devicelistscroll").remove()}),o.on("click",function(e){l()});var c=function(t){var n=$("<div></div>"),e=$("<span></span>"),i=$("<div></div>");return n.attr("id","wrap"),i.css("margin-right","5px"),i.css("width","10px"),i.css("height","10px"),i.css("border-radius","50%"),i.css("background-color",self.getAlertColor(t.status)),i.css("display","inline-block"),n.css("padding","5px 15px"),e.text(t.label),e.css("padding-right","10px"),n.append(i),n.append(e),n.on("mouseenter",function(e){r.find("#wrap").css("background-color","rgba(0,0,0,0)"),n.css("background-color","rgba(0,0,0,.3)")}),n.on("mouseleave",function(e){n.css("background-color","rgba(0,0,0,0)")}),n.on("click",function(e){s(t)}),t.$on("statusChanged",function(e){i.css("background-color",self.getAlertColor(t.status))}),n};for(var d in e)a.append(c(e[d]));r.append(o),r.append(a),topo.prepend(r)},self.createAttrDisp=function(u,n,i,f,g){var r,o,a,s,l=["震动","冲击","速度有效值","速度有效值","冲击平均值","冲击平均值","速度","温度","电压","电流"];function c(e,t){var n;for(n=0;n<e.length;n++)if(t(e[n],n))return n}function e(){r=$("<div></div>"),o=$("<div></div>"),a=$("<div></div>"),s=$("<table></table>"),r.css("position","absolute"),r.css("padding","2px"),r.css("background-color","rgba(30,65,93,.9)"),r.css("border","1px solid #000"),r.css("box-shadow","1px 1px 10px 1px rgba(0,0,0,.5)"),r.css("z-index",99),g?(o.css("max-height","300px"),o.css("min-width","380px")):(n.sort(function(t,n){return ka=c(l,function(e){return-1!=t.label.indexOf(e)})||t.label,kb=c(l,function(e){return-1!=n.label.indexOf(e)})||n.label,ka-kb}),o.css("max-height","50px")),o.css("overflow-y","auto"),o.css("overflow","auto"),a.css("text-align","center"),a.css("font-weight","bold"),a.css("padding","3px"),a.css("color","#fff"),a.css("background-color","#295375"),a.text(u),r.css("top",i.y+"px"),r.css("left",i.x+"px"),r.append(a);var e=function(t){var e=$("<tr></tr>"),n=$("<td></td>"),i=$("<td></td>"),r=$("<td></td>"),o=$("<td></td>"),a=useMomentFormat(t.arisingTime,"yyyy-MM-dd hh:mm:ss");n.css("padding","5px 6px 1px 6px"),i.css("padding","5px 6px 1px 6px"),r.css("padding","5px 6px 1px 6px"),o.css("padding","5px 6px 1px 6px"),n.css("vertical-align","middle"),i.css("vertical-align","middle"),r.css("vertical-align","middle"),o.css("vertical-align","middle");var s=$("<span></span>"),l=$('<button id="button" rel="popover" ></button>');if(g){var c=$("<span>"+t.devName+"</span>"),d=$("<span>"+t.message+"</span>"),p=$("<span>"+useMomentFormat(t.arisingTime,"yyyy-MM-dd hh:mm:ss")+"</span>");c.css("white-space","normal"),d.css("white-space","normal"),p.css("white-space","normal"),c.css("display","inline-block"),d.css("display","inline-block"),p.css("display","inline-block"),c.css("max-width","100px"),d.css("max-width","220px"),n.append(c),r.append(d),o.append(p)}else l.popover({placement:"right",trigger:"manual",title:"上报时间",container:"body",content:function(){return a}}).on("mouseenter",function(){u&&$(this).popover("show")}).on("mouseleave",function(){$(this).popover("hide")}),s.text(t.label),n.append(s);return t.valueStr?l.text(t.valueStr):"-"!=t.value?l.text(self.toFix(t.value,2)):l.text("-"),s.css("color","#aaa"),s.css("padding-right","10px"),t.updateValue=function(e,t){var n="-"!=e?self.toFix(e,2):"-";"NA"!=t&&t&&(n+=t),l.text(n),this.value=e},t.updateStatus=function(e){this.status=e,l.css("background-color",self.getAlertColor(e))},t.updateTime=function(e){e&&(a=useMomentFormat(e,"yyyy-MM-dd hh:mm:ss"))},l.css("min-width","50px"),l.css("text-align","center"),l.css("line-height","12px"),l.css("border",0),l.css("color","#fff"),l.css("border-radius","10px"),l.css("background-color",self.getAlertColor(t.status)),l.on("click",function(e){$(this).popover("destroy"),f&&f(t)}),t.label&&e.append(n),g&&(e.append(r),e.append(o)),e.append(i),i.append(l),e};for(var t in n)s.append(e(n[t]));o.append(s),r.append(o),topo.append(r)}return e.prototype.destroy=function(){r.remove()},e.prototype.getData=function(){return n},new e},self.createCurrentStatus=function(t,i,n){var r,o=topo.find("div#cStatus"),a=$("<div></div>"),s=$("<div></div>"),l=$("<div></div>");function c(){$("body").off("click"),r.destroy(),itemins&&itemins.destroy()}function d(e){var t=newDimension.persentage||1,n=self.getValue("device/alerts");r&&r.destroy(),$("body").off("click"),n&&(0<n.length?(r=self.createAttrDisp("告警信息",n,{x:i.x/t-200,y:i.y/t+15},function(t){var n=t.nodeId;self.getValue("global/ROLE");self.getDomainAreaLineTree_alertStatus(function(e){e.traverse(function(e){e.id==n&&(self.setParameter("id",e.id),self.setValue("global/resource",e),self.setValue("global/instance",t.instance),self.setParameter("sensorId",t.id),self.setValue("global/alertTime",t.arisingTime),self.navigateToTab("analysis",0,1))})})},!0),setTimeout(function(){$("body").on("click",c)})):self.growl("暂无未处理的告警信息！"))}function e(){o.css("position","absolute");var e=newDimension.persentage||1;o.css("cursor","pointer"),o.css("top",i.y/e+"px"),o.css("left",i.x/e+"px"),a.text(t),a.css("padding-right","6px"),a.css("font-weight","bold"),a.css("line-height","14px"),a.css("display","inline-block"),a.css("color","#fff"),s.css("display","inline-block"),l.css("display","block"),l.css("position","absolute"),l.css("top","1px"),l.css("width","14px"),l.css("height","14px"),l.css("border-radius","50%"),l.css("background-color",self.getAlertColor(n)),l.css("box-shadow","1px 1px 10px 1px rgba(0,0,0,1)"),0<n&&(a.css("text-decoration","underline"),o.off("click"),o.on("click",d)),s.append(l),o.append(a),o.append(s),topo.append(o)}return(o=o.size()?o:$('<div id="cStatus"></div>')).children().remove(),e.prototype.setAlarmStatus=function(e){l.css("background-color",self.getAlertColor(e)),0<e&&(a.css("text-decoration","underline"),o.off("click"),o.on("click",d))},new e},self.createCurrentStatusByItem=function(t,e){function n(){$("body").off("click"),itemins&&itemins.destroy()}var i,r;i=newDimension.persentage||1,r=self.getValue("device/alerts"),itemins&&itemins.destroy(),r=r.filter(function(e){return e.nodeId==t}),$("body").off("click"),0<r.length?(itemins=self.createAttrDisp("告警信息",r,{x:e.x/i,y:e.y/i},function(t){var n=t.nodeId,i=self.getValue("global/ROLE");self.getDomainAreaLineTree_alertStatus(function(e){e.traverse(function(e){e.id==n&&(self.setValue("global/resource",e),self.setValue("global/instance",t.instance),self.setValue("global/alertTime",t.arisingTime),1==i?self.navigateTo("index",{main:2,backHistory:1},"self"):2==i?self.navigateTo("index",{main:2,backHistory:1},"self"):3==i?self.navigateTo("index",{main:2,backHistory:1},"self"):self.growl("此角色无法显示特征曲线"))})})},!0),setTimeout(function(){$("body").on("click",n)})):self.growl("此设备暂无未处理的告警信息！")},self.createMarker=function(n,i){$$.loadExternalJs(["toolkit/configure/marker"],function(e){var t=e.init(svgId,{title:n});i(t)})},self.createAlarm=function(n,i){$$.loadExternalJs(["toolkit/configure/alarm"],function(e){var t=e.init(svgId,{title:n});i(t)})},self.createAlarmSmall=function(n,i){$$.loadExternalJs(["toolkit/configure/alarm"],function(e){var t=e.init(svgId,{title:n,smallMode:!0});i(t)})},self.create3Dbar=function(n,i){$$.loadExternalJs(["toolkit/configure/3dbarchart"],function(e){var t=e.init(svgId,{title:n});i(t)})},self.getPersentageSite=function(e){var t=newDimension.persentage||1,n={x:0,y:0};return n.x=e.x/t,n.y=e.y/t,n},self.render=render,delete element.self,topo.css("width","100%"),topo.css("background-position","top"),topo.css("background-size","contain"),expression=expression||{};var initEvent=expression.$attr("on/init"),clickEvent=expression.$attr("on/click"),wholeClickEvent=expression.$attr("on/wholeClick");if(element.style&&topo.css(element.style),isFunction(initEvent))try{topo.underWatch=initEvent({target:self,self:self,global:global,tools:elemData},function(){defer.resolve("underwatch")},defer.id)}catch(e){console.error(e)}else self.render(json);return topo.on("click",function(e){if("function"==typeof wholeClickEvent)try{wholeClickEvent({target:self,global:global})}catch(e){}}),console.assert(null!=topo.underWatch,"underWatch没设置"),topo}});
//# sourceMappingURL=../../map/toolkit/component/topo_remake.js.map
