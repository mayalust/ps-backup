define(["app","optionDataHandler","commonlib"],function(e,k,$){e.run(["dataManagement","$rootScope","$location","$route","kpiDataService",function(o,e,l,d,s){e.$on("$locationChangeSuccess",function(e){var t=d.current.params.viewId,n=d.current.params.solutionId,a=d.current.params.groupId,r=d.current.params.modelId,i=l.path().split("/")[1];t?s.getViewById(t,function(e){"10022"==e.code?(alert("您所登录的用户，无权访问该视图"),setTimeout(function(){window.open("../../app-oc/index.html#/designView/detail","_self")},1e3)):o.locationChanges(t)}):o.locationChanges(t,n,a,r);echartVersion="echart"==i})}]),e.factory("echartVer",function(){var e={},t="";return e.setVersionString=function(e){t=e},e.getVersionString=function(){return t},e}),e.factory("userInfo",function(){var e={},t="";return e.setUserInfo=function(e){t=e},e.getUserInfo=function(){return t},e}),e.factory("units",["kpiDataService","$q",function(e,t){var n={},a=new t.defer;return n.getUnits=function(){return a.promise},e.getAllUnits(function(e){a.resolve(e)}),n}]),e.factory("loginManagement",["$rootScope","authService","$q","$location","$window","echartVer","$route","userInfo",function(n,a,r,t,i,e,o,l){var d={};t.$$host,t.$$port,t.path().split("/")[1];function s(e){e.data&&t.path("/echart")}function u(e){i.open("../../login.html","_self")}return d.login=function(e){var t=e.name,n=e.password;a.login(t,n,s,function(e){})},d.logout=function(){a.logout(u)},d.back=function(){i.open("../app-oc/index.html#/designView2","_self")},d.newProf=function(){"/echart"==t.path()?i.open("index.html#/new/echart","_self"):i.open("index.html#/echart","_self")},d.openProf=function(e){i.open("index.html#/echart/"+e,"_self")},d.loginChecking_login=function(){var e=r.defer();return a.getCurrentUser(function(e){"0"==e.code?e.data?(l.setUserInfo(e.data),t.path("echart")):i.open("../../login.html","_self"):"10022"==e.code&&(alert("您所登录的用户，无权访问该视图"),setTimeout(function(){i.open("../../app-oc/index.html#/designView/detail","_self")},1e3))},function(e){}),n.loading="没有登录",e.promise},d.loginChecking_others=function(){var t=r.defer();return e.setVersionString("echart_v3"),a.getCurrentUser(function(e){e.data?(l.setUserInfo(e.data),t.resolve({status:"logined",data:e.data})):i.open("../../login.html","_self")}),n.loading="载入设计器",t.promise},d}]),e.factory("dataManagement",["$rootScope","solutionUIService","resourceUIService","authService","graphservice","kpiDataService","$routeParams","$q","$location","echartVer","$timeout","units",function(e,t,u,n,o,c,a,l,r,i,d,s){var f,p,v,m,g,h={},I=(r.path().split("/")[1],l.defer());function w(n){c.getviews(function(e){var t=e.data;!function(e,t){var n=[],a=e[0],r=new $.ArrayHandler(e[1].data);for(var i in a.traverse.each(function(e){modelId=e.id;var t=r.findAll("modelId",modelId);t&&(e.resources=new $.ArrayHandler(t))}),t)t[i]&&"designView"==t[i].viewType&&n.push(t[i]);if(null==m){var o={solutionId:f,groupId:p,smodelId:v,views:n,modelStructure:a};I.resolve(o)}else l=m,d=a,s=n,c.getViewById(l,function(n){var a=JSON.parse(n.data.content).elements,e=[];for(var t in a){var r=d.traverse.find("id",a[t].modelId);r||a[t].modelId&&-1==e.indexOf(a[t].modelId)&&e.push(a[t].modelId)}0==e.length?I.resolve({viewId:l,views:s,viewTitle:n.data.viewTitle,modelStructure:d,viewList:a}):u.getModelByIds(e,function(e){if(e.code){var t=e.data[0];u.getResourceByModelId(t.id,function(e){t.resources=new $.ArrayHandler(e.data),u.getKpisByModelId(t.id,function(e){t.kpis=new $.ArrayHandler(e.data),d.root.push(t),I.resolve({viewId:l,views:s,viewTitle:n.data.viewTitle,modelStructure:d,viewList:a})})})}})});var l,d,s}(n,t)})}function y(n,k,$,S,a){Array;var r=function(e){var t=[];for(var n in e)t.push(e[n].id);return t}(k),i=function(e){var t=[];for(var n in e)t.push(e[n].id);return t}($);if("time"==n)var e={category:n,isRealTimeData:!0,timePeriod:S,nodeIds:r,kpiCodes:i};else if("ci"==n)e={category:n,isRealTimeData:!0,nodeIds:r,kpiCodes:i};var t=["kpi",e];c.getKpiHierarchyValueList(t,function(e){if("0"==e.code){var t;"time"==n?t=function(e){var t=[],n={};if(0<e.length)for(var a in e){var r=e[a];for(var i in r)if("category"!=i){var o=i.split("-")[0],l=i.split("-")[1],d=i.split("-")[2];if(d){var s=d,u=l;n[o]||(n[o]=[]);var c=function(e,t){for(var n in e)if(t==e[n])return!0;return!1}(n[o],u);c||n[o].push(u)}}}if(k)for(var f in k)for(var p in $)if(n[k[f].id])for(var a in n[k[f].id])t.push({cilabel:k[f].label,kpilabel:$[p].label,label:k[f].label+"-"+n[k[f].nodeId][a]+"-"+$[p].label,name:$[p].name,nodeId:k[f].id,instance:n[k[f].id][a],kpiId:$[p].id,unit:$[p].unit,data:[]});else t.push({cilabel:k[f].label,kpilabel:$[p].label,label:k[f].label+"-"+$[p].label,name:$[p].name,nodeId:k[f].id,kpiId:$[p].id,unit:$[p].unit,data:[]});else for(var f in $)t.push({cilabel:"模拟数据",kpilabel:$[f].label,label:$[f].label+"(模拟数据)",name:$[f].name,nodeId:0,kpiId:$[f].id,unit:$[f].unit,data:[]});if(k)for(var a in e){var r=e[a],v=r.category,m=b(v);for(var i in r)if("category"!=i){var o=i.split("-")[0],l=i.split("-")[1],d=i.split("-")[2];d?(s=d,u=l):s=l;var g=r[i];for(var h in t)t[h].nodeId==o&&t[h].name==s&&t[h].instance==u&&t[h].data.push({value:g,time:m.time,timestamp:m.timestamp})}}else{var I=(new Date).getTime(),w=parseInt(S/10),y=I-S,a=[];if(0!=w)for(var f=y;f<=I;f+=w)t[0]&&t[0].data.push({value:parseInt(100*Math.random()),time:b(f).time,timestamp:f})}function b(e){var t,n=new Date(e),a=n.getFullYear(),r=n.getMonth()+1,i=n.getDate(),o=n.getHours(),l=n.getMinutes();return t=a+"/"+r+"/"+i+" "+o+":"+l,timestamp=Date.parse(new Date(t)),{time:t,timestamp:n.getTime()}}return t}(e.data.recordList):"ci"==n&&(t=function(e){var t=[];for(var n in k)for(var a in $)t.push({cilabel:k[n].label,kpilabel:$[a].label,nodeLabel:k[n].label,label:k[n].label+"-"+$[a].label,name:$[a].name,nodeId:k[n].nodeId,kpiId:$[a].kpiId,unit:$[a].units});for(var n in e){var r=e[n],i=r.category;for(var o in r)if("category"!=o){var l=o,d=r[o];for(var s in t){var u=t[s].nodeLabel;u==i&&l==t[s].name&&(t[s].value=d)}}}return t}(e.data.recordList)),a({status:"success",kpis:i,nodes:r,category:n,data:t})}else a({status:"failure"})})}function b(e){}return i.setVersionString("echart_v3"),h.saveData=function(e,t){c.saveData(e,t)},h.updateView=function(e,t,n){c.updateView(e,t,n)},h.getKpiValueList=y,h.locationChanges=function(t,n,a,r){d(function(){function e(e){var t,n=new $.ArrayHandler(e.data),a=[],r=[];for(t in n.data)a[t]=l.defer(),function(e,t){o.getKpisByModelId(e,function(e){n.data[t].kpis=new $.ArrayHandler(e.data),a[t].resolve(e)})}(n.data[t].id,t);for(var i in a)r.push(a[i].promise);l.all(r).then(function(e){var a=new $.ArrayHandler([]),r=new $.ArrayHandler(n.data);r.each(function(e){var t=e.parentModelId;if(t){var n=r.find("id",t);n?n.children?n.children.push(e):n.children=new $.ArrayHandler([e]):a.push(e)}else a.push(e)}),defer_a.resolve({root:a,traverse:n})},function(e){})}f=n,p=a,m=t,v=r,defer_a=l.defer(),defer_b=l.defer(),0!=r&&null!=r?u.getModelByIds([r],e):0!=a&&null!=a?u.getModelByIds([a],e):o.getModels(e),o.getResources(function(e){defer_b.resolve(e)}),l.all([defer_a.promise,defer_b.promise]).then(w,b)})},h.getOptionData=function(e,n,a,t,r,i,o,l){var d=e,s=t;y(n,r,i,o,function(e){if("success"==e.status)var t=k(d.type,d.category[n],a,e,s,g);else var t="获取数据错误";l(t,e.data)})},h.getAllModels=function(){return I.promise},s.getUnits().then(function(e){g=e.data},function(){}),h}])});
//# sourceMappingURL=../../../map/app-editor/js/services/service.js.map
