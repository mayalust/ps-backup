define(["controllers/controllers","bootstrap-dialog"],function(e,A){"use strict";e.initController("CmdbSolutionCtrl",["$scope","$rootScope","$location","$routeParams","$timeout","userLoginUIService","resourceUIService","SwSocket","Info","growl","$route","ngDialog","viewFlexService","solutionUIService",function(c,i,t,e,o,s,n,l,a,r,d,u,f,m){console.info("切换到资源管理-设备相关管理"),c.routePaths=[],c.routePathNodes={},c.selectedDitem=null,c.queryDitem=null,c.domainListDic={},c.userGridData,c.visible=!1,c.treeAry=[],c.activeMainTab="设备类型视图",d.current?c.activeTab=d.current.params.activeTab?d.current.params.activeTab:"/modelsGroup"==c.treeviewIndex?"设备组模板信息":"模板信息":scope.$on("locationChanged",function(){c.activeTab=d.current.params.activeTab?d.current.params.activeTab:"/modelsGroup"==c.treeviewIndex?"设备组模板信息":"模板信息"}),c.previousMainTab;var v=!(c.activeListTab="tab1"),p=(a.get("../localdb/icon.json",function(e){c.iconList=e.qualityIcon,c.kpiIconList=e.kpiIcon}),function(e){var t=0,i=0,o=0;return c.selectedSolution&&c.selectedSolution.id&&(t=c.selectedSolution.id),c.selectedGroupitem&&c.selectedGroupitem.id?i=c.selectedGroupitem.id:"DeviceGroup"==e.category&&(i=e.id),"DeviceGroup"!=e.category&&(o=e.id),{solutionId:t,groupId:i,modelId:o}}),b=function(e,t){e.count=0;var i,o,s,l,a,d;Math.random();return e.icon=e.icon?e.icon:"fa fa-building-o",e.alertlv="bg-green",e.isLoaded=0,e.type=0,e.text=e.label,e.name=e.label,"DeviceGroup"==e.category?e.canEdit=e.canEdit:e.canEdit=!1,0!=t&&(a=e,n.getAttrsByModelId(a.id,function(e){0==e.code&&(a.attrs=e.data,a.isLoaded=a.isLoaded+1,d&&d())}),l=e,n.getKpisByModelId(l.id,function(e){0==e.code&&(l.kpis=e.data)}),s=p(o=e),m.getThresholdsBySolution(s.solutionId,s.groupId,s.modelId,function(e){0==e.code&&(o.alerts=e.data)}),(i=e).directives=[],n.getDirectivesByModelId(i.id,function(e){0==e.code&&(i.directives=e.data)})),e},h=function(e){n.getModels(function(e){!function(e){if(0==e.code){n.rootModelDic={},c.modelListSelect=e.data;var t=e.data;for(var i in t){var o=b(t[i],!1);c.routePathNodes[o.parentModelId]||(c.routePathNodes[o.parentModelId]=[]),c.routePathNodes[o.parentModelId].push(o),c.routePathNodes[o.id]||(c.routePathNodes[o.id]=[]),n.rootModelDic[o.id]=o}var s=function e(t){for(var i in c.routePathNodes)if(i==t.id){for(var o in t.nodes=c.routePathNodes[i],t.nodes)e(t.nodes[o]);0==t.nodes.length&&(t.nodes=null)}};for(var l in s(n.rootModel),c.routePathNodes)if(l!=n.rootModel.id&&!n.rootModelDic[l])for(var i in c.routePathNodes[l])s(c.routePathNodes[l][i]),n.rootModel.nodes||(n.rootModel.nodes=[]),n.rootModel.nodes.push(c.routePathNodes[l][i]);n.rootModelDic[n.rootModel.id]=n.rootModel,c.rootModelDic=n.rootModelDic,c.rootModel=n.rootModel}}(e)})},D=function(){c.selectedDitem.isLoaded=1},g=function(){var e={attrs:[],kpis:[],directives:[],alerts:[]};c.selectedDitem&&0!=c.selectedDitem.id&&(e=c.selectedDitem),null==c.activeTab||"属性"==c.activeTab?c.$broadcast(Event.ATTREDITINIT,{data:e.attrs}):"指标"==c.activeTab?c.$broadcast(Event.KPIEDITINIT,{data:e.kpis}):"告警"==c.activeTab?c.$broadcast(Event.ALERTEDITINIT,{data:e}):"指令"==c.activeTab&&c.$broadcast(Event.DIRECTIVESINIT,{data:e.directives})};c.click=function(e){if(c.selectedDirective=null,"设备类型视图"==c.activeMainTab){if(c.selectedDitem&&c.selectedDitem.id==e.id)return;for(var t in c.routePaths)c.selectedDitem&&c.routePaths[t].id==c.selectedDitem.id&&c.routePaths.splice(t,1);c.selectedDitem=e,c.routePaths.push(e),c.visible=!0,g(),c.activeListTab="tab1"}},c.dbClick=function(e){if(c.selectedDirective=null,"设备类型视图"==c.activeMainTab){for(var t in c.routePaths)c.selectedDitem&&c.routePaths[t].id==c.selectedDitem.id&&c.routePaths.splice(t,1);c.selectedDitem=e,c.routePaths.push(e),c.visible=!0,c.activeListTab="tab1",c.showChildren(e)}},c.addModel=function(){if(c.selectedSolution){var e=c.selectedSolution,t=[];for(var i in c.treeAry){var o=c.treeAry[i];if(t.push(o),0==o.id)return void r.warning("当前有未保存设备模板",{})}var s,l;s="新建"+e.label+"的设备组",(l={}).label=s,l.id=0,l.count=0,l.icon="fa fa-building-o",l.isLoaded=0,l.resources=[],l.solutionId=e.id,l.canEdit=!0,t.unshift(l),e.nodes=t,c.treeAry=e.nodes,c.click(l)}else r.warning("请选择一个解决方案",{})},c.delModel=function(){if(0==c.selectedDitem.id){var e=[];for(var t in c.treeAry)0!=c.treeAry[t].id&&e.push(c.treeAry[t]);c.selectedSolution.nodes=e,c.treeAry=c.selectedSolution.nodes,0<c.treeAry.length?c.click(c.treeAry[0]):c.selectedDitem=null,r.success("删除设备模板成功",{})}else A.show({title:"提示",closable:!1,message:"确认删除 "+escape(c.selectedDitem.label)+" 模板吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){c.selectedDitem&&m.deleteModelFromSolution(c.selectedSolution.id,c.selectedDitem.id,function(e){if(0==e.code){var t=[];for(var i in c.treeAry)c.treeAry[i].id!=c.selectedDitem.id&&t.push(c.treeAry[i]);c.treeAry=t,c.selectedSolution.nodes=t,0<c.treeAry.length?c.click(c.treeAry[0]):(c.routePaths[c.routePaths.length-1]={name:"",parentModelId:c.selectedSolution},c.selectedSolution.nodes=null,c.selectedDitem=null),g(),r.success("删除设备模板成功")}}),e.close()}},{label:"取消",action:function(e){e.close()}}]})},c.updateModel=function(){var t=function(e){if(0==e.code){for(var t in c.treeAry)c.treeAry[t].id==c.selectedDitem.id&&(c.treeAry[t].label=e.data.label,c.treeAry[t].icon=e.data.icon,c.selectedDitem.label=e.data.label,c.selectedDitem.icon=e.data.icon);r.success("修改成功",{})}};if(c.selectedDitem){var e={};e.id=c.selectedDitem.id,e.label=c.selectedDitem.label,e.icon=c.selectedDitem.icon,"/models"==c.treeviewIndex?n.updateModel(e,function(e){t(e)}):m.saveGroupModel(c.selectedDitem.solutionId,c.selectedDitem,function(e){t(e)})}},c.modelViewEdit=function(){window.location.href="../app-sc/index_machine.html#/machine/edit/"+c.selectedDitem.dashboardViewId+"/"+c.selectedDitem.id},c.createServiceView=function(){var e=c.selectedSolution.serviceViewId,t=p(c.selectedDitem);switch(e){case 200:r.warning("通用服务模板无需设计",{});break;case 201:window.location.href="../app-sc/index_machine.html#/machine/edit/"+t.solutionId+"/"+t.modelId;break;case 202:t.groupId&&0!=t.groupId?window.location.href="../app-topo/index.html#/topology/deviceGroupModel/0/"+t.solutionId+"/"+t.groupId:window.location.href="../app-topo/index.html#/topology/deviceModel/0/"+t.solutionId+"/"+t.modelId;break;case 203:window.location.href="../app-sc/index_tongji.html#/tongji/modeledit/"+t.solutionId+"/"+t.groupId}},c.saveModelSubItem=function(){for(var e in c.treeAry)if(c.selectedDitem.label==c.treeAry[e].label&&c.selectedDitem.id!=c.treeAry[e].id)return void r.warning("当前有重复设备模板名称，请修改",{});0==c.selectedDitem.id?"/models"==c.treeviewIndex?n.addModel(c.selectedDitem,function(e){if(0==e.code){var t=[],i=b(e.data,!0);for(var o in c.selectedSolution.nodes)0!=c.selectedSolution.nodes[o].id?t.push(c.selectedSolution.nodes[o]):t.push(i);c.selectedSolution.nodes=t,c.treeAry=t,c.click(i),r.success("新建设备模板成功",{})}}):m.saveGroupModel(c.selectedDitem.solutionId,c.selectedDitem,function(e){if(0==e.code){var t=[],i=b(e.data,!0);for(var o in c.selectedSolution.nodes)0!=c.selectedSolution.nodes[o].id?t.push(c.selectedSolution.nodes[o]):t.push(i);c.selectedSolution.nodes=t,c.treeAry=t,c.click(i),r.success("新建设备组模板成功",{})}}):c.updateModel(c.selectedDitem)},c.kpichangehandler=function(e){-1!=e.id&&(c.newKpi={isEdit:2,canEdit:!0,label:"",name:"",unit:"",range:"",number:"",granularity:"",granularityUnit:"",option:"",id:0,uid:0,isNew:!0},0!=e.id&&(c.newKpi.id=e.id,c.newKpi.label=e.label,c.newKpi.name=e.name,c.newKpi.unit=e.unit,c.newKpi.number=e.number,c.newKpi.range=e.range,c.newKpi.icon=e.icon,c.newKpi.granularity=e.granularity,c.newKpi.granularityUnit=e.granularityUnit),c.addModelSubItem(),c.select2init())},c.addModelSubItem=function(){if(c.selectedDitem&&0!=c.selectedDitem.id){if(null==c.activeTab||"属性"==c.activeTab){c.selectedDitem.attrs||(c.selectedDitem.attrs=[]);for(var e=c.selectedDitem.attrs.length-1;-1<e;e--)if(c.selectedDitem.attrs[e].isNew){if(!c.selectedDitem.attrs[e].isDel)return void r.warning("当前有未保存属性",{});c.selectedDitem.attrs.splice(e,1)}var t={isEdit:2,canEdit:!0,label:"",name:"",dataType:0,id:Math.uuid(),isNew:!0};c.selectedDitem.attrs.push(t),c.$broadcast(Event.ATTREDITINIT,{data:c.selectedDitem.attrs})}else if("指标"==c.activeTab){c.selectedDitem.kpis||(c.selectedDitem.kpis=[]);for(e=c.selectedDitem.kpis.length-1;-1<e;e--){if(c.newKpi.id==c.selectedDitem.kpis[e].id)return void r.warning("该指标在设备模板中已经使用",{});if(c.selectedDitem.kpis[e].isNew){if(!c.selectedDitem.kpis[e].isDel)return void r.warning("当前有未保存指标",{});c.selectedDitem.kpis.splice(e,1)}}c.selectedDitem.kpis.push(c.newKpi),c.$broadcast(Event.KPIEDITINIT,{data:c.selectedDitem.kpis})}else if("告警"==c.activeTab){c.selectedDitem.alerts||(c.selectedDitem.alerts=[]);for(e=c.selectedDitem.alerts.length-1;-1<e;e--)if(c.selectedDitem.alerts[e].isNew){if(!c.selectedDitem.alerts[e].isDel)return void r.warning("当前有未保存告警",{});c.selectedDitem.alerts.splice(e,1)}var i={isEdit:2,canEdit:!0,label:"",name:"",description:"",option:"",id:Math.uuid(),isNew:!0};c.selectedDitem.alerts.push(i),c.$broadcast(Event.ALERTEDITINIT,{data:c.selectedDitem})}else if("指令"==c.activeTab){c.selectedDitem.directives||(c.selectedDitem.directives=[]);for(e=c.selectedDitem.directives.length-1;-1<e;e--)if(c.selectedDitem.directives[e].isNew){if(!c.selectedDitem.directives[e].isDel)return void r.warning("当前有未保存指令",{});c.selectedDitem.directives.splice(e,1)}c.selectedDitem.directives.push({isEdit:2,canEdit:!0,label:"",name:"",description:"",option:"",expression:"",protocolType:"",id:0,isNew:!0}),c.$broadcast(Event.DIRECTIVESINIT,{data:c.selectedDitem.directives})}}else r.warning("当前设备模板没有保存，无法添加",{})},c.attrLabel="",c.iconClick=function(e,t,i){"图标"!=$("#label"+t).val()&&(c.attrLabel=$("#label"+t).val()),"icon"==e?($("#label"+t).val("图标"),$("#label"+t).attr("disabled",!0),c.selectedDitem.attrs[t].label="图标"):("图标"==$("#label"+t).val()&&$("#label"+t).val(c.attrLabel),$("#label"+t).attr("disabled",!1))},c.doAction=function(e,i,o){if("设备类型视图"==c.activeMainTab)if("save"==e){if((i.isEdit=0)==i.id){var t={};t.label=i.label,t.id=i.id,t.values=i.values,t.modelId=c.selectedDitem.id,n.addResource(t,function(e){0==e.code&&(D(),r.success("保存成功",{}))})}else if(0<i.id){var s=i.data;s.label=i.label,s.id=i.id,s.values=i.values,n.updateDevice(s,function(e){0==e.code&&(D(),r.success("保存成功",{}))})}}else if("cancel"==e){for(var l in n.selectedInstances)n.selectedInstances[l].isEdit=0;c.$broadcast(Event.CMDBINFOSINIT,{option:[n.selectedInstances,c.selectedDitem.attrs]})}else if("delete"==e)A.show({title:"提示",closable:!1,message:"是否要删除设备:"+escape(i.label),buttons:[{label:"确定",cssClass:"btn-success",action:function(e){n.deleteResource(i.id,function(e){0==e.code&&D()}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("change"==e)A.show({title:"提示",closable:!1,message:"是否要改变设备状态为:"+(1==i.state?"离线":"在线"),buttons:[{label:"确定",cssClass:"btn-success",action:function(e){for(var t in n.selectedInstances)n.selectedInstances[t].id==i.id&&(1==i.state?n.selectedInstances[t].state=0:n.selectedInstances[t].state=1);c.$broadcast(Event.CMDBINFOSINIT,{option:[n.selectedInstances,n.selectedAttrs]}),e.close()}},{label:"取消",action:function(e){e.close()}}]});else if("eidterror"==e)r.warning("当前有正在编辑的设备",{});else if("directive"==e)location.href="#directiveview/"+i.data.modelId+"/"+i.id;else if("message"==e);else if("thresholdMessage"==e)r.warning(i,{});else if("kpi-delete"==e)if(i.isNew){for(var l in c.selectedDitem.kpis)if(i.id==c.selectedDitem.kpis[l].id){c.selectedDitem.kpis.splice(l,1),o(!0);break}}else A.show({title:"提示",closable:!1,message:"是否要删除设备指标:"+escape(i.name),buttons:[{label:"确定",cssClass:"btn-success",action:function(e){n.deleteKpi(c.selectedDitem.id,i.id,function(e){if(0==e.code){for(var t in c.selectedDitem.kpis)if(i.id==c.selectedDitem.kpis[t].id){c.selectedDitem.kpis.splice(t,1),o(!0);break}r.success("指标删除成功",{})}}),e.close()}},{label:"取消",action:function(e){o(!1),e.close()}}]});else if("kpi-save"==e)A.show({title:"提示",closable:!1,message:"是否要保存设备指标:"+escape(i.name),buttons:[{label:"确定",cssClass:"btn-success",action:function(e){n.saveKpi(c.selectedDitem.id,i,function(e){0==e.code&&(o(e.data),r.success("指标保存成功",{}))}),e.close()}},{label:"取消",action:function(e){o(!1),e.close()}}]});else if("attr-delete"==e)if(i.isNew){for(var l in c.selectedDitem.attrs)if(i.id==c.selectedDitem.attrs[l].id){c.selectedDitem.attrs.splice(l,1),o(!0);break}}else A.show({title:"提示",closable:!1,message:"是否要删除设备属性:"+escape(i.name),buttons:[{label:"确定",cssClass:"btn-success",action:function(e){n.deleteAttr(c.selectedDitem.id,i.id,function(e){if(0==e.code){for(var t in c.selectedDitem.attrs)if(i.id==c.selectedDitem.attrs[t].id){c.selectedDitem.attrs.splice(t,1),o(!0);break}r.success("属性删除成功",{})}}),e.close()}},{label:"取消",action:function(e){o(!1),e.close()}}]});else if("attr-save"==e)A.show({title:"提示",closable:!1,message:"是否要保存设备属性:"+escape(i.name),buttons:[{label:"确定",cssClass:"btn-success",action:function(e){i.isNew&&(i.id=0),i.modelId=c.selectedDitem.id,n.saveAttr(c.selectedDitem.id,i,function(e){0==e.code&&(o(e.data),r.success("属性保存成功",{}))}),e.close()}},{label:"取消",action:function(e){o(!1),e.close()}}]});else if("directive-delete"==e)if(i.isNew){for(var l in c.selectedDitem.directives)if(i.id==c.selectedDitem.directives[l].id){c.selectedDitem.directives.splice(l,1),o(!0);break}}else A.show({title:"提示",closable:!1,message:"是否要删除设备指令:"+escape(i.label),buttons:[{label:"确定",cssClass:"btn-success",action:function(e){n.deleteDirective(c.selectedDitem.id,i.id,function(e){if(0==e.code){for(var t in c.selectedDitem.directives)if(i.id==c.selectedDitem.directives[t].id){c.selectedDitem.directives.splice(t,1),o(!0);break}r.success("指令删除成功",{})}}),e.close()}},{label:"取消",action:function(e){o(!1),e.close()}}]});else if("directive-save"==e){if(!o)return void n.saveDirective(c.selectedDitem.id,i,function(e){if(0==e.code)for(var t in c.selectedDirective=null,c.selectedDitem.directives)if(i.id==c.selectedDitem.directives[t].id){c.selectedDitem.directives[t].params=i.params;break}});A.show({title:"提示",closable:!1,message:"是否要保存设备指令:"+escape(i.label),buttons:[{label:"确定",cssClass:"btn-success",action:function(e){i.isNew&&(i.id=0),c.selectedDirective&&(i.params=c.selectedDirective.params),n.saveDirective(c.selectedDitem.id,i,function(e){0==e.code&&(o(e.data),r.success("指令保存成功",{}))}),e.close()}},{label:"取消",action:function(e){o(!1),e.close()}}]})}else if("directive-params"==e)n.checkDirectiveParam(i,function(e){0==e.code&&(0<e.data.params.length?c.selectedDirective=e.data:r.info("当前表达式无法解析出参数",{}))});else if("alert-delete"==e)if(i.isNew){for(var l in c.selectedDitem.alerts)if(i.id==c.selectedDitem.alerts[l].id){c.selectedDitem.alerts.splice(l,1),o(!0);break}}else A.show({title:"提示",closable:!1,message:"是否要删除设备告警:"+escape(i.label),buttons:[{label:"确定",cssClass:"btn-success",action:function(e){var t=p(c.selectedDitem);m.deleteThresholdBySolution(t.solutionId,t.groupId,t.modelId,i.id,function(e){if(0==e.code){for(var t in c.selectedDitem.alerts)if(i.id==c.selectedDitem.alerts[t].id){c.selectedDitem.alerts.splice(t,1),o(!0);break}r.success("告警删除成功",{})}}),e.close()}},{label:"取消",action:function(e){o(!1),e.close()}}]});else if("alert-save"==e){2==i.isEdit&&i.isNew&&(i.id=0);var a=p(c.selectedDitem);m.saveThresholdBySolution(a.solutionId,a.groupId,a.modelId,i,function(e){0==e.code&&(o(e.data),r.success("告警保存成功",{}))})}else if("alert-enable"==e){var d="停用";i.thresholds[0].enabled&&(d="启用"),A.show({title:"提示",closable:!1,message:"确认要"+d+"设备告警:"+escape(i.label)+"?",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){n.saveThresholdsByAlert(c.selectedDitem.id,i,function(e){0==e.code&&(o(e.data),r.success("告警已"+d,{}))}),e.close()}},{label:"取消",action:function(e){o(!1),e.close()}}]})}};var I=function(){"设备类型视图"==c.activeMainTab&&(c.activeTab="属性",c.activeListTab="tab1",h()),c.$apply()},M=function(){c.$apply(),"tab2"==c.activeListTab&&o(function(){c.$broadcast(Event.CMDBINFOS4MAPINIT,{option:[n.selectedInstances,n.selectedAttrs]})})};$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){c.selectedDirective=null;var t=$(e.target).attr("name"),i=$(e.target).text();t?(c.activeListTab=t,M()):-1<i.search("视图")?(c.activeMainTab=$.trim($(e.target).text()),c.previousMainTab=$(e.relatedTarget).text(),I()):(c.activeTab=$.trim($(e.target).text()),$.trim($(e.relatedTarget).text()),g())});c.gotoPath=function(e){if(e.nodes!=c.treeAry){var t=[];for(var i in c.routePaths){if(c.routePaths[i].id==e.id){t.push(c.routePaths[i]);break}t.push(c.routePaths[i])}c.routePaths=t,c.showChildren(e)}},c.gotoParentPath=function(e){var t=c.rootModelDic[e.parentModelId];t||(t=c.rootModel);var i=[];for(var o in c.routePaths){if(c.routePaths[o].id==t.id){i.push(c.routePaths[o]);break}i.push(c.routePaths[o])}c.routePaths=i,c.treeAry=t.nodes,c.selectedSolution=t,c.click(c.treeAry[0])},c.gotoBrotherPath=function(e){if(e.nodes!=c.treeAry){var t=[];for(var i in c.routePaths){if(c.routePaths[i].parentModelId==e.parentModelId){t.push(e);break}t.push(c.routePaths[i])}c.routePaths=t,c.showChildren(e)}},c.showChildren=function(e){0!=e.id?e.nodes&&0<e.nodes.length?(c.selectedSolution=e,c.selectedDitem=null,c.treeAry=e.nodes,c.click(c.treeAry[0])):"/resource_type"==t.path()&&0==c.enterpriseType&&(c.selectedSolution=e,c.selectedDitem=null,g(),c.treeAry=[],c.routePaths.push({name:"",parentModelId:c.selectedSolution.id})):r.warning("但前设备模板没有保存，无法进行该操作",{})},c.directiveBack=function(){c.doAction("directive-save",c.selectedDirective)},c.saveThresholds=function(o,s,e){n.saveThresholds(e,function(e){if(0==e.code){r.success("阈值设置保存成功",{});for(var t=!1,i=0;i<o.thresholds.length;i++)if(o.thresholds[i].alertCode==s){o.thresholds[i].thresholdsData=e.data,t=!0;break}t||o.thresholds.push({alertCode:s,thresholdsData:e.data})}})};var w;c.goSearch=function(){c.queryDitem||(c.queryDitem={domainPath:null,modelId:0}),n.getCustomerDeviceByFilter(c.queryDitem,function(e){if(0==e.code){var t=[];for(var i in e.data){var o=e.data[i];o.option="",o.state=1,o.onlineStatus=o.onlineStatus?o.onlineStatus:"online",o.alertlv=Math.floor(4*Math.random()),o.externalDevId=o.externalDevId?o.externalDevId:"",(o.data=o).health=100,o.isEdit=0,o.selected=!1,t.push(o.id)}s=t,l=e.data,kpiDataService.getRealTimeKpiData(s,[999999],function(e){if(0==e.code)for(var t in e.data)for(var i in l)e.data[t].nodeId==l[i].id&&(l[i].health=100-20*e.data[t].value);c.$broadcast(Event.CMDBINFOSINIT+"_shadows",{option:l})}),c.$broadcast(Event.CMDBINFOSINIT+"_shadows",{option:e.data})}var s,l})},c.goClear=function(){c.queryDitem={domainPath:null,modelId:0}},c.placeList=[],c.selectedSolution={},c.deviceModel=0,c.changeModel=function(e){c.deviceModel=e},c.gotoResourceType=function(){w.close(),location.href="../app-oc/index.html#/resource_type"},c.closeDialog=function(){c.deviceModel=0},c.confirm=function(){if(0<!c.deviceModel)r.warning("请选择一个设备模板",{});else{for(var e in c.treeAry)if(c.deviceModel==c.treeAry[e].id)return void r.warning("当前已经关联该设备模板，请重新选择",{});var t=function(e){c.treeAry||(c.treeAry=[]),b(e),c.treeAry.push(e),c.click(e),c.deviceModel=0};0==c.selectedSolution.managedByGroup?m.linkModelToSolution(c.selectedSolution.id,c.deviceModel,function(e){0==e.code&&t(e.data)}):m.linkModelToGroupModel(c.selectedSolution.id,c.selectedGroupitem.id,c.deviceModel,function(e){0==e.code&&t(e.data)}),w.close()}},c.deleteDeviceModel=function(){var t=function(e){for(var t in c.treeAry)if(c.treeAry[t].id==e.id){c.treeAry.splice(t,1);break}0<c.treeAry.length?c.click(c.treeAry[0]):c.selectedDitem=null};A.show({title:"提示",closable:!1,message:"确认解除 "+escape(c.selectedDitem.label)+" 模板吗？",buttons:[{label:"确定",cssClass:"btn-success",action:function(e){0==c.selectedSolution.managedByGroup?m.deleteModelFromSolution(c.selectedSolution.id,c.selectedDitem.id,function(e){0==e.code&&t(e.data)}):m.deleteModelFromGroupModel(c.selectedSolution.id,c.selectedGroupitem.id,c.selectedDitem.id,function(e){0==e.code&&t(e.data)}),e.close()}},{label:"取消",action:function(e){e.close()}}]})},c.addDeviceModel=function(){w=u.open({template:"partials/device-info.html",scope:c})},c.linkDevices=function(){i.selectedGroupitem=c.selectedDitem,i.groupModels=c.treeAry,location.href="#/models"};var y=function(e){for(var t in e)b(e[t]),0==t&&c.click(e[0]);c.treeAry=e},T=function(t){m.getGroupModelsBySolutionId(c.selectedSolution.id,function(e){0==e.code&&t(e.data)})};c.solutionChange=function(e){var t;i.selectedSolution=c.selectedSolution,"/models"==c.treeviewIndex?1==c.selectedSolution.managedByGroup?e&&i.groupModels?(c.selectedGroupitem=i.selectedGroupitem,c.groupModels=i.groupModels):(i.groupModels=null,T(function(e){c.groupModels=e})):(t=y,m.getDeviceModelsBySolutionId(c.selectedSolution.id,function(e){0==e.code&&t(e.data)})):"/modelsGroup"==c.treeviewIndex&&(1==c.selectedSolution.managedByGroup?(i.selectedGroupitem=null,i.groupModels=null,T(y)):(r.warning("该解决方案的类型为[设备]',无法使用[关联设备组]菜单"),location.href="#/models"))},c.groupChange=function(e){var t;"/models"==c.treeviewIndex&&(1==c.selectedSolution.managedByGroup&&e&&i.selectedGroupitem&&(c.selectedGroupitem=i.selectedGroupitem),c.selectedGroupitem?(t=y,m.getModelsByGroupId(c.selectedSolution.id,c.selectedGroupitem.id,function(e){0==e.code&&t(e.data)})):(c.treeAry=null,c.selectedDitem=null))};var S=function(){i.placeList&&0<i.placeList.length?c.placeList=i.placeList:m.getSolutionsByStatus(10,function(e){0==e.code&&(e.data.forEach(function(e){c.placeList.push(e)}),i.placeList=c.placeList)}),i.selectedGroupitem&&(c.groupModels=i.groupModels),i.selectedSolution?(c.selectedSolution=i.selectedSolution,c.solutionChange(!0),c.groupChange(!0)):location.href="#/myView"};c.designDashboardView=function(){var e=p(c.selectedDitem);window.open("../app-editor2/index.html#/editor/solution/"+e.solutionId+"/"+e.groupId+"/"+e.modelId)};var k=function(){v||(c.domainPath=s.user.domainPath,v=!0,(n.rootModel=null)==n.rootModel?n.getRootModel(function(e){0==e.code&&(e.data.name=e.data.label,e.data.text=e.data.label,n.rootModel=e.data,h(),S())}):(c.rootModelDic=n.rootModelDic,c.rootModel=n.rootModel,S()),n.getKpiTypeByFilter({},function(e){if(0==e.code){var t=[];t.push({text:"请选择",label:"请选择",id:-1}),t.push({text:"手动添加指标",label:"手动添加指标",id:0}),e.data.forEach(function(e){e.text=e.label,t.push(e)}),c.kpiList=t}}),$('a[data-toggle="tab"]').on("shown.bs.tab",function(e){c.selectedDirective=null;var t=$(e.target).attr("name"),i=$(e.target).text();t?(c.activeListTab=t,M()):-1<i.search("视图")?(c.activeMainTab=$.trim($(e.target).text()),c.previousMainTab=$(e.relatedTarget).text(),I()):(c.activeTab=$.trim($(e.target).text()),$.trim($(e.relatedTarget).text()),g())}))};s.user.isAuthenticated?k():c.$on("loginStatusChanged",function(e,t){s.user.isAuthenticated&&k()})}])});
//# sourceMappingURL=../../../map/app-ac/js/controllers/cmdb-solution-ctrl.js.map
