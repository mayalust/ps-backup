{"version":3,"sources":["app-uc/js/controllers/message-ctrl.js"],"names":["define","controllers","BootstrapDialog","initController","$scope","$location","userLoginUIService","configUIService","psMessageService","growl","msgStatus","statusMsg","messageList","readMsgStatus","path","chGMT","dateStr","Date","Format","msgGridData","columns","$","ProudSmart","datatable","selectCol","title","data","columnDefs","targets","orderable","render","type","full","message","messageId","status","str2","undefined","messageTypeDic","senderTxt","activeListTab","initEvent","on","e","target","closest","length","removeClass","children","addClass","aname","attr","tabName","$apply","tabMessage","initGetDB","statusQuery","queryMessageByUserID","res","code","msgList","mesListQuery","i","msgType","push","$broadcast","Event","USERCENTERINIT","queryMessageByStatusAndUserID","configGroupsDic","configList","getAllConfigs","returnObj","forEach","item","groupName","configGroups","value","messageType","eval","queryMessage","mesg","allQueryMessage","statusUpdate","messageData","modifyMsgStatus","orderId","trim","content","split","orderAddress","location","href","css","deleteMsg","option","messageInfo","selected","show","closable","buttons","label","cssClass","action","dialogRef","deleteMessageUser","success","close","warning","user","isAuthenticated","$on","evt","d","$sce","$routeParams","msgId","detailMessage","TrustAsHtml","post","trustAsHtml","queryMessageByID"],"mappings":"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","file":"app-uc/js/controllers/message-ctrl.js","sourcesContent":["define(['controllers/controllers', 'bootstrap-dialog'], function (controllers, BootstrapDialog) {\n  'use strict';\n\n  controllers.initController('AllMessageCtrl', ['$scope', '$location', 'userLoginUIService', 'configUIService', 'psMessageService', 'growl', function ($scope, $location, userLoginUIService, configUIService, psMessageService, growl) {\n    $scope.msgStatus = \"全部消息\";\n    $scope.statusMsg = \"0\";\n    $scope.messageList = \"\";\n    $scope.readMsgStatus = $location.path(); //标准时间转换2017-07-17T03:10:38.931+0000\n\n    var chGMT = function chGMT(dateStr) {\n      var mydate = new Date(dateStr);\n      return mydate.Format(\"yyyy-MM-dd hh:mm:ss\");\n    };\n\n    $scope.msgGridData = {\n      columns: [$.ProudSmart.datatable.selectCol, {\n        title: \"消息标题\",\n        data: \"message.title\"\n      }, {\n        title: \"接收时间\",\n        data: \"message.insertTime\"\n      }, {\n        title: \"消息类型\",\n        data: \"message.msgType\"\n      }],\n      columnDefs: [{\n        \"targets\": 0,\n        \"orderable\": false,\n        \"data\": \"message.messageId\",\n        render: function render(data, type, full) {\n          if (type == \"display\") {\n            if (data) {\n              return '<input class=\"itemCheckBox\" value=\"' + full.message.messageId + '\" checked type=\"checkbox\">';\n            } else {\n              return '<input class=\"itemCheckBox\" value=\"' + full.message.messageId + '\" type=\"checkbox\">';\n            }\n          }\n\n          return \"\";\n        }\n      }, {\n        \"targets\": 1,\n        \"data\": \"message.title\",\n        \"render\": function render(data, type, full) {\n          var str = '';\n\n          if (full.status == 0) {\n            str = '<dt><a href class=\"hov-slide\" style=\"color: #444;\" >' + data + '</a></dt>';\n          } else {\n            str = '<span class=\"contacts-list-msg\"><a  href style=\"color: #999;\"   class=\"hov-slide\"  >' + data + '</a></span>';\n          }\n\n          return str;\n        }\n      }, {\n        \"targets\": 2,\n        \"data\": \"message.insertTime\",\n        \"render\": function render(data, type, full) {\n          var str = '';\n\n          if (full.status == 0) {\n            str = '<dt>' + chGMT(data) + '</dt>';\n          } else {\n            str = '<span class=\"contacts-list-msg\">' + chGMT(data) + '</span>';\n          }\n\n          return str;\n        }\n      }, {\n        \"targets\": 3,\n        \"data\": \"message.msgType\",\n        \"render\": function render(data, type, full) {\n          var str2 = '';\n\n          if (full.status == 0 && $scope.messageTypeDic[data] != undefined) {\n            str2 = '<dt>' + $scope.messageTypeDic[data].senderTxt + '</dt>';\n          } else if ($scope.messageTypeDic[data] != undefined) {\n            str2 = '<span class=\"contacts-list-msg\">' + $scope.messageTypeDic[data].senderTxt + '</span>';\n          }\n\n          return str2;\n        }\n      }]\n    };\n    $scope.activeListTab = \"tab1\";\n    /**\n     * tab页的事件监听\n     */\n\n    var initEvent = function initEvent() {\n      $('a[data-toggle=\"tab\"]').on('shown.bs.tab', function (e) {\n        if ($(e.target).closest(\"li.disabled\").length > 0) {\n          $(e.target).closest(\"li.disabled\").removeClass(\"active\");\n          $(e.target).closest(\"ul\").children(\"[name=\" + $scope.activeListTab + \"]\").addClass(\"active\");\n          return;\n        }\n\n        var aname = $(e.target).closest(\"li\").attr(\"name\");\n        var tabName = $(e.target).attr(\"name\");\n\n        if (aname) {\n          $scope.activeListTab = aname;\n          $scope.$apply();\n          tabMessage(tabName);\n        }\n      });\n    };\n\n    var tabMessage = function tabMessage(aname) {\n      if (aname == \"all\") {\n        initGetDB();\n      } else if (aname == \"order\") {\n        statusQuery(\"ticket_message\");\n      } else if (aname == \"bulletin\") {\n        statusQuery(\"bulletin_message\");\n      } else if (aname == \"payment\") {\n        statusQuery(\"payment_message\");\n      } else if (aname == \"maintenance\") {\n        statusQuery(\"maintenance_message\");\n      } else if (aname == \"notice\") {\n        statusQuery(\"notify_message\");\n      } //$scope.$apply();\n\n    };\n\n    var statusQuery = function statusQuery(status) {\n      if ($location.path() == \"/message\") {\n        psMessageService.queryMessageByUserID(function (res) {\n          if (res.code == 0) {\n            $scope.msgGridData.data = res.data;\n            $scope.messageList = res.data;\n            var msgList = $scope.messageList;\n            var mesListQuery = [];\n\n            for (var i in msgList) {\n              if (status == 'notify_message') {\n                if (msgList[i].message.msgType == 'payment_message' || msgList[i].message.msgType == 'maintenance_message' || msgList[i].message.msgType == 'maintenance_msg' || msgList[i].message.msgType == 'notice' || msgList[i].message.msgType == 'gateway_message') {\n                  mesListQuery.push(msgList[i]);\n                }\n              } else {\n                if (msgList[i].message.msgType == status) {\n                  mesListQuery.push(msgList[i]);\n                }\n              }\n            }\n\n            $scope.msgGridData.data = mesListQuery;\n            $scope.$broadcast(Event.USERCENTERINIT + \"_msg\", $scope.msgGridData);\n          }\n        });\n      } else if ($location.path() == \"/unread\") {\n        psMessageService.queryMessageByStatusAndUserID(\"0\", function (res) {\n          if (res.code == 0) {\n            $scope.msgGridData.data = res.data;\n            $scope.messageList = res.data;\n            var msgList = $scope.messageList;\n            var mesListQuery = [];\n\n            for (var i in msgList) {\n              if (status == 'notify_message') {\n                if (msgList[i].message.msgType == 'payment_message' || msgList[i].message.msgType == 'maintenance_message' || msgList[i].message.msgType == 'maintenance_msg' || msgList[i].message.msgType == 'notice' || msgList[i].message.msgType == 'gateway_message') {\n                  mesListQuery.push(msgList[i]);\n                }\n              } else {\n                if (msgList[i].message.msgType == status) {\n                  mesListQuery.push(msgList[i]);\n                }\n              }\n            }\n\n            $scope.msgGridData.data = mesListQuery;\n            $scope.$broadcast(Event.USERCENTERINIT + \"_msg\", $scope.msgGridData);\n          }\n        });\n      } else if ($location.path() == \"/read\") {\n        psMessageService.queryMessageByStatusAndUserID(\"1\", function (res) {\n          if (res.code == 0) {\n            $scope.msgGridData.data = res.data;\n            $scope.messageList = res.data;\n            var msgList = $scope.messageList;\n            var mesListQuery = [];\n\n            for (var i in msgList) {\n              if (status == 'notify_message') {\n                if (msgList[i].message.msgType == 'payment_message' || msgList[i].message.msgType == 'maintenance_message' || msgList[i].message.msgType == 'maintenance_msg' || msgList[i].message.msgType == 'notice' || msgList[i].message.msgType == 'gateway_message') {\n                  mesListQuery.push(msgList[i]);\n                }\n              } else {\n                if (msgList[i].message.msgType == status) {\n                  mesListQuery.push(msgList[i]);\n                }\n              }\n            }\n\n            $scope.msgGridData.data = mesListQuery;\n            $scope.$broadcast(Event.USERCENTERINIT + \"_msg\", $scope.msgGridData);\n          }\n        });\n      } //psMessageService.queryMessageByTypeAndUserID(status, function (ret) {\n      //\n      //  if (ret.code == 0) {\n      //    $scope.msgGridData.data = ret.data;\n      //    $scope.$broadcast(Event.USERCENTERINIT + \"_msg\", $scope.msgGridData);\n      //  }\n      //});\n\n    };\n\n    $scope.messageTypeDic = {};\n    $scope.configGroupsDic = {}; //获取所有的全局配置\n\n    var configList = function configList() {\n      configUIService.getAllConfigs(function (returnObj) {\n        if (returnObj.code == 0) {\n          returnObj.data.forEach(function (item) {\n            $scope.configGroupsDic[item.groupName] = item;\n          });\n          $scope.configGroups = returnObj.data;\n\n          if (returnObj.data.length > 0 && $scope.configGroupsDic[\"messageType\"] != undefined && $scope.configGroupsDic[\"messageType\"].value) {\n            var messageType = eval(\"(\" + $scope.configGroupsDic[\"messageType\"].value + \")\");\n            $scope.messageTypeDic = messageType;\n            /*messageType.forEach(function(user) {\n              $scope.messageTypeDic[user.typeCode] = user;\n            });*/\n          }\n\n          initGetDB();\n        }\n      });\n    };\n\n    var queryMessage = function queryMessage(mesg) {\n      //查询消息的状态\n      psMessageService.queryMessageByStatusAndUserID(mesg, function (res) {\n        if (res.code == 0) {\n          $scope.msgGridData.data = res.data;\n          $scope.messageList = res.data;\n          $scope.$broadcast(Event.USERCENTERINIT + \"_msg\", $scope.msgGridData);\n        }\n      });\n    };\n\n    var initGetDB = function initGetDB() {\n      if ($location.path() == \"/message\") {\n        $scope.msgStatus = \"全部消息\";\n        $scope.statusMsg = '0';\n        allQueryMessage();\n      } else if ($location.path() == \"/unread\") {\n        $scope.msgStatus = \"未读消息\";\n        $scope.statusMsg = '0';\n        queryMessage(\"0\");\n      } else if ($location.path() == \"/read\") {\n        $scope.msgGridData = {\n          columns: [{\n            title: \"消息标题\",\n            data: \"message.title\"\n          }, {\n            title: \"接收时间\",\n            data: \"message.insertTime\"\n          }, {\n            title: \"消息类型\",\n            data: \"message.msgType\"\n          }],\n          columnDefs: [{\n            \"targets\": 0,\n            \"data\": \"message.title\",\n            \"render\": function render(data, type, full) {\n              var str = '';\n\n              if (full.status == 0) {\n                str = '<dt><a href class=\"hov-slide\" style=\"color: #444;\" >' + data + '</a></dt>';\n              } else {\n                str = '<span class=\"contacts-list-msg\"><a  href style=\"color: #999;\"   class=\"hov-slide\"  >' + data + '</a></span>';\n              }\n\n              return str;\n            }\n          }, {\n            \"targets\": 1,\n            \"data\": \"message.insertTime\",\n            \"render\": function render(data, type, full) {\n              var str = '';\n\n              if (full.status == 0) {\n                str = '<dt>' + chGMT(data) + '</dt>';\n              } else {\n                str = '<span class=\"contacts-list-msg\">' + chGMT(data) + '</span>';\n              }\n\n              return str;\n            }\n          }, {\n            \"targets\": 2,\n            \"data\": \"message.msgType\",\n            \"render\": function render(data, type, full) {\n              var str2 = '';\n\n              if (full.status == 0 && $scope.messageTypeDic[data] != undefined) {\n                str2 = '<dt>' + $scope.messageTypeDic[data].senderTxt + '</dt>';\n              } else if ($scope.messageTypeDic[data] != undefined) {\n                str2 = '<span class=\"contacts-list-msg\">' + $scope.messageTypeDic[data].senderTxt + '</span>';\n              }\n\n              return str2;\n            }\n          }]\n        };\n        $scope.msgStatus = \"已读消息\";\n        queryMessage(\"1\");\n        $scope.statusMsg = '1';\n      }\n    };\n\n    var allQueryMessage = function allQueryMessage() {\n      psMessageService.queryMessageByUserID(function (res) {\n        if (res.code == 0) {\n          $scope.msgGridData.data = res.data;\n          $scope.messageList = res.data;\n          $scope.$broadcast(Event.USERCENTERINIT + \"_msg\", $scope.msgGridData);\n        }\n      });\n    };\n\n    $scope.statusUpdate = function (messageData) {\n      psMessageService.modifyMsgStatus([messageData.message.messageId], function (res) {\n        if (res.code == 0) {\n          if (messageData.message.msgType == \"ticket_message\") {\n            var str2 = $.trim(messageData.message.content);\n            var orderId = str2.split(\"任务ID：\")[1];\n            var orderAddress = str2.split(\"任务地址：\")[1];\n\n            if (orderAddress) {\n              // location.href = '../app-oc/index.html#/deviceTask/' + orderId.split(\",\")[0] + '';\n              location.href = orderAddress + \"/\" + orderId.split(\",\")[0];\n            } else {\n              location.href = '../app-oc/index.html#/orderdetail/' + orderId.split(\",\")[0] + '/task/message';\n            }\n          } else if (messageData.message.msgType == \"ticket_maintenance_message\") {\n            var str2 = $.trim(messageData.message.content);\n            var orderId = str2.split(\"任务ID：\")[1];\n            location.href = '../app-oc/index.html#/deviceTask/' + orderId.split(\",\")[0] + '';\n          } else if (messageData.message.msgType == \"payment_message\") {\n            $(\"#info\").css(\"display\", \"none\");\n            $(\"#exp\").css(\"display\", \"block\");\n            location.href = '../app-uc/index.html#/expenses';\n          } else if (messageData.message.msgType == \"alert_message_insystem\") {\n            location.href = '../app-oc/index.html#/configAlert/' + $.trim(messageData.message.content) + '/alert';\n          } else if (messageData.message.msgType == \"maintenance_msg\") {\n            location.href = '../app-oc/index.html#/maintenance/' + $.trim(messageData.message.content) + '';\n          } else {\n            location.href = '#/messageDetail/' + messageData.message.messageId + '';\n          }\n        }\n      });\n    };\n\n    $scope.deleteMsg = function (option) {\n      $scope.messageInfo = [];\n      var messageList = $scope.msgGridData.data;\n      var messageId = \"\";\n      /*$(\".itemCheckBox\").each(function() {\n        if($(this).is(':checked')) {\n          messageId += $(this).val() + \",\";\n          $scope.messageInfo.push($(this).val());\n        }\n      });*/\n\n      messageList.forEach(function (item) {\n        if (item.selected && item.status == 0 && option == '2' || item.selected && option == '1') {\n          messageId += item.message.messageId + \",\";\n          $scope.messageInfo.push(item.message.messageId);\n        }\n      });\n\n      if (option == '1') {\n        if ($scope.messageInfo.length > 0) {\n          BootstrapDialog.show({\n            title: '提示',\n            closable: false,\n            message: '您确认要删除选中的' + $scope.messageInfo.length + '条消息吗？',\n            buttons: [{\n              label: '确定',\n              cssClass: 'btn-success',\n              action: function action(dialogRef) {\n                psMessageService.deleteMessageUser($scope.messageInfo, function (res) {\n                  if (res.code == 0) {\n                    growl.success(\"删除消息成功\", {});\n                    initGetDB();\n                  }\n                });\n                dialogRef.close();\n              }\n            }, {\n              label: '取消',\n              action: function action(dialogRef) {\n                dialogRef.close();\n              }\n            }]\n          });\n        } else {\n          growl.warning(\"请选择要删除的消息\", {});\n        }\n      } else if (option == '2') {\n        if ($scope.messageInfo.length > 0) {\n          BootstrapDialog.show({\n            title: '提示',\n            closable: false,\n            message: '您确认要标记选中的' + $scope.messageInfo.length + '条消息为已读吗？',\n            buttons: [{\n              label: '确定',\n              cssClass: 'btn-success',\n              action: function action(dialogRef) {\n                psMessageService.modifyMsgStatus($scope.messageInfo, function (res) {\n                  if (res.code == 0) {\n                    growl.success(\"消息标记已读成功\", {});\n                    tabMessage($(\".nav-tabs .active  a \").attr(\"name\"));\n                  }\n                });\n                dialogRef.close();\n              }\n            }, {\n              label: '取消',\n              action: function action(dialogRef) {\n                dialogRef.close();\n              }\n            }]\n          });\n        } else {\n          growl.warning(\"请选择要标记为已读的消息,已读消息不算数哦！\", {});\n        }\n      }\n    }; //判断用户是否存在\n\n\n    if (!userLoginUIService.user.isAuthenticated) {\n      $scope.$on('loginStatusChanged', function (evt, d) {\n        if (userLoginUIService.user.isAuthenticated) {\n          initEvent();\n          configList();\n        }\n      });\n    } else {\n      initEvent();\n      configList();\n    }\n  }]);\n  controllers.initController('messageDetailCtrl', ['$scope', '$sce', '$routeParams', '$location', 'userLoginUIService', 'psMessageService', 'growl', function ($scope, $sce, $routeParams, $location, userLoginUIService, psMessageService, growl) {\n    var msgId = $routeParams.msgId;\n    $scope.detailMessage = \"\";\n\n    $scope.TrustAsHtml = function (post) {\n      return $sce.trustAsHtml(post);\n    };\n\n    psMessageService.queryMessageByID(msgId, function (res) {\n      if (res.code == 0) {\n        $scope.detailMessage = res.data;\n      }\n    });\n  }]);\n});"],"sourceRoot":"/source/"}