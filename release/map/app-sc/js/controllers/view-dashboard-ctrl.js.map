{"version":3,"sources":["app-sc/js/controllers/view-dashboard-ctrl.js"],"names":["define","controllers","psUltility","initController","scope","rootSccope","$state","$stateParams","userEnterpriseService","rootScope","routeParams","resourceUIService","timeout","growl","q","window","location","viewFlexService","freeboardservice","userLoginUIService","roleViewService","commonMethodService","serviceProxy","commonMethodService2","cmd","undefined","instance","viewId","$root","path","index","user","getCurrentParents","then","parents","extId","str","toLowerCase","toLowercase","length","category","externalDevId","map","d","label","join","treeStr","catch","e","console","error","message","$emit","main_active_index","defer","url","showTree","callApi","service","method","param","get","code","resolve","data","reject","promise","getViewById_back","event","input","dt","content","JSON","parse","setting","bgColor","color","hasOwnProperty","find","element","tabIndex","indexOf","tabs","groups","layout","editData","replaceCiKpi","setMode","renderLayout","navigation","urlparser","href","test","some","address","item","port","stopInspection","success","reload","saveView","startInspection","psrequire","view","isNaN","getView","json","getViewById"],"mappings":"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","file":"app-sc/js/controllers/view-dashboard-ctrl.js","sourcesContent":["define(['controllers/controllers', '../../../../node_modules/ps-ultility/ps-ultility'], function (controllers, psUltility) {\n  'use strict';\n\n  controllers.initController('viewDashboardCtrl', ['$scope', '$rootScope', '$state', '$stateParams', 'userEnterpriseService', '$rootScope', '$routeParams', 'resourceUIService', '$timeout', 'growl', '$q', '$window', '$location', 'viewFlexService', 'freeboardservice', 'userLoginUIService', 'roleViewService', 'commonMethodService', 'serviceProxy', 'commonMethodService2', function (scope, rootSccope, $state, $stateParams, userEnterpriseService, rootScope, routeParams, resourceUIService, timeout, growl, q, window, location, viewFlexService, freeboardservice, userLoginUIService, roleViewService, commonMethodService, serviceProxy, commonMethodService2) {\n    var cmd = commonMethodService(undefined, scope);\n    scope.instance = {};\n    var viewId = scope.$root.viewId = $stateParams.viewId,\n        viewTitle = \"index\",\n        path = $stateParams.index; // 隐藏左边视图的多余部位\n\n    var user = userLoginUIService.user || {};\n\n    function toLowercase(str) {\n      if (typeof str == \"string\") {\n        return str.toLowerCase();\n      }\n    }\n\n    commonMethodService2.getCurrentParents().then(function (parents) {\n      var extId = toLowercase(parents[parents.length - 1].category) == \"device\" && parents[parents.length - 1].externalDevId,\n          str = parents.map(function (d) {\n        return d.label;\n      }).join(\" > \");\n      extId ? str += \" ( \" + extId + \" ) \" : null;\n      rootScope ? rootScope.treeStr = str : null;\n    }).catch(function (e) {\n      console.error(e.message);\n    });\n    /**\n     *\n     * 判断是否要显示树\n     * 0 不显示 1 显示\n     */\n\n    scope.$emit(\"main_active_index\", $stateParams.main_active_index);\n    var showTree = $stateParams.showTree;\n\n    if (showTree == 0) {\n      scope.$root.showTree = false;\n    } else {\n      scope.$root.showTree = true;\n    }\n    /**\n     * 获取当前视图的viewId\n     * 根据viewId来查找当前的视图渲染页面\n     * 如果不是仪表板到视图id，可以跳转到对应的配置ID\n     */\n\n    /**  本地8080端口执行调用本地js视图文件 **/\n\n\n    function callApi(service, method, param) {\n      var defer = q.defer(),\n          callBack = function callBack(d) {\n        if (d.code == 0) {\n          defer.resolve(d.data || []);\n        } else {\n          defer.reject(d);\n        }\n      },\n          error = function error(e) {\n        defer.reject(e);\n      };\n\n      serviceProxy.get(service, method, param, callBack, error);\n      return defer.promise;\n    }\n\n    function startInspection(viewId) {\n      return callApi(\"inspectionService\", \"start\", viewId);\n    }\n\n    function stopInspection(viewId) {\n      return callApi(\"inspectionService\", \"end\", viewId);\n    }\n\n    function saveView(viewId) {\n      return callApi(\"inspectionService\", \"save\", viewId);\n    }\n\n    function getListeners(viewId) {\n      return callApi(\"inspectionService\", \"getlisteners\", viewId);\n    }\n\n    function checkLoadLocalView(viewId) {\n      var defer = q.defer(),\n          url = psUltility.urlparser(window.location.href);\n\n      function hasValue(str) {\n        return function (item) {\n          return item === str;\n        };\n      }\n\n      if (!/\\d+/.test(viewId + \"\")) {\n        defer.reject(\"not a number\");\n        return defer.promise;\n      }\n\n      if ([\"localhost\", \"127.0.0.1\"].some(hasValue(url.address)) && url.port == 8080) {\n        getListeners(viewId).then(function (d) {\n          if (d.indexOf(viewId) !== -1) {\n            rootScope.stopInspection = function () {\n              stopInspection(viewId).then(function (d) {\n                growl.success(\"结束本地监听视图 : \" + viewId);\n                window.location.reload();\n              }).catch(function (e) {\n                growl.error(\"移除监听故障 : \" + viewId);\n              });\n            };\n\n            rootScope.saveView = function () {\n              saveView(viewId).then(function (d) {\n                growl.success(\"成功保存视图 : \" + viewId);\n              }).catch(function (e) {\n                growl.error(\"不能保存视图 : \" + viewId);\n              });\n            };\n\n            delete rootScope.startInspection;\n          } else {\n            rootScope.startInspection = function () {\n              startInspection(viewId).then(function (d) {\n                growl.success(\"开始本地监听视图 : \" + viewId);\n                window.location.reload();\n              }).catch(function (e) {\n                growl.error(\"监听故障 : \" + viewId);\n              });\n            };\n\n            delete rootScope.stopInspection;\n            delete rootScope.saveView;\n          }\n\n          if (typeof viewId !== \"undefined\") {\n            psrequire([\"../app-views/build/\" + viewId + \".\" + path], function (view) {\n              var editData = new freeboardservice.replaceCiKpi(view, function () {\n                timeout(function () {\n                  scope.instance.setMode(true);\n                  scope.instance.renderLayout(editData, null, scope);\n                });\n              }, null, null, scope);\n              defer.resolve(\"user local\");\n            }, function (e) {\n              defer.reject(\"user server\");\n            });\n          }\n        });\n      } else {\n        defer.reject(\"user server\");\n      }\n\n      return defer.promise;\n    }\n    /**  本地8080端口执行调用本地js视图文件 **/\n\n\n    function toObject(content) {\n      var dt = JSON.parse(content);\n\n      if (typeof dt.setting == \"string\") {\n        dt.setting = JSON.parse(dt.setting);\n      }\n\n      scope.setting = dt.setting;\n\n      if (dt.setting) {\n        scope.bgColor = dt.setting.color;\n      }\n\n      return dt;\n    }\n\n    function getViewById_back(event) {\n      if (event.code == 0 && event.data != null) {\n        var input;\n        var dt = toObject(event.data.content);\n\n        if (dt.hasOwnProperty(\"groups\")) {\n          var find = dt[\"groups\"].find(function (element) {\n            return $stateParams.index == element.path;\n          });\n          scope.tabIndex = find ? dt['groups'].indexOf(find) : 0;\n          scope.tabs = dt.groups;\n          input = {\n            layout: dt.groups[scope.tabIndex].layout,\n            setting: dt.setting\n          };\n          var editData = new freeboardservice.replaceCiKpi(input, function () {\n            timeout(function () {\n              scope.instance.setMode(true);\n              scope.instance.renderLayout(editData, null, scope);\n            });\n          }, null, dt, scope);\n        } else if (dt.hasOwnProperty(\"layout\")) {\n          scope.navigation = [{\n            label: \"服务中心\"\n          }];\n          input = {\n            layout: dt.layout,\n            setting: dt.setting\n          };\n          var editData = new freeboardservice.replaceCiKpi(input, function () {\n            timeout(function () {\n              scope.instance.setMode(true);\n              scope.instance.renderLayout(editData, null, scope);\n            });\n          }, null, dt, scope);\n        }\n\n        ;\n      } else {\n        scope.error = \"获取此此用户角色的服务视图发生错误\" + (event.message ? \",\" + event.message : \"\");\n      }\n\n      ;\n    }\n\n    ;\n    checkLoadLocalView(viewId).then(function (e) {}).catch(function (d) {\n      if (!isNaN(viewId)) {\n        viewFlexService.getViewById(viewId, getViewById_back);\n      } else {\n        // 针对directive的名称解析对应的视图\n        cmd.getView({\n          path: \"viewCtrl:\" + viewId,\n          item: {}\n        }, function (json) {\n          var editData = new freeboardservice.replaceCiKpi(json, function () {\n            timeout(function () {\n              scope.instance.setMode(true);\n              scope.instance.renderLayout(editData, null, scope);\n            });\n          }, null, null, scope);\n        });\n      }\n    });\n  }]);\n});"],"sourceRoot":"/source/"}