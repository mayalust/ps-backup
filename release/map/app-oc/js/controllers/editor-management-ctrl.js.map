{"version":3,"sources":["app-oc/js/controllers/editor-management-ctrl.js"],"names":["define","controllers","BootstrapDialog","initController","$scope","resourceUIService","$q","ngDialog","$location","$routeParams","$timeout","userLoginUIService","Info","growl","configUIService","callback","getConfigsByGroupName","calcRule","returnData","console","log","i","data","length","value","JSON","parse","id","type","substring","push","calcRules","source","showSelector","showIndex","header","strHeader","columnDefs","label","width","editable","sortable","filterable","modes","default","edit","placeholder","options","optList","result","saveConfigGroup","name","getAllConfigGroups","notFind","flag","editor","json","code","editorManagemengt","error","itemsNameArr","$$","isExistItems","itemsNameId","hasElement","useableJson","toUpperCase","config","stringify","groupName","Id","saveConfig","close","closeEditorManagemengt","strEdit","class","events","click","target","open","template","className","scope","$$hashKey","strDel","fnlist","icon","style","border-radius","font-size","font-weight","padding","fn","configId","deleteConfig","dialog","title","description","margin","advance","expression","height"],"mappings":"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","file":"app-oc/js/controllers/editor-management-ctrl.js","sourcesContent":["define(['controllers/controllers', 'bootstrap-dialog'], function (controllers, BootstrapDialog) {\n  'use strict';\n\n  controllers.initController('editorManagementCtrl', ['$scope', 'resourceUIService', '$q', 'ngDialog', '$location', '$routeParams', '$timeout', 'userLoginUIService', 'Info', 'growl', 'configUIService', function ($scope, resourceUIService, $q, ngDialog, $location, $routeParams, $timeout, userLoginUIService, Info, growl, configUIService) {\n    /**\n     * 查询AllConfigs 里面有没有CustomerTools，\n     * 没有就创建一个\n     */\n    function isHaveCustomerTools(callback) {\n      return configUIService.getAllConfigGroups(function (returnData) {\n        var notFind = true;\n\n        for (var i = 0; i < returnData.data.length; i++) {\n          if (returnData.data[i].name == \"CustomerTools\") {\n            notFind = false;\n            break;\n          }\n        }\n\n        callback(notFind);\n      });\n    }\n\n    isHaveCustomerTools(function (result) {\n      if (result) {\n        var configGroup = {\n          label: '自定义视图组件',\n          name: 'CustomerTools'\n        };\n        configUIService.saveConfigGroup(configGroup, function (returnData) {\n          console.log(returnData);\n        });\n      } else {\n        getConfigsByGroupName();\n      }\n    }); // 刷新表格\n\n    function getConfigsByGroupName() {\n      $scope.calcRule = [];\n      var configGroupName = \"CustomerTools\";\n      configUIService.getConfigsByGroupName(configGroupName, function (returnData) {\n        console.log(returnData);\n\n        for (var i = 0; i < returnData.data.length; i++) {\n          var value = JSON.parse(returnData.data[i].value);\n          value.id = returnData.data[i].id;\n          value.type = value.type.substring(7);\n          $scope.calcRule.push(value);\n        }\n      });\n      console.log($scope.calcRule);\n      /**\n       * 创建表格\n       * @type {{source: Array, showSelector: boolean, showIndex: boolean, header: [null], columnDefs: [null,null,null]}}\n       */\n\n      $scope.calcRules = {\n        source: $scope.calcRule,\n        showSelector: false,\n        showIndex: true,\n        header: [strHeader],\n        columnDefs: [{\n          label: \"名称\",\n          width: \"35%\",\n          editable: true,\n          sortable: false,\n          filterable: true,\n          data: \"label\",\n          type: \"text\",\n          modes: {\n            default: {\n              type: \"text\"\n            },\n            edit: {\n              type: \"input\",\n              placeholder: \"例如：请填写用户名，用户名不可为空\"\n            }\n          }\n        }, {\n          label: \"标识\",\n          editable: true,\n          sortable: false,\n          filterable: true,\n          data: \"type\",\n          type: \"text\",\n          modes: {\n            default: {\n              type: \"text\"\n            },\n            edit: {\n              type: \"input\",\n              placeholder: \"例如：请填写用户名，用户名不可为空\"\n            }\n          }\n        }, {\n          label: \"操作\",\n          type: \"buttonGroup\",\n          filterable: false,\n          sortable: false,\n          width: '100px',\n          modes: {\n            default: {\n              options: optList\n            }\n          }\n        }]\n      };\n    }\n    /**\n     * 校验方法\n     * 创建设计服务器\n     * @type {{name: string, id: string, json: string, code: string}}\n     */\n\n\n    $scope.editor = {\n      name: \"\",\n      id: \"\",\n      json: \"\",\n      code: \"\"\n    }; // 校验不能为空\n\n    function checkoutInfo() {\n      if ($scope.editor.name == '') {\n        growl.error(\"名称不能为空\");\n        return false;\n      }\n\n      if ($scope.editor.id == '') {\n        growl.error(\"标识不能为空\");\n        return false;\n      }\n\n      return true;\n    } // 查重\n\n\n    function hasElement() {\n      var itemsNameArr = [];\n\n      for (var i = 0; i < $scope.calcRule.length; i++) {\n        itemsNameArr.push($scope.calcRule[i].label);\n      }\n\n      if ($$.isExistItems($scope.editor.name, itemsNameArr)) {\n        growl.error(\"名称已经存在\");\n        return false;\n      }\n\n      var itemsNameId = [];\n\n      for (var i = 0; i < $scope.calcRule.length; i++) {\n        itemsNameId.push($scope.calcRule[i].type);\n      }\n\n      if ($$.isExistItems($scope.editor.id, itemsNameId)) {\n        growl.error(\"标识已经存在\");\n        return false;\n      }\n\n      return true;\n    } // 点击提交按钮\n\n\n    var flag = false; // 用来判断是编辑还是添加\n\n    $scope.editorManagemengt = function () {\n      if (checkoutInfo() && hasElement()) {\n        var useableJson = JSON.parse($scope.editor.json);\n        console.log(useableJson);\n        useableJson.label = $scope.editor.name;\n        useableJson.type = \"custom_\" + $scope.editor.id;\n        useableJson.source = \"CUSTOM_\" + $scope.editor.id.toUpperCase();\n\n        if (flag) {\n          var config = {\n            value: JSON.stringify(useableJson),\n            label: $scope.editor.name,\n            groupName: \"CustomerTools\"\n          };\n        } else {\n          config = {\n            value: JSON.stringify(useableJson),\n            label: $scope.editor.name,\n            groupName: \"CustomerTools\",\n            id: $scope.editor.Id\n          };\n        }\n\n        console.log(config);\n        configUIService.saveConfig(config, function (returnData) {\n          console.log(returnData);\n          getConfigsByGroupName();\n        });\n        ngDialog.close();\n      }\n    };\n\n    $scope.closeEditorManagemengt = function () {\n      ngDialog.close();\n      getConfigsByGroupName();\n    };\n    /**\n     *  $scope.calcRule 表格名称\n     * optList 操作按钮数组\n     * editClick  编辑按钮方法  delectClick 删除按钮方法  addNewClick  添加设计器名称\n     * @type {Array}\n     */\n\n\n    var optList = []; // 添加设计器名称\n\n    var addNewClick = function addNewClick(target) {\n      var json = {\n        \"advance\": {\n          \"expression\": \"express = {\\n  on : {\\n    init : function(event){\\n      var target = event.target;\\n      var global = event.global;\\n      var hours = ['12a', '1a', '2a', '3a', '4a', '5a', '6a','7a', '8a', '9a', '10a', '11a',\\n          '12p', '1p', '2p', '3p', '4p', '5p','6p', '7p', '8p', '9p', '10p', '11p'];\\n      var days = ['1', '2', '3','4', '5', '6', '7'];\\n      var data = [[12, 0, 10], [3, 3, 15], [4, 3, 20], [10, 1, 12], [3, 0, 14]]\\n      var option = {\\n        tooltip: {},\\n        visualMap: {\\n            max: 20,\\n            inRange: {\\n                color: ['#313695', '#4575b4', '#74add1', '#abd9e9', '#e0f3f8', '#ffffbf', '#fee090', '#fdae61', '#f46d43', '#d73027', '#a50026']\\n            }\\n        },\\n        xAxis3D: {\\n            type: 'category',\\n            data: hours\\n        },\\n        yAxis3D: {\\n            type: 'category',\\n            data: days\\n        },\\n        zAxis3D: {\\n            type: 'value'\\n        },\\n        grid3D: {\\n            boxWidth: 200,\\n            boxHeight: 40,\\n            boxDepth: 90,\\n            light: {\\n                main: {\\n                    intensity: 1.2\\n                },\\n                ambient: {\\n                    intensity: 0.3\\n                }\\n            }\\n        },\\n        series: [{\\n            type: 'bar3D',\\n            data: data.map(function (item) {\\n                return {\\n                    value: [item[1], item[0], item[2]]\\n                }\\n            }),\\n            shading: 'color',\\n\\n            label: {\\n                show: false,\\n                textStyle: {\\n                    fontSize: 16,\\n                    borderWidth: 1\\n                }\\n            },\\n\\n            itemStyle: {\\n                opacity: 0.8\\n            },\\n\\n            emphasis: {\\n                label: {\\n                    textStyle: {\\n                        fontSize: 20,\\n                        color: '#900'\\n                    }\\n                },\\n                itemStyle: {\\n                    color: '#900'\\n                }\\n            }\\n        }]\\n    }\\n    //   target.line3DOption()  3D 折线图\\n    //   target.bar3DOption()  3D  柱状图\\n    //   target.scatter3DOption()  3D 散点图\\n      event.target.render(option);\\n    }\\n  }\\n}\"\n        },\n        \"style\": {\n          \"margin\": \"auto\",\n          \"width\": \"100%\",\n          \"height\": \"300px\"\n        }\n      };\n      $scope.editor = {\n        name: \"\",\n        id: \"\",\n        json: JSON.stringify(json, null, 2),\n        code: \"function tool(data) {\\n  var element = data.element;\\n  var global = data.global;\\n  var target = $(\\\"<div></div>\\\");\\n  var route = data.route;\\n  if(element.style) {\\n    target.css(element.style);\\n  };\\n  var expression;\\n  $$.runExpression(element.$attr(\\\"advance/expression\\\"), function(funRes) {\\n    if(funRes.code == \\\"0\\\") {\\n      var fnResult = funRes.data;\\n      if(typeof fnResult == 'function') {\\n        expression = fnResult(data, system);\\n      } else {\\n        expression = fnResult;\\n      }\\n      expression = expression ? expression : {};\\n    } else {\\n      expression = {};\\n      console.log(funRes.message);\\n      //throw new Error(funRes.message);\\n    }\\n  });\\n  var clickFn = expression.$attr(\\\"on/click\\\");\\n  var initFn = expression.$attr(\\\"on/init\\\");\\n  target.on(\\\"click\\\", function(event){\\n    if(typeof clickFn == \\\"function\\\"){\\n      target.css(\\\"cursor\\\", \\\"pointer\\\");\\n      if(route.current.$$route.controller != \\\"freeBoardCtrl\\\"){\\n        clickFn({\\n          target : element,\\n          global : global\\n        })\\n      };\\n    }\\n  });\\n  var render = function(){\\n  };\\n  element.render = render\\n  if(initFn){\\n    try {\\n      initFn({\\n        target : element,\\n        global : global\\n      })\\n    } catch(e){\\n      element.growl(e.message, \\\"warning\\\");\\n    }\\n  } else {\\n    render();\\n  };\\n  return target;\\n}\"\n      };\n      ngDialog.open({\n        template: '../partials/dialogue/editor_management_diag.html',\n        className: 'ngdialog-theme-plain',\n        scope: $scope\n      });\n      flag = true;\n    }; // 编辑按钮方法\n\n\n    var editClick = function editClick(target) {\n      console.log(target);\n      ngDialog.open({\n        template: '../partials/dialogue/editor_management_diag.html',\n        className: 'ngdialog-theme-plain',\n        scope: $scope\n      });\n      $scope.editor = {\n        name: target.label,\n        id: target.source.substring(7),\n        code: target.code,\n        Id: target.id\n      };\n      delete target.label;\n      delete target.$$hashKey;\n      delete target.source;\n      delete target.type;\n      delete target.id;\n      $scope.editor.json = JSON.stringify(target, null, 2);\n      flag = false;\n    }; // 删除按钮方法\n\n\n    var delectClick = function delectClick(target) {\n      var fnlist = [{\n        label: \"确定\",\n        icon: 'btn btn-success',\n        style: {\n          width: '50%',\n          'border-radius': 0,\n          'font-size': '18px',\n          'font-weight': 'bold',\n          'padding': 10\n        },\n        fn: function fn() {\n          ngDialog.close();\n          var configId = target.id;\n          configUIService.deleteConfig(configId, function (returnData) {\n            console.log(returnData);\n          });\n          getConfigsByGroupName();\n        }\n      }, {\n        label: \"取消\",\n        icon: 'btn btn-default',\n        style: {\n          width: '50%',\n          'border-radius': 0,\n          'font-size': '18px',\n          'font-weight': 'bold',\n          'padding': 10\n        },\n        fn: function fn() {\n          ngDialog.close();\n        }\n      }];\n      $scope.dialog = {\n        title: {\n          label: '提示'\n        },\n        description: {\n          label: '确认要删除此工具？'\n        },\n        fnlist: fnlist\n      };\n      ngDialog.open({\n        template: '../partials/dialogue/common_dia_prompt.html',\n        className: 'ngdialog-theme-plain',\n        scope: $scope\n      });\n    };\n\n    var strEdit = {\n      label: \"编辑\",\n      type: \"button\",\n      class: \"btn btn-primary\",\n      events: {\n        click: editClick\n      }\n    };\n    optList.push(strEdit);\n    var strDel = {\n      label: \"删除\",\n      type: \"button\",\n      class: \"btn btn-default\",\n      events: {\n        click: delectClick\n      }\n    };\n    optList.push(strDel);\n    var strHeader = {\n      icon: \"fa fa-plus\",\n      class: \"btn btn-warning btn-sm\",\n      label: \"添加设计器名称\",\n      style: {\n        margin: \"2px\"\n      },\n      type: \"button\",\n      events: {\n        click: addNewClick\n      }\n    };\n  }]);\n});"],"sourceRoot":"/source/"}