{"version":3,"sources":["app-oc/js/controllers/facility-panel-ctrl.js"],"names":["define","controllers","BootstrapDialog","initController","scope","q","timeout","$routeParams","growl","userUIService","userEnterpriseService","kpiDataService","resourceUIService","Info","viewFlexService","userDomainService","userLoginUIService","customerUIService","projectUIService","ngDialog","deviceAccessUIService","freeboardservice","roleViewService","decodeURIComponent","parameter","JSON","parse","modelId","resourceId","instance","getManagedViewsByTypeAndRole","event","allAvaliableViews","defaultDviews","code","data","getDefaultView","Array","template","templateDefault","find","elem","templateExtent","viewId","user","roleResList","some","resId","resType","getViewById","model","resource","content","getModelByIds","getResource_back","clone","hasOwnProperty","input","layout","setting","editData","replaceCiKpi","setMode","renderLayout","getResourceById","getResources","resources","itemchange","id","split","str","stringify","error","encodeURIComponent"],"mappings":"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","file":"app-oc/js/controllers/facility-panel-ctrl.js","sourcesContent":["define(['controllers/controllers', 'bootstrap-dialog', 'Array'], function (controllers, BootstrapDialog) {\n  'use strict';\n\n  controllers.initController('FacilityPanelCtrl', ['$scope', '$q', '$timeout', '$routeParams', 'growl', 'userUIService', 'userEnterpriseService', 'kpiDataService', 'resourceUIService', 'Info', 'viewFlexService', 'userDomainService', 'userLoginUIService', 'customerUIService', 'projectUIService', 'ngDialog', 'deviceAccessUIService', 'freeboardservice', 'roleViewService', function (scope, q, timeout, $routeParams, growl, userUIService, userEnterpriseService, kpiDataService, resourceUIService, Info, viewFlexService, userDomainService, userLoginUIService, customerUIService, projectUIService, ngDialog, deviceAccessUIService, freeboardservice, roleViewService) {\n    var str = decodeURIComponent($routeParams.parameter);\n    var parameter = JSON.parse(decodeURIComponent($routeParams.parameter));\n    var modelId = parameter[0].modelId;\n    var resourceId = parameter[0].resourceId;\n\n    if (modelId) {\n      scope.instance = {};\n\n      var getManagedViewsByType_back = function getManagedViewsByType_back(event) {\n        var allAvaliableViews, defaultDviews;\n\n        if (event.code == 0) {\n          allAvaliableViews = event.data;\n\n          var getDefaultView_back = function getDefaultView_back(event) {\n            if (event.code == 0) {\n              defaultDviews = event.data;\n\n              if (event.data instanceof Array) {\n                var template;\n                var templateDefault = defaultDviews.find(function (elem) {\n                  if (elem.template) {\n                    if (elem.template.resourceId == modelId) {\n                      return true;\n                    } else {\n                      return false;\n                    }\n                  } else {\n                    return false;\n                  }\n                });\n                var templateExtent = allAvaliableViews.find(function (elem) {\n                  var viewId = elem.viewId;\n\n                  if (elem.template) {\n                    if (elem.template.resourceId == modelId) {\n                      var findRoleRes = function findRoleRes(elem) {\n                        return elem.resId == viewId && elem.resType == 21;\n                      };\n\n                      var authorized = userLoginUIService.user.roleResList.some(findRoleRes);\n                      return authorized;\n                    } else {\n                      return false;\n                    }\n                  } else {\n                    return false;\n                  }\n                });\n\n                if (templateExtent) {\n                  template = templateExtent;\n                } else if (templateDefault) {\n                  template = templateDefault;\n                }\n\n                if (template) {\n                  var getViewById_back = function getViewById_back(event) {\n                    var model, resource, content;\n\n                    if (event.code == \"0\") {\n                      var content = event.data.content;\n\n                      var getModel_back = function getModel_back(event) {\n                        if (event.code == \"0\") {\n                          model = event.data[0];\n                        }\n\n                        var getResource_back = function getResource_back(event) {\n                          if (event.code == \"0\") {\n                            resource = event.data;\n\n                            if (content != null) {\n                              var clone = JSON.parse(content);\n\n                              if (clone.hasOwnProperty('groups')) {} else {\n                                var input = {\n                                  layout: clone.data ? clone.data : clone.layout,\n                                  setting: clone.setting\n                                };\n                              }\n\n                              ;\n                              delete clone.data;\n                              var editData = new freeboardservice.replaceCiKpi(input, function () {\n                                timeout(function () {\n                                  scope.instance.setMode(true);\n                                  scope.instance.renderLayout(editData, null, scope);\n                                });\n                              }, {\n                                model: model,\n                                resource: resource\n                              });\n                            }\n                          }\n                        };\n\n                        if (resourceId) {\n                          resourceUIService.getResourceById(resourceId, getResource_back);\n                        } else {\n                          var getResources_back = function getResources_back(event) {\n                            if (event.code == 0) {\n                              scope.resources = event.data;\n                              /** console.log(scope.resources); */\n\n                              scope.resource = scope.resources[0];\n\n                              scope.itemchange = function (event) {\n                                var id = event.id.split(\"number:\")[1];\n                                var find = scope.resources.find(function (elem) {\n                                  return elem.id == id;\n                                });\n\n                                if (find) {\n                                  getResource_back({\n                                    code: 0,\n                                    data: find\n                                  });\n                                }\n                              };\n\n                              getResource_back({\n                                code: 0,\n                                data: scope.resources[0]\n                              });\n                            }\n\n                            ;\n                          };\n\n                          resourceUIService.getResources(getResources_back);\n                        }\n\n                        ;\n                      };\n\n                      resourceUIService.getModelByIds([modelId], getModel_back);\n                    }\n                  };\n\n                  viewFlexService.getViewById(template.viewId, getViewById_back);\n                } else {\n                  //http://180.76.147.159/app-freeboard/index.html#/template/model/dashboard/%7B%22modelId%22:506095638486376%7D\n                  var str = JSON.stringify({\n                    modelId: modelId\n                  });\n                  scope.error = \"没有找到相应的设备仪表板视图，点击<a href='../app-freeboard/index.html#/template/model/dashboard/\" + encodeURIComponent(str) + \"' style='cursor:pointer; text-decoration: underline;'>创建设备仪表板</a>\";\n                }\n              } else {\n                scope.error = \"视图列表为空，请联系系统管理员\";\n              }\n            } else {\n              scope.error = \"获取视图列表发生错误，请联系系统管理员\";\n            }\n          };\n\n          viewFlexService.getDefaultView(modelId, getDefaultView_back);\n        }\n      };\n\n      viewFlexService.getManagedViewsByTypeAndRole('dashboard', getManagedViewsByType_back);\n    } else {\n      scope.error = \"传入的设备模型，或者设备参数错误。请退出重新选择。\";\n    }\n\n    ;\n  }]);\n});"],"sourceRoot":"/source/"}