{"version":3,"sources":["app-editor/js/services/service.js"],"names":["define","service","optionDataHandler","lib","run","dm","rootScope","loc","route","kpi","$on","event","viewId","current","params","solutionId","groupId","modelId","pathName","path","split","getViewById","code","alert","setTimeout","window","open","locationChanges","echartVersion","factory","versionStr","setVersionString","string","getVersionString","user","setUserInfo","data","getUserInfo","kpiDataService","q","defer","getUnits","promise","getAllUnits","resolve","authService","echartVer","userInfo","$$host","$$port","login_callback","logout_callback","login","item","name","password","e","logout","back","newProf","openProf","loginChecking_login","getCurrentUser","loading","loginChecking_others","status","solutionUIService","resourceUIService","graphservice","rp","$timeout","units","smodelId","unitslist","deferred","modelAndResourceComplete","getviews","views","viewList","models","resources","ArrayHandler","i","traverse","each","model","id","findResource","findAll","viewType","push","undefined","rs","modelStructure","content","JSON","parse","elements","lack","find","indexOf","length","viewTitle","getModelByIds","getResourceByModelId","getKpisByModelId","kpis","root","getviews_callback","getKpiValueList","category","nodeslist","kpislist","timespan","callback","Array","nodes","obj","kpiQueryModel","isRealTimeData","timePeriod","nodeIds","kpiCodes","param","getKpiHierarchyValueList","result","instance","k","l","nodeId","param2","param3","ins","value","j","cilabel","label","kpilabel","kpiId","unit","timeText","td","timeData","m","time","timestamp","timeEnd","Date","getTime","unitTime","parseInt","timeStart","Math","random","date","year","getFullYear","month","getMonth","day","getDate","hour","getHours","min","getMinutes","rearrangeTimeRecordList","recordList","nodeLabel","kpiname","labelComb","rearrangeCiRecordList","error","saveData","updateView","vid","sid","gid","mid","getModel_callback","defers","index","all","then","modelshandler","parentModelId","findmodel","children","defer_a","defer_b","getModels","getResources","getOptionData","dataType","formatStr","option","dType","op","type","getAllModels"],"mappings":"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","file":"app-editor/js/services/service.js","sourcesContent":["define([\"app\", \"optionDataHandler\", \"commonlib\"], function (service, optionDataHandler, lib) {\n  service.run([\"dataManagement\", \"$rootScope\", \"$location\", \"$route\", \"kpiDataService\", function (dm, rootScope, loc, route, kpi) {\n    rootScope.$on('$locationChangeSuccess', locationChangeSuccess);\n\n    function locationChangeSuccess(event) {\n      var viewId = route.current.params.viewId;\n      var solutionId = route.current.params.solutionId;\n      var groupId = route.current.params.groupId;\n      var modelId = route.current.params.modelId;\n      var pathName = loc.path().split(\"/\")[1];\n\n      if (viewId) {\n        kpi.getViewById(viewId, function (event) {\n          if (event.code == \"10022\") {\n            alert(\"您所登录的用户，无权访问该视图\");\n            setTimeout(function () {\n              window.open(\"../../app-oc/index.html#/designView/detail\", \"_self\");\n            }, 1000);\n          } else {\n            dm.locationChanges(viewId);\n          }\n        });\n      } else {\n        dm.locationChanges(viewId, solutionId, groupId, modelId);\n      }\n\n      echartVersion = pathName == \"echart\";\n    }\n  }]);\n  service.factory(\"echartVer\", function () {\n    var factory = {};\n    var versionStr = '';\n    factory.setVersionString = setVersionString;\n    factory.getVersionString = getVersionString;\n\n    function setVersionString(string) {\n      versionStr = string;\n    }\n\n    function getVersionString() {\n      return versionStr;\n    }\n\n    return factory;\n  });\n  service.factory(\"userInfo\", function () {\n    var factory = {};\n    var user = '';\n    factory.setUserInfo = setUserInfo;\n    factory.getUserInfo = getUserInfo;\n\n    function setUserInfo(data) {\n      user = data;\n    }\n\n    function getUserInfo() {\n      return user;\n    }\n\n    return factory;\n  });\n  service.factory(\"units\", [\"kpiDataService\", \"$q\", function (kpiDataService, q) {\n    var factory = {};\n    var defer = new q.defer();\n    factory.getUnits = getUnits;\n\n    function getUnits() {\n      return defer.promise;\n    }\n\n    kpiDataService.getAllUnits(function (event) {\n      defer.resolve(event);\n    });\n    return factory;\n  }]);\n  service.factory(\"loginManagement\", [\"$rootScope\", \"authService\", \"$q\", \"$location\", \"$window\", \"echartVer\", \"$route\", \"userInfo\", function (rootScope, authService, q, loc, window, echartVer, route, userInfo) {\n    var factory = {};\n    var _HOST_ = loc.$$host;\n    var _PORT_ = loc.$$port;\n    var pathName = loc.path().split(\"/\")[1];\n    factory.login = login;\n    factory.logout = logout;\n    factory.back = back;\n    factory.newProf = newProf;\n    factory.openProf = openProf;\n    factory.loginChecking_login = loginChecking_login;\n    factory.loginChecking_others = loginChecking_others;\n\n    function login(item) {\n      var name = item.name;\n      var password = item.password;\n      authService.login(name, password, login_callback, onError);\n\n      function onError(e) {}\n    }\n\n    function logout() {\n      authService.logout(logout_callback);\n    }\n\n    function loginChecking_login() {\n      var defer = q.defer();\n      authService.getCurrentUser(checkLoginStatus, onError);\n\n      function onError(e) {}\n\n      function checkLoginStatus(data) {\n        if (data.code == \"0\") {\n          if (data.data) {\n            userInfo.setUserInfo(data.data);\n            loc.path(\"echart\");\n          } else {\n            window.open(\"../../login.html\", \"_self\");\n          }\n        } else if (data.code == \"10022\") {\n          alert(\"您所登录的用户，无权访问该视图\");\n          setTimeout(function () {\n            window.open(\"../../app-oc/index.html#/designView/detail\", \"_self\");\n          }, 1000);\n        }\n      }\n\n      rootScope.loading = \"没有登录\";\n      return defer.promise;\n    }\n\n    function loginChecking_others() {\n      var defer = q.defer();\n      echartVer.setVersionString(pathName == \"echart\" ? \"echart_v3\" : \"echart_v3\");\n      authService.getCurrentUser(checkLoginStatus);\n\n      function checkLoginStatus(data) {\n        if (data.data) {\n          userInfo.setUserInfo(data.data);\n          defer.resolve({\n            status: \"logined\",\n            data: data.data\n          });\n        } else {\n          window.open(\"../../login.html\", \"_self\");\n        }\n      }\n\n      rootScope.loading = \"载入设计器\";\n      return defer.promise;\n    }\n\n    function login_callback(data) {\n      if (data.data) {\n        loc.path(\"/echart\");\n      }\n    }\n\n    function newProf() {\n      if (loc.path() == \"/echart\") {\n        window.open(\"index.html#/new/echart\", \"_self\");\n      } else {\n        window.open(\"index.html#/echart\", \"_self\");\n      }\n    }\n\n    function openProf(viewId) {\n      window.open(\"index.html#/echart/\" + viewId, \"_self\");\n    }\n\n    function back() {\n      window.open(\"../app-oc/index.html#/designView2\", \"_self\");\n    }\n\n    function logout_callback(data) {\n      window.open(\"../../login.html\", \"_self\");\n    }\n\n    return factory;\n  }]);\n  service.factory(\"dataManagement\", [\"$rootScope\", 'solutionUIService', 'resourceUIService', \"authService\", \"graphservice\", \"kpiDataService\", \"$routeParams\", \"$q\", \"$location\", \"echartVer\", \"$timeout\", \"units\", function (rootScope, solutionUIService, resourceUIService, authService, graphservice, kpi, rp, q, loc, echartVer, $timeout, units) {\n    var factory = {},\n        solutionId,\n        groupId,\n        smodelId;\n    var viewId;\n    var unitslist;\n    var pathName = loc.path().split(\"/\")[1];\n    var deferred = q.defer();\n    echartVer.setVersionString(pathName == \"echart\" ? \"echart_v3\" : \"echart_v3\");\n    factory.saveData = saveData;\n    factory.updateView = updateView;\n    factory.getKpiValueList = getKpiValueList;\n    factory.locationChanges = locationChanges;\n    factory.getOptionData = getOptionData;\n    factory.getAllModels = getAllModels;\n    units.getUnits().then(function success(event) {\n      unitslist = event.data;\n    }, function error() {});\n\n    function getAllModels() {\n      return deferred.promise;\n    }\n\n    function getOptionData(dataType, category, formatStr, option, nodeslist, kpislist, timespan, callback) {\n      var cat = category == \"time\" ? \"time\" : \"ci\";\n      var dType = dataType;\n      var op = option;\n      getKpiValueList(category, nodeslist, kpislist, timespan, getKpiValueList_callback);\n\n      function getKpiValueList_callback(event) {\n        if (event.status == 'success') {\n          var result = optionDataHandler(dType.type, dType.category[category], formatStr, event, op, unitslist);\n        } else {\n          var result = \"获取数据错误\";\n        }\n\n        callback(result, event.data);\n      }\n    }\n\n    function locationChanges(vid, sid, gid, mid) {\n      $timeout(function () {\n        solutionId = sid;\n        groupId = gid;\n        viewId = vid;\n        smodelId = mid;\n        defer_a = q.defer();\n        defer_b = q.defer();\n\n        if (mid != 0 && mid != undefined) {\n          resourceUIService.getModelByIds([mid], getModel_callback);\n        } else if (gid != 0 && gid != undefined) {\n          resourceUIService.getModelByIds([gid], getModel_callback);\n        } else {\n          graphservice.getModels(getModel_callback);\n        }\n\n        graphservice.getResources(getResources_callback);\n        q.all([defer_a.promise, defer_b.promise]).then(modelAndResourceComplete, error);\n\n        function getModel_callback(event) {\n          var models = new lib.ArrayHandler(event.data);\n          var defers = [];\n          var promise = [];\n          var i;\n\n          for (i in models.data) {\n            defers[i] = q.defer();\n\n            (function (modelId, index) {\n              graphservice.getKpisByModelId(modelId, function (data) {\n                models.data[index].kpis = new lib.ArrayHandler(data.data);\n                defers[index].resolve(data);\n              });\n            })(models.data[i].id, i);\n          }\n\n          ;\n\n          for (var k in defers) {\n            promise.push(defers[k].promise);\n          }\n\n          q.all(promise).then(function success(data) {\n            var root = new lib.ArrayHandler([]);\n            var modelshandler = new lib.ArrayHandler(models.data);\n            modelshandler.each(function (model) {\n              var parentModelId = model.parentModelId;\n\n              if (parentModelId) {\n                var findmodel = modelshandler.find(\"id\", parentModelId);\n\n                if (findmodel) {\n                  if (findmodel.children) {\n                    findmodel.children.push(model);\n                  } else {\n                    findmodel.children = new lib.ArrayHandler([model]);\n                  }\n                } else {\n                  root.push(model);\n                }\n              } else {\n                root.push(model);\n              }\n            });\n            defer_a.resolve({\n              root: root,\n              traverse: models\n            });\n            /* before 2016.3.15\n            defer_a.resolve(models);\n            */\n          }, function error(data) {});\n        }\n\n        function getResources_callback(data) {\n          defer_b.resolve(data);\n        }\n      });\n    }\n\n    ;\n\n    function modelAndResourceComplete(data) {\n      kpi.getviews(function (event) {\n        var views = event.data;\n        getviews_callback(data, views);\n      });\n    }\n\n    function getviews_callback(data, views) {\n      var viewList = [];\n      var models = data[0];\n      /* before 2016.3.15\n      var models = data[0].data;\n      */\n\n      var resources = new lib.ArrayHandler(data[1].data);\n      models.traverse.each(function (model) {\n        modelId = model.id;\n        var findResource = resources.findAll(\"modelId\", modelId);\n\n        if (findResource) {\n          model.resources = new lib.ArrayHandler(findResource);\n        }\n      });\n      /* before 2016.3.15\n      var models = (function(md, resources){\n      \tfor(var i in md)\n      \t{\n      \t\tvar mid = md[i].id;\n      \t\tvar find = (function(mid){\n      \t\t\tvar rs = [];\n      \t\t\tfor(var j in resources){\n      \t\t\t\tif(resources[j].modelId == mid)\n      \t\t\t\t{\n      \t\t\t\t\trs.push({\n      \t\t\t\t\t\tcreateTime : resources[j].createTime,\n      \t\t\t\t\t\tid : resources[j].id,\n      \t\t\t\t\t\tlabel : resources[j].label,\n      \t\t\t\t\t});\n      \t\t\t\t}\n      \t\t\t}\n      \t\t\treturn rs;\n      \t\t})(mid);\n      \t\tif(find.length)\n      \t\t{\n      \t\t\tmd[i].resources = find;\n      \t\t}\n      \t}\n      \treturn md;\n      })(data[0].data, data[1].data);\n      var rs = models ? models : {};\n      */\n\n      for (var i in views) {\n        if (views[i]) {\n          if (views[i].viewType == \"designView\") {\n            viewList.push(views[i]);\n          }\n        }\n      }\n\n      if (viewId == undefined) {\n        /* before 2016.3.15\n        var rs = {\n        \tviews : viewList,\n        \tmodelStructure : JSON.parse(JSON.stringify(rs))\n        };\n        */\n        var rs = {\n          solutionId: solutionId,\n          groupId: groupId,\n          smodelId: smodelId,\n          views: viewList,\n          modelStructure: models\n        };\n        /* before 2016.3.15\n        rootScope.$broadcast(\"modelAndResourceComplete\", rs);\n         */\n\n        deferred.resolve(rs);\n      } else {\n        /* before 2016.3.15\n        getViewGraph(viewId, JSON.parse(JSON.stringify(rs)), viewList);\n         */\n        getViewGraph(viewId, models, viewList);\n      }\n    }\n\n    function getViewGraph(viewId, models, views) {\n      kpi.getViewById(viewId, getViewById_callback);\n\n      function getViewById_callback(data) {\n        var content = JSON.parse(data.data.content).elements;\n        var lack = [];\n\n        for (var i in content) {\n          var find = models.traverse.find(\"id\", content[i].modelId);\n\n          if (!find) {\n            if (content[i].modelId) {\n              if (lack.indexOf(content[i].modelId) == -1) {\n                lack.push(content[i].modelId);\n              }\n            }\n          }\n        }\n\n        if (lack.length == 0) {\n          deferred.resolve({\n            viewId: viewId,\n            views: views,\n            viewTitle: data.data.viewTitle,\n            modelStructure: models,\n            viewList: content\n          });\n        } else {\n          resourceUIService.getModelByIds(lack, function (event) {\n            if (event.code) {\n              var model = event.data[0];\n              resourceUIService.getResourceByModelId(model.id, function (event) {\n                model.resources = new lib.ArrayHandler(event.data);\n                resourceUIService.getKpisByModelId(model.id, function (event) {\n                  model.kpis = new lib.ArrayHandler(event.data);\n                  models.root.push(model);\n                  deferred.resolve({\n                    viewId: viewId,\n                    views: views,\n                    viewTitle: data.data.viewTitle,\n                    modelStructure: models,\n                    viewList: content\n                  });\n                });\n              });\n            }\n          });\n        }\n        /* before 2016.3.15\n        rootScope.$broadcast(\"modelAndResourceComplete\", {\n        \tviewId : viewId,\n        \tviews : views,\n        \tviewTitle : data.data.viewTitle,\n        \tmodelStructure : models,\n        \tviewList : content\n        });\n         */\n\n      }\n    }\n\n    function getKpiValueList(category, nodeslist, kpislist, timespan, callback) {\n      if (nodeslist instanceof Array) {}\n\n      var nodes = function (obj) {\n        var rs = [];\n\n        for (var i in obj) {\n          rs.push(obj[i].id);\n        }\n\n        return rs;\n      }(nodeslist);\n\n      var kpis = function (obj) {\n        var rs = [];\n\n        for (var i in obj) {\n          rs.push(obj[i].id);\n        }\n\n        return rs;\n      }(kpislist);\n\n      if (category == 'time') {\n        var kpiQueryModel = {\n          category: category,\n          isRealTimeData: true,\n          timePeriod: timespan,\n          nodeIds: nodes,\n          kpiCodes: kpis\n        };\n      } else if (category == 'ci') {\n        var kpiQueryModel = {\n          category: category,\n          isRealTimeData: true,\n          nodeIds: nodes,\n          kpiCodes: kpis\n        };\n      }\n\n      var param = [\"kpi\", kpiQueryModel];\n      kpi.getKpiHierarchyValueList(param, getKpiHierarchyValueList_callback);\n\n      function getKpiHierarchyValueList_callback(event) {\n        if (event.code == \"0\") {\n          var result;\n\n          if (category == \"time\") {\n            result = rearrangeTimeRecordList(event.data.recordList);\n          } else if (category == \"ci\") {\n            result = rearrangeCiRecordList(event.data.recordList);\n          }\n\n          callback({\n            status: 'success',\n            kpis: kpis,\n            nodes: nodes,\n            category: category,\n            data: result\n          });\n        } else {\n          callback({\n            status: 'failure'\n          });\n        }\n      }\n\n      ;\n\n      function rearrangeCiRecordList(obj) {\n        var result = [];\n\n        for (var i in nodeslist) {\n          for (var j in kpislist) {\n            result.push({\n              cilabel: nodeslist[i].label,\n              kpilabel: kpislist[j].label,\n              nodeLabel: nodeslist[i].label,\n              label: nodeslist[i].label + \"-\" + kpislist[j].label,\n              name: kpislist[j].name,\n              nodeId: nodeslist[i].nodeId,\n              kpiId: kpislist[j].kpiId,\n              unit: kpislist[j].units\n            });\n          }\n        }\n\n        for (var i in obj) {\n          var item = obj[i];\n          var name = item.category;\n\n          for (var l in item) {\n            if (l != \"category\") {\n              var kpiname = l;\n              var value = item[l];\n\n              for (var m in result) {\n                var labelComb = result[m].nodeLabel;\n\n                if (labelComb == name && kpiname == result[m].name) {\n                  result[m].value = value;\n                }\n              }\n            }\n          }\n        }\n\n        return result;\n      }\n\n      ;\n\n      function rearrangeTimeRecordList(obj) {\n        var result = [];\n        var instance = {};\n\n        if (obj.length > 0) {\n          for (var k in obj) {\n            var item = obj[k];\n\n            for (var l in item) {\n              if (l != \"category\") {\n                var nodeId = l.split(\"-\")[0];\n                var param2 = l.split(\"-\")[1];\n                var param3 = l.split(\"-\")[2];\n\n                if (param3) {\n                  var name = param3;\n                  var ins = param2;\n\n                  if (!instance[nodeId]) {\n                    instance[nodeId] = [];\n                  }\n\n                  var find = function (data, value) {\n                    for (var i in data) {\n                      if (value == data[i]) {\n                        return true;\n                      }\n                    }\n\n                    return false;\n                  }(instance[nodeId], ins);\n\n                  if (!find) {\n                    instance[nodeId].push(ins);\n                  }\n                }\n              }\n            }\n          }\n        }\n\n        if (nodeslist) {\n          for (var i in nodeslist) {\n            for (var j in kpislist) {\n              if (instance[nodeslist[i].id]) {\n                for (var k in instance[nodeslist[i].id]) {\n                  result.push({\n                    cilabel: nodeslist[i].label,\n                    kpilabel: kpislist[j].label,\n                    label: nodeslist[i].label + \"-\" + instance[nodeslist[i].nodeId][k] + \"-\" + kpislist[j].label,\n                    name: kpislist[j].name,\n                    nodeId: nodeslist[i].id,\n                    instance: instance[nodeslist[i].id][k],\n                    kpiId: kpislist[j].id,\n                    unit: kpislist[j].unit,\n                    data: []\n                  });\n                }\n              } else {\n                result.push({\n                  cilabel: nodeslist[i].label,\n                  kpilabel: kpislist[j].label,\n                  label: nodeslist[i].label + \"-\" + kpislist[j].label,\n                  name: kpislist[j].name,\n                  nodeId: nodeslist[i].id,\n                  kpiId: kpislist[j].id,\n                  unit: kpislist[j].unit,\n                  data: []\n                });\n              }\n            }\n          }\n        } else {\n          for (var i in kpislist) {\n            result.push({\n              cilabel: '模拟数据',\n              kpilabel: kpislist[i].label,\n              label: kpislist[i].label + \"(模拟数据)\",\n              name: kpislist[i].name,\n              nodeId: 0,\n              kpiId: kpislist[i].id,\n              unit: kpislist[i].unit,\n              data: []\n            });\n          }\n        }\n\n        if (nodeslist) {\n          for (var k in obj) {\n            var item = obj[k];\n            var timeText = item.category;\n            var td = timeData(timeText);\n\n            for (var l in item) {\n              if (l != \"category\") {\n                var nodeId = l.split(\"-\")[0];\n                var param2 = l.split(\"-\")[1];\n                var param3 = l.split(\"-\")[2];\n                var ins;\n                var name;\n\n                if (param3) {\n                  name = param3;\n                  ins = param2;\n                } else {\n                  name = param2;\n                }\n\n                var value = item[l];\n\n                for (var m in result) {\n                  if (result[m].nodeId == nodeId && result[m].name == name && result[m].instance == ins) {\n                    result[m].data.push({\n                      value: value,\n                      time: td.time,\n                      timestamp: td.timestamp\n                    });\n                  }\n                }\n              }\n            }\n          }\n        } else {\n          var timeEnd = new Date().getTime();\n          var unitTime = parseInt(timespan / 10);\n          var timeStart = timeEnd - timespan;\n          var k = [];\n\n          if (unitTime != 0) {\n            for (var i = timeStart; i <= timeEnd; i += unitTime) {\n              if (result[0]) {\n                result[0].data.push({\n                  value: parseInt(Math.random() * 100),\n                  time: timeData(i).time,\n                  timestamp: i\n                });\n              }\n            }\n          }\n        }\n\n        function timeData(label) {\n          var date = new Date(label);\n          var time;\n          var year = date.getFullYear();\n          var month = date.getMonth() + 1;\n          var day = date.getDate();\n          var hour = date.getHours();\n          var min = date.getMinutes();\n          time = year + \"/\" + month + \"/\" + day + \" \" + hour + \":\" + min;\n          timestamp = Date.parse(new Date(time));\n          return {\n            time: time,\n            timestamp: date.getTime()\n          };\n        }\n\n        return result;\n      }\n    }\n\n    function saveData(data, callback) {\n      kpi.saveData(data, callback);\n    }\n\n    function updateView(viewId, data, callback) {\n      kpi.updateView(viewId, data, callback);\n    }\n\n    function error(data) {}\n\n    return factory;\n  }]);\n});"],"sourceRoot":"/source/"}