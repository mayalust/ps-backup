{"version":3,"sources":["solution/customview/homepage/deviceDetail.js"],"names":["_typeof","obj","Symbol","iterator","constructor","prototype","define","on","init","event","complete","df","deviceDetail","target","isNotUndefined","d","sensorMap","a","b","name","getDataItemId","dataItem","dataItemId","bind","fn","apply","arguments","getNumber","str","match","exec","prop","cell","attr","val","item","attrs","split","filter","rs","shift","last","pop","DeviceDetail","this","hookToView","cells","next","forEach","handleEachCell","num","nodeId","kpiId","modelId","resource","ext","sensors","kpis","sort","k1","kpisMap","k2","serial","i","map","children","id","callback","getView","json","hooks","tap","render","$on","loadCiKpiComplete","is","createCurrentStatus","label","x","y","getAlertState","clear","value","setAlarmStatus","destroy","call","getBrothers","brothers","fd","find","v","$attr","viewId","getViewById","view","JSON","parse","e","content","getChildren","then","getMeasureLocate","sensor","n","l","getDataItemsByModelIdFromCache","reduce","getDomainAreaLineTree_alertStatus"],"mappings":"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","file":"solution/customview/homepage/deviceDetail.js","sourcesContent":["function _typeof(obj) { if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; }; } return _typeof(obj); }\n\ndefine({\n  \"on\": {\n    \"init\": function init(event, complete, df) {\n      var target = event.target,\n          kpisMap = {},\n          deviceDetail;\n\n      function parse(str) {\n        var a;\n\n        try {\n          a = JSON.parse(str);\n        } catch (e) {\n          return;\n        }\n\n        return a;\n      }\n\n      function isNotUndefined(d) {\n        return typeof d !== \"undefined\";\n      }\n\n      function sensorMap(a, b) {\n        a[b.name] = b;\n        return a;\n      }\n\n      function childrenMap(a, b) {\n        a[b.id] = b;\n        return a;\n      }\n\n      function getDataItemId(dataItem) {\n        return dataItem.dataItemId;\n      }\n\n      function bind(target, fn) {\n        return function () {\n          return fn.apply(target, arguments);\n        };\n      }\n\n      function lessThan(num) {\n        return function (d, i) {\n          return i < num;\n        };\n      }\n\n      function getNumber(str) {\n        var match = /(?:.*\\:)*([^\\:]*)/.exec(str);\n\n        if (typeof str == \"string\" || typeof str == \"number\") {\n          return match ? match[1] - 0 : str;\n        }\n      }\n\n      function getString(str) {\n        var match = /(?:.*\\:)*([^\\:]*)/.exec(str);\n\n        if (typeof str == \"string\" || typeof str == \"number\") {\n          return match ? match[1] : str;\n        }\n      }\n\n      function prop(cell, attr, val) {\n        var attrs = attr.split(\"/\").filter(isNotUndefined),\n            item;\n\n        if (typeof val === \"undefined\") {\n          rs = cell;\n\n          while ((item = attrs.shift()) && rs) {\n            rs = rs[item];\n          }\n\n          return rs;\n        }\n\n        var last = attrs.pop(),\n            rs = cell;\n\n        while ((item = attrs.shift()) && rs) {\n          rs = rs[item];\n        }\n\n        if (_typeof(rs) === \"object\") {\n          rs[last] = val;\n        }\n      }\n\n      function attr(cell, attr, val) {\n        var attrs = attr.split(\"/\").filter(isNotUndefined),\n            item;\n\n        if (typeof val === \"undefined\") {\n          rs = cell.attrs;\n\n          while ((item = attrs.shift()) && rs) {\n            rs = rs[item];\n          }\n\n          return rs;\n        }\n\n        var last = attrs.pop(),\n            rs = cell.attrs;\n\n        while ((item = attrs.shift()) && rs) {\n          rs = rs[item];\n        }\n\n        if (_typeof(rs) === \"object\") {\n          rs[last] = val;\n        }\n      }\n\n      function DeviceDetail() {\n        this.hookToView(bind(this, function (cells, next) {\n          cells.forEach(bind(this, this.handleEachCell));\n          next(cells);\n        }));\n      }\n\n      DeviceDetail.prototype.handleEachCell = function (cell) {\n        var name = attr(cell, \"text/text\"),\n            nodeId = getNumber(prop(cell, \"nodeId\")),\n            kpiId = getNumber(prop(cell, \"kpiId\")),\n            modelId = this.resource.modelId,\n            ext = prop(cell, \"extend\");\n        attr(cell, \"rect/visibility\", \"hidden\");\n        attr(cell, \"circle/visibility\", \"hidden\");\n        attr(cell, \"text/visibility\", \"hidden\");\n        attr(cell, \".connection/stroke\", \"#1f8fd8\");\n        attr(cell, \".connection/stroke-width\", 2);\n        attr(cell, \".marker-target/visibility\", \"hidden\");\n\n        if (ext) {\n          if (ext == \"kpis\" && modelId > 1000) {\n            prop(cell, \"currentdevice\", 1);\n          }\n\n          return;\n        }\n\n        if (typeof this.sensors[name] !== \"undefined\") {\n          this.sensors[name].kpis.sort(function (a, b) {\n            var k1 = this.kpisMap[modelId][a.dataItemId] || {},\n                k2 = this.kpisMap[modelId][b.dataItemId] || {},\n                s1 = k1.serial || 0,\n                s2 = k2.serial || 0;\n            return s1 - s2;\n          });\n          prop(cell, \"extend\", \"kpis\");\n          prop(cell, \"sensor\", name);\n          prop(cell, \"currentdevice\", 1);\n          prop(cell, \"dataItem\", this.sensors[name].kpis.filter(lessThan(4)).map(getDataItemId));\n          return;\n        }\n\n        if (nodeId) {\n          if (typeof this.children[nodeId] !== \"undefined\") {\n            prop(cell, \"extend\", \"alert\");\n          } else {\n            prop(cell, \"sensor\", \"00\");\n            prop(cell, \"extend\", \"dataItem\");\n            prop(cell, \"nodeId\", \"number:\" + this.resource.id);\n            prop(cell, \"currentdevice\", 1);\n            prop(cell, \"dataItem\", [kpiId]);\n          }\n\n          return;\n        }\n      };\n\n      DeviceDetail.prototype.hookToView = function (callback) {\n        this.getView(bind(this, function (json) {\n          target.hooks.tap(\"viewloaded\", callback);\n          target.render(json);\n          target.$on(\"$loadCiKpiComplete\", bind(this, this.loadCiKpiComplete));\n        }));\n      };\n\n      DeviceDetail.prototype.loadCiKpiComplete = function (cells) {\n        var position = {\n          x: 290,\n          y: 0\n        },\n            is = target.createCurrentStatus(this.resource.label, position, this.resource.getAlertState());\n        this.clear = this.resource.$on(\"alertStateChange\", function (value) {\n          is.setAlarmStatus(value);\n        });\n      };\n\n      DeviceDetail.prototype.destroy = function () {\n        this.clear && this.clear.call(this);\n      };\n\n      DeviceDetail.prototype.getView = function (callback) {\n        this.getBrothers(bind(this, function (brothers) {\n          var fd = brothers.find(function (v) {\n            return v.$attr(\"values/view/viewId\");\n          }) || {},\n              viewId = this.resource.$attr(\"view/viewId\") || this.resource.$attr(\"values/view/viewId\") || fd.$attr(\"values/view/viewId\");\n          target.getViewById(viewId, function (view) {\n            callback(parse(view.content));\n          });\n        }));\n      };\n\n      DeviceDetail.prototype.getBrothers = function (callback) {\n        this.getChildren(bind(this, function (children) {\n          this.resource.getBrothers().then(bind(this, function (brothers) {\n            this.brothers = brothers;\n            callback(brothers);\n          }));\n        }));\n      };\n\n      DeviceDetail.prototype.getChildren = function (callback) {\n        this.getMeasureLocate(bind(this, function (sensor) {\n          this.resource.getChildren(function (n, i, l) {\n            return true;\n          }).then(bind(this, function (children) {\n            this.children = children;\n            callback(children);\n          }));\n        }));\n      };\n\n      DeviceDetail.prototype.getMeasureLocate = function (callback) {\n        this.getDataItemsByModelIdFromCache(bind(this, function (kpisMap) {\n          this.resource.getMeasureLocate().then(bind(this, function (sensors) {\n            this.sensors = sensors.reduce(sensorMap, {});\n            callback(sensors);\n          }));\n        }));\n      };\n\n      DeviceDetail.prototype.getDataItemsByModelIdFromCache = function (callback) {\n        this.getDomainAreaLineTree_alertStatus(function (resource) {\n          target.getDataItemsByModelIdFromCache(resource.modelId, function (kpisMap) {\n            this.kpisMap = kpisMap;\n            callback(kpisMap);\n          });\n        });\n      };\n\n      DeviceDetail.prototype.getDomainAreaLineTree_alertStatus = function (callback) {\n        target.getDomainAreaLineTree_alertStatus(bind(this, function (resource) {\n          this.resource = resource;\n          callback(resource);\n        }));\n      };\n\n      deviceDetail = new DeviceDetail();\n      target.on(\"$destroy\", function () {\n        deviceDetail.destroy();\n      });\n    }\n  }\n});"],"sourceRoot":"/source/"}