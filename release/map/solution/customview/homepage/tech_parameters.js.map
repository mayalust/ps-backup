{"version":3,"sources":["solution/customview/homepage/tech_parameters.js"],"names":["define","on","init","event","complete","df","target","bind","fn","apply","arguments","getIndex","obj","inx","n","i","toNumber","d","TechParameters","this","valueListMap","getKpiValueList","setWebSocket","createCell","value","type","composory","style","white-space","borderBottom","height","class","setEachGroup","item","val","unit","kpiName","dateHandler","arisingTime","getDateString","map","prototype","getDomainAreaLineTree_alertStatus","callback","resource","call","getAttrsByResource","attrs","attributes","getMeasureLocate","then","sensors","sensor","find","label","trim","dataItems","kpis","dataItemsMap","reduce","a","b","dataItemId","getKpis","getKpisByModelId","modelId","forEach","kpi","id","handValueList","valueList","Array","kpiCode","render","ctrlGroups","list","Object","values","push","tableIns","refresh","data","tds","getElementsByTagName","spa1","spa2","innerText","webSocket","time","timer","keys","_this","nodeId","instance","setTimeout","getKpiValueCi","isRealTimeData","includeInstance"],"mappings":"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","file":"solution/customview/homepage/tech_parameters.js","sourcesContent":["define({\n  on: {\n    init: function init(event, complete, df) {\n      var target = event.target,\n          techParameters;\n\n      function bind(target, fn) {\n        return function () {\n          return fn.apply(target, arguments);\n        };\n      }\n\n      function getIndex(obj, inx) {\n        var n = 0;\n\n        for (var i in obj) {\n          if (inx == i) {\n            return n;\n          }\n\n          n++;\n        }\n      }\n\n      function toNumber(d) {\n        return d - 0;\n      }\n\n      function throttle(fn, time) {\n        var timer,\n            obj = {};\n        return function (data) {\n          var _this = this;\n\n          var nodeId = data.nodeId,\n              kpiCode = data.kpiCode,\n              instance = data.instance || \"_\";\n\n          if (timer == null) {\n            timer = setTimeout(function () {\n              fn.call(_this, obj);\n              timer = null;\n            }, time);\n          } else {\n            obj[kpiCode] = data;\n          }\n        };\n      }\n\n      function TechParameters() {\n        this.valueListMap = {};\n        this.getKpiValueList(bind(this, function () {\n          this.setWebSocket();\n        }));\n      }\n\n      function createCell(value) {\n        return {\n          type: \"label\",\n          value: value,\n          composory: \"none\",\n          style: {\n            \"white-space\": \"pre-wrap\",\n            borderBottom: \"1px solid #666666\",\n            height: \"41px\"\n          },\n          class: \"col-xs-4\"\n        };\n      }\n\n      function initCtrlGroup() {\n        var arr = [\"名称\", \"数值\", \"更新时间\"].map(function (item) {\n          return createCell(item);\n        });\n        return [arr];\n      }\n\n      function setEachGroup(item) {\n        var val = item[\"_value\"] == null ? \"-\" : item[\"_value\"],\n            unit = item.unit && item.unit != \"NA\" ? item.unit : \"\",\n            arr;\n        val = val + unit;\n        arr = [item.kpiName, val, target.dateHandler(item.arisingTime).getDateString(\"yy/MM/dd hh:mm:ss\")].map(function (item) {\n          return createCell(item);\n        });\n        return arr;\n      }\n\n      TechParameters.prototype.getDomainAreaLineTree_alertStatus = function (callback) {\n        target.getDomainAreaLineTree_alertStatus(bind(this, function (resource) {\n          this.resource = resource;\n          callback && callback.call(this, resource);\n        }));\n      };\n\n      TechParameters.prototype.getAttrsByResource = function (callback) {\n        this.getDomainAreaLineTree_alertStatus(bind(this, function (resource) {\n          target.getAttrsByResource(resource, bind(this, function (attrs) {\n            this.attributes = attrs;\n            callback && callback.call(this, attrs);\n          }));\n        }));\n      };\n\n      TechParameters.prototype.getMeasureLocate = function (callback) {\n        this.getAttrsByResource(bind(this, function (attrs) {\n          this.resource.getMeasureLocate().then(bind(this, function (sensors) {\n            var sensor = sensors.find(function (sensor) {\n              return sensor.label.trim() == \"整体\";\n            }),\n                dataItems = sensor ? sensor.kpis : [],\n                inx = 0;\n            this.dataItemsMap = dataItems.reduce(function (a, b) {\n              a[b.dataItemId] = b;\n              inx++;\n              return a;\n            }, {});\n            callback && callback.call(this, this.dataItemsMap);\n          }));\n        }));\n      };\n\n      TechParameters.prototype.getKpis = function (callback) {\n        this.getMeasureLocate(bind(this, function (dataItemsMap) {\n          target.getKpisByModelId(this.resource.modelId, function (kpis) {\n            kpis.forEach(function (kpi) {\n              dataItemsMap[kpi.id] ? dataItemsMap[kpi.id].unit = kpi.unit : null;\n            });\n            callback && callback.call(this, dataItemsMap);\n          });\n        }));\n      };\n\n      TechParameters.prototype.handValueList = function (valueList) {\n        if (valueList instanceof Array) {\n          valueList.forEach(bind(this, function (b) {\n            this.dataItemsMap[b.kpiCode][\"_value\"] = b.value;\n            this.dataItemsMap[b.kpiCode][\"arisingTime\"] = b.arisingTime;\n          }));\n        } else {\n          for (var i in valueList) {\n            this.dataItemsMap[i][\"_value\"] = valueList[i].value;\n            this.dataItemsMap[i].arisingTime = valueList[i].arisingTime;\n          }\n        }\n      };\n\n      TechParameters.prototype.render = function () {\n        var ctrlGroups = initCtrlGroup(),\n            list = Object.values(this.dataItemsMap);\n        [].push.apply(ctrlGroups, list.map(setEachGroup));\n        this.tableIns = target.render(ctrlGroups);\n      };\n\n      TechParameters.prototype.refresh = function (data) {\n        if (!this.tableIns) {\n          return;\n        }\n\n        for (var i in data) {\n          bind(this, function (i, val) {\n            var inx = getIndex(this.dataItemsMap, i),\n                item = this.dataItemsMap[i],\n                value = val.value == null ? \"-\" : val.value,\n                unit = item.unit && item.unit != \"NA\" ? item.unit : \"\",\n                trs = this.tableIns.find(\"tr\"),\n                tr = trs[inx + 1],\n                tds = tr.getElementsByTagName(\"td\"),\n                spa1 = tds[1].getElementsByTagName(\"span\")[2],\n                spa2 = tds[2].getElementsByTagName(\"span\")[2];\n            spa1.innerText = value + unit;\n            spa2.innerText = target.dateHandler(val.arisingTime).getDateString(\"yy/MM/dd hh:mm:ss\");\n          })(i, data[i]);\n        }\n      };\n\n      TechParameters.prototype.webSocket = function (callback) {\n        target.webSocket(this.resource.id, Object.keys(this.dataItemsMap), bind(this, throttle(callback, 3000)), \"instance_parameter\");\n      };\n\n      TechParameters.prototype.setWebSocket = function () {\n        this.webSocket(bind(this, function (data) {\n          this.refresh(data);\n        }));\n      };\n\n      TechParameters.prototype.getKpiValueList = function (callback) {\n        this.getKpis(bind(this, function (dataItemsMap) {\n          target.getKpiValueCi([this.resource.id], Object.keys(dataItemsMap).map(toNumber), bind(this, function (valueList) {\n            this.handValueList(valueList);\n            this.render();\n            callback();\n          }), {\n            isRealTimeData: true,\n            includeInstance: true\n          });\n        }));\n      };\n\n      techParameters = new TechParameters();\n      target.on(\"$destroy\", function (d) {});\n    }\n  }\n});"],"sourceRoot":"/source/"}