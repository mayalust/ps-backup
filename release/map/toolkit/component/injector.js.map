{"version":3,"sources":["toolkit/component/injector.js"],"names":["define","data","undefined","Error","q","scope","element","constructor","previewMode","coldomInner","viewFlexService","traverseColumn","traverseRow","cov","rowDom","customMethodService","style","$","compile","css","expression","wrap","addClass","$$","runExpression","$attr","expFn","code","initFn","renderJSON","json","children","showloading","renderCtrl","ctrlname","innerHTML","window","_newScope","$destroy","createRenderCtrl","then","dom","$new","appendChild","$on","render","a","runtime","defers","layout","groups","$remapByChild","traveseByChild","defer","renderAttr","getCiKpi","ci","kpi","resource","resolve","source","viewId","cacheAsyncData","call","getViewById","event","JSON","parse","content","push","promise","viewTitle","all","traverse","root","Object","defineProperty","enumerable","promises","remove","setTimeout","trigger","target","e","runExpressionSuccess"],"mappings":"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","file":"toolkit/component/injector.js","sourcesContent":["/**\n * Created by leonlin on 16/11/3.\n */\ndefine(function () {\n  return function (data) {\n    if (data == undefined) {\n      throw new Error(\"undefined\");\n    }\n\n    var q = data.q;\n    var scope = data.scope;\n    var element = data.element;\n    var constructor = element.constructor;\n    var coldomInner = data.coldomInner;\n    var previewMode = data.previewMode;\n    var traverseColumn = data.traverseColumn;\n    var viewFlexService = data.viewFlexService;\n    var traverseRow = data.traverseRow;\n    var rowDom = data.rowDom;\n    var customMethodService = data.customMethodService;\n    var style = element.style;\n    var cov = $(\"<div></div>\");\n    var scope = data.scope;\n    var compile = data.compile;\n    cov.css(\"width\", \"100%\");\n    cov.css(\"height\", \"100%\");\n    cov.css(\"background-color\", \"rgba(250,250,250,.5)\");\n    var wrap = $(\"<div></div>\");\n    wrap.addClass(\"ww\"); //wrap.css(style);\n\n    if (!previewMode) {\n      wrap.css(\"opacity\", \".1\");\n      wrap.css(\"pointer-events\", \"none\");\n      wrap.css(\"background-color\", \"#eee\");\n    }\n\n    var expression;\n    $$.runExpression(element.$attr(\"advance/expression\"), function (expFn) {\n      if (expFn.code == 0) {\n        expression = expFn.data;\n      }\n\n      runExpressionSuccess(expression);\n    }, element);\n\n    function runExpressionSuccess(expression) {\n      expression = expression ? expression : {};\n      var initFn = expression.$attr(\"on/init\");\n\n      element.renderJSON = function (json) {\n        traverseRow(wrap, json.children, true);\n      };\n\n      element.showloading = function () {};\n\n      element.renderCtrl = function (ctrlname) {\n        wrap.innerHTML = \"\";\n        window._newScope ? window._newScope.$destroy() : null;\n        element.createRenderCtrl(ctrlname).then(function (dom) {\n          window._newScope = scope.$new();\n          wrap[0].appendChild(dom);\n          compile(wrap)(window._newScope);\n\n          window._newScope.$on(\"$destroy\", function () {\n            ;\n          });\n        });\n      };\n\n      element.render = function (json, a) {\n        runtime(\"开始加载视图\");\n        var defers = [];\n\n        if (json.layout == undefined) {\n          json.layout = json.groups[0].layout;\n        }\n\n        json.layout = json.layout.$remapByChild(function (element) {\n          var rs = new constructor(element);\n          return rs;\n        });\n        element.children = json.layout.children;\n        element.traveseByChild(function (element) {\n          var defer = q.defer();\n\n          var renderAttr = function renderAttr() {\n            if (element.data) {\n              element.getCiKpi(function (ci, kpi) {\n                if (element.data) {\n                  element.data.resource = ci;\n                  element.data.kpi = kpi;\n                }\n\n                ;\n                defer.resolve(\"success\");\n              });\n            } else {\n              defer.resolve(\"success\");\n            }\n\n            ;\n          };\n\n          if (element.source) {\n            var source = element.source;\n\n            if (source == \"TOPO\") {\n              var viewId = element.viewId;\n              $$.cacheAsyncData.call(viewFlexService.getViewById, [viewId], function (event) {\n                if (event.code == 0 && event.data != null) {\n                  var json = JSON.parse(event.data.content);\n                  element.JSON = json;\n                }\n\n                renderAttr();\n              });\n            } else {\n              renderAttr();\n            }\n          } else {\n            renderAttr();\n          }\n\n          defers.push(defer.promise);\n        });\n        runtime(\"完成加载视图\" + json.viewTitle);\n        q.all(defers).then(function () {\n          json.layout.traverse(function () {});\n          json.layout.root = json;\n          Object.defineProperty(json.layout, \"root\", {\n            enumerable: false\n          });\n          traverseRow.promises = [];\n          wrap.children().remove();\n          var promises = traverseRow(wrap, json.layout.children, true);\n          setTimeout(function () {\n            element.trigger(\"graphicLoaded\");\n          }, 5000);\n          /**\n           q.all(promises).then(function(p){\n          console.info(\"graphicLoaded\");\n          element.trigger(\"graphicLoaded\")\n          });*/\n        });\n      };\n\n      if (initFn) {\n        try {\n          initFn({\n            target: element\n          });\n        } catch (e) {\n          ;\n        } finally {}\n      }\n    }\n\n    return wrap;\n  };\n});"],"sourceRoot":"/source/"}