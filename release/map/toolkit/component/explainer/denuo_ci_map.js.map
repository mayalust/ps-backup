{"version":3,"sources":["toolkit/component/explainer/denuo_ci_map.js"],"names":["define","data","tools","callback","nodesDes","kpisDes","q","resourceUIService","start","map","BMap","Map","localSearch","LocalSearch","instances","reduce","a","b","indexOf","instance","push","ci","kpi","defers","dfs","rs","loop","children","target","df","defer","find","obj","elem","kpiCode","id","nodeId","search","setSearchCompleteCallback","searchResult","keyword","point","vr","value","lng","lat","resolve","promise","i","all","then","regroup","gp","group","getSeries","formatter","gr","name","label","item","getLegend","nodes","kpis","legend","series","require","count","wait","Error","setTimeout","undefined","window"],"mappings":"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","file":"toolkit/component/explainer/denuo_ci_map.js","sourcesContent":["/**\n * Created by leonlin on 16/11/3.\n */\ndefine([], function () {\n  return function (data, tools, callback) {\n    var nodesDes = tools.nodesDes;\n    var kpisDes = tools.kpisDes;\n    var q = tools.q;\n    var service = {};\n    service.resourceUIService = tools.resourceUIService;\n\n    var start = function start() {\n      var map = new BMap.Map(\"container\");\n      var localSearch = new BMap.LocalSearch(map);\n      var instances = data.reduce(function (a, b) {\n        if (a.indexOf(b.instance) == -1) {\n          a.push(b.instance);\n        }\n\n        ;\n        return a;\n      }, []);\n\n      var regroup = function regroup(ci, kpi, callback) {\n        var defers = [];\n        var dfs = [];\n        var rs = [];\n\n        var loop = function loop(ci) {\n          var rs = {\n            ci: ci,\n            children: []\n          };\n\n          var loop = function loop(kpi) {\n            var findValue = function findValue(ci, kpi, instance, target, df) {\n              var a = {};\n              var defer = q.defer();\n              var find = data.find(function (elem) {\n                return elem.kpiCode == kpi.id && elem.nodeId == ci.id && elem.instance == instance;\n              });\n              defer.id = instance;\n              defer.find = find;\n              a.id = instance;\n              df.id = instance;\n\n              if (find) {\n                localSearch.search(find.instance);\n\n                (function (defer, a) {\n                  var callback = function callback(searchResult) {\n                    /** 这样的写法是因为百度地图的回调函数回破坏闭包结构， 但还没发现原因 */\n                    var keyword = searchResult.keyword;\n                    var df = dfs.find(function (elem) {\n                      return elem.id == keyword;\n                    });\n                    var point = searchResult.vr[0].point;\n                    var tg = rs.children.find(function (elem) {\n                      return elem.instance == keyword;\n                    });\n                    tg.value = [point.lng, point.lat, df.find.value];\n                    df.resolve(\"success\");\n                  };\n\n                  localSearch.setSearchCompleteCallback(callback);\n                })(defer, a);\n              } else {\n                target.value = \"-\";\n                defer.resolve(\"success\");\n              }\n\n              ;\n              dfs.push(defer);\n              defer.promise.id = instance;\n              return defer.promise;\n            };\n\n            var loop = function loop(instance) {\n              var defer = q.defer();\n              var obj = {\n                kpi: kpi,\n                instance: instance\n              };\n              defers.push(findValue(ci, kpi, instance, obj, defer));\n              rs.children.push(obj);\n            };\n\n            for (var i in instances) {\n              loop(instances[i]);\n            }\n          };\n\n          for (var i in kpi) {\n            loop(kpi[i]);\n          }\n\n          return rs;\n        };\n\n        for (var i in ci) {\n          rs.push(loop(ci[i]));\n        }\n\n        q.all(defers).then(function () {\n          callback(rs);\n        });\n      };\n\n      regroup(nodesDes, kpisDes, function (gp) {\n        var group = gp;\n\n        var getSeries = function getSeries(formatter) {\n          var rs = [];\n\n          var loop = function loop(gr) {\n            var rs = {\n              name: gr.ci.label,\n              data: []\n            };\n\n            var loop = function loop(item) {\n              var name = item.instance;\n              return {\n                name: name,\n                value: item.value\n              };\n            };\n\n            for (var i in gr.children) {\n              rs.data.push(loop(gr.children[i]));\n            }\n\n            return rs;\n          };\n\n          for (var i in group) {\n            rs.push(loop(group[i]));\n          }\n\n          return rs;\n        };\n\n        var getLegend = function getLegend(formatter) {\n          var rs = [];\n\n          var loop = function loop(gr) {\n            var loop = function loop(item) {\n              var name;\n\n              if (typeof formatter == \"function\") {\n                name = formatter({\n                  ci: gr.ci.label,\n                  kpi: item.kpi.label,\n                  value: item.value\n                });\n              } else {\n                name = gr.ci.label + \"-\" + item.kpi.label;\n              }\n\n              return name;\n            };\n\n            for (var i in gr.children) {\n              rs.push(loop(gr.children[i]));\n            }\n          };\n\n          for (var i in group) {\n            loop(group[i]);\n          }\n\n          return rs;\n        };\n\n        var rs = {\n          getSeries: getSeries,\n          getLegend: getLegend,\n          data: {\n            nodes: nodesDes,\n            kpis: kpisDes,\n            legend: getLegend(),\n            series: getSeries()\n          }\n        };\n        callback(rs);\n      });\n    };\n\n    require(['baiduMap', 'bmap'], function (a, b) {\n      var count = 0;\n      wait();\n\n      function wait() {\n        if (count < 20) {\n          count += 1;\n          setTimeout(function () {\n            if (window.BMap == undefined) {\n              wait();\n            } else {\n              start();\n            }\n          });\n        } else {\n          throw new Error('百度视图获取失败!!');\n        }\n      }\n    }, function error() {\n      ;\n      start();\n    });\n  };\n});"],"sourceRoot":"/source/"}