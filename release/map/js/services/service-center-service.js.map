{"version":3,"sources":["js/services/service-center-service.js"],"names":["_typeof","obj","Symbol","iterator","constructor","prototype","define","services","serviceCenterService","q","timeout","userLoginUIService","resourceUIService","dictionaryService","kpiDataService","viewFlexService","window","location","SwSocket","unitService","solutionUIService","Info","factory","getAll","cache","cached","undefined","cur","this","deferred","defer","success","data","status","valueCached","resolve","error","err","errObj","reject","promise","then","eval","fun","event","caller","message","getBymodelId","modelId","findModel","models","find","element","id","findValue","filter","kpi","push","i","elem","concat","devices","Object","create","resources","result","rootDomain","get","groupModels","units","deviceGroups","views","deviceGroupModels","attrs","directives","getValues","nodes","kpis","extension","kpiQueryModel","category","isRealTimeData","timePeriod","nodeIds","kpiCodes","startTime","endTime","timeRange","statisticType","condList","param","getValueList","code","toString","getValuesByCi","nodesDes","kpisDes","orderType","topN","modelGroupIds","map","label","orderCond","legends","series","instance","name","ci","value","callback_group","j","nodeId","kpiCode","callback","getValuesByTimealert","getKpiHierarchyValueList","recordList","alert_code_count","getValuesList","minTimespan","reduce","reduceByCiKpi","reduceByTime","prev","next","nextTime","Date","arisingTime","getTime","length","key","hasOwnProperty","getValueListBytime","nodesDescription","kpisDescription","timespan","frequency","format","type","method","cod","nodeDefers","aggregate_type","customCategory","simulate","aggregate_rule","autoFillBlank","condition","$clone","time","unit","merge","require","defers","rs","cond","Array","object","includeInstance","aggregateType","granularityUnit","aggregate_instance","instances","tspan","traverse","loop","attr","item","str","exec","translate","params","mergeRule","freqObj","apply","loopNode","nodeDes","parseInt","nodeLoaded","loopKpi","kpiDes","all","init","simuData","sData","instanceId","insCode","getDictValues","getValuesListAndMergeByTime","mtspan","mode","minspan","pack","xAxis","legend","timeStamp","allTimes","Math","min","max","mergeByCi","resource","valueGroup","fd","index","st","et","list","k","el","mergeByCiKpi","valueList","getMinTimeSpan","getKpisByKpiIds","getByKpiIds","inside","outside","arguments","kpiId","$inject"],"mappings":"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","file":"js/services/service-center-service.js","sourcesContent":["function _typeof(obj) { if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; }; } return _typeof(obj); }\n\ndefine(['../services/services.js'], function (services) {\n  'use strict';\n\n  services.factory(\"serviceCenterService\", serviceCenterService);\n  serviceCenterService.$inject = ['$q', '$timeout', 'userLoginUIService', 'resourceUIService', 'dictionaryService', 'kpiDataService', 'viewFlexService', '$window', '$location', 'SwSocket', 'unitService', 'solutionUIService', 'Info'];\n\n  function serviceCenterService(q, timeout, userLoginUIService, resourceUIService, dictionaryService, kpiDataService, viewFlexService, window, location, SwSocket, unitService, solutionUIService, Info) {\n    var factory = {};\n    factory.devices = Object.create({\n      status: 'WAIT',\n      fun: 'resourceUIService.getDevices',\n      getAll: getAll\n    });\n    factory.resources = Object.create({\n      status: 'WAIT',\n      fun: 'resourceUIService.getResources',\n      getAll: getAll,\n      getBymodelId: function getBymodelId(modelId) {\n        var cur = this,\n            deferred = q.defer();\n\n        if (cur.status == \"COMPLETE\") {\n          var result = cur.valueCached.filter(function (element) {\n            return modelId == element.modelId;\n          });\n          deferred.resolve(result);\n        } else if (cur.status == \"INPROGRESS\") {\n          cur.promise.then(function (data) {\n            var result = data.filter(function (element) {\n              return modelId == element.modelId;\n            });\n            deferred.resolve(result);\n          });\n        } else if (cur.status == \"WAIT\") {\n          cur.getAll().then(function (data) {\n            var result = data.filter(function (element) {\n              return modelId == element.modelId;\n            });\n            deferred.resolve(result);\n          });\n        }\n\n        return deferred.promise;\n      }\n    });\n    factory.rootDomain = Object.create({\n      status: 'WAIT',\n      fun: 'resourceUIService.getRootDomain',\n      get: getAll\n    });\n    factory.models = Object.create({\n      status: 'WAIT',\n      fun: 'resourceUIService.getModels',\n      getAll: getAll\n    });\n    factory.groupModels = Object.create({\n      status: 'WAIT',\n      fun: 'solutionUIService.getGroupModels',\n      getAll: getAll\n    });\n    factory.units = Object.create({\n      status: 'WAIT',\n      fun: 'unitService.getAllUnits',\n      getAll: getAll\n    });\n    factory.deviceGroups = Object.create({\n      status: 'WAIT',\n      fun: 'resourceUIService.getDeviceGroups',\n      getAll: getAll\n    });\n    factory.views = Object.create({\n      status: 'WAIT',\n      fun: 'viewFlexService.getAllMyViews',\n      getAll: getAll\n    });\n    factory.deviceGroupModels = Object.create({\n      status: 'WAIT',\n      fun: 'resourceUIService.getDeviceGroupModels',\n      getAll: getAll\n    });\n    factory.attrs = Object.create({\n      models: [],\n      valueCached: [],\n      fun: 'resourceUIService.getAttrsByModelId',\n      getBymodelId: getBymodelId\n    });\n    factory.directives = Object.create({\n      models: [],\n      valueCached: [],\n      fun: 'resourceUIService.getDirectivesByModelId',\n      getBymodelId: getBymodelId\n    });\n\n    factory.getValues = function (nodes, kpis, extension) {\n      var deferred = q.defer();\n      var kpiQueryModel = {\n        category: 'ci',\n        isRealTimeData: false,\n        timePeriod: 0,\n        nodeIds: nodes,\n        kpiCodes: kpis,\n        startTime: null,\n        endTime: null,\n        timeRange: \"\",\n        statisticType: \"psiot\",\n        condList: []\n      };\n\n      for (var i in extension) {\n        kpiQueryModel[i] = extension[i];\n      }\n\n      var param = [\"kpi\", kpiQueryModel];\n      kpiDataService.getValueList(param, function (event) {\n        callback(event);\n      });\n\n      function callback(event) {\n        if (event.code == \"0\") {\n          deferred.resolve(event.data);\n        } else {\n          deferred.reject(\"通过设备[\" + nodes.toString() + \"], 指标[\" + kpis.toString() + \"]获取数据列表失败。\");\n        }\n      }\n\n      return deferred.promise;\n    };\n\n    factory.getValuesByCi = function (nodesDes, kpisDes, orderType, topN, modelGroupIds) {\n      var deferred = q.defer();\n      var kpis;\n      var nodes;\n\n      if (nodesDes) {\n        nodes = nodesDes.map(function (element) {\n          if (element) {\n            return element.id;\n          } else {\n            return false;\n          }\n        });\n      }\n\n      if (kpisDes == 'alert') {\n        kpisDes = [{\n          id: 999999,\n          label: '节点告警状态'\n        }];\n      }\n\n      kpis = kpisDes.map(function (element) {\n        return element.id;\n      });\n      var kpiQueryModel = {\n        category: 'ci',\n        isRealTimeData: true,\n        nodeIds: nodes,\n        kpiCodes: kpis,\n        startTime: null,\n        endTime: null,\n        timeRange: \"\",\n        statisticType: \"psiot\",\n        condList: []\n      };\n\n      if (modelGroupIds) {\n        kpiQueryModel.orderCond = modelGroupIds;\n      }\n\n      if (orderType) {\n        kpiQueryModel.orderType = orderType;\n      }\n\n      if (topN) {\n        kpiQueryModel.topN = topN;\n      }\n\n      var param = [\"kpi\", kpiQueryModel];\n      kpiDataService.getValueList(param, function (event) {\n        if (modelGroupIds) {\n          callback_group(event);\n        } else {\n          callback(event);\n        }\n      });\n\n      function callback_group(event) {\n        if (event.code == \"0\") {\n          var legends = [];\n          var series = [];\n\n          for (var i in event.data) {\n            if (event.data[i].instance != null) {\n              series.push({\n                name: {\n                  ci: event.data[i].instance,\n                  kpi: ''\n                },\n                value: event.data[i] ? event.data[i].value : 0\n              });\n              legends.push({\n                ci: event.data[i].instance,\n                kpi: ''\n              });\n            }\n          }\n\n          deferred.resolve({\n            series: [{\n              name: {\n                ci: '设备',\n                kpi: '指标'\n              },\n              data: series\n            }],\n            legends: legends\n          });\n        } else {\n          deferred.reject(\"通过设备[\" + nodes.toString() + \"], 指标[\" + kpis.toString() + \"]获取数据列表失败。\");\n        }\n      }\n\n      function callback(event) {\n        if (event.code == \"0\") {\n          var legends = [];\n          var series = [];\n\n          for (var i in nodesDes) {\n            for (var j in kpisDes) {\n              var find = event.data.find(function (elem) {\n                return elem.nodeId == nodesDes[i].id && elem.kpiCode == kpisDes[j].id;\n              });\n              series.push({\n                name: {\n                  ci: nodesDes[i].label,\n                  kpi: kpisDes[j].label\n                },\n                value: find ? find.value : 0\n              });\n              legends.push({\n                ci: nodesDes[i].label,\n                kpi: kpisDes[j].label\n              });\n            }\n          }\n\n          deferred.resolve({\n            series: [{\n              name: {\n                ci: '设备',\n                kpi: '指标'\n              },\n              data: series\n            }],\n            legends: legends\n          });\n        } else {\n          deferred.reject(\"通过设备[\" + nodes.toString() + \"], 指标[\" + kpis.toString() + \"]获取数据列表失败。\");\n        }\n      }\n\n      return deferred.promise;\n    };\n\n    factory.getValuesByTimealert = function () {\n      var deferred = q.defer();\n      var kpiQueryModel = {\n        category: 'ci',\n        isRealTimeData: true,\n        timePeriod: 0,\n        kpiCodes: [\"alert_code_count\"]\n      };\n      var param = [\"alert\", kpiQueryModel];\n      kpiDataService.getKpiHierarchyValueList(param, function (event) {\n        callback(event);\n      });\n\n      function callback(event) {\n        if (event.code == \"0\") {\n          var legends = [];\n          var series = [];\n\n          for (var i in event.data.recordList) {\n            series.push({\n              name: event.data.recordList[i].category,\n              value: event.data.recordList[i].alert_code_count\n            });\n            legends.push(event.data.recordList[i].category);\n          }\n\n          deferred.resolve({\n            series: [{\n              name: '设备，指标',\n              data: series\n            }],\n            legends: legends\n          });\n        } else {\n          deferred.reject(\"通过设备[alert_code_count]方法，获取数据列表失败。\");\n        }\n      }\n\n      return deferred.promise;\n    };\n\n    factory.getValuesList = function (nodes, kpis) {\n      var deferred = q.defer();\n      var kpiQueryModel = {\n        category: 'time',\n        isRealTimeData: true,\n        timePeriod: 24 * 3600 * 1000,\n        nodeIds: nodes,\n        kpiCodes: kpis,\n        startTime: null,\n        endTime: null,\n        timeRange: \"\",\n        statisticType: \"psiot\",\n        condList: []\n      };\n      var param = [\"kpi\", kpiQueryModel];\n      kpiDataService.getValueList(param, function (event) {\n        callback(event);\n      });\n\n      function callback(event) {\n        var minTimespan;\n\n        if (event.code == \"0\") {\n          //factory.kpis.getMinTimeSpan(kpis).then(success, error);\n          success();\n        }\n\n        function success(data) {\n          minTimespan = 0;\n          var result = event.data;\n          /*\n           var result = event.data.reduce(reduceByTime,[]);\n           var result = result.map(function(element){\n           var regExp = /\\d{2}\\:\\d{2}\\:\\d{2}/;\n           var time = element.arisingTime.match(regExp);\n           return {\n           kpiCode : element.kpiCode,\n           nodeId : element.nodeId,\n           time : time[0],\n           value : element.value\n           }\n           });\n           */\n\n          var result = result.reduce(reduceByCiKpi, {});\n\n          for (var i in result) {\n            result[i] = result[i].reduce(reduceByTime, []);\n          }\n\n          deferred.resolve(result);\n        }\n\n        function error(err) {\n          deferred.reject(\"通过设备[\" + nodes.toString() + \"], 指标[\" + kpis.toString() + \"]获取数据列表失败。\");\n        }\n\n        var startTime;\n\n        function reduceByTime(prev, next) {\n          var nextTime = new Date(next.arisingTime).getTime();\n\n          if (prev.length == 0) {\n            startTime = nextTime;\n            return [next];\n          } else {\n            if (nextTime - startTime < minTimespan) {\n              return prev;\n            } else {\n              startTime = nextTime;\n              prev.push(next);\n              return prev;\n            }\n          }\n        }\n\n        function reduceByCiKpi(prev, next) {\n          var key = next.nodeId + \"?\" + next.kpiCode;\n\n          if (prev.hasOwnProperty(key)) {\n            prev[key].push(next);\n          } else {\n            prev[key] = [next];\n          }\n\n          return prev;\n        }\n      }\n\n      return deferred.promise;\n    };\n\n    factory.getValueListBytime = function (nodesDescription, kpisDescription, timespan, frequency, format, category, type, method, cod, extension, kpiQueryModel) {\n      var deferred = q.defer();\n      var nodeDefers = [];\n      var instance;\n      var nodes = [],\n          kpis = [];\n      var nodesDes = [];\n      var kpisDes = [];\n      var aggregate_type = [];\n      var modelId;\n      var customCategory;\n      var simulate;\n      var aggregate_rule;\n      var autoFillBlank;\n      var condition = cod.$clone();\n\n      var getTime = function getTime(time) {\n        if (time) {\n          switch (time.unit) {\n            case \"second\":\n              return time.value * 1000;\n              break;\n\n            case \"minute\":\n              return time.value * 60 * 1000;\n              break;\n\n            case \"hour\":\n              return time.value * 60 * 60 * 1000;\n              break;\n\n            case \"day\":\n              return time.value * 24 * 60 * 60 * 1000;\n              break;\n\n            case \"month\":\n              return time.value * 30 * 24 * 60 * 60 * 1000;\n              break;\n\n            default:\n              return time.value;\n              break;\n          }\n        } else {\n          return 0;\n        }\n      };\n\n      var merge = function merge(category, callback) {\n        var path = customCategory ? customCategory : category;\n\n        require([\"../../toolkit/component/explainer/\" + path], function (fun) {\n          callback(fun);\n        });\n      };\n\n      var defers = [],\n          rs = {};\n\n      var getValueList = function getValueList(type, category, method, condition) {\n        // \n        var cond;\n\n        if (condition instanceof Array) {\n          cond = condition;\n\n          if (_typeof(condition[1]) == \"object\") {\n            cond[1].startTime = condition[1].startTime;\n          }\n\n          ;\n\n          if (_typeof(condition[1]) == \"object\") {\n            cond[1].endTime = condition[1].endTime;\n          }\n\n          ;\n        } else {\n          cond = condition;\n        }\n\n        ;\n        var object = {\n          kpiQueryModel: kpiQueryModel ? kpiQueryModel : {\n            category: category,\n            isRealTimeData: true,\n            nodeIds: nodes,\n            kpiCodes: kpis,\n            startTime: null,\n            endTime: null,\n            timeRange: \"\",\n            statisticType: \"psiot\",\n            includeInstance: true,\n            condList: []\n          }\n        };\n\n        if (extension) {\n          object.kpiQueryModel.aggregateType = aggregate_type = extension.aggregate_type;\n          object.kpiQueryModel.granularityUnit = extension.granularityUnit;\n\n          if (extension.aggregate_instance instanceof Array) {\n            if (extension.aggregate_instance.length > 0) {\n              object.kpiQueryModel.instances = extension.aggregate_instance;\n            }\n\n            ;\n          }\n\n          aggregate_rule = extension.aggregate_rule;\n          autoFillBlank = extension.autoFillBlank;\n        }\n\n        if (category == \"time\") {\n          var tspan = getTime(timespan);\n          object[\"kpiQueryModel\"][\"timePeriod\"] = tspan ? tspan : 24 * 3600 * 1000;\n        }\n\n        var traverse = function traverse(condition) {\n          var translate = function translate(str) {\n            var objLike = /^\\{object\\:(\\w+)\\}$/;\n            var result = objLike.exec(str);\n\n            if (result != null) {\n              var param = result[1];\n              return object[param];\n            } else {\n              return str;\n            }\n\n            ;\n          };\n\n          var loop = function loop(attr, item) {\n            if (_typeof(item) == 'object') {\n              traverse(item);\n            } else if (typeof item == \"string\") {\n              condition[attr] = translate(item);\n            }\n          };\n\n          for (var i in condition) {\n            loop(i, condition[i]);\n          }\n        };\n\n        var params = [];\n\n        var callback = function callback(event) {\n          merge(category, function (mergeRule) {\n            if (nodesDes.length == 0 || kpisDes.length == 0) {//throw new Error(\"nodesDes is empty\");\n            }\n\n            var obj = {\n              Info: Info,\n              format: format,\n              frequency: getTime(frequency),\n              timespan: getTime(timespan),\n              freqObj: frequency,\n              nodesDes: nodesDes,\n              kpisDes: kpisDes,\n              instance: instance,\n              aggregate_type: aggregate_type,\n              aggregate_rule: aggregate_rule,\n              autoFillBlank: autoFillBlank,\n              dictionaryService: dictionaryService,\n              kpiDataService: kpiDataService,\n              resourceUIService: resourceUIService,\n              q: q\n            };\n\n            if (simulate) {\n              obj.simulate = simulate;\n            }\n\n            var callback = function callback(data) {\n              rs[category] = data;\n              deferred.resolve(rs);\n            };\n\n            mergeRule(event.code == 0 ? event.data : [], obj, callback);\n          });\n        };\n\n        if (cond != \"\") {\n          if (_typeof(cond) == \"object\") {\n            traverse(cond);\n          }\n\n          params.push(cond);\n        }\n\n        params.push(callback);\n        eval(method).apply(null, params);\n      };\n\n      var loopNode = function loopNode(nodeDes) {\n        var defer = q.defer();\n\n        if (_typeof(nodeDes) == \"object\") {\n          timeout(function () {\n            nodes.push(nodeDes.id);\n            modelId = nodeDes.modelId;\n            nodesDes.push(nodeDes);\n            defer.resolve(\"success\");\n          }, 100);\n        } else {\n          var success = function success(data) {\n            var find = data.find(function (element) {\n              return element.id == nodeDes;\n            });\n\n            if (find) {\n              nodesDes.push(find);\n              modelId = find.modelId;\n            }\n\n            defer.resolve(\"success\");\n          };\n\n          nodes.push(parseInt(nodeDes));\n          factory.resources.getAll().then(success);\n        }\n\n        return defer.promise;\n      };\n\n      var nodeLoaded = function nodeLoaded(data) {\n        var kpiDefers = [];\n\n        var kpiLoaded = function kpiLoaded(data) {\n          getValueList(type, category, method, condition);\n        };\n\n        var loopKpi = function loopKpi(kpiDes) {\n          var defer = q.defer();\n\n          if (_typeof(kpiDes) == \"object\") {\n            kpis.push(kpiDes.id);\n            kpisDes.push(kpiDes);\n            defer.resolve(\"success\");\n          } else {\n            var success = function success(data) {\n              var find = data.find(function (element) {\n                return element.id == kpiDes;\n              });\n              kpisDes.push(find);\n              defer.resolve(\"success\");\n            };\n\n            kpis.push(parseInt(kpiDes));\n\n            if (modelId) {\n              factory.kpis.getBymodelId(modelId).then(success);\n            } else {}\n          }\n        };\n\n        for (var i in kpisDescription) {\n          loopKpi(kpisDescription[i]);\n        }\n\n        ;\n        q.all(kpiDefers).then(kpiLoaded);\n      };\n\n      var init = function init() {\n        for (var i in nodesDescription) {\n          nodeDefers.push(loopNode(nodesDescription[i]));\n        }\n\n        q.all(nodeDefers).then(nodeLoaded);\n      };\n\n      var simuData = function simuData(sData) {\n        aggregate_rule = extension.aggregate_rule;\n        autoFillBlank = extension.autoFillBlank;\n        merge(category, function (mergeRule) {\n          if (nodesDes.length == 0 || kpisDes.length == 0) {//throw new Error(\"nodesDes is empty\");\n          }\n\n          var obj = {\n            Info: Info,\n            format: format,\n            frequency: getTime(frequency),\n            nodesDes: nodesDescription,\n            kpisDes: kpisDescription,\n            instance: instance,\n            aggregateType: aggregate_type,\n            aggregate_rule: aggregate_rule,\n            autoFillBlank: autoFillBlank,\n            dictionaryService: dictionaryService,\n            kpiDataService: kpiDataService,\n            resourceUIService: resourceUIService,\n            q: q\n          };\n\n          if (simulate) {\n            obj.simulate = simulate;\n          }\n\n          var callback = function callback(data) {\n            rs[category] = data;\n            deferred.resolve(rs);\n          };\n\n          mergeRule(sData, obj, callback);\n        });\n      };\n\n      if (extension) {\n        if (extension.simuData) {\n          simuData(extension.simuData);\n        } else {\n          simulate = extension.simulate;\n          customCategory = extension.customCategory;\n          var instanceId = extension.aggregate_instance;\n          var insCode;\n\n          if (instanceId == 0) {} else if (instanceId == 1) {\n            insCode = \"industryType\";\n          } else if (instanceId == 2) {\n            insCode = \"energyType\";\n          } else if (instanceId == 3) {\n            insCode = \"energyType\";\n          } else if (instanceId == 4) {\n            insCode = \"industryShortType\";\n          } else {\n            insCode = \"industryType\";\n          }\n\n          if (insCode) {\n            dictionaryService.getDictValues(insCode, function (event) {\n              if (event.code == 0) {\n                instance = event.data;\n                init();\n              }\n            });\n          } else {\n            init();\n          }\n\n          ;\n        }\n      } else {\n        init();\n      }\n\n      return deferred.promise;\n    };\n\n    factory.getValuesListAndMergeByTime = function (nodesDes, kpisDes, timespan, mtspan, mode) {\n      var minspan = mtspan;\n      var deferred = q.defer();\n      var nodes = nodesDes.map(function (element) {\n        return element.id;\n      });\n      var kpis = kpisDes.map(function (element) {\n        return element.id;\n      });\n      var kpiQueryModel = {\n        category: 'time',\n        isRealTimeData: true,\n        timePeriod: timespan ? timespan : 24 * 3600 * 1000,\n        nodeIds: nodes,\n        kpiCodes: kpis,\n        startTime: null,\n        endTime: null,\n        timeRange: \"\",\n        statisticType: \"psiot\",\n        condList: []\n      };\n      var param = [\"kpi\", kpiQueryModel];\n      kpiDataService.getValueList(param, function (event) {\n        callback(event);\n      });\n\n      function callback(event) {\n        var minTimespan, pack;\n\n        if (event.code == \"0\") {\n          if (minspan) {\n            minTimespan = minspan;\n          } else {\n            minTimespan = 0;\n          }\n\n          var result = event.data;\n          var series = [],\n              xAxis = [],\n              legend = [];\n          var result = result.map(function (element) {\n            var timeStamp = new Date(element.arisingTime).getTime();\n            return {\n              kpiCode: element.kpiCode,\n              nodeId: element.nodeId,\n              time: element.arisingTime,\n              timeStamp: timeStamp,\n              value: element.value\n            };\n          });\n          var allTimes = result.map(function (elem) {\n            return elem.timeStamp;\n          });\n          var startTime = Math.min.apply(null, allTimes);\n          var endTime = Math.max.apply(null, allTimes);\n          var time = startTime;\n\n          if (minTimespan > 0) {\n            while (time <= endTime) {\n              xAxis.push(time);\n              time += minTimespan;\n            }\n          } else {\n            xAxis = allTimes;\n          }\n\n          if (xAxis[xAxis.length - 1] != endTime) {\n            xAxis.push(endTime);\n          } //xAxis = xAxis;\n\n\n          if (mode == 'scatter') {\n            var mergeByCi = result.reduce(reduceByCi, []);\n\n            for (var i in mergeByCi) {\n              (function (index, element) {\n                series[i] = {};\n                series[i].name = {\n                  ci: element.resource.label\n                };\n\n                if (xAxis.length > 0) {\n                  series[index].data = [];\n\n                  for (var j = 0; j < xAxis.length - 1; j++) {\n                    var st = xAxis[j];\n                    var et = xAxis[j + 1];\n                    var list = [];\n\n                    for (var k in element.valueGroup) {\n                      (function (inx, elem) {\n                        var find = elem.data.find(function (el) {\n                          return st <= el.timeStamp && el.timeStamp < et;\n                        });\n                        list.push(find ? find.value : undefined);\n                      })(k, element.valueGroup[k]);\n                    }\n\n                    series[index].data.push(list);\n                  }\n                } else {\n                  series[i].data = [];\n                }\n              })(i, mergeByCi[i]);\n            }\n          } else {\n            var mergeByCiKpi = result.reduce(reduceByCiKpi, []);\n\n            for (var i in mergeByCiKpi) {\n              (function (index, element) {\n                series[i] = {};\n                series[i].name = {\n                  ci: element.resource.label,\n                  kpi: element.kpi.label\n                };\n                legend.push({\n                  ci: element.resource.label,\n                  kpi: element.kpi.label\n                });\n\n                if (xAxis.length > 0) {\n                  series[index].data = [];\n\n                  for (var j = 0; j < xAxis.length - 1; j++) {\n                    var st = xAxis[j];\n                    var et = xAxis[j + 1];\n                    var find = element.valueList.find(function (el) {\n                      return st <= el.timeStamp && el.timeStamp < et;\n                    });\n                    series[index].data.push(find ? find.value : undefined);\n                  }\n                } else {\n                  series[i].data = [];\n                }\n              })(i, mergeByCiKpi[i]);\n            }\n          }\n\n          pack = {\n            xAxis: xAxis,\n            series: series,\n            legend: legend\n          };\n          deferred.resolve(pack);\n        } else {\n          deferred.reject(\"通过设备[\" + nodes.toString() + \"], 指标[\" + kpis.toString() + \"]获取数据列表失败。\");\n        }\n\n        function error(err) {\n          deferred.reject(\"通过设备[\" + nodes.toString() + \"], 指标[\" + kpis.toString() + \"]获取数据列表失败。\");\n        }\n\n        var startTime;\n\n        function reduceByCiKpi(prev, next) {\n          var nodeId = next.nodeId;\n          var kpiCode = next.kpiCode;\n          var resource = nodesDes.find(function (elem) {\n            return elem.id == nodeId;\n          });\n          var kpi = kpisDes.find(function (elem) {\n            return elem.id == kpiCode;\n          });\n          var find = prev.find(function (element) {\n            return element.resource.id == nodeId && element.kpi.id == kpiCode;\n          });\n\n          if (find) {\n            find.valueList.push({\n              time: next.time,\n              timeStamp: next.timeStamp,\n              value: next.value\n            });\n          } else {\n            prev.push({\n              resource: resource,\n              kpi: kpi,\n              valueList: [{\n                time: next.time,\n                timeStamp: next.timeStamp,\n                value: next.value\n              }]\n            });\n          }\n\n          return prev;\n        }\n\n        function reduceByCi(prev, next) {\n          var nodeId = next.nodeId;\n          var kpiCode = next.kpiCode;\n          var resource = nodesDes.find(function (elem) {\n            return elem.id == nodeId;\n          });\n          var kpi = kpisDes.find(function (elem) {\n            return elem.id == kpiCode;\n          });\n          var find = prev.find(function (element) {\n            return element.resource.id == nodeId;\n          });\n\n          if (find) {\n            var valueGroup = find.valueGroup;\n            var fd = find.valueGroup.find(function (element) {\n              return element.kpi.id == kpiCode;\n            });\n\n            if (fd) {\n              fd.data.push({\n                time: next.time,\n                timeStamp: next.timeStamp,\n                value: next.value\n              });\n            } else {\n              find.valueGroup.push({\n                kpi: kpi,\n                data: [{\n                  time: next.time,\n                  timeStamp: next.timeStamp,\n                  value: next.value\n                }]\n              });\n            }\n          } else {\n            prev.push({\n              resource: resource,\n              valueGroup: [{\n                kpi: kpi,\n                data: [{\n                  time: next.time,\n                  timeStamp: next.timeStamp,\n                  value: next.value\n                }]\n              }]\n            });\n          }\n\n          return prev;\n        }\n      }\n\n      return deferred.promise;\n    };\n\n    factory.kpis = Object.create({\n      models: [],\n      valueCached: [],\n      fun: 'resourceUIService.getKpisByModelId',\n      getMinTimeSpan: function getMinTimeSpan(kpis) {\n        var deferred = q.defer();\n        resourceUIService.getKpisByKpiIds(kpis, success, error);\n\n        function success(data) {\n          if (data.minTimespan) {\n            deferred.resolve(data.minTimespan);\n          }\n        }\n\n        function error(err) {}\n\n        return deferred.promise;\n      },\n      getByKpiIds: function getByKpiIds(kpis) {\n        var deferred = q.defer(),\n            inside,\n            outside,\n            cur = this;\n        inside = [];\n        outside = [];\n        insideValueCached.apply(null, kpis);\n\n        function insideValueCached() {\n          for (var i in arguments) {\n            (function (kpiId) {\n              var find = cur.valueCached.filter(function (kpi) {\n                return kpiId == kpi.id;\n              });\n\n              if (find.length > 0) {\n                inside.push(find[0]);\n              } else {\n                outside.push(kpiId);\n              }\n            })(arguments[i]);\n          }\n        }\n\n        resourceUIService.getKpisByKpiIds(outside, success, error);\n\n        function success(data) {\n          try {\n            if (data) {\n              var result = [];\n              delete data.minTimespan;\n\n              for (var i in data) {\n                result.push(data[i]);\n                cur.valueCached.push(data[i]);\n              }\n\n              deferred.resolve(inside.concat(result));\n            } else {\n              throw \"data is undefined !!\";\n            }\n          } catch (err) {\n            deferred.reject(err);\n          }\n        }\n\n        function error(err) {\n          throw err;\n        }\n\n        return deferred.promise;\n      },\n      getBymodelId: getBymodelId\n    });\n\n    function getAll(cache) {\n      var cached;\n      cached = cache == undefined ? true : cache;\n      var cur = this,\n          deferred = q.defer();\n\n      if (cur.status == 'COMPLETE' && cached) {\n        deferred.resolve(cur.valueCached);\n      } else if (cur.status == 'INPROGRESS' && cached) {\n        if (cur.promise) {\n          cur.promise.then(success, error);\n        }\n      } else if (cur.status == 'WAIT' || cached == false) {\n        cur.status = 'INPROGRESS';\n        cur.promise = deferred.promise;\n        eval(cur.fun)(function (event) {\n          try {\n            if (event.data) {\n              success(event.data);\n            } else {\n              cur.errObj = {\n                caller: cur.fun,\n                message: \"databack is undefined !!\"\n              };\n              throw cur.errObj;\n            }\n          } catch (err) {\n            deferred.reject(err);\n          }\n        }, error);\n      } else if (cur.status == 'ERROR' && cached) {\n        deferred.reject(cur.errObj);\n      }\n\n      function success(data) {\n        delete cur.defer;\n        cur.status = 'COMPLETE';\n        cur.valueCached = data;\n        deferred.resolve(data);\n      }\n\n      function error(err) {\n        cur.status = 'ERROR';\n        cur.valueCached = [];\n        cur.errObj = err;\n        deferred.reject(cur.errObj);\n      }\n\n      return deferred.promise;\n    }\n\n    ;\n\n    function getBymodelId(modelId) {\n      var cur = this,\n          deferred = q.defer();\n      var findModel = cur.models.find(function (element) {\n        return element.id == modelId;\n      });\n\n      if (findModel) {\n        if (findModel.status == 'COMPLETE') {\n          var findValue = cur.valueCached.filter(function (kpi) {\n            return kpi.modelId == modelId;\n          });\n          deferred.resolve(findValue);\n        } else if (findModel.status == 'INPROGRESS') {\n          var promise = findModel.promise;\n          promise.then(success, error);\n        }\n      } else {\n        cur.models.push({\n          id: modelId,\n          promise: deferred.promise,\n          status: 'INPROGRESS'\n        });\n\n        if (modelId) {\n          eval(cur.fun)(modelId, function (event) {\n            try {\n              if (event.data) {\n                success(event.data);\n              } else {\n                throw \"API-getBymodelId[\" + modelId + \"]\" + \"databack is undefined !!\";\n              }\n            } catch (err) {\n              deferred.reject(err);\n            }\n          }, error);\n        } else {\n          deferred.reject(\"modelId为空\");\n        }\n      }\n\n      function success(data) {\n        for (var i in data) {\n          data[i].modelId = modelId;\n        }\n\n        var find = cur.models.find(function (element) {\n          return element.id == modelId;\n        });\n        delete find.promise;\n        find.status = 'COMPLETE';\n        cur.valueCached = cur.valueCached.filter(function (elem) {\n          return elem.modelId != modelId;\n        });\n        cur.valueCached = cur.valueCached.concat(data);\n        deferred.resolve(data);\n      }\n\n      function error(err) {}\n\n      return deferred.promise;\n    }\n\n    ;\n    return factory;\n  }\n});"],"sourceRoot":"/source/"}