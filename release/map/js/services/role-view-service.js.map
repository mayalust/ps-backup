{"version":3,"sources":["js/services/role-view-service.js"],"names":["define","services","factory","serviceProxy","userLoginUIService","rootScope","getView","type","val","callback","ready","tree","rs","find","user","traverse","data","push","hasOwnProperty","i","function","elem","Error","name","ViewCode","functionCode","viewResArr","roleViewList","filter","length","viewRes","sort","a","b","roleId","code","message","isAuthenticated","$on","getViewByFunctionCode","fnCode","getViewByFunctionName"],"mappings":"AAAAA,OAAO,CAAC,2BAA4B,SAAUC,GAC5C,aAEAA,EAASC,QAAQ,kBAAmB,CAAC,eAAgB,qBAAsB,aAAc,SAAUC,EAAcC,EAAoBC,GACnI,IAAIH,EAAU,GAEVI,EAAU,SAAiBC,EAAMC,EAAKC,GACxC,IAAIC,EAAQ,WACV,IAAqCC,EAC/BC,EAiBFC,GAlBiCF,EAiBNP,EAAmBU,KAhB5CF,EAAK,GAEM,SAASG,EAASC,GAG/B,GAFAJ,EAAGK,KAAKD,GAEJA,EAAKE,eAAe,YACtB,IAAK,IAAIC,KAAKH,EAAKI,SACjBL,EAASC,EAAKI,SAASD,IAK7BJ,CAASJ,GACFC,GAIgBC,KAAK,SAAUQ,GACtC,OAAOA,EAAKd,IAASC,IAGvB,IAAIK,EAoDF,MAAM,IAAIS,MAAM,cAAgBC,KAAO,SAnDvC,IAQQX,EARJY,EAAWX,EAAKY,aAEhBC,EADetB,EAAmBU,KAAKa,aACbC,OAAO,SAAUP,GAC7C,OAAOA,EAAKI,cAAgBD,IAG9B,GAAwB,EAApBE,EAAWG,OAAY,CACzB,IAmBIC,EATc,GATZlB,EAkBwBc,EAlBbK,KAAK,SAAUC,EAAGC,GAC/B,OAAID,EAAEE,OAAOL,OAASI,EAAEC,OAAOL,OACtB,EAEA,KAKJA,OACEjB,EAAG,GAEH,KASTH,EADEqB,EACO,CACPK,KAAM,EACNnB,KAAMc,EACNM,QAAS,MAGF,CACPD,KAAM,KACNnB,KAAM,KACNoB,QAAS,qBAIb3B,EAAS,CACP0B,KAAM,KACNnB,KAAM,KACNoB,QAAS,gBAAkBb,KAAO,sBAUtCnB,EAAmBU,KAAKuB,gBAC1B3B,IAEAL,EAAUiC,IAAI,qBAAsB5B,IAYxC,OARAR,EAAQqC,sBAAwB,SAAUC,EAAQ/B,GAChDH,EAAQ,eAAgBkC,EAAQ/B,IAGlCP,EAAQuC,sBAAwB,SAAUlB,EAAMd,GAC9CH,EAAQ,OAAQiB,EAAMd,IAGjBP","file":"js/services/role-view-service.js","sourcesContent":["define(['../services/services.js'], function (services) {\n  'use strict';\n\n  services.factory('roleViewService', ['serviceProxy', 'userLoginUIService', '$rootScope', function (serviceProxy, userLoginUIService, rootScope) {\n    var factory = {};\n\n    var getView = function getView(type, val, callback) {\n      var ready = function ready() {\n        var createlist = function createlist(tree) {\n          var rs = [];\n\n          var traverse = function traverse(data) {\n            rs.push(data);\n\n            if (data.hasOwnProperty(\"function\")) {\n              for (var i in data.function) {\n                traverse(data.function[i]);\n              }\n            }\n          };\n\n          traverse(tree);\n          return rs;\n        };\n\n        var functionlists = createlist(userLoginUIService.user);\n        var find = functionlists.find(function (elem) {\n          return elem[type] == val;\n        });\n\n        if (find) {\n          var ViewCode = find.functionCode;\n          var roleViewList = userLoginUIService.user.roleViewList;\n          var viewResArr = roleViewList.filter(function (elem) {\n            return elem.functionCode == ViewCode;\n          });\n\n          if (viewResArr.length > 0) {\n            var getResourseView = function getResourseView(array) {\n              var rs = array.sort(function (a, b) {\n                if (a.roleId.length < b.roleId.length) {\n                  return 0;\n                } else {\n                  return 1;\n                }\n              });\n              /** 如果用户自定义视图获取自定义视图*/\n\n              if (rs.length > 0) {\n                return rs[0];\n              } else {\n                return null;\n              }\n\n              ;\n            };\n\n            var viewRes = getResourseView(viewResArr);\n\n            if (viewRes) {\n              callback({\n                code: 0,\n                data: viewRes,\n                message: null\n              });\n            } else {\n              callback({\n                code: 1001,\n                data: null,\n                message: \"没找到对应的服务视图。\"\n              });\n            }\n          } else {\n            callback({\n              code: 1001,\n              data: null,\n              message: \"此用户角色并没有配置相应的\" + name + \"视图，请询问系统管理员配置视图。\"\n            });\n          }\n\n          ;\n        } else {\n          throw new Error(\"内部错误：找不到对应'\" + name + \"'的功能码\");\n        }\n      };\n\n      if (userLoginUIService.user.isAuthenticated) {\n        ready();\n      } else {\n        rootScope.$on(\"loginStatusChanged\", ready);\n      }\n    };\n\n    factory.getViewByFunctionCode = function (fnCode, callback) {\n      getView(\"functionCode\", fnCode, callback);\n    };\n\n    factory.getViewByFunctionName = function (name, callback) {\n      getView(\"name\", name, callback);\n    };\n\n    return factory;\n  }]);\n});"],"sourceRoot":"/source/"}