{"version":3,"sources":["js/services/user-login-ui-service.js"],"names":["define","services","factory","$http","$state","$rootScope","serviceProxy","$q","route","location","window","timeout","growl","userEnterpriseService","psTreeData","psUiRouterHandler","cms2","psConfig","_INCLUDES","isFromFreeStyle","$$absUrl","indexOf","loginService","roleId","localStorage","getItem","changeAuth","loggedIn","user","userId","userID","enterprise","enterpriseLogo","url","origin","isAuthenticated","$broadcast","loginPath","wait","callback","roles","viewType","firstCode","result","document","title","getCurrentUser","deferred","defer","getCurrentRoleId","currentUserRoleId","str","rs","parseInt","split","console","assert","warn","get","log","Date","__loadedTime__","toFixed","code","data","usercurrentRoleID","currentRoleID","roleID","resolve","currentUrl","href","loginTimes","reject","promise","login","account","password","loginCallback","logout","dt","slice","modifyPassword","email","newPassword","callBack","loginin","loginName","redirectToLogin","changePos","loginChangedefer","appData","industry","$on","event","then","domainPath","Error","match","exec","rootId","params","id","currentRole","queryEnterpriseRole","returnObj","find","ele","setRoleValues","values","getRoleValues","tab","children","index","length","viewId","test","d","go","apply","addEventListener","hashChange","e","replace","removeEventListener","rootHandler","$scope","$location","absUrl","search","localMenuCode","menuitems","currentMenuCode","treeviewIndex","path","locationStr","menuObj","locationAry","some","parentCode","locaStr1","warning","oldTreeviewIndex","functionCode","firstMenuCode","charAt","oldFirstMenuCode","$","css","removeClass","AdminLTE","layout","fix","key","defaultRoute","substr","function","forEach","subItem","initMenus","userInfo","functionList","menu","baseConfig","name","label","sublabel","decodeURIComponent","menuhandle","menuInfo","searchUrl","substring","handlemenu","getAddressPoint","address","jQuery","ajax","type","protocol","dataType","jsoncallback","success","status","lat","lng","error","hash"],"mappings":"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","file":"js/services/user-login-ui-service.js","sourcesContent":["define(['../services/services.js'], function (services) {\n  'use strict';\n\n  services.factory('userLoginUIService', ['$http', '$state', '$rootScope', 'serviceProxy', '$q', '$route', '$location', '$window', '$timeout', 'growl', 'userEnterpriseService', 'psTreeData', 'psUiRouterHandler', 'commonMethodService2', 'psConfig', function ($http, $state, $rootScope, serviceProxy, $q, route, location, window, timeout, growl, userEnterpriseService, psTreeData, psUiRouterHandler, cms2, psConfig) {\n    var _INCLUDES = ['prod_', 'rview'];\n    /** 暂时写死APP-FREE-STYLE不受权限控制，之后通过权限进行重新配置 */\n\n    var isFromFreeStyle = function (absUrl) {\n      return absUrl.indexOf(\"app-free-style\") != -1;\n    }(location.$$absUrl);\n    /** 暂时写死APP-FREE-STYLE不受权限控制，之后通过权限进行重新配置 */\n\n\n    var factory,\n        loginService = 'userLoginUIService';\n    var defer,\n        roleId = localStorage.getItem(\"roleId\");\n    factory = {\n      loginPath: '',\n      user: {\n        wait: function wait(callback) {\n          defer = callback;\n        },\n        isAuthenticated: false,\n        roles: null,\n        viewType: null,\n        firstCode: null\n      },\n      result: {}\n    };\n\n    function extend(a, b) {\n      for (var i in b) {\n        a[i] = b[i];\n      }\n\n      return a;\n    }\n\n    function toJSON(str) {\n      var obj = null;\n\n      try {\n        obj = JSON.parse(str);\n      } catch (e) {\n        console.error(e);\n        return null;\n      }\n\n      return obj;\n    }\n\n    function addMenu(target, path, val) {\n      var patharr = path.split(\"/\"),\n          cpath = patharr.shift(),\n          currentTarget = target[cpath];\n\n      if (!currentTarget) {\n        return;\n      }\n\n      while (cpath = patharr.shift()) {\n        currentTarget.function = currentTarget.function || [];\n        var find = currentTarget.function.find(function (e) {\n          return e.functionCode == cpath;\n        }),\n            item;\n\n        if (!find) {\n          item = {\n            \"functionCode\": cpath,\n            \"parentCode\": currentTarget.functionCode\n          };\n          currentTarget.function.push(item);\n        } else {\n          item = find;\n        }\n\n        if (patharr.length == 0) {\n          extend(item, val || {});\n        }\n\n        currentTarget = item;\n      }\n    }\n\n    window.document.title = '';\n\n    function includePath(path) {\n      return _INCLUDES.some(function (e) {\n        return path.indexOf(e) != -1;\n      });\n    }\n\n    factory.getCurrentUser = function (callback) {\n      var deferred = $q.defer();\n\n      function getFirstRoleID(str) {\n        var rs;\n\n        if (typeof str === \"string\") {\n          rs = parseInt(str.split(\",\")[0]);\n          console.assert(rs === rs, \"角色ROLEID为空\");\n          return rs === rs ? rs : null;\n        } else {\n          console.warn(\"角色ROLEID不为字符串\");\n          return null;\n        }\n      }\n\n      function getCurrentRoleId(roleId, currentUserRoleId) {\n        if (currentUserRoleId.indexOf(roleId) != -1) {\n          return roleId;\n        }\n\n        return getFirstRoleID(currentUserRoleId);\n      }\n\n      serviceProxy.get(loginService, 'getCurrentUser', null, function (result) {\n        console.log(\"getCurrentUser\", ((new Date() - window.__loadedTime__) / 1000).toFixed(3) + \"s\");\n\n        if (result != null && result != \"\" && result.code == 0 && result.data) {\n          factory.user = result.data;\n          factory.user.usercurrentRoleID = factory.user.currentRoleID = getCurrentRoleId(roleId, factory.user.roleID);\n          factory.user.usercurrentRoleID += \"\";\n          factory.user.currentRoleID += \"\";\n          factory.user.isAuthenticated = true;\n          deferred.resolve(result.data);\n          changeAuth(true);\n          var currentUrl = document.location.href;\n\n          if (typeof callback == \"function\") {\n            callback(factory.user);\n          }\n\n          psTreeData.getCurrentUser(factory.user);\n\n          if (result.data.loginTimes == 0 && currentUrl.indexOf('password.html') < 0) {\n            window.location.href = \"../app-uc/password.html\";\n          }\n        } else {\n          deferred.reject(\"error\");\n          changeAuth(false);\n        }\n      });\n      return deferred.promise;\n    };\n\n    factory.login = function (account, password, callback) {\n      serviceProxy.get(loginService, 'login', [account, password], function (result) {\n        if (result != null && result != \"\" && result.code == 0 && result.data) {\n          factory.user = result.data;\n          factory.user.isAuthenticated = true;\n          changeAuth(true);\n        } else {\n          factory.result = result;\n          changeAuth(false);\n        }\n      });\n    };\n\n    factory.loginCallback = function (account, password, callback) {\n      serviceProxy.get(loginService, 'login', [account, password], callback);\n    };\n\n    factory.logout = function () {\n      serviceProxy.get(loginService, 'logout', null, function (result) {\n        if (result != null && result != \"\" && result.code == 0) {\n          var dt = result.data;\n          dt = dt[0] == \"/\" && dt.slice(1) || dt;\n          window.location.href = \"../\" + dt;\n          factory.user = {};\n          factory.user.isAuthenticated = false;\n          changeAuth(false);\n        }\n      });\n    };\n    /**\n     * 修改密码\n     */\n\n\n    factory.modifyPassword = function (email, password, newPassword, callBack) {\n      serviceProxy.get(loginService, \"modifyPassword\", [email, password, newPassword], callBack);\n    };\n    /**\n     * 超级管理员切换用户\n     * loginName  登录名称\n     */\n\n\n    factory.loginin = function (loginName, callBack) {\n      serviceProxy.get(loginService, \"loginin\", loginName, callBack);\n    };\n\n    factory.redirectToLogin = function () {\n      $rootScope.$broadcast('redirectToLogin', null);\n    };\n    /**\n     * 跳转路径的切换，解决方案优先行业\n     */\n\n\n    factory.changePos = function () {\n      var loginChangedefer = $q.defer();\n      var defer = $q.defer();\n\n      if (factory.user ? factory.user.appData == null : true) {\n        $rootScope.$on('loginStatusChanged', function (event) {\n          loginChangedefer.resolve({\n            appData: factory.user.appData,\n            industry: factory.user.industry\n          });\n        });\n      } else {\n        loginChangedefer.resolve({\n          appData: factory.user.appData,\n          industry: factory.user.industry\n        });\n      }\n\n      loginChangedefer.promise.then(function (data) {\n        // 根据角色ID查找当前配置的tab页签\n        var domainPath = factory && factory.user && factory.user.domainPath;\n\n        if (!domainPath) {\n          throw new Error(\"invalid user data\");\n          return;\n        }\n\n        var match = /\\/(\\d+)\\/$/.exec(domainPath),\n            rootId = match ? match[1] : null;\n\n        if (!rootId) {\n          throw new Error(\"invalid user domainPath\");\n          return;\n        }\n\n        $state.params.id = rootId;\n        var currentRole = factory.user.currentRoleID;\n        console.log(currentRole);\n\n        function getPath(domainPath) {\n          var length = domainPath.split(\"/\").length - 4,\n              dics = [\"index\", \"navigate\", \"factory\", \"production\", \"devicegroup\"];\n          return dics[length] || \"devicegroup\";\n        }\n\n        userEnterpriseService.queryEnterpriseRole(function (returnObj) {\n          if (returnObj.code == 0) {\n            var find = returnObj.data.find(function (ele) {\n              if (ele.roleID == 127260997560018) {\n                return false;\n              }\n\n              ;\n\n              if (currentRole) {\n                return currentRole == ele.roleID;\n              } else {\n                return factory.user.roleID.indexOf(ele.roleID) !== -1;\n              }\n            });\n            psConfig.setRoleValues(find.values);\n            var promise = psConfig.getRoleValues().then(function (values) {\n              var tab = values.children[0],\n                  index = getPath(domainPath),\n                  viewId = tab.viewId;\n\n              if (viewId == \"177280852260000\" && index) {\n                window.location.href = \"./index_freeboard.html#/prod_dashboard/0/\" + rootId + \"/0/0/0/\" + viewId + \"/\" + index;\n                return;\n              }\n\n              if (viewId != \"177280852260000\" && /\\d+/.test(viewId + \"\")) {\n                window.location.href = \"./index_freeboard.html#/prod_dashboard/0/\" + rootId + \"/0/0/0/\" + viewId + \"/index\";\n                return;\n              }\n\n              return psUiRouterHandler(tab);\n            });\n            promise && promise.then(function (d) {\n              var name = d[0],\n                  args = d[1],\n                  hashChange = function hashChange(e) {\n                var href = window.location.href.replace(\"index.html\", \"index_freeboard.html\");\n                window.location.href = href;\n                window.removeEventListener(\"hashchange\", hashChange);\n              };\n\n              args.id = rootId;\n              $state.go.apply($state, d);\n              window.addEventListener(\"hashchange\", hashChange);\n            });\n            /* psConfig.getRoleValues().then(function (values) {\n              var FIRST_TAB_PATH = values.children[0];\n              return psUiRouterHandler(FIRST_TAB_PATH);\n            }).then(function (d) {\n              var name = d[0],\n                args = d[1],\n                hashChange = function (e) {\n                  var href = window.location.href.replace(\"index.html\", \"index_freeboard.html\");\n                  window.location.href = href;\n                  window.removeEventListener(\"hashchange\", hashChange);\n                };\n              args.id = rootId;\n              $state.go.apply($state, d);\n              window.addEventListener(\"hashchange\", hashChange);\n            }); */\n          }\n        });\n      });\n      return defer.promise;\n    };\n\n    function changeAuth(loggedIn) {\n      if (loggedIn) {\n        factory.user.userId = factory.user.userID; // 设置企业ICON\n\n        if (factory.user.enterprise != null) {\n          if (factory.user.enterprise.enterpriseLogo != null && factory.user.enterprise.enterpriseLogo != \"\") {\n            var url = serviceProxy.origin + \"/\" + factory.user.enterprise.enterpriseLogo;\n            factory.user.enterprise.enterpriseLogo = url;\n            factory.user.enterprise[\"logoStatus\"] = \"0\";\n          } else {\n            factory.user.enterprise.enterpriseLogo = \"../images/enterprise/logo.svg\";\n          }\n        } else {\n          var logo = {\n            \"enterpriseLogo\": \"../images/enterprise/logo.svg\"\n          };\n          factory.user.enterprise = logo;\n        }\n\n        factory.user.isAuthenticated = loggedIn;\n        $rootScope.$broadcast('loginStatusChanged', loggedIn);\n        /**\n         serviceProxy.get(\"resourceUIService\", 'getAppData', null, function(result) {\n          if(result != null && result != \"\" && result.code == 0) {\n            factory.user.appData = result.data;\n            factory.user.isAuthenticated = loggedIn;\n            if(defer) {\n              defer();\n            }\n            delete factory.user.wait;\n            $rootScope.$broadcast('loginStatusChanged', loggedIn);\n          } else {\n           }\n        });*/\n      } else {\n        factory.user.isAuthenticated = loggedIn;\n        $rootScope.$broadcast('loginStatusChanged', loggedIn);\n      }\n    }\n\n    ;\n\n    factory.rootHandler = function ($scope, $location) {\n      var absUrl = $location.absUrl().split(\"#\")[0];\n\n      if (absUrl.search(\"/app-oc/\") > -1) {\n        //运营中心\n        $scope.localMenuCode = \"F01\";\n      } else if (absUrl.search(\"/app-sc/\") > -1) {\n        //服务中心\n        $scope.localMenuCode = \"F02\";\n      } else if (absUrl.search(\"/app-ac/\") > -1) {\n        //应用中心\n        $scope.localMenuCode = \"F03\";\n      } else if (absUrl.search(\"/app-uc/\") > -1) {\n        //用户中心\n        $scope.localMenuCode = \"F04\";\n      } else if (absUrl.search(\"/app-help/\") > -1) {\n        //帮助中心\n        $scope.localMenuCode = \"F05\";\n      } //权限没有加载完成时跳出\n\n\n      if (!$scope.menuitems[\"isloaded\"]) {\n        return;\n      }\n      /** 暂时写死APP-FREE-STYLE不受权限控制，之后通过权限进行重新配置 */\n\n\n      if (isFromFreeStyle) {\n        return;\n      }\n      /** 暂时写死APP-FREE-STYLE不受权限控制，之后通过权限进行重新配置 */\n\n\n      $scope.currentMenuCode = null;\n      $scope.treeviewIndex = $location.path();\n      var locationAry = $location.path().split(\"/\");\n      var locationStr;\n      var menuObj;\n\n      if (locationAry.length == 1 || !locationAry[1]) {\n        //没有默认路由时，使用权限第一个M权限，如果M权限没有url则使用其下的一个S权限\n        for (var key in $scope.menuitems) {\n          //\n          if (key.indexOf(\"M\") == 0 && $scope.menuitems[key].parentCode == $scope.localMenuCode && !menuObj) {\n            if ($scope.menuitems[key].url) {\n              if ($scope.defaultRoute) {\n                window.location.href = $scope.defaultRoute;\n              } else {\n                var path = $scope.menuitems[key].url.substr(1);\n                $location.path(path);\n                menuObj = $scope.menuitems[key];\n              }\n\n              return false;\n            } else {\n              $scope.menuitems[key].function.forEach(function (subItem) {\n                if (subItem.functionCode.indexOf(\"S\") == 0 && subItem.url && !menuObj) {\n                  var path = subItem.url.substr(1);\n                  $location.path(path);\n                  menuObj = subItem;\n                  return false;\n                }\n              });\n            }\n          }\n        }\n\n        if (!menuObj) {\n          growl.warning(\"您并没有访问该功能的权限，请联系系统管理人员\", {});\n        }\n\n        return;\n      } else if (locationAry.length > 2) {\n        //两级以上路由时，仅判断到第二级，如有特殊需求可自行扩展\n        locationStr = \"#/\" + locationAry[1] + \"/\" + locationAry[2]; //locationStr = \"#/\"+locationAry[1] + \"/\";\n\n        menuObj = $scope.menuitems[locationStr];\n\n        if (!menuObj) {\n          //如果指定二级路由没有权限，查看0模式下是否存在（告警查询权限）\n          menuObj = $scope.menuitems[\"#/\" + locationAry[1] + \"/0\"];\n        }\n      }\n\n      if (!menuObj) {\n        //如果二级路由0模式下也没有权限，上推到一级路由\n\n        /** 当路径当中带了prod_前缀，不进行校验。 */\n        if (includePath($location.path())) {\n          menuObj = {\n            parentCode: \"M01\"\n          };\n        } else {\n          locationStr = \"#/\" + locationAry[1];\n          var locaStr1 = \"#/\" + locationAry[1] + \"/\";\n          menuObj = $scope.menuitems[locationStr] || $scope.menuitems[locaStr1];\n        }\n      }\n\n      if (typeof menuObj === \"undefined\") {\n        //如果都没有权限，提示权限错误\n        growl.warning(\"您并没有访问该功能的权限，请联系系统管理人员\", {});\n        $location.path($scope.oldTreeviewIndex);\n        return;\n      }\n\n      ;\n      $scope.oldTreeviewIndex = $scope.treeviewIndex;\n\n      if (menuObj) {\n        $scope.currentMenuCode = menuObj.functionCode || null;\n        $scope.firstMenuCode = menuObj.functionCode || null;\n\n        if (menuObj.parentCode.charAt(0) == \"M\") {\n          $scope.firstMenuCode = $scope.menuitems[menuObj.parentCode] ? $scope.menuitems[menuObj.parentCode].functionCode : null;\n        } else {\n          if ($scope.menuitems[menuObj.parentCode].parentCode.charAt(0) == \"M\") {\n            $scope.firstMenuCode = $scope.menuitems[$scope.menuitems[menuObj.parentCode].parentCode].functionCode;\n          }\n        }\n      }\n\n      if ($scope.oldFirstMenuCode != $scope.firstMenuCode && $scope.firstMenuCode != null && $scope.oldFirstMenuCode != null) {\n        $(\"[name='\" + $scope.oldFirstMenuCode + \"']\").css('display', 'none');\n        $(\"[name='\" + $scope.oldFirstMenuCode + \"']\").removeClass('menu-open');\n        $(\"[name='\" + $scope.firstMenuCode + \"']\").css('display', 'block');\n      }\n\n      $scope.oldFirstMenuCode = $scope.firstMenuCode;\n      timeout(function () {\n        $.AdminLTE.layout.fix(); //调整一下页面\n      });\n    };\n\n    factory.initMenus = function ($scope, $location) {\n      function menuhandle(menuInfo) {\n        menuInfo.searchUrl = menuInfo.url ? menuInfo.url.substring(1) + \"/\" : \"\"; //菜单选中状态用\n\n        if (menuInfo.function) {\n          menuInfo.function.forEach(function (handlemenu) {\n            if ($scope.baseConfig && $scope.baseConfig[handlemenu.functionCode]) {\n              handlemenu.name = $scope.baseConfig[handlemenu.functionCode].label;\n              handlemenu.label = $scope.baseConfig[handlemenu.functionCode].sublabel;\n            }\n\n            menuInfo.searchUrl = menuInfo.searchUrl + (handlemenu.url ? handlemenu.url.substring(1) + \"/\" : \"\"); //\n\n            $scope.menuitems[handlemenu.functionCode] = handlemenu;\n\n            if (handlemenu.url) {\n              var url = decodeURIComponent(handlemenu.url);\n              $scope.menuitems[url] = handlemenu;\n            }\n\n            menuhandle(handlemenu);\n          });\n        }\n      }\n\n      $scope.userInfo.functionList.forEach(function (menu) {\n        if ($scope.baseConfig && $scope.baseConfig[menu.functionCode]) {\n          menu.name = $scope.baseConfig[menu.functionCode].label;\n          menu.label = $scope.baseConfig[menu.functionCode].sublabel;\n        }\n\n        $scope.menuitems[menu.functionCode] = menu;\n\n        if (menu.url) {\n          var url = decodeURIComponent(menu.url);\n          $scope.menuitems[url] = menu;\n        }\n\n        ;\n        menuhandle(menu);\n      });\n      $scope.menuitems[\"isloaded\"] = true; //加载完毕\n\n      /** 增加一个方法ADDMENU能自定义写入菜单*/\n\n      /**\n       addMenu($scope.menuitems, \"F01/M02/S117\", {\n        name : \"设备视图管理\",\n        icon : \"fa fa-circle\",\n        url : \"#/rview\"\n      })**/\n\n      factory.rootHandler($scope, $location);\n    };\n\n    factory.getAddressPoint = function (address, callBack) {\n      if (address) {\n        jQuery.ajax({\n          type: \"GET\",\n          url: window.location.protocol + \"//api.map.baidu.com/geocoder/v2/?address=\" + address + \"&output=json&ak=eMekSXxqG1j2wLM57RFN61l8T6eB1EDx\",\n          dataType: \"jsonp\",\n          jsoncallback: 'callBack',\n          success: function success(d) {\n            if (d.status == 0) {\n              if (callBack) {\n                callBack(d.result);\n              }\n            } else {\n              if (callBack) {\n                callBack({\n                  location: {\n                    lat: \"\",\n                    lng: \"\"\n                  }\n                });\n              }\n            }\n          },\n          error: function error(e) {}\n        });\n      } else {\n        if (callBack) {\n          callBack(null);\n        }\n      }\n    };\n\n    if (window.location.hash.indexOf(\"dailyReport\") !== -1) {\n      factory.user.isAuthenticated = true;\n    } else {\n      factory.getCurrentUser();\n    }\n\n    return factory;\n  }]);\n});"],"sourceRoot":"/source/"}