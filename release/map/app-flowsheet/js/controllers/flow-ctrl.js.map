{"version":3,"sources":["app-flowsheet/js/controllers/flow-ctrl.js"],"names":["define","controllers","controller","$scope","$rootScope","$location","$timeout","growl","userEnterpriseService","userLoginUIService","resourceUIService","viewFlexService","userDomainService","solutionUIService","unitService","loc","errorMsg","slide","treeAry","configureView","echartView","myOptions","handleUser","userList","defaultRoute","treeviewIndex","oldTreeviewIndex","currentMenuCode","firstMenuCode","localMenuCode","showMenu","menuitems","$on","rootHandler","menusFilter","item","functionCode","charAt","homeClick","window","open","backClick","location","hash","search","href","indexShow","personalShow","routePathNodes","initModelAtts","obj","idx","count","model","callback","Math","random","icon","alertlv","isLoaded","type","text","label","name","getManagedDevicesByModelId","id","returnObj","code","resources","data","push","getResourceByModelId","getAttrsByModelId","attrs","getKpisByModelId","kpis","urmpTree","ciName","getGroupModels","returnGroup","getModels","concat","rootModelDic","tree","i","parentModelId","addNodes","parentNode","modeid","nodes","length","key","rootModel","handler","initViews","viewId","viewTitle","getAllMyViews","forEach","viewType","$broadcast","logout","domains","initUnit","getAllUnits","units","unitDics","unitCode","unitName","myOptionDic","initstate","init","queryDomainTree","user","userID","domainListTree","domainListDic","domainsAry","domainPath","foreachdomains","lv","domain","breaks","getbreak","getRootModel","selectedParentitem","isAuthenticated","initMenus","evt","d","staffName","userName","userInfo","result","message","errorStatus"],"mappings":"AAAAA,OAAO,CAAC,2BAA4B,SAAUC,GAC5C,aAGAA,EAAYC,WAAW,oBAAqB,CAAC,SAAU,aAAc,YAAa,WAAY,QAAS,wBAAyB,qBAAsB,oBAAqB,kBAAmB,oBAAqB,oBAAqB,cAAe,YAAa,SAAUC,EAAQC,EAAYC,EAAWC,EAAUC,EAAOC,EAAuBC,EAAoBC,EAAmBC,EAAiBC,EAAmBC,EAAmBC,EAAaC,GAC9bZ,EAAOa,SAAW,GAClBb,EAAOc,MAAQ,IAEfd,EAAOe,QAAU,GACjBf,EAAOgB,cAAgB,GAEvBhB,EAAOiB,WAAa,GAEpBjB,EAAOkB,UACPlB,EAAOmB,WAAa,GACpBnB,EAAOoB,SAAW,GAClBpB,EAAOqB,aAAe,sCACtBrB,EAAOsB,cAAgB,GACvBtB,EAAOuB,iBAAmB,GAC1BvB,EAAOwB,gBAAkB,KAEzBxB,EAAOyB,cAAgB,KAEvBzB,EAAO0B,cAAgB,MAEvB1B,EAAO2B,UAAW,EAClB3B,EAAO4B,UAAY,GAEnB5B,EAAO6B,IAAI,sBAAuB,WAChCvB,EAAmBwB,YAAY9B,EAAQE,KAkBzCF,EAAO+B,YAAc,SAAUC,GAC7B,MAAuC,MAAhCA,EAAKC,aAAaC,OAAO,IAGlClC,EAAOmC,UAAY,WACjBC,OAAOC,KAAK,8BAGdrC,EAAOsC,UAAY,YAC4B,EAAzCC,SAASC,KAAKC,OAAO,mBAA2D,EAAlCF,SAASC,KAAKC,OAAO,UACrEF,SAASG,KAAO,uCACkC,EAAzCH,SAASC,KAAKC,OAAO,mBAC9BF,SAASG,KAAO,0CAIpBzC,EAAW0C,WAAY,EACvB1C,EAAW2C,cAAe,EAC1B5C,EAAO6C,eAAiB,GAExB,IAmEIC,EAAgB,SAAuBC,EAAKC,GAC9CD,EAAIE,MAAQ,EACZ,IArEuCC,EAAOC,EAsCCD,EAAOC,EAeTD,EAgBhCE,KAAKC,SAWlB,OAVAN,EAAIO,KAAOP,EAAIO,KAAOP,EAAIO,KAAO,mBACjCP,EAAIQ,QAAU,WAEdR,EAAIS,SAAW,EACfT,EAAIU,KAAO,EACXV,EAAIW,KAAOX,EAAIY,MACfZ,EAAIa,KAAOb,EAAIY,MA3EG,WADqBT,EA6E1BH,GA5EHU,KACRlD,EAAkBsD,2BAA2BX,EAAMY,GAAI,SAAUC,GAC/D,GAAsB,GAAlBA,EAAUC,KAAW,CACvB,IAAIC,EAAYF,EAAUG,KAC1BhB,EAAMe,UAAYA,EAClBf,EAAMe,UAAUE,KAAK,CACnBL,GAAI,EACJH,MAAO,MAGLR,GACFA,OAON5C,EAAkB6D,qBAAqBlB,EAAMY,GAAI,SAAUC,GACzD,GAAsB,GAAlBA,EAAUC,KAAW,CACvB,IAAIC,EAAYF,EAAUG,KAC1BhB,EAAMe,UAAYA,EAClBf,EAAMe,UAAUE,KAAK,CACnBL,GAAI,EACJH,MAAO,MAGLR,GACFA,OASuCD,EAwC9BH,EAvCjBxC,EAAkB8D,kBAAkBnB,EAAMY,GAAI,SAAUC,GAChC,GAAlBA,EAAUC,OACZd,EAAMoB,MAAQP,EAAUG,KACxBhB,EAAMM,SAAWN,EAAMM,SAAW,EAE9BL,GACFA,OAQuCD,EA0B7BH,EAzBhBxC,EAAkBgE,iBAAiBrB,EAAMY,GAAI,SAAUC,GAC/B,GAAlBA,EAAUC,OACZd,EAAMsB,KAAOT,EAAUG,KACvBhB,EAAMsB,KAAKL,KAAK,CACdL,GAAI,EACJH,MAAO,SAqBNZ,GAGL0B,EAAW,SAAkBC,GAkD/BhE,EAAkBiE,eAAe,SAAUC,GACjB,GAApBA,EAAYZ,MACdzD,EAAkBsE,UAAU,SAAUd,GACpCA,EAAUG,KAAOH,EAAUG,KAAKY,OAAOF,EAAYV,MApD3C,SAAiBH,GAC7B,GAAsB,GAAlBA,EAAUC,KAAW,CACvBzD,EAAkBwE,aAAe,GACjC,IAAIC,EAAOjB,EAAUG,KAErB,IAAK,IAAIe,KAAKD,EAAM,CAClB,IAAIjC,EAAMiC,EAAKC,GACVjF,EAAO6C,eAAeE,EAAImC,iBAAgBlF,EAAO6C,eAAeE,EAAImC,eAAiB,IAC1FlF,EAAO6C,eAAeE,EAAImC,eAAef,KAAKpB,GACzC/C,EAAO6C,eAAeE,EAAIe,MAAK9D,EAAO6C,eAAeE,EAAIe,IAAM,IACpEvD,EAAkBwE,aAAahC,EAAIe,IAAMf,EACzCD,EAAcC,GAGhB,IAAIoC,EAAW,SAASA,EAASC,GAC/B,IAAK,IAAIC,KAAUrF,EAAO6C,eACxB,GAAIwC,GAAUD,EAAWtB,GAAI,CAG3B,IAAK,IAAImB,KAFTG,EAAWE,MAAQtF,EAAO6C,eAAewC,GAE3BD,EAAWE,MACvBH,EAASC,EAAWE,MAAML,IAGG,GAA3BG,EAAWE,MAAMC,SACnBH,EAAWE,MAAQ,QAQ3B,IAAK,IAAIE,KAFTL,EAAS5E,EAAkBkF,WAEXzF,EAAO6C,eACrB,GAAI2C,GAAOjF,EAAkBkF,UAAU3B,KAAOvD,EAAkBwE,aAAaS,GAC3E,IAAK,IAAIP,KAAKjF,EAAO6C,eAAe2C,GAClCL,EAASnF,EAAO6C,eAAe2C,GAAKP,IAC/B1E,EAAkBkF,UAAUH,QAAO/E,EAAkBkF,UAAUH,MAAQ,IAC5E/E,EAAkBkF,UAAUH,MAAMnB,KAAKnE,EAAO6C,eAAe2C,GAAKP,IAKxE1E,EAAkBwE,aAAaxE,EAAkBkF,UAAU3B,IAAMvD,EAAkBkF,UACnFzF,EAAO+E,aAAexE,EAAkBwE,aACxC/E,EAAOyF,UAAYlF,EAAkBkF,UACrCzF,EAAOe,QAAUiE,GAQfU,CAAQ3B,QAMhB,SAAS4B,IACP3F,EAAOgB,cAAgB,CAAC,CACtB4E,OAAQ,EACRC,UAAW,MAEb7F,EAAOiB,WAAa,CAAC,CACnB2E,OAAQ,EACRC,UAAW,MAEbrF,EAAgBsF,cAAc,SAAU/B,GAChB,GAAlBA,EAAUC,OACZD,EAAUG,KAAK6B,QAAQ,SAAU/D,GACV,aAAjBA,EAAKgE,UACPhG,EAAOgB,cAAcmD,KAAKnC,GAGP,cAAjBA,EAAKgE,UACPhG,EAAOiB,WAAWkD,KAAKnC,KAG3BhC,EAAOiG,WAAW,cAAe,CAC/B/B,KAAQlE,EAAOgB,mBAMvBhB,EAAOkG,OAAS,WACd5F,EAAmB4F,UAGrBlG,EAAOmG,QAAU,GAoCjB,SAASC,IACPzF,EAAY0F,YAAY,SAAUtC,GAChC,GAAsB,GAAlBA,EAAUC,KAAW,CAKvB,IAAK,IAAIiB,KAJTtE,EAAY2F,MAAQvC,EAAUG,KAC9BlE,EAAOkB,UAAY6C,EAAUG,KAC7BvD,EAAY4F,SAAW,GAETvG,EAAOkB,UACnBP,EAAY4F,SAASvG,EAAOkB,UAAU+D,GAAGuB,UAAYxG,EAAOkB,UAAU+D,GAAGwB,SACrC,MAAhCzG,EAAOkB,UAAU+D,GAAGuB,UAAoD,UAAhCxG,EAAOkB,UAAU+D,GAAGuB,WAAsB7F,EAAY4F,SAASvG,EAAOkB,UAAU+D,GAAGuB,UAAY,IAG7IxG,EAAO0G,YAAc/F,EAAY4F,YAKvC,IAAII,GAAY,EAEZC,EAAO,WACLD,IACJA,GAAY,EAjCZlG,EAAkBoG,gBAAgBvG,EAAmBwG,KAAKC,OAAQ,SAAU7C,GAC1ElE,EAAOgH,eAAiB9C,EAAK8C,eAC7BhH,EAAOiH,cAAgB/C,EAAK+C,cAC5B,IAAIC,EAAa,CAAC,CAChBC,WAAY,GACZzD,KAAM,OAjBS,SAAS0D,EAAejB,EAASkB,EAAIH,GACxDf,EAAQJ,QAAQ,SAAUuB,GACxBA,EAAO5D,KAZI,SAAkB2D,GAG/B,IAFA,IAAIE,EAAS,GAEJtC,EAAI,EAAGA,EAAIoC,EAAIpC,IACtBsC,GAAU,IAGZ,OAAOA,EAKSC,CAASH,GAAMC,EAAO5D,KACpCwD,EAAW/C,KAAKmD,GAEZA,EAAOhC,OACT8B,EAAeE,EAAOhC,MAAO+B,EAAK,EAAGH,KAavCE,CAAepH,EAAOgH,eAAgB,EAAGE,GACzClH,EAAOmG,QAAUe,IA2BnB3G,EAAkBkH,aAAa,SAAU1D,GACjB,GAAlBA,EAAUC,OACZD,EAAUG,KAAKN,KAAOG,EAAUG,KAAKP,MACrCI,EAAUG,KAAKR,KAAOK,EAAUG,KAAKP,MACrCpD,EAAkBkF,UAAY1B,EAAUG,KACxClE,EAAO0H,mBAAqB3D,EAAUG,KACtCO,SAKDnE,EAAmBwG,KAAKa,iBAgB3BvB,IACAQ,IAEAjB,IACArF,EAAmBsH,UAAU5H,EAAQE,IAnBrCF,EAAO6B,IAAI,qBAAsB,SAAUgG,EAAKC,GAC1CxH,EAAmBwG,KAAKa,iBAC1B1H,EAAW8H,UAAYzH,EAAmBwG,KAAKkB,SAC/ChI,EAAOiI,SAAW3H,EAAmBwG,KACrCV,IACAQ,IAEAjB,IACArF,EAAmBsH,UAAU5H,EAAQE,KAErCF,EAAOa,SAAWP,EAAmB4H,OAAOC,QAC5CnI,EAAOoI,YAAc","file":"app-flowsheet/js/controllers/flow-ctrl.js","sourcesContent":["define(['controllers/controllers'], function (controllers) {\n  'use strict'; //根据接口调用自定义视图获取\n  //用户登录userLoginUIService\n\n  controllers.controller('flowConfigureCtrl', ['$scope', '$rootScope', '$location', '$timeout', 'growl', 'userEnterpriseService', 'userLoginUIService', 'resourceUIService', 'viewFlexService', 'userDomainService', 'solutionUIService', 'unitService', '$location', function ($scope, $rootScope, $location, $timeout, growl, userEnterpriseService, userLoginUIService, resourceUIService, viewFlexService, userDomainService, solutionUIService, unitService, loc) {\n    $scope.errorMsg = \"\";\n    $scope.slide = \"1\"; //    $scope.powers = {};\n\n    $scope.treeAry = [];\n    $scope.configureView = []; //组态视图集合\n\n    $scope.echartView = []; //组态视图集合\n\n    $scope.myOptions;\n    $scope.handleUser = \"\";\n    $scope.userList = \"\";\n    $scope.defaultRoute = \"../app-oc/index.html#/processdesign\";\n    $scope.treeviewIndex = \"\";\n    $scope.oldTreeviewIndex = \"\";\n    $scope.currentMenuCode = null; //当前的菜单编码\n\n    $scope.firstMenuCode = null; //第一层的菜单编码\n\n    $scope.localMenuCode = \"F01\"; //判断使用哪一个服务中心，用来替代localIndex\n\n    $scope.showMenu = false;\n    $scope.menuitems = {}; // 路由跳转成功后触发\n\n    $scope.$on('$routeChangeSuccess', function () {\n      userLoginUIService.rootHandler($scope, $location);\n    }); //    var setPower = function(pow, len) {\n    //      pow = pow.substring(0, len);\n    //      $scope.powers[pow] = true;\n    //      if(len > 5) {\n    //        setPower(pow, len - 2);\n    //      }\n    //    }\n    //    var initPower = function() {\n    //      for(var i in userLoginUIService.user.functionCodeSet) {\n    //        var funCode = userLoginUIService.user.functionCodeSet[i];\n    //        $scope.powers[funCode] = true;\n    //        if(funCode.length > 5) {\n    //          setPower(funCode, funCode.length - 2);\n    //        }\n    //      }\n    //    }\n\n    $scope.menusFilter = function (item) {\n      return item.functionCode.charAt(0) === \"S\";\n    };\n\n    $scope.homeClick = function () {\n      window.open(\"http://www.proudsmart.com\");\n    };\n\n    $scope.backClick = function () {\n      if (location.hash.search(\"#/displayView\") > -1 || location.hash.search(\"#/flow\") > -1) {\n        location.href = \"../app-oc/index.html#/processdesign\";\n      } else if (location.hash.search(\"#/processView\") > -1) {\n        location.href = \"../app-oc/index.html#/workorderrecord\";\n      }\n    };\n\n    $rootScope.indexShow = false;\n    $rootScope.personalShow = true;\n    $scope.routePathNodes = {};\n\n    var getResources = function getResources(model, callback) {\n      if (model.type == \"Device\") {\n        resourceUIService.getManagedDevicesByModelId(model.id, function (returnObj) {\n          if (returnObj.code == 0) {\n            var resources = returnObj.data;\n            model.resources = resources;\n            model.resources.push({\n              id: 0,\n              label: \"无\"\n            });\n\n            if (callback) {\n              callback();\n            }\n          }\n\n          ;\n        });\n      } else {\n        resourceUIService.getResourceByModelId(model.id, function (returnObj) {\n          if (returnObj.code == 0) {\n            var resources = returnObj.data;\n            model.resources = resources;\n            model.resources.push({\n              id: 0,\n              label: \"无\"\n            });\n\n            if (callback) {\n              callback();\n            }\n          }\n\n          ;\n        });\n      }\n    };\n\n    var getResourceAttrs = function getResourceAttrs(model, callback) {\n      resourceUIService.getAttrsByModelId(model.id, function (returnObj) {\n        if (returnObj.code == 0) {\n          model.attrs = returnObj.data;\n          model.isLoaded = model.isLoaded + 1;\n\n          if (callback) {\n            callback();\n          }\n        }\n\n        ;\n      });\n    };\n\n    var getResourceKpis = function getResourceKpis(model) {\n      resourceUIService.getKpisByModelId(model.id, function (returnObj) {\n        if (returnObj.code == 0) {\n          model.kpis = returnObj.data;\n          model.kpis.push({\n            id: 0,\n            label: \"无\"\n          });\n        }\n\n        ;\n      });\n    };\n\n    var initModelAtts = function initModelAtts(obj, idx) {\n      obj.count = 0;\n      var random = Math.random();\n      obj.icon = obj.icon ? obj.icon : 'fa fa-building-o';\n      obj.alertlv = \"bg-green\"; //random > 0.75 ? \"bg-red\" : (random > 0.5 ? \"bg-orange\" : (random > 0.25 ? \"bg-yellow\" : \"bg-green\"));\n\n      obj.isLoaded = 0;\n      obj.type = 0;\n      obj.text = obj.label;\n      obj.name = obj.label;\n      getResources(obj);\n      getResourceAttrs(obj);\n      getResourceKpis(obj);\n      return obj;\n    };\n\n    var urmpTree = function urmpTree(ciName) {\n      var handler = function handler(returnObj) {\n        if (returnObj.code == 0) {\n          resourceUIService.rootModelDic = {};\n          var tree = returnObj.data;\n\n          for (var i in tree) {\n            var obj = tree[i];\n            if (!$scope.routePathNodes[obj.parentModelId]) $scope.routePathNodes[obj.parentModelId] = [];\n            $scope.routePathNodes[obj.parentModelId].push(obj);\n            if (!$scope.routePathNodes[obj.id]) $scope.routePathNodes[obj.id] = [];\n            resourceUIService.rootModelDic[obj.id] = obj;\n            initModelAtts(obj);\n          }\n\n          var addNodes = function addNodes(parentNode) {\n            for (var modeid in $scope.routePathNodes) {\n              if (modeid == parentNode.id) {\n                parentNode.nodes = $scope.routePathNodes[modeid];\n\n                for (var i in parentNode.nodes) {\n                  addNodes(parentNode.nodes[i]);\n                }\n\n                if (parentNode.nodes.length == 0) {\n                  parentNode.nodes = null;\n                }\n              }\n            }\n          };\n\n          addNodes(resourceUIService.rootModel);\n\n          for (var key in $scope.routePathNodes) {\n            if (key != resourceUIService.rootModel.id && !resourceUIService.rootModelDic[key]) {\n              for (var i in $scope.routePathNodes[key]) {\n                addNodes($scope.routePathNodes[key][i]);\n                if (!resourceUIService.rootModel.nodes) resourceUIService.rootModel.nodes = [];\n                resourceUIService.rootModel.nodes.push($scope.routePathNodes[key][i]);\n              }\n            }\n          }\n\n          resourceUIService.rootModelDic[resourceUIService.rootModel.id] = resourceUIService.rootModel;\n          $scope.rootModelDic = resourceUIService.rootModelDic;\n          $scope.rootModel = resourceUIService.rootModel;\n          $scope.treeAry = tree;\n        }\n      };\n\n      solutionUIService.getGroupModels(function (returnGroup) {\n        if (returnGroup.code == 0) {\n          resourceUIService.getModels(function (returnObj) {\n            returnObj.data = returnObj.data.concat(returnGroup.data);\n            handler(returnObj);\n          });\n        }\n      });\n    };\n\n    function initViews() {\n      $scope.configureView = [{\n        viewId: 0,\n        viewTitle: '无'\n      }];\n      $scope.echartView = [{\n        viewId: 0,\n        viewTitle: '无'\n      }];\n      viewFlexService.getAllMyViews(function (returnObj) {\n        if (returnObj.code == 0) {\n          returnObj.data.forEach(function (item) {\n            if (item.viewType == \"configure\") {\n              $scope.configureView.push(item);\n            }\n\n            if (item.viewType == \"designView\") {\n              $scope.echartView.push(item);\n            }\n          });\n          $scope.$broadcast('RAPPIDVIEWS', {\n            \"data\": $scope.configureView\n          });\n        }\n      });\n    }\n\n    $scope.logout = function () {\n      userLoginUIService.logout();\n    };\n\n    $scope.domains = [];\n\n    var getbreak = function getbreak(lv) {\n      var breaks = \"\";\n\n      for (var i = 0; i < lv; i++) {\n        breaks += \"*\";\n      }\n\n      return breaks;\n    };\n\n    var foreachdomains = function foreachdomains(domains, lv, domainsAry) {\n      domains.forEach(function (domain) {\n        domain.text = getbreak(lv) + domain.text;\n        domainsAry.push(domain);\n\n        if (domain.nodes) {\n          foreachdomains(domain.nodes, lv + 2, domainsAry);\n        }\n      });\n    };\n\n    var domainTreeQuery = function domainTreeQuery() {\n      userDomainService.queryDomainTree(userLoginUIService.user.userID, function (data) {\n        $scope.domainListTree = data.domainListTree;\n        $scope.domainListDic = data.domainListDic;\n        var domainsAry = [{\n          domainPath: \"\",\n          text: \"无\"\n        }];\n        foreachdomains($scope.domainListTree, 0, domainsAry);\n        $scope.domains = domainsAry;\n      });\n    };\n\n    function initUnit() {\n      unitService.getAllUnits(function (returnObj) {\n        if (returnObj.code == 0) {\n          unitService.units = returnObj.data;\n          $scope.myOptions = returnObj.data;\n          unitService.unitDics = {};\n\n          for (var i in $scope.myOptions) {\n            unitService.unitDics[$scope.myOptions[i].unitCode] = $scope.myOptions[i].unitName;\n            if ($scope.myOptions[i].unitCode == \"NA\" || $scope.myOptions[i].unitCode == \"Number\") unitService.unitDics[$scope.myOptions[i].unitCode] = \"\";\n          }\n\n          $scope.myOptionDic = unitService.unitDics;\n        }\n      });\n    }\n\n    var initstate = false;\n\n    var init = function init() {\n      if (initstate) return;\n      initstate = true;\n      domainTreeQuery();\n      resourceUIService.getRootModel(function (returnObj) {\n        if (returnObj.code == 0) {\n          returnObj.data.name = returnObj.data.label;\n          returnObj.data.text = returnObj.data.label;\n          resourceUIService.rootModel = returnObj.data;\n          $scope.selectedParentitem = returnObj.data;\n          urmpTree();\n        }\n      });\n    };\n\n    if (!userLoginUIService.user.isAuthenticated) {\n      $scope.$on('loginStatusChanged', function (evt, d) {\n        if (userLoginUIService.user.isAuthenticated) {\n          $rootScope.staffName = userLoginUIService.user.userName;\n          $scope.userInfo = userLoginUIService.user;\n          initUnit();\n          init(); //          initPower();\n\n          initViews();\n          userLoginUIService.initMenus($scope, $location);\n        } else {\n          $scope.errorMsg = userLoginUIService.result.message;\n          $scope.errorStatus = 1;\n        }\n      });\n    } else {\n      initUnit();\n      init(); //      initPower();\n\n      initViews();\n      userLoginUIService.initMenus($scope, $location);\n    }\n  }]);\n});"],"sourceRoot":"/source/"}