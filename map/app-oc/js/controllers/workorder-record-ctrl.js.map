{"version":3,"sources":["app-oc/js/controllers/workorder-record-ctrl.js"],"names":["define","controllers","BootstrapDialog","initController","$scope","$rootScope","$location","$routeParams","$timeout","growl","userLoginUIService","userEnterpriseService","Info","$route","ticketTaskService","ticketCategoryService","console","log","processType","activeListTab","ordercount","notdeal","dealing","done","formatDate","str","newDateJson","Format","GetDateCategoryStrByLabel","herfList","name","data","state","undefined","dataList","ticketNo","templateURL","url","$","trim","id","location","href","getRecordCount","getTicketTasksByStatus","returnObj","code","length","getRecordData","status","recordData","columns","title","visible","orderable","menuitems","columnDefs","targets","render","type","full","priorityBg","priorityName","$broadcast","Event","WORKORDERRECORDINIT","on","e","target","closest","removeClass","children","addClass","aname","attr","$apply","activeTab","text","getTicketCategorys","i","workflowId","tab","init","resourceUIService","workflowService","faultKnowledgeUIService","workType","orderType","priorityCode","workList","tasksList","historyData","process","processTime","myObj","myObjTop","devicesAll","allFault","get","info","myDicts","priorityCodeList","priorityData","getDevicesByCondition","res","getAllFaultKnowledges","findFault","findFaultKnowledgeByModelId","orderAddData","deviceId","modelId","initData","faultList","formAryList","definitions","startList","orderTicket","processDefinitionId","getTicket","flowId","value","commitTime","finishedTime","values","getWorkflowById","resAry","startAttributeDefinitions","vList","typePro","label","dataType","push","JSON","stringify","getTicketTasks","returnObj1","searchList","taskStatus","historyGo","save","detail","ticketStatus","doTask","success","navigator","userAgent","toLowerCase","indexOf","browserClass","display","margin-top","getTicketTaskById","taskObj","attributeDefinitions","statList","isMyTicketTask","FileUploader","$controller","userUIService","sparePartUIService","projectUIService","maintenanceUIService","sparePartsArray","devicesList","imgList","selectMajor","taskList","ticketTitle","ticketCommitTime","ticketCreatorName","customerName","projectName","projectID","modelName","modelID","deviceSn","faultNo","faultPhenomenon","selectList","urlService","uploadFileUrl","stockOrderItemList","ticketTaskDesc","addAttachment","addList","n","allSparePartsList","index","j","sparePartsInitList","warning","unshift","stockNumber","isEdit","serviceOrigin","toggle","click","uploadExcel","config","uploader","uploadAll","$on","event","args","response","file","onAfterAddingFile","fileItem","queue","queueLimit","removeFromQueue","saveAttachment","selectStatus","tmp","editNumber","cancelAttach","splice","processTask","DataTable","serializeArray","spareList","valueList","statusSel","itemsByDevice","getInspectionItemsByDeviceId","forEach","obj","getAllSpareParts","newObj","maintenanceContent","variables","projectId","device","customerID","images","orderList","allSpareParts","projectsList","projectsDic","queryProject","findProjectsByCondition","item","ticketLogService","processService","historyList","workOrderId","workOrderDetail","resData","getByTicketNo"],"mappings":"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","file":"app-oc/js/controllers/workorder-record-ctrl.js","sourcesContent":["define(['controllers/controllers', 'bootstrap-dialog'], function (controllers, BootstrapDialog) {\n  'use strict';\n\n  controllers.initController('WorkOrderRecordCtrl', ['$scope', '$rootScope', '$location', '$routeParams', '$timeout', 'growl', 'userLoginUIService', 'userEnterpriseService', 'Info', '$route', 'ticketTaskService', 'ticketCategoryService', function ($scope, $rootScope, $location, $routeParams, $timeout, growl, userLoginUIService, userEnterpriseService, Info, $route, ticketTaskService, ticketCategoryService) {\n    console.log('进入工单任务');\n    $scope.processType = {};\n    $scope.activeListTab = \"tab1\"; //工单计数\n\n    $scope.ordercount = {\n      \"notdeal\": 0,\n      \"dealing\": 0,\n      \"done\": 0 //获取工单流程定义\n\n    };\n\n    function getProcessDefinitions() {\n      ticketCategoryService.getTicketCategorys(function (returnObj) {\n        if (returnObj.code == 0) {\n          for (var i in returnObj.data) {\n            $scope.processType[returnObj.data[i].workflowId] = returnObj.data[i];\n          }\n        }\n      });\n    }\n\n    ; //格式化时间\n\n    var formatDate = function formatDate(str) {\n      if (str) {\n        str = newDateJson(str).Format(GetDateCategoryStrByLabel());\n      }\n\n      return str;\n    };\n\n    $scope.herfList = function (name, data, state) {\n      //state == 是工单任务的三种状态（待处理，处理中，已完成）\n      $rootScope.dataList = data;\n\n      if (data != undefined && data.ticketNo != null) {\n        if (data.templateURL != \"\" && data.templateURL != undefined && data.templateURL != null) {\n          var url = $.trim(data.templateURL) + \"/\" + data.id; // var url = \"../app-oc/index.html#/deviceTask/\" + data.id;\n\n          location.href = url;\n        } else {\n          location.href = \"index.html#/orderdetail/\" + data.id + \"/task\";\n        } //location.href = \"index.html#/orderdetail/\" + data.id + \"/task\"+\"/\"+state;\n        //location.href = \"../app-flowsheet/index.html#/processView/\" + data.id ;\n\n      }\n    };\n    /**\n     * 获取任务数量\n     *\n     */\n\n\n    $scope.getRecordCount = function () {\n      ticketTaskService.getTicketTasksByStatus(10, function (returnObj) {\n        if (returnObj.code == 0) {\n          $scope.ordercount.notdeal = returnObj.data.length;\n        }\n      });\n      ticketTaskService.getTicketTasksByStatus(100, function (returnObj) {\n        if (returnObj.code == 0) {\n          $scope.ordercount.dealing = returnObj.data.length;\n        }\n      });\n      ticketTaskService.getTicketTasksByStatus(200, function (returnObj) {\n        if (returnObj.code == 0) {\n          $scope.ordercount.done = returnObj.data.length;\n        }\n      });\n    }; //获取工单任务数据\n\n\n    $scope.getRecordData = function (status) {\n      // 10 - 待处理 100-处理中 200-已完成\n      ticketTaskService.getTicketTasksByStatus(status, function (returnObj) {\n        if (returnObj.code == 0) {\n          var state = null;\n\n          if (status == 10) {\n            $scope.ordercount.notdeal = returnObj.data.length;\n            state = \"notdeal\"; //待处理\n          } else if (status == 100) {\n            $scope.ordercount.dealing = returnObj.data.length;\n            state = \"dealing\"; //处理中\n          } else if (status == 200) {\n            $scope.ordercount.done = returnObj.data.length;\n            state = \"done\"; //已完成\n          } // statusTab(status);\n\n\n          $scope.recordData = {\n            \"columns\": [{\n              \"data\": \"ticketTitle\",\n              \"title\": \"工单名称\"\n            }, {\n              \"data\": \"ticketNo\",\n              \"title\": \"工单号\"\n            }, {\n              \"data\": \"processDefinitionId\",\n              \"title\": \"工单流程\"\n            }, {\n              \"data\": \"taskConfigName\",\n              \"title\": \"任务名称\"\n            }, {\n              \"data\": \"ticketPriorityCode\",\n              \"title\": \"紧急度\"\n            }, {\n              \"data\": \"senderName\",\n              \"title\": \"发送人\"\n            }, {\n              \"data\": \"sendTime\",\n              \"title\": \"发送时间\"\n            }, {\n              \"data\": \"finishedTime\",\n              \"title\": \"完成时间\",\n              \"visible\": false\n            }, {\n              \"data\": \"option\",\n              \"orderable\": false,\n              // \"visible\": optionStatus,\n              \"visible\": $scope.menuitems['A01_S08'] != undefined,\n              \"title\": \"操作\"\n            }],\n            \"columnDefs\": [{\n              \"targets\": 0,\n              \"data\": \"ticketTitle\",\n              \"render\": function render(data, type, full) {\n                return \"<span style='cursor:pointer;'>\" + data + \"</span>\";\n              }\n            }, {\n              \"targets\": 1,\n              \"data\": \"ticketNo\",\n              \"render\": function render(data, type, full) {\n                return \"<span style='cursor:pointer;'>\" + data + \"</span>\";\n              }\n            }, {\n              \"targets\": 2,\n              \"data\": \"processDefinitionId\",\n              \"render\": function render(data, type, full) {\n                var str = \"\";\n\n                if ($scope.processType && $scope.processType[data] != undefined) {\n                  str = $scope.processType[data].name;\n                }\n\n                return \"<span style='cursor:pointer;'>\" + str + \"</span>\";\n              }\n            }, {\n              \"targets\": 3,\n              \"data\": \"taskConfigName\",\n              \"render\": function render(data, type, full) {\n                return \"<span style='cursor:pointer;'>\" + data + \"</span>\";\n              }\n            }, {\n              \"targets\": 5,\n              \"data\": \"senderName\",\n              \"render\": function render(data, type, full) {\n                return \"<span style='cursor:pointer;'>\" + data + \"</span>\";\n              }\n            }, {\n              \"targets\": 4,\n              \"data\": \"ticketPriorityCode\",\n              \"render\": function render(data, type, full) {\n                //紧急度\n                var priorityBg;\n                var priorityName;\n\n                if (data == 0) {\n                  priorityBg = \"alerts-minor\";\n                  priorityName = \"低\";\n                } else if (data == 100) {\n                  priorityBg = \"alerts-major\";\n                  priorityName = \"中\";\n                } else if (data == 200) {\n                  priorityBg = \"alerts-critical\";\n                  priorityName = \"高\";\n                }\n\n                return '<span class=\"label ' + priorityBg + '\" style=\"cursor: pointer;\">' + priorityName + '</span>';\n              }\n            }, {\n              \"targets\": 6,\n              \"data\": \"sendTime\",\n              \"render\": function render(data, type, full) {\n                //发送时间\n                return \"<span style='cursor:pointer;'>\" + formatDate(data) + \"</span>\";\n              }\n            }, {\n              \"targets\": 7,\n              \"data\": \"sendTime\",\n              \"render\": function render(data, type, full) {\n                //完成时间\n                return \"<span style='cursor:pointer;'>\" + formatDate(data) + \"</span>\";\n              }\n            }, {\n              \"targets\": 8,\n              \"data\": \"option\",\n              \"render\": function render(data, type, full) {\n                var str = '';\n\n                if ($scope.menuitems['A01_S09']) {\n                  str = \"<a id='process' class='btn btn-default btn-sm' style='cursor: pointer;' ><i class='fa fa-close hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'>执行历史</span></a>\";\n                }\n\n                return str;\n              }\n            }],\n            data: []\n          };\n          $scope.recordData.data = returnObj.data;\n          $scope.recordData.state = state;\n          $scope.$broadcast(Event.WORKORDERRECORDINIT, $scope.recordData);\n        }\n      });\n    };\n    /*var statusTab = function(status){\n       for (var i = $scope.recordData.columns.length - 1; i > -1; i--) {\n        var item = $scope.recordData.columns[i]\n        if (item.data == \"finishedTime\") {\n          if(status == 200){\n            item.visible = true;\n            item.bVisible = true;\n          }else{\n            item.visible = false;\n            item.bVisible = false;\n          }\n          $scope.recordData.columns[i] = item;\n          break;\n        }\n      }\n    }*/\n    //监测Tab页的变换\n\n\n    var previousTab;\n    /*  $('a[data-toggle=\"tab\"]').on('shown.bs.tab', function (e) {\n        // 获取已激活的标签页的名称\n        $scope.activeTab = $(e.target).text();\n        // 获取前一个激活的标签页的名称\n        previousTab = $(e.relatedTarget).text();\n        var state = null;\n        if ($scope.activeTab.indexOf('待处理') > -1) {\n          state = 10;\n        } else if ($scope.activeTab.indexOf('处理中') > -1) {\n          state = 100;\n        } else if ($scope.activeTab.indexOf('已完成') > -1) {\n          state = 200;\n        }\n        $scope.getRecordData(state);\n      });*/\n\n    /**\n     * tab页的事件监听\n     */\n\n    var initEvent = function initEvent() {\n      $('a[data-toggle=\"tab\"]').on('shown.bs.tab', function (e) {\n        if ($(e.target).closest(\"li.disabled\").length > 0) {\n          $(e.target).closest(\"li.disabled\").removeClass(\"active\");\n          $(e.target).closest(\"ul\").children(\"[name=\" + $scope.activeListTab + \"]\").addClass(\"active\");\n          return;\n        }\n\n        var aname = $(e.target).closest(\"li\").attr(\"name\");\n\n        if (aname) {\n          $scope.activeListTab = aname;\n          $scope.$apply(); // 获取已激活的标签页的名称\n\n          $scope.activeTab = $(e.target).text();\n          var state = null;\n\n          if (aname == 'tab1') {\n            state = 10;\n          } else if (aname == 'tab2') {\n            state = 100;\n          } else if (aname == 'tab3') {\n            state = 200;\n          }\n\n          $scope.getRecordData(state);\n        }\n      });\n    }; //初始化数据\n\n\n    function init() {\n      initEvent();\n      getProcessDefinitions();\n      $scope.getRecordCount();\n\n      if ($routeParams && $routeParams.state) {\n        var id = null;\n        var state = null;\n\n        switch ($routeParams.state) {\n          case 'notdeal':\n            id = 0;\n            state = 10;\n            break;\n\n          case 'dealing':\n            id = 1;\n            state = 100;\n            break;\n\n          case 'done':\n            id = 2;\n            state = 200;\n            break;\n        }\n\n        $(\"#myTab li:eq(\" + id + \") a\").tab('show');\n        $scope.getRecordData(state);\n      } else {\n        $scope.getRecordData(10); // $scope.getRecordData(100);\n        // $scope.getRecordData(200);\n      }\n    }\n\n    init();\n  }]);\n  /**\n   * 工单详情，同时也可以直接处理任务，如果不是模板任务的时候\n   */\n\n  controllers.initController('orderDetailCtrl', ['$scope', '$rootScope', '$location', '$routeParams', '$timeout', 'growl', 'resourceUIService', 'workflowService', 'faultKnowledgeUIService', 'userEnterpriseService', 'Info', '$route', 'ticketTaskService', 'ticketCategoryService', function ($scope, $rootScope, $location, $routeParams, $timeout, growl, resourceUIService, workflowService, faultKnowledgeUIService, userEnterpriseService, Info, $route, ticketTaskService, ticketCategoryService) {\n    var id = $routeParams.id;\n    $scope.workType = $routeParams.workType;\n    $scope.state = $routeParams.state;\n    $scope.orderType = \"\";\n    $scope.priorityCode = \"\";\n    $scope.processType = [];\n    $scope.workList = \"\";\n    $scope.tasksList = \"\";\n    $scope.historyData = \"\";\n    $scope.process = \"\";\n    $scope.processTime = \"\";\n    $scope.myObj = {};\n    $scope.myObjTop = {};\n    $scope.historyData = {\n      columns: [{\n        title: \"处理人\",\n        data: \"handlerName\"\n      }, {\n        title: \"处理时间\",\n        data: \"finishedTime\"\n      }],\n      columnDefs: [{\n        \"targets\": 1,\n        \"data\": \"option\",\n        \"render\": function render(data, type, full) {\n          // 返回自定义内容\n          return formatDate(data);\n        }\n      }]\n    };\n    $scope.devicesAll = \"\";\n    $scope.allFault = \"\";\n    var info = Info.get(\"../localdb/info.json\", function (info) {\n      $scope.orderType = $scope.myDicts['ticketCategory']; //工单分类\n\n      $scope.priorityCodeList = info.priorityData; //紧急度\n    }); //获取工单类型\n\n    ticketCategoryService.getTicketCategorys(function (returnObj) {\n      if (returnObj.code == 0) {\n        for (var i in returnObj.data) {\n          $scope.processType = returnObj.data;\n        }\n      }\n    }); //获取所有工单\n\n    resourceUIService.getDevicesByCondition({}, function (res) {\n      if (res.code == 0) {\n        $scope.devicesAll = res.data;\n      }\n    }); //获取所有故障知识\n\n    faultKnowledgeUIService.getAllFaultKnowledges(function (res) {\n      if (res.code == 0) {\n        $scope.allFault = res.data;\n      }\n    });\n\n    $scope.findFault = function () {\n      resourceUIService.findFaultKnowledgeByModelId($scope.orderAddData.deviceId.modelId, function (res) {\n        if (res.code == 0) {\n          $scope.initData.faultList = res.data;\n        }\n      });\n    };\n\n    $scope.formAryList = [];\n    $scope.definitions = {};\n\n    var process = function getProcessType() {\n      if ($scope.workType == 'task') {\n        //通过任务id，获取任务\n        ticketTaskService.getTicketTaskById(id, function (taskObj) {\n          if (taskObj.code == 0) {\n            $scope.detail = taskObj.data;\n\n            if (taskObj.data && taskObj.data.attributeDefinitions != \"\" && taskObj.data.attributeDefinitions != null) {\n              var resAry = taskObj.data.attributeDefinitions;\n\n              for (var i in resAry) {\n                var typePro = {};\n                typePro[\"label\"] = resAry[i].label;\n                typePro[\"name\"] = resAry[i].name;\n                typePro[\"dataType\"] = resAry[i].dataType;\n\n                if (taskObj.data.taskStatus == \"200\" || taskObj.data.taskStatus == \"100\") {\n                  var statList = taskObj.data.values;\n                  $scope.definitions[resAry[i].label] = statList[resAry[i].label];\n                } else {\n                  $scope.definitions[resAry[i].label] = \"\";\n                }\n\n                $scope.formAryList.push(typePro);\n              }\n\n              orderTicket(taskObj.data.ticketNo, taskObj.data.processDefinitionId);\n            } else {\n              orderTicket(taskObj.data.ticketNo, taskObj.data.processDefinitionId);\n            }\n          }\n        });\n        ticketTaskService.isMyTicketTask(id, function (ticketStatus) {\n          if (ticketStatus.code == 0) {\n            $scope.myObj[\"ticketStatus\"] = ticketStatus.data;\n          }\n        });\n      } else if ($scope.workType == 'order') {\n        orderTicket(id, 0);\n      }\n    };\n\n    $scope.startList = \"\";\n\n    var workFlowValue = function workFlowValue(flowId, value) {\n      workflowService.getWorkflowById(flowId, function (returnObj) {\n        if (returnObj.code == 0) {\n          var resAry = returnObj.data.startAttributeDefinitions;\n          var vList = [];\n\n          for (var i in resAry) {\n            var typePro = {};\n            typePro[\"label\"] = resAry[i].label;\n            typePro[\"name\"] = resAry[i].name;\n            typePro[\"dataType\"] = resAry[i].dataType;\n            typePro[\"value\"] = value[resAry[i].label];\n            vList.push(typePro);\n          }\n\n          $scope.startList = vList;\n          console.log(\"startvalue======\" + JSON.stringify(vList));\n        }\n      });\n    };\n\n    var orderTicket = function orderTicket(id, processDefinitionId) {\n      //根据工单Id获取工单详情\n      ticketTaskService.getTicket(id, function (returnObj) {\n        if (returnObj.code == 0) {\n          //$scope.detail = returnObj.data;\n          returnObj.data.commitTime = formatDate(returnObj.data.commitTime);\n          returnObj.data.finishedTime = formatDate(returnObj.data.finishedTime);\n          $scope.workList = returnObj.data;\n\n          if ($scope.workType == 'task') {\n            if ($scope.workList.finishedTime == null || $scope.workList.finishedTime == '') {\n              $scope.processTime = \"0\";\n            }\n\n            if (returnObj.data.values != null && returnObj.data.values != \"\") {\n              workFlowValue(processDefinitionId, returnObj.data.values);\n            }\n          } //通过工单号,获取任务\n\n\n          ticketTaskService.getTicketTasks(id, function (returnObj1) {\n            if (returnObj1.code == 0) {\n              var searchList = [];\n\n              for (var i in returnObj1.data) {\n                if (returnObj1.data[i].taskStatus == 200 || returnObj1.data[i].taskStatus == 100) {\n                  searchList.push(returnObj1.data[i]);\n                }\n              }\n\n              $scope.historyData.data = searchList;\n              $scope.$broadcast(Event.WORKORDERRECORDINIT + \"_history\", $scope.historyData);\n            }\n          }); //}else{\n          //  $scope.historyData.data = [];\n          //  $scope.$broadcast(Event.WORKORDERRECORDINIT + \"_history\", $scope.historyData);\n          //}\n        }\n      });\n    };\n\n    var formatDate = function formatDate(str) {\n      if (str) {\n        str = newDateJson(str).Format(GetDateCategoryStrByLabel());\n      }\n\n      return str;\n    };\n\n    $scope.historyGo = function () {\n      var state = $routeParams.state; //if ($scope.workType == 'task') {\n\n      location.href = \"index.html#/workorderrecord\"; //} else if ($scope.workType == 'alert') {\n      //  location.href = \"index.html#/configAlert\";\n      //} else if ($scope.workType == 'manage') {\n      //  location.href = \"index.html#/workOrder/\" + state;\n      //}\n    };\n\n    $scope.save = function (status) {\n      $scope.detail.taskStatus = status; //$scope.detail.status = status;\n      // if($scope.detail.taskStatus != 200 ){\n\n      $scope.detail[\"values\"] = $scope.definitions;\n\n      if ($scope.myObj.ticketStatus != false) {\n        ticketTaskService.doTask($scope.detail, function (returnObj) {\n          if (returnObj.code == 0) {\n            if (status == 100) {\n              growl.success(\"工单已确认\", {});\n            } else if (status == 200) {\n              growl.success(\"工单已完成\", {});\n              $scope.historyGo();\n            }\n          } else {\n            growl.success(\"工单操作失败\", {});\n          }\n        });\n      } // }\n\n    };\n\n    var init = function init() {\n      //getProcessDefinitions();\n      var UA = navigator.userAgent.toLowerCase();\n\n      if (UA.indexOf(\"webkit\") < 0) {\n        $scope.browserClass = \"wrong\";\n        $scope.myObj = {\n          \"display\": \"inline-flex\"\n        };\n        $scope.myObjTop = {\n          \"margin-top\": \"6px\"\n        };\n      }\n\n      process();\n    };\n\n    init();\n  }]); //从模板地址进来的地址\n\n  controllers.initController('processDetailCtrl', ['$scope', '$rootScope', 'FileUploader', '$location', '$controller', '$routeParams', '$timeout', 'userUIService', 'sparePartUIService', 'growl', 'workflowService', 'userEnterpriseService', 'Info', '$route', 'projectUIService', 'ticketTaskService', 'maintenanceUIService', function ($scope, $rootScope, FileUploader, $location, $controller, $routeParams, $timeout, userUIService, sparePartUIService, growl, workflowService, userEnterpriseService, Info, $route, projectUIService, ticketTaskService, maintenanceUIService) {\n    $scope.status = $routeParams.status; //获取跳转过来的任务状态\n\n    var id = $routeParams.id; //获取跳转过来的任务id\n\n    $scope.workType = $routeParams.workType;\n    $scope.sparePartsArray = {};\n    $scope.devicesList = [];\n    $scope.imgList = [];\n    $scope.selectMajor = '';\n    $scope.taskList = {\n      \"ticketNo\": \"\",\n      \"ticketTitle\": \"\",\n      \"ticketCommitTime\": \"\",\n      \"ticketCreatorName\": \"\",\n      \"customerName\": \"\",\n      \"projectName\": \"\",\n      \"projectID\": \"\",\n      \"modelName\": \"\",\n      \"modelID\": \"\",\n      \"deviceSn\": \"\",\n      \"faultNo\": \"\",\n      \"faultPhenomenon\": \"\"\n    };\n    $scope.selectList = {};\n    $scope.urlService = userUIService.uploadFileUrl;\n    $scope.definitions = {\n      \"faultPhenomenon\": \"\",\n      \"stockOrderItemList\": \"\",\n      \"ticketTaskDesc\": \"\"\n    };\n\n    $scope.addAttachment = function () {\n      var newObj = {\n        name: \"\",\n        label: \"\",\n        stockNumber: \"\",\n        isEdit: 3,\n        id: null\n      };\n      var addList = [];\n\n      for (var n in $scope.selectList.allSparePartsList) {\n        var index = -1;\n\n        for (var j in $scope.sparePartsInitList.data) {\n          if ($scope.selectList.allSparePartsList[n].id == $scope.sparePartsInitList.data[j].id) {\n            index = j;\n          }\n        }\n\n        if (index == -1) {\n          addList.push($scope.selectList.allSparePartsList[n]);\n        }\n      }\n\n      for (var i in $scope.sparePartsInitList.data) {\n        if ($scope.sparePartsInitList.data[i].id == null) {\n          growl.warning(\"当前有未保存的备件\", {});\n          return;\n        }\n      }\n\n      $scope.sparePartsInitList.data.unshift(newObj); //$scope.$broadcast(Event.WORKORDERRECORDINIT + \"_deviceTask\", $scope.sparePartsInitList);\n\n      $scope.definitions.selectList = \"\";\n    };\n\n    $scope.sparePartsInitList = {};\n    $scope.serviceOrigin = userUIService.uploadFileUrl + '/api/rest/upload/maintenanceUIService/uploadTaskImage';\n    $controller('AppUploadCtrl', {\n      $scope: $scope,\n      growl: growl,\n      FileUploader: FileUploader\n    });\n\n    $scope.toggle = function toggle() {\n      $('#nv-file-select').click();\n    };\n\n    $scope.uploadExcel = function (config) {\n      /*  $scope.uploader.formData = [];\n        $scope.uploader.formData.push({\n          config: 'deviceModel'\n        });*/\n      $scope.uploader.uploadAll();\n    };\n\n    $scope.$on(\"uploadTemplate\", function (event, args) {\n      if (args.response.code == 0) {\n        growl.success(\"上传成功\", {});\n        $scope.imgList.push(args.response.data.file);\n        $scope.$apply();\n      }\n    });\n\n    $scope.uploader.onAfterAddingFile = function (fileItem) {\n      if ($scope.uploader.queue.length > $scope.queueLimit) {\n        $scope.uploader.removeFromQueue(0);\n      }\n\n      $scope.uploadExcel();\n    };\n\n    $scope.saveAttachment = function (selectStatus) {\n      var tmp = -1; // if (selectStatus.id == -1) return;\n\n      for (var i in $scope.sparePartsInitList.data) {\n        if ($scope.selectMajor == $scope.sparePartsInitList.data[i].id) {\n          growl.warning(\"该备件已经使用\", {});\n          tmp = $scope.selectMajor;\n          break;\n        }\n      }\n\n      if (tmp == -1) {\n        if (!$scope.sparePartsInitList.data) $scope.sparePartsInitList.data = [];\n        $scope.sparePartsArray[$scope.selectMajor][\"edit\"] = 7; // $scope.sparePartsArray[$scope.selectMajor] = selectStatus;\n\n        $scope.sparePartsArray[$scope.selectMajor].editNumber = \"\";\n        $scope.sparePartsInitList.data.unshift($scope.sparePartsArray[$scope.selectMajor]);\n        $scope.selectMajor = \"\";\n        $scope.$broadcast(Event.WORKORDERRECORDINIT + \"_deviceTask\", $scope.sparePartsInitList);\n      } //if($scope.sparePartsArray[selectStatus.id]){\n      //\n      //}\n\n    };\n\n    $scope.cancelAttach = function (data) {\n      for (var j in $scope.sparePartsInitList.data) {\n        if ($scope.sparePartsInitList.data[j].isEdit == 3 && data.isEdit == 3) {\n          $scope.sparePartsInitList.data.splice(j, 1);\n        } else if ($scope.sparePartsInitList.data[j].id == data.id) {\n          $scope.sparePartsInitList.data.splice(j, 1);\n        }\n      }\n\n      $scope.$broadcast(Event.WORKORDERRECORDINIT + \"_deviceTask\", $scope.sparePartsInitList);\n    };\n\n    $scope.processTask = function (status) {\n      var table = $('table[name=\"major\"]').DataTable();\n      var data = table.$('input').serializeArray();\n      var spareList = $scope.sparePartsInitList.data;\n      var valueList = [];\n      var statusSel = $scope.detail.taskStatus;\n\n      for (var i in data) {\n        for (var j in spareList) {\n          if (data[i].name == spareList[j].id) {\n            if (data[i].value) {\n              spareList[j].stockNumber = data[i].value;\n              valueList.push(spareList[j]);\n            } else {\n              growl.warning(\"您有备件数量没有输入,请输入之后再保存\", {});\n              return;\n            }\n          }\n        }\n      }\n\n      $scope.definitions.stockOrderItemList = valueList;\n      $scope.detail[\"values\"] = $scope.definitions;\n      $scope.detail[\"maintenanceContent\"] = $scope.devicesList; //\t维保内容\n\n      $scope.detail[\"images\"] = $scope.imgList; //图片\n\n      $scope.detail.taskStatus = status;\n\n      if ($scope.selectList.ticketStatus) {\n        ticketTaskService.doTask($scope.detail, function (returnObj) {\n          if (returnObj.code == 0) {\n            if (status == 200) {\n              growl.success(\"处理任务成功\", {});\n              location.href = \"index.html#/workorderrecord\";\n            } else {\n              growl.success(\"任务已确认\", {});\n            }\n          } else {\n            $scope.detail.taskStatus = statusSel;\n          }\n        });\n      }\n    };\n\n    var ticketDetail = function ticketDetail() {\n      //通过任务id查任务详情\n      ticketTaskService.getTicketTaskById(id, function (taskObj) {\n        if (taskObj.code == 0) {\n          if (taskObj.data.deviceId) {\n            if (taskObj.data.maintenanceContent && taskObj.data.maintenanceContent.length > 0) {\n              $scope.devicesList = taskObj.data.maintenanceContent;\n            } else {\n              itemsByDevice(taskObj.data.deviceId);\n            }\n          }\n\n          $scope.detail = taskObj.data;\n          $scope.taskList.ticketNo = taskObj.data.ticketNo;\n          $scope.taskList.ticketTitle = taskObj.data.ticketTitle;\n\n          if (taskObj.data.variables != \"\" && taskObj.data.variables != null) {\n            $scope.taskList.ticketCommitTime = newDateJson(taskObj.data.variables.ticketCommitTime).Format(GetDateCategoryStrByLabel());\n            $scope.taskList.projectId = taskObj.data.variables.device.projectId;\n          }\n\n          $scope.taskList.ticketCreatorName = taskObj.data.variables.ticketCreatorName;\n          $scope.taskList.modelName = taskObj.data.variables.modelName;\n          $scope.taskList.modelID = taskObj.data.variables.modelID; //if(taskObj.data.variables.customer != \"\" && taskObj.data.variables.customer != \"\"){\n\n          $scope.taskList.customerID = taskObj.data.variables.customerID;\n          $scope.taskList.customerName = taskObj.data.variables.customerName; //}\n\n          /* if (taskObj.data.variables.project != \"\" && taskObj.data.variables.project != null) {\n             $scope.taskList.projectName = taskObj.data.variables.project.label;\n             $scope.taskList.projectID = taskObj.data.variables.project.id;\n           }*/\n\n          $scope.taskList.faultNo = taskObj.data.variables.faultNo;\n          $scope.taskList.deviceSn = taskObj.data.variables.deviceSn;\n          $scope.taskList.faultPhenomenon = taskObj.data.variables.faultPhenomenon;\n\n          if (taskObj.data.images) {\n            $scope.imgList = taskObj.data.images;\n          }\n\n          if (taskObj.data.values != null && taskObj.data.values != \"\") {\n            $scope.definitions.ticketTaskDesc = taskObj.data.values.ticketTaskDesc;\n\n            if (taskObj.data.values.stockOrderItemList != null && taskObj.data.values.stockOrderItemList != \"\") {\n              $scope.sparePartsInitList.data = taskObj.data.values.stockOrderItemList;\n              var orderList = taskObj.data.values.stockOrderItemList;\n\n              for (var j in orderList) {\n                if ($scope.sparePartsArray[orderList[j].id] != undefined) {\n                  $scope.sparePartsArray[orderList[j].id].editNumber = orderList[j].stockNumber;\n                }\n              } //$scope.$broadcast(Event.WORKORDERRECORDINIT+\"_deviceTask\", $scope.sparePartsInitList);\n\n            }\n          }\n\n          $scope.$broadcast(Event.WORKORDERRECORDINIT + \"_deviceTask\", $scope.sparePartsInitList);\n        }\n      });\n    };\n\n    var itemsByDevice = function itemsByDevice(deviceId) {\n      maintenanceUIService.getInspectionItemsByDeviceId(deviceId, function (res) {\n        if (res.code == 0) {\n          res.data.forEach(function (obj) {\n            obj[\"status\"] = \"0\";\n          });\n          $scope.devicesList = res.data;\n        }\n      });\n    };\n\n    var init = function init() {\n      ticketTaskService.isMyTicketTask(id, function (ticketStatus) {\n        if (ticketStatus.code == 0) {\n          $scope.selectList[\"ticketStatus\"] = ticketStatus.data;\n        }\n      });\n      $scope.sparePartsInitList.data = []; //查询所有备件\n\n      sparePartUIService.getAllSpareParts(function (data) {\n        if (data.code == 0) {\n          //$scope.selectList[\"allSpareParts\"] = data.data;\n          //$scope.selectList[\"allSparePartsList\"] = data.data;\n          var newObj = [];\n          newObj.push({\n            text: '请选择',\n            label: '请选择',\n            id: -1\n          });\n          data.data.forEach(function (obj) {\n            obj.text = obj.name;\n            $scope.sparePartsArray[obj.id] = obj; //$scope.sparePartsArray[obj.id][\"editNumber\"] = obj;\n\n            newObj.push(obj);\n          });\n          ticketDetail();\n          $scope.allSpareParts = newObj;\n        }\n      });\n    };\n    /**\n     * 查询项目\n     */\n\n\n    $scope.projectsList;\n    $scope.projectsDic = {};\n\n    $scope.queryProject = function () {\n      projectUIService.findProjectsByCondition({}, function (returnObj) {\n        if (returnObj.code == 0) {\n          returnObj.data.forEach(function (item) {\n            $scope.projectsDic[item.id] = item;\n            item.text = item.projectName;\n          });\n          $scope.projectsList = returnObj.data;\n          init();\n        }\n      });\n    };\n\n    $scope.queryProject();\n  }]); //工单任务历史记录\n\n  controllers.initController('workTimeLineCtrl', ['$scope', '$rootScope', '$location', '$routeParams', '$timeout', 'ticketLogService', 'growl', 'workflowService', 'userEnterpriseService', 'Info', '$route', 'ticketTaskService', 'processService', function ($scope, $rootScope, $location, $routeParams, $timeout, ticketLogService, growl, workflowService, userEnterpriseService, Info, $route, ticketTaskService, processService) {\n    var id = $routeParams.id; //获取跳转过来的任务id\n\n    $scope.historyList = null;\n    $scope.workOrderId = id;\n    $scope.workOrderDetail = null;\n\n    if (id != '' && id != null) {\n      ticketTaskService.getTicket(id, function (resData) {\n        if (resData.code == 0) {\n          $scope.workOrderDetail = resData.data;\n        }\n      });\n      ticketLogService.getByTicketNo(id, function (res) {\n        if (res.code == 0) {\n          $scope.historyList = res.data;\n        }\n      });\n    }\n  }]);\n});"],"sourceRoot":"/source/"}