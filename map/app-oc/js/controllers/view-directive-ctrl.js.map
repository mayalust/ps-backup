{"version":3,"sources":["app-oc/js/controllers/view-directive-ctrl.js"],"names":["define","controllers","initController","$scope","$routeParams","$timeout","resourceUIService","kpiDataService","SwSocket","growl","uuid","console","info","kpiCodes","kpiCode2Name","modelId","nodeId","selectedDiritem","itemKpiValues","itemDirValues","itemlabel","dirItemClick","item","sendItemDir","i","params","obj","name","warning","label","sendDeviceDirective","Number","id","returnObj","code","success","callback","evendata","kpiname","data","kpiCode","value","queryKpis","nodeIds","kpiReturnObj","p","category","isRealTimeData","timePeriod","getKpiHierarchyValueList","recordList","kpirecord","j","jary","split","length","param","ciid","toString","kpi","operation","register","send","hierarchyValueHandler","Math","getDirectivesByModelId","modelsDirs","getKpisByModelId","modelsKpis","push","getResourceById","$on","log","unregister"],"mappings":"AAAAA,OAAO,CAAC,2BAA4B,SAAUC,GAC5C,aAEAA,EAAYC,eAAe,oBAAqB,CAAC,SAAU,eAAgB,WAAY,oBAAqB,iBAAkB,WAAY,QAAS,SAAUC,EAAQC,EAAcC,EAAUC,EAAmBC,EAAgBC,EAAUC,GAExO,IAAIC,EADJC,QAAQC,KAAK,wBAGb,IAAIC,EAAW,GACXC,EAAe,GAOfC,EAAUX,EAAaW,QACvBC,EAASZ,EAAaY,OAC1Bb,EAAOc,gBAAkB,GACzBd,EAAOe,cAAgB,GACvBf,EAAOgB,cAAgB,GACvBhB,EAAOiB,UAAY,GAEnBjB,EAAOkB,aAAe,SAAUC,GAC9BnB,EAAOc,gBAAkBK,GAG3BnB,EAAOoB,YAAc,WACnB,IAAK,IAAIC,KAAKrB,EAAOc,gBAAgBQ,OAAQ,CAC3C,IAAIC,EAAMvB,EAAOc,gBAAgBQ,OAAOD,GAGxC,IAFYrB,EAAOgB,cAAcO,EAAIC,MAInC,YADAlB,EAAMmB,QAAQ,OAASzB,EAAOc,gBAAgBQ,OAAOD,GAAGK,MAAO,IAKnEvB,EAAkBwB,oBAAoBC,OAAOf,GAASb,EAAOc,gBAAgBe,GAAI7B,EAAOgB,cAAe,SAAUc,GACzF,GAAlBA,EAAUC,MACZzB,EAAM0B,QAAQ,SAAU,OAK9B,IAAIC,EAAW,SAAkBC,GAC/B,IAAIC,EAAUxB,EAAauB,EAASE,KAAKC,SACrCF,IAASnC,EAAOe,cAAcoB,GAAWD,EAASE,KAAKE,QAGzDC,EAAY,SAAmB7B,EAAU8B,GAC3C,IAQIC,EADAC,EAAI,CAAC,MAPW,CAClBC,SAAU,OACVC,gBAAgB,EAChBC,WAAY,EACZL,QAASA,EACT9B,SAAUA,IAgCZN,EAAe0C,yBAAyBJ,EAAG,SAAUZ,IA3BzB,SAA+BA,GACzD,GAAsB,GAAlBA,EAAUC,KAAW,CAIvB,IAAK,IAAIV,KAFToB,EAAeX,EAAUM,MAEEW,WAAY,CACrC,IAAIC,EAAYP,EAAaM,WAAW1B,GAExC,IAAK,IAAI4B,KAAKD,EAAW,CACvB,IAAIE,EAAOD,EAAEE,MAAM,KACD,EAAdD,EAAKE,SAAYpD,EAAOe,cAAcmC,EAAK,IAAMF,EAAUC,KAInE,IAAII,EAAQ,CACVC,KAAMd,EAAQe,WACdC,IAAK9C,EAAS6C,YAEZE,EAAY,WAGhBpD,EAASqD,SAASnD,EAAMkD,EAAWxB,GAEnC5B,EAASsD,KAAKpD,EAAMkD,EAAW,MAAOJ,IAKxCO,CAAsB9B,MAiCtBlB,GAAWC,IA5BbN,EAAOsD,KAAKtD,OACZJ,EAAkB2D,uBAAuBlD,EAAS,SAAUkB,GACpC,GAAlBA,EAAUC,OACZ/B,EAAO+D,WAAajC,EAAUM,KAC9BpC,EAAOc,gBAAkBd,EAAO+D,WAAW,MAG/C5D,EAAkB6D,iBAAiBpD,EAAS,SAAUkB,GACpD,GAAsB,GAAlBA,EAAUC,KAAW,CAGvB,IAAK,IAAIV,KAFTrB,EAAOiE,WAAanC,EAAUM,KAEhBpC,EAAOiE,WACnBvD,EAASwD,KAAKlE,EAAOiE,WAAW5C,GAAGQ,IACnClB,EAAaX,EAAOiE,WAAW5C,GAAGQ,IAAM7B,EAAOiE,WAAW5C,GAAGG,KAC7DxB,EAAOe,cAAcf,EAAOiE,WAAW5C,GAAGG,MAAQ,GAIpDe,EAAU7B,EADA,CAACG,OAIfV,EAAkBgE,gBAAgBtD,EAAQ,SAAUiB,GAC5B,GAAlBA,EAAUC,OACZ/B,EAAOiB,UAAYa,EAAUM,KAAKV,UAUxC1B,EAAOoE,IAAI,WAAY,WACrB5D,QAAQ6D,IAAI,cACZhE,EAASiE,WAAW/D","file":"app-oc/js/controllers/view-directive-ctrl.js","sourcesContent":["define(['controllers/controllers'], function (controllers) {\n  'use strict';\n\n  controllers.initController('viewDirectiveCtrl', ['$scope', '$routeParams', '$timeout', 'resourceUIService', 'kpiDataService', 'SwSocket', 'growl', function ($scope, $routeParams, $timeout, resourceUIService, kpiDataService, SwSocket, growl) {\n    console.info(\"viewDirectiveCtrl被触发\");\n    var uuid;\n    var item;\n    var kpiCodes = [];\n    var kpiCode2Name = {};\n    var timePeriod = 0; //取值时间长度\n\n    var nodeIds = []; //CI编码数组\n\n    var category; //time或者实例模式\n\n    var modelId = $routeParams.modelId;\n    var nodeId = $routeParams.nodeId;\n    $scope.selectedDiritem = {};\n    $scope.itemKpiValues = {};\n    $scope.itemDirValues = {};\n    $scope.itemlabel = \"\";\n\n    $scope.dirItemClick = function (item) {\n      $scope.selectedDiritem = item;\n    };\n\n    $scope.sendItemDir = function () {\n      for (var i in $scope.selectedDiritem.params) {\n        var obj = $scope.selectedDiritem.params[i];\n        var value = $scope.itemDirValues[obj.name];\n\n        if (!value) {\n          growl.warning(\"请输入:\" + $scope.selectedDiritem.params[i].label, {});\n          return;\n        }\n      }\n\n      resourceUIService.sendDeviceDirective(Number(nodeId), $scope.selectedDiritem.id, $scope.itemDirValues, function (returnObj) {\n        if (returnObj.code == 0) {\n          growl.success(\"指令发送成功\", {});\n        }\n      });\n    };\n\n    var callback = function callback(evendata) {\n      var kpiname = kpiCode2Name[evendata.data.kpiCode];\n      if (kpiname) $scope.itemKpiValues[kpiname] = evendata.data.value;\n    };\n\n    var queryKpis = function queryKpis(kpiCodes, nodeIds) {\n      var kpiQueryModel = {\n        category: \"time\",\n        isRealTimeData: true,\n        timePeriod: 0,\n        nodeIds: nodeIds,\n        kpiCodes: kpiCodes\n      };\n      var p = [\"kpi\", kpiQueryModel];\n      var kpiReturnObj;\n\n      var hierarchyValueHandler = function hierarchyValueHandler(returnObj) {\n        if (returnObj.code == 0) {\n          var xAxisObj;\n          kpiReturnObj = returnObj.data;\n\n          for (var i in kpiReturnObj.recordList) {\n            var kpirecord = kpiReturnObj.recordList[i];\n\n            for (var j in kpirecord) {\n              var jary = j.split(\"-\");\n              if (jary.length > 1) $scope.itemKpiValues[jary[1]] = kpirecord[j];\n            }\n          }\n\n          var param = {\n            ciid: nodeIds.toString(),\n            kpi: kpiCodes.toString()\n          };\n          var operation = \"register\"; //考虑极端情况，一个页面有多个模块监听同一个方法  \n          //但展示在页面的数据需对接收的实时监听的数据做不同处理 \n\n          SwSocket.register(uuid, operation, callback); //websocket发送请求\n\n          SwSocket.send(uuid, operation, 'kpi', param);\n        }\n      };\n\n      kpiDataService.getKpiHierarchyValueList(p, function (returnObj) {\n        hierarchyValueHandler(returnObj);\n      });\n    };\n\n    var init = function init() {\n      uuid = Math.uuid();\n      resourceUIService.getDirectivesByModelId(modelId, function (returnObj) {\n        if (returnObj.code == 0) {\n          $scope.modelsDirs = returnObj.data;\n          $scope.selectedDiritem = $scope.modelsDirs[0];\n        }\n      });\n      resourceUIService.getKpisByModelId(modelId, function (returnObj) {\n        if (returnObj.code == 0) {\n          $scope.modelsKpis = returnObj.data;\n\n          for (var i in $scope.modelsKpis) {\n            kpiCodes.push($scope.modelsKpis[i].id);\n            kpiCode2Name[$scope.modelsKpis[i].id] = $scope.modelsKpis[i].name;\n            $scope.itemKpiValues[$scope.modelsKpis[i].name] = \"\";\n          }\n\n          nodeIds = [nodeId];\n          queryKpis(kpiCodes, nodeIds);\n        }\n      });\n      resourceUIService.getResourceById(nodeId, function (returnObj) {\n        if (returnObj.code == 0) {\n          $scope.itemlabel = returnObj.data.label;\n        }\n      });\n    };\n\n    if (modelId && nodeId) {\n      init();\n    } //注销scope时注销方法heartBeat，回调函数callback  \n\n\n    $scope.$on(\"$destroy\", function () {\n      console.log(\"on-destroy\");\n      SwSocket.unregister(uuid);\n    });\n  }]);\n});"],"sourceRoot":"/source/"}