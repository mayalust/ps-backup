{"version":3,"sources":["app-oc/js/controllers/workorder-procedure-copy-ctrl.js"],"names":["define","controllers","BootstrapDialog","bootstrapMultiselect","initController","$scope","$location","$routeParams","$timeout","viewFlexService","kpiDataService","resourceUIService","growl","userLoginUIService","processService","userEnterpriseService","Info","$route","console","log","isEditing","procedureData","taskConfs","get","info","procedureStep","workOrderType","myDicts","procedureStepBk","procedureModel","getUser","queryEnterpriseUser","returnObj","code","data","length","userData","getUserGroup","queryEnterpriseGroup","groupData","getSupplier","querySupplier","providerData","initProcessDefinitions","getProcessDefinitions","$broadcast","Event","WORKORDERTYPEINIT","initProcedureStep","id","dictCode","valueCode","label","name","param","stepNumber","value","initStepData","i","procedureItem","category","desc","domainPath","processTemplateKey","taskConfsObj","userType","providerId","userIds","userGroupIds","sendEmail","sendSms","sendPsMessage","operation","prev","now","selectAll2Right","arr","push","String","userID","groupID","$","multiSelect","selectAll2Left","addProcedure","currentEditIndex","unshift","isEdit","warning","initDefaultSelect","addStep","parseInt","saveTaskConfs","removeClass","eq","addClass","deleteStep","splice","initSelectUser","initSelectGroup","index","obj","toString","initSelectProvider","saveProcedure","userids","usergroupids","undefined","processDefinition","saveProcessDefinition","success","doAction","type","select","show","title","closable","message","buttons","cssClass","action","dialogRef","deleteProcessDefinitionById","close","on","e","activeTab","target","text","relatedTarget","user","isAuthenticated","$on","evt","d","q","ticketCategoryService","workflowService","userRoleUIService","cmd","flows","uuid","Math","cmdins","flowList","workflowId","userSelect","roleSelect","expressionSelect","taskId","assignedUser","roleUser","allUser","groupUser","taskArry","handerConfsData","defers","defer","configureFlow","flowListDic","roleIdUser","rList","roleID","roleIds","getAssociateRole2User","res","forEach","ele","customNameArr","getdomainNameHandler","domains","customName","allRoles","allRole","queryEnterpriseRole","allGroupUser","groupId","queryGroupUser","addViews","newObj","createTime","Date","flg","rowData","fun","deleteTicketCategoryById","handerConfsList","handerConfs","saveTicketCategory","updateView","getTicketCategorys","tabStatus","userAssigned","userName","userExpressionOfCategory","userExpression","initEvent","attr","$apply","promises","promise","all","then","getWorkflows","resolve"],"mappings":"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","file":"app-oc/js/controllers/workorder-procedure-copy-ctrl.js","sourcesContent":["define(['controllers/controllers', 'bootstrap-dialog', 'bootstrap-multiselect'], function (controllers, BootstrapDialog, bootstrapMultiselect) {\n  'use strict';\n\n  controllers.initController('WorkOrderProcedureCtrl', ['$scope', '$location', '$routeParams', '$timeout', 'viewFlexService', 'kpiDataService', 'resourceUIService', 'growl', 'userLoginUIService', 'processService', 'userEnterpriseService', 'Info', '$route', function ($scope, $location, $routeParams, $timeout, viewFlexService, kpiDataService, resourceUIService, growl, userLoginUIService, processService, userEnterpriseService, Info, $route) {\n    console.log('进入工单流程Copy');\n    $scope.isEditing = false;\n    $scope.procedureData = [];\n    $scope.taskConfs = [];\n    var previousTab;\n    var procedureModel;\n    var procedureStepBk;\n    var info = Info.get(\"localdb/procedure.json\", function (info) {\n      $scope.procedureStep = info.procedureStep; //5步工单枚举\n\n      $scope.workOrderType = $scope.myDicts['ticketCategory']; //工单分类枚举\n\n      procedureModel = info.procedureStepBk;\n      $scope.procedureModel = info.procedureStep;\n    });\n    /**\n     * 五步流程数据默认名字\n     * @return {[type]} [description]\n     */\n\n    $scope.initProcedureStep = function () {\n      var procedureStepBk = [{\n        \"id\": 4011,\n        \"dictCode\": \"systemProcessTemplate\",\n        \"valueCode\": \"oneStep\",\n        \"label\": \"一步工单\",\n        \"name\": \"流程任务1\",\n        \"param\": 1\n      }, {\n        \"id\": 4012,\n        \"dictCode\": \"systemProcessTemplate\",\n        \"valueCode\": \"twoStep\",\n        \"label\": \"二步工单\",\n        \"name\": \"流程任务2\",\n        \"param\": 2\n      }, {\n        \"id\": 4013,\n        \"dictCode\": \"systemProcessTemplate\",\n        \"valueCode\": \"threeStep\",\n        \"label\": \"三步工单\",\n        \"name\": \"流程任务3\",\n        \"param\": 3\n      }, {\n        \"id\": 4014,\n        \"dictCode\": \"systemProcessTemplate\",\n        \"valueCode\": \"fourStep\",\n        \"label\": \"四步工单\",\n        \"name\": \"流程任务4\",\n        \"param\": 4\n      }, {\n        \"id\": 4015,\n        \"dictCode\": \"systemProcessTemplate\",\n        \"valueCode\": \"fiveStep\",\n        \"label\": \"五步工单\",\n        \"name\": \"流程任务5\",\n        \"param\": 5\n      }];\n      $scope.procedureModel = procedureStepBk;\n    };\n\n    $scope.stepNumber = [{\n      \"name\": \"a\",\n      \"value\": 1\n    }, {\n      \"name\": \"b\",\n      \"value\": null\n    }, {\n      \"name\": \"c\",\n      \"value\": null\n    }, {\n      \"name\": \"d\",\n      \"value\": null\n    }, {\n      \"name\": \"e\",\n      \"value\": null\n    }]; //点击编辑工单流程\n\n    $scope.initStepData = function (length) {\n      for (var i = 0; i < length; i++) {\n        $scope.stepNumber[i].value = i + 1;\n      }\n    };\n\n    $scope.procedureItem = {\n      \"label\": \"\",\n      \"category\": \"\",\n      \"desc\": \"\",\n      \"id\": \"\",\n      \"domainPath\": \"\",\n      \"processTemplateKey\": \"\"\n    };\n    $scope.taskConfsObj = {\n      \"name\": \"\",\n      \"userType\": \"user\",\n      \"providerId\": null,\n      \"userIds\": null,\n      \"userGroupIds\": null,\n      \"sendEmail\": true,\n      \"sendSms\": true,\n      \"sendPsMessage\": false //工单流程任务的前后步\n\n    };\n    $scope.operation = {\n      \"prev\": null,\n      \"now\": 0\n      /**\n       * 获取用户\n       */\n\n    };\n\n    function getUser() {\n      userEnterpriseService.queryEnterpriseUser(function (returnObj) {\n        if (returnObj.code == 0) {\n          if (returnObj.data.length != 0) {\n            $scope.userData = returnObj.data;\n          } else {\n            $scope.userData = [];\n          }\n        }\n      });\n    }\n    /**\n     * 获取用户组\n     */\n\n\n    function getUserGroup() {\n      userEnterpriseService.queryEnterpriseGroup(function (returnObj) {\n        if (returnObj.code == 0) {\n          if (returnObj.data.length != 0) {\n            $scope.groupData = returnObj.data;\n          } else {\n            $scope.groupData = [];\n          }\n        }\n      });\n    }\n    /**\n     * 获取设备供应商\n     */\n\n\n    function getSupplier() {\n      userEnterpriseService.querySupplier(function (returnObj) {\n        if (returnObj.code == 0) {\n          if (returnObj.data.length != 0) {\n            $scope.providerData = returnObj.data;\n          } else {\n            $scope.providerData = [];\n          }\n        }\n      });\n    }\n    /**\n     * multi-select全选到右侧\n     */\n\n\n    $scope.selectAll2Right = function () {\n      var length;\n      var taskConfsObj = $scope.taskConfsObj;\n\n      if (taskConfsObj.userType == 'user') {\n        var arr = [];\n\n        if ($scope.userData != []) {\n          for (var i in $scope.userData) {\n            arr.push(String($scope.userData[i].userID));\n          }\n        }\n\n        taskConfsObj.userIds = arr;\n        $scope.taskConfsObj.userIds = arr;\n        length = taskConfsObj.userIds.length;\n      } else if (taskConfsObj.userType == 'group') {\n        var arr = [];\n\n        if ($scope.groupData != []) {\n          for (var i in $scope.groupData) {\n            arr.push(String($scope.groupData[i].groupID));\n          }\n        }\n\n        taskConfsObj.userGroupIds = arr;\n        $scope.taskConfsObj.userGroupIds = arr;\n        length = taskConfsObj.userGroupIds.length;\n      } else if (taskConfsObj.userType == 'provider') {\n        var providerId;\n\n        if ($scope.providerData != []) {\n          providerId = $scope.providerData;\n        }\n\n        $scope.taskConfsObj.providerId = providerId;\n        length = taskConfsObj.providerId.length;\n      }\n\n      if (length >= 0) {\n        $('.my-select-' + $scope.taskConfsObj.userType).multiSelect('select_all');\n      }\n    };\n    /**\n     * 全选到左侧\n     *\n     */\n\n\n    $scope.selectAll2Left = function () {\n      $('.my-select-' + $scope.taskConfsObj.userType).multiSelect('deselect_all');\n    };\n    /**\n     * 新建工单流程\n     */\n\n\n    $scope.addProcedure = function () {\n      if ($scope.isEditing == false) {\n        $scope.isEditing = true;\n        $scope.operation.prev = 0;\n        $scope.operation.now = 0; //将所有相关数据清空\n\n        $scope.taskConfs = [];\n        $scope.initProcedureStep();\n        $scope.currentEditIndex = 1;\n        $scope.stepNumber = [{\n          \"name\": \"a\",\n          \"value\": 1\n        }, {\n          \"name\": \"b\",\n          \"value\": null\n        }, {\n          \"name\": \"c\",\n          \"value\": null\n        }, {\n          \"name\": \"d\",\n          \"value\": null\n        }, {\n          \"name\": \"e\",\n          \"value\": null\n        }]; //流程名称类型描述数据清空\n\n        $scope.procedureItem = {\n          \"label\": \"\",\n          \"category\": \"\",\n          \"desc\": \"\" //正在操作的流程任务清空\n\n        };\n        $scope.taskConfsObj = {\n          \"name\": \"\",\n          \"userType\": \"user\",\n          \"providerId\": null,\n          \"userIds\": null,\n          \"userGroupIds\": null,\n          \"sendEmail\": true,\n          \"sendSms\": true,\n          \"sendPsMessage\": false\n        };\n        var newObj = {\n          id: '',\n          label: \"\",\n          domainPath: '',\n          category: '',\n          processTemplateKey: '',\n          desc: \"\",\n          taskConfs: [],\n          isEditing: true,\n          isEdit: 1\n        }; //isEdit 1-新建 2-编辑\n\n        $scope.procedureData.unshift(newObj);\n        $scope.$broadcast(Event.WORKORDERTYPEINIT, $scope.procedureData);\n      } else {\n        growl.warning(\"当前有正在编辑的工单流程\", {});\n      }\n    }; // $scope.$watch('taskConfsObj.userType', function(newValue, oldValue) {\n    //     console.log(\"监听用户单选按钮\");\n    //     console.log(newValue);\n    //     $scope.userType = newValue;\n    //     $scope.initDefaultSelect()\n    //     if (newValue == 'user') {\n    //       $scope.taskConfsObj.userIds = $scope.taskConfsObj.userIds ? $scope.taskConfsObj.userIds : [];\n    //       $scope.taskConfsObj.userGroupIds = null;\n    //       $scope.taskConfsObj.providerId = null;\n    //       $scope.taskConfsObj.userType = 'user';\n    //     } else if (newValue == 'group') {\n    //       $scope.taskConfsObj.userIds = null;\n    //       $scope.taskConfsObj.userGroupIds = $scope.taskConfsObj.userGroupIds ? $scope.taskConfsObj.userGroupIds : [];\n    //       $scope.taskConfsObj.providerId = null;\n    //       $scope.taskConfsObj.userType = 'group';\n    //     } else if (newValue == 'provider') {\n    //       $scope.taskConfsObj.userIds = null;\n    //       $scope.taskConfsObj.userGroupIds = null;\n    //       $scope.taskConfsObj.providerId = $scope.taskConfsObj.providerId ? $scope.taskConfsObj.providerId : null;\n    //       $scope.taskConfsObj.userType = 'provider';\n    //     }\n    //     console.log(\"userType : \" + $scope.taskConfsObj.userType);\n    //   });\n\n\n    $scope.initDefaultSelect = function () {\n      $('.my-select-user').multiSelect('deselect_all');\n      $('.my-select-group').multiSelect('deselect_all');\n      $('.my-select-provider').multiSelect('deselect_all');\n      return false;\n    };\n    /**\n     * 添加工单流程任务\n     */\n\n\n    $scope.addStep = function () {\n      var arr = [];\n\n      if ($scope.taskConfsObj.userType == 'user') {\n        arr = $scope.taskConfsObj.userIds;\n      } else if ($scope.taskConfsObj.userType == 'group') {\n        arr = $scope.taskConfsObj.userGroupIds;\n      } else if ($scope.taskConfsObj.userType == 'provider') {\n        arr = $scope.taskConfsObj.providerId;\n      }\n\n      if (arr != null && arr.length != 0) {\n        if ($scope.stepNumber[4].value == 5) {\n          growl.warning(\"最多只能添加5个工单流程任务\", {});\n          return;\n        } else {\n          for (var i in $scope.stepNumber) {\n            if ($scope.stepNumber[i].value == null) {\n              $scope.stepNumber[i].value = parseInt(i) + 1;\n              $scope.currentEditIndex = parseInt(i);\n              $scope.saveTaskConfs($scope.currentEditIndex);\n              $scope.taskConfsObj.userIds = [];\n              $scope.initDefaultSelect();\n              $(\".nav-tabs-custom>ul li\").removeClass('active');\n              $(\".nav-tabs-custom>ul li\").eq($scope.currentEditIndex - 1).addClass('active'); //              $scope.changeMultiSelect();\n\n              return;\n            }\n          }\n        }\n      } else {\n        growl.warning(\"请选择任务处理人\", {});\n        return;\n      }\n    };\n    /**\n     * 删除工单流程任务\n     */\n\n\n    $scope.deleteStep = function () {\n      for (var i in $scope.stepNumber) {\n        if (4 - i == 0) {\n          growl.warning(\"至少要有一个流程任务\", {});\n        } else {\n          $scope.initDefaultSelect();\n\n          if ($scope.stepNumber[4 - i].value != null) {\n            $scope.stepNumber[4 - i].value = null;\n            $(\".nav-tabs-custom>ul li\").removeClass('active');\n            $(\".nav-tabs-custom>ul li\").eq($scope.currentEditIndex).addClass('active');\n            var taskConfs = $scope.taskConfs;\n            taskConfs.splice($scope.currentEditIndex - 1, 1);\n            $scope.taskConfs = taskConfs;\n\n            for (var i in taskConfs) {\n              $scope.procedureModel[i].name = taskConfs[i].name;\n            }\n\n            $scope.operation.now = $scope.taskConfs.length - 1;\n            $scope.taskConfsObj = $scope.taskConfs[$scope.operation.now];\n            $scope.currentEditIndex = $scope.operation.now + 1;\n            $(\".nav-tabs-custom ul li\").removeClass('active');\n            $(\".nav-tabs-custom ul li\").eq($scope.operation.now).addClass('active');\n\n            if ($scope.taskConfsObj.userType == 'user' && $scope.taskConfsObj.userIds) {\n              $scope.initSelectUser($scope.taskConfsObj.userIds);\n            } else if ($scope.taskConfsObj.userType == 'group' && $scope.taskConfsObj.userGroupIds) {\n              $scope.initSelectGroup($scope.taskConfsObj.userGroupIds);\n            }\n\n            return;\n          }\n        }\n      }\n    };\n    /**\n     * 保存工单流程任务\n     */\n\n\n    $scope.currentEditIndex = 1;\n    $scope.operation.prev = 0;\n    $scope.operation.now = 0;\n\n    $scope.saveTaskConfs = function (index) {\n      $scope.operation.prev = $scope.operation.now;\n      $scope.operation.now = index;\n      var taskConfs = $scope.taskConfs;\n      var obj = $scope.taskConfsObj;\n      obj.name = $scope.procedureModel[$scope.operation.prev].name;\n      taskConfs[$scope.operation.prev] = obj;\n      $scope.taskConfs = taskConfs; //更新当前步骤数据\n\n      if ($scope.taskConfs[index]) {\n        $scope.taskConfsObj = $scope.taskConfs[index];\n        $scope.userType = $scope.taskConfsObj.userType;\n\n        if ($scope.taskConfsObj.userType == 'user') {\n          var arr = [];\n\n          for (var i in $scope.taskConfsObj.userIds) {\n            if (typeof $scope.taskConfsObj.userIds[i] != 'string') {\n              arr[i] = $scope.taskConfsObj.userIds[i].toString();\n            } else {\n              arr[i] = $scope.taskConfsObj.userIds[i];\n            }\n          }\n\n          $scope.initDefaultSelect();\n          $scope.initSelectUser(arr);\n        } else if ($scope.taskConfsObj.userType == 'group') {\n          var arr = [];\n\n          for (var i in $scope.taskConfsObj.userGroupIds) {\n            if (typeof $scope.taskConfsObj.userGroupIds[i] != 'string') {\n              arr[i] = $scope.taskConfsObj.userGroupIds[i].toString();\n            } else {\n              arr[i] = $scope.taskConfsObj.userGroupIds[i];\n            }\n          }\n\n          $scope.initDefaultSelect();\n          $scope.initSelectGroup(arr);\n        } else if ($scope.taskConfsObj.userType == 'provider') {\n          var arr = $scope.taskConfsObj.providerId.toString();\n          $scope.initSelectProvider(arr);\n        }\n      } else {\n        $scope.taskConfsObj = {\n          \"name\": \"\",\n          \"userType\": \"user\",\n          \"providerId\": null,\n          \"userIds\": null,\n          \"userGroupIds\": null,\n          \"sendEmail\": true,\n          \"sendSms\": true,\n          \"sendPsMessage\": false\n        };\n      }\n\n      $scope.currentEditIndex = index + 1;\n    };\n    /**\n     * 保存工单流程\n     */\n\n\n    $scope.saveProcedure = function () {\n      var userids = $scope.taskConfsObj.userIds;\n      var usergroupids = $scope.taskConfsObj.userGroupIds;\n      var providerid = $scope.taskConfsObj.providerId;\n\n      if ($scope.procedureItem.label == \"\" || $scope.procedureItem.label == null || $scope.procedureItem.label == undefined) {\n        growl.warning(\"请填写流程名称\", {});\n        return;\n      } else if ($scope.procedureItem.category == null || $scope.procedureItem.category == \"\") {\n        growl.warning(\"请选择工单类型\", {});\n        return;\n      }\n\n      if ($scope.taskConfsObj.userType == 'user') {\n        if (userids == null || userids.length == 0) {\n          growl.warning(\"请选择任务处理人\", {});\n          return;\n        }\n      } else if ($scope.taskConfsObj.userType == 'group') {\n        if (usergroupids == null || usergroupids.length == 0) {\n          growl.warning(\"请选择任务处理人\", {});\n          return;\n        }\n      }\n\n      if ($scope.procedureModel[$scope.operation.now].name == \"\" || $scope.procedureModel[$scope.operation.now].name == null) {\n        growl.warning(\"请填写流程任务名称\", {});\n        return;\n      } //保存最近一次的工单流程编辑数据\n\n\n      $scope.saveTaskConfs($scope.operation.now);\n      $scope.taskConfs.name = $scope.procedureItem.label;\n      var taskConfs = $scope.taskConfs;\n      var processDefinition = $scope.procedureItem;\n      processDefinition.taskConfs = taskConfs;\n\n      for (var i in processDefinition.taskConfs) {\n        if (!processDefinition.taskConfs[i]) {\n          delete processDefinition.taskConfs[i];\n        }\n      }\n\n      processService.saveProcessDefinition(processDefinition, function (returnObj) {\n        if (returnObj.code == 0) {\n          if (processDefinition.id) {\n            growl.success(\"修改工单流程成功\", {});\n          } else {\n            growl.success(\"新建工单流程成功\", {});\n          }\n\n          $scope.isEditing = false;\n          initProcessDefinitions();\n          $scope.taskConfs = []; //清空数据\n\n          $scope.operation.prev = 0;\n          $scope.operation.now = 0;\n        }\n      });\n    };\n    /**\n     * 处理Table数据\n     */\n\n\n    $scope.doAction = function (type, select) {\n      if (type == 'save') {} else if (type == 'editError') {\n        growl.warning(select, {});\n        return;\n      } else if (type == 'delete') {\n        if ($scope.isEditing == true) {\n          $scope.isEditing == false;\n        }\n\n        BootstrapDialog.show({\n          title: '提示',\n          closable: false,\n          message: '确认删除工单流程 ' + select.label + ' 吗？',\n          buttons: [{\n            label: '确定',\n            cssClass: 'btn-success',\n            action: function action(dialogRef) {\n              var id = select.id;\n              processService.deleteProcessDefinitionById(id, function (returnObj) {\n                if (returnObj.code == 0) {\n                  //删除后刷新局部\n                  initProcessDefinitions();\n                  $scope.initProcedureStep();\n                  $scope.isEditing = false;\n                  $scope.procedureModel = procedureStepBk;\n                  growl.success(\"删除工单流程成功\", {});\n                }\n              });\n              dialogRef.close();\n            }\n          }, {\n            label: '取消',\n            action: function action(dialogRef) {\n              dialogRef.close();\n            }\n          }]\n        });\n      } else if (type == 'cancel') {\n        $scope.isEditing = false;\n        initProcessDefinitions();\n        growl.success(select, {});\n        $scope.operation.prev = 0;\n        $scope.operation.now = 0;\n        $scope.isEditing = false;\n      }\n    }; //监测Tab页的变换\n\n\n    $('a[data-toggle=\"tab\"]').on('shown.bs.tab', function (e) {\n      // 获取已激活的标签页的名称\n      $scope.activeTab = $(e.target).text(); // 获取前一个激活的标签页的名称\n\n      previousTab = $(e.relatedTarget).text();\n    });\n    /**\n     * 初始化工单类型定义\n     */\n\n    function initProcessDefinitions() {\n      processService.getProcessDefinitions(function (returnObj) {\n        if (returnObj.code == 0) {\n          if (returnObj.length != 0) {\n            $scope.procedureData = returnObj.data;\n          } else {\n            $scope.procedureData = [];\n          }\n\n          $scope.$broadcast(Event.WORKORDERTYPEINIT, $scope.procedureData);\n        }\n      });\n    }\n\n    ;\n\n    function init() {\n      if (!userLoginUIService.user.isAuthenticated) {\n        $scope.$on('loginStatusChanged', function (evt, d) {\n          if (userLoginUIService.user.isAuthenticated) {\n            getSupplier();\n            getUserGroup();\n            getUser();\n            initProcessDefinitions();\n          }\n        });\n      } else {\n        getSupplier();\n        getUserGroup();\n        getUser();\n        initProcessDefinitions();\n      }\n    }\n\n    init();\n  }]);\n  controllers.initController('workFlowCtrl', ['$scope', '$q', 'ticketCategoryService', '$location', 'workflowService', '$timeout', 'userRoleUIService', 'kpiDataService', 'resourceUIService', 'growl', 'userLoginUIService', 'processService', 'userEnterpriseService', 'Info', '$route', 'commonMethodService', function ($scope, q, ticketCategoryService, $location, workflowService, $timeout, userRoleUIService, kpiDataService, resourceUIService, growl, userLoginUIService, processService, userEnterpriseService, Info, $route, cmd) {\n    $scope.workOrderType = \"\";\n    $scope.flows = \"\";\n    var uuid = Math.uuid();\n    var cmdins = new cmd(); //一些下拉框的model值选择\n\n    $scope.flowList = {\n      \"workflowId\": \"\",\n      \"category\": \"\",\n      \"userSelect\": \"\",\n      \"roleSelect\": \"\",\n      \"expressionSelect\": \"\",\n      \"userType\": \"\",\n      \"taskId\": \"\",\n      \"assignedUser\": \"\",\n      \"roleUser\": [],\n      \"allUser\": {},\n      \"groupUser\": {},\n      \"taskArry\": {}\n    };\n    $scope.handerConfsData = {};\n    var defers = [];\n\n    for (var i = 0; i < 1; i++) {\n      defers.push(q.defer());\n    }\n\n    $scope.configureFlow = [];\n    $scope.flowListDic = {};\n\n    var updateView = function updateView(param, fun) {\n      var handerConfsList = [];\n      var handerConfs = $scope.handerConfsData;\n\n      for (var i in handerConfs) {\n        /* if(handerConfs[i].userType == \"role\"){\n         if($scope.flowList.roleUser <= 0){\n         growl.warning(\"您的'\"+handerConfs[i].taskName+\"'任务下面角色没有用户请去用户管理分配\",{});\n         return;\n         }\n         }else if(handerConfs[i].userType == \"groupUser\"){\n         if($scope.flowList.roleUser <= 0){\n         growl.warning(\"您的'\"+handerConfs[i].taskName+\"'任务下面用户组没有用户请去用户组管理分配\",{});\n         return;\n         }\n         }*/\n        handerConfsList.push(handerConfs[i]);\n      }\n\n      param.handerConfs = handerConfsList;\n\n      if (param.isEdit == 3) {\n        param.id = 0;\n      }\n\n      ticketCategoryService.saveTicketCategory(param, function (returnObj) {\n        if (returnObj.code == 0) {\n          if (param.isEdit == 3) {\n            for (var i in $scope.configureFlow) {\n              if ($scope.configureFlow[i].isEdit == 3) {\n                $scope.configureFlow[i].isEdit = 0;\n                $scope.configureFlow[i] = returnObj.data;\n                break;\n              }\n            }\n          } else {\n            for (var i = $scope.configureFlow.length - 1; i > -1; i--) {\n              if ($scope.configureFlow[i].id == returnObj.data.id) {\n                $scope.configureFlow[i] = returnObj.data;\n              }\n            }\n          }\n\n          $scope.$broadcast('WORKFLOW', $scope.configureFlow);\n\n          if (param.id > 0) {\n            growl.success(\"编辑成功\");\n          } else {\n            growl.success(\"添加成功\");\n          }\n        }\n      });\n    }; //通过角色id查用户\n\n\n    $scope.roleIdUser = function () {\n      var roleId = $scope.handerConfsData[$scope.flowList.taskId].roleIds;\n      var rList = {\n        \"roleID\": roleId\n      };\n      userRoleUIService.getAssociateRole2User(rList, function (res) {\n        if (res.code == 0) {\n          res.data.forEach(function (ele) {\n            var customNameArr = cmdins.getdomainNameHandler(ele.domains, []);\n            var customName = \"\";\n\n            for (var i = 0; i < customNameArr.length; i++) {\n              customName += customNameArr[i] + \"/\";\n            }\n\n            ele.customName = customName;\n          });\n          $scope.flowList.roleUser = res.data;\n        }\n      });\n    }; //获取当前用户下面的所有用户\n\n\n    $scope.allUser = function () {\n      userEnterpriseService.queryEnterpriseUser(function (res) {\n        if (res.code == 0) {\n          for (var i in res.data) {\n            $scope.flowList.allUser[res.data[i].userID] = res.data[i];\n          }\n        }\n      });\n    }; //获取当前用户下面的所有角色\n\n\n    $scope.flowList.allRoles = {};\n\n    $scope.allRole = function () {\n      userEnterpriseService.queryEnterpriseRole(function (res) {\n        if (res.code == 0) {\n          for (var i in res.data) {\n            $scope.flowList.allRoles[res.data[i].roleID] = res.data[i];\n          }\n        }\n      });\n    }; //获取用户组用户\n\n\n    $scope.allGroupUser = function () {\n      var groupId = $scope.handerConfsData[$scope.flowList.taskId].userGroupIds;\n      userEnterpriseService.queryGroupUser(groupId, function (res) {\n        if (res.code == 0) {\n          $scope.flowList.groupUser = res.data;\n        }\n      });\n    };\n\n    $scope.addViews = function () {\n      var newObj = {\n        id: uuid,\n        workflowId: \"\",\n        name: \"\",\n        desc: \"\",\n        category: \"\",\n        createTime: new Date(),\n        //handerConfs:\"\",\n        isEdit: 3\n      };\n      $scope.flowList.category = \"\";\n      $scope.flowList.workflowId = \"\";\n\n      for (var i in $scope.configureFlow) {\n        if ($scope.configureFlow[i].id == null || $scope.configureFlow[i].isEdit > 1) {\n          growl.warning(\"当前有未保存的数据，请先保存\", {});\n          return;\n        }\n      }\n\n      $scope.configureFlow.push(newObj);\n      $scope.$broadcast('WORKFLOW', $scope.configureFlow);\n    };\n\n    $scope.doAction = function (flg, rowData, fun) {\n      if (flg == \"attr-delete\") {\n        //删除\n        BootstrapDialog.show({\n          title: '提示',\n          closable: false,\n          //size:BootstrapDialog.SIZE_WIDE,\n          message: '确认删除流程关联吗？',\n          buttons: [{\n            label: '确定',\n            cssClass: 'btn-success',\n            action: function action(dialogRef) {\n              ticketCategoryService.deleteTicketCategoryById([rowData.id], function (returnObj) {\n                if (returnObj.code == 0) {\n                  for (var i = 0; i < $scope.configureFlow.length; i++) {\n                    if ($scope.configureFlow[i].id == rowData.id) {\n                      $scope.configureFlow.splice(i, 1);\n                      break;\n                    }\n                  }\n\n                  if (fun) {\n                    fun(true);\n                  }\n\n                  growl.success(\"流程关联删除成功\", {});\n                }\n              });\n              dialogRef.close();\n            }\n          }, {\n            label: '取消',\n            action: function action(dialogRef) {\n              dialogRef.close();\n            }\n          }]\n        });\n      } else if (flg == \"view-save\") {\n        updateView(rowData, fun);\n      } else if (flg == \"cancel\") {\n        ticketCategoryService.getTicketCategorys(function (returnObj) {\n          if (returnObj.code == 0) {\n            $scope.configureFlow = returnObj.data;\n            $scope.$broadcast('WORKFLOW', $scope.configureFlow);\n          }\n        });\n      }\n    };\n\n    $scope.tabStatus = function (type, handerConfsData) {\n      if (handerConfsData) {\n        $scope.handerConfsData = handerConfsData;\n\n        if (type == \"role\") {\n          /**\n           * 现在实现的是按照所选当前的节点开始加载的数据\n           * 之前是一次性全部加载的 把这个方法注释了\n           * 韩星\n           */\n          $scope.$broadcast(\"handerConfsData\", handerConfsData[$scope.flowList.taskId]); // $scope.roleIdUser();\n        } else if (type == \"user\") {\n          var userAssigned = $scope.handerConfsData[$scope.flowList.taskId].userIds;\n          $scope.flowList.assignedUser = $scope.flowList.allUser[userAssigned].userName;\n        } else if (type == \"group\") {\n          $scope.allGroupUser();\n        } else if (type == \"expression\") {\n          var userExpressionOfCategory = $scope.handerConfsData[$scope.flowList.taskId].userExpressionOfCategory;\n\n          if (userExpressionOfCategory == \"\" || userExpressionOfCategory == null) {\n            $scope.handerConfsData[$scope.flowList.taskId].userExpressionOfCategory = $scope.handerConfsData[$scope.flowList.taskId].userExpression;\n          }\n        }\n      }\n    };\n\n    $scope.initEvent = function () {\n      $('a[data-toggle=\"tab\"]').on('shown.bs.tab', function (e) {\n        var userType = $(e.target).attr(\"userType\");\n        var taskId = $(e.target).attr(\"taskId\");\n        $scope.flowList.userType = userType;\n        $scope.flowList.taskId = taskId;\n        $scope.tabStatus(userType, $scope.handerConfsData);\n        $scope.$apply();\n      });\n    };\n\n    function initViews() {\n      //查询所有已经发布的流程\n      workflowService.getWorkflows(function (returnObj) {\n        if (returnObj.code == 0) {\n          if (returnObj.data && returnObj.data != undefined) {\n            for (var i in returnObj.data) {\n              $scope.flowListDic[returnObj.data[i].id] = returnObj.data[i];\n            }\n          }\n\n          $scope.flows = returnObj.data;\n          defers[0].resolve(\"success\");\n        }\n      });\n      Info.get(\"localdb/procedure.json\", function (info) {\n        $scope.workOrderType = $scope.myDicts['ticketCategory']; //工单分类枚举\n      });\n    }\n\n    var promises = [];\n\n    for (var i in defers) {\n      promises.push(defers[i].promise);\n    }\n\n    q.all(promises).then(function (data) {\n      console.log(\"all loaded\"); //查询所有分类跟流程关联的数据\n\n      ticketCategoryService.getTicketCategorys(function (returnObj) {\n        if (returnObj.code == 0) {\n          $scope.configureFlow = returnObj.data;\n          $scope.$broadcast('WORKFLOW', $scope.configureFlow);\n        }\n      });\n      $scope.allUser();\n      $scope.allRole();\n    });\n    initViews();\n  }]);\n});"],"sourceRoot":"/source/"}