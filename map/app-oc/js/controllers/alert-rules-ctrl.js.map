{"version":3,"sources":["app-oc/js/controllers/alert-rules-ctrl.js"],"names":["define","controllers","BootstrapDialog","initController","$scope","resourceUIService","$q","dictionaryService","unitService","customerUIService","projectUIService","userDomainService","ngDialog","$location","$routeParams","$timeout","userLoginUIService","Info","growl","routePathNodes","alertRulesLists","modelLists","showType","type","mistakeMesg","deferList","initHistory","selectedItem","title","modelId","nodeIds","domain","alertRulesInfo","id","kpiCode","desc","enabled","condition","refValue","severity","alertCode","ruleType","customerId","projectId","classify","risingTime","Date","selectedCount","abled","unabled","Category","index","label","severiesList","severNo","severName","name","value","closeDialog","close","addAlertRules","location","href","saveData","$","extend","modelID","domainAry","split","length","updateKpiThreshold","returnObj","code","rulesId","success","i","$broadcast","Event","ALERTRULESINIT","option","addKpiThreshold","data","push","warning","doAction","select","callback","ifOnly","show","closable","message","buttons","cssClass","action","dialogRef","deleteKpiThresholds","j","splice","$apply","enabledKpiThresholds","copyKpiThresholdById","selectModel","queryKpis","selkpisByDomainsinit","selkpisByDevice","item","replace","join","allDeveicesList","trim","_modelId","selkpisByDomains","selkpisByCustomer","selkpisByProject","kpisLists","temLists","kpiListsDic","kpi","changeVal","number","verifyFun","r","test","phone","email","kpiLists","defer","getModels","defers","newObj","baseConfig","customerConfig","display","projectConfig","forEach","subdefer","getDataItemsByModelId","text","resolve","promise","allModelLists","all","then","findProjectsByCondition","obj","projectName","projectList","findCustomersByCondition","customerName","CustomerList","customerDic","allAlertClassify","reflash","findAlertDefinitions","alertClassifyLists","concat","getChange","queryState","searchData","param","nodeId","findKpiThresholds","parseInt","init","getDevicesByCondition","queryDomainTree","user","userID","domainListTree","domainListDic","viewType","showView","isAuthenticated","$on","evt","d","orCondition","description","alertClassifyInfo","addalertClassify","open","template","className","scope","updateAlertDefinition","addAlertDefinition","deleteAlertDefinition","userEnterpriseService","alertInformLists","rootInformId","alertInformsId","alertInformsInfo","kpiThresholdId","ruleName","personType","noticeRole","templates","noticeWay","noticeTemplate","contact","addalertInforms","state","templParams","filter","key","noticeWayLabel","ruleTempName","getRuleTempName","alertInformDic","find","elem","updatedDeferList","updateNoticeRule","addNoticeRule","newItem","kpiThresholdIds","selected","delIds","delitem","deleteNoticeRule","jQuery","choseItem","changeRole","alertFun","queryType","resourceType","notifications","notificationList","valueCode","queryMesg","queryTemplLists","templLists","findNoticeRules","inithandler","notificationType","myDicts","list","templatesDic","personTypeLabel","queryEnterpriseRole","roleID","roleName","allRoles","findTemplateByCondition","noticeTemplateDesc","$watch","n","o","kpiTypeInfo","unit","range","icon","kpiTypeLists","addkpiType","saveKpiType","deleteKpiTypeByIds","getKpiTypeByFilter"],"mappings":"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","file":"app-oc/js/controllers/alert-rules-ctrl.js","sourcesContent":["define(['controllers/controllers', 'bootstrap-dialog'], function (controllers, BootstrapDialog) {\n  'use strict'; //告警规则 \n\n  controllers.initController('alertRulesCtrl', ['$scope', 'resourceUIService', '$q', 'dictionaryService', 'unitService', 'customerUIService', 'projectUIService', 'userDomainService', 'ngDialog', '$location', '$routeParams', '$timeout', 'userLoginUIService', 'Info', 'growl', function ($scope, resourceUIService, $q, dictionaryService, unitService, customerUIService, projectUIService, userDomainService, ngDialog, $location, $routeParams, $timeout, userLoginUIService, Info, growl) {\n    $scope.routePathNodes = {}; //设备型号初始对象 \n\n    $scope.alertRulesLists = []; //告警规则列表\n\n    $scope.modelLists = []; //kpi指标\n\n    $scope.showType = $routeParams.type; //global，special\n\n    $scope.mistakeMesg = {}; //用于验证用\n\n    var deferList = []; //用于执行顺序\n\n    $scope.selectedCount = 0;\n    $scope.abled = false;\n    $scope.unabled = false; //查询/展示字段\n\n    function initHistory() {\n      $scope.selectedItem = {\n        \"title\": \"\",\n        \"modelId\": \"\",\n        \"nodeIds\": \"\",\n        \"domain\": \"\"\n      };\n      $scope.alertRulesInfo = {\n        \"id\": 0,\n        \"title\": \"\",\n        //规则名称\n        \"kpiCode\": \"\",\n        //指标\n        \"desc\": \"\",\n        //规则描述\n        \"enabled\": false,\n        \"condition\": \"\",\n        //阈值条件\n        \"refValue\": \"\",\n        //阈值\n        \"severity\": \"\",\n        //告警级别\n        \"modelId\": \"\",\n        //设备型号\n        \"alertCode\": \"\",\n        //告警类别\n        \"ruleType\": \"\",\n        //告警规则类型\n        \"domain\": \"\",\n        //域\n        \"nodeIds\": \"\",\n        //设备实例id\n        \"customerId\": \"\",\n        //客户id\n        \"projectId\": \"\",\n        //项目id\n        \"classify\": \"\",\n        //数据分类,\n        \"risingTime\": new Date()\n      };\n    }\n\n    ;\n    $scope.Category = [{\n      index: \"\",\n      label: \"全部\"\n    }, {\n      index: \"FAULT\",\n      label: \"故障\"\n    }, {\n      index: \"ALERT\",\n      label: \"测点\"\n    }];\n    $scope.severiesList = [{\n      \"severNo\": 1,\n      \"severName\": \"警告\"\n    }, {\n      \"severNo\": 2,\n      \"severName\": \"次要\"\n    }, {\n      \"severNo\": 3,\n      \"severName\": \"重要\"\n    }, {\n      \"severNo\": 4,\n      \"severName\": \"严重\"\n    }];\n    $scope.condition = [{\n      'name': '大于',\n      'value': 'compare(value,refValue)>0'\n    }, {\n      'name': '大于等于',\n      'value': 'compare(value,refValue)>=0'\n    }, {\n      'name': '等于',\n      'value': 'compare(value,refValue)=0'\n    }, {\n      'name': '小于',\n      'value': 'compare(value,refValue)<0'\n    }, {\n      'name': '小于等于',\n      'value': 'compare(value,refValue)<=0'\n    }, {\n      'name': '表达式',\n      'value': ''\n    }]; //弹出框的关闭事件\n\n    $scope.closeDialog = function () {\n      ngDialog.close();\n    }; //添加告警规则\n\n\n    $scope.addAlertRules = function (type) {\n      initHistory();\n\n      if (type == 'global') {\n        location.href = \"#/alertRules/global/0/edit\";\n      } else if (type == 'special') {\n        location.href = \"#/alertRules/special/0/edit\";\n      }\n    }; //保存\n\n\n    $scope.saveData = function () {\n      var alertRulesInfo = $.extend({}, $scope.alertRulesInfo, true);\n\n      if (!alertRulesInfo.title) {\n        growl.warning(\"请输入规则名称\", {});\n        return;\n      }\n\n      if (!alertRulesInfo.domain) {\n        growl.warning(\"请选择管理域\", {});\n        return;\n      }\n\n      if (!alertRulesInfo.modelId && $scope.showType == 'global') {\n        growl.warning(\"请选择资源类型\", {});\n        return;\n      }\n      /**\n      if(!alertRulesInfo.classify && $scope.showType == 'global') {\n        growl.warning(\"请选择数据分类\", {});\n        return;\n      }        \n      if (!alertRulesInfo.customerId && $scope.showType == 'special' && $scope.baseConfig.customerConfig.display && $scope.baseConfig.customerConfig.check) {\n        growl.warning(\"请选择客户名称\", {});\n        return;\n      }\n      if (!alertRulesInfo.projectId && $scope.showType == 'special' && $scope.baseConfig.projectConfig.display  && $scope.baseConfig.projectConfig.check) {\n        growl.warning(\"请选择\"+(($scope.menuitems[\"S13\"]&&$scope.menuitems[\"S13\"].label)?$scope.menuitems[\"S13\"].label:\"项目\")+\"名称\", {});\n        return;\n      }\n      \n      if (!alertRulesInfo.nodeIds && $scope.showType == 'special') {\n        growl.warning(\"请选择设备名称\", {});\n        return;\n      }\n      */\n\n\n      if (!alertRulesInfo.kpiCode) {\n        growl.warning(\"请选择数据项\", {});\n        return;\n      }\n\n      if (!alertRulesInfo.refValue) {\n        growl.warning(\"请填写阈值\", {});\n        return;\n      }\n\n      if (!alertRulesInfo.alertCode) {\n        growl.warning(\"请选择告警类别\", {});\n        return;\n      }\n\n      if (!alertRulesInfo.severity) {\n        growl.warning(\"请选择告警级别\", {});\n        return;\n      }\n\n      if ($scope.showType != 'global') {\n        //实例时特殊处理\n        var modelID = alertRulesInfo.modelId;\n\n        if ((!modelID || modelID == 300) && alertRulesInfo.domain) {\n          //如何选中了管理域\n          alertRulesInfo.modelId = 300;\n          var domainAry = alertRulesInfo.domain.split(\"/\");\n          alertRulesInfo.nodeIds = domainAry[domainAry.length - 2];\n        }\n\n        if ((!modelID || modelID == 301) && alertRulesInfo.customerId) {\n          //如何选中了客户，则为客户域，覆盖管理域\n          alertRulesInfo.modelId = 301;\n          alertRulesInfo.nodeIds = alertRulesInfo.customerId;\n        }\n\n        if ((!modelID || modelID == 302) && alertRulesInfo.projectId) {\n          //如何选中了项目，则为项目域，覆盖客户域\n          alertRulesInfo.modelId = 302;\n          alertRulesInfo.nodeIds = alertRulesInfo.projectId;\n        }\n      }\n\n      var updataFun = function updataFun() {\n        resourceUIService.updateKpiThreshold(alertRulesInfo, function (returnObj) {\n          if (returnObj.code == 0) {\n            if ($routeParams.rulesId > 0) {\n              if (alertRulesInfo.modelId == 300 || alertRulesInfo.modelId == 301 || alertRulesInfo.modelId == 302) {\n                alertRulesInfo.nodeIds = \"\";\n              }\n            }\n\n            $scope.alertRulesInfo = alertRulesInfo;\n            growl.success(\"告警规则信息修改完成\", {});\n            var alertRulesLists = $scope.alertRulesLists;\n\n            for (var i in alertRulesLists) {\n              if (alertRulesLists[i].id == alertRulesInfo.id) {\n                $.extend(alertRulesLists[i], alertRulesInfo);\n                break;\n              }\n            }\n\n            $timeout(function () {\n              $scope.$broadcast(Event.ALERTRULESINIT + \"_rules\", {\n                \"option\": [$scope.alertRulesLists]\n              });\n            });\n          }\n        });\n      };\n\n      var addFun = function addFun() {\n        resourceUIService.addKpiThreshold(alertRulesInfo, function (returnObj) {\n          if (returnObj.code == 0) {\n            alertRulesInfo = returnObj.data;\n\n            if ($routeParams.rulesId > 0) {\n              if (alertRulesInfo.modelId == 300 || alertRulesInfo.modelId == 301 || alertRulesInfo.modelId == 302) {\n                alertRulesInfo.nodeIds = \"\";\n              }\n            }\n\n            $scope.alertRulesInfo.id = alertRulesInfo.id;\n            $scope.alertRulesLists.push(alertRulesInfo);\n            $timeout(function () {\n              $scope.$broadcast(Event.ALERTRULESINIT + \"_rules\", {\n                \"option\": [$scope.alertRulesLists]\n              });\n            });\n            growl.success(\"告警规则信息添加成功\", {});\n          }\n        });\n      };\n\n      if (alertRulesInfo.id > 0) {\n        updataFun(alertRulesInfo);\n      } else if (alertRulesInfo.id == 0) {\n        addFun(alertRulesInfo);\n      }\n    }; //删除,启用\n\n\n    $scope.doAction = function (type, select, callback, ifOnly) {\n      if (type == \"deleteAlertRules\") {\n        BootstrapDialog.show({\n          title: '提示',\n          closable: false,\n          message: ifOnly ? '确认要删除此告警规则吗？' : '当前有 ' + select.length + '个告警规则可删除，确认要删除吗？',\n          buttons: [{\n            label: '确定',\n            cssClass: 'btn-success',\n            action: function action(dialogRef) {\n              resourceUIService.deleteKpiThresholds([select], function (returnObj) {\n                callback(returnObj);\n\n                if (returnObj.code == 0) {\n                  var alertRulesLists = $scope.alertRulesLists;\n\n                  for (var i in select) {\n                    for (var j in alertRulesLists) {\n                      if (alertRulesLists[j].id == select[i]) {\n                        alertRulesLists.splice(j, 1);\n                      }\n                    }\n                  }\n\n                  $scope.selectedCount = 0;\n                  $scope.abled = false;\n                  $scope.unabled = false;\n                }\n              });\n              dialogRef.close();\n            }\n          }, {\n            label: '取消',\n            action: function action(dialogRef) {\n              callback(false);\n              dialogRef.close();\n              $scope.selectedCount = 0;\n              $scope.abled = false;\n              $scope.unabled = false;\n              $scope.$apply();\n            }\n          }]\n        });\n      } else if (type == \"AlertEnable\") {\n        var enabled = select[1];\n        BootstrapDialog.show({\n          title: '提示',\n          closable: false,\n          message: enabled ? ifOnly ? '确认要启用此告警规则吗？' : '当前有 ' + select[0].length + '个告警规则未启用，确认要启用吗？' : ifOnly ? '确认要停用此告警规则吗？' : '当前有 ' + select[0].length + '个告警规则未停用，确认要停用吗？',\n          buttons: [{\n            label: '确定',\n            cssClass: 'btn-success',\n            action: function action(dialogRef) {\n              resourceUIService.enabledKpiThresholds(select, function (returnObj) {\n                callback(returnObj);\n\n                if (returnObj.code == 0) {\n                  if (enabled) {\n                    $scope.abled = false;\n                    $scope.unabled = false;\n                  } else {\n                    $scope.abled = false;\n                    $scope.unabled = false;\n                  }\n\n                  $scope.selectedCount = 0;\n                  return;\n                }\n              });\n              dialogRef.close();\n            }\n          }, {\n            label: '取消',\n            action: function action(dialogRef) {\n              callback(false);\n              $scope.selectedCount = 0;\n              $scope.abled = false;\n              $scope.unabled = false;\n              $scope.$apply();\n              dialogRef.close();\n            }\n          }]\n        });\n      } else if (type == \"copy\") {\n        resourceUIService.copyKpiThresholdById([select.id], function (returnObj) {\n          if (returnObj.code == 0) {\n            growl.success(\"告警规则信息复制成功\", {});\n            $scope.alertRulesLists.push(returnObj.data);\n            $timeout(function () {\n              $scope.$broadcast(Event.ALERTRULESINIT + \"_rules\", {\n                \"option\": [$scope.alertRulesLists]\n              });\n            });\n            callback(returnObj);\n          }\n        });\n      }\n    }; //全局设备型号过滤数据项\n\n\n    $scope.selectModel = function () {\n      //      if($scope.alertRulesInfo.classify) { //数据分类\n      $scope.queryKpis($scope.alertRulesInfo.classify); //      }\n    }; //实例设备过滤数据项\n\n\n    $scope.selkpisByDevice = function (item) {\n      var id = item.id.replace(/[^0-9]+/g, \"\").split(\"\").join(\"\");\n\n      for (var i in $scope.allDeveicesList) {\n        if ($.trim(id) == $scope.allDeveicesList[i].id) {\n          $scope._modelId = $scope.allDeveicesList[i].modelId;\n          $scope.alertRulesInfo.modelId = $scope.allDeveicesList[i].modelId;\n          break;\n        }\n      }\n\n      $scope.queryKpis($scope.alertRulesInfo.classify);\n    };\n\n    var selkpisByDomainsinit = false;\n\n    $scope.selkpisByDomains = function () {\n      if ($scope.showType != 'global' && $scope.alertRulesInfo.domain && selkpisByDomainsinit) {\n        //如何选中了管理域\n        $scope.alertRulesInfo.modelId = \"300\";\n        $scope.alertRulesInfo.customerId = \"\";\n        $scope.alertRulesInfo.projectId = \"\";\n        $scope.alertRulesInfo.classify = \"\";\n        $scope.alertRulesInfo.nodeIds = \"\";\n        $scope.queryKpis(\"\");\n      }\n\n      selkpisByDomainsinit = true;\n    };\n\n    $scope.selkpisByCustomer = function () {\n      if ($scope.alertRulesInfo.customerId) {\n        //如何选中了客户，则为客户域，覆盖管理域\n        $scope.alertRulesInfo.modelId = \"301\";\n        $scope.alertRulesInfo.projectId = \"\";\n        $scope.alertRulesInfo.classify = \"\";\n        $scope.alertRulesInfo.nodeIds = \"\";\n        $scope.queryKpis(\"\");\n      }\n    };\n\n    $scope.selkpisByProject = function () {\n      if ($scope.alertRulesInfo.projectId) {\n        //如何选中了项目，则为项目域，覆盖客户域\n        $scope.alertRulesInfo.modelId = \"302\";\n        $scope.alertRulesInfo.classify = \"\";\n        $scope.alertRulesInfo.nodeIds = \"\";\n        $scope.queryKpis(\"\");\n      }\n    }; //通过故障或告警不同状态，用设备模板id调用接口\n\n\n    $scope.kpisLists = [];\n\n    $scope.queryKpis = function (alertCode) {\n      /** 以下是老版本的处理方法，并不好用\n       * 1、每次都重新查询没有必要，因为对于模板的KPI和KQI都存在kpiLists中\n       * 2、域（包括客户、项目）的KQI可以取得后存在kpiLists中\n      var modelID = $scope.alertRulesInfo.modelId ? $scope.alertRulesInfo.modelId : ($scope._modelId ? $scope._modelId : \"\");\n      if (alertCode == \"ALERT\" && modelID) {\n        resourceUIService.getKpisByModelId(modelID, function(returnObj) {\n          if (returnObj.code == 0) {\n            returnObj.data.forEach(function(item) {\n              item.text = item.label;\n            })\n            $scope.kpisLists = returnObj.data;\n          }\n        })\n      } else if (alertCode == \"FAULT\" && modelID) {\n        resourceUIService.getFaultsByModelId(modelID, function(returnObj) {\n          if (returnObj.code == 0) {\n            returnObj.data.forEach(function(item) {\n              item.text = item.label;\n            })\n            $scope.kpisLists = returnObj.data;\n          }\n        })\n      }\n      */\n      var modelID = $scope.alertRulesInfo.modelId;\n      var temLists = [];\n\n      if ($scope.kpiListsDic && $scope.kpiListsDic[modelID]) {\n        for (var i in $scope.kpiListsDic[modelID]) {\n          var kpi = $scope.kpiListsDic[modelID][i];\n\n          if (kpi.type == \"fault\" && alertCode == \"FAULT\") {\n            temLists.push(kpi);\n          } else if (kpi.type == \"kpi\" && alertCode == \"ALERT\") {\n            temLists.push(kpi);\n          } else if (alertCode != \"FAULT\" && alertCode != \"ALERT\") {\n            temLists.push(kpi);\n          }\n        }\n\n        $scope.kpisLists = temLists;\n        $timeout(function () {\n          $scope.$apply();\n        });\n      }\n    }; //      if($scope.kpiLists) {\n    //        for(var key in $scope.kpiLists) {\n    //          var kpi = $scope.kpiLists[key];\n    //          if(modelID && (kpi.modelId == modelID || (kpi.modelIdList && kpi.modelIdList.search(modelID) > -1))) {\n    //            if(kpi.type == \"fault\" && alertCode == \"FAULT\") {\n    //              temLists.push(kpi);\n    //            } else if(kpi.type == \"kpi\" && alertCode == \"ALERT\") {\n    //              temLists.push(kpi);\n    //            } else if(alertCode != \"FAULT\" && alertCode != \"ALERT\") {\n    //              temLists.push(kpi);\n    //            }\n    //          }\n    //        }\n    //        $scope.kpisLists = temLists;\n    //        $timeout(function() {\n    //          $scope.$apply();\n    //        })\n    //      } else {\n    //        growl.info(\"没有获得相关的测点数据，请刷新页面\", {})\n    //      }\n    //    };\n    //触发条件不改变阈值时触发验证\n\n\n    $scope.changeVal = function () {\n      if ($scope.alertRulesInfo.refValue) {\n        $scope.alertRulesInfo.refValue = \"\";\n        $scope.mistakeMesg.number = false; // $scope.verifyFun($scope.alertRulesInfo.refValue, 'number');\n      }\n    }; //验证阈值\n\n\n    $scope.verifyFun = function (value, type) {\n      var reg, r;\n\n      if (type == \"phone\") {\n        var isMob = /^((1[34578]\\d{9})|(0\\d{2,4}\\-\\d{7,8})|\\d{8})$/;\n        r = isMob.test(value);\n\n        if (!r) {\n          $scope.mistakeMesg.phone = true;\n        } else {\n          $scope.mistakeMesg.phone = false;\n        }\n      } else if (type == \"email\") {\n        reg = /^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\\.[a-zA-Z0-9_-]{2,3}){1,2})$/;\n        r = reg.test(value);\n\n        if (!r) {\n          $scope.mistakeMesg.email = true;\n        } else {\n          $scope.mistakeMesg.email = false;\n        }\n      } else if (type == \"number\" && $scope.alertRulesInfo.condition) {\n        reg = /^[+-]?([1-9][0-9]*|0)(\\.[0-9]+)?%?$/; //全体实数\n\n        r = reg.test(value);\n\n        if (!r) {\n          //不为数字\n          $scope.mistakeMesg.number = true;\n        } else {\n          $scope.mistakeMesg.number = false;\n        }\n      } else if (type == \"number\" && !$scope.alertRulesInfo.condition) {\n        //输入表达式\n        if ($.trim(value).length == 0) {\n          $scope.mistakeMesg.number = true;\n        } else {\n          $scope.mistakeMesg.number = false;\n        }\n      }\n    }; //获取所有设备型号，和设备型号里面的所有故障和测点的kpi指标\n\n\n    $scope.kpiLists = {};\n    $scope.kpiListsDic = {};\n\n    var modelLists = function modelLists() {\n      $scope.kpiLists = {};\n      var defer = $q.defer();\n\n      var querykpiLists = function querykpiLists(modelID) {\n        var subdefer = $q.defer();\n        resourceUIService.getDataItemsByModelId(modelID, function (returnObj) {\n          if (returnObj.code == 0) {\n            returnObj.data.forEach(function (item) {\n              item.text = item.label;\n              $scope.kpiLists[item.id] = item;\n            });\n            $scope.kpiListsDic[modelID] = returnObj.data;\n            subdefer.resolve(\"success\");\n          }\n        });\n        return subdefer.promise;\n      };\n\n      resourceUIService.getModels(function (returnObj) {\n        var defers = [];\n\n        if (returnObj.code == 0) {\n          var newObj = [];\n          returnObj.data.push({\n            id: 300,\n            label: \"管理域类型\"\n          });\n\n          if ($scope.baseConfig && $scope.baseConfig.customerConfig && $scope.baseConfig.customerConfig.display) {\n            returnObj.data.push({\n              id: 301,\n              label: \"客户域类型\"\n            });\n          }\n\n          if ($scope.baseConfig && $scope.baseConfig.projectConfig && $scope.baseConfig.projectConfig.display) {\n            returnObj.data.push({\n              id: 302,\n              label: \"项目域类型\"\n            });\n          }\n\n          returnObj.data.forEach(function (item) {\n            defers.push(querykpiLists(item.id));\n            item.text = item.label;\n            item.id = item.id;\n            newObj.push(item);\n          });\n          $scope.allModelLists = newObj;\n        }\n\n        $q.all(defers).then(function () {\n          defer.resolve(\"success\");\n        });\n      });\n      deferList.push(defer.promise);\n    }; //根据用户Id查用户域\n\n\n    var domainTreeQuery = function domainTreeQuery() {\n      var defer = $q.defer();\n      userDomainService.queryDomainTree(userLoginUIService.user.userID, function (data) {\n        $scope.domainListTree = data.domainListTree;\n        $scope.domainListDic = data.domainListDic;\n        defer.resolve(\"success\");\n      });\n      deferList.push(defer.promise);\n    }; //设备模板目录树拼接\n\n\n    function handler(returnObj) {\n      if (returnObj.code == 0) {\n        resourceUIService.rootModelDic = {};\n\n        for (var i in returnObj.data) {\n          var obj = returnObj.data[i];\n          if (!$scope.routePathNodes[obj.parentModelId]) $scope.routePathNodes[obj.parentModelId] = [];\n          $scope.routePathNodes[obj.parentModelId].push(obj);\n          if (!$scope.routePathNodes[obj.id]) $scope.routePathNodes[obj.id] = [];\n          resourceUIService.rootModelDic[obj.id] = obj;\n        }\n\n        var addNodes = function addNodes(parentNode) {\n          for (var modeid in $scope.routePathNodes) {\n            if (modeid == parentNode.id) {\n              parentNode.nodes = $scope.routePathNodes[modeid];\n\n              for (var i in parentNode.nodes) {\n                addNodes(parentNode.nodes[i]);\n              }\n\n              if (parentNode.nodes.length == 0) {\n                parentNode.nodes = null;\n              }\n            }\n          }\n        };\n\n        var initRoutePath = function initRoutePath(node, arr) {\n          for (var i in node.nodes) {\n            if ($routeParams.modelId == node.nodes[i].id) {\n              if (node.id != arr[0].id) arr.push(node);\n              break;\n            } else {\n              initRoutePath(node.nodes[i], arr);\n            }\n          }\n        };\n\n        addNodes(resourceUIService.rootModel);\n\n        for (var key in $scope.routePathNodes) {\n          if (key != resourceUIService.rootModel.id && !resourceUIService.rootModelDic[key]) {\n            for (var i in $scope.routePathNodes[key]) {\n              addNodes($scope.routePathNodes[key][i]);\n              if (!resourceUIService.rootModel.nodes) resourceUIService.rootModel.nodes = [];\n              $scope.routePathNodes[key][i].parentModelId = resourceUIService.rootModel.id;\n              resourceUIService.rootModel.nodes.push($scope.routePathNodes[key][i]);\n            }\n          }\n        }\n\n        resourceUIService.rootModelDic[resourceUIService.rootModel.id] = resourceUIService.rootModel;\n        $scope.rootModelDic = resourceUIService.rootModelDic;\n        $scope.rootModel = resourceUIService.rootModel;\n      }\n    }\n\n    ; //查询所有的设备模板\n\n    var modelList = function modelList() {\n      resourceUIService.getModels(function (returnObj) {\n        if (returnObj.code == 0) {\n          handler(returnObj);\n        }\n      });\n    }; //获取所有设备\n\n\n    var queryAllDevicesList = function queryAllDevicesList() {\n      var defer = $q.defer();\n      resourceUIService.getDevicesByCondition({}, function (returnObj) {\n        if (returnObj.code == 0) {\n          var newObj = [];\n          returnObj.data.forEach(function (obj) {\n            obj.text = obj.label;\n            obj.id = obj.id;\n            newObj.push(obj);\n          });\n          $scope.allDeveicesList = newObj;\n        }\n\n        defer.resolve(\"success\");\n      });\n      deferList.push(defer.promise);\n    }; //获取全部项目\n\n\n    (function () {\n      var defer = $q.defer();\n      projectUIService.findProjectsByCondition({}, function (returnObj) {\n        if (returnObj.code == 0) {\n          var newObj = [];\n          returnObj.data.forEach(function (obj) {\n            obj.text = obj.projectName;\n            obj.id = obj.id;\n            newObj.push(obj);\n          });\n          $scope.projectList = newObj;\n          defer.resolve('asdasd');\n        }\n      });\n      deferList.push(defer.promise);\n    })(); //获取全部客户\n\n\n    (function () {\n      var defer = $q.defer();\n      customerUIService.findCustomersByCondition({}, function (returnObj) {\n        if (returnObj.code == 0) {\n          var newObj = [];\n          returnObj.data.forEach(function (obj) {\n            obj.text = obj.customerName;\n            obj.id = obj.id;\n            newObj.push(obj);\n          });\n          $scope.CustomerList = newObj;\n          $scope.customerDic = returnObj.customerDic;\n        }\n\n        defer.resolve('asdasd');\n      });\n      deferList.push(defer.promise);\n    })(); //获取全部告警分类\n\n\n    $scope.allAlertClassify = function (reflash) {\n      var defer = $q.defer();\n      resourceUIService.findAlertDefinitions({}, function (returnObj) {\n        if (returnObj.code == 0) {\n          returnObj.data.forEach(function (item) {\n            if (item.name) {\n              item.text = item.label + \"（\" + item.name + \"）\";\n            } else {\n              item.text = item.label;\n            }\n          });\n          $scope.alertClassifyLists = [{\n            id: 0,\n            text: \"请选择...\"\n          }].concat(returnObj.data);\n        }\n\n        if (reflash) {\n          growl.success(\"操作成功!\");\n        } else {\n          defer.resolve(\"success\");\n        }\n      });\n      if (!reflash) deferList.push(defer.promise);\n    }; // 清空其他选择项\n\n\n    $scope.getChange = function () {\n      if ($scope.queryState == 1) {\n        $scope.selectedItem.modelId = \"\";\n        $scope.selectedItem.nodeIds = \"\";\n        $scope.selectedItem.domain = \"\";\n      } else if ($scope.queryState == 2) {\n        $scope.selectedItem.domain = \"\";\n        $scope.selectedItem.nodeIds = \"\";\n        $scope.selectedItem.title = \"\";\n      } else if ($scope.queryState == 3) {\n        $scope.selectedItem.domain = \"\";\n        $scope.selectedItem.modelId = \"\";\n        $scope.selectedItem.title = \"\";\n      } else if ($scope.queryState == 4) {\n        $scope.selectedItem.title = \"\";\n        $scope.selectedItem.modelId = \"\";\n        $scope.selectedItem.nodeIds = \"\";\n      }\n    };\n\n    $scope.searchData = function () {\n      var param = {\n        'nodeIds': \"\" ? \"\" : $routeParams.nodeId ? $routeParams.nodeId : $scope.selectedItem.nodeIds,\n        'alertCode': \"\" ? \"\" : $routeParams.alertCode ? $routeParams.alertCode : $scope.selectedItem.alertCode,\n        'modelId': \"\" ? \"\" : $scope.selectedItem.modelId,\n        'domain': $scope.selectedItem.domain ? $scope.selectedItem.domain : \"\",\n        'id': \"\" ? \"\" : $routeParams.rulesId ? $routeParams.rulesId : $scope.selectedItem.id,\n        'title': \"\" ? \"\" : $scope.selectedItem.title\n      };\n      resourceUIService.findKpiThresholds(param, function (returnObj) {\n        if (returnObj.code == 0) {\n          if ($routeParams.rulesId > 0) {\n            returnObj.data[0].nodeIds = parseInt(returnObj.data[0].nodeIds);\n\n            if (returnObj.data[0].modelId == 300 || returnObj.data[0].modelId == 301 || returnObj.data[0].modelId == 302) {\n              returnObj.data[0].nodeIds = \"\";\n            }\n\n            $scope.alertRulesInfo = returnObj.data[0]; // $scope.alertRulesInfo.nodeIds = \"\"; //设备清空，否则在编辑状态没有可选设备，仍可以保存成功\n\n            $scope.queryKpis($scope.alertRulesInfo.classify);\n            return;\n          }\n\n          $scope.alertRulesLists = returnObj.data;\n          $timeout(function () {\n            $scope.$broadcast(Event.ALERTRULESINIT + \"_rules\", {\n              \"option\": [$scope.alertRulesLists]\n            });\n          });\n        }\n      });\n    };\n\n    var init = function init() {\n      initHistory();\n      $scope.allAlertClassify();\n      queryAllDevicesList();\n      domainTreeQuery();\n      modelLists();\n      $q.all(deferList).then(function () {\n        $scope.searchData();\n      });\n\n      if ($routeParams.viewType == \"edit\") {\n        //新增，查看可编辑\n        $scope.showView = true;\n      } else {\n        $scope.showView = false; //不可查看\n      }\n    };\n    /**\n     * 监听登录状态\n     */\n\n\n    if (!userLoginUIService.user.isAuthenticated) {\n      $scope.$on('loginStatusChanged', function (evt, d) {\n        if (userLoginUIService.user.isAuthenticated) {\n          init();\n        }\n      });\n    } else {\n      init();\n    }\n  }]); //告警分类\n\n  controllers.initController('alertClassifyCtrl', ['$scope', 'resourceUIService', 'userDomainService', 'ngDialog', '$location', '$routeParams', '$timeout', 'userLoginUIService', 'Info', 'growl', function ($scope, resourceUIService, userDomainService, ngDialog, $location, $routeParams, $timeout, userLoginUIService, Info, growl) {\n    $scope.alertClassifyLists = []; //告警分类列表\n\n    $scope.mistakeMesg = {}; //错误提示\n\n    $scope.selectedCount = 0; //查询/展示字段\n\n    function initHistory() {\n      $scope.selectedItem = {\n        \"orCondition\": \"\",\n        \"label\": \"\",\n        //告警分类名称\n        \"name\": \"\",\n        //告警类别\n        \"description\": \"\" //说明\n\n      };\n      $scope.alertClassifyInfo = {\n        \"id\": 0,\n        \"label\": \"\",\n        //告警分类名称\n        \"name\": \"\",\n        //告警\n        \"description\": \"\",\n        //说明\n        \"risingTime\": new Date()\n      };\n    }\n\n    ; //弹出框的关闭事件\n\n    $scope.closeDialog = function () {\n      ngDialog.close();\n    }; //添加告警分类\n\n\n    $scope.addalertClassify = function () {\n      initHistory();\n      ngDialog.open({\n        template: '../partials/dialogue/alert_classification_dia.html',\n        className: 'ngdialog-theme-plain',\n        scope: $scope\n      });\n    }; //保存\n\n\n    $scope.saveData = function () {\n      var alertClassifyInfo = $scope.alertClassifyInfo;\n\n      if (alertClassifyInfo.id > 0) {\n        resourceUIService.updateAlertDefinition(alertClassifyInfo, function (returnObj) {\n          if (returnObj.code == 0) {\n            growl.success(\"告警类别修改完成\", {});\n            var alertClassifyLists = $scope.alertClassifyLists;\n\n            for (var i in alertClassifyLists) {\n              if (alertClassifyLists[i].id == alertClassifyInfo.id) {\n                $.extend(alertClassifyLists[i], alertClassifyInfo);\n                break;\n              }\n            }\n\n            $timeout(function () {\n              $scope.$broadcast(Event.ALERTRULESINIT + \"_classify\", {\n                \"option\": [$scope.alertClassifyLists]\n              });\n            });\n            ngDialog.close();\n          }\n        });\n      } else if (alertClassifyInfo.id == 0) {\n        resourceUIService.addAlertDefinition(alertClassifyInfo, function (returnObj) {\n          if (returnObj.code == 0) {\n            growl.success(\"告警类别添加成功\", {});\n            $scope.alertClassifyLists.push(returnObj.data);\n            $timeout(function () {\n              $scope.$broadcast(Event.ALERTRULESINIT + \"_classify\", {\n                \"option\": [$scope.alertClassifyLists]\n              });\n            });\n            ngDialog.close();\n          }\n        });\n      }\n    };\n\n    $scope.doAction = function (type, select, callback) {\n      if (type == \"deleteAlertClassify\") {\n        BootstrapDialog.show({\n          title: '提示',\n          closable: false,\n          message: '确认删除已选中告警类别记录？',\n          buttons: [{\n            label: '确定',\n            cssClass: 'btn-success',\n            action: function action(dialogRef) {\n              resourceUIService.deleteAlertDefinition([select], function (returnObj) {\n                callback(returnObj.code);\n\n                if (returnObj.code == 0) {\n                  var alertClassifyLists = $scope.alertClassifyLists;\n\n                  for (var i in select) {\n                    for (var j in alertClassifyLists) {\n                      if (alertClassifyLists[j].id == select[i]) {\n                        alertClassifyLists.splice(j, 1);\n                      }\n                    }\n                  }\n\n                  $scope.selectedCount = 0;\n                  growl.success(\"告警类别记录已删除\", {});\n                  return;\n                }\n              });\n              dialogRef.close();\n            }\n          }, {\n            label: '取消',\n            action: function action(dialogRef) {\n              dialogRef.close();\n            }\n          }]\n        });\n      }\n    }; // 清空其他选择项\n\n\n    $scope.getChange = function () {\n      $scope.selectedItem.orCondition = !$scope.queryState ? $scope.selectedItem.orCondition : null;\n      $scope.selectedItem.label = $scope.queryState == 1 ? $scope.selectedItem.label : null;\n      $scope.selectedItem.name = $scope.queryState == 2 ? $scope.selectedItem.name : null;\n      $scope.selectedItem.description = $scope.queryState == 3 ? $scope.selectedItem.description : null;\n    }; //验证长度\n\n\n    $scope.verifyFun = function (value, type) {\n      var reg, r;\n\n      if (type == \"length\") {\n        reg = /^(?!.{33}|^\\s*$)/; //不能超32个字符且不为空\n\n        r = reg.test(value);\n\n        if (!r) {\n          $scope.mistakeMesg.length = true;\n        } else {\n          $scope.mistakeMesg.length = false;\n        }\n      }\n    }; //查询\n\n\n    $scope.searchData = function () {\n      var param = {\n        \"id\": \"\" ? \"\" : $routeParams.id ? $routeParams.id : $scope.selectedItem.id,\n        \"orCondition\": \"\" ? \"\" : $scope.selectedItem.orCondition,\n        \"name\": \"\" ? \"\" : $scope.selectedItem.name,\n        \"description\": $scope.selectedItem.description ? $scope.selectedItem.description : \"\",\n        \"label\": \"\" ? \"\" : $scope.selectedItem.label\n      };\n      resourceUIService.findAlertDefinitions(param, function (returnObj) {\n        if (returnObj.code == 0) {\n          $scope.alertClassifyLists = returnObj.data;\n          $timeout(function () {\n            $scope.$broadcast(Event.ALERTRULESINIT + \"_classify\", {\n              \"option\": [$scope.alertClassifyLists]\n            });\n          });\n        }\n      });\n    };\n\n    var init = function init() {\n      initHistory();\n      $scope.searchData();\n    };\n    /**\n     * 监听登录状态\n     */\n\n\n    if (!userLoginUIService.user.isAuthenticated) {\n      $scope.$on('loginStatusChanged', function (evt, d) {\n        if (userLoginUIService.user.isAuthenticated) {\n          init();\n        }\n      });\n    } else {\n      init();\n    }\n  }]); //告警通知规则\n\n  controllers.initController('alertInformCtrl', ['$scope', 'resourceUIService', '$q', 'dictionaryService', 'userEnterpriseService', 'userDomainService', 'ngDialog', '$location', '$routeParams', '$timeout', 'userLoginUIService', 'Info', 'growl', function ($scope, resourceUIService, $q, dictionaryService, userEnterpriseService, userDomainService, ngDialog, $location, $routeParams, $timeout, userLoginUIService, Info, growl) {\n    $scope.routePathNodes = {};\n    $scope.alertInformLists = [];\n    $scope.allModelLists = []; // 模板\n\n    $scope.selectedCount = 0;\n    var deferList = [];\n    var rootInformId = $routeParams.alertInformsId; //跳转过来的id\n\n    $scope.mistakeMesg = {\n      //验证错误信息提示\n      email: false,\n      phone: false\n    }; //查询/展示字段\n\n    function initHistory() {\n      $scope.selectedItem = {\n        \"label\": \"\",\n        //告警分类名称\n        \"modelId\": \"\",\n        //设备型号\n        \"name\": \"\" //分类编码\n\n      };\n      $scope.alertInformsInfo = {\n        \"id\": 0,\n        \"kpiThresholdId\": rootInformId,\n        \"ruleName\": \"\",\n        //告警通知规则名称\n        \"personType\": \"\",\n        //通知人员类型\n        \"noticeRole\": \"\",\n        //通知角色\n        templates: [{\n          \"noticeWay\": \"\",\n          //通知方式\n          \"noticeRole\": \"\",\n          //角色\n          \"noticeTemplate\": \"\",\n          //通知模板\n          \"contact\": \"\" //联系方式\n\n        }],\n        \"risingTime\": new Date()\n      };\n    }\n\n    ;\n\n    var initData = function initData() {\n      //人员\n      $scope.notificationType = $scope.myDicts['noticePersonType']; //通知方式\n\n      $scope.notificationList = $scope.myDicts['noticeWay']; //所有通知列表\n\n      $scope.templates = [];\n      $scope.notificationList.forEach(function (list) {\n        if (list.valueCode != 'sysmessage') {\n          $scope.notificationType.forEach(function (item) {\n            var templatesDic = {\n              personType: item.valueCode,\n              personTypeLabel: item.label,\n              noticeWay: list.valueCode,\n              noticeWayLabel: list.label,\n              state: true,\n              noticeRole: \"\",\n              //角色\n              noticeTemplate: \"\",\n              //通知模板\n              contact: \"\" //联系方式\n\n            };\n            $scope.templates.push(templatesDic);\n          });\n        }\n      });\n      $scope.templates.push({\n        personType: 'inSystem',\n        personTypeLabel: '系统人员',\n        noticeWay: 'sysmessage',\n        noticeWayLabel: '站内消息',\n        state: true,\n        noticeRole: \"\",\n        //角色\n        noticeTemplate: \"\",\n        //通知模板\n        contact: \"\" //联系方式\n\n      });\n    }; //弹出框的关闭事件\n\n\n    $scope.closeDialog = function () {\n      ngDialog.close();\n    }; //添加告警通知\n\n\n    $scope.addalertInforms = function () {\n      initHistory();\n      $scope.templates.forEach(function (item) {\n        item.state = true;\n        item.contact = \"\";\n      }); // $scope.notifications = [];\n      // $scope.queryTemplLists = [];\n\n      ngDialog.open({\n        template: '../partials/dialogue/alert_inform_dia.html',\n        className: 'ngdialog-theme-plain',\n        scope: $scope\n      });\n    }; //保存\n\n\n    $scope.saveData = function () {\n      var alertInformsInfo = $scope.alertInformsInfo;\n      var templParams = $scope.templates.filter(function (item) {\n        return item.state == true && item.personType == alertInformsInfo.personType;\n      });\n      alertInformsInfo.templates = templParams;\n\n      if (templParams.length == 0 && alertInformsInfo.personType == 'outSystem') {\n        growl.warning(\"请手机号或邮箱选其一进行填写\", {});\n        return;\n      }\n\n      if (alertInformsInfo.personType == 'outSystem') {\n        for (var key in templParams) {\n          if (templParams[key].contact == \"\") {\n            growl.warning(\"请输入完成\" + templParams[key].noticeWayLabel + \"信息\");\n            return;\n          }\n        }\n      }\n\n      if ($scope.mistakeMesg.phone && alertInformsInfo.personType == 'outSystem') {\n        growl.warning(\"请正确输入手机号\", {});\n        return;\n      }\n\n      if ($scope.mistakeMesg.email && alertInformsInfo.personType == 'outSystem') {\n        growl.warning(\"请输入正确的邮箱地址\", {});\n        return;\n      }\n\n      if ((alertInformsInfo.noticeRole == 0 || alertInformsInfo.noticeRole == \"\") && alertInformsInfo.personType == 'inSystem') {\n        growl.warning(\"请选择通知角色\", {});\n        return;\n      }\n\n      var ruleTempName = getRuleTempName(alertInformsInfo);\n\n      if (alertInformsInfo.id > 0) {\n        if ($scope.alertInformDic[ruleTempName]) {\n          var find = $scope.alertInformDic[ruleTempName].find(function (elem) {\n            return elem.id == alertInformsInfo.id;\n          });\n\n          if (!find) {\n            growl.warning(\"该通知信息已经有类似的，请选中【\" + $scope.alertInformDic[ruleTempName][0].ruleName + \"】\", {});\n            return;\n          }\n        }\n\n        var updatedDeferList = [];\n        $scope.alertInformDic[alertInformsInfo.ruleTempName].forEach(function (item) {\n          var defer = $q.defer();\n          item.ruleName = alertInformsInfo.ruleName;\n          item.noticeRole = alertInformsInfo.noticeRole;\n          item.templates = alertInformsInfo.templates;\n          item.personType = alertInformsInfo.personType;\n          resourceUIService.updateNoticeRule(item, function (returnObj) {\n            if (returnObj.code == 0) {\n              defer.resolve(\"success\");\n            }\n          });\n          updatedDeferList.push(defer.promise);\n        });\n        $q.all(updatedDeferList).then(function () {\n          growl.success(\"告警通知信息修改完成\", {});\n          var alertInformLists = $scope.alertInformLists;\n\n          for (var i in alertInformLists) {\n            if (alertInformLists[i].id == alertInformsInfo.id) {\n              $.extend(alertInformLists[i], alertInformsInfo);\n              break;\n            }\n          }\n\n          $timeout(function () {\n            $scope.$broadcast(Event.ALERTRULESINIT + \"_informs\", {\n              \"option\": [$scope.alertInformLists]\n            });\n          });\n          ngDialog.close();\n        });\n      } else if (alertInformsInfo.id == 0) {\n        if ($scope.alertInformDic[ruleTempName]) {\n          growl.warning(\"该通知信息已经有类似的，请选中【\" + $scope.alertInformDic[ruleTempName][0].ruleName + \"】\", {});\n          return;\n        }\n\n        resourceUIService.addNoticeRule(alertInformsInfo, function (returnObj) {\n          if (returnObj.code == 0) {\n            growl.success(\"告警通知信息添加成功\", {});\n            var newItem = returnObj.data;\n            newItem.ruleTempName = ruleTempName;\n            newItem.kpiThresholdIds = [rootInformId];\n            newItem.selected = true;\n            $scope.alertInformLists.push(newItem);\n            $scope.alertInformDic[ruleTempName] = [newItem];\n            $timeout(function () {\n              $scope.$broadcast(Event.ALERTRULESINIT + \"_informs\", {\n                \"option\": [$scope.alertInformLists]\n              });\n            });\n            ngDialog.close();\n          }\n        });\n      }\n    }; //动作\n\n\n    $scope.doAction = function (type, select, callback) {\n      if (type == \"deleteAlertForm\") {\n        BootstrapDialog.show({\n          title: '提示',\n          closable: false,\n          message: '如删除该告警通知记录，则基于该通知的告警规则都会失效，确认要删除么？',\n          buttons: [{\n            label: '确定',\n            cssClass: 'btn-success',\n            action: function action(dialogRef) {\n              var delIds = []; //查找字典下该规则的通知\n\n              $scope.alertInformDic[select.ruleTempName].forEach(function (delitem) {\n                delIds.push(delitem.id);\n              });\n              resourceUIService.deleteNoticeRule([delIds], function (returnObj) {\n                if (returnObj.code == 0) {\n                  callback(returnObj.code);\n\n                  for (var i in $scope.alertInformLists) {\n                    if ($scope.alertInformLists[i].id == select.id) {\n                      $scope.alertInformLists.splice(i, 1);\n                    }\n                  }\n\n                  delete $scope.alertInformDic[select.ruleTempName];\n                  $scope.selectedCount = 0;\n                  growl.success(\"告警通知信息已删除\", {});\n                  return;\n                } else {\n                  callback(returnObj.code);\n                }\n              });\n              dialogRef.close();\n            }\n          }, {\n            label: '取消',\n            action: function action(dialogRef) {\n              dialogRef.close();\n            }\n          }]\n        });\n      } else if (type == \"enabled\") {\n        var alertInformsInfo = jQuery.extend(true, {}, select);\n        alertInformsInfo.id = 0;\n        alertInformsInfo.kpiThresholdId = rootInformId;\n        resourceUIService.addNoticeRule(alertInformsInfo, function (returnObj) {\n          if (returnObj.code == 0) {\n            growl.success(\"告警通知信息启用成功\", {});\n            var newItem = returnObj.data;\n            newItem.ruleTempName = select.ruleTempName;\n            select.kpiThresholdIds.push(rootInformId);\n            $scope.alertInformDic[select.ruleTempName] = [newItem];\n          }\n        });\n      } else if (type == \"disabled\") {\n        var choseItem = null;\n\n        for (var i = $scope.alertInformDic[select.ruleTempName].length - 1; i > -1; i--) {\n          if ($scope.alertInformDic[select.ruleTempName][i].kpiThresholdId == rootInformId) {\n            choseItem = $scope.alertInformDic[select.ruleTempName][i];\n            $scope.alertInformDic[select.ruleTempName].splice(i, 1);\n          }\n        }\n\n        if ($scope.alertInformDic[select.ruleTempName].length > 0) {\n          resourceUIService.deleteNoticeRule([[choseItem.id]], function (returnObj) {\n            if (returnObj.code == 0) {\n              growl.success(\"告警通知信息停用成功\", {});\n            }\n          });\n        } else {\n          choseItem.kpiThresholdId = 0;\n          resourceUIService.updateNoticeRule(choseItem, function (returnObj) {\n            if (returnObj.code == 0) {\n              growl.success(\"告警通知信息停用成功\", {});\n            }\n          });\n        }\n      }\n    }; //角色转换\n\n\n    $scope.changeRole = function (type) {\n      if (type == 'outSystem') {\n        $scope.alertInformsInfo.noticeRole = \"\";\n      }\n    }; //验证\n\n\n    $scope.alertFun = function (obj) {\n      if (obj.state) {\n        //如果跟踪为真，则用户点击为不选中\n        obj.state = false;\n        obj.contact = \"\";\n      } else {\n        obj.state = true;\n      }\n    }; //验证信息\n\n\n    $scope.verifyFun = function (value, type) {\n      var reg, r;\n\n      if (type == \"sms\") {\n        if (!value) {\n          $scope.mistakeMesg.phone = false;\n          return;\n        }\n\n        var isMob = /^((1[34578]\\d{9})|(0\\d{2,4}\\-\\d{7,8})|\\d{8})$/;\n        r = isMob.test(value);\n\n        if (!r) {\n          $scope.mistakeMesg.phone = true;\n        } else {\n          $scope.mistakeMesg.phone = false;\n        }\n      } else if (type == \"email\") {\n        if (!value) {\n          $scope.mistakeMesg.email = false;\n          return;\n        }\n\n        reg = /^([a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+((\\.[a-zA-Z0-9_-]{2,3}){1,2})$/;\n        r = reg.test(value);\n\n        if (!r) {\n          $scope.mistakeMesg.email = true;\n        } else {\n          $scope.mistakeMesg.email = false;\n        }\n      }\n    }; //通过type过滤通知方式\n\n\n    $scope.queryType = function (type) {\n      $scope.alertInformsInfo.resourceType = \"\";\n      $scope.notifications = [];\n\n      for (var i in $scope.notificationList) {\n        var code = $scope.notificationList[i].valueCode;\n\n        if (code == \"sysmessage\" && type == \"outSystem\") {\n          continue;\n        }\n\n        $scope.notifications.push($scope.notificationList[i]);\n      }\n\n      ;\n\n      if ($scope.alertInformsInfo.noticeWay) {\n        $scope.queryMesg($scope.alertInformsInfo.noticeWay);\n      }\n    }; //通过通知方式过滤消息模板\n\n\n    $scope.queryMesg = function (id) {\n      $scope.alertInformsInfo.resourceType = \"\";\n      $scope.queryTemplLists = []; //内容通知模板\n      //手机通知系统外\n\n      templLists.forEach(function (item) {\n        if (item.noticeWay == id && item.personType == $scope.alertInformsInfo.personType) {\n          $scope.queryTemplLists.push(item);\n        }\n      });\n\n      if ($scope.alertInformsInfo.noticeWay == 'sms') {\n        $scope.verifyFun($scope.alertInformsInfo.contact, 'phone');\n      } else if ($scope.alertInformsInfo.noticeWay == 'email') $scope.verifyFun($scope.alertInformsInfo.contact, 'email');\n    }; //查看所有内容模板\n\n\n    var templLists = [];\n\n    var queryAllTempl = function queryAllTempl() {\n      var defer = $q.defer();\n      resourceUIService.findTemplateByCondition('alert', function (returnObj) {\n        if (returnObj.code == 0) {\n          templLists = returnObj.data;\n          $scope.templLists = returnObj.data;\n          $scope.templates.forEach(function (list) {\n            templLists.forEach(function (item) {\n              if (list.noticeWay == item.noticeWay && list.personType == item.personType) {\n                list.noticeTemplate = item.id;\n                list.noticeTemplateDesc = item.desc;\n              }\n            });\n          });\n        }\n\n        defer.resolve(\"success\");\n      });\n      deferList.push(defer.promise);\n    }; //查看企业下所有角色列表\n\n\n    var queryAllRoles = function queryAllRoles() {\n      var defer = $q.defer();\n      userEnterpriseService.queryEnterpriseRole(function (returnObj) {\n        if (returnObj.code == 0) {\n          returnObj.data.forEach(function (item) {\n            item.id = item.roleID;\n            item.text = item.roleName;\n          });\n          $scope.allRoles = returnObj.data ? returnObj.data : [];\n        }\n\n        defer.resolve(\"success\");\n      });\n      deferList.push(defer.promise);\n    }; // 清空其他选择项\n\n\n    $scope.getChange = function () {\n      if ($scope.queryState == 1) {\n        $scope.selectedItem.modelId = \"\";\n        $scope.selectedItem.name = \"\";\n      } else if ($scope.queryState == 2) {\n        $scope.selectedItem.label = \"\";\n        $scope.selectedItem.name = \"\";\n      } else if ($scope.queryState == 3) {\n        $scope.selectedItem.label = \"\";\n        $scope.selectedItem.modelId = \"\";\n      }\n    };\n\n    $scope.searchData = function () {\n      var param = {\n        //        'kpiThresholdId': rootInformId,\n        'ruleName': \"\" ? \"\" : $scope.selectedItem.ruleName,\n        //告警通知名称\n        'personType': $scope.selectedItem.personType ? $scope.selectedItem.personType : \"\",\n        //通知人员类型\n        'noticeWay': \"\" ? \"\" : $scope.selectedItem.noticeWay ? $scope.selectedItem.noticeWay : \"\" //通知方式\n\n      };\n      resourceUIService.findNoticeRules(param, function (returnObj) {\n        if (returnObj.code == 0) {\n          //          $scope.alertInformLists = returnObj.data;\n          $scope.alertInformDic = {};\n          var alertInformLists = [];\n          returnObj.data.forEach(function (item) {\n            if (!item.kpiThresholdIds || item.kpiThresholdId && item.kpiThresholdIds.length == 0) {\n              //老通知规则\n              var ruleTempName = getRuleTempName(item);\n              if (!$scope.alertInformDic[ruleTempName]) $scope.alertInformDic[ruleTempName] = [];\n              $scope.alertInformDic[ruleTempName].push(item);\n            } else {\n              //新版本的ifttt没有做完，暂时使用老版本\n              var ruleTempName = getRuleTempName(item);\n              if (!$scope.alertInformDic[ruleTempName]) $scope.alertInformDic[ruleTempName] = [];\n              $scope.alertInformDic[ruleTempName].push(item);\n            }\n          });\n\n          for (var key in $scope.alertInformDic) {\n            var newItem = null;\n            $scope.alertInformDic[key].forEach(function (item) {\n              if (!newItem) {\n                newItem = jQuery.extend(true, {}, item);\n                newItem.ruleTempName = key;\n                newItem.kpiThresholdIds = [];\n              }\n\n              if (item.kpiThresholdId == rootInformId) newItem.selected = true;\n              newItem.kpiThresholdIds.push(item.kpiThresholdId);\n            });\n            alertInformLists.push(newItem);\n          }\n\n          $scope.alertInformLists = alertInformLists;\n          $timeout(function () {\n            $scope.$broadcast(Event.ALERTRULESINIT + \"_informs\", {\n              \"option\": [$scope.alertInformLists]\n            });\n          });\n        }\n      });\n    };\n\n    var getRuleTempName = function getRuleTempName(item) {\n      //处理通知模板\n      var templates = \"\";\n\n      if (item.templates) {\n        item.templates.forEach(function (template) {\n          templates += template.noticeWay + template.contact + \"|\";\n        });\n      } //如果通知规则一样则认为是同一个规则\n\n\n      var ruleTempName = \"noticeRole:\" + item.noticeRole + \"&personType:\" + item.personType + \"&templates:\" + templates;\n      return ruleTempName;\n    };\n\n    var init = function init() {\n      var inithandler = function inithandler() {\n        initData();\n        initHistory();\n        queryAllRoles();\n        queryAllTempl();\n        $q.all(deferList).then(function () {\n          $scope.searchData();\n        });\n      };\n\n      if (!$scope.myDicts) {\n        $scope.$watch(\"myDicts\", function (n, o) {\n          if (n) {\n            inithandler();\n          }\n        });\n      } else {\n        inithandler();\n      }\n    };\n    /**\n     * 监听登录状态\n     */\n\n\n    if (!userLoginUIService.user.isAuthenticated) {\n      $scope.$on('loginStatusChanged', function (evt, d) {\n        if (userLoginUIService.user.isAuthenticated) {\n          init();\n        }\n      });\n    } else {\n      init();\n    }\n  }]); //数据项\n\n  controllers.initController('kpiTypeCtrl', ['$scope', 'resourceUIService', 'userDomainService', 'ngDialog', '$location', '$routeParams', '$timeout', 'userLoginUIService', 'Info', 'growl', function ($scope, resourceUIService, userDomainService, ngDialog, $location, $routeParams, $timeout, userLoginUIService, Info, growl) {\n    $scope.kpiTypeLists = []; //告警分类列表\n\n    $scope.mistakeMesg = {}; //错误提示\n\n    $scope.selectedCount = 0; //查询/展示字段\n\n    function initHistory() {\n      $scope.selectedItem = {\n        \"orCondition\": \"\",\n        \"label\": \"\",\n        //告警分类名称\n        \"name\": \"\",\n        //告警类别\n        \"description\": \"\" //说明\n\n      };\n      $scope.kpiTypeInfo = {\n        \"id\": 0,\n        \"label\": \"\",\n        //数据项名称\n        \"name\": \"\",\n        //数据项name\n        \"unit\": \"\",\n        //数据项单位\n        \"number\": \"\",\n        //是否数值\n        \"type\": \"\",\n        //数据分类\n        \"range\": \"\",\n        //取值范围\n        \"icon\": \"\" //数据项图标\n\n      };\n    }\n\n    ; //弹出框的关闭事件\n\n    $scope.closeDialog = function () {\n      ngDialog.close();\n    }; //添加告警分类\n\n\n    $scope.addkpiType = function () {\n      initHistory();\n      ngDialog.open({\n        template: '../partials/dialogue/kpi_type_dia.html',\n        className: 'ngdialog-theme-plain',\n        scope: $scope\n      });\n    }; //保存\n\n\n    $scope.saveKpiType = function () {\n      // debugger\n      var kpiTypeInfo = $scope.kpiTypeInfo;\n\n      if (kpiTypeInfo.id > 0) {\n        resourceUIService.saveKpiType(kpiTypeInfo, function (returnObj) {\n          if (returnObj.code == 0) {\n            growl.success(\"数据项修改完成\", {});\n            var kpiTypeLists = $scope.kpiTypeLists;\n\n            for (var i in kpiTypeLists) {\n              if (kpiTypeLists[i].id == kpiTypeInfo.id) {\n                $.extend(kpiTypeLists[i], kpiTypeInfo);\n                break;\n              }\n            }\n\n            $timeout(function () {\n              $scope.$broadcast(Event.ALERTRULESINIT + \"_kpitype\", {\n                \"option\": [$scope.kpiTypeLists]\n              });\n            });\n            ngDialog.close();\n          }\n        });\n      } else if (kpiTypeInfo.id == 0) {\n        resourceUIService.saveKpiType(kpiTypeInfo, function (returnObj) {\n          if (returnObj.code == 0) {\n            growl.success(\"数据项添加成功\", {});\n            $scope.kpiTypeLists.push(returnObj.data);\n            $timeout(function () {\n              $scope.$broadcast(Event.ALERTRULESINIT + \"_kpitype\", {\n                \"option\": [$scope.kpiTypeLists]\n              });\n            });\n            ngDialog.close();\n          }\n        });\n      }\n    }; //删除\n\n\n    $scope.doAction = function (type, select, callback) {\n      if (type == \"deleteAlertClassify\") {\n        BootstrapDialog.show({\n          title: '提示',\n          closable: false,\n          message: '确认删除已选中数据项？',\n          buttons: [{\n            label: '确定',\n            cssClass: 'btn-success',\n            action: function action(dialogRef) {\n              resourceUIService.deleteKpiTypeByIds([select], function (returnObj) {\n                callback(returnObj.code);\n\n                if (returnObj.code == 0) {\n                  var kpiTypeLists = $scope.kpiTypeLists;\n\n                  for (var i in select) {\n                    for (var j in kpiTypeLists) {\n                      if (kpiTypeLists[j].id == select[i]) {\n                        kpiTypeLists.splice(j, 1);\n                      }\n                    }\n                  }\n\n                  $scope.selectedCount = 0;\n                  growl.success(\"数据项记录已删除\", {});\n                  return;\n                }\n              });\n              dialogRef.close();\n            }\n          }, {\n            label: '取消',\n            action: function action(dialogRef) {\n              dialogRef.close();\n            }\n          }]\n        });\n      }\n    }; // 清空其他选择项\n\n\n    $scope.getChange = function () {\n      $scope.selectedItem.orCondition = !$scope.queryState ? $scope.selectedItem.orCondition : null;\n      $scope.selectedItem.label = $scope.queryState == 1 ? $scope.selectedItem.label : null;\n      $scope.selectedItem.name = $scope.queryState == 2 ? $scope.selectedItem.name : null;\n      $scope.selectedItem.description = $scope.queryState == 3 ? $scope.selectedItem.description : null;\n    }; //验证长度\n\n\n    $scope.verifyFun = function (value, type) {\n      var reg, r;\n\n      if (type == \"length\") {\n        reg = /^(?!.{33}|^\\s*$)/; //不能超32个字符且不为空\n\n        r = reg.test(value);\n\n        if (!r) {\n          $scope.mistakeMesg.length = true;\n        } else {\n          $scope.mistakeMesg.length = false;\n        }\n      }\n    }; //查询\n\n\n    $scope.searchData = function () {\n      var param = {\n        // \"id\": \"\" ? \"\" : ($routeParams.id ? $routeParams.id : $scope.selectedItem.id),\n        // \"orCondition\": \"\" ? \"\" : $scope.selectedItem.orCondition,\n        // \"name\": \"\" ? \"\" : $scope.selectedItem.name,\n        // \"description\": $scope.selectedItem.description ? $scope.selectedItem.description : \"\",\n        \"label\": \"\" ? \"\" : $scope.selectedItem.label\n      };\n      resourceUIService.getKpiTypeByFilter(param, function (returnObj) {\n        // debugger\n        if (returnObj.code == 0) {\n          $scope.kpiTypeLists = returnObj.data;\n          $timeout(function () {\n            $scope.$broadcast(Event.ALERTRULESINIT + \"_kpitype\", {\n              \"option\": [$scope.kpiTypeLists]\n            });\n          });\n        }\n      });\n    };\n\n    var init = function init() {\n      initHistory();\n      $scope.searchData();\n    };\n    /**\n     * 监听登录状态\n     */\n\n\n    if (!userLoginUIService.user.isAuthenticated) {\n      $scope.$on('loginStatusChanged', function (evt, d) {\n        if (userLoginUIService.user.isAuthenticated) {\n          init();\n        }\n      });\n    } else {\n      init();\n    }\n  }]);\n});"],"sourceRoot":"/source/"}