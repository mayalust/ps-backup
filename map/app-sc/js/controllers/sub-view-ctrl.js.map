{"version":3,"sources":["app-sc/js/controllers/sub-view-ctrl.js"],"names":["define","controllers","psUltility","initController","scope","$state","$stateParams","userEnterpriseService","rootScope","routeParams","resourceUIService","timeout","growl","q","window","location","viewFlexService","freeboardservice","userLoginUIService","roleViewService","commonMethodService","serviceProxy","instance","viewId","str","defer","url","cmd","$root","path","index","urlparser","href","callApi","service","method","param","get","d","code","resolve","data","reject","e","promise","getViewById_back","event","input","dt","content","JSON","parse","setting","bgColor","color","hasOwnProperty","find","element","tabIndex","indexOf","tabs","groups","layout","editData","replaceCiKpi","setMode","renderLayout","navigation","label","error","message","test","some","address","item","port","then","stopInspection","success","reload","catch","saveView","startInspection","psrequire","view","console","log","isNaN","getView","json","getResourceById","params","id","res","setValue","getViewById"],"mappings":"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","file":"app-sc/js/controllers/sub-view-ctrl.js","sourcesContent":["define(['controllers/controllers', '../../../../node_modules/ps-ultility/ps-ultility'], function (controllers, psUltility) {\n  'use strict';\n\n  controllers.initController('subViewCtrl', ['$scope', '$state', '$stateParams', 'userEnterpriseService', '$rootScope', '$routeParams', 'resourceUIService', '$timeout', 'growl', '$q', '$window', '$location', 'viewFlexService', 'freeboardservice', 'userLoginUIService', 'roleViewService', 'commonMethodService', 'serviceProxy', function (scope, $state, $stateParams, userEnterpriseService, rootScope, routeParams, resourceUIService, timeout, growl, q, window, location, viewFlexService, freeboardservice, userLoginUIService, roleViewService, commonMethodService, serviceProxy) {\n    scope.instance = {};\n    var cmd = commonMethodService();\n    var viewId = scope.$root.viewId = $stateParams.viewId,\n        path = $stateParams.index,\n        url = psUltility.urlparser(window.location.href);\n    /**  本地8080端口执行调用本地js视图文件 **/\n\n    function callApi(service, method, param) {\n      var defer = q.defer(),\n          callBack = function callBack(d) {\n        if (d.code == 0) {\n          defer.resolve(d.data || []);\n        } else {\n          defer.reject(d);\n        }\n      },\n          error = function error(e) {\n        defer.reject(e);\n      };\n\n      serviceProxy.get(service, method, param, callBack, error);\n      return defer.promise;\n    }\n\n    function startInspection(viewId) {\n      return callApi(\"inspectionService\", \"start\", viewId);\n    }\n\n    function stopInspection(viewId) {\n      return callApi(\"inspectionService\", \"end\", viewId);\n    }\n\n    function saveView(viewId) {\n      return callApi(\"inspectionService\", \"save\", viewId);\n    }\n\n    function getListeners(viewId) {\n      return callApi(\"inspectionService\", \"getlisteners\", viewId);\n    }\n\n    function checkLoadLocalView(viewId) {\n      var defer = q.defer(),\n          url = psUltility.urlparser(window.location.href);\n\n      function hasValue(str) {\n        return function (item) {\n          return item === str;\n        };\n      }\n\n      if (!/\\d+/.test(viewId + \"\")) {\n        defer.reject(\"not a number\");\n        return defer.promise;\n      }\n\n      if ([\"localhost\", \"127.0.0.1\"].some(hasValue(url.address)) && /808\\d/.test(url.port + \"\")) {\n        getListeners(viewId).then(function (d) {\n          if (d.indexOf(viewId) !== -1) {\n            rootScope.stopInspection = function () {\n              stopInspection(viewId).then(function (d) {\n                growl.success(\"结束本地监听视图 : \" + viewId);\n                window.location.reload();\n              }).catch(function (e) {\n                growl.error(\"移除监听故障 : \" + viewId);\n              });\n            };\n\n            rootScope.saveView = function () {\n              saveView(viewId).then(function (d) {\n                growl.success(\"成功保存视图 : \" + viewId);\n              }).catch(function (e) {\n                growl.error(\"不能保存视图 : \" + viewId);\n              });\n            };\n\n            delete rootScope.startInspection;\n          } else {\n            rootScope.startInspection = function () {\n              startInspection(viewId).then(function (d) {\n                growl.success(\"开始本地监听视图 : \" + viewId);\n                window.location.reload();\n              }).catch(function (e) {\n                growl.error(\"监听故障 : \" + viewId);\n              });\n            };\n\n            delete rootScope.stopInspection;\n            delete rootScope.saveView;\n          }\n\n          if (typeof viewId !== \"undefined\") {\n            psrequire([\"../app-views/build/\" + viewId + \".\" + path], function (view) {\n              var editData = new freeboardservice.replaceCiKpi(view, function () {\n                timeout(function () {\n                  scope.instance.setMode(true);\n                  scope.instance.renderLayout(editData, null, null, scope);\n                });\n              }, null, null, scope);\n              defer.resolve(\"user local\");\n            }, function (e) {\n              console.log(\"没找到本地视图从服务器加载视图\");\n              defer.reject(\"user server\");\n            });\n          }\n        });\n      } else {\n        defer.reject(\"user server\");\n      }\n\n      return defer.promise;\n    }\n    /**  本地8080端口执行调用本地js视图文件 **/\n\n\n    function toObject(content) {\n      var dt = JSON.parse(content);\n\n      if (typeof dt.setting == \"string\") {\n        dt.setting = JSON.parse(dt.setting);\n      }\n\n      scope.setting = dt.setting;\n\n      if (dt.setting) {\n        scope.bgColor = dt.setting.color;\n      }\n\n      return dt;\n    }\n\n    function getViewById_back(event) {\n      if (event.code == 0 && event.data != null) {\n        var input;\n        var dt = toObject(event.data.content);\n\n        if (dt.hasOwnProperty(\"groups\")) {\n          var find = dt[\"groups\"].find(function (element) {\n            return $stateParams.index == element.path;\n          });\n          scope.tabIndex = find ? dt['groups'].indexOf(find) : 0;\n          scope.tabs = dt.groups;\n          input = {\n            layout: dt.groups[scope.tabIndex].layout,\n            setting: dt.setting\n          };\n          var editData = new freeboardservice.replaceCiKpi(input, function () {\n            timeout(function () {\n              scope.instance.setMode(true);\n              scope.instance.renderLayout(editData, null, null, scope);\n            });\n          }, null, dt, scope);\n        } else if (dt.hasOwnProperty(\"layout\")) {\n          scope.navigation = [{\n            label: \"服务中心\"\n          }];\n          input = {\n            layout: dt.layout,\n            setting: dt.setting\n          };\n          var editData = new freeboardservice.replaceCiKpi(input, function () {\n            timeout(function () {\n              scope.instance.setMode(true);\n              scope.instance.renderLayout(editData, null, null, scope);\n            });\n          }, null, dt, scope);\n        }\n\n        ;\n      } else {\n        scope.error = \"获取此此用户角色的服务视图发生错误\" + (event.message ? \",\" + event.message : \"\");\n      }\n\n      ;\n    }\n\n    ;\n    checkLoadLocalView(viewId).then(function (e) {\n      console.log(\"use local views\");\n    }).catch(function (d) {\n      if (!isNaN(viewId)) {\n        cmd.getResourceById($state.params.id, function (res) {\n          cmd.setValue(\"global/resource\", res);\n          viewFlexService.getViewById(viewId, getViewById_back);\n        });\n      } else {\n        // 针对directive的名称解析对应的视图\n        cmd.getView({\n          path: \"viewCtrl:\" + viewId,\n          item: {}\n        }, function (json) {\n          var editData = new freeboardservice.replaceCiKpi(json, function () {\n            timeout(function () {\n              scope.instance.setMode(true);\n              scope.instance.renderLayout(editData, null, null, scope);\n            });\n          }, null, null, scope);\n        });\n      }\n    });\n  }]);\n});"],"sourceRoot":"/source/"}