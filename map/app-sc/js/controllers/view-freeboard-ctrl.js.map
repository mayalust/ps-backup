{"version":3,"sources":["app-sc/js/controllers/view-freeboard-ctrl.js"],"names":["_typeof","obj","Symbol","iterator","constructor","prototype","define","controllers","initController","scope","$state","$stateParams","userEnterpriseService","rootScope","routeParams","resourceUIService","timeout","growl","q","window","location","viewFlexService","freeboardservice","userLoginUIService","roleViewService","commonMethodService","page","callback","user","pa","parameter","watch","$watch","newValue","oldValue","baseConfig","openSidebar","$","css","signClick","href","naviClick","link","param","trigger","encodeURIComponent","JSON","stringify","bgColorFn","bgColor","background-color","setCurrentTab","str","navigation","length","label","json","parse","tabLabel","roleID","console","assert","defers","split","map","e","defer","queryEnterpriseRole","returnObj","code","role","data","find","item","resolve","reject","promise","all","then","objLike","arrLike","rs","i","r","RegExp","test","Array","push","apply","getViewByFunctionCode_back","viewId","getViewByFunctionCode","currentRoleID","getCurrentUser","$on","event","args"],"mappings":"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","file":"app-sc/js/controllers/view-freeboard-ctrl.js","sourcesContent":["function _typeof(obj) { if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; }; } return _typeof(obj); }\n\ndefine(['controllers/controllers', 'Array'], function (controllers) {\n  'use strict';\n\n  controllers.initController('viewFreeboardCtrl', ['$scope', '$state', '$stateParams', 'userEnterpriseService', '$rootScope', '$routeParams', 'resourceUIService', '$timeout', 'growl', '$q', '$window', '$location', 'viewFlexService', 'freeboardservice', 'userLoginUIService', 'roleViewService', 'commonMethodService', function (scope, $state, $stateParams, userEnterpriseService, rootScope, routeParams, resourceUIService, timeout, growl, q, window, location, viewFlexService, freeboardservice, userLoginUIService, roleViewService, commonMethodService) {\n    var allViews,\n        currentView,\n        roleValue,\n        // viewTitle = routeParams.page,\n    // pa = routeParams.parameter;\n    viewTitle = $stateParams.page,\n        pa = $stateParams.parameter;\n    var _ROLEKEY = \"values\";\n    var watch = scope.$watch('baseConfig', function (newValue, oldValue, scope) {\n      if (scope.baseConfig) {\n        if (!scope.baseConfig.openSidebar) {\n          $(\".sidebar-toggle\").css(\"display\", \"none\");\n          $(\".main-sidebar\").css(\"display\", \"none\");\n          $(\".sidebar-mini.sidebar-collapse .content-wrapper\").css(\"cssText\", \"margin-left: 0px!important\");\n        }\n\n        watch();\n      }\n    });\n\n    function getRoleByID(roleID) {\n      var defer = q.defer();\n      userEnterpriseService.queryEnterpriseRole(function (returnObj) {\n        if (returnObj.code == 0) {\n          var role = returnObj.data.find(function (item) {\n            return item.roleID == roleID;\n          });\n          defer.resolve(role);\n        } else {\n          defer.reject(returnObj);\n        }\n      });\n      return defer.promise;\n    }\n\n    function parseJson(str) {\n      var objLike = new RegExp(\"^\\\\{.*\\\\}$\", \"g\");\n      var arrLike = new RegExp(\"^\\\\[.*\\\\]$\", \"g\");\n\n      if (objLike.test(str) || arrLike.test(str)) {\n        return JSON.parse(str);\n      } else {\n        return null;\n      }\n    }\n\n    scope.signClick = function () {\n      window.location.href = \"../app-freeboard/index.html#/service/view/scenter\" + (currentView ? '/' + currentView.viewId : '');\n    }; // PROMETHEUS-586 导航点击后，发送websocket的清空消息\n\n\n    scope.naviClick = function (link, param) {\n      $('#free-board').trigger('naviClick');\n      window.location.href = \"../app-sc/index_freeboard.html#/freeboard/\" + link + \"/\" + encodeURIComponent(JSON.stringify(param));\n    };\n\n    scope.bgColorFn = function (bgColor) {\n      return {\n        \"background-color\": bgColor ? bgColor : \"#eee\"\n      };\n    };\n\n    rootScope.setCurrentTab = function (str) {\n      scope.navigation[scope.navigation.length - 1].label = str;\n      var json = ['0'];\n\n      if (pa) {\n        var json = JSON.parse(pa);\n      }\n\n      if (_typeof(json[json.length - 1]) != \"object\") {\n        json[json.length - 1] = {};\n      }\n\n      json[json.length - 1].tabLabel = str;\n      $stateParams.parameter = JSON.stringify(json);\n    };\n\n    function getRoleID(callback) {\n      var user = userLoginUIService.user || {};\n\n      if (user.roleID) {\n        callback(user.currentRoleID + \"\");\n      } else {\n        userLoginUIService.getCurrentUser(function (user) {\n          callback(user.currentRoleID + \"\");\n        });\n      }\n    }\n\n    function getRoleID_success(roleID) {\n      console.assert(roleID, \"roleID is not Defined!!\");\n      var roles = roleID.split(\",\");\n      var defers = roles.map(function (e) {\n        return getRoleByID(e);\n      });\n      q.all(defers).then(function (role) {\n        var json = function () {\n          var rs = [];\n\n          for (var i in role) {\n            var r = parseJson(role[i][_ROLEKEY]);\n\n            if (r) {\n              Array.prototype.push.apply(rs, r);\n            }\n          }\n\n          return rs;\n        }();\n\n        if (json.length > 0) {\n          var view = {\n            viewId: 224265044620000\n          };\n          getViewByFunctionCode_back({\n            code: 0,\n            data: view\n          });\n        } else {\n          roleViewService.getViewByFunctionCode(\"M24\", getViewByFunctionCode_back);\n        }\n      });\n    }\n\n    getRoleID(getRoleID_success);\n\n    function toObject(content) {\n      var dt = JSON.parse(content);\n\n      if (typeof dt.setting == \"string\") {\n        dt.setting = JSON.parse(dt.setting);\n      }\n\n      scope.setting = dt.setting;\n      return dt;\n    }\n\n    function getViewById_back(event) {\n      if (event.code == 0 && event.data != null) {\n        var input;\n        var dt = toObject(event.data.content);\n\n        if (dt.hasOwnProperty(\"groups\")) {\n          var vt,\n              vt_arr = viewTitle.split(\"|\"),\n              va_arr,\n              vlabel;\n\n          if (pa) {\n            va_arr = JSON.parse(pa);\n          } else {\n            va_arr = [];\n          }\n\n          ;\n\n          if (va_arr.length > 0) {\n            vlabel = va_arr[va_arr.length - 1].tabLabel;\n          }\n\n          ;\n\n          if (vt_arr.length > 0) {\n            vt = vt_arr[vt_arr.length - 1];\n          } else {\n            vt = viewTitle;\n            vt_arr = [viewTitle];\n          }\n\n          ;\n          var base = '',\n              rs = [];\n\n          var loop = function loop(inx, elem) {\n            var find = dt[\"groups\"].find(function (element) {\n              return elem === element.path;\n            });\n\n            if (find) {\n              var param = va_arr[inx],\n                  tabLabel;\n              base = base == \"\" ? elem : base + \"|\" + elem;\n\n              if (_typeof(param) == \"object\" && param != null) {\n                tabLabel = param.tabLabel;\n              }\n\n              rs.push({\n                label: tabLabel ? tabLabel : find.label,\n                link: base,\n                param: va_arr.slice(0, parseInt(inx) + 1)\n              });\n            }\n\n            ;\n          };\n\n          for (var i in vt_arr) {\n            loop(i, vt_arr[i]);\n          }\n\n          ;\n          scope.navigation = rs;\n\n          if (vt == \"panel\") {\n            scope.navigation = scope.navigation.concat({\n              label: vlabel ? vlabel : \"设备仪表板\",\n              link: base + \"|panel\"\n            });\n\n            var getLastElement = function getLastElement(arr) {\n              return arr[arr.length - 1];\n            };\n\n            var parameter = getLastElement(JSON.parse($stateParams.parameter));\n            var modelId = parameter.modelId;\n            var resourceId = parameter.resourceId;\n            var allAvaliableViews, defaultViews, template;\n\n            var getManagedViewsByType_back = function getManagedViewsByType_back(event) {\n              if (event.code == 0) {\n                allAvaliableViews = event.data;\n\n                var getDefaultView_back = function getDefaultView_back(event) {\n                  if (event.code == 0) {\n                    var defaultViews = event.data;\n                    var templateDefault = defaultViews.find(function (elem) {\n                      if (elem.template) {\n                        if (elem.template.resourceId == modelId) {\n                          return true;\n                        } else {\n                          return false;\n                        }\n                      } else {\n                        return false;\n                      }\n                    });\n                    var templateExtent = allAvaliableViews.find(function (elem) {\n                      var viewId = elem.viewId;\n\n                      if (elem.template) {\n                        if (elem.template.resourceId == modelId) {\n                          var findRoleRes = function findRoleRes(elem) {\n                            return elem.resId == viewId && elem.resType == 21;\n                          };\n\n                          var authorized = userLoginUIService.user.roleResList.some(findRoleRes);\n                          return authorized;\n                        } else {\n                          return false;\n                        }\n                      } else {\n                        return false;\n                      }\n                    });\n\n                    if (templateExtent) {\n                      template = templateExtent;\n                    } else if (templateDefault) {\n                      template = templateDefault;\n                    }\n\n                    if (template) {\n                      var getViewById_back = function getViewById_back(event) {\n                        var model, resource, content;\n\n                        if (event.code == \"0\") {\n                          var content = event.data.content;\n\n                          var getModel_back = function getModel_back(event) {\n                            if (event.code == \"0\") {\n                              model = event.data[0];\n                            }\n\n                            var getResource_back = function getResource_back(event) {\n                              if (event.code == \"0\") {\n                                resource = event.data;\n\n                                if (content != null) {\n                                  var clone = JSON.parse(content);\n                                  var input = {\n                                    layout: clone.data ? clone.data : clone.layout,\n                                    setting: clone.setting\n                                  };\n                                  delete clone.data;\n                                  var editData = new freeboardservice.replaceCiKpi(input, function () {\n                                    timeout(function () {\n                                      scope.instance.setMode(true);\n                                      scope.instance.renderLayout(editData);\n                                    });\n                                  }, {\n                                    model: model,\n                                    resource: resource\n                                  }, null, dt);\n                                }\n                              }\n                            };\n\n                            if (resourceId) {\n                              resourceUIService.getResourceById(resourceId, getResource_back);\n                            } else {\n                              var getResources_back = function getResources_back(event) {\n                                if (event.code == 0) {\n                                  scope.resources = event.data;\n                                  /** console.log(scope.resources); */\n\n                                  scope.resource = scope.resources[0];\n\n                                  scope.itemchange = function (event) {\n                                    var id = event.id.split(\"number:\")[1];\n                                    var find = scope.resources.find(function (elem) {\n                                      return elem.id == id;\n                                    });\n\n                                    if (find) {\n                                      getResource_back({\n                                        code: 0,\n                                        data: find\n                                      });\n                                    }\n                                  };\n\n                                  getResource_back({\n                                    code: 0,\n                                    data: scope.resources[0]\n                                  });\n                                }\n\n                                ;\n                              };\n\n                              resourceUIService.getResources(getResources_back);\n                            }\n\n                            ;\n                          };\n\n                          resourceUIService.getModelByIds([modelId], getModel_back);\n                        }\n                      };\n\n                      viewFlexService.getViewById(template.viewId, getViewById_back);\n                    } else {\n                      scope.error = \"没有找到相应的设备仪表板视图，点击<a href='../app-oc/index.html#/views/dashboard' style='cursor:pointer; text-decoration: underline;'>Dashboard管理</a>创建设备仪表板\";\n                    }\n                  } else {\n                    scope.error = \"视图列表为空，请联系系统管理员\";\n                  }\n                };\n\n                viewFlexService.getDefaultView(modelId, getDefaultView_back);\n              } else {\n                scope.error = \"获取视图列表发生错误，请联系系统管理员\";\n              }\n            };\n\n            viewFlexService.getManagedViewsByTypeAndRole('dashboard', getManagedViewsByType_back);\n          } else {\n            var find = dt[\"groups\"].find(function (element) {\n              return vt == element.path;\n            });\n            scope.tabIndex = find ? dt['groups'].indexOf(find) : 0;\n            scope.tabs = dt.groups;\n            input = {\n              layout: dt.groups[scope.tabIndex].layout,\n              setting: dt.setting\n            };\n            var editData = new freeboardservice.replaceCiKpi(input, function () {\n              timeout(function () {\n                scope.instance.setMode(true);\n                scope.instance.renderLayout(editData);\n              });\n            }, null, dt);\n          }\n        } else if (dt.hasOwnProperty(\"data\")) {\n          scope.navigation = [{\n            label: \"服务中心\"\n          }];\n          input = {\n            layout: dt.data,\n            setting: dt.setting\n          };\n          var editData = new freeboardservice.replaceCiKpi(input, function () {\n            timeout(function () {\n              scope.instance.setMode(true);\n              scope.instance.renderLayout(editData);\n            });\n          }, null, dt);\n        } else if (dt.hasOwnProperty(\"layout\")) {\n          scope.navigation = [{\n            label: \"服务中心\"\n          }];\n          input = {\n            layout: dt.layout,\n            setting: dt.setting\n          };\n          var editData = new freeboardservice.replaceCiKpi(input, function () {\n            timeout(function () {\n              scope.instance.setMode(true);\n              scope.instance.renderLayout(editData);\n            });\n          }, null, dt);\n        }\n\n        ;\n      } else {\n        scope.error = \"获取此此用户角色的服务视图发生错误\" + (event.message ? \",\" + event.message : \"\");\n      }\n\n      ;\n    }\n\n    ;\n    /**\n    scope.$on(\"roleValueChanges\", function(e, roleID){\n      commonMethodService.clearEvents();\n      getRoleID_success(roleID + \"\");\n    })*/\n\n    scope.$on(\"CHANGEDASHBOARDVIEWS\", function (event, args) {\n      getViewByFunctionCode_back({\n        code: 0,\n        data: args.data\n      });\n    });\n  }]);\n});"],"sourceRoot":"/source/"}