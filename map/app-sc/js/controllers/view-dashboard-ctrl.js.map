{"version":3,"sources":["app-sc/js/controllers/view-dashboard-ctrl.js"],"names":["define","controllers","psUltility","initController","scope","rootSccope","$state","$stateParams","userEnterpriseService","rootScope","routeParams","resourceUIService","timeout","growl","q","window","location","viewFlexService","freeboardservice","userLoginUIService","roleViewService","commonMethodService","serviceProxy","commonMethodService2","cmd","undefined","instance","viewId","$root","path","index","user","getCurrentParents","then","parents","treeStr","map","d","label","join","catch","e","error","message","$emit","main_active_index","str","defer","url","showTree","callApi","service","method","param","get","code","resolve","data","reject","promise","getViewById_back","event","input","dt","content","JSON","parse","setting","bgColor","color","hasOwnProperty","find","element","tabIndex","indexOf","tabs","groups","layout","editData","replaceCiKpi","setMode","renderLayout","navigation","urlparser","href","test","some","address","item","port","stopInspection","success","reload","saveView","startInspection","psrequire","view","console","log","isNaN","getView","json","getViewById"],"mappings":"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","file":"app-sc/js/controllers/view-dashboard-ctrl.js","sourcesContent":["define(['controllers/controllers', '../../../../node_modules/ps-ultility/ps-ultility'], function (controllers, psUltility) {\n  'use strict';\n\n  controllers.initController('viewDashboardCtrl', ['$scope', '$rootScope', '$state', '$stateParams', 'userEnterpriseService', '$rootScope', '$routeParams', 'resourceUIService', '$timeout', 'growl', '$q', '$window', '$location', 'viewFlexService', 'freeboardservice', 'userLoginUIService', 'roleViewService', 'commonMethodService', 'serviceProxy', 'commonMethodService2', function (scope, rootSccope, $state, $stateParams, userEnterpriseService, rootScope, routeParams, resourceUIService, timeout, growl, q, window, location, viewFlexService, freeboardservice, userLoginUIService, roleViewService, commonMethodService, serviceProxy, commonMethodService2) {\n    var cmd = commonMethodService(undefined, scope);\n    scope.instance = {};\n    var viewId = scope.$root.viewId = $stateParams.viewId,\n        viewTitle = \"index\",\n        path = $stateParams.index; // 隐藏左边视图的多余部位\n\n    var user = userLoginUIService.user || {}; // console.log(user)\n\n    commonMethodService2.getCurrentParents().then(function (parents) {\n      rootSccope.treeStr = parents.map(function (d) {\n        return d.label;\n      }).join(\" > \");\n    }).catch(function (e) {\n      growl.error(e.message);\n    });\n    /**\n     *\n     * 判断是否要显示树\n     * 0 不显示 1 显示\n     */\n\n    scope.$emit(\"main_active_index\", $stateParams.main_active_index);\n    var showTree = $stateParams.showTree;\n\n    if (showTree == 0) {\n      scope.$root.showTree = false;\n    } else {\n      scope.$root.showTree = true;\n    }\n    /**\n     * 获取当前视图的viewId\n     * 根据viewId来查找当前的视图渲染页面\n     * 如果不是仪表板到视图id，可以跳转到对应的配置ID\n     */\n\n    /**  本地8080端口执行调用本地js视图文件 **/\n\n\n    function callApi(service, method, param) {\n      var defer = q.defer(),\n          callBack = function callBack(d) {\n        if (d.code == 0) {\n          defer.resolve(d.data || []);\n        } else {\n          defer.reject(d);\n        }\n      },\n          error = function error(e) {\n        defer.reject(e);\n      };\n\n      serviceProxy.get(service, method, param, callBack, error);\n      return defer.promise;\n    }\n\n    function startInspection(viewId) {\n      return callApi(\"inspectionService\", \"start\", viewId);\n    }\n\n    function stopInspection(viewId) {\n      return callApi(\"inspectionService\", \"end\", viewId);\n    }\n\n    function saveView(viewId) {\n      return callApi(\"inspectionService\", \"save\", viewId);\n    }\n\n    function getListeners(viewId) {\n      return callApi(\"inspectionService\", \"getlisteners\", viewId);\n    }\n\n    function checkLoadLocalView(viewId) {\n      var defer = q.defer(),\n          url = psUltility.urlparser(window.location.href);\n\n      function hasValue(str) {\n        return function (item) {\n          return item === str;\n        };\n      }\n\n      if (!/\\d+/.test(viewId + \"\")) {\n        defer.reject(\"not a number\");\n        return defer.promise;\n      }\n\n      if ([\"localhost\", \"127.0.0.1\"].some(hasValue(url.address)) && url.port == 8080) {\n        getListeners(viewId).then(function (d) {\n          if (d.indexOf(viewId) !== -1) {\n            rootScope.stopInspection = function () {\n              stopInspection(viewId).then(function (d) {\n                growl.success(\"结束本地监听视图 : \" + viewId);\n                window.location.reload();\n              }).catch(function (e) {\n                growl.error(\"移除监听故障 : \" + viewId);\n              });\n            };\n\n            rootScope.saveView = function () {\n              saveView(viewId).then(function (d) {\n                growl.success(\"成功保存视图 : \" + viewId);\n              }).catch(function (e) {\n                growl.error(\"不能保存视图 : \" + viewId);\n              });\n            };\n\n            delete rootScope.startInspection;\n          } else {\n            rootScope.startInspection = function () {\n              startInspection(viewId).then(function (d) {\n                growl.success(\"开始本地监听视图 : \" + viewId);\n                window.location.reload();\n              }).catch(function (e) {\n                growl.error(\"监听故障 : \" + viewId);\n              });\n            };\n\n            delete rootScope.stopInspection;\n            delete rootScope.saveView;\n          }\n\n          if (typeof viewId !== \"undefined\") {\n            psrequire([\"../app-views/build/\" + viewId + \".\" + path], function (view) {\n              var editData = new freeboardservice.replaceCiKpi(view, function () {\n                timeout(function () {\n                  scope.instance.setMode(true);\n                  scope.instance.renderLayout(editData);\n                });\n              }, null, null, scope);\n              defer.resolve(\"user local\");\n            }, function (e) {\n              console.log(\"没找到本地视图从服务器加载视图\");\n              defer.reject(\"user server\");\n            });\n          }\n        });\n      } else {\n        defer.reject(\"user server\");\n      }\n\n      return defer.promise;\n    }\n    /**  本地8080端口执行调用本地js视图文件 **/\n\n\n    function toObject(content) {\n      var dt = JSON.parse(content);\n\n      if (typeof dt.setting == \"string\") {\n        dt.setting = JSON.parse(dt.setting);\n      }\n\n      scope.setting = dt.setting;\n\n      if (dt.setting) {\n        scope.bgColor = dt.setting.color;\n      }\n\n      return dt;\n    }\n\n    function getViewById_back(event) {\n      if (event.code == 0 && event.data != null) {\n        var input;\n        var dt = toObject(event.data.content);\n\n        if (dt.hasOwnProperty(\"groups\")) {\n          var find = dt[\"groups\"].find(function (element) {\n            return $stateParams.index == element.path;\n          });\n          scope.tabIndex = find ? dt['groups'].indexOf(find) : 0;\n          scope.tabs = dt.groups;\n          input = {\n            layout: dt.groups[scope.tabIndex].layout,\n            setting: dt.setting\n          };\n          var editData = new freeboardservice.replaceCiKpi(input, function () {\n            timeout(function () {\n              scope.instance.setMode(true);\n              scope.instance.renderLayout(editData);\n            });\n          }, null, dt, scope);\n        } else if (dt.hasOwnProperty(\"layout\")) {\n          scope.navigation = [{\n            label: \"服务中心\"\n          }];\n          input = {\n            layout: dt.layout,\n            setting: dt.setting\n          };\n          var editData = new freeboardservice.replaceCiKpi(input, function () {\n            timeout(function () {\n              scope.instance.setMode(true);\n              scope.instance.renderLayout(editData);\n            });\n          }, null, dt, scope);\n        }\n\n        ;\n      } else {\n        scope.error = \"获取此此用户角色的服务视图发生错误\" + (event.message ? \",\" + event.message : \"\");\n      }\n\n      ;\n    }\n\n    ;\n    checkLoadLocalView(viewId).then(function (e) {\n      console.log(\"use local views\");\n    }).catch(function (d) {\n      if (!isNaN(viewId)) {\n        viewFlexService.getViewById(viewId, getViewById_back);\n      } else {\n        // 针对directive的名称解析对应的视图\n        cmd.getView({\n          path: \"viewCtrl:\" + viewId,\n          item: {}\n        }, function (json) {\n          var editData = new freeboardservice.replaceCiKpi(json, function () {\n            timeout(function () {\n              scope.instance.setMode(true);\n              scope.instance.renderLayout(editData);\n            });\n          }, null, null, scope);\n        });\n      }\n    });\n  }]);\n});"],"sourceRoot":"/source/"}