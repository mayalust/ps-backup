{"version":3,"sources":["app-editor/js/services/service.js"],"names":["define","service","optionDataHandler","lib","run","dm","rootScope","loc","route","kpi","$on","event","viewId","current","params","solutionId","groupId","modelId","pathName","path","split","getViewById","code","alert","setTimeout","window","open","locationChanges","echartVersion","factory","versionStr","setVersionString","string","getVersionString","user","setUserInfo","data","getUserInfo","kpiDataService","q","defer","getUnits","promise","getAllUnits","resolve","authService","echartVer","userInfo","$$host","$$port","login_callback","logout_callback","login","item","name","password","e","logout","back","newProf","openProf","loginChecking_login","getCurrentUser","loading","loginChecking_others","status","solutionUIService","resourceUIService","graphservice","rp","$timeout","units","smodelId","unitslist","deferred","modelAndResourceComplete","getviews","views","viewList","models","resources","ArrayHandler","i","traverse","each","model","id","findResource","findAll","viewType","push","undefined","rs","modelStructure","console","log","content","JSON","parse","elements","lack","find","indexOf","length","viewTitle","getModelByIds","getResourceByModelId","getKpisByModelId","kpis","root","getData","getviews_callback","getKpiValueList","category","nodeslist","kpislist","timespan","callback","Array","nodes","obj","kpiQueryModel","isRealTimeData","timePeriod","nodeIds","kpiCodes","param","getKpiHierarchyValueList","result","instance","k","l","nodeId","param2","param3","ins","value","j","cilabel","label","kpilabel","kpiId","unit","timeText","td","timeData","m","time","timestamp","timeEnd","Date","getTime","unitTime","parseInt","timeStart","Math","random","date","year","getFullYear","month","getMonth","day","getDate","hour","getHours","min","getMinutes","rearrangeTimeRecordList","recordList","nodeLabel","kpiname","labelComb","rearrangeCiRecordList","error","saveData","updateView","vid","sid","gid","mid","getModel_callback","defers","index","all","then","modelshandler","parentModelId","findmodel","children","defer_a","defer_b","getModels","getResources","getOptionData","dataType","formatStr","option","dType","op","type","getAllModels"],"mappings":"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","file":"app-editor/js/services/service.js","sourcesContent":["define([\"app\", \"optionDataHandler\", \"commonlib\"], function (service, optionDataHandler, lib) {\n  service.run([\"dataManagement\", \"$rootScope\", \"$location\", \"$route\", \"kpiDataService\", function (dm, rootScope, loc, route, kpi) {\n    rootScope.$on('$locationChangeSuccess', locationChangeSuccess);\n\n    function locationChangeSuccess(event) {\n      var viewId = route.current.params.viewId;\n      var solutionId = route.current.params.solutionId;\n      var groupId = route.current.params.groupId;\n      var modelId = route.current.params.modelId;\n      var pathName = loc.path().split(\"/\")[1];\n\n      if (viewId) {\n        kpi.getViewById(viewId, function (event) {\n          if (event.code == \"10022\") {\n            alert(\"您所登录的用户，无权访问该视图\");\n            setTimeout(function () {\n              window.open(\"../../app-oc/index.html#/designView/detail\", \"_self\");\n            }, 1000);\n          } else {\n            dm.locationChanges(viewId);\n          }\n        });\n      } else {\n        dm.locationChanges(viewId, solutionId, groupId, modelId);\n      }\n\n      echartVersion = pathName == \"echart\";\n    }\n  }]);\n  service.factory(\"echartVer\", function () {\n    var factory = {};\n    var versionStr = '';\n    factory.setVersionString = setVersionString;\n    factory.getVersionString = getVersionString;\n\n    function setVersionString(string) {\n      versionStr = string;\n    }\n\n    function getVersionString() {\n      return versionStr;\n    }\n\n    return factory;\n  });\n  service.factory(\"userInfo\", function () {\n    var factory = {};\n    var user = '';\n    factory.setUserInfo = setUserInfo;\n    factory.getUserInfo = getUserInfo;\n\n    function setUserInfo(data) {\n      user = data;\n    }\n\n    function getUserInfo() {\n      return user;\n    }\n\n    return factory;\n  });\n  service.factory(\"units\", [\"kpiDataService\", \"$q\", function (kpiDataService, q) {\n    var factory = {};\n    var defer = new q.defer();\n    factory.getUnits = getUnits;\n\n    function getUnits() {\n      return defer.promise;\n    }\n\n    kpiDataService.getAllUnits(function (event) {\n      defer.resolve(event);\n    });\n    return factory;\n  }]);\n  service.factory(\"loginManagement\", [\"$rootScope\", \"authService\", \"$q\", \"$location\", \"$window\", \"echartVer\", \"$route\", \"userInfo\", function (rootScope, authService, q, loc, window, echartVer, route, userInfo) {\n    var factory = {};\n    var _HOST_ = loc.$$host;\n    var _PORT_ = loc.$$port;\n    var pathName = loc.path().split(\"/\")[1];\n    factory.login = login;\n    factory.logout = logout;\n    factory.back = back;\n    factory.newProf = newProf;\n    factory.openProf = openProf;\n    factory.loginChecking_login = loginChecking_login;\n    factory.loginChecking_others = loginChecking_others;\n\n    function login(item) {\n      var name = item.name;\n      var password = item.password;\n      authService.login(name, password, login_callback, onError);\n\n      function onError(e) {}\n    }\n\n    function logout() {\n      authService.logout(logout_callback);\n    }\n\n    function loginChecking_login() {\n      var defer = q.defer();\n      authService.getCurrentUser(checkLoginStatus, onError);\n\n      function onError(e) {}\n\n      function checkLoginStatus(data) {\n        if (data.code == \"0\") {\n          if (data.data) {\n            userInfo.setUserInfo(data.data);\n            loc.path(\"echart\");\n          } else {\n            window.open(\"../../login.html\", \"_self\");\n          }\n        } else if (data.code == \"10022\") {\n          alert(\"您所登录的用户，无权访问该视图\");\n          setTimeout(function () {\n            window.open(\"../../app-oc/index.html#/designView/detail\", \"_self\");\n          }, 1000);\n        }\n      }\n\n      rootScope.loading = \"没有登录\";\n      return defer.promise;\n    }\n\n    function loginChecking_others() {\n      var defer = q.defer();\n      echartVer.setVersionString(pathName == \"echart\" ? \"echart_v3\" : \"echart_v3\");\n      authService.getCurrentUser(checkLoginStatus);\n\n      function checkLoginStatus(data) {\n        if (data.data) {\n          userInfo.setUserInfo(data.data);\n          defer.resolve({\n            status: \"logined\",\n            data: data.data\n          });\n        } else {\n          window.open(\"../../login.html\", \"_self\");\n        }\n      }\n\n      rootScope.loading = \"载入设计器\";\n      return defer.promise;\n    }\n\n    function login_callback(data) {\n      if (data.data) {\n        loc.path(\"/echart\");\n      }\n    }\n\n    function newProf() {\n      if (loc.path() == \"/echart\") {\n        window.open(\"index.html#/new/echart\", \"_self\");\n      } else {\n        window.open(\"index.html#/echart\", \"_self\");\n      }\n    }\n\n    function openProf(viewId) {\n      window.open(\"index.html#/echart/\" + viewId, \"_self\");\n    }\n\n    function back() {\n      window.open(\"../app-oc/index.html#/designView2\", \"_self\");\n    }\n\n    function logout_callback(data) {\n      window.open(\"../../login.html\", \"_self\");\n    }\n\n    return factory;\n  }]);\n  service.factory(\"dataManagement\", [\"$rootScope\", 'solutionUIService', 'resourceUIService', \"authService\", \"graphservice\", \"kpiDataService\", \"$routeParams\", \"$q\", \"$location\", \"echartVer\", \"$timeout\", \"units\", function (rootScope, solutionUIService, resourceUIService, authService, graphservice, kpi, rp, q, loc, echartVer, $timeout, units) {\n    var factory = {},\n        solutionId,\n        groupId,\n        smodelId;\n    var viewId;\n    var unitslist;\n    var pathName = loc.path().split(\"/\")[1];\n    var deferred = q.defer();\n    echartVer.setVersionString(pathName == \"echart\" ? \"echart_v3\" : \"echart_v3\");\n    factory.saveData = saveData;\n    factory.updateView = updateView;\n    factory.getKpiValueList = getKpiValueList;\n    factory.locationChanges = locationChanges;\n    factory.getOptionData = getOptionData;\n    factory.getAllModels = getAllModels;\n    units.getUnits().then(function success(event) {\n      unitslist = event.data;\n    }, function error() {});\n\n    function getAllModels() {\n      return deferred.promise;\n    }\n\n    function getOptionData(dataType, category, formatStr, option, nodeslist, kpislist, timespan, callback) {\n      var cat = category == \"time\" ? \"time\" : \"ci\";\n      var dType = dataType;\n      var op = option;\n      getKpiValueList(category, nodeslist, kpislist, timespan, getKpiValueList_callback);\n\n      function getKpiValueList_callback(event) {\n        if (event.status == 'success') {\n          var result = optionDataHandler(dType.type, dType.category[category], formatStr, event, op, unitslist);\n        } else {\n          var result = \"获取数据错误\";\n        }\n\n        callback(result, event.data);\n      }\n    }\n\n    function locationChanges(vid, sid, gid, mid) {\n      $timeout(function () {\n        solutionId = sid;\n        groupId = gid;\n        viewId = vid;\n        smodelId = mid;\n        defer_a = q.defer();\n        defer_b = q.defer();\n\n        if (mid != 0 && mid != undefined) {\n          resourceUIService.getModelByIds([mid], getModel_callback);\n        } else if (gid != 0 && gid != undefined) {\n          resourceUIService.getModelByIds([gid], getModel_callback);\n        } else {\n          graphservice.getModels(getModel_callback);\n        }\n\n        graphservice.getResources(getResources_callback);\n        q.all([defer_a.promise, defer_b.promise]).then(modelAndResourceComplete, error);\n\n        function getModel_callback(event) {\n          var models = new lib.ArrayHandler(event.data);\n          var defers = [];\n          var promise = [];\n          var i;\n\n          for (i in models.data) {\n            defers[i] = q.defer();\n\n            (function (modelId, index) {\n              graphservice.getKpisByModelId(modelId, function (data) {\n                models.data[index].kpis = new lib.ArrayHandler(data.data);\n                defers[index].resolve(data);\n              });\n            })(models.data[i].id, i);\n          }\n\n          ;\n\n          for (var k in defers) {\n            promise.push(defers[k].promise);\n          }\n\n          q.all(promise).then(function success(data) {\n            var root = new lib.ArrayHandler([]);\n            var modelshandler = new lib.ArrayHandler(models.data);\n            modelshandler.each(function (model) {\n              var parentModelId = model.parentModelId;\n\n              if (parentModelId) {\n                var findmodel = modelshandler.find(\"id\", parentModelId);\n\n                if (findmodel) {\n                  if (findmodel.children) {\n                    findmodel.children.push(model);\n                  } else {\n                    findmodel.children = new lib.ArrayHandler([model]);\n                  }\n                } else {\n                  root.push(model);\n                }\n              } else {\n                root.push(model);\n              }\n            });\n            defer_a.resolve({\n              root: root,\n              traverse: models\n            });\n            /* before 2016.3.15\n            defer_a.resolve(models);\n            */\n          }, function error(data) {});\n        }\n\n        function getResources_callback(data) {\n          console.log(\"get all resources\", data);\n          defer_b.resolve(data);\n        }\n      });\n    }\n\n    ;\n\n    function modelAndResourceComplete(data) {\n      kpi.getviews(function (event) {\n        var views = event.data;\n        getviews_callback(data, views);\n      });\n    }\n\n    function getviews_callback(data, views) {\n      var viewList = [];\n      var models = data[0];\n      /* before 2016.3.15\n      var models = data[0].data;\n      */\n\n      var resources = new lib.ArrayHandler(data[1].data);\n      models.traverse.each(function (model) {\n        modelId = model.id;\n        var findResource = resources.findAll(\"modelId\", modelId);\n\n        if (findResource) {\n          model.resources = new lib.ArrayHandler(findResource);\n        }\n      });\n      /* before 2016.3.15\n      var models = (function(md, resources){\n      \tfor(var i in md)\n      \t{\n      \t\tvar mid = md[i].id;\n      \t\tvar find = (function(mid){\n      \t\t\tvar rs = [];\n      \t\t\tfor(var j in resources){\n      \t\t\t\tif(resources[j].modelId == mid)\n      \t\t\t\t{\n      \t\t\t\t\trs.push({\n      \t\t\t\t\t\tcreateTime : resources[j].createTime,\n      \t\t\t\t\t\tid : resources[j].id,\n      \t\t\t\t\t\tlabel : resources[j].label,\n      \t\t\t\t\t});\n      \t\t\t\t}\n      \t\t\t}\n      \t\t\treturn rs;\n      \t\t})(mid);\n      \t\tif(find.length)\n      \t\t{\n      \t\t\tmd[i].resources = find;\n      \t\t}\n      \t}\n      \treturn md;\n      })(data[0].data, data[1].data);\n      var rs = models ? models : {};\n      */\n\n      for (var i in views) {\n        if (views[i]) {\n          if (views[i].viewType == \"designView\") {\n            viewList.push(views[i]);\n          }\n        }\n      }\n\n      if (viewId == undefined) {\n        /* before 2016.3.15\n        var rs = {\n        \tviews : viewList,\n        \tmodelStructure : JSON.parse(JSON.stringify(rs))\n        };\n        */\n        var rs = {\n          solutionId: solutionId,\n          groupId: groupId,\n          smodelId: smodelId,\n          views: viewList,\n          modelStructure: models\n        };\n        console.log(\"modelAndResourceComplete\", rs);\n        /* before 2016.3.15\n        rootScope.$broadcast(\"modelAndResourceComplete\", rs);\n         */\n\n        deferred.resolve(rs);\n      } else {\n        /* before 2016.3.15\n        getViewGraph(viewId, JSON.parse(JSON.stringify(rs)), viewList);\n         */\n        getViewGraph(viewId, models, viewList);\n      }\n    }\n\n    function getViewGraph(viewId, models, views) {\n      kpi.getViewById(viewId, getViewById_callback);\n\n      function getViewById_callback(data) {\n        var content = JSON.parse(data.data.content).elements;\n        var lack = [];\n\n        for (var i in content) {\n          var find = models.traverse.find(\"id\", content[i].modelId);\n\n          if (!find) {\n            if (content[i].modelId) {\n              if (lack.indexOf(content[i].modelId) == -1) {\n                lack.push(content[i].modelId);\n              }\n            }\n          }\n        }\n\n        console.log(lack);\n\n        if (lack.length == 0) {\n          deferred.resolve({\n            viewId: viewId,\n            views: views,\n            viewTitle: data.data.viewTitle,\n            modelStructure: models,\n            viewList: content\n          });\n        } else {\n          resourceUIService.getModelByIds(lack, function (event) {\n            if (event.code) {\n              console.log(event.data);\n              var model = event.data[0];\n              resourceUIService.getResourceByModelId(model.id, function (event) {\n                model.resources = new lib.ArrayHandler(event.data);\n                resourceUIService.getKpisByModelId(model.id, function (event) {\n                  model.kpis = new lib.ArrayHandler(event.data);\n                  models.root.push(model);\n                  console.log(models.root.getData());\n                  deferred.resolve({\n                    viewId: viewId,\n                    views: views,\n                    viewTitle: data.data.viewTitle,\n                    modelStructure: models,\n                    viewList: content\n                  });\n                });\n              });\n            }\n          });\n        }\n        /* before 2016.3.15\n        rootScope.$broadcast(\"modelAndResourceComplete\", {\n        \tviewId : viewId,\n        \tviews : views,\n        \tviewTitle : data.data.viewTitle,\n        \tmodelStructure : models,\n        \tviewList : content\n        });\n         */\n\n      }\n    }\n\n    function getKpiValueList(category, nodeslist, kpislist, timespan, callback) {\n      if (nodeslist instanceof Array) {}\n\n      var nodes = function (obj) {\n        var rs = [];\n\n        for (var i in obj) {\n          rs.push(obj[i].id);\n        }\n\n        return rs;\n      }(nodeslist);\n\n      var kpis = function (obj) {\n        var rs = [];\n\n        for (var i in obj) {\n          rs.push(obj[i].id);\n        }\n\n        return rs;\n      }(kpislist);\n\n      if (category == 'time') {\n        var kpiQueryModel = {\n          category: category,\n          isRealTimeData: true,\n          timePeriod: timespan,\n          nodeIds: nodes,\n          kpiCodes: kpis\n        };\n      } else if (category == 'ci') {\n        var kpiQueryModel = {\n          category: category,\n          isRealTimeData: true,\n          nodeIds: nodes,\n          kpiCodes: kpis\n        };\n      }\n\n      var param = [\"kpi\", kpiQueryModel];\n      kpi.getKpiHierarchyValueList(param, getKpiHierarchyValueList_callback);\n\n      function getKpiHierarchyValueList_callback(event) {\n        if (event.code == \"0\") {\n          var result;\n\n          if (category == \"time\") {\n            result = rearrangeTimeRecordList(event.data.recordList);\n          } else if (category == \"ci\") {\n            result = rearrangeCiRecordList(event.data.recordList);\n          }\n\n          callback({\n            status: 'success',\n            kpis: kpis,\n            nodes: nodes,\n            category: category,\n            data: result\n          });\n        } else {\n          callback({\n            status: 'failure'\n          });\n        }\n      }\n\n      ;\n\n      function rearrangeCiRecordList(obj) {\n        var result = [];\n\n        for (var i in nodeslist) {\n          for (var j in kpislist) {\n            result.push({\n              cilabel: nodeslist[i].label,\n              kpilabel: kpislist[j].label,\n              nodeLabel: nodeslist[i].label,\n              label: nodeslist[i].label + \"-\" + kpislist[j].label,\n              name: kpislist[j].name,\n              nodeId: nodeslist[i].nodeId,\n              kpiId: kpislist[j].kpiId,\n              unit: kpislist[j].units\n            });\n          }\n        }\n\n        for (var i in obj) {\n          var item = obj[i];\n          var name = item.category;\n\n          for (var l in item) {\n            if (l != \"category\") {\n              var kpiname = l;\n              var value = item[l];\n\n              for (var m in result) {\n                var labelComb = result[m].nodeLabel;\n\n                if (labelComb == name && kpiname == result[m].name) {\n                  result[m].value = value;\n                }\n              }\n            }\n          }\n        }\n\n        return result;\n      }\n\n      ;\n\n      function rearrangeTimeRecordList(obj) {\n        var result = [];\n        var instance = {};\n\n        if (obj.length > 0) {\n          for (var k in obj) {\n            var item = obj[k];\n\n            for (var l in item) {\n              if (l != \"category\") {\n                var nodeId = l.split(\"-\")[0];\n                var param2 = l.split(\"-\")[1];\n                var param3 = l.split(\"-\")[2];\n\n                if (param3) {\n                  var name = param3;\n                  var ins = param2;\n\n                  if (!instance[nodeId]) {\n                    instance[nodeId] = [];\n                  }\n\n                  var find = function (data, value) {\n                    for (var i in data) {\n                      if (value == data[i]) {\n                        return true;\n                      }\n                    }\n\n                    return false;\n                  }(instance[nodeId], ins);\n\n                  if (!find) {\n                    instance[nodeId].push(ins);\n                  }\n                }\n              }\n            }\n          }\n        }\n\n        if (nodeslist) {\n          for (var i in nodeslist) {\n            for (var j in kpislist) {\n              if (instance[nodeslist[i].id]) {\n                console.log(instance[nodeslist[i].id]);\n\n                for (var k in instance[nodeslist[i].id]) {\n                  result.push({\n                    cilabel: nodeslist[i].label,\n                    kpilabel: kpislist[j].label,\n                    label: nodeslist[i].label + \"-\" + instance[nodeslist[i].nodeId][k] + \"-\" + kpislist[j].label,\n                    name: kpislist[j].name,\n                    nodeId: nodeslist[i].id,\n                    instance: instance[nodeslist[i].id][k],\n                    kpiId: kpislist[j].id,\n                    unit: kpislist[j].unit,\n                    data: []\n                  });\n                }\n              } else {\n                result.push({\n                  cilabel: nodeslist[i].label,\n                  kpilabel: kpislist[j].label,\n                  label: nodeslist[i].label + \"-\" + kpislist[j].label,\n                  name: kpislist[j].name,\n                  nodeId: nodeslist[i].id,\n                  kpiId: kpislist[j].id,\n                  unit: kpislist[j].unit,\n                  data: []\n                });\n              }\n            }\n          }\n        } else {\n          for (var i in kpislist) {\n            result.push({\n              cilabel: '模拟数据',\n              kpilabel: kpislist[i].label,\n              label: kpislist[i].label + \"(模拟数据)\",\n              name: kpislist[i].name,\n              nodeId: 0,\n              kpiId: kpislist[i].id,\n              unit: kpislist[i].unit,\n              data: []\n            });\n          }\n        }\n\n        if (nodeslist) {\n          for (var k in obj) {\n            var item = obj[k];\n            var timeText = item.category;\n            var td = timeData(timeText);\n\n            for (var l in item) {\n              if (l != \"category\") {\n                var nodeId = l.split(\"-\")[0];\n                var param2 = l.split(\"-\")[1];\n                var param3 = l.split(\"-\")[2];\n                var ins;\n                var name;\n\n                if (param3) {\n                  name = param3;\n                  ins = param2;\n                } else {\n                  name = param2;\n                }\n\n                var value = item[l];\n\n                for (var m in result) {\n                  if (result[m].nodeId == nodeId && result[m].name == name && result[m].instance == ins) {\n                    result[m].data.push({\n                      value: value,\n                      time: td.time,\n                      timestamp: td.timestamp\n                    });\n                  }\n                }\n              }\n            }\n          }\n        } else {\n          var timeEnd = new Date().getTime();\n          var unitTime = parseInt(timespan / 10);\n          var timeStart = timeEnd - timespan;\n          var k = [];\n\n          if (unitTime != 0) {\n            for (var i = timeStart; i <= timeEnd; i += unitTime) {\n              if (result[0]) {\n                result[0].data.push({\n                  value: parseInt(Math.random() * 100),\n                  time: timeData(i).time,\n                  timestamp: i\n                });\n              }\n            }\n          }\n        }\n\n        function timeData(label) {\n          var date = new Date(label);\n          var time;\n          var year = date.getFullYear();\n          var month = date.getMonth() + 1;\n          var day = date.getDate();\n          var hour = date.getHours();\n          var min = date.getMinutes();\n          time = year + \"/\" + month + \"/\" + day + \" \" + hour + \":\" + min;\n          timestamp = Date.parse(new Date(time));\n          return {\n            time: time,\n            timestamp: date.getTime()\n          };\n        }\n\n        return result;\n      }\n    }\n\n    function saveData(data, callback) {\n      kpi.saveData(data, callback);\n    }\n\n    function updateView(viewId, data, callback) {\n      kpi.updateView(viewId, data, callback);\n    }\n\n    function error(data) {}\n\n    return factory;\n  }]);\n});"],"sourceRoot":"/source/"}