{"version":3,"sources":["js/services/kpidata-flex-service.js"],"names":["define","services","factory","serviceProxy","service","base","includeFields","toString","getRealTimeKpiData","nodeIds","kpiCodes","callBack","includeInstance","extendstr","p","isRealTimeData","timePeriod","get","queryDeviceData","kpiQueryModel","getRealTimeKpiDataWithKpiInfo","category","startTime","endTime","timeRange","statisticType","condList","getKpiHierarchyValueList","exportKpiValueList","kpiQueryObj","getValueList","param","returnObj","getKpiValList","$extension","getKpiValueList","handlerObj","code","data","recordList","source","nodesDic","kpisDic","kpisNDic","insDic","mergeKpiValue","kpiObj","config","datavalue","length","arisingMS","newDateJson","arisingTime","getTime","milliseconds","time","minTimespan","instance","nodeId","kpiCode","value","obj","push","i","label","name","getChartProperty","item","key","properties","pt","getKpisInfo","kpiName2Code","displayKpi","dataSource","displayKpiSet","jQuery","isArray","subDisplayKpi","Number","getNodesInfo","filters","filter","filterObj","type","tmpNodeIds","split","j","mergeKpiHandler"],"mappings":"AAAAA,OAAO,CAAC,2BAA4B,SAAUC,GAC5C,aAEAA,EAASC,QAAQ,iBAAkB,CAAC,eAAgB,SAAUC,GAC5D,IAAIC,EAAU,GACVC,EAAO,qBAEPC,EAAgB,iBADN,CAAC,cAAe,kBAAmB,WAAY,UAAW,UAAW,SAAU,SAC9CC,WAwR/C,OA/QAH,EAAQI,mBAAqB,SAAUC,EAASC,EAAUC,EAAUC,EAAiBC,GAC9EA,IACHA,EAAYP,GAGd,IAOIQ,EAAI,CAAC,MAPW,CAClBC,gBAAgB,EAChBC,WAAY,EACZP,QAASA,EACTC,SAAUA,EACVE,gBAAiBA,IAGnBT,EAAac,IAAIZ,EAAM,kBAAmBS,EAAGH,EAAU,KAAME,IAG/DT,EAAQc,gBAAkB,SAAUC,EAAeR,EAAUE,GACtDA,IACHA,EAAYP,GAGd,IAAIQ,EAAI,CAAC,MAAOK,GAChBhB,EAAac,IAAIZ,EAAM,kBAAmBS,EAAGH,EAAU,KAAME,IAG/DT,EAAQgB,8BAAgC,SAAUX,EAASC,EAAUC,GACnE,IAYIG,EAAI,CAAC,MAZW,CAClBO,SAAU,KACVN,gBAAgB,EAChBC,WAAY,EACZP,QAASA,EACTC,SAAUA,EACVY,UAAW,KACXC,QAAS,KACTC,UAAW,GACXC,cAAe,QACfC,SAAU,KAGZvB,EAAac,IAAIZ,EAAM,2BAA4BS,EAAGH,IAGxDP,EAAQuB,yBAA2B,SAAUb,EAAGH,GAC9CR,EAAac,IAAIZ,EAAM,2BAA4BS,EAAGH,IAGxDP,EAAQwB,mBAAqB,SAAUC,EAAalB,GAClDR,EAAac,IAAIZ,EAAM,qBAAsBwB,EAAalB,IAG5DP,EAAQ0B,aAAe,SAAUC,EAAOpB,EAAUE,GAC3CA,IACHA,EAAYP,GAGdH,EAAac,IAAIZ,EAAM,kBAAmB0B,EAAO,SAAUC,GACzDrB,EAASqB,IACR,KAAMnB,IAGXT,EAAQ6B,cAAgB,SAAUF,EAAOpB,EAAUE,GAC5CA,IACHA,EAAYP,GAGd,IAAIa,EAAgB,CAClBE,SAAU,OACVN,gBAAgB,EAChBC,WAAY,EACZP,QAAS,GACTC,SAAU,GACVY,UAAW,KACXC,QAAS,KACTC,UAAW,GACXC,cAAe,QACfC,SAAU,IACVQ,WAAWH,GACb5B,EAAac,IAAIZ,EAAM,kBAAmB,CAAC,MAAOc,GAAgB,SAAUa,GAC1ErB,EAASqB,IACR,KAAMnB,IAGXT,EAAQ+B,gBAAkB,SAAUrB,EAAGH,EAAUE,GAC1CA,IACHA,EAAYP,GAGd,IAAI8B,EAAa,CACfC,KAAM,EACNC,KAAM,CACJC,WAAY,IAEdC,OAAQ,KACRC,SAAU,GACVC,QAAS,GACTC,SAAU,GACVC,OAAQ,IAGNC,EAAgB,SAAuBC,EAAQC,GACjD,IAAIC,EAAYZ,EAAWE,KAAKC,WAAWH,EAAWE,KAAKC,WAAWU,OAAS,GAC3EC,EAAYC,YAAYL,EAAOM,aAAaC,UAQhD,GAN8B,GAA1BL,EAAUM,eACZN,EAAUM,aAAeJ,EACzBF,EAAUI,YAAcN,EAAOM,YAC/BJ,EAAUO,KAAOT,EAAOM,aAGtBF,EAAYF,EAAUM,aAAeP,EAAOL,QAAQc,YAClDV,EAAOW,UACTrB,EAAWQ,OAAOE,EAAOW,UAAYX,EAAOW,SAC5CT,EAAUF,EAAOY,OAAS,IAAMZ,EAAOa,QAAU,IAAMb,EAAOW,UAAYX,EAAOc,OAEjFZ,EAAUF,EAAOY,OAAS,IAAMZ,EAAOa,SAAWb,EAAOc,UAEtD,CACL,IAAIC,EAAM,CACRP,aAAcJ,EACdE,YAAaN,EAAOM,YACpBG,KAAMT,EAAOM,aAGXN,EAAOW,UACTrB,EAAWQ,OAAOE,EAAOW,UAAYX,EAAOW,SAC5CI,EAAIf,EAAOY,OAAS,IAAMZ,EAAOa,QAAU,IAAMb,EAAOW,UAAYX,EAAOc,OAE3EC,EAAIf,EAAOY,OAAS,IAAMZ,EAAOa,SAAWb,EAAOc,MAGrDxB,EAAWE,KAAKC,WAAWuB,KAAKD,KAIpC1D,EAAac,IAAIZ,EAAM,kBAAmBS,EAAG,SAAUkB,GACrD,GAAsB,GAAlBA,EAAUK,KAAW,CACvBD,EAAWI,OAASR,EAAUM,KAC9B,IAAIS,EAASjC,EAAE,GAEf,GAA4B,EAAxBkB,EAAUM,KAAKW,QACO,EAApBF,EAAO/B,WACOmC,YAAYnB,EAAUM,KAAK,GAAGc,aAAaC,UAC7CF,YAAYnB,EAAUM,KAAKN,EAAUM,KAAKW,OAAS,GAAGG,aAAaC,UAClEN,EAAOL,QAAQc,YAKlC,IAAK,IAAIO,KAAK/B,EAAUM,KAAM,CAC5B,IAAIQ,EAASd,EAAUM,KAAKyB,GAW5B,GAVA3B,EAAWK,SAASK,EAAOY,QAAUX,EAAON,SAASK,EAAOY,QAAQM,MACpE5B,EAAWM,QAAQI,EAAOa,SAAWZ,EAAOL,QAAQI,EAAOa,SAASK,MACpE5B,EAAWO,SAASI,EAAOL,QAAQI,EAAOa,SAASM,MAAQnB,EAAOa,QAEzB,GAArCvB,EAAWE,KAAKC,WAAWU,QAC7Bb,EAAWE,KAAKC,WAAWuB,KAAK,CAC9BR,aAAc,IAIO,GAArBP,EAAO/B,WAAiB,CAC1B,IAAIgC,EAAYZ,EAAWE,KAAKC,WAAW,GAU3CS,EAAUF,EAAOY,OAAS,IAAMZ,EAAOa,SAAWb,EAAOc,MACzDZ,EAAUI,YAAcN,EAAOM,YAC/BJ,EAAUO,KAAOT,EAAOM,iBAExBP,EAAcC,EAAQC,IAW5BpC,EAASyB,IACR,KAAMvB,IAGXT,EAAQ8D,iBAAmB,SAAUC,EAAMC,GACzC,IAAK,IAAIL,KAAKI,EAAKE,WAAWF,KAAM,CAClC,IAAIG,EAAKH,EAAKE,WAAWF,KAAKJ,GAE9B,GAAIO,EAAGL,MAAQG,EACb,OAAOE,IAKblE,EAAQmE,YAAc,SAAUJ,GAC9B,IAAIzD,EAAW,GACX8D,EAAe,GACfC,EAAaN,EAAKO,WAAWC,cAAcF,WAE/C,GAAIG,OAAOC,QAAQJ,GACjB,IAAK,IAAIV,KAAKU,EAAY,CACxB,IAAIK,EAAgBL,EAAWV,GAC/BrD,EAASoD,KAAKiB,OAAOD,EAAczC,OACnCmC,EAAaM,EAAczC,MAAQyC,EAAcb,UAGnDvD,EAASoD,KAAKiB,OAAON,EAAWpC,OAChCmC,EAAaC,EAAWpC,MAAQoC,EAAWR,KAG7C,MAAO,CAACvD,EAAU8D,IAGpBpE,EAAQ4E,aAAe,SAAUb,GAC/B,IAAInD,EACAP,EAAU,GAEd,IAAK,IAAIsD,KAAKI,EAAKO,WAAWO,QAAQC,OAAQ,CAC5C,IAAIC,EAAYhB,EAAKO,WAAWO,QAAQC,OAAOnB,GAE/C,GAAsB,MAAlBoB,EAAUC,KAAc,CAC1B,IAAIC,EAAaF,EAAU1E,QAAQ6E,MAAM,KAEzC,IAAK,IAAIC,KAAKF,EACZ5E,EAAQqD,KAAKiB,OAAOM,EAAWE,SAEN,QAAlBJ,EAAUC,OACnBpE,EAA4C,GAA/B+D,OAAOI,EAAUnE,YAAmB,KAIrD,MAAO,CAACP,EAASO,IAGnBZ,EAAQoF,gBAAkB,SAAU1C,EAAQC,EAAQX,GAClD,IAAIY,EAAYZ,EAAWE,KAAKC,WAAWH,EAAWE,KAAKC,WAAWU,OAAS,GAC3EC,EAAYC,YAAYL,EAAOM,aAAaC,UAEhD,GAAIH,EAAYF,EAAUM,aAAeP,EAAOL,QAAQc,YAClDV,EAAOW,UACTrB,EAAWQ,OAAOE,EAAOW,UAAYX,EAAOW,SAC5CT,EAAUF,EAAOY,OAAS,IAAMZ,EAAOa,QAAU,IAAMb,EAAOW,UAAYX,EAAOc,OAEjFZ,EAAUF,EAAOY,OAAS,IAAMZ,EAAOa,SAAWb,EAAOc,UAEtD,CACL,IAAIC,EAAM,CACRP,aAAcJ,EACdE,YAAaN,EAAOM,YACpBG,KAAMT,EAAOM,aAGXN,EAAOW,UACTrB,EAAWQ,OAAOE,EAAOW,UAAYX,EAAOW,SAC5CI,EAAIf,EAAOY,OAAS,IAAMZ,EAAOa,QAAU,IAAMb,EAAOW,UAAYX,EAAOc,OAE3EC,EAAIf,EAAOY,OAAS,IAAMZ,EAAOa,SAAWb,EAAOc,MAGrDxB,EAAWE,KAAKC,WAAWuB,KAAKD,GAGlC,OAAOzB,GAGFhC","file":"js/services/kpidata-flex-service.js","sourcesContent":["define(['../services/services.js'], function (services) {\n  'use strict';\n\n  services.factory('kpiDataService', ['serviceProxy', function (serviceProxy) {\n    var service = {};\n    var base = \"kpiDataFlexService\";\n    var include = [\"arisingTime\", \"granularityUnit\", \"instance\", \"kpiCode\", \"modelId\", \"nodeId\", \"value\"];\n    var includeFields = \"includeFields=\" + include.toString();\n    /**\n     * 获得当前KPI数据，适用于一个数据展示的组件，如饼图、仪表盘、节点告警状态等。\n     * @param {Array} nodeIds 设备IDs\n     * @param {Array} kpiCodes KPIIDs\n     * @param {Function} callBack 回调方法\n     * @param {Boolean} includeInstance 是否能够查询实例，999999状态专用\n     */\n\n    service.getRealTimeKpiData = function (nodeIds, kpiCodes, callBack, includeInstance, extendstr) {\n      if (!extendstr) {\n        extendstr = includeFields;\n      }\n\n      var kpiQueryModel = {\n        isRealTimeData: true,\n        timePeriod: 0,\n        nodeIds: nodeIds,\n        kpiCodes: kpiCodes,\n        includeInstance: includeInstance\n      };\n      var p = [\"kpi\", kpiQueryModel];\n      serviceProxy.get(base, \"getKpiValueList\", p, callBack, null, extendstr);\n    };\n\n    service.queryDeviceData = function (kpiQueryModel, callBack, extendstr) {\n      if (!extendstr) {\n        extendstr = includeFields;\n      }\n\n      var p = [\"kpi\", kpiQueryModel];\n      serviceProxy.get(base, \"getKpiValueList\", p, callBack, null, extendstr);\n    };\n\n    service.getRealTimeKpiDataWithKpiInfo = function (nodeIds, kpiCodes, callBack) {\n      var kpiQueryModel = {\n        category: \"ci\",\n        isRealTimeData: true,\n        timePeriod: 0,\n        nodeIds: nodeIds,\n        kpiCodes: kpiCodes,\n        startTime: null,\n        endTime: null,\n        timeRange: \"\",\n        statisticType: \"psiot\",\n        condList: []\n      };\n      var p = [\"kpi\", kpiQueryModel];\n      serviceProxy.get(base, \"getKpiHierarchyValueList\", p, callBack);\n    };\n\n    service.getKpiHierarchyValueList = function (p, callBack) {\n      serviceProxy.get(base, \"getKpiHierarchyValueList\", p, callBack);\n    };\n\n    service.exportKpiValueList = function (kpiQueryObj, callBack) {\n      serviceProxy.get(base, \"exportKpiValueList\", kpiQueryObj, callBack);\n    };\n\n    service.getValueList = function (param, callBack, extendstr) {\n      if (!extendstr) {\n        extendstr = includeFields;\n      }\n\n      serviceProxy.get(base, \"getKpiValueList\", param, function (returnObj) {\n        callBack(returnObj);\n      }, null, extendstr);\n    };\n\n    service.getKpiValList = function (param, callBack, extendstr) {\n      if (!extendstr) {\n        extendstr = includeFields;\n      }\n\n      var kpiQueryModel = {\n        category: \"time\",\n        isRealTimeData: true,\n        timePeriod: 0,\n        nodeIds: [],\n        kpiCodes: [],\n        startTime: null,\n        endTime: null,\n        timeRange: \"\",\n        statisticType: \"psiot\",\n        condList: []\n      }.$extension(param);\n      serviceProxy.get(base, \"getKpiValueList\", [\"kpi\", kpiQueryModel], function (returnObj) {\n        callBack(returnObj);\n      }, null, extendstr);\n    };\n\n    service.getKpiValueList = function (p, callBack, extendstr) {\n      if (!extendstr) {\n        extendstr = includeFields;\n      }\n\n      var handlerObj = {\n        code: 0,\n        data: {\n          recordList: []\n        },\n        source: null,\n        nodesDic: {},\n        kpisDic: {},\n        kpisNDic: {},\n        insDic: {}\n      };\n\n      var mergeKpiValue = function mergeKpiValue(kpiObj, config) {\n        var datavalue = handlerObj.data.recordList[handlerObj.data.recordList.length - 1];\n        var arisingMS = newDateJson(kpiObj.arisingTime).getTime();\n\n        if (datavalue.milliseconds == 0) {\n          datavalue.milliseconds = arisingMS;\n          datavalue.arisingTime = kpiObj.arisingTime;\n          datavalue.time = kpiObj.arisingTime;\n        }\n\n        if (arisingMS < datavalue.milliseconds + config.kpisDic.minTimespan) {\n          if (kpiObj.instance) {\n            handlerObj.insDic[kpiObj.instance] = kpiObj.instance;\n            datavalue[kpiObj.nodeId + \"?\" + kpiObj.kpiCode + \"?\" + kpiObj.instance] = kpiObj.value;\n          } else {\n            datavalue[kpiObj.nodeId + \"?\" + kpiObj.kpiCode] = kpiObj.value;\n          }\n        } else {\n          var obj = {\n            milliseconds: arisingMS,\n            arisingTime: kpiObj.arisingTime,\n            time: kpiObj.arisingTime\n          };\n\n          if (kpiObj.instance) {\n            handlerObj.insDic[kpiObj.instance] = kpiObj.instance;\n            obj[kpiObj.nodeId + \"?\" + kpiObj.kpiCode + \"?\" + kpiObj.instance] = kpiObj.value;\n          } else {\n            obj[kpiObj.nodeId + \"?\" + kpiObj.kpiCode] = kpiObj.value;\n          }\n\n          handlerObj.data.recordList.push(obj);\n        }\n      };\n\n      serviceProxy.get(base, \"getKpiValueList\", p, function (returnObj) {\n        if (returnObj.code == 0) {\n          handlerObj.source = returnObj.data;\n          var config = p[1];\n\n          if (returnObj.data.length > 0) {\n            if (config.timePeriod > 0) {\n              var startTime = newDateJson(returnObj.data[0].arisingTime).getTime();\n              var endTime = newDateJson(returnObj.data[returnObj.data.length - 1].arisingTime).getTime();\n              var timespan = config.kpisDic.minTimespan;\n              var timeDiff = endTime - startTime;\n            }\n          }\n\n          for (var i in returnObj.data) {\n            var kpiObj = returnObj.data[i];\n            handlerObj.nodesDic[kpiObj.nodeId] = config.nodesDic[kpiObj.nodeId].label;\n            handlerObj.kpisDic[kpiObj.kpiCode] = config.kpisDic[kpiObj.kpiCode].label;\n            handlerObj.kpisNDic[config.kpisDic[kpiObj.kpiCode].name] = kpiObj.kpiCode;\n\n            if (handlerObj.data.recordList.length == 0) {\n              handlerObj.data.recordList.push({\n                milliseconds: 0\n              });\n            }\n\n            if (config.timePeriod == 0) {\n              var datavalue = handlerObj.data.recordList[0];\n              /*\n              if (kpiObj.instance) {\n                handlerObj.insDic[kpiObj.instance] = kpiObj.instance;\n                datavalue[kpiObj.nodeId + \"?\" + kpiObj.kpiCode + \"?\" + kpiObj.instance] = kpiObj.value;\n              } else {\n                datavalue[kpiObj.nodeId + \"?\" + kpiObj.kpiCode] = kpiObj.value;\n              }\n              */\n\n              datavalue[kpiObj.nodeId + \"?\" + kpiObj.kpiCode] = kpiObj.value;\n              datavalue.arisingTime = kpiObj.arisingTime;\n              datavalue.time = kpiObj.arisingTime;\n            } else {\n              mergeKpiValue(kpiObj, config);\n            }\n          }\n        }\n        /*\n        if (handlerObj.data.recordList.length > 1) {\n          handlerObj.data.recordList.splice(handlerObj.data.recordList.length - 1, 1);\n        }\n        */\n\n\n        callBack(handlerObj);\n      }, null, extendstr);\n    };\n\n    service.getChartProperty = function (item, key) {\n      for (var i in item.properties.item) {\n        var pt = item.properties.item[i];\n\n        if (pt.name == key) {\n          return pt;\n        }\n      }\n    };\n\n    service.getKpisInfo = function (item) {\n      var kpiCodes = [];\n      var kpiName2Code = {};\n      var displayKpi = item.dataSource.displayKpiSet.displayKpi;\n\n      if (jQuery.isArray(displayKpi)) {\n        for (var i in displayKpi) {\n          var subDisplayKpi = displayKpi[i];\n          kpiCodes.push(Number(subDisplayKpi.code));\n          kpiName2Code[subDisplayKpi.code] = subDisplayKpi.name;\n        }\n      } else {\n        kpiCodes.push(Number(displayKpi.code));\n        kpiName2Code[displayKpi.code] = displayKpi.name;\n      }\n\n      return [kpiCodes, kpiName2Code];\n    };\n\n    service.getNodesInfo = function (item) {\n      var timePeriod;\n      var nodeIds = [];\n\n      for (var i in item.dataSource.filters.filter) {\n        var filterObj = item.dataSource.filters.filter[i];\n\n        if (filterObj.type == \"ci\") {\n          var tmpNodeIds = filterObj.nodeIds.split(',');\n\n          for (var j in tmpNodeIds) {\n            nodeIds.push(Number(tmpNodeIds[j]));\n          }\n        } else if (filterObj.type == \"time\") {\n          timePeriod = Number(filterObj.timePeriod) * 60 * 1000;\n        }\n      }\n\n      return [nodeIds, timePeriod];\n    };\n\n    service.mergeKpiHandler = function (kpiObj, config, handlerObj) {\n      var datavalue = handlerObj.data.recordList[handlerObj.data.recordList.length - 1];\n      var arisingMS = newDateJson(kpiObj.arisingTime).getTime();\n\n      if (arisingMS < datavalue.milliseconds + config.kpisDic.minTimespan) {\n        if (kpiObj.instance) {\n          handlerObj.insDic[kpiObj.instance] = kpiObj.instance;\n          datavalue[kpiObj.nodeId + \"?\" + kpiObj.kpiCode + \"?\" + kpiObj.instance] = kpiObj.value;\n        } else {\n          datavalue[kpiObj.nodeId + \"?\" + kpiObj.kpiCode] = kpiObj.value;\n        }\n      } else {\n        var obj = {\n          milliseconds: arisingMS,\n          arisingTime: kpiObj.arisingTime,\n          time: kpiObj.arisingTime\n        };\n\n        if (kpiObj.instance) {\n          handlerObj.insDic[kpiObj.instance] = kpiObj.instance;\n          obj[kpiObj.nodeId + \"?\" + kpiObj.kpiCode + \"?\" + kpiObj.instance] = kpiObj.value;\n        } else {\n          obj[kpiObj.nodeId + \"?\" + kpiObj.kpiCode] = kpiObj.value;\n        }\n\n        handlerObj.data.recordList.push(obj);\n      }\n\n      return handlerObj;\n    };\n\n    return service;\n  }]);\n});"],"sourceRoot":"/source/"}