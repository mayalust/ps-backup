{"version":3,"sources":["js/services/user-login-ui-service.js"],"names":["define","services","factory","$http","$state","$rootScope","serviceProxy","$q","route","location","window","timeout","growl","userEnterpriseService","psTreeData","psUiRouterHandler","cms2","psConfig","_INCLUDES","isFromFreeStyle","$$absUrl","indexOf","loginService","roleId","$$","urlparse","param","changeAuth","loggedIn","user","userId","userID","enterprise","enterpriseLogo","url","origin","isAuthenticated","$broadcast","loginPath","wait","callback","roles","viewType","firstCode","result","document","title","getCurrentUser","deferred","defer","get","code","data","usercurrentRoleID","currentRoleID","str","roleID","rs","parseInt","split","console","assert","warn","resolve","currentUrl","href","loginTimes","reject","promise","login","account","password","loginCallback","logout","dt","slice","modifyPassword","email","newPassword","callBack","loginin","loginName","redirectToLogin","changePos","loginChangedefer","appData","industry","$on","event","then","domainPath","Error","match","exec","rootId","params","id","queryEnterpriseRole","returnObj","find","ele","setRoleValues","values","getRoleValues","FIRST_TAB_PATH","children","d","go","apply","addEventListener","hashChange","e","replace","removeEventListener","rootHandler","$scope","$location","absUrl","search","localMenuCode","menuitems","currentMenuCode","treeviewIndex","path","locationStr","menuObj","locationAry","length","some","parentCode","locaStr1","warning","oldTreeviewIndex","functionCode","firstMenuCode","charAt","oldFirstMenuCode","$","css","removeClass","AdminLTE","layout","fix","key","defaultRoute","substr","function","forEach","subItem","initMenus","userInfo","functionList","menu","baseConfig","name","label","sublabel","decodeURIComponent","menuhandle","menuInfo","searchUrl","substring","handlemenu","getAddressPoint","address","jQuery","ajax","type","protocol","dataType","jsoncallback","success","status","lat","lng","error","log","hash"],"mappings":"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","file":"js/services/user-login-ui-service.js","sourcesContent":["define(['../services/services.js'], function (services) {\n  'use strict';\n\n  services.factory('userLoginUIService', ['$http', '$state', '$rootScope', 'serviceProxy', '$q', '$route', '$location', '$window', '$timeout', 'growl', 'userEnterpriseService', 'psTreeData', 'psUiRouterHandler', 'commonMethodService2', 'psConfig', function ($http, $state, $rootScope, serviceProxy, $q, route, location, window, timeout, growl, userEnterpriseService, psTreeData, psUiRouterHandler, cms2, psConfig) {\n    var _INCLUDES = ['prod_', 'rview'];\n    /** 暂时写死APP-FREE-STYLE不受权限控制，之后通过权限进行重新配置 */\n\n    var isFromFreeStyle = function (absUrl) {\n      return absUrl.indexOf(\"app-free-style\") != -1;\n    }(location.$$absUrl);\n    /** 暂时写死APP-FREE-STYLE不受权限控制，之后通过权限进行重新配置 */\n\n\n    var factory,\n        loginService = 'userLoginUIService';\n    var defer,\n        roleId = $$.urlparse().param['roleID'];\n    factory = {\n      loginPath: '',\n      user: {\n        wait: function wait(callback) {\n          defer = callback;\n        },\n        isAuthenticated: false,\n        roles: null,\n        viewType: null,\n        firstCode: null\n      },\n      result: {}\n    };\n\n    function extend(a, b) {\n      for (var i in b) {\n        a[i] = b[i];\n      }\n\n      return a;\n    }\n\n    function toJSON(str) {\n      var obj = null;\n\n      try {\n        obj = JSON.parse(str);\n      } catch (e) {\n        console.error(e);\n        return null;\n      }\n\n      return obj;\n    }\n\n    function addMenu(target, path, val) {\n      var patharr = path.split(\"/\"),\n          cpath = patharr.shift(),\n          currentTarget = target[cpath];\n\n      if (!currentTarget) {\n        return;\n      }\n\n      while (cpath = patharr.shift()) {\n        currentTarget.function = currentTarget.function || [];\n        var find = currentTarget.function.find(function (e) {\n          return e.functionCode == cpath;\n        }),\n            item;\n\n        if (!find) {\n          item = {\n            \"functionCode\": cpath,\n            \"parentCode\": currentTarget.functionCode\n          };\n          currentTarget.function.push(item);\n        } else {\n          item = find;\n        }\n\n        if (patharr.length == 0) {\n          extend(item, val || {});\n        }\n\n        currentTarget = item;\n      }\n    }\n\n    window.document.title = '';\n\n    function includePath(path) {\n      return _INCLUDES.some(function (e) {\n        return path.indexOf(e) != -1;\n      });\n    }\n\n    factory.getCurrentUser = function (callback) {\n      var deferred = $q.defer();\n\n      function getFirstRoleID(str) {\n        var rs;\n\n        if (typeof str === \"string\") {\n          rs = parseInt(str.split(\",\")[0]);\n          console.assert(rs === rs, \"角色ROLEID为空\");\n          return rs === rs ? rs : null;\n        } else {\n          console.warn(\"角色ROLEID不为字符串\");\n          return null;\n        }\n      }\n\n      serviceProxy.get(loginService, 'getCurrentUser', null, function (result) {\n        if (result != null && result != \"\" && result.code == 0 && result.data) {\n          factory.user = result.data;\n          factory.user.usercurrentRoleID = factory.user.currentRoleID = roleId || getFirstRoleID(factory.user.roleID);\n          factory.user.usercurrentRoleID += \"\";\n          factory.user.currentRoleID += \"\";\n          factory.user.isAuthenticated = true;\n          deferred.resolve(result.data);\n          changeAuth(true);\n          var currentUrl = document.location.href;\n\n          if (typeof callback == \"function\") {\n            callback(factory.user);\n          }\n\n          psTreeData.getCurrentUser(factory.user);\n\n          if (result.data.loginTimes == 0 && currentUrl.indexOf('password.html') < 0) {\n            window.location.href = \"../app-uc/password.html\";\n          }\n        } else {\n          deferred.reject(\"error\");\n          changeAuth(false);\n        }\n      });\n      return deferred.promise;\n    };\n\n    factory.login = function (account, password, callback) {\n      serviceProxy.get(loginService, 'login', [account, password], function (result) {\n        if (result != null && result != \"\" && result.code == 0 && result.data) {\n          factory.user = result.data;\n          factory.user.isAuthenticated = true;\n          changeAuth(true);\n        } else {\n          factory.result = result;\n          changeAuth(false);\n        }\n      });\n    };\n\n    factory.loginCallback = function (account, password, callback) {\n      serviceProxy.get(loginService, 'login', [account, password], callback);\n    };\n\n    factory.logout = function () {\n      serviceProxy.get(loginService, 'logout', null, function (result) {\n        if (result != null && result != \"\" && result.code == 0) {\n          var dt = result.data;\n          dt = dt[0] == \"/\" && dt.slice(1) || dt;\n          window.location.href = \"../\" + dt;\n          factory.user = {};\n          factory.user.isAuthenticated = false;\n          changeAuth(false);\n        }\n      });\n    };\n    /**\n     * 修改密码\n     */\n\n\n    factory.modifyPassword = function (email, password, newPassword, callBack) {\n      serviceProxy.get(loginService, \"modifyPassword\", [email, password, newPassword], callBack);\n    };\n    /**\n     * 超级管理员切换用户\n     * loginName  登录名称\n     */\n\n\n    factory.loginin = function (loginName, callBack) {\n      serviceProxy.get(loginService, \"loginin\", loginName, callBack);\n    };\n\n    factory.redirectToLogin = function () {\n      $rootScope.$broadcast('redirectToLogin', null);\n    };\n    /**\n     * 跳转路径的切换，解决方案优先行业\n     */\n\n\n    factory.changePos = function () {\n      var loginChangedefer = $q.defer();\n      var defer = $q.defer();\n\n      if (factory.user ? factory.user.appData == null : true) {\n        $rootScope.$on('loginStatusChanged', function (event) {\n          loginChangedefer.resolve({\n            appData: factory.user.appData,\n            industry: factory.user.industry\n          });\n        });\n      } else {\n        loginChangedefer.resolve({\n          appData: factory.user.appData,\n          industry: factory.user.industry\n        });\n      }\n\n      loginChangedefer.promise.then(function (data) {\n        // 根据角色ID查找当前配置的tab页签\n        var domainPath = factory && factory.user && factory.user.domainPath;\n\n        if (!domainPath) {\n          throw new Error(\"invalid user data\");\n          return;\n        }\n\n        var match = /\\/(\\d+)\\/$/.exec(domainPath),\n            rootId = match ? match[1] : null;\n\n        if (!rootId) {\n          throw new Error(\"invalid user domainPath\");\n          return;\n        }\n\n        $state.params.id = rootId;\n        userEnterpriseService.queryEnterpriseRole(function (returnObj) {\n          if (returnObj.code == 0) {\n            var find = returnObj.data.find(function (ele) {\n              if (ele.roleID == 127260997560018) {\n                return false;\n              }\n\n              ;\n              return factory.user.roleID.indexOf(ele.roleID) !== -1;\n            });\n            psConfig.setRoleValues(find.values);\n            psConfig.getRoleValues().then(function (values) {\n              var FIRST_TAB_PATH = values.children[0];\n              return psUiRouterHandler(FIRST_TAB_PATH);\n            }).then(function (d) {\n              var name = d[0],\n                  args = d[1],\n                  hashChange = function hashChange(e) {\n                var href = window.location.href.replace(\"index.html\", \"index_freeboard.html\");\n                window.location.href = href;\n                window.removeEventListener(\"hashchange\", hashChange);\n              };\n\n              args.id = rootId;\n              $state.go.apply($state, d);\n              window.addEventListener(\"hashchange\", hashChange);\n            });\n          }\n        });\n      });\n      return defer.promise;\n    };\n\n    function changeAuth(loggedIn) {\n      if (loggedIn) {\n        factory.user.userId = factory.user.userID; // 设置企业ICON\n\n        if (factory.user.enterprise != null) {\n          if (factory.user.enterprise.enterpriseLogo != null && factory.user.enterprise.enterpriseLogo != \"\") {\n            var url = serviceProxy.origin + \"/\" + factory.user.enterprise.enterpriseLogo;\n            factory.user.enterprise.enterpriseLogo = url;\n            factory.user.enterprise[\"logoStatus\"] = \"0\";\n          } else {\n            factory.user.enterprise.enterpriseLogo = \"../images/enterprise/logo.svg\";\n          }\n        } else {\n          var logo = {\n            \"enterpriseLogo\": \"../images/enterprise/logo.svg\"\n          };\n          factory.user.enterprise = logo;\n        }\n\n        factory.user.isAuthenticated = loggedIn;\n        $rootScope.$broadcast('loginStatusChanged', loggedIn);\n        /**\n         serviceProxy.get(\"resourceUIService\", 'getAppData', null, function(result) {\n          if(result != null && result != \"\" && result.code == 0) {\n            factory.user.appData = result.data;\n            factory.user.isAuthenticated = loggedIn;\n            if(defer) {\n              defer();\n            }\n            delete factory.user.wait;\n            $rootScope.$broadcast('loginStatusChanged', loggedIn);\n          } else {\n           }\n        });*/\n      } else {\n        factory.user.isAuthenticated = loggedIn;\n        $rootScope.$broadcast('loginStatusChanged', loggedIn);\n      }\n    }\n\n    ;\n\n    factory.rootHandler = function ($scope, $location) {\n      var absUrl = $location.absUrl().split(\"#\")[0];\n\n      if (absUrl.search(\"/app-oc/\") > -1) {\n        //运营中心\n        $scope.localMenuCode = \"F01\";\n      } else if (absUrl.search(\"/app-sc/\") > -1) {\n        //服务中心\n        $scope.localMenuCode = \"F02\";\n      } else if (absUrl.search(\"/app-ac/\") > -1) {\n        //应用中心\n        $scope.localMenuCode = \"F03\";\n      } else if (absUrl.search(\"/app-uc/\") > -1) {\n        //用户中心\n        $scope.localMenuCode = \"F04\";\n      } else if (absUrl.search(\"/app-help/\") > -1) {\n        //帮助中心\n        $scope.localMenuCode = \"F05\";\n      } //权限没有加载完成时跳出\n\n\n      if (!$scope.menuitems[\"isloaded\"]) {\n        return;\n      }\n      /** 暂时写死APP-FREE-STYLE不受权限控制，之后通过权限进行重新配置 */\n\n\n      if (isFromFreeStyle) {\n        return;\n      }\n      /** 暂时写死APP-FREE-STYLE不受权限控制，之后通过权限进行重新配置 */\n\n\n      $scope.currentMenuCode = null;\n      $scope.treeviewIndex = $location.path();\n      var locationAry = $location.path().split(\"/\");\n      var locationStr;\n      var menuObj;\n\n      if (locationAry.length == 1 || !locationAry[1]) {\n        //没有默认路由时，使用权限第一个M权限，如果M权限没有url则使用其下的一个S权限\n        for (var key in $scope.menuitems) {\n          //console.log(key, $scope.menuitems[key], $scope.localMenuCode);\n          if (key.indexOf(\"M\") == 0 && $scope.menuitems[key].parentCode == $scope.localMenuCode && !menuObj) {\n            if ($scope.menuitems[key].url) {\n              if ($scope.defaultRoute) {\n                window.location.href = $scope.defaultRoute;\n              } else {\n                var path = $scope.menuitems[key].url.substr(1);\n                $location.path(path);\n                menuObj = $scope.menuitems[key];\n              }\n\n              return false;\n            } else {\n              $scope.menuitems[key].function.forEach(function (subItem) {\n                if (subItem.functionCode.indexOf(\"S\") == 0 && subItem.url && !menuObj) {\n                  var path = subItem.url.substr(1);\n                  $location.path(path);\n                  menuObj = subItem;\n                  return false;\n                }\n              });\n            }\n          }\n        }\n\n        if (!menuObj) {\n          growl.warning(\"您并没有访问该功能的权限，请联系系统管理人员\", {});\n        }\n\n        return;\n      } else if (locationAry.length > 2) {\n        //两级以上路由时，仅判断到第二级，如有特殊需求可自行扩展\n        locationStr = \"#/\" + locationAry[1] + \"/\" + locationAry[2]; //locationStr = \"#/\"+locationAry[1] + \"/\";\n\n        menuObj = $scope.menuitems[locationStr];\n\n        if (!menuObj) {\n          //如果指定二级路由没有权限，查看0模式下是否存在（告警查询权限）\n          menuObj = $scope.menuitems[\"#/\" + locationAry[1] + \"/0\"];\n        }\n      }\n\n      if (!menuObj) {\n        //如果二级路由0模式下也没有权限，上推到一级路由\n\n        /** 当路径当中带了prod_前缀，不进行校验。 */\n        if (includePath($location.path())) {\n          menuObj = {\n            parentCode: \"M01\"\n          };\n        } else {\n          locationStr = \"#/\" + locationAry[1];\n          var locaStr1 = \"#/\" + locationAry[1] + \"/\";\n          menuObj = $scope.menuitems[locationStr] || $scope.menuitems[locaStr1];\n        }\n      }\n\n      if (typeof menuObj === \"undefined\") {\n        //如果都没有权限，提示权限错误\n        growl.warning(\"您并没有访问该功能的权限，请联系系统管理人员\", {});\n        $location.path($scope.oldTreeviewIndex);\n        return;\n      }\n\n      ;\n      $scope.oldTreeviewIndex = $scope.treeviewIndex;\n\n      if (menuObj) {\n        $scope.currentMenuCode = menuObj.functionCode || null;\n        $scope.firstMenuCode = menuObj.functionCode || null;\n\n        if (menuObj.parentCode.charAt(0) == \"M\") {\n          $scope.firstMenuCode = $scope.menuitems[menuObj.parentCode] ? $scope.menuitems[menuObj.parentCode].functionCode : null;\n        } else {\n          if ($scope.menuitems[menuObj.parentCode].parentCode.charAt(0) == \"M\") {\n            $scope.firstMenuCode = $scope.menuitems[$scope.menuitems[menuObj.parentCode].parentCode].functionCode;\n          }\n        }\n      }\n\n      if ($scope.oldFirstMenuCode != $scope.firstMenuCode && $scope.firstMenuCode != null && $scope.oldFirstMenuCode != null) {\n        $(\"[name='\" + $scope.oldFirstMenuCode + \"']\").css('display', 'none');\n        $(\"[name='\" + $scope.oldFirstMenuCode + \"']\").removeClass('menu-open');\n        $(\"[name='\" + $scope.firstMenuCode + \"']\").css('display', 'block');\n      }\n\n      $scope.oldFirstMenuCode = $scope.firstMenuCode;\n      timeout(function () {\n        $.AdminLTE.layout.fix(); //调整一下页面\n      });\n    };\n\n    factory.initMenus = function ($scope, $location) {\n      function menuhandle(menuInfo) {\n        menuInfo.searchUrl = menuInfo.url ? menuInfo.url.substring(1) + \"/\" : \"\"; //菜单选中状态用\n\n        if (menuInfo.function) {\n          menuInfo.function.forEach(function (handlemenu) {\n            if ($scope.baseConfig && $scope.baseConfig[handlemenu.functionCode]) {\n              handlemenu.name = $scope.baseConfig[handlemenu.functionCode].label;\n              handlemenu.label = $scope.baseConfig[handlemenu.functionCode].sublabel;\n            }\n\n            menuInfo.searchUrl = menuInfo.searchUrl + (handlemenu.url ? handlemenu.url.substring(1) + \"/\" : \"\"); //console.log(handlemenu.functionCode);\n\n            $scope.menuitems[handlemenu.functionCode] = handlemenu;\n\n            if (handlemenu.url) {\n              var url = decodeURIComponent(handlemenu.url);\n              $scope.menuitems[url] = handlemenu;\n            }\n\n            menuhandle(handlemenu);\n          });\n        }\n      }\n\n      $scope.userInfo.functionList.forEach(function (menu) {\n        if ($scope.baseConfig && $scope.baseConfig[menu.functionCode]) {\n          menu.name = $scope.baseConfig[menu.functionCode].label;\n          menu.label = $scope.baseConfig[menu.functionCode].sublabel;\n        }\n\n        $scope.menuitems[menu.functionCode] = menu;\n\n        if (menu.url) {\n          var url = decodeURIComponent(menu.url);\n          $scope.menuitems[url] = menu;\n        }\n\n        ;\n        menuhandle(menu);\n      });\n      $scope.menuitems[\"isloaded\"] = true; //加载完毕\n\n      /** 增加一个方法ADDMENU能自定义写入菜单*/\n\n      /**\n       addMenu($scope.menuitems, \"F01/M02/S117\", {\n        name : \"设备视图管理\",\n        icon : \"fa fa-circle\",\n        url : \"#/rview\"\n      })**/\n\n      factory.rootHandler($scope, $location);\n    };\n\n    factory.getAddressPoint = function (address, callBack) {\n      if (address) {\n        jQuery.ajax({\n          type: \"GET\",\n          url: window.location.protocol + \"//api.map.baidu.com/geocoder/v2/?address=\" + address + \"&output=json&ak=eMekSXxqG1j2wLM57RFN61l8T6eB1EDx\",\n          dataType: \"jsonp\",\n          jsoncallback: 'callBack',\n          success: function success(d) {\n            if (d.status == 0) {\n              if (callBack) {\n                callBack(d.result);\n              }\n            } else {\n              if (callBack) {\n                callBack({\n                  location: {\n                    lat: \"\",\n                    lng: \"\"\n                  }\n                });\n              }\n            }\n          },\n          error: function error(e) {\n            console.log('ajax error');\n          }\n        });\n      } else {\n        if (callBack) {\n          callBack(null);\n        }\n      }\n    };\n\n    if (window.location.hash.indexOf(\"dailyReport\") !== -1) {\n      factory.user.isAuthenticated = true;\n    } else {\n      factory.getCurrentUser();\n    }\n\n    return factory;\n  }]);\n});"],"sourceRoot":"/source/"}