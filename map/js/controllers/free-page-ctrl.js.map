{"version":3,"sources":["js/controllers/free-page-ctrl.js"],"names":["_typeof","obj","Symbol","iterator","constructor","prototype","define","controllers","freePageCtrl","scope","rootScope","viewFlexService","resourceUIService","timeout","window","Info","freeboardservice","growl","routeParams","freeboardBaseService","userLoginUIService","input","viewId","viewTitle","page","pa","parameter","naviClick","link","param","location","href","encodeURIComponent","JSON","stringify","setCurrentTab","str","console","log","bgColorFn","bgColor","background-color","instance","renderData","dt","setting","color","hasOwnProperty","vt","va_arr","vt_arr","split","parse","length","base","rs","loop","inx","elem","find","element","path","tabLabel","push","label","slice","parseInt","i","navigation","arr","allAvaliableViews","template","modelId","resourceId","concat","getManagedViewsByTypeAndRole","event","code","data","getDefaultView","templateDefault","templateExtent","user","roleResList","some","resId","resType","getViewById","model","resource","content","getModelByIds","getResource_back","clone","layout","editData","replaceCiKpi","setMode","renderLayout","getResourceById","getResources","resources","itemchange","id","error","tabIndex","indexOf","tabs","groups","get","info","message","selectEditDataGroup","tab","renderBoard","registerController","$inject"],"mappings":"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","file":"js/controllers/free-page-ctrl.js","sourcesContent":["function _typeof(obj) { if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; }; } return _typeof(obj); }\n\ndefine(['controllers/controllers', 'Array'], function (controllers) {\n  'use strict';\n\n  controllers.registerController('freePageCtrl', freePageCtrl);\n  freePageCtrl.$inject = [\"$scope\", \"$rootScope\", \"viewFlexService\", \"resourceUIService\", \"$timeout\", \"$window\", \"Info\", \"freeboardservice\", 'growl', '$routeParams', 'freeboardBaseService', 'userLoginUIService'];\n\n  function freePageCtrl(scope, rootScope, viewFlexService, resourceUIService, timeout, window, Info, freeboardservice, growl, routeParams, freeboardBaseService, userLoginUIService) {\n    var input,\n        viewId,\n        currentView,\n        viewTitle = routeParams.page ? routeParams.page : 'index',\n        pa = routeParams.parameter;\n    viewId = routeParams.viewId;\n\n    scope.naviClick = function (link, param) {\n      window.location.href = \"../app-free-style/index.html#/\" + viewId + \"/\" + link + \"/\" + encodeURIComponent(JSON.stringify(param));\n    };\n\n    rootScope.setCurrentTab = function (str) {\n      console.log(\"asd\" + str);\n    };\n\n    scope.bgColorFn = function (bgColor) {\n      return {\n        \"background-color\": bgColor ? bgColor : \"#eee\"\n      };\n    };\n\n    scope.instance = {};\n\n    var renderData = function renderData(dt) {\n      scope.setting = dt.setting;\n\n      if (dt.setting) {\n        scope.bgColor = dt.setting.color;\n      }\n\n      if (dt.hasOwnProperty(\"groups\")) {\n        var vt,\n            vt_arr = viewTitle.split(\"|\"),\n            va_arr;\n\n        if (pa) {\n          va_arr = JSON.parse(pa);\n        } else {\n          va_arr = [];\n        }\n\n        if (vt_arr.length > 0) {\n          vt = vt_arr[vt_arr.length - 1];\n        } else {\n          vt = viewTitle;\n          vt_arr = [viewTitle];\n        }\n\n        var base = '',\n            rs = [];\n\n        var loop = function loop(inx, elem) {\n          var find = dt[\"groups\"].find(function (element) {\n            return elem == element.path;\n          });\n\n          if (find) {\n            base = base == \"\" ? elem : base + \"|\" + elem;\n            var param = va_arr[inx],\n                tabLabel;\n\n            if (_typeof(param) == \"object\" && param != null) {\n              tabLabel = param.tabLabel;\n            }\n\n            rs.push({\n              label: tabLabel ? tabLabel : find.label,\n              link: base,\n              param: va_arr.slice(0, parseInt(inx) + 1)\n            });\n          }\n\n          ;\n        };\n\n        for (var i in vt_arr) {\n          loop(i, vt_arr[i]);\n        }\n\n        ;\n        scope.navigation = rs;\n\n        var getLastElement = function getLastElement(arr) {\n          return arr[arr.length - 1];\n        };\n\n        var parameter = {};\n\n        if (routeParams.parameter) {\n          parameter = getLastElement(JSON.parse(routeParams.parameter));\n        }\n\n        ;\n        rootScope.parameter = parameter;\n\n        if (vt == \"panel\") {\n          var modelId = parameter.modelId;\n          var resourceId = parameter.resourceId;\n          scope.navigation = scope.navigation.concat({\n            label: parameter.tabLabel ? parameter.tabLabel : \"设备仪表板\",\n            link: base + \"|panel\"\n          });\n          var allAvaliableViews, defaultViews, template;\n\n          var getManagedViewsByType_back = function getManagedViewsByType_back(event) {\n            if (event.code == 0) {\n              allAvaliableViews = event.data;\n\n              var getDefaultView_back = function getDefaultView_back(event) {\n                if (event.code == \"0\") {\n                  defaultViews = event.data;\n                  var templateDefault = defaultViews.find(function (elem) {\n                    if (elem.template) {\n                      if (elem.template.resourceId == modelId) {\n                        return true;\n                      } else {\n                        return false;\n                      }\n                    } else {\n                      return false;\n                    }\n                  });\n                  var templateExtent = allAvaliableViews.find(function (elem) {\n                    var viewId = elem.viewId;\n\n                    if (elem.template) {\n                      if (elem.template.resourceId == modelId) {\n                        var findRoleRes = function findRoleRes(elem) {\n                          return elem.resId == viewId && elem.resType == 21;\n                        };\n\n                        var authorized = userLoginUIService.user.roleResList.some(findRoleRes);\n                        return authorized;\n                      } else {\n                        return false;\n                      }\n                    } else {\n                      return false;\n                    }\n                  });\n\n                  if (templateExtent) {\n                    template = templateExtent;\n                  } else if (templateDefault) {\n                    template = templateDefault;\n                  }\n\n                  if (template) {\n                    var getViewById_back = function getViewById_back(event) {\n                      var model, resource, content;\n\n                      if (event.code == \"0\") {\n                        var content = event.data.content;\n\n                        var getModel_back = function getModel_back(event) {\n                          if (event.code == \"0\") {\n                            model = event.data[0];\n                          }\n\n                          var getResource_back = function getResource_back(event) {\n                            if (event.code == \"0\") {\n                              resource = event.data;\n\n                              if (content != null) {\n                                var clone = JSON.parse(content);\n                                var input = {\n                                  layout: clone.data ? clone.data : clone.layout,\n                                  setting: clone.setting\n                                };\n                                delete clone.data;\n                                var editData = new freeboardservice.replaceCiKpi(input, function () {\n                                  timeout(function () {\n                                    scope.instance.setMode(true);\n                                    scope.instance.renderLayout(editData);\n                                  });\n                                }, {\n                                  model: model,\n                                  resource: resource\n                                }, clone);\n                              }\n                            }\n                          };\n\n                          if (resourceId) {\n                            resourceUIService.getResourceById(resourceId, getResource_back);\n                          } else {\n                            var getResources_back = function getResources_back(event) {\n                              if (event.code == 0) {\n                                scope.resources = event.data;\n                                /** console.log(scope.resources); */\n\n                                scope.resource = scope.resources[0];\n\n                                scope.itemchange = function (event) {\n                                  var id = event.id.split(\"number:\")[1];\n                                  var find = scope.resources.find(function (elem) {\n                                    return elem.id == id;\n                                  });\n\n                                  if (find) {\n                                    getResource_back({\n                                      code: 0,\n                                      data: find\n                                    });\n                                  }\n                                };\n\n                                getResource_back({\n                                  code: 0,\n                                  data: scope.resources[0]\n                                });\n                              }\n\n                              ;\n                            };\n\n                            resourceUIService.getResources(getResources_back);\n                          }\n\n                          ;\n                        };\n\n                        resourceUIService.getModelByIds([modelId], getModel_back);\n                      }\n                    };\n\n                    viewFlexService.getViewById(template.viewId, getViewById_back);\n                  } else {\n                    scope.error = \"没有找到相应的设备仪表板视图，点击<a href='#/views/dashboard' style='cursor:pointer; text-decoration: underline;'>Dashboard管理</a>创建设备仪表板\";\n                  }\n                } else {\n                  scope.error = \"视图列表为空，请联系系统管理员\";\n                }\n              };\n\n              viewFlexService.getDefaultView(modelId, getDefaultView_back);\n            } else {\n              scope.error = \"获取视图列表发生错误，请联系系统管理员\";\n            }\n          };\n\n          viewFlexService.getManagedViewsByTypeAndRole('dashboard', getManagedViewsByType_back);\n        } else {\n          //var parameter = JSON.parse($routeParams.parameter);\n          var find = dt[\"groups\"].find(function (element) {\n            return vt == element.path;\n          });\n          scope.tabIndex = find ? dt['groups'].indexOf(find) : 0;\n          scope.tabs = dt.groups;\n          input = {\n            layout: dt.groups[scope.tabIndex].layout,\n            setting: dt.setting\n          };\n          var editData = new freeboardservice.replaceCiKpi(input, function () {\n            timeout(function () {\n              scope.instance.setMode(true);\n              scope.instance.renderLayout(editData);\n            });\n          }, null, dt);\n        }\n      } else if (dt.hasOwnProperty(\"data\")) {\n        scope.navigation = [{\n          label: '运营首页'\n        }];\n        input = {\n          layout: dt.data,\n          setting: dt.setting\n        };\n        var editData = new freeboardservice.replaceCiKpi(input, function () {\n          timeout(function () {\n            scope.instance.setMode(true);\n            scope.instance.renderLayout(editData);\n          });\n        }, null, dt);\n      } else if (dt.hasOwnProperty(\"layout\")) {\n        scope.navigation = [{\n          label: '运营首页'\n        }];\n        input = {\n          layout: dt.layout,\n          setting: dt.setting\n        };\n        var editData = new freeboardservice.replaceCiKpi(input, function () {\n          timeout(function () {\n            scope.instance.setMode(true);\n            scope.instance.renderLayout(editData);\n          });\n        }, null, dt);\n      }\n\n      ;\n    };\n\n    var getViewById_back = function getViewById_back(event) {\n      if (event.code == 0 && event.data != null) {\n        var input;\n        var content = event.data.content;\n        var dt = JSON.parse(content);\n        renderData(dt);\n      } else {\n        scope.error = \"此用户无配置首页视图\" + (event.message ? \",\" + event.message : \"\");\n      }\n\n      ;\n    };\n\n    if (viewId == 'help') {\n      var path = \"../localdb/help.json\";\n      Info.get(path, function (info) {\n        renderData(info);\n      });\n    } else {\n      viewFlexService.getViewById(viewId, getViewById_back);\n    }\n\n    scope.selectEditDataGroup = function (tab) {\n      scope.tabIndex = tab.id;\n      input = {\n        layout: tab.layout,\n        setting: scope.editData.setting\n      };\n      scope.editData = new freeboardservice.replaceCiKpi(input, function () {\n        timeout(function () {\n          console.log(scope.editData);\n          scope.editData.renderBoard(true, true);\n        });\n      });\n    };\n  }\n});"],"sourceRoot":"/source/"}