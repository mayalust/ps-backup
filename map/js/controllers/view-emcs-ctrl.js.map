{"version":3,"sources":["js/controllers/view-emcs-ctrl.js"],"names":["define","controllers","BootstrapDialog","initController","$scope","$filter","$location","$routeParams","$timeout","viewFlexService","kpiDataService","resourceUIService","growl","userLoginUIService","userDomainService","route","SwSocket","Info","unitService","console","log","deviceView","selectedDevicetitem","kpis","timePeriod","domainListDic","kpiSearch","domainsAry","defaultDomain","tableDataLoading","chartData","tableData","uuid","Math","erroruuid","domainStates","gateData","selectedRadioId","queryDitem","kpiDef","deviceswitchflg","kpiswitchflg","colorArray","times","get","info","emcsAlertColor","emcsSetTime","kpiQueryModel","statisticType","category","nodeIds","kpiCodes","isRealTimeData","startTime","endTime","timeRange","queryInstances","initAllData","s","selectedKpi","jQuery","find","length","AdminLTE","boxWidget","collapse","initHistory","name","unit","data","getRealTimeHistoryData","getData","id","kpiData","idArray","getMSvalue","p","getValueList","returnObj","code","xData","series","type","forEach","e","push","formatDate","arisingTime","value","f","kpiCode","label","rangeObj","$broadcast","option","getOption","reverse","selectedRadio","kpi","setTimeout","$","scrollTop","parseInt","title","text","subtext","x","y","tooltip","trigger","formatter","params","date","xAxis","boundaryGap","yAxis","axisLabel","datestr","formatKpiValue","r","v","undefined","indexOf","JSON","parse","getCurrentKpiData","modelId","callback","evendata","i","$apply","range","time","obj","unshift","kpiIds","valueStr","includeInstance","window","param","ciid","toString","operation","register","send","warning","$on","unregister","errorCallback","eventData","instance","nodeId","color","alertCode","getDeviceError","deviceview","gotoDeviceView","item","location","href","getResourcehandler","goSearch","extend","domains","domainPath","getDevicesByCondition","ci","icon","rootModelDic","goClear","customerId","projectId","sn","gatewayId","getKPIs","stringify","modelID","getKpisByModelId","callbackfun","getDataItemsByModelId","regExp","myOptionDic","test","rangeAry","Array","min","max","Object","domainCallback","domainListTree","selectedParentitem","init","getRootModel","rootModel","routePathNodes","getModels","tree","parentModelId","cmpObj","addNodes","parentNode","modeid","nodes","key","getAllGateways","menuitems","baseConfig","extendDomain","getExtendDomainsByFilter","queryDomainTree","user","userID","menuitemsWatch","$watch","o","n","hasOwnProperty","searchMode","getResourceById","itemDirValues","initKpiData","unitArray","labelArray","granularityArray","granularityUnitArray","Event","ECHARTINFOSINIT","nulloption","getUnit","units","myOptions","unitDics","getAllUnits","unitCode","unitName","isAuthenticated","evt","d"],"mappings":"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","file":"js/controllers/view-emcs-ctrl.js","sourcesContent":["define(['controllers/controllers', 'bootstrap-dialog'], function (controllers, BootstrapDialog) {\n  'use strict';\n\n  controllers.initController('ViewEmcsCtrl', ['$scope', '$filter', '$location', '$routeParams', '$timeout', 'viewFlexService', 'kpiDataService', 'resourceUIService', 'growl', 'userLoginUIService', 'userDomainService', '$route', 'SwSocket', 'Info', 'unitService', function ($scope, $filter, $location, $routeParams, $timeout, viewFlexService, kpiDataService, resourceUIService, growl, userLoginUIService, userDomainService, route, SwSocket, Info, unitService) {\n    console.log(\"进入设备监控视图\");\n    $scope.deviceView = null;\n    $scope.selectedDevicetitem;\n    $scope.kpis = [];\n    $scope.timePeriod = \"10\";\n    $scope.domainListDic = {};\n    $scope.kpiSearch = \"\";\n    $scope.domainsAry = [];\n    $scope.defaultDomain = [];\n    $scope.tableDataLoading = false;\n    $scope.chartData = null; //Chart图数据\n\n    $scope.tableData = {}; //Table表格数据\n\n    $scope.uuid = Math.uuid(); //kpi指标值uuid\n\n    $scope.erroruuid = Math.uuid(); //设备故障的uuid\n\n    $scope.domainStates = false; //控制显示隐藏域\n\n    $scope.gateData = []; //网关\n\n    $scope.selectedRadioId = null; //選中的kpi指標\n\n    $scope.queryDitem = {}; //查询条件\n\n    $scope.kpiDef = {}; //KPI定义\n\n    $scope.deviceswitchflg = 0; //设备默认显示列表\n\n    $scope.kpiswitchflg = 0; //KPI默认显示列表\n    //    var target = echarts.init($(\"#linedataview\")[0]);\n\n    var colorArray = [];\n    $scope.times = null;\n    var path = \"../localdb/info.json\";\n    Info.get(path, function (info) {\n      colorArray = info.emcsAlertColor;\n      $scope.times = info.emcsSetTime;\n    });\n    var kpiQueryModel = {\n      \"statisticType\": \"\",\n      \"category\": \"time\",\n      //ci 是实时最新当前数据，time 是当前获取到的数据\n      \"nodeIds\": [],\n      //设备 ID  List\n      \"kpiCodes\": [],\n      //KPI ID  List\n      \"isRealTimeData\": true,\n      //是否是实时数据\n      \"timePeriod\": \"\",\n      //获取数据时间周期\n      \"startTime\": \"\",\n      //获取数据开始时间\n      \"endTime\": \"\",\n      //获取数据结束时间\n      \"timeRange\": \"\",\n      //暂时没用\n      \"queryInstances\": null\n    }; //初始化所有的数据\n\n    function initAllData(s) {\n      if (s == 'a') {\n        $scope.deviceView = [];\n        $scope.kpis = [];\n        $scope.selectedKpi = null;\n        $scope.selectedDevicetitem = null;\n        $scope.deviceView = null;\n\n        if (jQuery(\"#devicecollapse\").find(\".fa.fa-plus\").length == 0) {\n          jQuery.AdminLTE.boxWidget.collapse(jQuery(\"#devicecollapse\"));\n        }\n\n        $scope.kpis = null;\n\n        if (jQuery(\"#kpicollapse\").find(\".fa.fa-plus\").length == 0) {\n          jQuery.AdminLTE.boxWidget.collapse(jQuery(\"#kpicollapse\"));\n        }\n\n        if (jQuery(\"#viewcollapse\").find(\".fa.fa-plus\").length == 0) {\n          jQuery.AdminLTE.boxWidget.collapse(jQuery(\"#viewcollapse\"));\n        }\n      } else if (s == 'b') {\n        $scope.kpis = [];\n        $scope.selectedKpi = null;\n      }\n\n      initHistory();\n      $scope.timePeriod = \"10\";\n      $scope.tableData = {\n        \"name\": \"\",\n        \"unit\": \"\",\n        \"data\": []\n      };\n    }\n\n    ;\n    /**\n     * 根据输入的时间获取实时的历史数据\n     */\n\n    $scope.getRealTimeHistoryData = function () {\n      getData();\n    };\n    /**\n     * 获取历史数据\n     */\n\n\n    var getData = function getData() {\n      if (!$scope.selectedDevicetitem) return;\n      var id = $scope.selectedDevicetitem.id;\n      kpiQueryModel.nodeIds = [id];\n      kpiQueryModel.kpiCodes = $scope.kpiData.idArray;\n      kpiQueryModel.category = \"time\";\n      kpiQueryModel.timePeriod = resourceUIService.getMSvalue(0, $scope.selectedKpi) * $scope.timePeriod; //      if ( kpiQueryModel.timePeriod / resourceUIService.getMSvalue(0,$scope.selectedKpi) > 5000) {\n      //        growl.warning(\"非常抱歉，您当前获得的数据条数过大，为了能够获得最佳显示效果，请选择更小的条数。\",{});\n      //        return;\n      //      }\n\n      var p = [\"kpi\", kpiQueryModel]; //新接口\n\n      $scope.tableDataLoading = true;\n      kpiDataService.getValueList(p, function (returnObj) {\n        if (returnObj.code == 0) {\n          $scope.tableDataLoading = false; //初始化图表数据\n\n          initHistory();\n          $scope.tableData = {\n            \"name\": \"\",\n            \"unit\": \"\",\n            \"data\": []\n          };\n          $scope.chartData = {\n            \"xData\": [],\n            \"series\": {\n              \"name\": \"\",\n              \"type\": \"line\",\n              \"data\": []\n            }\n          }; //历史数据table数据的展示\n\n          if (returnObj.data.length != 0) {\n            formatData(returnObj.data);\n          }\n        }\n      });\n    };\n    /**\n     * 处理单选按钮选中事件\n     * @param kpi\n     */\n\n\n    $scope.selectedRadio = function (kpi) {\n      if (jQuery(\"#viewcollapse\").find(\".fa.fa-plus\").length > 0) {\n        jQuery.AdminLTE.boxWidget.collapse(jQuery(\"#viewcollapse\"));\n      }\n\n      setTimeout(function () {\n        $('.content-wrapper').scrollTop(1000000);\n      }, 500);\n      $scope.selectedKpi = kpi;\n      $scope.selectedRadioId = parseInt(kpi.id);\n      $scope.kpiData.idArray = [$scope.selectedRadioId]; //获取数据\n\n      getData();\n    }; //定义EChart option\n\n\n    var getOption = function getOption(chartData) {\n      return {\n        title: {\n          text: '',\n          subtext: '',\n          x: 'center',\n          y: 'top'\n        },\n        tooltip: {\n          trigger: 'axis',\n          formatter: function formatter(params) {\n            params = params[0];\n            var date = params.name;\n            var value = params.value || params.value == 0 ? params.value : '';\n            var name = chartData.series.name ? chartData.series.name : '';\n            return date ? date + '<br>' + name + ' : ' + value : '没有数据';\n          }\n        },\n        xAxis: [{\n          type: 'category',\n          boundaryGap: false,\n          data: chartData.xData //[]\n\n        }],\n        yAxis: [{\n          type: 'value',\n          axisLabel: {\n            formatter: '{value}'\n          }\n        }],\n        series: chartData.series //{name:'',type:'',data:[]}\n\n      };\n    };\n    /**\n     * 格式化时间格式(YYYY-MM-Day HH:MM:SS)\n     */\n\n\n    var formatDate = function formatDate(datestr) {\n      datestr = $filter('date')(datestr, 'yyyy-MM-dd HH:mm:ss');\n      return datestr;\n    };\n    /**\n     * 格式化返回历史数据\n     * @param data\n     */\n\n\n    function formatData(data) {\n      //chart图数据\n      var chartData = {\n        \"xData\": [],\n        \"series\": {\n          \"name\": \"\",\n          \"type\": \"line\",\n          \"data\": []\n        }\n      }; //表格数据\n\n      var tableData = {\n        \"name\": \"\",\n        \"unit\": \"\",\n        \"data\": []\n      }; //处理图表数据，遍历出xData,series.data\n\n      data.forEach(function (e) {\n        chartData.xData.push(formatDate(e.arisingTime));\n        chartData.series.data.push(e.value);\n        var rangeObj = null;\n        $scope.kpis.forEach(function (f) {\n          if (f.id == e.kpiCode) {\n            chartData.series.name = f.label;\n            tableData.name = f.label;\n            tableData.unit = f.unit;\n            if (f.rangeObj) rangeObj = f.rangeObj;\n          }\n        }); //Table表格数据\n\n        tableData.data.push({\n          \"name\": formatDate(e.arisingTime),\n          \"value\": e.value\n        });\n      });\n      $scope.$broadcast('OptionStatusChange', {\n        option: getOption(chartData)\n      }); //      target.setOption(getOption(chartData));\n      //聚合Chart数据\n\n      $scope.chartData = chartData; //聚合Table表格展示的数据\n\n      tableData.data.reverse();\n      $scope.tableData = tableData;\n    }\n    /**\n     * 格式化kpi值\n     * @param r = range\n     * @param v = value\n     */\n\n\n    function formatKpiValue(r, v) {\n      if (r == null || r == undefined || r == '') {\n        return v;\n      }\n\n      if (r.indexOf('{') > -1 && r.indexOf(':') > -1) {\n        //说明返回的是json格式\n        try {\n          r = JSON.parse(r);\n          v = r[v];\n        } catch (e) {\n          console.log(\"返回值不是标准对象，在转换JSON时报错: \" + e);\n        }\n      }\n\n      return v;\n    }\n\n    function isJson(r) {\n      var regExp = /\\{|\\[.*\\}|\\]/;\n      var find = regExp.test(r);\n      return find;\n    }\n    /**\n     * 获取当前的kpi数据值\n     * @param kpi\n     */\n\n\n    function getCurrentKpiData(kpi) {\n      $scope.kpis = $scope.kpiDef[$scope.selectedDevicetitem.modelId];\n      var id = $scope.selectedDevicetitem.id;\n      var uuid = $scope.uuid;\n\n      var callback = function callback(evendata) {\n        for (var i in $scope.kpis) {\n          if ($scope.kpis[i].id == evendata.data.kpiCode) {\n            $scope.$apply(function () {\n              //实时更新KPI值\n              $scope.kpis[i].value = formatKpiValue($scope.kpis[i].range, evendata.data.value);\n              $scope.kpis[i].time = formatDate(evendata.data.arisingTime); //根据选中的KPI，如果没有数据，则初始化name，unit\n\n              if ($scope.kpiData.idArray.length != 0 && $scope.chartData.series.name == \"\" && $scope.selectedRadioId == evendata.data.kpiCode) {\n                $scope.chartData.series.name = $scope.kpis[i].label;\n                $scope.tableData.name = $scope.kpis[i].label;\n                $scope.tableData.unit = $scope.kpis[i].unit;\n              }\n            });\n          }\n        } //实时更新选中的KPI的图表\n\n\n        if ($scope.kpiData.idArray.length != 0 && $scope.kpiData.idArray[0] == evendata.data.kpiCode) {\n          //chart展示\n          $scope.chartData.xData.push(formatDate(evendata.data.arisingTime));\n          $scope.chartData.series.data.push(evendata.data.value);\n          $scope.$broadcast('OptionStatusChange', {\n            option: getOption({\n              \"xData\": $scope.chartData.xData,\n              \"series\": $scope.chartData.series\n            })\n          }); //          target.setOption(getOption({\n          //            \"xData\": $scope.chartData.xData,\n          //            \"series\": $scope.chartData.series\n          //          }));\n          //table表格展示\n\n          var obj = {\n            \"name\": formatDate(evendata.data.arisingTime),\n            \"value\": evendata.data.value\n          };\n          $scope.$apply(function () {\n            $scope.tableData.data.unshift(obj);\n          });\n        }\n      };\n\n      var kpiIds = [];\n      $scope.kpis.forEach(function (e) {\n        e.value = \"\";\n        e.valueStr = \"\";\n        kpiIds.push(e.id);\n      });\n      kpiQueryModel.nodeIds = [id];\n      kpiQueryModel.kpiCodes = kpiIds;\n      kpiQueryModel.category = \"ci\";\n      kpiQueryModel.timePeriod = '0';\n      kpiQueryModel.includeInstance = true;\n      var p = [\"kpi\", kpiQueryModel];\n      kpiDataService.getValueList(p, kpiDataCallback);\n\n      function kpiDataCallback(returnObj) {\n        if (0 == returnObj.code) {\n          var data = returnObj.data;\n          data.forEach(function (e) {\n            for (var i in $scope.kpis) {\n              if (e.kpiCode == $scope.kpis[i].id) {\n                if ($scope.kpis[i].rangeObj) $scope.kpis[i].value = $scope.kpis[i].rangeObj[e.value];else $scope.kpis[i].value = e.value;\n                $scope.kpis[i].time = formatDate(e.arisingTime);\n              }\n            }\n          });\n\n          if (\"WebSocket\" in window) {\n            var param = {\n              ciid: p[1].nodeIds.toString(),\n              kpi: p[1].kpiCodes.toString()\n            };\n            var operation = \"register\"; //注册WebSocket\n\n            SwSocket.register(uuid, operation, callback); //webSocket发送请求\n\n            SwSocket.send(uuid, operation, 'kpi', param);\n          } else {\n            growl.warning(\"您的浏览器不支持WebSocket.\", {});\n          }\n        }\n      }\n\n      ;\n      /**\n       * 注销scope时注销方法heartBeat，回调函数callback\n       */\n\n      $scope.$on(\"$destroy\", function () {\n        console.log(\"on-destroy, uuid\" + uuid);\n        SwSocket.unregister(uuid);\n      });\n    }\n\n    ;\n    /**\n     * 监听设备故障返回值数据处理\n     */\n\n    function errorCallback(eventData) {\n      if (eventData.data.instance) return;\n\n      for (var i in $scope.deviceView) {\n        if (eventData.data.nodeId == $scope.deviceView[i].id) {\n          if (colorArray[eventData.data.value] != undefined) {\n            $scope.deviceView[i].color = colorArray[eventData.data.value - 1].color;\n          }\n\n          $scope.deviceView[i].alertCode = eventData.data.value; // $scope.$apply();\n\n          break;\n        } else if (eventData.data.value <= 0 && eventData.data.nodeId == $scope.deviceView[i].id) {\n          delete $scope.deviceView[i].color;\n          delete $scope.deviceView[i].alertCode;\n          break;\n        }\n      }\n\n      $scope.$apply();\n    }\n\n    ;\n    /**\n     * 获取设备的异常\n     * @param deviceview\n     */\n\n    $scope.getDeviceError = function (deviceview) {\n      var nodeIds = [];\n      var uuid = $scope.erroruuid;\n      $scope.deviceView.forEach(function (e) {\n        nodeIds.push(e.id);\n        e.alertCode = 10; //设置默认故障状态如果等于10就是默认无数据状态\n      });\n      kpiQueryModel.timePeriod = 0;\n      kpiQueryModel.category = \"ci\";\n      kpiQueryModel.nodeIds = nodeIds;\n      kpiQueryModel.kpiCodes = [999999];\n      var p = [\"kpi\", kpiQueryModel];\n      kpiDataService.getValueList(p, function (returnObj) {\n        if (0 == returnObj.code) {\n          var errorData = returnObj.data;\n          errorData.forEach(function (e) {\n            for (var i in $scope.deviceView) {\n              if ($scope.deviceView[i].id == e.nodeId) {\n                if (e.value > 0) {\n                  $scope.deviceView[i].color = colorArray[e.value - 1].color;\n                } else {\n                  //如果小于0统一为正常\n                  $scope.deviceView[i].color = \"#00b9b2\";\n                }\n\n                $scope.deviceView[i].alertCode = e.value;\n                break;\n              }\n            }\n          }); //监听websocket\n\n          if (\"WebSocket\" in window) {\n            var param = {\n              ciid: nodeIds.toString(),\n              kpi: '999999'\n            };\n            var operation = \"register\"; //注册WebSocket\n\n            SwSocket.register(uuid, operation, errorCallback); //webSocket发送请求\n\n            SwSocket.send(uuid, operation, 'kpi', param);\n          } else {\n            growl.warning(\"您的浏览器还不支持WebSocket\", {});\n          }\n        }\n      });\n      /**\n       * 注销scope时注销方法heartBeat，回调函数callback\n       */\n\n      $scope.$on(\"$destroy\", function () {\n        SwSocket.unregister(uuid);\n      });\n    };\n    /**\n     * gotoDeviceView 跳转设备视图\n     */\n\n\n    $scope.gotoDeviceView = function (item) {\n      location.href = \"#/configAlert/\" + item.id + \"/node\";\n    };\n    /**\n     * 获取icon\n     * @param random\n     * @returns \n     */\n\n\n    var getIcon = function getIcon(random) {\n      var icon;\n\n      switch (true) {\n        default:\n          icon = \"ion ion-ios-color-filter\";\n      }\n\n      return icon;\n    };\n    /**\n     * 扩展域的信息\n     * @param {Object} obj\n     * @param {Object} idx\n     */\n\n\n    var initDomainAtts = function initDomainAtts(obj, idx) {\n      obj.id = obj.id ? obj.id : 0;\n      obj.domainID = obj.domainID ? obj.domainID : 0;\n      obj.domainPath = obj.domainPath ? obj.domainPath : \"\";\n      obj.domainName = obj.domainName ? obj.domainName : \"\";\n      obj.description = obj.description ? obj.description : \"\";\n      obj.count = 0;\n      var random = Math.random(); //      obj.icon = getIcon(random);\n\n      obj.alertlv = \"bg-green\"; //random > 0.75 ? \"bg-red\" : (random > 0.5 ? \"bg-orange\" : (random > 0.25 ? \"bg-yellow\" : \"bg-green\"));\n\n      obj.isLoaded = 0;\n      obj.type = 1;\n      obj.label = obj.name ? obj.name : \"\";\n      obj.createTime = obj.createTime ? formatDate(obj.createTime) : \"\";\n      return obj;\n    };\n\n    var getResourcehandler = function getResourcehandler() {\n      getCurrentKpiData($scope.selectedDevicetitem);\n      initHistory();\n      $scope.tableData = null;\n    };\n    /**\n     * 查询设备列表 \n     */\n\n\n    $scope.goSearch = function () {\n      initAllData(\"a\");\n      var queryDitem = jQuery.extend({}, $scope.queryDitem, true);\n      queryDitem.domains = queryDitem.domainPath;\n      queryDitem.domainPath = \"\";\n      resourceUIService.getDevicesByCondition(queryDitem, function (returnObj) {\n        if (jQuery(\"#devicecollapse\").find(\".fa.fa-plus\").length > 0) {\n          jQuery.AdminLTE.boxWidget.collapse(jQuery(\"#devicecollapse\"));\n        }\n\n        if (returnObj.data) {\n          if (returnObj.data.length > 10) {\n            $scope.deviceswitchflg = 0;\n          }\n\n          returnObj.data.forEach(function (ci) {\n            ci.icon = resourceUIService.rootModelDic[ci.modelId].icon;\n          });\n          $scope.deviceView = returnObj.data;\n          SwSocket.unregister($scope.erroruuid); //注销错误信息的websocket\n          //获取设备异常的信息\n\n          $scope.getDeviceError($scope.deviceView);\n        }\n      });\n    };\n    /** \n     * 清空搜索条件\n     */\n\n\n    $scope.goClear = function () {\n      $scope.queryDitem = {\n        customerId: \"\",\n        //  客户ID\n        projectId: \"\",\n        //项目ID\n        domainPath: \"\",\n        //域路径\n        modelId: \"\",\n        //型号\n        sn: \"\",\n        //序列号\n        label: \"\",\n        //序列号\n        gatewayId: \"\"\n      };\n      initAllData(\"a\");\n    };\n    /**\n     * 查看CI的KPI值\n     * @param {Object} item\n     */\n\n\n    $scope.getKPIs = function (item) {\n      if ($scope.deviceView.length > 10) {\n        if (jQuery(\"#devicecollapse\").find(\".fa.fa-plus\").length == 0) {\n          jQuery.AdminLTE.boxWidget.collapse(jQuery(\"#devicecollapse\"));\n        }\n      }\n\n      if (jQuery(\"#kpicollapse\").find(\".fa.fa-plus\").length > 0) {\n        jQuery.AdminLTE.boxWidget.collapse(jQuery(\"#kpicollapse\"));\n      } //格式化相关数据\n\n\n      $scope.selectedRadioId = null; //选中kpi指标清空\n\n      $scope.kpiData.idArray = []; //清空选中的历史kpi id\n\n      initAllData('b'); //清空相关数据\n      //注销websocket\n\n      if ('WebSocket' in window) {\n        SwSocket.unregister($scope.uuid);\n      }\n\n      $scope.selectedDevicetitem = JSON.parse(JSON.stringify(item));\n      var modelID = item.modelId;\n      getKpisByModelId(modelID, function () {\n        getCurrentKpiData($scope.selectedDevicetitem);\n      });\n    };\n    /**\n     * 通过设备ID查询设备\n     * @param {Object} id\n     */\n\n\n    var getResourceById = function getResourceById(id) {\n      resourceUIService.getResourceById(id, function (returnObj) {\n        if (returnObj.code == 0) {\n          $scope.selectedDevicetitem = returnObj.data;\n          $scope.deviceView = [returnObj.data];\n          var modelId = returnObj.data.modelId;\n\n          if (modelId) {\n            $scope.getDeviceError($scope.deviceView);\n            getKpisByModelId(modelId, getResourcehandler);\n          }\n        }\n      });\n    };\n    /**\n     * 通过模型ID查询KPI定义\n     * @param {Object} modelId\n     * @param {Object} callbackfun\n     */\n\n\n    var getKpisByModelId = function getKpisByModelId(modelId, callbackfun) {\n      if ($scope.kpiDef[$scope.selectedDevicetitem.modelId]) {\n        if (callbackfun) {\n          callbackfun();\n        }\n      } else {\n        resourceUIService.getDataItemsByModelId(modelId, function (returnObj) {\n          if (returnObj.code == 0) {\n            initAllData('b'); //清空相关数据\n\n            var regExp = /\\{|\\[.*\\}|\\]/; //格式化kpi单位\n\n            for (var i in returnObj.data) {\n              returnObj.data[i].unit = $scope.myOptionDic[returnObj.data[i].unit];\n\n              if (returnObj.data[i].range) {\n                var find = regExp.test(returnObj.data[i].range);\n                var rangeObj = [];\n\n                if (find) {\n                  try {\n                    rangeObj = find ? JSON.parse(returnObj.data[i].range) : [];\n                  } catch (e) {}\n                }\n\n                returnObj.data[i].rangeAry = rangeObj;\n\n                if (rangeObj instanceof Array) {\n                  returnObj.data[i].rangeAry = rangeObj;\n\n                  if (rangeObj.length == 2) {\n                    returnObj.data[i].min = rangeObj[0];\n                    returnObj.data[i].max = rangeObj[1];\n                  }\n                } else if (rangeObj instanceof Object) {\n                  returnObj.data[i].rangeObj = rangeObj;\n                }\n              }\n            }\n\n            $scope.kpiDef[$scope.selectedDevicetitem.modelId] = returnObj.data;\n\n            if (callbackfun) {\n              callbackfun();\n            }\n          }\n        });\n      }\n    };\n    /**\n     * 域返回值处理函数\n     * @param data\n     */\n\n\n    function domainCallback(data) {\n      $scope.domainListTree = data.domainListTree;\n      $scope.domainListDic = data.domainListDic;\n      $scope.selectedParentitem = null; //      for(var i in data.data) {\n      //        if(!data.data[i]) {\n      //          continue;\n      //        } else {\n      //          initDomainAtts(data.data[i]);\n      //        }\n      //        $scope.domainsAry.push(userDomainService.initTreeview(data.data[i], $scope.domainListDic));\n      //      }\n      //      $scope.defaultDomain = $scope.domainsAry;\n    }\n\n    ;\n    /**\n     * 模型数据处理\n     * @param {Object} ciName\n     */\n\n    var handler = function handler(ciName) {\n      resourceUIService.getModels(function (returnObj) {\n        if (returnObj.code == 0) {\n          resourceUIService.rootModelDic = {};\n          var tree = returnObj.data;\n\n          for (var i in tree) {\n            var obj = tree[i];\n            obj.text = obj.label;\n            if (!$scope.routePathNodes[obj.parentModelId]) $scope.routePathNodes[obj.parentModelId] = [];\n            $scope.routePathNodes[obj.parentModelId].push(obj);\n            if (!$scope.routePathNodes[obj.id]) $scope.routePathNodes[obj.id] = [];\n            var cmpObj = jQuery.extend(true, {}, obj);\n            resourceUIService.rootModelDic[cmpObj.id] = cmpObj;\n          }\n\n          var addNodes = function addNodes(parentNode) {\n            for (var modeid in $scope.routePathNodes) {\n              if (modeid == parentNode.id) {\n                parentNode.nodes = $scope.routePathNodes[modeid];\n\n                for (var i in parentNode.nodes) {\n                  addNodes(parentNode.nodes[i]);\n                }\n\n                if (parentNode.nodes.length == 0) {\n                  parentNode.nodes = null;\n                }\n              }\n            }\n          };\n\n          var initRoutePath = function initRoutePath(node, arr) {\n            for (var i in node.nodes) {\n              if ($routeParams.modelId == node.nodes[i].id) {\n                arr.push(node);\n                break;\n              } else {\n                initRoutePath(node.nodes[i], arr);\n              }\n            }\n          };\n\n          addNodes(resourceUIService.rootModel);\n\n          for (var key in $scope.routePathNodes) {\n            if (key != resourceUIService.rootModel.id && !resourceUIService.rootModelDic[key]) {\n              for (var i in $scope.routePathNodes[key]) {\n                addNodes($scope.routePathNodes[key][i]);\n                if (!resourceUIService.rootModel.nodes) resourceUIService.rootModel.nodes = [];\n                resourceUIService.rootModel.nodes.push($scope.routePathNodes[key][i]);\n              }\n            }\n          }\n\n          resourceUIService.rootModelDic[resourceUIService.rootModel.id] = resourceUIService.rootModel;\n          $scope.rootModel = resourceUIService.rootModel.nodes;\n          $scope.rootModelDic = resourceUIService.rootModelDic;\n        }\n      });\n    };\n    /**\n     * 根据获取的域以及获取所有的网关，筛选出该域的网关\n     */\n\n\n    function getAllGateways() {\n      resourceUIService.getAllGateways(function (data) {\n        if (0 == data.code) {\n          $scope.gateData = data.data;\n        }\n      });\n    }\n\n    ;\n    /**\n     * 初始化，页面入口\n     */\n\n    var init = function init() {\n      /* 获得根模型的定义 */\n      resourceUIService.getRootModel(function (returnObj) {\n        if (returnObj.code == 0) {\n          resourceUIService.rootModel = returnObj.data;\n          $scope.routePathNodes = {};\n          handler(returnObj);\n        }\n      });\n      getAllGateways();\n\n      if (!$scope.menuitems[\"isloaded\"]) {\n        var menuitemsWatch = $scope.$watch('menuitems', function (o, n) {\n          if ($scope.menuitems[\"isloaded\"]) {\n            if ($scope.baseConfig.extendDomain) {\n              resourceUIService.getExtendDomainsByFilter({}, domainCallback);\n            } else {\n              userDomainService.queryDomainTree(userLoginUIService.user.userID, domainCallback);\n            }\n\n            menuitemsWatch();\n          }\n        }, true);\n      } else if ($scope.baseConfig.extendDomain) {\n        resourceUIService.getExtendDomainsByFilter({}, domainCallback);\n      } else {\n        userDomainService.queryDomainTree(userLoginUIService.user.userID, domainCallback);\n      }\n\n      if ($routeParams.hasOwnProperty('id')) {\n        if ($routeParams.id) {\n          $scope.searchMode = true;\n          getResourceById($routeParams.id);\n        }\n      } else {\n        /* 让下一层收缩 */\n        jQuery.AdminLTE.boxWidget.collapse(jQuery(\"#devicecollapse\"));\n        jQuery.AdminLTE.boxWidget.collapse(jQuery(\"#kpicollapse\"));\n        jQuery.AdminLTE.boxWidget.collapse(jQuery(\"#viewcollapse\"));\n      }\n\n      $scope.$on(\"switchChange\", function (e, param) {\n        $scope.$apply(function () {\n          if (param.id == \"deviceswitch\") {\n            if (jQuery(\"#devicecollapse\").find(\".fa.fa-plus\").length > 0) {\n              jQuery.AdminLTE.boxWidget.collapse(jQuery(\"#devicecollapse\"));\n            }\n\n            $scope.deviceswitchflg = param.itemDirValues; //设备默认显示按钮\n          } else if (param.id == \"kpiswitch\") {\n            if (jQuery(\"#kpicollapse\").find(\".fa.fa-plus\").length > 0) {\n              jQuery.AdminLTE.boxWidget.collapse(jQuery(\"#kpicollapse\"));\n            }\n\n            $scope.kpiswitchflg = param.itemDirValues; //KPI默认显示按钮\n          }\n        });\n      });\n    };\n    /**\n     * 指标参数\n     */\n\n\n    var initKpiData = function initKpiData() {\n      $scope.kpiData = {\n        \"idArray\": [],\n        \"unitArray\": [],\n        \"labelArray\": [],\n        \"granularityArray\": [],\n        \"granularityUnitArray\": []\n      };\n      var xData = [];\n      var series = [{\n        \"data\": [],\n        \"name\": \"\",\n        \"type\": \"line\"\n      }]; // 初始化echart组件\n\n      $timeout(function () {\n        $scope.$broadcast(Event.ECHARTINFOSINIT, {\n          \"option\": getOption({\n            \"xData\": xData,\n            \"series\": series\n          })\n        });\n      });\n    };\n    /**\n     * 初始化历史数据，无数据时的历史数据展示\n     */\n\n\n    var initHistory = function initHistory() {\n      var xData = [];\n      var series = [{\n        \"data\": [],\n        \"name\": \"\",\n        \"type\": \"line\"\n      }];\n      var nulloption = getOption({\n        \"xData\": xData,\n        \"series\": series\n      });\n      $scope.$broadcast('OptionStatusChange', {\n        option: nulloption\n      });\n    };\n    /**\n     * 获得KPI单位的设置\n     */\n\n\n    var getUnit = function getUnit() {\n      if (!unitService.units) {\n        unitService.getAllUnits(function (returnObj) {\n          if (returnObj.code == 0) {\n            unitService.units = returnObj.data;\n            $scope.myOptions = returnObj.data;\n            unitService.unitDics = {};\n\n            for (var i in $scope.myOptions) {\n              unitService.unitDics[$scope.myOptions[i].unitCode] = $scope.myOptions[i].unitName;\n              if ($scope.myOptions[i].unitCode == \"NA\" || $scope.myOptions[i].unitCode == \"Number\") unitService.unitDics[$scope.myOptions[i].unitCode] = \"\";\n            }\n\n            $scope.myOptionDic = unitService.unitDics;\n          }\n        });\n      } else {\n        $scope.myOptions = unitService.units;\n        $scope.myOptionDic = unitService.unitDics;\n      }\n    }; //登录状态判定\n\n\n    if (!userLoginUIService.user.isAuthenticated) {\n      $scope.$on('loginStatusChanged', function (evt, d) {\n        if (userLoginUIService.user.isAuthenticated) {\n          init();\n          getUnit();\n          initKpiData();\n        }\n      });\n    } else {\n      init();\n      getUnit();\n      initKpiData();\n    }\n  }]);\n});"],"sourceRoot":"/source/"}