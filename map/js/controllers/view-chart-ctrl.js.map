{"version":3,"sources":["js/controllers/view-chart-ctrl.js"],"names":["define","controllers","initController","$scope","$timeout","kpiDataService","SwSocket","Info","resourceUIService","q","baseoption","console","info","uuid","item","category","formatStr","option","kpiReturnObj","kpiQueryModel","get","kpiCodes","timePeriod","nodeIds","deflen","seriesMaxLen","callback","evendata","data","instance","getChartindexById","nodeId","kpiCode","recordList","length","newData","mergeKpiHandler","series","forEach","pop","push","filedName","xAxis","xaxis","shift","newDateJson","arisingTime","Format","GetDateCategoryStrByLabel","value","$broadcast","name","$parent","view","echartViewId","ciid","kpiid","i","getResourceKpis","model","getKpisByModelId","id","returnObj","code","kpis","regExp","range","rangeObj","find","test","JSON","parse","e","rangeAry","Array","min","max","Object","displayParam","displayParamObj","kpisDic","init","reload","Math","isOld","defaultChart","theme","hasOwnProperty","extendFlg","j","nodes","cilistByModelId","modelId","timespan","type","children","subItem","apply","getKpisInfo","dataSource","filters","arr","getNodesInfo","getChartProperty","split","Event","ECHARTINFOSINIT","isRealTimeData","minTimespan","hierarchyValueHandler","xAxisObj","jQuery","extend","legend","title","text","subtext","tooltip","pieOption","toolbox","gaugeOption","titleObj","node","nodesDic","kpi","label","pieObj","filedNameAry","gaugeObj","m","seriesObj","indexOf","kpirecord","param","toString","operation","register","send","getResourceByIds","key","p","kpiDef","getMSvalue","ceil","getKpiValueList","echartItem","$on","event","changerItem","log","unregister"],"mappings":"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","file":"js/controllers/view-chart-ctrl.js","sourcesContent":["define(['controllers/controllers'], function (controllers) {\n  'use strict';\n\n  controllers.initController('ViewChartsCtrl', ['$scope', '$timeout', 'kpiDataService', 'SwSocket', 'Info', 'resourceUIService', '$q', function ($scope, $timeout, kpiDataService, SwSocket, Info, resourceUIService, q) {\n    console.info(\"ViewChartsCtrl被触发\");\n    var baseoption;\n    var info = Info.get(\"../localdb/echarts-chart.json\", function (info) {\n      baseoption = info.option;\n    });\n    var uuid;\n    var item;\n    var kpiCodes = [];\n    var kpiName2Code = {}; //kpi名称和编码对应\n\n    var timePeriod = 0; //取值时间长度\n\n    var nodeIds = []; //CI编码数组\n\n    var category; //time或者实例模式\n\n    var formatStr; //时间格式化\n\n    var graphLineColors; //轴的颜色\n\n    var addDatas = [];\n    var option;\n    var deflen = 0;\n    var kpiReturnObj;\n    var kpiQueryModel;\n    var seriesMaxLen = 0;\n\n    var callback = function callback(evendata) {\n      if (evendata.data.instance) return;\n      var index = getChartindexById(evendata.data.nodeId, evendata.data.kpiCode);\n\n      if (index > -1) {\n        if (seriesMaxLen == 0) seriesMaxLen = kpiReturnObj.data.recordList.length;\n        kpiReturnObj = kpiDataService.mergeKpiHandler(evendata.data, kpiQueryModel, kpiReturnObj);\n        var newData = kpiReturnObj.data.recordList[kpiReturnObj.data.recordList.length - 1];\n\n        if (kpiReturnObj.data.recordList.length == seriesMaxLen) {\n          //更新不增加\n          option.series.forEach(function (series) {\n            series.data.pop();\n            series.data.push(newData[series.filedName]);\n          });\n        } else {\n          //跟新增加\n          seriesMaxLen++;\n\n          if (option.xAxis) {\n            var xaxis = option.xAxis[0];\n\n            if (xaxis.data.length >= deflen) {\n              xaxis.data.shift();\n            }\n\n            xaxis.data.push(newDateJson(newData.arisingTime).Format(GetDateCategoryStrByLabel(formatStr.value)));\n          }\n\n          option.series.forEach(function (series) {\n            if (series.data.length >= deflen) {\n              series.data.shift();\n            }\n\n            series.data.push(newData[series.filedName]);\n          });\n        }\n\n        $scope.$broadcast('OptionStatusChange', {\n          \"name\": $scope.$parent.view ? $scope.$parent.view.echartViewId : null,\n          \"option\": option\n        });\n      }\n    };\n\n    var getChartindexById = function getChartindexById(ciid, kpiid) {\n      for (var i = 0; i < option.series.length; i++) {\n        if (option.series[i].filedName == ciid + \"?\" + kpiid) return i;\n      }\n\n      return 0;\n    };\n\n    var GasFunction = function GasFunction(value) {\n      switch (value) {\n        case 0:\n          return 'H';\n\n        case 50:\n          return '温度';\n\n        case 100:\n          return 'C';\n      }\n    };\n\n    var WaterFunction = function WaterFunction(value) {\n      switch (value) {\n        case 0:\n          return 'H';\n\n        case 50:\n          return '能耗';\n\n        case 100:\n          return 'C';\n      }\n    };\n\n    var getResourceKpis = function getResourceKpis(model, callback) {\n      resourceUIService.getKpisByModelId(model.id, function (returnObj) {\n        if (returnObj.code == 0) {\n          model.kpis = returnObj.data;\n          var regExp = /\\{|\\[.*\\}|\\]/;\n\n          for (var i in model.kpis) {\n            if (model.kpis[i].range) {\n              var find = regExp.test(model.kpis[i].range);\n              var rangeObj = [];\n\n              if (find) {\n                try {\n                  rangeObj = find ? JSON.parse(model.kpis[i].range) : [];\n                } catch (e) {}\n              }\n\n              model.kpis[i].rangeAry = rangeObj;\n\n              if (rangeObj instanceof Array) {\n                model.kpis[i].rangeAry = rangeObj;\n\n                if (rangeObj.length == 2) {\n                  model.kpis[i].min = rangeObj[0];\n                  model.kpis[i].max = rangeObj[1];\n                }\n              } else if (rangeObj instanceof Object) {\n                model.kpis[i].rangeObj = rangeObj;\n              }\n            }\n\n            if (model.kpis[i].displayParam) {\n              var find = regExp.test(model.kpis[i].displayParam);\n              var displayParamObj = {};\n\n              if (find) {\n                displayParamObj = JSON.parse(model.kpis[i].displayParam);\n              }\n\n              model.kpis[i].displayParamObj = displayParamObj;\n            }\n\n            resourceUIService.kpisDic[model.id + \"??\" + model.kpis[i].id] = model.kpis[i];\n            resourceUIService.kpisDic[model.kpis[i].id] = model.kpis[i];\n          }\n\n          if (callback) {\n            callback(model);\n          }\n        }\n\n        ;\n      });\n    };\n    /**\n     * 初始化\n     * @param 是否重载 reload\n     */\n\n\n    var init = function init(reload) {\n      if (!reload) uuid = Math.uuid();\n      var isOld = true; //是否为V1版本视图\n\n      var defaultChart = false; //默认Chart不做任何处理\n\n      var theme = item.theme ? item.theme : 'macarons';\n\n      if (item.hasOwnProperty(\"option\")) {\n        if (item.hasOwnProperty('timespan')) {\n          kpiCodes = item.kpis;\n          var extendFlg = true;\n\n          for (var j in item.nodes) {\n            for (var i in kpiDataService.cilistByModelId) {\n              if (item.nodes[j] == kpiDataService.cilistByModelId[i].id) {\n                extendFlg = false;\n                break;\n              }\n            }\n\n            if (extendFlg && kpiDataService.cilistByModelId && kpiDataService.cilistByModelId.length > 0) {\n              for (var i = 0; i < item.nodes.length; i++) {\n                if (kpiDataService.cilistByModelId[i]) {\n                  if (item.modelId == kpiDataService.cilistByModelId[i].modelId) {\n                    nodeIds.push(kpiDataService.cilistByModelId[i].id);\n                  } else {\n                    nodeIds = item.nodes;\n                  }\n                } else {\n                  nodeIds = item.nodes;\n                }\n              }\n            } else {\n              nodeIds = item.nodes;\n            }\n\n            break;\n          }\n\n          timePeriod = item.timespan;\n\n          if (item.type == \"line\" || item.type == \"bar\") {\n            category = \"time\";\n          } else if (item.type == \"pie\" || item.type == 'gauge') {\n            category = \"time\";\n            timePeriod = 0;\n          }\n\n          formatStr = {};\n          formatStr.value = '';\n          if (item.formatStr) formatStr.value = item.formatStr;\n        } else {\n          defaultChart = true;\n        }\n\n        isOld = false;\n      } else {\n        if (item.hasOwnProperty(\"isGroup\") && item[\"isGroup\"]) {\n          for (var i in item.children) {\n            var subItem = item.children[i];\n            kpiCodes.push.apply(kpiCodes, kpiDataService.getKpisInfo(subItem)[0]);\n\n            if (i == 0) {\n              category = subItem.dataSource.filters.category;\n              var arr = kpiDataService.getNodesInfo(subItem);\n              nodeIds = arr[0];\n              timePeriod = arr[1];\n            }\n          }\n        } else {\n          formatStr = kpiDataService.getChartProperty(item, \"categoryAxisFormatStr\");\n          category = item.dataSource.filters.category;\n          if (item.type == \"LineChart\") graphLineColors = kpiDataService.getChartProperty(item, \"graphLineColors\").value.split(\",\");\n          var arr = kpiDataService.getKpisInfo(item);\n          kpiCodes = arr[0];\n          kpiName2Code = arr[1];\n          var arr = kpiDataService.getNodesInfo(item);\n          nodeIds = arr[0];\n          timePeriod = arr[1];\n        }\n      }\n\n      if (defaultChart) {\n        $timeout(function () {\n          $scope.$broadcast(Event.ECHARTINFOSINIT, {\n            \"theme\": theme,\n            \"option\": item.option\n          });\n        });\n        return;\n      }\n\n      kpiQueryModel = {\n        category: category,\n        isRealTimeData: true,\n        timePeriod: timePeriod,\n        nodeIds: nodeIds,\n        kpiCodes: kpiCodes,\n        kpisDic: {\n          minTimespan: 0\n        }\n      };\n      var p = [\"kpi\", kpiQueryModel];\n      kpiReturnObj = null;\n\n      var hierarchyValueHandler = function hierarchyValueHandler(returnObj) {\n        if (returnObj.code == 0) {\n          var xAxisObj;\n          kpiReturnObj = returnObj;\n\n          if (isOld) {\n            option = jQuery.extend(true, {}, baseoption);\n            option.legend.data = [];\n            option.xAxis = [];\n            option.series = [];\n\n            if (item.hasOwnProperty(\"isGroup\") && item[\"isGroup\"]) {\n              option.title.text = \"\";\n              option.title.subtext = \"\";\n\n              if (item.type == \"PieChart\") {\n                option.tooltip = info.pieOption.tooltip;\n                option.toolbox = info.pieOption.toolbox;\n                info.pieOption.series = [];\n              } else if (item.type == \"GaugeChart\") {\n                option.tooltip = info.gaugeOption.tooltip;\n                info.gaugeOption.series = [];\n              }\n            } else {\n              //设置title\n              var titleObj = kpiDataService.getChartProperty(item, \"title\");\n              option.title.text = titleObj.value;\n              option.title.subtext = \"\";\n\n              if (item.type == \"PieChart\") {\n                option.tooltip = info.pieOption.tooltip;\n                option.toolbox = info.pieOption.toolbox;\n                info.pieOption.series[0].data = [];\n              } else if (item.type == \"GaugeChart\") {\n                option.tooltip = info.gaugeOption.tooltip;\n                info.gaugeOption.series[0].data = [];\n              }\n            }\n          } else {\n            baseoption = item.option;\n            option = jQuery.extend(true, {}, baseoption);\n            if (option.legend) option.legend.data = [];\n            option.xAxis = [];\n            option.series = [];\n          }\n\n          for (var i in kpiQueryModel.nodeIds) {\n            var node = kpiQueryModel.nodesDic[kpiQueryModel.nodeIds[i]];\n\n            for (var j in kpiQueryModel.kpiCodes) {\n              var kpi = kpiQueryModel.kpisDic[kpiQueryModel.kpiCodes[j]];\n\n              if (option.legend) {\n                if (node && kpi && node.hasOwnProperty(\"label\") && kpi.hasOwnProperty(\"label\")) {\n                  option.legend.data.push(node.label + \":\" + kpi.label);\n                } else {\n                  continue;\n                }\n              }\n\n              if (item.type == \"pie\" || item.type == 'gauge') {\n                if (option.series.length == 0) {\n                  option.series.push(jQuery.extend(true, {}, baseoption.series[0]));\n                  option.series[0].data = [];\n                }\n\n                var pieObj = {};\n                pieObj.name = node.label + \":\" + kpi.label;\n                pieObj.filedName = kpiQueryModel.nodeIds[i] + \"?\" + kpiQueryModel.kpiCodes[j];\n                pieObj.value;\n                option.series[0].data.push(pieObj);\n              } else if (item.type == \"GaugeChart\") {\n                info.gaugeOption.series[0].name = filedNameAry[0];\n                var gaugeObj = {};\n                gaugeObj.name = node.label + \":\" + kpi.label;\n                gaugeObj.filedName = kpiQueryModel.nodeIds[i] + \"?\" + kpiQueryModel.kpiCodes[j];\n                gaugeObj.value = \"\";\n                info.gaugeOption.series[0].data.push(gaugeObj);\n              } else if (item.type == \"line\" || item.type == \"bar\") {\n                var seriesObj;\n\n                for (var m in baseoption.series) {\n                  seriesObj = jQuery.extend(true, {}, baseoption.series[m]);\n\n                  if (seriesObj.name.indexOf(kpi.label) > -1) {\n                    break;\n                  }\n                }\n\n                if (seriesObj) {\n                  seriesObj.data = [];\n                  seriesObj.name = node.label + \":\" + kpi.label;\n                  seriesObj.filedName = kpiQueryModel.nodeIds[i] + \"?\" + kpiQueryModel.kpiCodes[j];\n                  option.series.push(seriesObj);\n                }\n              }\n            }\n          }\n\n          if (item.type == \"LineChart\" || item.type == \"line\" || item.type == \"bar\") {\n            xAxisObj = jQuery.extend(true, {}, baseoption.xAxis[0]);\n            xAxisObj.data = [];\n          }\n\n          for (var i in kpiReturnObj.data.recordList) {\n            var kpirecord = kpiReturnObj.data.recordList[i];\n\n            if (item.hasOwnProperty(\"isGroup\") && item[\"isGroup\"]) {\n              if (item.type == \"GaugeChart\") {\n                for (var j in info.gaugeOption.series) {\n                  var seriesObj = info.gaugeOption.series[j];\n                  seriesObj.data[0].value = kpirecord[seriesObj.data[0].filedName];\n                }\n              }\n            } else {\n              if (item.type == \"PieChart\") {\n                for (var j in info.pieOption.series[0].data) {\n                  var seriesObj = info.pieOption.series[0].data[j];\n                  seriesObj.value = kpirecord[seriesObj.filedName];\n                }\n              } else if (item.type == \"pie\" || item.type == 'gauge') {\n                for (var j in option.series[0].data) {\n                  var seriesObj = option.series[0].data[j];\n                  seriesObj.value = kpirecord[seriesObj.filedName];\n                }\n              } else if (item.type == \"GaugeChart\") {\n                for (var j in info.gaugeOption.series[0].data) {\n                  var seriesObj = info.gaugeOption.series[0].data[j];\n                  seriesObj.value = kpirecord[seriesObj.filedName];\n                }\n              } else if (item.type == \"LineChart\" || item.type == \"line\" || item.type == \"bar\") {\n                for (var j in option.series) {\n                  var seriesObj = option.series[j];\n                  seriesObj.data.push(kpirecord[seriesObj.filedName]);\n\n                  if (j == 0) {\n                    var xaxis = kpirecord[kpiQueryModel.category];\n\n                    if (category == \"time\") {\n                      xaxis = newDateJson(xaxis).Format(GetDateCategoryStrByLabel(formatStr.value));\n                    }\n\n                    xAxisObj.data.push(xaxis);\n                  }\n                }\n              }\n            }\n          }\n\n          if (item.type == \"GaugeChart\") {\n            for (var i in info.gaugeOption.series) {\n              var seriesObj = info.gaugeOption.series[i];\n              option.series.push(seriesObj);\n            }\n          } else if (item.type == \"pie\" || item.type == 'gauge') {//\t\t\t\t\t\t\toption=baseoption;\n          } else if (item.type == \"PieChart\") {\n            seriesObj = jQuery.extend(true, {}, info.pieOption.series[0]);\n            option.series.push(seriesObj);\n          } else if (item.type == \"LineChart\" || item.type == \"line\" || item.type == \"bar\") {\n            option.xAxis.push(xAxisObj);\n          }\n\n          if (option.series == null || option.series[0] == null || option.series[0].data.length == 0) {\n            return;\n          }\n\n          $scope.$broadcast(Event.ECHARTINFOSINIT, {\n            \"name\": $scope.$parent.view ? $scope.$parent.view.echartViewId : null,\n            \"theme\": theme,\n            \"option\": option\n          });\n          console.info(\"在Controller中获得echarts的option\");\n          var param = {\n            ciid: nodeIds.toString(),\n            kpi: kpiCodes.toString()\n          };\n\n          if (!reload) {\n            var operation = \"register\"; //考虑极端情况，一个页面有多个模块监听同一个方法  \n            //但展示在页面的数据需对接收的实时监听的数据做不同处理 \n\n            SwSocket.register(uuid, operation, callback); //websocket发送请求\n\n            SwSocket.send(uuid, operation, 'kpi', param);\n          }\n        }\n      };\n\n      var handlerFun = function handlerFun(p) {\n        //\t\t\t\tkpiDataService.getKpiHierarchyValueList(p, function(returnObj) {\n        kpiDataService.getKpiValueList(p, function (returnObj) {\n          if (baseoption) {\n            hierarchyValueHandler(returnObj);\n          } else {\n            $timeout(function () {\n              hierarchyValueHandler(returnObj);\n            });\n          }\n        });\n      };\n      /*\n      resourceUIService.getResourceByIds(nodeIds,function(returnObj){\n      \tkpiQueryModel.nodesDic = returnObj;\n      \tif (kpiQueryModel.kpisDic) {\n      \t\thandlerFun([\"kpi\", kpiQueryModel]);\n      \t}\n      \t\t\n      });\n      resourceUIService.getKpisByKpiIds(kpiCodes,function(returnObj){\n      \tkpiQueryModel.kpisDic = returnObj;\n      \tif (kpiQueryModel.nodesDic) {\n      \t\thandlerFun([\"kpi\", kpiQueryModel]);\n      \t}\n      });\n      */\n\n\n      resourceUIService.getResourceByIds(nodeIds, function (returnObj) {\n        kpiQueryModel.nodesDic = returnObj;\n\n        for (var key in kpiQueryModel.nodesDic) {\n          getResourceKpis({\n            id: kpiQueryModel.nodesDic[key].modelId\n          }, function (model) {\n            var minTimespan = -1;\n            kpiCodes.forEach(function (kpiid) {\n              var kpiDef = resourceUIService.kpisDic[kpiid];\n\n              if (kpiDef) {\n                kpiQueryModel.kpisDic[kpiid] = kpiDef;\n\n                if (minTimespan == -1) {\n                  minTimespan = resourceUIService.getMSvalue(0, kpiDef);\n                  deflen = Math.ceil(kpiQueryModel.timePeriod / minTimespan);\n                }\n              }\n            });\n\n            if (minTimespan > -1) {\n              kpiQueryModel.kpisDic.minTimespan = minTimespan;\n              handlerFun([\"kpi\", kpiQueryModel]);\n            }\n          });\n        }\n      });\n    };\n\n    item = $scope.echartItem ? $scope.echartItem : $scope.$parent.item ? $scope.$parent.item : null;\n\n    if (item) {\n      init();\n    }\n    /**\n     * 更换CI时重新加载\n     */\n\n\n    $scope.$on(\"itemChanger\", function (event, changerItem) {\n      if (changerItem.id == item.id) {\n        item = changerItem;\n        init(true);\n      }\n    });\n    /**\n     * 注销scope时注销方法heartBeat，回调函数callback  \n     */\n\n    $scope.$on(\"$destroy\", function () {\n      console.log(\"on-destroy\");\n      SwSocket.unregister(uuid);\n    });\n  }]);\n});"],"sourceRoot":"/source/"}