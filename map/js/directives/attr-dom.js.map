{"version":3,"sources":["js/directives/attr-dom.js"],"names":["define","directives","datatables","initDirective","$timeout","$compile","restrict","controller","$scope","$element","$attrs","table","domMain","isEditing","$on","Event","ATTREDITINIT","event","args","destroy","DataTable","dom","language","$","ProudSmart","datatable","data","scrollX","columns","title","orderable","width","visible","selectedDitem","canEdit","columnDefs","targets","render","type","full","isEdit","dataType","escape","myDicts","put","i","valueCode","label","str","isNew","on","parentDom","parent","html","value","this","children","val","tr","closest","row","name","cells","invalidate","tds","parents","each","jqob","e","stopPropagation","checkPass","txt","addClass","removeClass","cell","doAction","returnObj","id","preventDefault","isDel","rowData","flg","remove","draw"],"mappings":"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","file":"js/directives/attr-dom.js","sourcesContent":["define(['directives/directives', 'datatables.net', 'datatables.net-bs'], function (directives, datatables) {\n  'use strict';\n\n  directives.initDirective('attrseditTable', ['$timeout', '$compile', function ($timeout, $compile) {\n    return {\n      restrict: 'A',\n      controller: ['$scope', '$element', '$attrs', function ($scope, $element, $attrs) {\n        var domMain = $element;\n        var table;\n        var isEditing = false;\n        var itemAttrs;\n        $scope.$on(Event.ATTREDITINIT, function (event, args) {\n          if (table) {\n            table.destroy();\n          }\n\n          isEditing = false;\n          table = domMain.DataTable({\n            dom: '<\"row\"<\"col-sm-6\"<\"special-btn\">><\"col-sm-6\"f>><\"row\"<\"clo-sm-12\">>t<\"row\"<\"col-sm-2\"i><\"col-sm-2\"l><\"col-sm-8\"p>>',\n            language: $.ProudSmart.datatable.language,\n            data: args.data,\n            scrollX: true,\n            columns: [{\n              data: \"name\",\n              title: \"属性名称\"\n            }, {\n              data: \"label\",\n              title: \"显示名称\"\n            }, {\n              data: \"dataType\",\n              title: \"数据类型\"\n            }, {\n              data: \"option\",\n              orderable: false,\n              title: \"操作\",\n              width: \"100px\",\n              visible: $scope.selectedDitem && $scope.selectedDitem.canEdit\n            }],\n            columnDefs: [{\n              targets: 0,\n              data: \"name\",\n              render: function render(data, type, full) {\n                // 返回自定义内容\t\t\n                if (full.isEdit == 2 && type == \"display\") {\n                  if (full.dataType != \"icon\") return \"<input style='width:100%' class='form-control input-sm' type='text' value='\" + escape(data) + \"'>\";else return \"<input style='width:100%' class='form-control input-sm' type='text' value='\" + escape(data) + \"' disabled>\";\n                } else return escape(data);\n              }\n            }, {\n              targets: 1,\n              data: \"label\",\n              render: function render(data, type, full) {\n                // 返回自定义内容\t\t\n                if (full.isEdit == 2 && type == \"display\") {\n                  if (full.dataType != \"icon\") return \"<input style='width:100%' class='form-control input-sm' type='text' value='\" + escape(data) + \"'>\";else return \"<input disabled style='width:100%' class='form-control input-sm' type='text' value='\" + escape(data) + \"'>\";\n                } else return escape(data);\n              }\n            }, {\n              targets: 2,\n              data: \"dataType\",\n              render: function render(data, type, full) {\n                if (!$scope.myDicts) return data; // 返回自定义内容\t\t\n\n                if (full.isEdit == 2 && type == \"display\") {\n                  var put = \"<select id='dtSelect' class='combobox form-control input-sm'>\";\n                  put += '<option value=\"\">请选择...</option>';\n\n                  for (var i in $scope.myDicts['DataType']) {\n                    if ($scope.myDicts['DataType'][i].valueCode == data) {\n                      put += '<option selected=\"true\" value=\"' + $scope.myDicts['DataType'][i].valueCode + '\">' + $scope.myDicts['DataType'][i].label + '</option>';\n                    } else {\n                      put += '<option value=\"' + $scope.myDicts['DataType'][i].valueCode + '\">' + $scope.myDicts['DataType'][i].label + '</option>';\n                    }\n                  }\n\n                  put += '</select>';\n                  return put;\n                }\n\n                for (var i in $scope.myDicts['DataType']) {\n                  if ($scope.myDicts['DataType'][i].valueCode == data) {\n                    return $scope.myDicts['DataType'][i].label;\n                  }\n                }\n\n                return data;\n              }\n            }, {\n              targets: 3,\n              data: \"option\",\n              render: function render(data, type, full) {\n                // 返回自定义内容\t\t\n                var str = \"<div class='btn-group btn-group-sm'>\";\n\n                if (full.canEdit) {\n                  if (full.isEdit == 2) {\n                    str += \"<a id='save-btn' class='btn btn-default' ><i class='fa fa-save hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'> 保存</span></a>\";\n                    if (full.isNew) str += \"<a id='del-btn' class='btn btn-default' ><i class='fa fa-minus hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'> 删除</span></a>\";else str += \"<a id='cancel-btn' class='btn btn-default' ><i class='fa fa-times hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'> 取消</span></a>\";\n                  } else {\n                    str += \"<a id='edit-btn' class='btn btn-default' ><i class='fa fa-edit hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'> 修改</span></a>\";\n                    str += \"<a id='del-btn' class='btn btn-default' ><i class='fa fa-minus hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'> 删除</span></a>\";\n                  } //                } else {\n                  //                  str += \"<a id='del-btn' class='btn btn-default' ><i class='fa fa-minus hidden-lg hidden-md hidden-sm'></i><span class='hidden-xs'> 删除</span></a>\"\n\n                }\n\n                str += \"</div>\";\n                return str;\n              }\n            }]\n          });\n        });\n        /**\n         * 监听表格初始化后，添加按钮\n         */\n\n        domMain.on('init.dt', function () {\n          if ($scope.selectedDitem && $scope.selectedDitem.canEdit) {\n            var parentDom = $(\".special-btn\").parent();\n            parentDom.html('<a ng-click=\"addModelSubItem()\" class=\"btn btn-default btn-sm\"><i class=\"fa fa-plus\"></i><span class=\"hidden-xs\"> 添加属性</span></a>');\n            $compile(parentDom)($scope);\n          }\n        });\n        domMain.on('change', \"#dtSelect\", function () {\n          var value = $(this).children('option:selected').val(); //这就是selected的值 \n\n          var tr = $(this).closest('tr');\n          var row = table.row(tr);\n\n          if (value == \"icon\") {\n            row.data().label = \"图标\";\n            row.data().name = \"icon\";\n            row.data().dataType = \"icon\";\n            row.cells().invalidate();\n          } else {\n            var tds = $(this).parents(\"tr\").children();\n            $.each(tds, function (i, val) {\n              var jqob = $(val);\n\n              if (i == 1) {\n                row.data().label = jqob.children(\"input\").val();\n              }\n\n              if (i == 0) {\n                row.data().name = jqob.children(\"input\").val();\n              }\n            });\n            row.data().dataType = value;\n            row.cells().invalidate();\n          }\n        });\n        domMain.on('click', '#save-btn', function (e) {\n          e.stopPropagation();\n          var tr = $(this).closest('tr');\n          var row = table.row(tr);\n\n          if (row.data().isEdit == 2) {\n            var tds = $(this).parents(\"tr\").children();\n            var checkPass = true;\n            $.each(tds, function (i, val) {\n              var jqob = $(val);\n\n              if (i == 0 || i == 1) {\n                var txt = jqob.children(\"input\").val();\n\n                if (!txt) {\n                  $(val).addClass('danger');\n                  checkPass = false;\n                  row.data().isEdit = 2;\n                  row.cells().invalidate();\n                  return false;\n                } else {\n                  $(val).removeClass('danger');\n                }\n              }\n\n              if (i == 2) {\n                var txt = $(val).children(\"select\").val();\n\n                if (txt) {\n                  jqob.html(txt);\n                  table.cell(jqob).data(txt); //修改DataTables对象的数据\n\n                  $(val).removeClass('danger');\n                  return true;\n                } else {\n                  checkPass = false;\n                  $(val).addClass('danger');\n                  return false;\n                }\n              }\n\n              if (i == 3) {\n                row.cell(jqob).invalidate();\n                return true;\n              }\n\n              var txt = jqob.children(\"input\").val();\n              jqob.html(txt);\n              table.cell(jqob).data(txt); //修改DataTables对象的数据\n            });\n\n            if (checkPass) {\n              $scope.doAction(\"attr-save\", row.data(), function (returnObj) {\n                if (returnObj == false) {\n                  row.data().isEdit = 2;\n                } else {\n                  row.data().id = returnObj.id;\n                  row.data().isEdit = 0;\n                  row.data().isNew = false;\n                  row.cells().invalidate();\n                  isEditing = false;\n                }\n              });\n            }\n          }\n        });\n        domMain.on('click', '#edit-btn', function (e) {\n          e.preventDefault();\n\n          if (!isEditing) {\n            isEditing = true;\n            var tr = $(this).closest('tr');\n            var row = table.row(tr);\n            row.data().isEdit = 2;\n            row.cells().invalidate();\n          } else {\n            $scope.doAction(\"thresholdMessage\", \"当前有修改中的属性，请先完成该操作\");\n          }\n        });\n        domMain.on('click', '#cancel-btn', function (e) {\n          e.preventDefault();\n\n          if (isEditing) {\n            isEditing = false;\n            var tr = $(this).closest('tr');\n            var row = table.row(tr);\n            row.data().isEdit = 0;\n            row.cells().invalidate();\n          }\n        });\n        domMain.on('click', '#del-btn', function (e) {\n          e.preventDefault();\n          var tr = $(this).closest('tr');\n          var row = table.row(tr);\n          row.data().isDel = true;\n          var rowData = row.data();\n          $scope.doAction(\"attr-delete\", rowData, function (flg) {\n            if (flg) row.remove().draw(false);\n          });\n        });\n      }]\n    };\n  }]);\n});"],"sourceRoot":"/source/"}